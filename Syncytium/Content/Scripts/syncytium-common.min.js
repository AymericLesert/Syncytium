var Namespace={},Digits,Language,Filter,List,GUI;Namespace.isDefined=function(n){try{return eval(n),!0}catch(t){return!1}};Array.isEmpty=function(n){if(n===null||n===undefined||n.length===null||n.length===undefined)return!0;if(n.length>0)return!1;let t=0;for(t in n)return!1;return!0};class Dates{static Check(n,t,i,r,u){var f=null,s=[],e=[],c=new moment,o,h;for(f in i)if(i[f]!==null&&i[f]!==undefined){if(t[i[f]]===null||t[i[f]]===undefined||!t[i[f]]instanceof moment){u.addField(i[f],"ERR_FIELD_REQUIRED",["{"+n.toUpperCase()+"_"+i[f].toUpperCase()+"}"]);continue}s.push(i[f])}for(f in s){if(r&&t[s[f]]>c){u.addField(s[f],"ERR_"+n.toUpperCase()+"_DATE",["{"+n.toUpperCase()+"_"+s[f].toUpperCase()+"}","{"+n.toUpperCase()+"_NOW}"]);continue}e.push(s[f])}for(o=0;o<e.length-1;o++)for(h=o+1;h<e.length;h++)t[e[o]]>t[e[h]]&&u.addField(e[o],"ERR_"+n.toUpperCase()+"_DATE",["{"+n.toUpperCase()+"_"+e[o].toUpperCase()+"}","{"+n.toUpperCase()+"_"+e[h].toUpperCase()+"}"])}static Compare(n,t){return(n===null||n===undefined)&&(t===null||t===undefined)?0:n===null||n===undefined?1:t===null||t===undefined?-1:n<t?-1:n>t?1:0}static isDateVisible(n,t,i){let r=0,u=0;if(i===null||i===undefined||i.length===null||i.length===undefined||i.length===0)return!1;for(r=0;r<i.length&&i[r].indexOf(n)>=0;r++);if(r===i.length)return!0;if(i.length===1)return!1;for(r=0;r<i.length;r++){let f=i[r].indexOf(n);if(!(f<0)){for(u=f-1;u>=0&&Dates.isDateVisible(i[r][u],t,i);u--);if(u<0&&t[n]!==null&&t[n]!==undefined)return!0}}let f=0;for(r=1;r<i.length;r++)i[r].length<i[f].length&&(f=r);return i[f].indexOf(n)>=0}static getLongestPath(n,t){if(t===null||t===undefined||t.length===null||t.length===undefined||t.length===0)return[];if(t.length===1)return t[0];let i=0;for(let r=0;r<t[0].length;r++)Dates.isDateVisible(t[0][r],n,t)&&i++;let r=0;for(let u=1;u<t.length;u++)if(!(i>=t[u].length)){let f=0;for(let i=0;i<t[u].length;i++)Dates.isDateVisible(t[u][i],n,t)&&f++;i<f&&(r=u,i=f)}return t[r]}}class Errors{get HasError(){return Object.keys(this._fields).length>0||Object.keys(this._errors).length>0||this._global.length>0}clear(){this._errors={};this._fields={};this._global=[]}addError(n,t){t!==null&&t!==undefined&&t.HasError&&(this._errors[n]||(this._errors[n]=[]),this._errors[n].push(t))}addField(n,t,i){this._fields[n]||(this._fields[n]={ignore:!1,errors:[]});this._fields[n].errors.push({message:t,parameters:i})}getField(n){let t=this._fields[n];if(t===null||t===undefined||Array.isEmpty(t.errors))return null;var i="<ul>";for(let n in t.errors){let r=t.errors[n];i+="<li>";i+=Helper.Span(r.message,r.parameters);i+="<\/li>"}return i+="<\/ul>"}ignoreField(n){this._fields[n]||(this._fields[n]={ignore:!0,errors:[]});this._fields[n].ignore=!0}addGlobal(n,t){this._global.push({message:n,parameters:t})}setJSON(n){var t,i;this.clear();t=0;for(i in n.Fields)for(this._fields[i]={ignore:!1,errors:[]},t=0;t<n.Fields[i].length;t++)this._fields[i].errors.push({message:n.Fields[i][t].Message,parameters:n.Fields[i][t].Parameters});for(t=0;t<n.Globals.length;t++)this._global.push({message:n.Globals[t].Message,parameters:n.Globals[t].Parameters})}summary(){var r;if(!this.HasError)return"";var i=0,t=null,n="<ul>",u=0;for(r in this._fields)if(this._fields[r].ignore!==!0){u++;n+="<li>";n+=String.encode(r);n+="<ul>";for(i in this._fields[r].errors)t=this._fields[r].errors[i],n+="<li>",n+=Helper.Span(t.message,t.parameters),n+="<\/li>";n+="<\/ul>";n+="<\/li>"}for(t in this._errors){u++;n+="<li>";n+=String.encode(t);n+="<ul>";for(i in this._errors[t])n+="<li>",n+=this._errors[t][i].summary(),n+="<\/li>";n+="<\/ul>";n+="<\/li>"}if(u===0&&this._global.length===0)return"";if(u===0&&this._global.length===1)return Helper.Span(this._global[0].message,this._global[0].parameters);for(i in this._global)t=this._global[i],n+="<li>",n+=Helper.Span(t.message,t.parameters),n+="<\/li>";return n+"<\/ul>"}toString(n){var u;if(!this.HasError)return"";(n===null||n===undefined)&&(n="FR");var r=0,i=null,t="";for(u in this._fields){t.length!==0&&(t+=", ");t+=u+": {";for(r in this._fields[u].errors)i=this._fields[u].errors[r],r!=="0"&&(t+=", "),t+=Language.Manager.Instance.interpolation(i.message,i.parameters,n);t+="}"}for(i in this._errors){t.length!==0&&(t+=", ");t+=i+": {";for(r in this._errors[i])t+=this._errors[i][r].toString(n),r!=="0"&&(t+=", ");t+="}"}for(r in this._global)i=this._global[r],t.length!==0&&(t+=", "),t+=Language.Manager.Instance.interpolation(i.message,i.parameters,n);return t}constructor(n,t){this._errors={};this._fields={};this._global=[];n!==undefined&&this.addGlobal(n,t)}}class Helper{static Label(n,t,i){var r={label:null,parameters:null,language:null};return typeof n=="string"?r={label:n,parameters:t?t:null,language:i?i:null}:n!==null&&n!==undefined&&typeof n=="object"&&(r={label:n.label,parameters:n.parameters,language:n.language},r.parameters=t?t:r.parameters,r.language=i?i:r.language),r.parameters===null||r.parameters===undefined||Array.isArray(r.parameters)||(r.parameters=[r.parameters]),r}static IsLabel(n,t){return n===null||n===undefined?!1:typeof n=="string"&&!String.isEmptyOrWhiteSpaces(n)&&(t===null||t===undefined||!t)?!0:n.label!==undefined&&n.language!==undefined&&n.parameters!==undefined}static Span(n,t,i){var r=Helper.Label(n,t,i),u,f;if(String.isEmptyOrWhiteSpaces(r.label))return"";if(u="<span",r.language!==null&&r.language!==undefined&&(u+=' k-language="'+r.language+'"'),r.label!==null&&r.label!==undefined&&(u+=' k-label="'+r.label+'"'),r.parameters!==null&&r.parameters!==undefined&&r.parameters.length>0)for(f in r.parameters)u+=" k-label-"+f+'="'+r.parameters[f]+'"';return u+">"+String.encode(Language.Manager.Instance.interpolation(r))+"<\/span>"}static Option(n,t,i,r){var u=Helper.Label(t,i,r),f,e;if(String.isEmptyOrWhiteSpaces(u.label))return"";if(f="<option",n!==null&&n!==undefined&&(f+=' value="'+n.toString()+'"'),u.language!==null&&u.language!==undefined&&(f+=' k-language="'+u.language+'"'),u.label!==null&&u.label!==undefined&&(f+=' k-label="'+u.label+'"'),u.parameters!==null&&u.parameters!==undefined&&u.parameters.length>0)for(e in u.parameters)f+=" k-label-"+e+'="'+u.parameters[e]+'"';return f+">"+String.encode(Language.Manager.Instance.interpolation(u))+"<\/option>"}}class Logger{static get LOG_FILENAME(){return"log.txt"}static get MAX_LINES(){return 1e5}get IsVerbose(){return this._isVerbose}set IsVerbose(n){this._isVerbose=n===!0;this._isDebug=this._isVerbose===!0}get IsDebug(){return this._isDebug}set IsDebug(n){this._isDebug=n===!0}get IsEnabled(){return this._isEnabled}set IsEnabled(n){this._isEnabled=n===!0}get Visible(){return this._logTable?this._logTable.isVisible():!1}downloadLogFile(){function r(n,t){return function(i){var r=n.getItem(i);t.push(r.id.toString().padEnd(8," ")+" "+r.date+" ["+r.level+"] "+String.decode(r.module).padEnd(48," ")+" "+r.allDescription)}}var t,i,n;return this._logTable?(t=[],this._logTable.eachRow(r(this._logTable,t)),i=new Blob([t.join("\n")],{type:"text/plain;charset=utf-8"}),this._logFile!==null&&window.URL.revokeObjectURL(this._logFile),this._logFile=window.URL.createObjectURL(i),n=document.createElement("a"),n.setAttribute("download",Logger.LOG_FILENAME),n.href=this._logFile,document.getElementById("log").appendChild(n),window.requestAnimationFrame(function(){var t=new MouseEvent("click");n.dispatchEvent(t);document.getElementById("log").removeChild(n)}),!0):!0}write(n,t,i){var u={id:this._id,date:(new Date).toISOString(),level:n,module:t,message:i},r,f;this._id++;this.define();this._isEnabled&&this._logTable&&(r=String.encode(u.message),f=null,f=r.length>4096?r.substring(0,4096)+"[...]":r,this._logTable.add({id:this.id,date:u.date,level:u.level,module:String.encode(u.module),description:f,allDescription:r}),this._logTable.count()>Logger.MAX_LINES&&this._logTable.remove(this._logTable.getFirstId()))}adjustWebix(n){function i(n,t,i){var r,u,f;if(i!==null&&i!==undefined){for(r=1,u=0;u<t.length;u++)f=n._logTable.getColumnConfig(t[u]),$(n._logAdjustedZoneHTML).css("width",f.width+"px"),$(n._logAdjustedZoneHTML).css("height","1px"),n._logAdjustedZoneHTML.innerHTML=n._logTable.getText(i.id,f.id),r<n._logAdjustedZoneHTML.scrollHeight&&(r=n._logAdjustedZoneHTML.scrollHeight),n._logAdjustedZoneHTML.innerHTML="";i.$height=r}}function u(n,t){return function(r){i(n,t,r)}}var t,r;if(this._logTable!==null){this._logAdjustedZone===null&&(this._logAdjustedZone=$("<div class='webix_view webix_dtable webix_log'><div class='webix_ss_body'><div class='webix_ss_center'><div class='webix_ss_center_scroll'><div class='webix_column'><div class='webix_cell'><\/div><\/div><\/div><\/div><\/div><\/div>"),this._logAdjustedZone.css("visibility","hidden"),$(this._logTable.$view).append(this._logAdjustedZone),this._logAdjustedZoneHTML=this._logAdjustedZone.find("> div > div > div > div > div")[0]);t=[];for(r in this._logTable.config.columns)t.push(this._logTable.config.columns[r].id);n!==null&&n!==undefined?(i(this,t,this._logTable.getItem(n)),this._logTable.refresh(n)):(this._logTable.data.each(u(this,t)),this._logTable.refresh())}}define(){function t(n){return function(t){n.adjustWebix(t)}}function n(n,t){return function(n){switch(n.level){case"V":return"<span class='verbose'>"+n[t]+"<\/span>";case"D":return"<span class='debug'>"+n[t]+"<\/span>";case"I":return"<span class='info'>"+n[t]+"<\/span>";case"W":return"<span class='warning'>"+n[t]+"<\/span>";case"E":return"<span class='error'>"+n[t]+"<\/span>";default:return n[t]}}}function i(n){return function(){clearTimeout(n._throttle);n._throttle=setTimeout(function(){n._logTable.isVisible()&&n._logTable.resize()},100)}}if(this._isEnabled&&!this._logTable){this._logTable=new webix.ui({view:"datatable",container:$("log")[0],css:"webix_log",scroll:"y",scrollAlignY:!1,columns:[{id:"date",header:"Date",adjust:"data",fillspace:2,css:{"text-align":"center"},template:n(this,"date")},{id:"level",header:"Level",adjust:"header",fillspace:1,css:{"text-align":"center"},template:n(this,"level")},{id:"module",header:"Module",adjust:"data",fillspace:2,css:{"text-align":"center"},template:n(this,"module")},{id:"description",header:"Description (<a href='#' onclick='javascript:Logger.Instance.downloadLogFile();'>client<\/a> - <a href='/Administration/Administration/Log?date="+(new moment).format("YYYY-MM-DD")+"' target='_blank'>server<\/a>)",adjust:"data",fillspace:15,css:{"text-align":"left"},template:n(this,"description")}],resizeColumn:!0,fixedRowHeight:!1,rowLineHeight:15,rowHeight:15,on:{onItemDblClick:t(this)}});this._logTable.hide();$(window).on("resize",i(this));this.write("I","Log","-----------------------------------------------------");this.write("I","Log","Module : "+this._moduleArea);this.write("I","Log","Version : "+this._moduleVersion);this.write("I","Log","Parameters : "+window.location.search);this.write("I","Log","-----------------------------------------------------");this.id++}}setModule(n,t){this._moduleArea=n;this._moduleVersion=t}show(){(this.define(),this._logTable)&&($("page").hide(),$("log").show(),this._logTable.show())}hide(){(this.define(),this._logTable)&&(this._logTable.hide(),$("log").hide(),$("page").show())}verbose(n,t){this._isVerbose&&this.write("V",n,t)}debug(n,t){this._isDebug&&this.write("D",n,t)}info(n,t){this.write("I",n,t)}warn(n,t){this.write("W",n,t)}error(n,t){this.write("E",n,t)}exception(n,t,i){i.message&&(t+=" : "+i.message);i.stack&&(t+=" | stack: "+i.stack);typeof i=="string"&&(t+=" : "+i);this.write("E",n,t)}status(n){function u(){return function(){$("header > ul > li.status").hasClass("started")===!0?($("header > ul > li.status").removeClass("started"),$("header > ul > li.status").addClass("stopped")):($("header > ul > li.status").removeClass("stopped"),$("header > ul > li.status").addClass("started"))}}this._currentStatus=n;let i=$("header > ul > li.status");i.unbind();var t=null,r=["starting","started","stopping","stopped","readytosynchronize"];switch(n){case"Starting":t="starting";this._currentStatus="STATUS_STARTING";break;case"Started":t="started";this._currentStatus="STATUS_STARTED";break;case"Stopping":t="stopping";this._currentStatus="STATUS_STOPPING";break;case"Error":case"NotInitialized":case"Stopped":t="stopped";this._currentStatus="STATUS_STOPPED";break;case"ReadyToSynchronize":t="readytosynchronize";this._currentStatus="STATUS_READY";$("header > ul > li.status").click(function(){Hub.Instance.synchronize()})}this._intervalStatus!==null&&(window.clearInterval(this._intervalStatus),this._intervalStatus=null);for(let n=0;n<r.length;n++)i.removeClass(r[n]);t==="starting"||t==="stopping"?this._intervalStatus=window.setInterval(u(this),1e3):t!==null&&i.addClass(t);i.hover(function(){$('<p class="image webix_tooltip"><\/p>').html(Helper.Span(Logger.Instance._currentStatus)).appendTo("body").fadeIn("slow")},function(){$(".image.webix_tooltip").remove()}).mousemove(function(n){var t=n.pageX+10,i=n.pageY;$(".image.webix_tooltip").css({top:i,left:t})})}constructor(){this._isVerbose=!1;this._isDebug=!1;this._isEnabled=!1;this._logTable=null;this._logAdjustedZone=null;this._logAdjustedZoneHTML=null;this._currentStatus=null;this._logFile=null;this._id=0;this._moduleArea="";this._moduleVersion="";this._intervalStatus=null;this._throttle=null}static get Instance(){return this._instance||(this._instance=new Logger),this._instance}}class LoggerBaseObject{get Module(){return this._module}get IsVerbose(){return Logger.Instance.IsVerbose}get IsDebug(){return Logger.Instance.IsDebug}verbose(n){Logger.Instance.IsVerbose&&Logger.Instance.verbose(this._module,n)}debug(n){Logger.Instance.IsDebug&&Logger.Instance.debug(this._module,n)}info(n){Logger.Instance.info(this._module,n)}warn(n){Logger.Instance.warn(this._module,n)}error(n){Logger.Instance.error(this._module,n)}exception(n,t){Logger.Instance.exception(this._module,n,t)}toString(){return String.JSONStringify(this)}constructor(n){this._module=n}}class CSV extends LoggerBaseObject{get Headers(){return this._headers}get Charset(){return this._charset}get Separator(){return this._separator}addLine(n){this._lines.push({_table:n===undefined||n===null?null:n});this._lineNumber++}addRecord(n,t,i){if(t!==null&&t!==undefined){this._lines[this._lineNumber-1][n]=t===null||t===undefined?null:t;let u=this._tablesByName[n];if(u!==undefined){for(let n in t)n.startsWith("_")||u[n].ignore||typeof t[n]=="string"&&t[n].startsWith("data:image/")&&(u[n].ignore=!0);return}(i===null||i===undefined)&&t._list!==undefined&&t._list!==null&&(i=t._list);u={_table:n,_list:i===null||i===undefined?null:i};this._tablesByName[n]=u;this._tablesByOrder.push(u);let r=null;for(r in t)r==="Id"&&(u[r]={table:n,attribut:r,label:n+"."+r,list:u._list,ignore:!1},this._headers.push(u[r]));for(r in t)if(!r.startsWith("_")&&r!=="Id"){let i=r==="CustomerId"||r.startsWith("Copy");i||t._list===null||t._list===undefined||t._list.column!==r||(i=!0);u[r]={table:n,attribut:r,label:n+"."+r,list:u._list,ignore:i};this._headers.push(u[r])}}}addList(n,t){function i(n,r,u){return function(f){var o,e;n.addLine(r.Table);for(let t in u)n.addRecord(u[t].list.Table,u[t].record,u[t].list);if(n.addRecord(r.Table,f,r),f._subLists!==null&&f._subLists!==undefined){u.push({list:r,record:f});for(o in f._subLists)if(e=f._subLists[o],e!==null&&e!==undefined&&(e.composition||t)){let r=f[o];for(let t in r)i(n,e.list,u)(r[t])}u.pop()}}}n!==null&&n!==undefined&&(t=t!==null&&t!==undefined&&t===!0,n.each(i(this,n,[])))}toBlob(n,t){let i=0,u=0,e=[],r=[],f="";for(this.info("Building CSV file ..."),this._charset=n,String.isEmptyOrWhiteSpaces(this._charset)&&(this._charset="utf-8"),this._separator=t,String.isEmptyOrWhiteSpaces(this._separator)&&(this._separator=";"),i=0;i<this._headers.length;i++)this._headers[i].ignore||r.push(this._headers[i].label);for(e.push(r),i=0;i<this._lines.length;i++){let n=this._lines[i];for(r=[],u=0;u<this._headers.length;u++){let t=this._headers[u];if(!t.ignore){if(t.table===null&&t.attribut==="line"){r.push(i+1);continue}if(t.table===null&&t.attribut==="table"){r.push(n._table);continue}if(t===null||t===undefined){r.push(null);continue}let f=n[t.table];if(f===null||f===undefined){r.push(null);continue}let e=null;e=t.list===null?f[t.attribut]:t.list.getAttributText(f,t.attribut);r.push(e)}}e.push(r)}for(f=this._charset.toLowerCase()==="iso-8859-15"?"ï»¿":"",i=0;i<e.length;i++){for(r=e[i],u=0;u<r.length;u++)f+=String.convertCSV(r[u],this._separator),u<r.length-1&&(f+=this._separator);f+="\n"}return this.info("CSV file built"),[f]}constructor(){super("CSV");this._charset="utf-8";this._separator=";";this._lineNumber=0;this._lines=[];this._tablesByOrder=[];this._tablesByName={};this._headers=[];this._headers.push({table:null,attribut:"line",label:"line",list:null,ignore:!1});this._headers.push({table:null,attribut:"table",label:"table",list:null,ignore:!1})}}let _PDF_FONT_NAME="roboto",_PDF_INITIALIZATION_DONE=!1;class PDF{static get MAX_WIDTH_A4(){return Math.ceil(8.27*72)}static get MAX_HEIGHT_A4(){return Math.ceil(11.69*72)}static get ROOT_DIRECTORY(){return URL_ROOT+"Content/Fonts/"}static get ROOT_WEBSITE(){return"www.syncytium.fr"}static get FONT_NAME(){return _PDF_FONT_NAME}static set FONT_NAME(n){_PDF_FONT_NAME=n}static get INITIALIZATION_DONE(){return _PDF_INITIALIZATION_DONE}static set INITIALIZATION_DONE(n){_PDF_INITIALIZATION_DONE=n}static Initialize(n){function i(n,t){return function(i,r){GUI.Box.Progress.SetStatus();Logger.Instance.info("PDF","Font '"+n+"' loaded with status: "+r);PDF.INITIALIZATION_DONE=!0;t()}}function r(n,t){return function(i,r){GUI.Box.Progress.SetStatus();Logger.Instance.error("PDF","Unable to load the font '"+n+"' due to "+r);PDF.INITIALIZATION_DONE=!1;t()}}if(PDF.INITIALIZATION_DONE){n();return}(pdfMake.tableLayouts===undefined||pdfMake.tableLayouts===null)&&(pdfMake.tableLayouts={});pdfMake.tableLayouts.tableLayout={hLineWidth:function(n,t){return n===t.table.body.length||n<=t.table.headerRows?1:0},vLineWidth:function(){return 1},hLineColor:function(){return"#666666"},vLineColor:function(){return"#666666"}};(pdfMake.fonts===undefined||pdfMake.fonts===null)&&(pdfMake.fonts={});var t=null;switch(PDF.FONT_NAME){case"arial-unicode-ms":pdfMake.fonts[PDF.FONT_NAME]={normal:"arial-unicode-ms.ttf",bold:"arial-unicode-ms.ttf",italics:"arial-unicode-ms.ttf",bolditalics:"arial-unicode-ms.ttf"};t="arial-unicode-ms";break;case"dejavu":pdfMake.fonts[PDF.FONT_NAME]={normal:"DejaVuSans.ttf",bold:"DejaVuSans-Bold.ttf",italics:"DejaVuSans-Oblique.ttf",bolditalics:"DejaVuSans-BoldOblique.ttf"};t="dejavusans";break;case"dejavu-condensed":pdfMake.fonts[PDF.FONT_NAME]={normal:"DejaVuSansCondensed.ttf",bold:"DejaVuSansCondensed-Bold.ttf",italics:"DejaVuSansCondensed-Oblique.ttf",bolditalics:"DejaVuSansCondensed-BoldOblique.ttf"};t="dejavusans";break;case"opensans":pdfMake.fonts[PDF.FONT_NAME]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-Bold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-BoldItalic.ttf"};t="opensans";break;case"opensans-extra":pdfMake.fonts[PDF.FONT_NAME]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-ExtraBold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-ExtraBoldItalic.ttf"};t="opensans";break;case"opensans-light":pdfMake.fonts[PDF.FONT_NAME]={normal:"OpenSans-Light.ttf",bold:"OpenSans-Regular.ttf",italics:"OpenSans-LightItalic.ttf",bolditalics:"OpenSans-Italic.ttf"};t="opensans";break;case"opensans-semi":pdfMake.fonts[PDF.FONT_NAME]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-Semibold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-SemiboldItalic.ttf"};t="opensans";break;case"microsoft-yaihei":pdfMake.fonts[PDF.FONT_NAME]={normal:"msyh.ttf",bold:"msyh.ttf",italics:"msyh.ttf",bolditalics:"msyh.ttf"};t="msyh";break;default:PDF.FONT_NAME="roboto";pdfMake.fonts[PDF.FONT_NAME]={normal:"Roboto-Regular.ttf",bold:"Roboto-Medium.ttf",italics:"Roboto-Italic.ttf",bolditalics:"Roboto-MediumItalic.ttf"};t="roboto"}if(window.pdfMake!==null&&window.pdfMake!==undefined&&window.pdfMake.vfs!==null&&window.pdfMake.vfs!==undefined&&window.pdfMake.vfs[pdfMake.fonts[PDF.FONT_NAME].normal]!==null&&window.pdfMake.vfs[pdfMake.fonts[PDF.FONT_NAME].normal]!==undefined){PDF.INITIALIZATION_DONE=!0;n();return}$.ajax({url:PDF.ROOT_DIRECTORY+"pdfmake-"+t+".js",dataType:"script",success:i(t,n),error:r(t,n)})}static Create(n){return{pageSize:"A4",pageOrientation:"portrait",pageMargins:[20,90,20,30],compress:!1,header:function(t){var i={columns:[{image:"image_0",width:100,height:32,margin:[15,10,0,0]},{image:"image_1",width:345,margin:[20,26,20,0],height:1},{text:PDF.ROOT_WEBSITE,width:150,margin:[0,22,15,0],style:"url"}]};return t>1&&n!==null&&n!==undefined&&(i=[i,{text:Language.Manager.Instance.interpolation(n).toUpperCase(),style:"subtitle"}]),i},content:[{text:n!==null&&n!==undefined?Language.Manager.Instance.interpolation(n).toUpperCase():"",decoration:"underline",decorationColor:"#7dc142",style:"title"}],images:{image_0:{name:"image_0",src:URL_ROOT+"Content/Images/PDF/Syncytium.png"},image_1:{name:"image_1",src:URL_ROOT+"Content/Images/PDF/Line.png"}},styles:{url:{fontSize:10,bold:!1,color:"#3a6bbb",alignment:"right"},title:{fontSize:26,bold:!1,color:"#333333",alignment:"center",margin:[0,0,0,10]},subtitle:{fontSize:12,bold:!0,color:"#333333",alignment:"left",margin:[20,15,0,10]},legend:{fontSize:6,bold:!1,color:"#333333",alignment:"center",italics:!0,margin:0},boardTitle:{fontSize:22,bold:!1,color:"#3a6bbb",alignment:"left",margin:[0,15,0,15]},tableHeader:{fontSize:6,italics:!0,bold:!0,color:"#ffffff",fillColor:"#bfbfbf",margin:0},tableCell:{fontSize:6,italics:!1,bold:!1,fillColor:"#ffffff",color:"#666666",margin:[0,0,0,0]},tableCellOdd:{fontSize:6,italics:!1,bold:!1,color:"#666666",fillColor:"#ebebeb",margin:[0,0,0,0]}},defaultStyle:{font:PDF.FONT_NAME},footer:function(n,t){return{text:Language.Manager.Instance.interpolation("PDF_PAGE",[n.toString(),t.toString()],DSDatabase.Instance.CurrentLanguage),fontSize:8,alignment:"center"}}}}static AddImage(n,t){var u=0,i,r;for(i in n.images){if(r=n.images[i],r.src===t)return r.name;u++}return i="image_"+u.toString(),n.images[i]={name:i,src:t},i}static CreateTable(n,t,i,r,u){for(var e=0,f=0,d=0,c=0,g=1,o={headerRows:2,dontBreakRows:!0,widths:[],body:[]},p,v,l,a,s,h,w,nt,b,y,k,e=0;e<i.length;e++)c+=i[e].size;for(c>0&&(g=(PDF.MAX_WIDTH_A4-n.pageMargins[0]-n.pageMargins[2]-10*i.length)/c),c=0,String.isEmptyOrWhiteSpaces(t)||o.body.push([{text:Language.Manager.Instance.interpolation(t),colSpan:i.length,style:"boardTitle",border:[!1,!1,!1,!0]}]),o.body.push([]),e=0;e<i.length;e++)p=Math.ceil(i[e].size*g)+1,v=Language.Manager.Instance.interpolation(i[e].title),v=v===null?"":v.toUpperCase(),e===i.length-1&&(p=PDF.MAX_WIDTH_A4-n.pageMargins[0]-n.pageMargins[2]-9*i.length-c+1),o.widths.push(p),o.body[o.body.length-1].push({text:v,alignment:"center",style:"tableHeader"}),e>0&&o.body.length>1&&o.body[0].push({}),c+=p;for(e in u)if(l=u[e],l!==null&&l!==undefined&&r.isVisible(l)){for(a=d%2==0?"tableCell":"tableCellOdd",s=[],f=0;f<i.length;f++){if(h=r.getAttributText(l,i[f].field),w=r.getAttributHTML(l,i[f].field),!String.isEmptyOrWhiteSpaces(h)&&!String.isEmptyOrWhiteSpaces(w)&&h===String.decode(w)){s.push({text:h,alignment:i[f].align,style:a});continue}if(nt=$(w),b=nt.attr("src"),b===undefined){s.push({text:h,alignment:i[f].align,style:a});continue}y=PDF.AddImage(n,b);i[f].legend!==null&&i[f].legend!==undefined&&i[f].legend&&!String.isEmptyOrWhiteSpaces(h)?(k=null,k=i[f].width!==undefined&&i[f].height!==undefined?{image:y,width:i[f].width,height:i[f].height,alignment:i[f].align}:{image:y,alignment:i[f].align},s.push({stack:[k,{text:h,style:"legend"}],style:a})):i[f].width!==undefined&&i[f].height!==undefined?s.push({image:y,width:i[f].width,height:i[f].height,alignment:i[f].align,style:a}):s.push({image:y,alignment:i[f].align,style:a})}o.body.push(s);d++}n.content.push({table:o,layout:"tableLayout"})}static Finalize(n,t,i){function e(n,r){return function(e){try{n.images[r]=e;f++;f===u&&t(n)}catch(o){Logger.Instance.exception("PDF","Unable to create PDF file",o);i("ERR_DOWNLOAD_PDF")}}}try{var u=0,r=null,f=0;for(r in n.images)u++;if(u===0){t(n);return}for(r in n.images)Picture.loadSVG(n.images[r].src,e(n,r))}catch(o){Logger.Instance.exception("PDF","Unable to create PDF file",o);i("ERR_DOWNLOAD_PDF")}}}class Picture{static resize(n,t,i,r){var u=document.createElement("img");u.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height+" => width: "+t+" x height: "+i);var n=document.createElement("canvas"),f=n.getContext("2d");n.width=t;n.height=i;f.drawImage(this,0,0,this.width,this.height,0,0,n.width,n.height);r(n.toDataURL("image/png",1));this.onload=null;n.remove();u.remove()};u.src=n}static loadPNG(n,t){var i=new Image;i.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height);var n=document.createElement("canvas"),r=n.getContext("2d");n.height=this.height;n.width=this.width;r.drawImage(this,0,0);t(n.toDataURL("image/png",1));this.onload=null;n.remove();i.remove()};i.src=n}static loadSVG(n,t){var i=new Image;i.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height);var n=document.createElement("canvas"),r=n.getContext("2d");n.height=this.height;n.width=this.width;r.drawImage(this,0,0);t(n.toDataURL("image/svg+xml"));this.onload=null;n.remove();i.remove()};i.src=n}}class SortArray{static find(n,t,i){let r=null;switch(n.length){case 0:return{index:0,newIndex:!0};case 1:return(r=i(n[0],t),r<0)?{index:1,newIndex:!0}:r>0?{index:0,newIndex:!0}:{index:0,newIndex:!1}}let u=0,f=n.length-1;if(r=i(n[u],t),r>0)return{index:u,newIndex:!0};if(r===0)return{index:u,newIndex:!1};if(r=i(n[f],t),r<0)return{index:f+1,newIndex:!0};if(r===0)return{index:f,newIndex:!1};let e=Math.floor((u+f)/2);while(e!==u&&e!==f){if(r=i(n[e],t),r===0)return{index:e,newIndex:!1};r<0?u=e:f=e;e=Math.floor((u+f)/2)}return{index:u+1,newIndex:!0}}}class Similarity{static pairs(n){var t=[],r=n.length,i;if(r<2)return t;for(n=n.toUpperCase(),i=0;i<r-1;i++)t.push(n.substr(i,2));return t.sort(function(n,t){return n<t?-1:n>t?1:0}),t}static computeWord(n,t){var f=Similarity.pairs(n),u;if(f.length===0||(u=Similarity.pairs(t),u.length===0)||n.length<2||t.length<2)return 0;for(var s=0,h=0,c=0,i=0,r=0,e=f.length,o=u.length;i<e&&r<o;)if(f[i]===u[r]){for(c++,s++,h++,i++;i<e&&f[i]===f[i-1];i++);for(r++;r<o&&u[r]===u[r-1];r++);}else if(f[i]<u[r])for(s++,i++;i<e&&f[i]===f[i-1];i++);else for(h++,r++;r<o&&u[r]===u[r-1];r++);while(i<e)for(s++,i++;i<e&&f[i]===f[i-1];i++);while(r<o)for(h++,r++;r<o&&u[r]===u[r-1];r++);return 2*c/(s+h)}static words(n){var i=n.toUpperCase().replace(/[&\/\\#,+()$~%.'":*?!<>{}]/g," ").split(" "),r,t;for(i.sort(function(n,t){return n<t?-1:n>t?1:0}),r=[],t=0;t<i.length;t++)String.isEmptyOrWhiteSpaces(i[t])||t>0&&i[t]===i[t-1]||i[t].length<2||r.push(i[t]);return r}static rank(n,t){var u,i,f,e;if(String.isEmptyOrWhiteSpaces(n)||String.isEmptyOrWhiteSpaces(t))return 0;var r=Similarity.words(n),o=Similarity.words(t),s=0;for(u=0;u<r.length;u++){for(i=0,f=0;f<o.length&&i<1;f++)e=Similarity.computeWord(r[u],o[f]),e>i&&(i=e);s+=i}return r.length===0?0:s/r.length}static ranks(n,t){for(var u,i=0,r=0;r<t.length&&i<1;r++)u=Similarity.rank(n,t[r]),u>i&&(i=u);return i}}String.HEX_DIGITS=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];String.encode=function(n){return $("<div/>").text(n).html()};String.decode=function(n){return $("<div/>").html(n).text()};String.protect=function(n,t){return n.replace(new RegExp(t,"g"),"\\"+t)};String.isEmptyOrWhiteSpaces=function(n){return n===null||n===undefined||typeof n=="string"&&n.match(/^\s*$/)!==null};String.isEmailValide=function(n){return n&&/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(n)};String.getStringFromJSON=function(n){return this.isEmptyOrWhiteSpaces(n)?"":n.trim()};String.prototype.startsWith||(String.prototype.startsWith=function(n,t){return t=t||0,this.substr(t,n.length)===n});String.prototype.padEnd||(String.prototype.padEnd=function(n,t){if(!t||typeof t!="string"||t.length===0||!n||typeof n!="number"||n===0||t.length>=n)return this;for(var i=t;i.length<n;)i+=t;return(i+this).slice(-n)});String.convertValue=function(n){return n===null||n===undefined?null:typeof n=="boolean"?n?"1":"0":(typeof n!="string"&&(n=n.toString()),n=n.trim(),n===""?null:n)};String.parseInt=function(n){return/^(\-|\+)?([0-9]+|Infinity)$/.test(n)?Number(n):NaN};String.parseFloat=function(n){return/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(n)?Number(n):/^(\-|\+)?([0-9]+(\,[0-9]+)?|Infinity)$/.test(n)?Number(n.replace(",",".")):NaN};String.parseRGBToHEX=function(n){function t(n){return isNaN(n)?"00":String.HEX_DIGITS[(n-n%16)/16]+String.HEX_DIGITS[n%16]}return n=n.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+t(n[1])+t(n[2])+t(n[3])};String.convertCSV=function(n,t){var i="";if(n===null||n===undefined)return i;switch(typeof n){case"string":i=n;break;case"number":i=n.toString().replace(".",",");break;case"boolean":i=String.convertValue(n);break;default:i=n instanceof Date?moment(n.toString()).format("YYYY/MM/DD HH:mm:ss.SSS"):n instanceof moment?moment(n).format("YYYY/MM/DD HH:mm:ss.SSS"):n.toString()}return(i.indexOf(t)>0||i.indexOf('"')>0||isNaN(String.parseFloat(i))||!isFinite(i))&&(i='"'+i.replace(/"/g,"'").replace(/\n/g," ")+'"'),i};String.convertBoolean=function(n){return typeof n=="string"&&(n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1")||typeof n=="boolean"&&n||typeof n=="number"&&n!==0};String.compare=function(n,t){return n=String.convertValue(n),n=n===null?"":n.toUpperCase(),t=String.convertValue(t),t=t===null?"":t.toUpperCase(),n<t?-1:n>t?1:0};String.in=function(n,t){return n=String.convertValue(n),n=n===null?"":n.toUpperCase(),t=String.convertValue(t),t=t===null?"":t.toUpperCase(),n.indexOf(t)>=0};String.JSONStringify=function(n){return JSON.stringify(n,function(n,t){return n==="_subLists"||n==="_list"||n==="_parent"?undefined:t})};Digits={};Digits.Digits=(class{static Factory(n){let t=null;if(String.isEmptyOrWhiteSpaces(n)||typeof n!="string")return null;if(t=n.match(/^\_*0+(\,0+){0,1}$/),t!==null)return new Digits.Decimal(t[0].length-(t[1]===undefined?0:t[1].length),t[1]===undefined?0:t[1].length-1);if(t=n.match(/^\D+(0+)$/),t!==null)return new Digits.Sequence(t[0].substr(0,t[0].length-t[1].length),t[1].length);if(t=n.match(/^((\W*)([\_0]+))+$/),t!==null)return new Digits.Mask(n);let i=new Digits.Datetime(n);return i.IsDateTime?i:null}get Type(){return"digit"}set Format(n){n=String.isEmptyOrWhiteSpaces(n)?this._formatDefault:n;this._tokenFormat=[];let t=0;while(t<n.length){let i={fix:"",format:"",type:"",digits:"",value:0};while(t<n.length&&n[t]!=="0"&&n[t]!=="_")i.fix+=n[t],t++;while(t<n.length&&(n[t]==="0"||n[t]==="_"))i.format+=n[t],t++;this._tokenFormat.push(i)}this._indexToken=null;this._format=n}get Format(){return this._format}get IsCalendar(){return!1}get IsNull(){return String.isEmptyOrWhiteSpaces(this._value)}set Value(n){this._tokenFormat=this.parseValue(n===null||n===undefined?null:n);this._value=this.formatValue();this._raz||(this._indexToken=null,this._undo=[])}get Value(){return this._value}get AllowNegativeValue(){return this._allowNegativeValue}toString(){return this._value}set IndexToken(n){n=n===null||n===undefined?0:n;this._indexToken=n<0||this._tokenFormat.length===0?0:n>=this._tokenFormat.length?this._tokenFormat.length-1:n}get IndexToken(){return this._indexToken}get HasUndo(){return this._undo.length>0}get NextTokenFix(){return this._indexToken<this._tokenFormat.length-1?this._tokenFormat[this._indexToken+1].fix:null}updateToken(n){return n}parseValue(n){let u=[],i=[],t=0,r=0;for(t=0;t<this._tokenFormat.length;t++)u.push({fix:this._tokenFormat[t].fix,format:this._tokenFormat[t].format,type:this._tokenFormat[t].type,digits:"",value:0});for(n=typeof n=="number"?n.toString():String.isEmptyOrWhiteSpaces(n)?"":n.toString(),t=0;t<n.length;){let r={fix:"",digits:""};while(t<n.length&&(n[t]<"0"||n[t]>"9"))r.fix+=n[t],t++;while(t<n.length&&"0"<=n[t]&&n[t]<="9")r.digits+=n[t],t++;i.push(r)}for(i.length>0&&String.isEmptyOrWhiteSpaces(i[0].fix)&&(i[0].fix=this._tokenFormat[0].fix),t=0,r=0;t<u.length&&r<i.length;){while(t<u.length&&r<i.length&&u[t].fix!==i[r].fix)t++;t<u.length&&r<i.length&&(u[r].digits=i[r].digits,u[r].value=parseInt(String.isEmptyOrWhiteSpaces(i[r].digits)?"0":i[r].digits));t++;r++}return this.updateToken(u)}formatValue(n){let t=String.isEmptyOrWhiteSpaces(n)?this._tokenFormat:this.parseValue(n);n="";for(let i=0;i<t.length;i++)if(t[i].format.length===0)n+=t[i].fix;else{let r=t[i].value.toString(),u="";if(r.length>t[i].format.length)r=r.substr(r.length-t[i].format.length,t[i].format.length);else for(let n=0;n<t[i].format.length-r.length;n++)u+=t[i].format[n]==="0"?"0":" ";n+=t[i].fix+u+r}return n}pushUndo(){if(this._indexToken===null){for(this._indexToken=0;this._indexToken<this._tokenFormat.length&&this._tokenFormat[this._indexToken].digits.length===this._tokenFormat[this._indexToken].format.length;this._indexToken++);this._indexToken>=this._tokenFormat.length&&(this._indexToken=this._tokenFormat.length-1)}let n={indexToken:this._indexToken,tokens:[]};for(let t=0;t<this._tokenFormat.length;t++)n.tokens.push({fix:this._tokenFormat[t].fix,format:this._tokenFormat[t].format,type:this._tokenFormat[t].type,digits:this._tokenFormat[t].digits,value:this._tokenFormat[t].value});if(this._undo.length>0){let t=this._undo[this._undo.length-1],i=n.indexToken===t.indexToken;for(let r=0;r<t.tokens.length&&i;r++)(t.tokens[r].fix!==n.tokens[r].fix||t.tokens[r].format!==n.tokens[r].format||t.tokens[r].type!==n.tokens[r].type||t.tokens[r].digits!==n.tokens[r].digits||t.tokens[r].value!==n.tokens[r].value)&&(i=!1);if(i)return}this._undo.push(n)}popUndo(){if(this._undo.length!==0){let n=this._undo.pop();this._tokenFormat=[];for(let t=0;t<n.tokens.length;t++)this._tokenFormat.push({fix:n.tokens[t].fix,format:n.tokens[t].format,type:n.tokens[t].type,digits:n.tokens[t].digits,value:n.tokens[t].value});this._value=this.formatValue();this._indexToken=n.indexToken}}addKey(n){if(this._indexToken===null||n==="raz"){this.pushUndo();for(let n=0;n<this._tokenFormat.length;n++)this._tokenFormat[n].digits="",this._tokenFormat[n].value=0;this._indexToken=0}if(n==="raz"){this._value=this.formatValue();return}if(n==="next"||this._indexToken<this._tokenFormat.length-1&&this._tokenFormat[this._indexToken+1].fix===n){this.pushUndo();this._indexToken<this._tokenFormat.length-1&&this._indexToken++;this._value=this.formatValue();return}if(n==="undo"){this.popUndo();this._undo.length===0&&this.selectAll();return}if(!(n<"0")&&!(n>"9")){let t=0;for(t=0;t<this._tokenFormat.length&&this._tokenFormat[t].format.length===this._tokenFormat[t].digits.length;t++);t!==this._tokenFormat.length&&(this.pushUndo(),this._tokenFormat[this._indexToken].digits+=n,this._tokenFormat[this._indexToken].value=parseInt(String.isEmptyOrWhiteSpaces(this._tokenFormat[this._indexToken].digits)?"0":this._tokenFormat[this._indexToken].digits),this.updateToken(this._tokenFormat),this._value=this.formatValue())}}selectAll(){this._tokenFormat=this.parseValue(this._value);this._value=this.formatValue();this._indexToken=null;this._undo=[]}RAZ(){this.pushUndo();this._raz=!0;this.Value=null;this._raz=!1;this._indexToken=0}clone(){let n=new Digits.Digits(this._formatDefault);return n.Value=this.Value,n._allowNegativeValue=this._allowNegativeValue,n}constructor(n){this._value=null;this._format=null;this._tokenFormat=null;this._indexToken=null;this._undo=[];this._formatDefault=String.isEmptyOrWhiteSpaces(n)?"000000000":n;this._raz=!1;this._allowNegativeValue=!1;this.Format=this._formatDefault;this.Value=null}});Digits.Decimal=(class extends Digits.Digits{static get EPSILON(){return 1e-5}static IsZero(n){return-Digits.Decimal.EPSILON<n&&n<Digits.Decimal.EPSILON}get Type(){return"decimal"}set Value(n){typeof n=="number"?n=n.toFixed(this._nbDigitAfter).toString().replace(".",","):String.isEmptyOrWhiteSpaces(n)||(n=n.trim());n!==null&&n.startsWith("-")?(this._negative=!0,n=n.substr(1)):this._negative=!1;super.Value=n}get Value(){let n=super.Value;return n===null?n:this._negative?-String.parseFloat(n.trim()):String.parseFloat(n.trim())}get NbDigitBefore(){return this._nbDigitBefore}get NbDigitAfter(){return this._nbDigitAfter}get AllowNegativeValue(){return super.AllowNegativeValue}set AllowNegativeValue(n){this._allowNegativeValue=n===null||n===undefined||n===!0}toString(){if(this._value===null)return"";let i=this._value.trim().split(","),n=parseInt(i[0]),t="";return(n>=1e6?(t+=((n-n%1e6)/1e6).toString()+".",n=n%1e6,t+=((n-n%1e3)/1e3).toString().padStart(3,"0")+".",n=n%1e3,t+=n.toString().padStart(3,"0")):n>=1e3?(t+=((n-n%1e3)/1e3).toString()+".",n=n%1e3,t+=n.toString().padStart(3,"0")):t=n.toString(),i.length>1&&(t+=","+i[1]),this._negative)?"-"+t:t}addKey(n){if(n==="minus"&&this._allowNegativeValue){this._negative=!this._negative;return}super.addKey(n==="."?",":n)}updateToken(n){if(n.length>1&&this._nbDigitAfter!==undefined){let t=n[1].digits.padEnd(this._nbDigitAfter,"0");t.length>n[1].format.length&&(t=t.substr(0,n[1].format.length),n[1].digits=t);n[1].value=parseInt(t)}return n[0].digits.length>n[0].format.length&&(n[0].digits=n[0].digits.substr(n[0].digits.length-n[0].format.length,n[0].format.length),n[0].value=parseInt(n[0].digits)),n}pushUndo(){if(super.pushUndo(),this._undo.length!==0){let n=this._undo[this._undo.length-1];n.indexToken<n.tokens.length-1||n.tokens[n.indexToken].digits.length<n.tokens[n.indexToken].format.length||this._undo.pop()}}clone(){let n=new Digits.Decimal(this._nbDigitBefore,this._nbDigitAfter);return n.Value=this.Value,n}constructor(n,t){n=n===null||n===undefined||n<=0?6:n;t=t===null||t===undefined||t<=0?0:t;let i="";for(let t=0;t<n-1;t++)i+="_";if(i+="0",t>0){i+=",";for(let n=0;n<t;n++)i+="0"}super(i);this._negative=!1;this._nbDigitBefore=n;this._nbDigitAfter=t;this.Value=null}});Digits.Mask=(class extends Digits.Digits{get Type(){return"mask"}get IsNull(){return super.IsNull?!0:super.Value===this._formatDefault}set Value(n){if(String.isEmptyOrWhiteSpaces(n)){super.Value=n;return}let t="";for(let i=0;i<this._tokenFormat.length&&n.length>0;i++)if(this._tokenFormat[i].format.length>0){let r=n.substr(0,this._tokenFormat[i].format.length);n=n.substr(this._tokenFormat[i].format.length);t+=this._tokenFormat[i].fix+r}super.Value=t}get Value(){let n="";for(let t=0;t<this._tokenFormat.length;t++)if(this._tokenFormat[t].format.length>0){let i=this._tokenFormat[t].value.toString(),r="";if(i.length>this._tokenFormat[t].format.length)i=i.substr(i.length-this._tokenFormat[t].format.length,this._tokenFormat[t].format.length);else for(let n=0;n<this._tokenFormat[t].format.length-i.length;n++)r+=this._tokenFormat[t].format[n]==="0"?"0":" ";n+=r+i}return n}updateToken(n){let i=this.IndexToken;if(i===null)return n;let t=n[i];if(t.digits.length<=t.format.length)return t.value=parseInt(t.digits.padEnd(t.format.length,"0")),n;let r=t.digits.substr(0,t.format.length),u=t.digits.substr(t.format.length);return(t.digits=r,t.value=parseInt(r),i>=n.length-1)?n:(t=n[i+1],t.digits=u,t.value=parseInt(u.padEnd(t.format.length,"0")),this.IndexToken=i+1,n)}pushUndo(){if(super.pushUndo(),this._undo.length!==0){let n=this._undo[this._undo.length-1];n.indexToken<n.tokens.length-1||n.tokens[n.indexToken].digits.length<n.tokens[n.indexToken].format.length||this._undo.pop()}}clone(){let n=new Digits.Mask(this._formatDefault);return n.Value=this.Value,n}constructor(n){super(n)}});Digits.Sequence=(class extends Digits.Digits{get Type(){return"sequence"}clone(){let n=new Digits.Sequence(this._key,this._length);return n.Value=this.Value,n}constructor(n,t){super(n+"".padEnd(t,"0"));this._key=n;this._length=t}});Digits.Datetime=(class extends Digits.Digits{get Type(){return"datetime"}get IsCalendar(){let i=this._indexToken===null?0:this._indexToken,t=this._tokenFormat[i];if(t===null||t===undefined)return!1;let n=this.CurrentType;return(n==="YYYY"||n==="MM"||n==="DD")&&this.WebixType!==null}get IsDateTime(){let n=["YYYY","MM","DD","HH","mm","ss","SSS"];for(let t=0;t<this._tokenFormat.length;t++)if(n.indexOf(this._tokenFormat[t].type)>=0)return!0;return!1}set Format(n){let t=["YYYY","MM","DD","HH","mm","ss","SSS"];n=String.isEmptyOrWhiteSpaces(n)?this._formatDefault:n;this._tokenFormat=[];let r=0,i={fix:"",format:"",type:"",digits:"",value:0};while(r<n.length){let u=0;for(u=0;u<t.length&&n.substr(r,t[u].length)!==t[u];u++);u<t.length?(i.type=t[u],i.format="".padEnd(t[u].length,"_"),r+=t[u].length,this._tokenFormat.push(i),i={fix:"",format:"",type:"",digits:"",value:0}):(i.fix+=n[r],r++)}String.isEmptyOrWhiteSpaces(i.fix)||this._tokenFormat.push(i);this._format=n;this._indexToken=null}get Format(){return this._format}get WebixFormat(){let t=["YYYY","MM","DD","HH","mm","ss","SSS"],i=["%Y","%m","%d","%H","%i","%s","%S"],n="";for(let r=0;r<this._tokenFormat.length;r++){n+=this._tokenFormat[r].fix;let u=t.indexOf(this._tokenFormat[r].type);n+=u>=0?i[u]:"".padEnd(this._tokenFormat[r].format.length," ")}return n}get WebixType(){let t=["YYYY","MM","DD"],i=[1,2,4],n=0;for(let r=0;r<this._tokenFormat.length;r++){let u=t.indexOf(this._tokenFormat[r].type);u>=0&&(n|=i[u])}return n===1?"year":n===2||n===3?"month":n===6||n===7?"day":null}get CurrentType(){let t=this._indexToken===null?0:this._indexToken,n=t<this._tokenFormat.length?this._tokenFormat[t]:null;return n===null?null:(n.digits.length>=n.format.length&&t<this._tokenFormat.length-1&&(n=this._tokenFormat[t+1]),n.type)}set Value(n){n instanceof Date&&(n=moment(n.toString()).format(this._format));n instanceof moment&&(n=n.format(this._format));super.Value=n}get Value(){for(let n=0;n<this._tokenFormat.length;n++){let t=this._tokenFormat[n];if((t.type==="YYYY"||t.type==="MM"||t.type==="DD")&&t.digits.length!==t.format.length)return null}let n=super.Value;if(String.isEmptyOrWhiteSpaces(n))return null;let t=new moment(n,this._format,!0);return t.isValid()?t:null}toString(){let n="";for(let t=0;t<this._tokenFormat.length;t++)if(this._tokenFormat[t].format.length===0)n+=this._tokenFormat[t].fix;else{let i=this._tokenFormat[t].digits;i=i.length>this._tokenFormat[t].format.length?i.substr(0,this._tokenFormat[t].format.length):i.padEnd(this._tokenFormat[t].format.length,"_");n+=this._tokenFormat[t].fix+i}return n}formatValue(n){let t=String.isEmptyOrWhiteSpaces(n)?this._tokenFormat:this.parseValue(n);n="";for(let i=0;i<t.length;i++)if(t[i].format.length===0)n+=t[i].fix;else{let r=t[i].value.toString(),u="";if(r.length>t[i].format.length)r=r.substr(r.length-t[i].format.length,t[i].format.length);else for(let n=0;n<t[i].format.length-r.length;n++)u+="0";n+=t[i].fix+u+r}return n}setValue(n,t,i,r){if(t===null||t===undefined)return-1;for(let u=0;u<this._tokenFormat.length;u++)if(this._tokenFormat[u].type===n)return t<i&&(t=i),t>r&&(t=r),this._tokenFormat[u].value=t,this._tokenFormat[u].digits=t.toString().padStart(this._tokenFormat[u].format.length,"0"),u;return-1}setDate(n,t,i){let u=0,r=0,f=!1;if(this.pushUndo(),this._indexToken===null){for(let n=0;n<this._tokenFormat.length;n++)this._tokenFormat[n].digits="",this._tokenFormat[n].value=0;this._indexToken=0;this.pushUndo()}(r=this.setValue("DD",n,1,31),r>=0&&(f=!0),r>u&&(u=r),r=this.setValue("MM",t,1,12),r>=0&&(f=!0),r>u&&(u=r),typeof i=="number"&&i<100&&(i+=2e3),r=this.setValue("YYYY",i,1900,2099),r>=0&&(f=!0),r>u&&(u=r),f)&&(this._tokenFormat=this.updateToken(this._tokenFormat),this._value=this.formatValue(),u>this.IndexToken&&(this.IndexToken=u))}setTime(n,t,i,r){let f=0,u=0,e=!1;if(this.pushUndo(),this._indexToken===null){for(let n=0;n<this._tokenFormat.length;n++)this._tokenFormat[n].digits="",this._tokenFormat[n].value=0;this._indexToken=0;this.pushUndo()}(u=this.setValue("HH",n,0,23),u>=0&&(e=!0),u>f&&(f=u),u=this.setValue("mm",t,0,59),u>=0&&(e=!0),u>f&&(f=u),u=this.setValue("ss",i,0,59),u>=0&&(e=!0),u>f&&(f=u),u=this.setValue("SSS",r,0,999),u>=0&&(e=!0),u>f&&(f=u),e)&&(this._tokenFormat=this.updateToken(this._tokenFormat),this._value=this.formatValue(),f>this.IndexToken&&(this.IndexToken=f))}updateToken(n){let i=this.IndexToken;if(i===null)return n;let t=n[i];if(t.digits.length<t.format.length)return n;if(t.digits.length>t.format.length){let r=t.digits.substr(0,t.format.length),u=t.digits.substr(t.format.length);t.digits=r;t.value=parseInt(r);i<n.length-1&&(t=n[i+1],t.digits=u,t.value=parseInt(u.padEnd(t.format.length,"0")),this.IndexToken=i+1)}for(let t=0;t<n.length;t++)switch(n[t].type){case"MM":if(n[t].digits.length===2){let i=n[t].value;i<1&&(i=1);i>12&&(i=12);n[t].value=i;n[t].digits=i.toString().padStart(2,"0")}break;case"DD":if(n[t].digits.length===2){let i=n[t].value;i<1&&(i=1);i>31&&(i=31);n[t].value=i;n[t].digits=i.toString().padStart(2,"0")}break;case"HH":if(n[t].digits.length===2){let i=n[t].value;i>23&&(i=23);n[t].value=i;n[t].digits=i.toString().padStart(2,"0")}break;case"mm":case"ss":if(n[t].digits.length===2){let i=n[t].value;i>59&&(i=59);n[t].value=i;n[t].digits=i.toString().padStart(2,"0")}}return n}selectAll(){this._tokenFormat=this.parseValue(this.toString());this._value=this.formatValue();this._indexToken=null;this._undo=[]}clone(){let n=new Digits.Datetime(this._formatDefault);return n.Value=this.Value,n}constructor(n){let t=String.isEmptyOrWhiteSpaces(n)?"DD/MM/YYYY HH:mm:ss":n;switch(t.toLowerCase()){case"date":t="DD/MM/YYYY";break;case"time":t="HH:mm";break;case"datetime":t="DD/MM/YYYY HH:mm"}super(t);this.Value=null}});Language={};Language.Manager=(class extends LoggerBaseObject{static get LANGUAGE_ROOT(){return"body > header > ul > "}static HandleReplacementKeyLabel(n,t,i){return function(){var u,r,e,f,o;try{if((u=$(this).attr("k-label"),!u||u===undefined)||u!==i||(r=$(this).attr("k-language"),!r&&t!==n)||r&&r!==t)return!0;for(r||(r=t),e=[],f=0;$(this).attr("k-label-"+f);)e.push($(this).attr("k-label-"+f)),f++;return o=Language.Manager.Instance.interpolation(u,e,r),$(this).is("input")?$(this).val(o):$(this).html(String.encode(o)),!0}catch(s){return!0}}}static HandleReplacementLabel(n){return function(){var t,i,u,r,f;try{if(t=$(this).attr("k-label"),!t||t===undefined)return!0;for(i=$(this).attr("k-language"),i||(i=n),u=[],r=0;$(this).attr("k-label-"+r);)u.push($(this).attr("k-label-"+r)),r++;return f=Language.Manager.Instance.interpolation(t,u,i),$(this).is("input")?$(this).val(f):$(this).html(String.encode(f)),!0}catch(e){return!0}}}get Languages(){return this._languages}initialize(){function e(n){return function(t,i,r,u,f){n.info("Replace the label "+String.JSONStringify(n._labels[f.Key])+" by "+String.JSONStringify(f));n._labels[f.Key]=f;n.onUpdateLabel(t,i,r,u,f)}}function o(n){return function(){n.initialize();n.onChangeLanguage(DSDatabase.Instance.CurrentLanguage,!0)}}var f,n,t;this.info("Cleaning up ...");this._labels={};this._ignoreLabels={};this.info("Updating language table ...");var i=DSDatabase.Instance.getTable("Language"),r={},u=0;for(f in i){if(n=i[f],r[n.Key]=n,this._languages===null){this._languages=[];for(t in n)t.length===2&&t.toUpperCase()===t&&this._languages.push(t);this.debug("List of languages: "+String.JSONStringify(this._languages))}this.IsDebug&&this.debug("["+n.Key+"] = "+String.JSONStringify(n));u++}this._labels=r;this._ignoreLabels={};this.info("Language table contains "+u+" labels");this._eventOnUpdateKey===null&&(this._eventOnUpdateKey=DSDatabase.Instance.addEventListener("onUpdate","Language","*",e(this)),DSDatabase.Instance.addEventListener("onLoad","Language","*",o(this)))}existLabel(n){return this._labels[n]!==null&&this._labels[n]!==undefined}getLabel(n,t){try{var i=this._labels[t][n];return i?i:null}catch(r){return this._ignoreLabels[n+"."+t]||(this._ignoreLabels[n+"."+t]=!0,this.warn("The label("+n+","+t+") doesn't exist")),null}}getComment(n){try{var t=this._labels[n].Comment;return t?t:""}catch(i){return""}}setLabel(n,t,i){var r=this.getLabel(n,t);if(!i||!r||i===r)return!1;try{return this.info("The value '"+r+"' of the label '"+t+"' is replaced by '"+i+"' ..."),this._labels[t][n]=i,!0}catch(u){return this.exception("Exception on updating the label("+n+","+t+")",u),!1}}addComponent(n){this._components.push(n)}interpolation(n,t,i){function o(n,t){return function(i,r){try{var u=n.getLabel(t,r);return u===null?i:typeof u=="string"||typeof u=="number"?u:i}catch(f){return i}}}function s(n){return function(t,i){try{var r=n[i];return typeof r=="string"||typeof r=="number"?r:t}catch(u){return t}}}var r=Helper.Label(n,t,i),e,u,f;if(i=r.language?r.language:DSDatabase.Instance.CurrentLanguage,e=this.getLabel(i,r.label),!e)return r.label;if(u=[],r.parameters&&r.parameters.length>0)for(f in r.parameters)r.parameters[f]!==null&&r.parameters[f]!==undefined?u.push(r.parameters[f].toString().replace(/{([^{}]*)}/g,o(this,i))):u.push("");return e.replace(/{([^{}]*)}/g,s(u))}onUpdateLabel(n,t,i,r,u){var o,f,e,s;for(o in u)if(o.length===2&&o.toUpperCase()===o&&u[o]!==r[o]){f=u.Key;e=o;this.info("Updating all labels having the key '"+f+"' ("+e+")");$("div").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));$("span").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));$("input").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));$("select > option").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));for(let n=0;n<this._components.length;n++){let t=this._components[n];t.find("div").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));t.find("span").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));t.find("input").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f));t.find("select > option").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,e,f))}for(s in this._listeners)this._listeners[s](DSDatabase.Instance.CurrentLanguage,e,f)}}onChangeLanguage(n,t){if(t===undefined&&(t=!1),DSDatabase.Instance.CurrentLanguage!==n||t){webix.i18n.setLocale(n);Locale.setLanguage(n);$(Language.Manager.LANGUAGE_ROOT+"#"+DSDatabase.Instance.CurrentLanguage).removeClass("selected");DSDatabase.Instance.SelectedLanguage=n;$(Language.Manager.LANGUAGE_ROOT+"#"+n).addClass("selected");this.info("Translating all labels into '"+n+"' ...");$("div").each(Language.Manager.HandleReplacementLabel(n));$("span").each(Language.Manager.HandleReplacementLabel(n));$("input").each(Language.Manager.HandleReplacementLabel(n));$("select > option").each(Language.Manager.HandleReplacementLabel(n));for(let t=0;t<this._components.length;t++){let i=this._components[t];i.find("div").each(Language.Manager.HandleReplacementLabel(n));i.find("span").each(Language.Manager.HandleReplacementLabel(n));i.find("input").each(Language.Manager.HandleReplacementLabel(n));i.find("select > option").each(Language.Manager.HandleReplacementLabel(n))}for(var i in this._listeners)this._listeners[i](n)}}addListener(n){return this._indexListener++,this._listeners[this._indexListener]=n,this._indexListener}removeListener(n){this._listeners[n]!==null&&this._listeners[n]!==undefined&&this._listeners.splice(n,1)}constructor(){super("LanguageManager");this._labels={};this._ignoreLabels={};this._languages=null;this._eventOnUpdateKey=null;this._indexListener=0;this._listeners=[];this._components=[]}static get Instance(){return this._instance||(this._instance=new Language.Manager),this._instance}});Filter={};Filter.Filter=(class{getField(n){return this._filters[n]===undefined||this._filters[n]===null?null:this._filters[n]}setField(n,t){this._filters[n]=t}constructor(){this._filters={}}static get Instance(){return this._instance||(this._instance=new Filter.Filter),this._instance}});Filter.FilterItems=(class{setValue(n){let t=[];if(Array.isArray(n)){let i={};for(let r in n){let u=String.isEmptyOrWhiteSpaces(n[r])||isNaN(String.parseInt(n[r]))?null:String.parseInt(n[r]);i[u]===undefined&&u!==null&&(i[u]=!0,t.push(u))}t.sort(function(n,t){return n<t?-1:n>t?1:0})}else String.isEmptyOrWhiteSpaces(n)||isNaN(String.parseInt(n))||t.push(String.parseInt(n));let i=this._values.length===t.length;if(i){let n=0;for(n=0;n<t.length&&t[n]===this._values[n];n++);if(n===t.length)return!1}return this._values=t,!0}getValue(){return this._values}match(n){return this._values.length===0?!0:this._values.indexOf(n)>=0}constructor(){this._values=[]}});List={};List.List=(class{static get TEXT_FORMAT_DATE(){return"DD/MM/YYYY"}static get TEXT_FORMAT_DATETIME(){return"DD/MM/YYYY HH:mm:ss"}set DefaultPicture(n){this._defaultPicture=String.isEmptyOrWhiteSpaces(n)?null:n}get DefaultPicture(){return this._defaultPicture}set Filter(n){this._fnFilter=n?n:null}destructor(){this.clearListeners();this._events={}}clear(){}compare(n,t){var i=this.getId(n),r=this.getId(t);return i===r?0:i<r?-1:1}each(n){var i=this.getList(),r,t,u;for(r in i)if((t=i[r],this.isVisible(t))&&(u=String.convertValue(this.getId(t)),u!==null))try{n(t)}catch(f){Logger.Instance.exception("List","An exception occurs while rading each items",f)}}getList(){return[]}getListSorted(){function t(n){return function(t,i){return n.compare(t,i)}}var n=this.getList();return n.sort(t(this)),n}on(n,t){this._events[n]=t}raise(n){this._events[n]&&this._events[n]()}isEvent(n){return this._events[n]!==undefined&&this._events[n]!==null}getEvent(n){return this._events[n]?this._events[n]:null}unbind(n){this._events[n]=null}clearListeners(){for(var n in this._listeners)DSDatabase.Instance.removeEventListener(this._listeners[n]);this._listeners=[]}addListener(n){this._listeners.push(n)}onOpen(){}onClose(){this.clearListeners()}getId(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n:n.Id!==undefined?n.Id:null}getItem(n,t){var u=this.getList(),e=String.convertValue(n),f,i,r;for(f in u)if((i=u[f],t!==null&&t!==undefined&&t||this.isVisible(i))&&(r=String.convertValue(this.getId(i)),r!==null&&r===e))return i;return null}getText(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n.toString().trim():String.isEmptyOrWhiteSpaces(n.Name)?String.isEmptyOrWhiteSpaces(n.Description)?n.Id!==undefined?n.Id.toString().trim():n.toString().trim():n.Description.trim():n.Name.trim()}getLanguageLabel(){return null}getPicture(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?null:String.isEmptyOrWhiteSpaces(n.Picture)?this._defaultPicture:n.Picture}getAttributHTMLBoolean(n,t){if(n===null||n===undefined)return"";var i=n[t];return i===undefined?"":"<div class='"+(i===null?"null":i?"true":"false")+"'><\/div>"}getAttributHTMLReference(n,t,i,r){var u,f,e;if(n===null||n===undefined)return"";if((u=List.ListRecord.CACHE_LIST(i),u===null)||(f=u.getItem(n[t],!0),f===null||f===undefined))return this.getAttributText(n,t);if(r===!0){if(e=u.getPicture(f),e!==null)return"<img src='"+e+"' />";if(u.DefaultPicture!==null)return"<img src='"+u.DefaultPicture+"' />"}return u.getText(f)}getAttributHTMLPicture(n){if(n===null||n===undefined)return"";var t=n.Picture?n.Picture:this._defaultPicture;return t===null||t===undefined?"":"<img src='"+t+"' />"}getAttributHTMLEnumerate(n,t,i){var u,r;return n===null||n===undefined?"":(u=n[t],u===null||u===undefined)?i===!0?"<div class='null'><\/div>":"":(r=List.ListEnumerable.Factory(this.Table,t,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList()[u],r===undefined||r===null||r.Label===undefined||r.Label===null)?i===!0?"<div class='null'><\/div>":"":i===!0?"<div class='"+r.Name.toLowerCase()+"'><\/div>":Helper.Span(r.Label)}getAttributHTMLMultiline(n,t){if(n===null||n===undefined)return"";var i=n[t];return i===null||i===undefined?String.encode(this.getAttributText(n,t)):(i=String.encode(this.getAttributText(n,t)).split("\n"),i.join("<br />"))}getAttributHTML(n,t){if(n===null||n===undefined)return"";var i=n[t];return i===null||i===undefined?String.encode(this.getAttributText(n,t)):Helper.IsLabel(i,!0)?Helper.Span(i):String.encode(this.getAttributText(n,t))}getAttributToolTipHTML(){return null}getAttributTextBoolean(n,t){if(n===null||n===undefined)return"";var i=n[t];return i===null||i===undefined?"":Language.Manager.Instance.interpolation(Helper.Label(this.Table.toUpperCase()+"_"+t.toUpperCase()+"_"+(i===null?"NULL":i===!0?"TRUE":"FALSE")))}getAttributTextDouble(n,t,i){if(n===null||n===undefined)return"";var f=n[t];if(f===undefined||f===null)return"";let r=null,e=null,u=DSDatabase.Instance.getColumn(n._table,t);return u!==null&&u!==undefined?(r=i===null||i===undefined?u.Digit:new Digits.Decimal(9,i),e=u.Unit):r=new Digits.Decimal(9,i===null||i===undefined?3:i),r.Value=f,r.toString()+(String.isEmptyOrWhiteSpaces(e)?"":" "+e)}getAttributTextDate(n,t){if(n===null||n===undefined)return"";var i=n[t];if(i===undefined||i===null)return"";if(typeof i=="string")return i;let r=DSDatabase.Instance.getDatetimeFormat(n._table,t);return(r===null&&(r=List.List.TEXT_FORMAT_DATE),i instanceof Date)?moment(i.toString()).format(r):i instanceof moment?i.format(r):i.toString()}getAttributTextDateTime(n,t){if(n===null||n===undefined)return"";var i=n[t];if(i===undefined||i===null)return"";if(typeof i=="string")return i;let r=DSDatabase.Instance.getDatetimeFormat(n._table,t);return(r===null&&(r=List.List.TEXT_FORMAT_DATETIME),i instanceof Date)?moment(i.toString()).format(r):i instanceof moment?i.format(r):i.toString()}getAttributTextReference(n,t,i){var r,u;return n===null||n===undefined?"":(r=List.ListRecord.CACHE_LIST(i),r===null)?n[t]?n[t].toString():"":(u=r.getItem(n[t],!0),u===null||u===undefined)?n[t]?n[t].toString():"":r.getText(u)}getAttributTextPicture(){return""}getAttributTextEnumerate(n,t){var r,i;return n===null||n===undefined?"":(r=n[t],r===null||r===undefined)?"":(i=i=List.ListEnumerable.Factory(n._table?n._table:this.Table,t,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList()[r],i===undefined||i===null||i.Label===undefined||i.Label===null)?"":Language.Manager.Instance.interpolation(Helper.Label(i.Label))}getAttributText(n,t){if(n===null||n===undefined)return"";var i=n[t];if(i===null||i===undefined)return"";switch(typeof i){case"boolean":return i?"1":"0";case"number":return i.toString().replace(".",",");case"string":return i;default:return Helper.IsLabel(i,!0)?Language.Manager.Instance.interpolation(i):i instanceof Date?moment(i.toString()).format(List.List.TEXT_FORMAT_DATE):i instanceof moment?i.format(List.List.TEXT_FORMAT_DATE):i.toString()}}getAttributValue(n,t){if(n===null||n===undefined)return null;var i=n[t];return i===null||i===undefined?null:(Helper.IsLabel(i,!0)&&(i=Language.Manager.Instance.interpolation(i)),typeof i=="string")?i.trim().toUpperCase():i}isAttributDeletedReference(n,t,i){var r,u;return n===null||n===undefined?!0:(r=List.ListRecord.CACHE_LIST(i),r===null)?!0:(u=r.getItem(n[t]),u===null||u===undefined)?!0:r.isDeleted(u)}isAttributDeleted(){return!1}isVisible(n){return this._fnFilter?this._fnFilter(n):!0}isDeleted(n){return n===null||n===undefined?!0:n._deleted!==null&&n._deleted!==undefined&&n._deleted}isBoxFieldVisible(){return!0}isBoxFieldReadonly(n,t,i){return i.Profile===UserRecord.PROFILE_OTHER||i.Profile===UserRecord.PROFILE_NONE}isBoxBoardVisible(){return!0}isBoxBoardReadonly(){return!1}isBoxPanelVisible(){return!0}isBoxPanelReadonly(){return!1}isBoardFieldVisible(){return!0}isBoardFieldReadonly(){return!1}isBoardAllowed(n,t,i){return i==="help"||i==="read"||i==="onSelectChange"?!0:!n.Readonly&&t.Profile!==UserRecord.PROFILE_OTHER&&t.Profile!==UserRecord.PROFILE_NONE}beginTransaction(){}endTransaction(){}commit(){}rollback(){}constructor(){this._defaultPicture=null;this._fnFilter=null;this._events={};this._listeners=[]}});List.ListArray=(class extends List.List{get Array(){return this._array}getLanguageLabel(n){return typeof n=="object"?n.Label!==undefined?n.Label:null:null}getText(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n.toString().trim():n.Text!==undefined?n.Text:null}clear(){if(super.clear(),this._array!==null){let n=[];for(let t in this._array)n.push(t);for(let t=0;t<n.length;t++)delete this._array[n[t]];this._array.length=0}else this._array=[]}getList(){return this._array}constructor(n){super();this._array=n}});List.ListCalendar=(class extends List.List{setMonth(n,t){n<1||n>12||(this._offsetMonth=n,this._offsetYear=t)}previousMonth(){this._offsetMonth--;this._offsetMonth<1&&(this._offsetMonth=12,this._offsetYear--)}nextMonth(){this._offsetMonth++;this._offsetMonth>12&&(this._offsetMonth=1,this._offsetYear++)}month(n){var t=this._offsetMonth+(n===null||n===undefined?0:n);return(t-1)%12+1}year(n){var t=this._offsetMonth+(n===null||n===undefined?0:n);return this._offsetYear+Math.floor((t-1)/12)}getId(n){return n.day}getElementId(){return null}getElementHTML(){return null}getElementDate(){return null}getElementText(){return""}getText(){return null}getPicture(){return null}getAttributHTML(n,t){function a(n){return function(t,i){var r=n.getElementText(t),u=n.getElementText(i);return r<u?-1:u<r?1:0}}var e,s,h,f,i,u,c;if(t==="day")return n.day.toString();if(e=parseInt(t),isNaN(e))return"";for(var r=null,v=n.day,o=this._offsetMonth+e,l=this._offsetYear;o>12;)o-=12,l++;if((s=this.day[v],!s)||(h=s.month[o],!h)||(f=h.year[l],!f))return"";i=[];for(r in f)i.push(f[r]);i.sort(a(this));u="";for(r in i)i[r]!==null&&i[r]!==undefined&&((c=this.getElementHTML(i[r]),String.isEmptyOrWhiteSpaces(c))||(u!==""&&(u+="<\/br>"),u+=c));return u}getAttributText(n,t){var i;if(t==="ToolTip")return"";if(t==="day")return n.day.toString();if(i=parseInt(t),isNaN(i))return"";for(var f=n.day,r=this._offsetMonth+i,u=this._offsetYear;r>12;)r-=12,u++;return new moment([u,r-1,f]).format("LLLL")}getAttributValue(n){return n.day.toString()}isVisible(){return!0}getItem(n){return this.day[n]===undefined?null:this.day[n]}getList(){return this.day}clear(){this.day=[];for(var n=1;n<=31;n++)this.day[n]={day:n,month:{}}}addItem(n,t){var i=this.getElementDate(n),r,o,h;if(i===null||i===undefined||!(i instanceof moment))return null;var u=i.date(),f=i.month()+1,s=i.year(),e=this.day[u];return e?(r=e.month[f],r||(e.month[f]={month:f,year:{}},r=e.month[f]),o=r.year[s],o||(r.year[s]={},o=r.year[s]),o[this.getElementId(n)]=n,(typeof t!="boolean"||t)&&(h=this.getEvent("onUpdate"),h&&h("onUpdate","*",u,{day:u},{day:u})),n):null}updateItem(n,t){var i=this.getElementDate(n),r=this.getElementDate(t),u;if((this.deleteItem(n,!1),this.addItem(t,!1),i!==null||r!==null)&&(u=this.getEvent("onUpdate"),u)){if(i!==null&&r!==null&&i.date()===r.date()){u("onUpdate","*",i.date(),{day:i.date()},{day:i.date()});return}i!==null&&u("onUpdate","*",i.date(),{day:i.date()},{day:i.date()});r!==null&&u("onUpdate","*",r.date(),{day:r.date()},{day:r.date()})}}deleteItem(n,t){var i=this.getElementDate(n),u,f,e;if(i===null||i===undefined||!(i instanceof moment))return null;var r=i.date(),s=i.month()+1,h=i.year(),o=this.day[r];return o?(u=o.month[s],!u)?null:(f=u.year[h],!f)?null:(delete f[this.getElementId(n)],(typeof t!="boolean"||t)&&(e=this.getEvent("onUpdate"),e&&e("onUpdate","*",r,{day:r},{day:r})),n):null}constructor(){super();var n=new moment;this._offsetMonth=n.month()+1;this._offsetYear=n.year();this.clear()}});List.ListEnumerable=(class extends List.ListArray{static Factory(n,t,i){this._cache||(this._cache={});var u=n+"."+t,r=this._cache[u];return r?r:(r=new List.ListEnumerable(n,t,i),this._cache[u]=r,r)}get DefaultPicture(){return this._defaultPicture}getLanguageLabel(n){return n.Label!==undefined?n.Label:null}constructor(n,t,i){super(DSDatabase.Instance.getEnumerable(n,t));this._table=n;this._column=t;this._path=i?i:"";this._defaultPicture=null;let r=DSDatabase.Instance.getEnumerable(this._table,this._column,null);r!==null&&r!==undefined&&(this._defaultPicture=this._path+r.Picture);for(var u in this._array)this._array[u].Picture=this._path+this._array[u].Picture}});List.ListHistory=(class extends List.ListArray{static get CREATE(){return 0}static get UPDATE(){return 1}static get DELETE(){return 2}get IsDetails(){return this._details}clear(){super.clear();this._currentId=0}push(n,t,i,r,u,f){var e={Id:this._currentId++,UserId:n.LastModificationAuthor,Date:n.LastModificationDate,Nature:Helper.Label(i),Description:t===null||t===undefined?"":t,Field:r===null||r===undefined?null:Helper.Label(r),OldValue:u===null||u===undefined?null:u,NewValue:f===null||f===undefined?null:f,Item:n};return this._array.push(e),e}sort(){this._array.sort(function(n,t){return n.Id>t.Id?-1:n.Id<t.Id?1:0})}getValueText(n){return n===null||n===undefined?"":Helper.IsLabel(n,!0)?n.label:n.toString()}setDetails(n){this._details=n===null||n===undefined?!0:n}getId(n){return n.Id}getAttributHTML(n,t){var r=null,i;switch(t){case"Id":return"";case"User":return(r=n.UserId,r===null||r===undefined)?"":(i=DSDatabase.Instance.getRowById("User",r),i===null||i===undefined)?"":(String.isEmptyOrWhiteSpaces(i.Picture)&&(i.Picture=UserRecord.DEFAULT_PICTURE().picture),String.isEmptyOrWhiteSpaces(i.Picture))?"":"<img class='user' src='"+i.Picture+"' />";default:return super.getAttributHTML(n,t)}}getAttributText(n,t){var i=null,r;switch(t){case"User":return(i=n.UserId,i===null||i===undefined)?"":(r=DSDatabase.Instance.getRowById("User",i),r===null||r===undefined)?"":String.isEmptyOrWhiteSpaces(r.Name)?"":r.Name;case"Date":return(i=n[t],i===null||i===undefined)?"":i instanceof moment?i.format("DD/MM/YYYY HH:mm:ss"):super.getAttributText(n,t);default:return super.getAttributText(n,t)}}getAttributValue(n,t){var i=null;switch(t){case"User":case"Nature":case"Field":case"Description":return i=this.getAttributText(n,t),i===null?null:i.toUpperCase().trim();case"Date":return n.Id;default:return super.getAttributValue(n,t)}}newItem(){return null}isVisible(n){return this._details||n.Field===null}checkItem(){return!0}addItem(){return null}updateItem(){return null}deleteItem(){return null}constructor(){super([]);this._currentId=0;this._details=!0}});List.ListLanguage=(class extends List.List{getId(n){return n}getLanguageLabel(n){return n}getText(){return null}getPicture(){return null}getList(){return Language.Manager.Instance.Languages}constructor(){super()}});List.ListRecord=(class extends List.List{static CACHE_LIST(n){this._cacheList||(this._cacheList={});var t=this._cacheList[n];if(t!==null&&t!==undefined)return t;try{t=eval(n+"Record.List")}catch(i){t=null}return t=t?new t(!0):new List.ListRecord(n,!0),this._cacheList[n]=t,t}static SetListValues(n,t){if(n===undefined||n===null||t===null||t===undefined||t._subLists!==undefined)return t;t._subLists={};for(let i in n){let r=n[i];r!==null&&r!==undefined&&(t._subLists[i]={newSequenceId:-2,list:r.list,table:r.table,column:r.column,composition:r.composition,values:null},Object.defineProperty(t,i,{enumerable:!1,get:function(){function t(n,t){return function(i){i[t.column]===n.Id&&(i._parent=n,i._id=i.Id,i._list=t,t.values[i._id]=i)}}let n=this._subLists[i];return n===null||n===undefined?(n.values=[],n.values):n.values!==null?n.values:(n.values=[],n.newSequenceId=-2,n.list===null||this.Id<0)?n.values:(n.list.each(t(this,n)),n.values)}}))}return t}static GetRecordByPath(n,t,i){if(i===null||i===undefined)return t;typeof i=="string"&&(i=[i]);for(let r=0;r<i.length;r++){let u=t[i[r]];if(u===null||u===undefined)return null;let f=DSDatabase.Instance.getColumn(n,i[r]);if(f===null||(n=f.ForeignKey,n===null)||(n=n.Table,t=List.ListRecord.CACHE_LIST(n).getItem(u,!0),t===null||t===undefined))return null}return t}get Table(){return this._table}get SequenceProperty(){return this._sequenceProperty}destructor(){this._subLists=null;super.destructor()}declareListValues(n,t,i,r,u){this._subLists===null&&(this._subLists={});this._subLists[n]={list:u===null||u===undefined?List.ListRecord.CACHE_LIST(t):u,table:t,column:i,composition:r!==null&&r!==undefined&&r===!0}}getListValues(n){return this._subLists===null?null:this._subLists[n]===null||this._subLists[n]===undefined?null:this._subLists[n]}declareSequence(n,t,i){this._sequenceProperty=n;this._sequenceKey=t;this._sequenceLength=i}createSequence(n,t){function i(n,t,i){return function(r){typeof r=="number"&&(t._sequenceId=r,t[n._sequenceProperty]=n._sequenceKey+r.toString().padStart(n._sequenceLength-n._sequenceKey.length,"0"));i()}}return this._sequenceProperty===null?(t(),!0):!Hub.Instance.IsRunning&&!DSDatabase.Instance.hasSequence(this._sequenceKey)?!1:(DSDatabase.Instance.nextSequence(this._sequenceKey,i(this,n,t)),!0)}compare(n,t){var i=this.getText(n),r=this.getText(t);return i===r?0:i<r?-1:1}each(n){function t(n,t){return function(i){n.isVisible(i)&&t(List.ListRecord.SetListValues(n._subLists,i))}}DSDatabase.Instance.each(this._table,t(this,n))}getList(){function t(n,t){return function(i){n.isVisible(i)&&t.push(List.ListRecord.SetListValues(n._subLists,i))}}var n=[];return DSDatabase.Instance.each(this._table,t(this,n)),n}onOpen(){function n(n){return function(t,i,r,u){var f=n.getEvent(t);f&&f(t,i,r,u)}}function t(n){return function(t,i,r,u,f){var e=n.getEvent(t);e&&e(t,i,r,u,f)}}function i(n){return function(t,i,r,u){var f=n.getEvent(t);f&&f(t,i,r,u)}}function r(n){return function(t,i){var r=n.getEvent(t);r&&r(t,i)}}super.onOpen();this.addListener(DSDatabase.Instance.addEventListener("onCreate",this._table,"*",n(this)));this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._table,"*",t(this)));this.addListener(DSDatabase.Instance.addEventListener("onDelete",this._table,"*",i(this)));this.addListener(DSDatabase.Instance.addEventListener("onLoad",this._table,"*",r(this)))}get NewItem(){if(this._subLists===null)return DSDatabase.Instance.getNewRow(this._table);var n=List.ListRecord.SetListValues(this._subLists,DSDatabase.Instance.getNewRow(this._table));this._sequenceProperty!==null&&(n._sequenceProperty=this._sequenceProperty,n._sequenceKey=this._sequenceKey,n._sequenceLength=this._sequenceLength,n._sequenceId=null);for(let t in this._subLists){let i=n._subLists[t];i!==null&&i!==undefined&&(i.values=[])}return n}createSubItem(n,t){var i,r;return(List.ListRecord.SetListValues(this._subLists,n),n===null||n===undefined||n._subLists===null||n._subLists===undefined)?null:(i=n._subLists[t],i===null||i===undefined||i.list===null)?null:(r=i.list.NewItem,r[i.column]=n.Id,r._id=i.newSequenceId--,r._parent=n,r._list=i,r)}getItem(n,t){var i=null;return(typeof n=="number"?i=DSDatabase.Instance.getRowById(this._table,n):typeof n=="string"&&(i=DSDatabase.Instance.getRowById(this._table,parseInt(n))),i===null)?null:t!==null&&t!==undefined&&t?List.ListRecord.SetListValues(this._subLists,i):i._deleted||!this.isVisible(i)?null:List.ListRecord.SetListValues(this._subLists,i)}getAttributHTML(n,t){switch(t){case"Enable":return this.getAttributHTMLBoolean(n,t);case"Picture":return this.getAttributHTMLPicture(n,t);default:return super.getAttributHTML(n,t)}}getAttributText(n,t){var i;switch(t){case"Picture":return"";case"ToolTip":return n.ToolTip===undefined?this.getAttributText(n,"Comment"):(i=String.convertValue(n.ToolTip),i===null?"":i);default:return super.getAttributText(n,t)}}isVisible(n){return super.isVisible(n)?this._allRecords?!0:n.Enable!==undefined?n.Enable:!0:!1}checkItem(n,t,i){var r=null,u;if(this._subLists===null)return null;for(let f in this._subLists){let e=this._subLists[f];if(e!==null&&e!==undefined&&e.list!==null&&e.list!==undefined&&e.composition){u=n[f];for(let n in u){let o=u[n];if(o!==null&&o!==undefined){let s=new Errors,h=e.list.checkItem(o,s,i);s.HasError&&t.addError(f+"["+o._id+"]",s);r===null&&Helper.IsLabel(h)&&(r=h)}}}}return t.HasError?t:Helper.IsLabel(r)?r:null}addHistory(n,t,i,r,u){var c,f,s,o,e,h;if(this._subLists!==null&&(c=this._subLists.History,c!==undefined&&c!==null)){f={};s=i===null?t:i;for(o in s)if(!o.startsWith("_")&&r!==o){if(e=s[o],e===undefined&&(e=null),e===null){f[o]=null;continue}if(typeof e!="function"){if(typeof e=="number"&&o!=="Id"&&!o.startsWith("Copy")){let n=DSDatabase.Instance.getHistoryValue(this.Table,o,e);n===null?f[o]=e:(f["History"+o]=n.Id,f[o]=n.HistoryId);continue}if(typeof e=="string"||typeof e=="number"||typeof e=="boolean"){f[o]=e;continue}if(e instanceof Date){f[o]=new Date(e);continue}if(e instanceof moment){f[o]=new moment(e);continue}}}if(f.HistoryId=f.Id,f.Id=-1,f.HistoryUserId=DSDatabase.Instance.CurrentUser.Id,f.HistoryDate=new moment,f.HistoryNature=n,r!==undefined&&r!==null&&(f["History"+r]=s[r],f[r]=u),h=new Errors,f=DSDatabase.Instance.addFromClient("History"+this.Table,f,h),h.HasError){Logger.Instance.warn("List.ListRecord","Errors occured during added history item (ignore it) : "+h.toString());return}if(this._subLists===null&&this._subLists===undefined)return f;for(let n in this._subLists){let r=this._subLists[n];if(r!==null&&r!==undefined&&n!=="History"&&r.list!==null&&r.list!==undefined&&r.composition){f[n]=[];let o=List.ListRecord.CACHE_LIST(r.table),e=t===null?[]:t[n],u=i===null?[]:i[n];for(let t in u){let i=u[t];i=i===null||i===undefined?null:i;let s=e[t];s=s===null||s===undefined?null:s;i!==null&&s===null&&f[n].push(o.addHistory(List.ListHistory.CREATE,s,i,r.column,f.Id))}for(let t in u){let i=u[t];i=i===null||i===undefined?null:i;let s=e[t];s=s===null||s===undefined?null:s;i!==null&&s!==null&&f[n].push(o.addHistory(List.ListHistory.UPDATE,s,i,r.column,f.Id))}for(let t in e){let s=u[t];s=s===null||s===undefined?null:s;let i=e[t];i=i===null||i===undefined?null:i;s===null&&i!==null&&f[n].push(o.addHistory(List.ListHistory.DELETE,i,null,r.column,f.Id))}}}return f}}addItem(n,t,i,r){var f,u,e;if(n=DSDatabase.Instance.updateHistoryProperties(this.Table,n),r===null||r===undefined||r){if(f=this.checkItem(n,t,i),t.HasError)return t;if(Helper.IsLabel(f))return f}if(u=DSDatabase.Instance.addFromClient(this._table,n,t),t.HasError)return t;if(this._subLists===null)return u;List.ListRecord.SetListValues(this._subLists,u);for(let r in this._subLists){let f=this._subLists[r];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let o=u._subLists[r];o.values=[];e=n[r];for(let n in e){let h=e[n];if(h!==null&&h!==undefined){h[f.column]=u.Id;let c=new Errors,s=f.list.addItem(h,c,i,!1);(c.HasError&&t.addError(r+"["+h._id+"]",c),s!==null)&&(s.__id=h._id,s._id=s.Id,s._parent=u,s._list=f,o.values[s.Id]=s)}}}}return t.HasError?t:((r===null||r===undefined||r)&&this.addHistory(List.ListHistory.CREATE,null,u),u)}updateItem(n,t,i,r,u,f){var s,e,o;if(i=DSDatabase.Instance.updateHistoryProperties(this.Table,i),f===null||f===undefined||f){if(s=this.checkItem(i,r,u),r.HasError)return r;if(Helper.IsLabel(s))return s}if(e=DSDatabase.Instance.updateFromClient(this._table,t,i,r),r.HasError)return r;if(this._subLists===null)return e;List.ListRecord.SetListValues(this._subLists,e);for(let n in this._subLists){let f=this._subLists[n];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let c=t[n],s=i[n],h=e._subLists[n];h.values=[];for(let n in c){let t=c[n];if(t.Id!==-1&&!s[n]){let i=new Errors;f.list.deleteItem(t.Id,t,i,!1);i.HasError&&r.addError(f.column+"["+t._id+"]",i)}}for(let t in s){let i=s[t];if(i.Id!==-1){if(DSRecord.IsEqual(i,c[t])){h.values[i.Id]=DSRecord.Clone(i);h.values[i.Id].__id=i._id;continue}let l=new Errors;(o=f.list.updateItem(i.Id,c[t],i,l,u,!1),l.HasError&&r.addError(n+"["+i._id+"]",l),o!==null)&&(o.__id=i._id,o._id=o.Id,o._parent=e,o._list=f,h.values[o.Id]=o)}}for(let t in s){let o=s[t];if(o.Id===-1){o[f.column]=e.Id;let c=new Errors,i=f.list.addItem(o,c,u,!1);(c.HasError&&r.addError(n+"["+o._id+"]",c),i!==null)&&(i.__id=o._id,i._id=i.Id,i._parent=e,i._list=f,h.values[i.Id]=i)}}}}return r.HasError?r:((f===null||f===undefined||f)&&this.addHistory(List.ListHistory.UPDATE,t,e),e)}deleteItem(n,t,i,r){var f,u;if(this._subLists!==null){for(let n in this._subLists){let r=this._subLists[n];if(r!==null&&r!==undefined&&r.list!==null&&r.list!==undefined&&r.composition){f=t[n];for(let t in f){let u=f[t];if(u!==null&&u!==undefined){let e=new Errors;r.list.deleteItem(u.Id,u,e,!1);e.HasError&&i.addError(n+"["+u._id+"]",e)}}t._subLists[n].values=[]}}if(i.HasError)return i}if(u=DSDatabase.Instance.deleteFromClient(this._table,t,i),i.HasError)return i;if(this._subLists===null)return u;u=List.ListRecord.SetListValues(this._subLists,u);for(let n in this._subLists){let t=u._subLists[n];t!==null&&t!==undefined&&(t.values=[])}return(r===null||r===undefined||r)&&this.addHistory(List.ListHistory.DELETE,u,null),u}cancelItem(n,t,i,r){if(this._subLists===null)return!0;i!==null&&i!==undefined&&typeof i._sequenceId=="number"&&DSDatabase.Instance.cancelSequence(i._sequenceKey,i._sequenceId);for(let n in this._subLists){let f=this._subLists[n];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let e=t===null||t===undefined?null:t[n],u=i===null||i===undefined?null:i[n];if(u!==null&&u!==undefined)for(let t in u){let i=u[t];if(i.Id===-1){let e=new Errors;f.list.cancelItem(i.Id,null,i,e);e.HasError&&r.addError(n+"["+i._id+"]",e)}}if(u!==null&&u!==undefined&&e!==null&&e!==undefined)for(let t in u){let i=u[t];if(i.Id!==-1&&!DSRecord.IsEqual(i,e[t])){let o=new Errors;f.list.cancelItem(i.Id,e[t],i,o);o.HasError&&r.addError(n+"["+i._id+"]",o)}}if(e!==null&&e!==undefined)for(let t in e){let i=e[t];if(i.Id!==-1&&(u===null||u===undefined||!u[t])){let o=new Errors;f.list.cancelItem(i.Id,i,null,o);o.HasError&&r.addError(n+"["+i._id+"]",o)}}}}return!r.HasError}beginTransaction(n){DSDatabase.Instance.beginTransaction(n)}endTransaction(){DSDatabase.Instance.endTransaction()}commit(){DSDatabase.Instance.commit()}rollback(){DSDatabase.Instance.rollback()}isBoxFieldReadonly(n,t,i,r){return super.isBoxFieldReadonly(n,t,i,r)?!0:this._sequenceProperty!==null&&t===this._sequenceProperty?!0:!1}constructor(n,t){super();this._table=n;this._allRecords=t===null||t===undefined||t?!0:!1;let i=DSDatabase.Instance.getSequence(n);this._sequenceProperty=i===null?null:i.Property;this._sequenceKey=i===null?null:i.Key;this._sequenceLength=i===null?null:i.Length;this._subLists=null}});List.ListArrayRecord=(class extends List.ListArray{get Table(){return this._listRecord.Table}get Column(){return this._column}get ListRecord(){return this._listRecord}get ListParent(){return this._listParent}get Item(){return this._item}set Item(n){this._array=[];this._item=n===undefined||n===null?null:n;this._item!==null&&this._item[this._column]&&(this._array=this._item[this._column])}get SequenceProperty(){return this._listRecord._sequenceProperty}createSequence(n,t){return this._listRecord.createSequence(n,t)}compare(n,t){return this._listRecord.compare(n,t)}each(n){for(var t in this._array)n(this._array[t])}getList(){var n=[];for(var t in this._array)n.push(this._array[t]);return n}get NewItem(){return this._listRecord.createSubItem(this._item,this._column)}getId(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n:n._id!==undefined?n._id:null}getItem(n){var t=this._array[n];return t?DSRecord.Clone(t):null}getText(n){return this._listRecord.getText(n)}getLanguageLabel(n){return this._listRecord.getLanguageLabel(n)}getPicture(n){return this._listRecord.getPicture(n)}getAttributHTML(n,t){return this._listRecord.getAttributHTML(n,t)}getAttributToolTipHTML(n,t){return this._listRecord.getAttributToolTipHTML(n,t)}getAttributText(n,t){return this._listRecord.getAttributText(n,t)}getAttributValue(n,t){return this._listRecord.getAttributValue(n,t)}isAttributDeleted(n,t){return this._listRecord.isAttributDeleted(n,t)}isVisible(n){return this._listRecord.isVisible(n)}isDeleted(n){return this._listRecord.isDeleted(n)}checkItem(n,t,i){return this._listRecord.checkItem(n,t,i)}addItem(n,t,i){var r,u;let f=DSDatabase.Instance.updateHistoryProperties(this.Table,n);return(f!==null&&(n=f),n=DSDatabase.Instance.checkProperties(this.Table,n,t),t.HasError)?t:(r=this.checkItem(n,t,i),t.HasError)?t:Helper.IsLabel(r)?r:(this._array[n._id]=n,u=this.getEvent("onCreate"),u&&u("onCreate",this.Table,n.Id,n),n)}updateItem(n,t,i,r,u){var f,e;let o=DSDatabase.Instance.updateHistoryProperties(this.Table,i);return(o!==null&&(i=o),i=DSDatabase.Instance.checkProperties(this.Table,i,r),r.HasError)?r:(f=this.checkItem(i,r,u),r.HasError)?r:Helper.IsLabel(f)?f:(this._array[i._id]=i,e=this.getEvent("onUpdate"),e&&e("onUpdate",this.Table,i.Id,t,i),i)}deleteItem(n,t){var i=this._array[t._id],r;if(i)return delete this._array[t._id],r=this.getEvent("onDelete"),r&&r("onDelete",this.Table,i.Id,i),i}cancelItem(n,t,i,r){return this._listRecord.cancelItem(n,t,i,r)}isBoxFieldVisible(n,t,i,r){return this._listRecord.isBoxFieldVisible(n,t,i,r)}isBoxFieldReadonly(n,t,i,r){return this._listRecord.isBoxFieldReadonly(n,t,i,r)}isBoxBoardVisible(n,t,i,r){return this._listRecord.isBoxBoardVisible(n,t,i,r)}isBoxBoardReadonly(n,t,i,r){return this._listRecord.isBoxBoardReadonly(n,t,i,r)}isBoxPanelVisible(n,t,i,r){return this._listRecord.isBoxPanelVisible(n,t,i,r)}isBoxPanelReadonly(n,t,i,r){return this._listRecord.isBoxPanelReadonly(n,t,i,r)}isBoardFieldVisible(n,t,i,r){return this._listRecord.isBoardFieldVisible(n,t,i,r)}isBoardFieldReadonly(n,t,i,r){return this._listRecord.isBoardFieldReadonly(n,t,i,r)}isBoardAllowed(n,t,i,r){return this._listRecord.isBoardAllowed(n,t,i,r)}constructor(n,t,i){super([]);this._listParent=n===undefined||n===null?null:n;this._listRecord=i===undefined||i===null?null:i;this._item=null;this._column=t}});List.ListArrayRecordAssociation=(class extends List.ListArrayRecord{get Item(){return this._item}set Item(n){super.Item=n;this._targetArray=this._array;this.updateListItems()}compare(n,t){let i=this._listAssociation.getItem(n[this._associationColumn],!0),r=this._listAssociation.getItem(t[this._associationColumn],!0);return String.compare(this._listAssociation.getText(i),this._listAssociation.getText(r))}each(n){function r(n){return function(t,i){return n.compare(t,i)}}var t=[];for(var i in this._array)t.push(this._array[i]);t.sort(r(this));for(i in t)n(t[i])}updateListItems(){this._array=[];var n=this._listAssociation.getListSorted();for(let t in n){let r=this._listAssociation.getId(n[t]),i=null;for(let n in this._targetArray)if(this._targetArray[n][this._associationColumn]===r){i=DSRecord.Clone(this._targetArray[n]);i._selected=!0;break}i===null&&(i=this.ListRecord.createSubItem(this._item,this.Column),i[this._associationColumn]=r,i._selected=!1);this._array[i._id]=i}}onOpen(){function n(n){return function(t,i){n.updateListItems();var r=n.getEvent("onLoad");r&&r("onLoad",i)}}super.onOpen();this._listAssociation.on("onCreate",n(this));this._listAssociation.on("onUpdate",n(this));this._listAssociation.on("onDelete",n(this));this._listAssociation.on("onLoad",n(this));this._listAssociation.onOpen()}onClose(){this._listAssociation.unbind("onCreate");this._listAssociation.unbind("onUpdate");this._listAssociation.unbind("onDelete");this._listAssociation.unbind("onLoad");this._listAssociation.onClose();super.onClose()}getAttributHTML(n,t){return t==="_selected"?this.getAttributHTMLBoolean(n,t):super.getAttributHTML(n,t)}getAttributToolTipHTML(n,t){return t==="_selected"?"":super.getAttributToolTipHTML(n,t)}getAttributText(n,t){return t==="_selected"?"":super.getAttributText(n,t)}getAttributValue(n,t){return t==="_selected"?this.getAttributValueBoolean(n,t):super.getAttributText(n,t)}addItem(n,t,i){var u,f;if((n=DSDatabase.Instance.updateHistoryProperties(this.Table,n),n=DSDatabase.Instance.checkProperties(this.Table,n,t),t.HasError)||(u=this.checkItem(n,t,i),t.HasError))return t;if(Helper.IsLabel(u))return u;let e=n[this._associationColumn],r=null;n._selected=!1;for(let t in this._array)if(this._array[t][this._associationColumn]===e){r=this._array[t];this._array[t]=n;n.Id=r.Id;n._id=r._id;n._selected=!0;break}return n._selected?(this._targetArray[n._id]=n,n._selected=!0,f=this.getEvent("onUpdate"),f&&f("onUpdate",this.Table,n.Id,r,n),n):(Logger.Instance.error("List.ListArrayRecordAssociation","The list references an inexisting element ..."),t.addGlobal("ERR_EXCEPTION_UNEXPECTED"),t)}updateItem(n,t,i,r,u){return this.addItem(i,r,u)}deleteItem(n,t){let r=t[this._associationColumn];for(let u in this._array)if(this._array[u][this._associationColumn]===r){this._array[u]._selected=!1;delete this._targetArray[this._array[u]._id];var i=this.getEvent("onUpdate");i&&i("onUpdate",this.Table,n,t,this._array[u]);break}}constructor(n,t,i,r,u){super(n,t,i);this._targetArray=[];this._associationColumn=r;this._listAssociation=u===undefined||u===null?null:u}});class DSAnnotationAttribute{static Factory(n){switch(n.Type){case"ForeignKey":return new DSForeignKeyAttribute(n.Error,n.Table);case"Unique":return new DSUniqueAttribute(n.Error,n.CaseSensitive,n.Fields);case"Decimal":return new DSDecimalAttribute(n.Error,n.Digit,n.Precision,n.Unit);case"Email":return new DSEmailAttribute(n.Error);case"Key":return new DSKeyAttribute(n.Error);case"Required":return new DSRequiredAttribute(n.Error);case"String":return new DSStringAttribute(n.Error,n.Min,n.ErrorMin,n.Max,n.ErrorMax);case"DateTime":return new DSDateTimeAttribute(n.Format);case"Mask":return new DSMaskAttribute(n.Mask);case"Sequence":return new DSSequenceAttribute(n.Key,n.Length);case"Password":return new DSPasswordAttribute;case"File":return new DSFileAttribute}return Logger.Instance.error("DSAnnotationAttribute","Type '"+n.Type+"' not implemented!"),null}static FactoryList(n){for(var i,r=[],t=0;t<n.length;t++)i=DSAnnotationAttribute.Factory(n[t]),i&&r.push(i);return r}get Type(){return"Annotation"}toString(){return this.Type+" = "+String.JSONStringify(this)}constructor(){}}class DSConstraintAttribute extends DSAnnotationAttribute{get Type(){return"Constraint"}get Error(){return this._error}constructor(n){super();this._error=n}}class DSForeignKeyAttribute extends DSConstraintAttribute{get Type(){return"ForeignKey"}get Table(){return this._table}constructor(n,t){super(n);this._table=t}}class DSUniqueAttribute extends DSConstraintAttribute{get Type(){return"Unique"}addField(n){this._fields=[n].concat(this._fields)}get FieldName(){return this._fields[0]}get FieldNames(){return String.JSONStringify(this._fields)}getValue(n){var i=n[this._fields[0]],t,u,r;if(i===null||i===undefined||(t=this._caseSensitive?i.toString():i.toUpperCase(),t===undefined||t===null))return null;if(this._fields.length>1){for(u=[t],r=1;r<this._fields.length;r++)u.push(n[this._fields[r]]);t=String.JSONStringify(u)}return t}addValue(n){var i=this.getValue(n),t;i===null||t<0||(t=n.Id,t===undefined||t===null||t<0)||(this._values[i]===undefined&&(this._values[i]=[]),this._values[i].push(t))}existValue(n){var r=this.getValue(n),t,i;return r===null||this._values[r]===undefined?!1:(t=n.Id,t===undefined||t===null||t<0)?!0:(i=this._values[r],i===null||i===undefined)?!1:i.indexOf(t)>=0?!1:i.length>0}deleteValue(n){var r=this.getValue(n),i,t,u;r!==null&&((i=n.Id,i===undefined||i===null||i<0)||(t=this._values[r],t!==null&&t!==undefined)&&((u=t.indexOf(i),u<0)||(t.splice(u,1),t.length===0&&delete this._values[r])))}toListValues(){return String.JSONStringify(this._values)}constructor(n,t,i){super(n);this._caseSensitive=t==="True";this._values={};this._fields=i===null||i===undefined?[]:i}}class DSControlAttribute extends DSAnnotationAttribute{get Type(){return"Control"}get Error(){return this._error}check(){return!0}constructor(n){super();this._error=n}}class DSDecimalAttribute extends DSControlAttribute{get Type(){return"Decimal"}get NbDigitsBefore(){return this._digit-this._precision}get NbDigitsAfter(){return this._precision}get Unit(){return this._unit}check(n,t,i){var r=0,u=super.check(n,t,i);if(t===null||t===undefined)return u;switch(typeof t){case"string":r=String.parseFloat(t);break;case"number":r=t;break;case"boolean":r=t?1:0;break;default:return i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString()]),!1}return isNaN(r)?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString()]),!1):r>=this._maxValue?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString()]),!1):String.parseFloat(r.toFixed(8))!==String.parseFloat(r.toFixed(this._precision))?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString()]),!1):u}constructor(n,t,i,r){super(n);this._digit=t;this._precision=i;this._unit=String.isEmptyOrWhiteSpaces(r)?null:String.decode(r);this._maxValue=this._digit<=0?1:10;for(var u=i+1;u<this._digit;u++)this._maxValue*=10}}class DSEmailAttribute extends DSControlAttribute{get Type(){return"Email"}check(n,t,i){var r=super.check(n,t,i);return t===null||t===undefined?r:typeof t!="string"?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):!String.isEmptyOrWhiteSpaces(t)&&!String.isEmailValide(t)?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):r}constructor(n){super(n)}}class DSRequiredAttribute extends DSControlAttribute{get Type(){return"Required"}check(n,t,i){var r=super.check(n,t,i);return t===null||t===undefined?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):typeof t=="string"&&String.isEmptyOrWhiteSpaces(t)?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):r}constructor(n){super(n)}}class DSStringAttribute extends DSControlAttribute{get Type(){return"String"}get MaxLength(){return this._max}check(n,t,i){var r=super.check(n,t,i);return t===null||t===undefined?this._min>0?(i.addField(n.Property,this._errorMin,["{"+n.Field+"}",this._min.toString()]),!1):r:typeof t!="string"?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):(t.length<this._min&&(i.addField(n.Property,this._errorMin,["{"+n.Field+"}",this._min.toString()]),r=!1),this._max>=0&&t.length>this._max&&(i.addField(n.Property,this._errorMax,["{"+n.Field+"}",this._max.toString()]),r=!1),r)}constructor(n,t,i,r,u){super(n);this._min=t;this._errorMin=i;this._max=r;this._errorMax=u}}class DSKeyAttribute extends DSRequiredAttribute{get Type(){return"Key"}constructor(n){super(n)}}class DSFormatAttribute extends DSAnnotationAttribute{get Type(){return"Format"}convertFromJSON(n){return n}convertToJSON(n){return n}constructor(){super()}}class DSDateTimeAttribute extends DSFormatAttribute{get Type(){return"DateTime"}get Format(){return this._format}convertFromJSON(n){if(n===null||n===undefined||typeof n!="string")return n;if(n=new moment(n,this._format),!n.isValid())throw"ERR_FIELD_BADFORMAT";return n}convertToJSON(n){return n===null||n===undefined?n:n instanceof Date?moment(n.toString()).format(this._format):n instanceof moment?n.format(this._format):n}constructor(n){super();this._format=n}}class DSFileAttribute extends DSFormatAttribute{get Type(){return"File"}constructor(){super()}}class DSPasswordAttribute extends DSFormatAttribute{get Type(){return"Password"}constructor(){super()}}class DSMaskAttribute extends DSFormatAttribute{get Type(){return"Mask"}get Mask(){return this._mask}constructor(n){super();this._mask=n}}class DSSequenceAttribute extends DSFormatAttribute{get Type(){return"Sequence"}get Key(){return this._key}get Length(){return this._length}constructor(n,t){super();this._key=n;this._length=t}}class Hub extends LoggerBaseObject{get IsRunning(){return this._status==="Started"}get IsOnline(){return this._status==="Started"||this._status==="ReadyToSynchronize"}get IsStopped(){return this._status==="Stopped"}updateStatus(n,t){function i(n,t,i){i!==undefined?n.info("The status becomes '"+t+"' ("+String.JSONStringify(i)+")"):n.info("The status becomes '"+t+"'");n._status=t;Logger.Instance.status(n._status);for(var r in n._listeners)if(n._listeners[r].onStatusChanged){n.debug("Notify the listener '"+r+"' about the status '"+t+"'");n._listeners[r].onStatusChanged(t,i)}}function r(n,t){return function(r){if(r.Error!==null&&r.Error!==undefined){var u=new Errors;u.setJSON(r.Error);n.updateStatus("Error",u)}else r.Allow!==null&&r.Allow!==undefined&&r.Allow?i(n,t):n.updateStatus("Error",new Errors("ERR_AUTHENTICATED_TWICE"))}}if(this.verbose("Updating status '"+this._status+"' to '"+n+"' ..."),this._status!==n||n==="ReadyToSynchronize"){if(n!=="ReadyToSynchronize"){i(this,n,t);return}this.isAllowed(r(this,n))}}initialize(n,t,i,r){this.info("Initializing for the area '"+n+"' ("+t+") ...");$.connection.databaseHub.server.initialize(n,t).done(i).fail(r)}loadTable(n,t,i){this.info("Retrieving content of the table '"+n+"' ...");$.connection.databaseHub.server.loadTable(n).done(t).fail(i)}executeRequest(n,t,i,r,u,f,e){this.info("Executing the request: ["+n+"] => { Label = '"+String.JSONStringify(t)+"', Table = '"+i+"', Action = '"+r+"', Record = "+String.JSONStringify(u)+", Identity = "+String.JSONStringify(f)+"} ...");$.connection.databaseHub.server.executeRequest(n,t,i,r,u,f).done(e)}executeTransaction(n,t,i,r){this.info("Executing the transaction: ["+n+"] => { Label = '"+String.JSONStringify(t)+"', Transaction = '"+String.JSONStringify(i)+"'} ...");$.connection.databaseHub.server.executeTransaction(n,t,i).done(r)}executeService(n,t,i,r){this.info("Executing the service: { Service = '"+n+"', Record = "+String.JSONStringify(t)+", Identity = "+String.JSONStringify(i)+"} ...");$.connection.databaseHub.server.executeService(n,t,i).done(r)}beginNotification(n,t){if(this._status!=="ReadyToSynchronize")for(var i in this._listeners)this._listeners[i].beginNotification&&(this.debug("Notify the listener '"+i+"' for the beginning of notification ("+n.toString()+", "+String.JSONStringify(t)+")"),this._listeners[i].beginNotification(n,t))}notify(n,t,i,r){var f,u;if(this._status!=="ReadyToSynchronize")for(f in this._listeners)if(this._listeners[f].notify)for(this.debug("Notify the listener '"+f+"' about an update from the user '"+n+"' for ("+String.JSONStringify(t)+", '"+i+"', "+String.JSONStringify(r)),u=0;u<r.length;u++)this._listeners[f].notify(n,t,i,r[u].table,r[u].record)}endNotification(n,t){if(this._status!=="ReadyToSynchronize")for(var i in this._listeners)this._listeners[i].endNotification&&(this.debug("Notify the listener '"+i+"' for the ending of notification ("+n.toString()+", "+String.JSONStringify(t)+")"),this._listeners[i].endNotification(n,t))}acknowledgeRequest(n,t,i,r,u,f){for(var e in this._listeners)this._listeners[e].acknowledgeRequest&&(this.debug("Notify the listener '"+e+"' about an acknowledge from the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+")"),this._listeners[e].acknowledgeRequest(n,t,i,r,u,f))}acknowledgeTransaction(n,t,i){for(var r in this._listeners)this._listeners[r].acknowledgeTransaction&&(this.debug("Notify the listener '"+r+"' about an acknowledge from the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+")"),this._listeners[r].acknowledgeTransaction(n,t,i))}acknowledgeService(n,t,i,r,u){for(var f in this._listeners)this._listeners[f].acknowledgeService&&(this.debug("Notify the listener '"+f+"' about an acknowledge from the service '"+n+"' for ('"+t+"', '"+i+"', "+String.JSONStringify(r)+", "+String.JSONStringify(u)+")"),this._listeners[f].acknowledgeService(n,t,i,r,u))}start(){this._status!=="Started"&&this._status!=="Starting"&&this._status!=="ReadyToSynchronize"&&(this._status==="NotInitialized"?(this.updateStatus("Starting"),$.connection.hub.start().done(function(){Hub.Instance.updateStatus("Started")})):(this.updateStatus("Starting"),$.connection.hub.start().done(function(){Hub.Instance.updateStatus("ReadyToSynchronize")})))}synchronize(){this._status==="ReadyToSynchronize"&&this.updateStatus("Started")}isAllowed(n){function t(n,t){return function(i){n.info("IsAllowed = "+String.JSONStringify(i));window.clearInterval(n._intervalHandler);n._intervalHandler=null;t(i)}}function i(n){return function(){n.error("IsAllowed = failed!");window.clearInterval(n._intervalHandler);n._intervalHandler=null}}function r(n,r){return function(){n.verbose("Running is allowed ...");$.connection.databaseHub.server.isAllowed().done(t(n,r)).fail(i(n))}}this._intervalHandler=window.setInterval(r(this,n),1e3)}stop(n){if(n!==null&&n!==undefined&&n){$.connection.hub.stop();return}if(this.IsRunning&&this._status!=="Stopping"){this.updateStatus("Stopping");var t=$.connection.hub.stop();t.done&&t.done(function(){Hub.Instance.updateStatus("Stopped")})}}addListener(n,t){this._listeners[n]=t;this.debug("Listener '"+n+"' added")}removeListener(n){delete this._listeners[n];this.debug("Listener '"+n+"' removed")}constructor(){super("HUB");this._status="NotInitialized";this._listeners={};this._intervalHandler=null;Logger.Instance.status(this._status)}static get Instance(){return this._instance||(this._instance=new Hub),this._instance}}$.connection.databaseHub.client.beginNotification=function(n,t){Hub.Instance.beginNotification(n,t)};$.connection.databaseHub.client.notify=function(n,t,i,r){Hub.Instance.notify(n,t,i,r)};$.connection.databaseHub.client.endNotification=function(n,t){Hub.Instance.endNotification(n,t)};$.connection.databaseHub.client.acknowledgeRequest=function(n,t,i,r,u,f){Hub.Instance.acknowledgeRequest(n,t,i,r,u,f)};$.connection.databaseHub.client.acknowledgeTransaction=function(n,t,i){Hub.Instance.acknowledgeTransaction(n,t,i)};$.connection.databaseHub.client.acknowledgeService=function(n,t,i,r,u){Hub.Instance.acknowledgeService(n,t,i,r,u)};$.connection.databaseHub.client.stop=function(){Logger.Instance.info("HUB","Stop");$.connection.hub.stop()};$.connection.databaseHub.client.ping=function(){Logger.Instance.info("HUB","Ping");$.connection.databaseHub.server.ping()};$.connection.hub.reconnecting(function(){Hub.Instance.debug("Reconnecting ...");Hub.Instance.updateStatus("Starting")});$.connection.hub.reconnected(function(){Hub.Instance.debug("Reconnected!");Hub.Instance.updateStatus("ReadyToSynchronize")});$.connection.hub.disconnected(function(){Hub.Instance.debug("Disconnected!");Hub.Instance.updateStatus("Stopped");$.connection.hub.lastError&&Hub.Instance.warn("Disconnected. Reason: "+$.connection.hub.lastError.message)});class DSRecord{static Clone(n,t){var i,u,r,o,s,f,e;if(n===undefined||n===null)return null;t=t!==null&&t!==undefined&&t===!0;i={};for(u in n)if(u!=="_subLists"&&u!=="_parent"&&u!=="_list"){if(r=n[u],r===undefined&&(r=null),r===null){i[u]=null;continue}if(typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="function"){i[u]=r;continue}if(r instanceof Date){i[u]=new Date(r);continue}if(r instanceof moment){i[u]=new moment(r);continue}if(Array.isArray(r)){i[u]=[];for(o in r)i[u][o]=DSRecord.Clone(r[o],t);continue}i[u]=DSRecord.Clone(r,t)}if(n._list!==null&&n._list!==undefined&&(i._list=n._list),n._parent!==null&&n._parent!==undefined&&(i._parent=n._parent),n._subLists===null||n._subLists===undefined)return i;i=List.ListRecord.SetListValues(n._subLists,i);for(s in i._subLists)if(f=i._subLists[s],f!==null&&f!==undefined&&(f.composition||t)){let r=n[s];f.values=[];for(let n in r)(e=DSRecord.Clone(r[n],t),e!==null&&e!==undefined)&&(e._parent=i,e._list=f,f.values[n]=e)}return i}static IsEqual(n,t){var i=null,r,u,f;if((n===undefined||n===null)&&(t===undefined||t===null))return!0;if(n===undefined||n===null||t===undefined||t===null)return!1;for(i in n)if(!i.startsWith("_")&&!t.hasOwnProperty(i))return!1;for(i in t)if(!i.startsWith("_")&&!n.hasOwnProperty(i))return!1;for(i in n)if(!i.startsWith("_")&&(r=n[i],u=t[i],(r===undefined||String.isEmptyOrWhiteSpaces(r))&&(r=null),(u===undefined||String.isEmptyOrWhiteSpaces(u))&&(u=null),r!==null||u!==null)){if(r===null||u===null)return!1;if(typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof value=="function"){if(r!==u)return!1;continue}if(r instanceof Date&&u instanceof Date){if(r.toString()!==u.toString())return!1;continue}else if(r instanceof Date||u instanceof Date)return!1;if(r instanceof moment&&u instanceof moment){if(Dates.Compare(r,u)!==0)return!1;continue}else if(r instanceof moment||u instanceof moment)return!1;if(Array.isArray(r)&&Array.isArray(u)){if(r.length!==u.length)return!1;for(f in r)if(!DSRecord.IsEqual(r[f],u[f]))return!1;continue}else if(Array.isArray(r)||Array.isArray(u))return!1;if(!DSRecord.IsEqual(r,u))return!1}if((n._subLists===null||n._subLists===undefined)&&(t._subLists===null||t._subLists===undefined))return!0;if((n._subLists===null||n._subLists===undefined)&&!(t._subLists===null||t._subLists===undefined)||!(n._subLists===null||n._subLists===undefined)&&(t._subLists===null||t._subLists===undefined))return!1;for(i in n._subLists)if(!(n._subLists[i]===null||n._subLists[i]===undefined)&&(t._subLists[i]===null||t._subLists[i]===undefined)||(n._subLists[i]===null||n._subLists[i]===undefined)&&!(t._subLists[i]===null||t._subLists[i]===undefined))return!1;for(i in t._subLists)if(!(n._subLists[i]===null||n._subLists[i]===undefined)&&(t._subLists[i]===null||t._subLists[i]===undefined)||(n._subLists[i]===null||n._subLists[i]===undefined)&&!(t._subLists[i]===null||t._subLists[i]===undefined))return!1;for(i in n._subLists){if(n._subLists[i].composition!==t._subLists[i].composition)return!1;if(n._subLists[i].composition){let r=n[i],u=t[i];if(!DSRecord.IsEqual(r,u))return!1}}return!0}}class DSColumn extends LoggerBaseObject{get IsKey(){for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="Key")return!0;return!1}get IsEmail(){for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="Email")return!0;return!1}get ForeignKey(){for(var n=0;n<this._constraints.length;n++)if(this._constraints[n].Type==="ForeignKey")return this._constraints[n];return null}get Unique(){for(var n=0;n<this._constraints.length;n++)if(this._constraints[n].Type==="Unique")return this._constraints[n];return null}get Typeof(){switch(this._type){case"Int32":case"Decimal":case"Double":return"number";case"Boolean":return"boolean";case"String":return"string"}return this._type}get DatetimeFormat(){if(this._type!=="DateTime")return null;for(var n=0;n<this._formats.length;n++)if(this._formats[n].Type==="DateTime")return this._formats[n].Format;return null}get StringFormat(){if(this._type!=="String")return null;for(var n=0;n<this._formats.length;n++)if(this._formats[n].Type==="Mask")return this._formats[n].Mask;return null}get StringMaxLength(){if(this._type!=="String")return null;for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="String")return this._controls[n].MaxLength;return null}get Field(){return this._field}get Property(){return this._property}get DefaultValue(){return this._defaultValue}get Formats(){return this._formats}get Controls(){return this._controls}get Constraints(){return this._constraints}get IsNullable(){return this._isNullable}get IsRequired(){if(!this._isNullable)return!0;for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="Required")return!0;return!1}get Type(){return this._type}get PathEnumerable(){var t=this._enumerable.Area,i=this._enumerable.Name,n="";return String.isEmptyOrWhiteSpaces(t)||(n+=t+"/"),String.isEmptyOrWhiteSpaces(i)||(n+=i+"/"),n}get Digit(){for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="Decimal")return new Digits.Decimal(this._controls[n].NbDigitsBefore,this._controls[n].NbDigitsAfter);return this._type==="Int32"?new Digits.Decimal(9):new Digits.Decimal(6,3)}get Unit(){for(var n=0;n<this._controls.length;n++)if(this._controls[n].Type==="Decimal")return this._controls[n].Unit;return null}hasSameStructure(n){if(this._isNullable!==n._isNullable||this._type!==n._type)return!1;for(var t in this._enumerable)if(t!=="Name"&&t!=="Area"&&(n._enumerable[t]===null||n._enumerable[t]===undefined))return!1;for(t in n._enumerable)if(t!=="Name"&&t!=="Area"&&(this._enumerable[t]===null||this._enumerable[t]===undefined))return!1;for(t in this._enumerable)if(t!=="Name"&&t!=="Area"&&this._enumerable[t].Label!==n._enumerable[t].Label)return!1;return!0}convertType(n,t,i){var u,f,e,r;if(i===undefined&&(i=!0),u=null,(n===undefined||typeof n=="string"&&n==="")&&(n=null),!this._isNullable&&i&&n===null)return this.error("The property '"+this._property+"' can't be null"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n;if(n===null||(typeof n=="string"&&(n=n.trim()),typeof n===this.Typeof))return n;f=null;switch(this._type){case"Int32":if(typeof n=="boolean")return n?1:0;if(typeof n=="string"){if(n.trim()==="")return 0;if(u=String.parseInt(n),!isNaN(u))return u}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n;case"Decimal":case"Double":if(typeof n=="boolean")return n?1:0;if(typeof n=="string"){if(n.trim()==="")return 0;if(u=String.parseFloat(n),!isNaN(u))return u}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n;case"Boolean":return typeof n=="string"?n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1":typeof n=="number"?n!==0:(this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n);case"String":return n.toString().trim();case"Enum":if(typeof n=="number"&&this._enumerable[n]!==undefined)return n;if(typeof n=="string"){if(n!=="Name"&&n!=="Area"&&this._enumerable[n]!==undefined)return(e=String.parseInt(n),!isNaN(e))?e:n;for(r in this._enumerable)if(r!=="Name"&&r!=="Area"&&this._enumerable[r]!==null&&this._enumerable[r]!==undefined&&!String.isEmptyOrWhiteSpaces(this._enumerable[r].Label)&&this._enumerable[r].Label.trim().toUpperCase()===n.trim().toUpperCase())return String.parseInt(r)}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n;case"DateTime":return n instanceof Date&&(f=moment(n.toISOString(),moment.ISO_8601),f.isValid())?f:n instanceof moment?n:typeof n=="string"&&(f=moment(n,[moment.ISO_8601,"YYYY/MM/DD HH:mm:ss.SSS","YYYY/MM/DD HH:mm:ss","YYYY/MM/DD HH:mm","YYYY/MM/DD","DD/MM/YYYY HH:mm:ss.SSS","DD/MM/YYYY HH:mm:ss","DD/MM/YYYY HH:mm","DD/MM/YYYY","HH:mm:ss.SSS","HH:mm:ss","HH:mm"],!0),f.isValid())?f:(this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n);case"Byte[]":return n;default:return this.error("Type '"+this._type+"' not implemented!"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n}}convertFromJSON(n,t){if(!this._isNullable&&(n===null||n===undefined))return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n;for(var i=0;i<this._formats.length;i++)try{n=this._formats[i].convertFromJSON(n)}catch(r){return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n}return this.convertType(n,t)}convertToJSON(n,t){for(var i=0;i<this._formats.length;i++)try{n=this._formats[i].convertToJSON(n)}catch(r){return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}"]),n}return n}checkProperties(n,t){n=this.convertType(n,t);for(var i=0;i<this._controls.length;i++)this._controls[i].check(this,n,t);return n}getEnumerable(n){var t=null,i=null,r,u;if(this._type!=="Enum")return n===undefined?[]:n;if(n===undefined){r=[];u=this.PathEnumerable;for(t in this._enumerable)t!=="Name"&&t!=="Area"&&(String.isEmptyOrWhiteSpaces(this._enumerable[t].Label)||(i={},i.Id=String.parseInt(t),i.Label=this._enumerable[t].Label.trim().toUpperCase(),i.Picture=null,i.Name=this._enumerable[t].Name,String.isEmptyOrWhiteSpaces(this._enumerable[t].Name)||(i.Picture=u+this._enumerable[t].Name+".svg"),r.push(i)));return r}if(typeof n=="number"&&this._enumerable[n]!==undefined)return this._enumerable[n].Label;if(typeof n=="string"){if(n!=="Name"&&n!=="Area"&&this._enumerable[n]!==undefined)return this._enumerable[n].Label;for(t in this._enumerable)if(t!=="Name"&&t!=="Area"&&this._enumerable[t]!==null&&this._enumerable[t]!==undefined&&!String.isEmptyOrWhiteSpaces(this._enumerable[t].Label)&&this._enumerable[t].Label.trim().toUpperCase()===n.trim().toUpperCase())return this._enumerable[t].Label.trim().toUpperCase()}return n===null?(i={},i.Id=null,i.Label=this._field+"_NULL",i.Picture=this.PathEnumerable+"Null.svg",i.Name="Null",i):n}constructor(n,t){super("DSColumn["+n+"."+t.Property+"]");this._field=t.Field;this._property=t.Property;typeof t.Type=="string"?(this._type=t.Type,this._enumerable={}):(this._type="Enum",this._enumerable=t.Type);this._isNullable=t.IsNullable;this._defaultValue=t.DefaultValue;this._formats=DSAnnotationAttribute.FactoryList(t.Formats);this._controls=DSAnnotationAttribute.FactoryList(t.Controls);this._constraints=DSAnnotationAttribute.FactoryList(t.Constraints);this.info("Structure: "+this.toString())}}class DSTable extends LoggerBaseObject{static IsEqualProperties(n,t){return((n===undefined||String.isEmptyOrWhiteSpaces(n))&&(n=null),(t===undefined||String.isEmptyOrWhiteSpaces(t))&&(t=null),n===null&&t===null)?!0:n===null||t===null?!1:typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n===t:n instanceof Date&&t instanceof Date?n.toString()===t.toString():n instanceof Date||t instanceof Date?!1:n instanceof moment&&t instanceof moment?n.toString()===t.toString():(n instanceof moment||t instanceof moment,!1)}get NextSequenceId(){return this._lastSequenceId++}get NewRow(){for(var t={},n=0;n<this._columns.length;n++)t[this._columns[n].Property]=this._columns[n].DefaultValue;return t._table=this._name,t}updateUniqueValues(){var t=null,n,r,i;if(this._columnUnique.length!==0){for(n=0;n<this._records.length;n++)if(!this._records[n][this._indexDeleted]){r=this._identities[n][1];i=this.getRow(null,this._records[n],this._identities[n]);for(t in this._columnUnique)this._columnUnique[t].addValue(i)}if(this.IsVerbose)for(t in this._columnUnique)this.verbose("List of values for the column '"+this._columns[t].Property+"' = "+this._columnUnique[t].toListValues())}}updateForeignKeys(n){var r,i,t;if(this._columnForeign===null||n===!0){this.info("Declaring foreign key of the table '"+this._name+"' ...");try{for(this._columnForeign=[],r=!1,i=0;i<this._columns.length;i++)(t=this._columns[i].ForeignKey,t!==null)&&(this.debug("The column '"+this._columns[i].Property+"' is a foreign key on the table '"+t.Table+"'"),this._database.Tables[t.Table]===null||this._database.Tables[t.Table]===undefined?(this.error("The table '"+t.Table+"' doesn't exist in the schema"),r=!1):this._columnForeign.push({index:i,table:this._database.Tables[t.Table]}));if(r){this.error("Some errors occurs ...");this._columnForeign=undefined;return}this.info(this._columnForeign.length+" foreign keys are declared")}catch(u){this.exception("An exception occurs on declaring foreign key of the table '"+this._name+"'",u);this._columnForeign=undefined}}}get Loaded(){return this._loaded}hasSameStructure(n){var t;if(this._columns.length!==n._columns.length)return!1;for(var r={},u={},i=null,i=0;i<this._columns.length;i++)r[this._columns[i].Property]=this._columns[i],u[n._columns[i].Property]=n._columns[i];t=null;for(t in r)if(u[t]===null||u[t]===undefined)return!1;for(t in u)if(r[t]===null||r[t]===undefined)return!1;for(t in r)if(!r[t].hasSameStructure(u[t]))return!1;return!0}setDatabase(n){this._database=n}setTable(n,t){var i,c,u,f,o,s;if(this.info("Loading table ..."),this._indexKey===undefined||this._indexTick===undefined||this._indexDeleted===undefined||this._columnForeign===undefined)return this.error("The initialization has failed!"),!1;this._lastSequenceId=1;this._records=[];this._identities=[];this._identitiesByServerId=[];this._identitiesByClientId=[];try{var r=0,h=!1,e=new Errors;for(i=0;i<n.length;i++){for(this._records[i]=[],r=0;r<this._columns.length;r++)e.clear(),c=this._columns[r].convertFromJSON(n[i][r],e),e.HasError&&(this.error("["+i+"]: Conversion of the value '"+n[i][r].toString()+"' of the column '"+this._columns[r].Property+"' in the record '"+String.JSONStringify(n[i])+"' has failed"),h=!0),this._records[i][r]=c;for(this._records[i][this._indexTick]=n[i][this._indexTick],this._records[i][this._indexDeleted]=n[i][this._indexDeleted],n[this._indexReplayClientId]!==null&&this._indexReplayClientId!==undefined&&(this._replayServerIds[n[this._indexReplayClientId]]=this._records[i][this._indexKey]),u=[],u[0]=i,u[1]=this.NextSequenceId,r=2,f=0;f<this._columnForeign.length;r++,f++)this._columnForeign[f].table.getIdentity(u,r,this._records[i][this._columnForeign[f].index]);this.IsDebug&&this.debug("["+i+"]: Row = "+String.JSONStringify(this._records[i])+", Identity = "+String.JSONStringify(u));o=this._records[i][this._indexKey];s=u[1];this.updateIdentity(o,s);this._identities[i]=u;this._identitiesByServerId[o]=u;this._identitiesByClientId[s]=u}return(t&&t>0&&this._lastSequenceId<t+1&&(this._lastSequenceId=t+1),this.info("The sequence Id starts at "+this._lastSequenceId),h)?(this.error("Errors occurs on loading table ..."),!1):(this._loaded=!0,this.info("Table loaded with "+this._records.length+" records"),this._database.eventOnLoad(this._name),!0)}catch(l){return this.exception("An exception occurs on loading the table '"+this._name+"'",l),this._loaded=!1,!1}}getIdentity(n,t,i){var r,u;if(i===null||i===undefined){n[t]=null;return}if(r=this._identitiesByServerId[i],r!==undefined){n[t]=r[1];return}u={identity:n,index:t};n[t]=null;this.IsVerbose&&this.verbose("The identity '"+i+"' is not yet known by the table ... queueing ("+String.JSONStringify(u)+")!");this._notYetKnown[i]===undefined&&(this._notYetKnown[i]=[]);this._notYetKnown[i].push(u)}updateIdentity(n,t){var r,i;if(this._notYetKnown[n]!==undefined){for(this.IsVerbose&&this.verbose(this._notYetKnown[n].length+" identities of the serverId ("+n+") from foreign key were waiting for the clientId ("+t+")"),r=0;r<this._notYetKnown[n].length;r++)(i=this._notYetKnown[n][r],i!==null&&i!==undefined)&&(this.IsVerbose&&this.verbose(String.JSONStringify(i.identity)+" => Ids["+i.index+"] ="+t),i.identity[i.index]=t);delete this._notYetKnown[n]}}updateServerId(n,t,i){for(var f,u,e=!0,r=0;r<this._columnForeign.length;r++)if(this._columnForeign[r].table.Name===n){for(e&&(this.info("Updating id refering the foreign key ('"+n+"', ["+t+"]) with the serverId ["+i+"] ..."),e=!1),f=0,u=0;u<this._identities.length;u++)this._identities[u][r+2]===t&&(this._records[u][this._columnForeign[r].index]=i,f++);this.debug(f+" Ids updated")}}updateClientId(n,t,i){for(var f,r,o,e=!0,u=0;u<this._columnForeign.length;u++)if(this._columnForeign[u].table.Name===n){for(e&&(this.info("Updating id refering the foreign key ('"+n+"', ["+t+"]) with the clientId ["+i+"] ..."),e=!1),f=0,r=0;r<this._identities.length;r++)this._identities[r][u+2]===t&&(o=this.getRow(r),this._identities[r][u+2]=i,f++,this._database.eventOnUpdate(this._name,this._identities[r][1],o));this.debug(f+" Ids updated")}}getRow(n,t,i){var u,r,f;for(n!==null&&n!==undefined&&(t=this._records[n],i=this._identities[n]),u={},r=0,r=0;r<this._columns.length;r++)u[this._columns[r].Property]=t[r]instanceof moment?moment(t[r]):t[r]instanceof Date?moment(t[r].toISOString(),moment.ISO_8601):t[r];if(u._tick=t[r++],u._deleted=t[r++],u._table=this._name,i!==null&&i!==undefined)for(r=0,u._rowIndex=i[r++],u[this._columns[this._indexKey].Property]=i[r++],f=0;f<this._columnForeign.length;f++,r++)u[this._columns[this._columnForeign[f].index].Property]=i[r];return u}getTable(){var t,n;try{for(t=[],n=0;n<this._records.length;n++)this._records[n][this._indexDeleted]||t.push(this.getRow(n));return t}catch(i){return this.exception("An exception occurs on reading data from the table '"+this._name+"'",i),[]}}each(n){if(n!==null&&n!==undefined)for(var t=0;t<this._records.length;t++)this._records[t][this._indexDeleted]||n(this.getRow(t))}get Sequence(){for(let n=0;n<this._columns.length;n++){let t=this._columns[n];if(t!==null&&t!==undefined)for(let n=0;n<t.Formats.length;n++){let i=t.Formats[n];if(i!==null&&i!==undefined&&i.Type==="Sequence")return{Property:t.Property,Key:i.Key,Length:i.Length}}}return null}getColumn(n){var t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t]}getColumnLabel(n){var t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].Field}getDefaultValue(n){var t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].DefaultValue}getHistoryValue(n,t){var c=this._columnsByName[n],u,e,o,s,i,r,h,f;if(c===undefined||c===null||(u=this._database.Tables["History"+this._name],u===null||u===undefined)||(e=u._columnsByName[n],e===null||e===undefined)||(o=u._columns[e],o===null||o===undefined)||(s=o.ForeignKey,s===null||s===undefined)||(i=this._database.Tables[s.Table],i===null||i===undefined))return null;for(r=0,r=0;r<i._columnForeign.length;r++)if(i._columns[i._columnForeign[r].index].Property==="HistoryId")break;if(r>=i._columnForeign.length)return null;for(r+=2,h=-1,f=i._identitiesByClientId.length-1;f>=0;f--){let n=i._identitiesByClientId[f];if(n!==null&&n!==undefined&&n[0]!==null&&n[0]!==undefined&&!i._records[n[0]][i._indexDeleted]&&n[r]===t){h=f;break}}return{Id:t,HistoryId:h}}getLastHistoryId(n){var r=this._columnsByName.HistoryId,t,i;if(r===null||r===undefined)return null;for(t=0,t=0;t<this._columnForeign.length;t++)if(this._columns[this._columnForeign[t].index].Property==="HistoryId")break;if(t>=this._columnForeign.length)return null;for(t+=2,i=this._identitiesByClientId.length-1;i>=0;i--){let r=this._identitiesByClientId[i];if(r!==null&&r!==undefined&&r[0]!==null&&r[0]!==undefined&&!this._records[r[0]][this._indexDeleted]&&r[t]===n)return i}return null}updateHistoryProperties(n){if(this._hasCopy===!1)return n;this._hasCopy=!1;for(let t=0;t<this._columns.length;t++)if(this._columns[t].Property.startsWith("Copy")){let r=this._columns[t],i=this._columns[this._columnsByName[r.Property.substr(4)]];if(i!==null&&i!==undefined){let u=r.ForeignKey;if(u!==null&&u.Table.startsWith("History")){let f=i.ForeignKey;if(f!==null&&u.Table.substr(7)===f.Table){if(this._hasCopy=!0,n[i.Property]===null||n[i.Property]===undefined){n[i.Property]=null;n[r.Property]=null;continue}typeof n[i.Property]!="string"||isNaN(parseInt(n[i.Property]))||(n[i.Property]=parseInt(n[i.Property]));let e=this._database.getLastHistoryId(f.Table,n[i.Property]);if(n[r.Property]!==e)if(n[r.Property]===null||n[r.Property]===undefined)n[r.Property]=e;else{let t=this._database.getRowById(u.Table,n[r.Property]);(t===null||t.HistoryId!==n[i.Property])&&(n[r.Property]=e)}}}}}return n}getEnumerable(n,t){var i=this._columnsByName[n];return i===undefined||i===null?[]:this._columns[i].getEnumerable(t)}getDatetimeFormat(n){var t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].DatetimeFormat}convertValue(n,t,i){var r,u,f;return(i===undefined&&(i=!0),r=this._columnsByName[n],r===undefined||r===null)?t:(u=new Errors,f=this._columns[r].convertType(t,u,i),u.HasError?t:f)}checkProperties(n,t){for(var i,r=0;r<this._columns.length;r++){if(i=this._columns[r],n[i.Property]===undefined){this.error("The property '"+i.Property+"' is missing into the record");t.addField(i.Property,"ERR_FIELD_MISSING",["{"+i.Field+"}"]);n[i.Property]=null;continue}n[i.Property]=i.checkProperties(n[i.Property],t)}return n}getRowById(n){var t=this._identitiesByClientId[n];return t===null||t===undefined?null:this.getRow(t[0])}getClientIdByServerId(n){var t=this._identitiesByServerId[n];return t===null||t===undefined?null:t[1]}getServerIdByClientId(n){var t=this._identitiesByClientId[n];return t===null||t===undefined?null:this._records[t[0]][this._indexKey]}getRecordToServer(n){for(var r={},i=new Errors,t=0;t<this._columns.length;t++)r[this._columns[t].Property]=this._columns[t].convertToJSON(n[t],i);return i.HasError&&this.warn("Some errors occur during converting the record to a JSON object ("+i.toString()+")"),r}getIdentityToServer(n){var t={},i,r;for(t._rowIndex=n[0],t[this._columns[this._indexKey].Property]=n[1],i=0,r=2;i<this._columnForeign.length;i++,r++)t[this._columns[this._columnForeign[i].index].Property]=n[r];return t}addFromClient(n,t){var h,f,s,e,o,c,l;try{this.info("Adding the record "+String.JSONStringify(n)+" from the client ...");for(var r=[],u=null,i=null,i=0;i<this._columns.length;i++){if(u=this._columns[i],n[u.Property]===undefined){this.error("The property '"+u.Property+"' is missing into the record");t.addField(u.Property,"ERR_FIELD_MISSING",["{"+u.Field+"}"]);r[i]=null;continue}r[i]=u.checkProperties(n[u.Property],t)}r[this._indexKey]!==-1&&(this.error("A new record must have an Id equals to -1"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]));r[this._indexTick]=null;r[this._indexDeleted]=!1;this.debug("The new row containing clientId is "+String.JSONStringify(r));for(i in this._columnUnique)(h=this._columnUnique[i],u=this._columns[i],h.existValue(this.getRow(null,r)))&&(this.error("The value '"+r[i]+"' already exists for the column '"+u.Property+"'"),t.addField(u.Property,h.Error,["{"+u.Field+"}"]));for(f=[],i=0,f[i++]=-1,f[i++]=-1,s=0;s<this._columnForeign.length;s++,i++){if(e=this._columnForeign[s],u=this._columns[e.index],o=r[e.index],o===null||o===undefined){f[i]=null;continue}if(c=e.table._identitiesByClientId[o],c===undefined){this.error("The index '"+o+"' (client) of the column '"+u.Property+"' doesn't exist into the table '"+this._columnForeign[s].table._name+"'");t.addField(u.Property,u.ForeignKey.Error);f[i]=null;continue}f[i]=o;r[e.index]=e.table._records[c[0]][e.table._indexKey]}if(t.HasError)return this.error("Unable to add the record due to some errors ("+t.toString()+")"),null;f[0]=this._records.length;f[1]=this.NextSequenceId;this._records.push(r);this._identities.push(f);this._identitiesByClientId[f[1]]=f;l=this.getRow(null,r,f);for(i in this._columnUnique)this._columnUnique[i].addValue(l);return(this.info("The row containing serverId "+String.JSONStringify(r)+" and clientId "+String.JSONStringify(f)+" is added"),!this._database.send(this._name,"Create",this.getRecordToServer(r),this.getIdentityToServer(f),r[this._indexTick]))?(t.addGlobal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnCreate(this._name,f[1]),l)}catch(a){return this.exception("An exception occurs on adding data into the table '"+this._name+"'",a),t.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}updateFromClient(n,t,i){var o,y,p,s,h,a,c,l,w,b;try{this.info("Updating the record "+String.JSONStringify(n)+" to "+String.JSONStringify(t)+" from the client ...");for(var u=[],f=[],e=null,r=null,r=0;r<this._columns.length;r++){if(e=this._columns[r],n[e.Property]===undefined||t[e.Property]===undefined){this.error("The property '"+e.Property+"' is missing into the record");i.addField(e.Property,"ERR_FIELD_MISSING",["{"+e.Field+"}"]);u[r]=null;f[r]=null;continue}u[r]=e.convertType(n[e.Property],i);f[r]=e.checkProperties(t[e.Property],i)}if((u[this._indexKey]<0||f[this._indexKey]<0)&&(this.error("An existing record must have an Id greater or equal to 0"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"])),i.HasError||u[this._indexKey]===f[this._indexKey]||(this.error("New and old records must represent the same record!"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"])),i.HasError)return this.error("Unable to update the record due to some errors ("+i.toString()+")"),null;if(u[this._indexTick]=n._tick!==undefined?n._tick:null,u[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,f[this._indexTick]=u[this._indexTick],f[this._indexDeleted]=u[this._indexDeleted],(u[this._indexDeleted]||f[this._indexDeleted])&&(this.error("Unable to update a record already deleted!"),i.addGlobal("ERR_RECORD_DELETED")),this.debug("The rows containing clientId are old:"+String.JSONStringify(u)+" and new:"+String.JSONStringify(f)),o=this.getRowById(u[this._indexKey]),o===null||o===undefined)this.error("New and old records must represent an existing record!"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]);else{for(y=!1,r=0;r<this._columns.length;r++)if(!DSTable.IsEqualProperties(u[r],o[this._columns[r].Property])){this.error("Old ("+String.JSONStringify(u)+") and existing ("+String.JSONStringify(o)+") records must represent the same record ("+this._columns[r].Property+" => old: '"+(u[r]===null?"null":u[r].toString())+"' - existing: '"+(o[this._columns[r].Property]===null?"null":o[this._columns[r].Property].toString())+"') !");i.addGlobal("ERR_RECORD_DIFFERENT");y=!0;break}y||u[this._indexTick]===o._tick&&u[this._indexDeleted]===o._deleted||(this.error("Old ("+String.JSONStringify(u)+") and existing ("+String.JSONStringify(o)+") records must represent the same record (tick or deleted flag)!"),i.addGlobal("ERR_RECORD_DIFFERENT"))}for(r in this._columnUnique)(p=this._columnUnique[r],e=this._columns[r],p.existValue(this.getRow(null,f)))&&(this.error("The value '"+f[r]+"' already exists for the column '"+e.Property+"'"),i.addField(e.Property,p.Error,["{"+e.Field+"}"]));for(s=this._identitiesByClientId[f[this._indexKey]],h=[],r=0,h[r++]=s[0],h[r++]=s[1],f[this._indexKey]=this._records[s[0]][this._indexKey],a=0;a<this._columnForeign.length;a++,r++){if(c=this._columnForeign[a],e=this._columns[c.index],l=f[c.index],l===null||l===undefined){h[r]=null;continue}if(w=c.table._identitiesByClientId[l],w===undefined){this.error("The index '"+l+"' (client) of the column '"+e.Property+"' doesn't exist into the table '"+this._columnForeign[a].table._name+"'");i.addField(e.Property,e.ForeignKey.Error);h[r]=null;continue}h[r]=l;f[c.index]=c.table._records[w[0]][c.table._indexKey]}if(i.HasError)return this.error("Unable to update the record due to some errors ("+i.toString()+")"),null;var v=this._records[h[0]],k=this.getRecordToServer(v),d=this.getIdentityToServer(s);for(r=0;r<v.length;r++)v[r]=f[r];for(r=0;r<s.length;r++)s[r]=h[r];b=this.getRow(null,f,s);for(r in this._columnUnique)u[r]!==f[r]&&(this._columnUnique[r].deleteValue(this.getRow(null,u)),this._columnUnique[r].addValue(b));return(this.info("The row containing serverId "+String.JSONStringify(v)+" and clientId "+String.JSONStringify(s)+" is updated"),!this._database.send(this._name,"Update",{New:this.getRecordToServer(f),Old:k},{New:this.getIdentityToServer(s),Old:d},f[this._indexTick]))?(i.addGlobal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnUpdate(this._name,s[1],o),b)}catch(g){return this.exception("An exception occurs on updating data into the table '"+this._name+"'",g),i.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}updateFromServer(n,t){var w,c,u,e,o,v,y,b,f,p,a;try{w=new Errors;t!==null&&t!==undefined?this.info("Acknowledging the record "+String.JSONStringify(n)+" from the server within clientId "+String.JSONStringify(t)+" ..."):this.info("Updating the record "+String.JSONStringify(n)+" from the server ...");for(var r=[],l=null,i=null,s=null,h=null,i=0;i<this._columns.length;i++){if(l=this._columns[i],n[l.Property]===undefined||n[l.Property]===undefined){this.warn("The property '"+l.Property+"' is missing into the record");r[i]=null;continue}r[i]=l.convertFromJSON(n[l.Property],w)}if(r[this._indexTick]=n._tick!==undefined?n._tick:null,r[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,this.debug("The row containing serverId is "+String.JSONStringify(r)),t!==null&&t!==undefined)if(c=this._identitiesByServerId[r[this._indexKey]],u=this._identitiesByClientId[t[this._columns[this._indexKey].Property]],(c===null||c===undefined)&&u!==null&&u!==undefined)this.info("Acknowledging a creation ..."),this._identitiesByServerId[r[this._indexKey]]=u,this._database.updateServerId(this._name,u[1],r[this._indexKey]);else{if(u===null||u===undefined){this.warn("Identity information of the record is missing ... ignore this update!");return}if(c[0]!==u[0]){this.info("Acknowledging a creation but the record has been created before this action ... Merging rows ["+c[0]+"] and ["+u[0]+"] ...");this.debug("Removing referencing to the clientId ["+u[1]+"] ...");this._database.updateClientId(this._name,u[1],c[1]);for(i in this._columnUnique)this._columnUnique[i].deleteValue(this.getRow(null,this._records[u[0]],u));this.debug("Deleting the row ["+u[0]+"] ...");this._records[u[0]][this._indexDeleted]=!0;this.debug("The clientId ["+t[this._columns[this._indexKey].Property]+"] is replaced by ["+c[1]+"]");t[this._columns[this._indexKey].Property]=c[1];this._database.eventOnDelete(this._name,u[1])}}if(e=this._identitiesByServerId[r[this._indexKey]],e===null||e===undefined){for(this.debug("This record is a new one ... create it!"),o=this._records.length,this._records.push(r),h=[],h[0]=o,h[1]=this.NextSequenceId,i=2,s=0;s<this._columnForeign.length;i++,s++)this._columnForeign[s].table.getIdentity(h,i,this._records[o][this._columnForeign[s].index]);if(this.IsDebug&&this.debug("["+o+"]: Row = "+String.JSONStringify(this._records[o])+", Identity = "+String.JSONStringify(h)),v=this._records[o][this._indexKey],y=h[1],this.updateIdentity(v,y),this._identities[o]=h,this._identitiesByServerId[v]=h,this._identitiesByClientId[y]=h,!this._records[o][this._indexDeleted]){b=this.getRow(null,this._records[o],this._identities[o]);for(let n in this._columnUnique)this._columnUnique[n].addValue(b)}this._records[o][this._indexDeleted]||this._database.eventOnCreate(this._name,h[1]);return}if(f=this._records[e[0]],f[this._indexTick]!==null&&f[this._indexTick]!==undefined&&r[this._indexTick]!==null&&r[this._indexTick]!==undefined&&f[this._indexTick]>=r[this._indexTick]){this.info("The record stored into the table is newer than the record to update, ignore it!");return}for(p=this.getRow(e[0]),s=0,i=2;s<this._columnForeign.length;s++,i++)this._columnForeign[s].table.getIdentity(e,i,r[this._columnForeign[s].index]);for(i in this._columnUnique)(f[i]!==r[i]||r[this._indexDeleted]!==f[this._indexDeleted])&&(this._columnUnique[i].deleteValue(this.getRow(null,f,e)),r[this._indexDeleted]||this._columnUnique[i].addValue(p));for(a=f[this._indexDeleted],i=0;i<this._columns.length;i++)f[i]=r[i];f[this._indexTick]=r[this._indexTick];f[this._indexDeleted]=r[this._indexDeleted];this.info("The row containing serverId "+String.JSONStringify(f)+" and clientId "+String.JSONStringify(e)+" is updated");f[this._indexDeleted]===a?a||this._database.eventOnUpdate(this._name,e[1],p):a?this._database.eventOnCreate(this._name,e[1]):this._database.eventOnDelete(this._name,e[1])}catch(k){this.exception("An exception occurs on updating data into the table '"+this._name+"'",k)}}deleteRowById(n){try{this.info("Deleting the row "+n.toString()+" from the client ...");var t=this._identitiesByClientId[n];return t===null||t===undefined?!1:this._records[t[0]][this._indexDeleted]?!1:(this._records[t[0]][this._indexDeleted]=!0,this._database.eventOnDelete(this._name,t[1]),!0)}catch(i){return this.exception("An exception occurs on deleting row "+n.toString()+" into the table '"+this._name+"'",i),!1}}deleteFromClient(n,t){var u,s;try{this.info("Deleting the record "+String.JSONStringify(n)+" from the client ...");for(var i=[],f=null,r=null,r=0;r<this._columns.length;r++){if(f=this._columns[r],n[f.Property]===undefined){this.error("The property '"+f.Property+"' is missing into the record");t.addField(f.Property,"ERR_FIELD_MISSING",["{"+f.Field+"}"]);i[r]=null;continue}i[r]=f.convertType(n[f.Property],t)}if(i[this._indexKey]<0&&(this.error("An existing record must have an Id greater or equal to 0"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"])),i[this._indexTick]=n._tick!==undefined?n._tick:null,i[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,i[this._indexDeleted]&&(this.error("Unable to delete a record already deleted!"),t.addGlobal("ERR_RECORD_DELETED")),this.debug("The row containing clientId is "+String.JSONStringify(i)),u=this.getRowById(i[this._indexKey]),(u===null||u===undefined)&&i[this._indexKey]>=0)this.error("Record must represent an existing record!"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]);else if(i[this._indexKey]>=0){for(s=!1,r=0;r<this._columns.length;r++)if(!DSTable.IsEqualProperties(i[r],u[this._columns[r].Property])){this.error("Old ("+String.JSONStringify(i)+") and existing ("+String.JSONStringify(u)+") records must represent the same record ("+this._columns[r].Property+" => old: '"+(i[r]===null?"null":i[r].toString())+"' - existing: '"+(u[this._columns[r].Property]===null?"null":u[this._columns[r].Property].toString())+"') !");t.addGlobal("ERR_RECORD_DIFFERENT");s=!0;break}s||i[this._indexTick]===u._tick&&i[this._indexDeleted]===u._deleted||(this.error("Old ("+String.JSONStringify(i)+") and existing ("+String.JSONStringify(u)+") records must represent the same record (tick or deleted flag)!"),t.addGlobal("ERR_RECORD_DIFFERENT"))}if(t.HasError)return this.error("Unable to delete the record due to some errors ("+t.toString()+")"),null;var e=this._identitiesByClientId[i[this._indexKey]],o=this._records[e[0]],h=this.getRecordToServer(o),c=this.getIdentityToServer(e);o[this._indexDeleted]=!0;for(r in this._columnUnique)this._columnUnique[r].deleteValue(this.getRow(null,i));return(this.info("The row containing serverId "+String.JSONStringify(o)+" and clientId "+String.JSONStringify(e)+" is deleted"),!this._database.send(this._name,"Delete",h,c,o[this._indexTick]))?(t.addGlobal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnDelete(this._name,e[1]),this.getRow(e[0]))}catch(l){return this.exception("An exception occurs on deleting data into the table '"+this._name+"'",l),t.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}executeRequest(n,t,i,r){try{if(this.info("Executing the request '"+n+"' with the record "+String.JSONStringify(t)+" from the client ..."),this._name==="User"&&n==="NewPassword"&&t!==null&&t!==undefined&&t.Id!==null&&t.Id!==undefined&&t.CustomerId!==null&&t.CustomerId!==undefined){var u=this._identitiesByClientId[t.Id],f=this._database.getServerIdByClientId("Customer",t.CustomerId);if(u!==null||u!==undefined)return this._database.send(this._name,n,{UserId:this._records[u[0]][this._indexKey],CustomerId:f},{UserId:t.Id,CustomerId:t.CustomerId},null,r)?null:(i.addGlobal("ERR_OUT_OF_MEMORY"),null)}return i.addGlobal("ERR_REQUEST_UNKNOWN"),null}catch(e){return this.exception("An exception occurs on executin a request into the table '"+this._name+"'",e),i.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}rollback(n,t,i,r){var l=null,h,o,e,u,v,c,y,a;if(this.info("Rollbacking the request serverId:"+String.JSONStringify(t)+" clientId:"+String.JSONStringify(i)+" if and only if the tick is '"+r+"' ..."),h=t,o=i,n==="Update"&&t!==null&&t!==undefined&&i!==null&&i!==undefined&&(h=t.Old,o=i.Old),h===null||h===undefined||o===null||o===undefined){this.error("Unable to rollback due to a missing parameter!");return}var s=o._rowIndex,p=o[this._columns[this._indexKey].Property],f=this._identitiesByClientId[p];if(s===null||s===undefined){if(f===null||f===undefined){this.error("Unable to rollback due to a non-consitency information!");return}s=f[0]}else if(s!==f[0]){this.error("Unable to rollback due to a non-consitency information!");return}if(this.debug("Rollback the row ("+s+")"),e=this._records[s],e===null||e===undefined){this.error("Unable to rollback due to a missing row!");return}if(e[this._indexTick]!==r){this.info("Unable to rollback the row ("+s+") because the row has been updated since sending the request");return}u=null;switch(n){case"Create":this.debug("Delete the row");e[this._indexDeleted]=!0;for(u in this._columnUnique)this._columnUnique[u].deleteValue(this.getRow(null,e,f));this._database.eventOnDelete(this._name,f[1]);break;case"Update":for(this.debug("Restore the row"),u=0;u<this._columns.length;u++)if(h[this._columns[u].Property]===undefined){this.error("Unable to rollback due to a missing property!");return}for(u=0;u<this._columnForeign.length;u++)if(o[this._columns[this._columnForeign[u].index].Property]===undefined){this.error("Unable to rollback due to a missing identity!");return}for(v=new Errors,c=[],u=0;u<this._columns.length;u++)c[u]=this._columns[u].convertFromJSON(h[this._columns[u].Property],v);l=this.getRow(null,c,o);for(u in this._columnUnique)e[u]!==c[u]&&(this._columnUnique[u].deleteValue(this.getRow(null,e,f)),this._columnUnique[u].addValue(l));for(y=this.getRow(s),u=0;u<this._columns.length;u++)e[u]=c[u];for(u=2,a=0;a<this._columnForeign.length;u++,a++)f[u]=o[this._columns[this._columnForeign[a].index].Property];this._database.eventOnUpdate(this._name,f[1],y);break;case"Delete":this.debug("Restore the row as undeleted");e[this._indexDeleted]=!1;l=this.getRow(null,e,f);for(u in this._columnUnique)this._columnUnique[u].addValue(l);this._database.eventOnCreate(this._name,f[1])}}getNewClientId(n,t,i,r){var u,f,e;return t===null||t===undefined?null:(u=this._columns[n.index],f=null,t>=0)?(f=n.table._identitiesByServerId[t],f===undefined)?(this.error("The serverId '"+t+"' of the column '"+u.Property+"' doesn't exist into the table '"+n.table._name+"'"),r.addField(u.Property,u.ForeignKey.Error),null):f[1]:i===null||i===undefined?null:(t=n.table._replayServerIds[i],t!==null&&t!==undefined&&t>=0)?(f=n.table._identitiesByServerId[t],f===undefined)?(this.error("The serverId '"+t+"' of the column '"+u.Property+"' doesn't exist into the table '"+n.table._name+"'"),r.addField(u.Property,u.ForeignKey.Error),null):f[1]:(e=n.table._replayClientIds[i],e===null||e===undefined)?null:e}replayCreate(n,t,i,r){var h,e,s,l;try{this.info("Replaying the creation of the record "+String.JSONStringify(n)+" ...");for(var f=[],o=null,u=null,u=0;u<this._columns.length;u++){if(o=this._columns[u],n[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");r.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);f[u]=null;continue}f[u]=o.checkProperties(o.convertFromJSON(n[o.Property],r),r)}f[this._indexKey]!==-1&&(this.error("A new record must have an Id equals to -1"),r.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]));f[this._indexTick]=null;f[this._indexDeleted]=!1;this.debug("The new row containing serverId is "+String.JSONStringify(f));for(u in this._columnUnique)(h=this._columnUnique[u],o=this._columns[u],h.existValue(this.getRow(null,f)))&&(this.error("The value '"+f[u]+"' already exists for the column '"+o.Property+"'"),r.addField(o.Property,h.Error,["{"+o.Field+"}"]));for(e=[],u=0,e[u++]=-1,e[u++]=-1,s=0;s<this._columnForeign.length;s++,u++){var c=this._columnForeign[s],a=f[c.index],v=t[this._columns[c.index].Property];e[u]=this.getNewClientId(c,a,v,r)}if(r.HasError)return null;e[0]=this._records.length;e[1]=this.NextSequenceId;this._replayClientIds[t[this._columns[this._indexKey].Property]]=e[1];this._records.push(f);this._identities.push(e);this._identitiesByClientId[e[1]]=e;l=this.getRow(null,f,e);for(u in this._columnUnique)this._columnUnique[u].addValue(l);return this.info("The row containing serverId "+String.JSONStringify(f)+" and clientId "+String.JSONStringify(e)+" is added"),{requestId:null,table:this._name,action:"Create",record:this.getRecordToServer(f),identity:this.getIdentityToServer(e),tick:i}}catch(y){return this.exception("An exception occurs on replaying data into the table '"+this._name+"'",y),r.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}replayUpdate(n,t,i,r,u,f){var d,w,y,p,c,a,nt,s,tt,it,l,ut,b,k;try{this.info("Replaying the update of the record "+String.JSONStringify(n)+" within identities "+String.JSONStringify(t)+" to "+String.JSONStringify(i)+" within identities "+String.JSONStringify(r)+" ...");for(var e=null,v=null,o=null,h=[],e=0;e<this._columns.length;e++){if(o=this._columns[e],n[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");f.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);h[e]=null;continue}h[e]=this._columns[e].convertFromJSON(n[this._columns[e].Property],f)}if(h[this._indexTick]=n._tick!==undefined?n._tick:null,h[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,h[this._indexDeleted]&&(this.error("Unable to update a record already deleted!"),f.addGlobal("ERR_RECORD_DELETED")),d=h[this._indexKey],w=this.getNewClientId({index:this._indexKey,table:this},d,t[this._columns[this._indexKey].Property],f),w===null)return null;if(y=this._identitiesByClientId[w],y===null||y===undefined)return this.error("Unable to retrieve the client Id ["+w+"] into the table"),f.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null;for(p=[],p[0]=y[0],p[1]=y[1],e=2,v=0;v<this._columnForeign.length;v++,e++){var g=this._columnForeign[v],ft=h[g.index],et=t[this._columns[g.index].Property];p[e]=this.getNewClientId(g,ft,et,f)}if(f.HasError)return null;if(this.debug("The row of the record to update is "+String.JSONStringify(h)+" with identities "+String.JSONStringify(p)),c=this.getRow(y[0]),c===null||c===undefined)this.error("New and old records must represent an existing record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]);else{for(a=this.getRow(null,h,p),nt=!1,e=0;e<this._columns.length;e++)if(!DSTable.IsEqualProperties(a[this._columns[e].Property],c[this._columns[e].Property])){this.error("Old ("+String.JSONStringify(a)+") and existing ("+String.JSONStringify(c)+") records must represent the same record ("+this._columns[e].Property+" => old: '"+(a[this._columns[e].Property]===null?"null":a[this._columns[e].Property].toString())+"' - existing: '"+(c[this._columns[e].Property]===null?"null":c[this._columns[e].Property].toString())+"') !");f.addGlobal("ERR_RECORD_DIFFERENT");nt=!0;break}nt||(a._tick===c._tick||a._tick===null||c._tick===null)&&a._deleted===c._deleted||(this.error("Old ("+String.JSONStringify(a)+") and existing ("+String.JSONStringify(c)+") records must represent the same record (tick or deleted flag)!"),f.addGlobal("ERR_RECORD_DIFFERENT"))}if(f.HasError)return null;for(s=[],e=0;e<this._columns.length;e++){if(o=this._columns[e],i[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");f.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);s[e]=null;continue}s[e]=o.checkProperties(o.convertFromJSON(i[o.Property],f),f)}if(s[this._indexTick]=i._tick!==undefined?i._tick:null,s[this._indexDeleted]=i._deleted!==undefined?i._deleted:!1,s[this._indexDeleted]&&(this.error("Unable to update a record already deleted!"),f.addGlobal("ERR_RECORD_DELETED")),tt=s[this._indexKey],d!==tt&&(this.error("New and old records must represent the same record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"])),it=this.getNewClientId({index:this._indexKey,table:this},tt,r[this._columns[this._indexKey].Property],f),it===null)return null;for(w!==it&&(this.error("New and old records must represent the same record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"])),l=[],l[0]=y[0],l[1]=y[1],e=2,v=0;v<this._columnForeign.length;v++,e++){var rt=this._columnForeign[v],ot=s[rt.index],st=r[this._columns[rt.index].Property];l[e]=this.getNewClientId(rt,ot,st,f)}if(f.HasError)return null;this.debug("The new row of the record is "+String.JSONStringify(s)+" with identities "+String.JSONStringify(l));for(e in this._columnUnique)(ut=this._columnUnique[e],o=this._columns[e],ut.existValue(this.getRow(null,s,l)))&&(this.error("The value '"+s[e]+"' already exists for the column '"+o.Property+"'"),f.addField(o.Property,ut.Error,["{"+o.Field+"}"]));if(f.HasError)return null;for(b=this._records[l[0]],k=this._identities[l[0]],n=this.getRow(null,b,k),e=0;e<b.length;e++)b[e]=s[e];for(e=0;e<k.length;e++)k[e]=l[e];i=this.getRow(null,b,k);for(e in this._columnUnique)h[e]!==s[e]&&(this._columnUnique[e].deleteValue(n),this._columnUnique[e].addValue(i));return{requestId:null,table:this._name,action:"Update",record:{Old:this.getRecordToServer(h),New:this.getRecordToServer(s)},identity:{Old:this.getIdentityToServer(p),New:this.getIdentityToServer(l)},tick:u}}catch(ht){return this.exception("An exception occurs on replaying the update data into the table '"+this._name+"'",ht),f.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}replayDelete(n,t,i,r){var p,a,h,s,e,o,y;try{this.info("Replaying the deletion of the record "+String.JSONStringify(n)+" within identities "+String.JSONStringify(t)+" ...");for(var u=null,l=null,c=null,f=[],u=0;u<this._columns.length;u++){if(c=this._columns[u],n[c.Property]===undefined){this.error("The property '"+c.Property+"' is missing into the record");r.addField(c.Property,"ERR_FIELD_MISSING",["{"+c.Field+"}"]);f[u]=null;continue}f[u]=this._columns[u].convertFromJSON(n[this._columns[u].Property],r)}if(f[this._indexTick]=n._tick!==undefined?n._tick:null,f[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,f[this._indexDeleted]&&(this.error("Unable to delete a record already deleted!"),r.addGlobal("ERR_RECORD_DELETED")),p=f[this._indexKey],a=this.getNewClientId({index:this._indexKey,table:this},p,t[this._columns[this._indexKey].Property],r),a===null)return null;if(h=this._identitiesByClientId[a],h===null||h===undefined)return this.error("Unable to retrieve the client Id ["+a+"] into the table"),r.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null;for(s=[],s[0]=h[0],s[1]=h[1],u=2,l=0;l<this._columnForeign.length;l++,u++){var v=this._columnForeign[l],w=f[v.index],b=t[this._columns[v.index].Property];s[u]=this.getNewClientId(v,w,b,r)}if(r.HasError)return null;if(this.debug("The row of the record to delete is "+String.JSONStringify(f)+" with identities "+String.JSONStringify(s)),e=this.getRow(h[0]),e===null||e===undefined)this.error("Record must represent an existing record!"),r.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}"]);else{for(o=this.getRow(null,f,s),y=!1,u=0;u<this._columns.length;u++)if(!DSTable.IsEqualProperties(o[this._columns[u].Property],e[this._columns[u].Property])){this.error("Old ("+String.JSONStringify(o)+") and existing ("+String.JSONStringify(e)+") records must represent the same record ("+this._columns[u].Property+" => old: '"+(o[this._columns[u].Property]===null?"null":o[this._columns[u].Property].toString())+"' - existing: '"+(e[this._columns[u].Property]===null?"null":e[this._columns[u].Property].toString())+"') !");r.addGlobal("ERR_RECORD_DIFFERENT");y=!0;break}y||(o._tick===e._tick||o._tick===null||e._tick===null)&&o._deleted===e._deleted||(this.error("Old ("+String.JSONStringify(o)+") and existing ("+String.JSONStringify(e)+") records must represent the same record (tick or deleted flag)!"),r.addGlobal("ERR_RECORD_DIFFERENT"))}if(r.HasError)return null;for(u in this._columnUnique)this._columnUnique[u].deleteValue(this.getRow(null,f,s));return this._records[h[0]][this._indexDeleted]=!0,{requestId:null,table:this._name,action:"Delete",record:this.getRecordToServer(f),identity:this.getIdentityToServer(s),tick:i}}catch(k){return this.exception("An exception occurs on replaying the delete data into the table '"+this._name+"'",k),r.addGlobal("ERR_EXCEPTION_UNEXPECTED"),null}}constructor(n,t){var i,r,f,u;super("DSTable["+t.Name+"]");this._database=n;this._loaded=!1;this._name=t.Name;this._areaName=t.Area;this._columns=[];this._columnsByName={};this._records=[];this._columnUnique=[];this._hasCopy=null;this._columnForeign=null;this._identities=[];this._identitiesByServerId=[];this._identitiesByClientId=[];this._notYetKnown=[];this._replayClientIds={};this._replayServerIds={};this._lastSequenceId=0;this._indexKey=undefined;this._indexTick=undefined;this._indexDeleted=undefined;this._indexReplayClientId=undefined;this.info("Declaring the table '"+this._name+"' ...");try{for(this.info("Declaring columns ..."),i=0,i=0;i<t.Columns.length;i++)r=new DSColumn(this._name,t.Columns[i]),r.IsKey&&this._indexKey===undefined&&(this._indexKey=i),r.Unique&&(this._columnUnique[i]=r.Unique,this._columnUnique[i].addField(r.Property)),this._columns.push(r),this._columnsByName[r.Property]=i;for(f in this._columnUnique)u=this._columnUnique[f],this.debug("The column '"+u.FieldName+"' has to be a unique value (list of Ids: "+u.FieldNames+")");this._indexKey===undefined&&(i=this._columnsByName.Id,i!==undefined&&(this._indexKey=i));this.debug("IndexKey = "+this._indexKey);this._indexTick=this._columns.length;this.debug("IndexTick = "+this._indexTick);this._indexDeleted=this._columns.length+1;this.debug("IndexDeleted = "+this._indexDeleted);this._indexReplayClientId=this._columns.length+2;this.info(this._columns.length+" columns declared")}catch(e){this.exception("An exception occurs on declaring table '"+this._name+"'",e)}}}class DSDatabase extends LoggerBaseObject{static ReconnectHub(n){return function(){(Hub.Instance.IsRunning&&!n._commitRunning&&n.sendRequests(),Hub.Instance.IsStopped)&&(n.debug("The server is disconnected ... Trying to reconnect it ..."),Hub.Instance.start())}}set Area(n){this._areaName=n.Module;this._areaInstance=n;this._areaModuleId=n.ModuleId}get Area(){return this._areaName}get NextRequestId(){return this._lastRequestId++}get NextEventListenerKey(){return this._lastListenerKey++}get CurrentLanguage(){if(this._selectedLanguage)return this._selectedLanguage;var n=this.CurrentUser;return n&&n.Language?n.Language:this._defaultLanguage}get CurrentUser(){var n={},t;return this._currentUserId===null||this._currentUserId===undefined?null:this._currentUserId===-1?(n.Id=-1,n.Login="",n.Registration="",n.Name="",n.FactoryId=null,n.SectionId=null,n.WorkcentreId=null,n.Profile=UserRecord.PROFILE_ADMINISTRATOR,n.Email="",n.FrequencyNotification=UserRecord.FREQUENCY_NONE,n.FrequencyReportSupervisor=UserRecord.FREQUENCY_NONE,n.FrequencyReportUser=UserRecord.FREQUENCY_NONE,n.CreationDate=new moment,n.EndDate=null,n.Language=this._defaultLanguage,n.Picture=null,n.CustomerId=1,n):(t=this.getClientIdByServerId("User",this._currentUserId),t===null||t===undefined)?null:(this._listUsers===undefined&&(this._listUsers=UserRecord.List?new UserRecord.List:null),n=this._listUsers!==null?this._listUsers.getItem(t,!0):this.getRowById("User",t),n.Profile=this.CurrentModule.Profile,n)}get CurrentModule(){var n=this.getRowById("Module",this.getClientIdByServerId("Module",this._currentModuleId));return n===null&&(n={},n.Id=0,n.Name="No module",n.Module=ModuleRecord.MODULE_NONE,n.Parameters="",n.Profile=UserRecord.PROFILE_NONE,n.Description="",n.Enable=!1),n}get CurrentCustomer(){var n=this.getRowById("Customer",1);return n===null&&(n={},n.Id=0,n.Name="Syncytium Pontchateau",n.Email="",n.Address="",n.Comment=""),n}get Tables(){return this._tables}set SelectedLanguage(n){this._selectedLanguage=n}get Parameters(){return this._parameters}hasSequence(n){return this._sequence[n]===null||this._sequence[n]===undefined?!1:this._sequence[n].length>0}nextSequence(n,t){function i(t,i){return function(r){t.info("New sequence '"+n+"' = "+String.JSONStringify(r));i(r.Error!==null&&r.Error!==undefined?r:r.Result.Value)}}if((this._sequence[n]===null||this._sequence[n]===undefined)&&(this._sequence[n]=[]),this._sequence[n].length>0){t(this._sequence[n].splice(0,1)[0]);return}Hub.Instance.executeService("Sequence",{Key:n},null,i(this,t))}cancelSequence(n,t){t===null||t===undefined||t<=0||((this._sequence[n]===null||this._sequence[n]===undefined)&&(this._sequence[n]=[]),this.info("Cancel sequence '"+n+"' = "+t),this._sequence[n].push(t))}get IsEmpty(){return this._bufferRequest.length===0&&this._bufferRequestSent.length===0}handleExecutionRequest(n,t,i){var r=null,u=this._requestsByRequestId[n],f;i!==null&&i!==undefined?(r=new Errors,r.setJSON(i),f="["+n+"] The request can't have been executed due to some errors ("+r.toString()+")",this.warn(f),this.eventOnNotify("*",-1,u.label,r),this.rollbackRequest(u),this.deleteRequest(n)):this.debug("["+n+"] The request has been correctly executed");this.eventOnCommit(r&&r.HasError?r:null);this.sendRequests()}deleteRequest(n){var t=this._requestsByRequestId[n],i;t!==null&&t!==undefined&&(i=String.JSONStringify(t).length,this.debug("Remove the request ("+n+") from the memory ("+i+" octets)"),delete this._requestsByRequestId[n],this._currentSize-=i,this._areaInstance&&this._areaInstance.progressMemory&&this._areaInstance.progressMemory(this._currentSize,this._maxSize))}rollbackRequest(n){var t,i;if(n.transaction!==null&&n.transaction!==undefined){for(this.info("Rollbacking the transaction ("+n.requestId+") ..."),t=n.transaction.length-1;t>=0;t--)try{this.rollbackRequest(n.transaction[t])}catch(r){this.exception("Unable to rollback the request",r);this.warn("ignore this exception and continue")}return}if(n.requestId===undefined?this.info("Rollbacking the request serverId:"+String.JSONStringify(n.record)+" clientId:"+String.JSONStringify(n.identity)+" into the table '"+n.table+"' if and only if the tick is '"+n.tick+"' ..."):this.info("Rollbacking the request ("+n.requestId+") serverId:"+String.JSONStringify(n.record)+" clientId:"+String.JSONStringify(n.identity)+" into the table '"+n.table+"' if and only if the tick is '"+n.tick+"' ..."),i=this._tables[n.table],i===null||i===undefined){this.error("The table '"+n.table+"' doesn't exist!");return}i.rollback(n.action,n.record,n.identity,n.tick)}sendRequests(){function t(n,t){return function(i){t.fnDone!==null&&t.fnDone!==undefined&&t.fnDone(i.Record,i.Error);n.handleExecutionRequest(i.RequestId,i.Record,i.Error)}}if(this._bufferRequestSent.length===0){this.debug("No requests to send");this.eventOnStopCommit();return}this.info("Sending all requests in waiting ...");var n=this._bufferRequestSent[0][0];n!==undefined&&n!==null&&(this._requestsByRequestId[n.requestId]=n);this._bufferRequestSent[0].splice(0,1);this._bufferRequestSent[0].length===0&&this._bufferRequestSent.splice(0,1);n!==undefined&&n!==null&&(n.transaction!==null&&n.transaction!==undefined?(Hub.Instance.executeTransaction(n.requestId,n.label,n.transaction,t(this,n)),this.IsDebug&&this.debug("Transaction "+String.JSONStringify(n)+" sent")):(Hub.Instance.executeRequest(n.requestId,n.label,n.table,n.action,n.record,n.identity,t(this,n)),this.IsDebug&&this.debug("Request "+String.JSONStringify(n)+" sent")))}beginTransaction(n){this._bufferTransactionCount===0&&(this._bufferTransactionLabel=Helper.Label(n),this._bufferTransaction=[]);this._bufferTransactionCount++;this.debug("Begin transaction ["+this._bufferTransactionCount.toString()+"]")}endTransaction(n){if(this._bufferTransactionCount<0){this._bufferTransactionCount=0;return}if(this.debug("End transaction ["+this._bufferTransactionCount.toString()+"]"),this._bufferTransactionCount--,!(this._bufferTransactionCount>0)){if(this._bufferTransaction.length>0){var t={requestId:this.NextRequestId,label:this._bufferTransactionLabel,transaction:this._bufferTransaction,fnDone:n};this._bufferRequest.push(t);this.info("The transaction "+String.JSONStringify(t)+" is buffering ...")}this._bufferTransaction=null;this._bufferTransactionLabel=null}}send(n,t,i,r,u,f){var e={table:n,action:t,record:i,identity:r,tick:u},o;return(this._bufferTransaction!==null?this._bufferTransaction.push(e):(e.label=Helper.Label(n.toUpperCase()+"_"+t.toUpperCase()+"D_TOAST",t),e.requestId=this.NextRequestId,e.fnDone=f,this._bufferRequest.push(e)),o=String.JSONStringify(e).length,this._currentSize+=o,this._currentSize>this._maxSize)?(this.error("The request "+String.JSONStringify(e)+" can't be buffered into a transaction because the size '"+this._currentSize+" octets' exceeds '"+this._maxSize+" octets' ..."),this.rollbackRequest(e),!1):(this._bufferTransaction!==null?this.info("The request "+String.JSONStringify(e)+" is buffering into a transaction (size: "+o+" octets) ..."):this.info("The request "+String.JSONStringify(e)+" is buffering (size: "+o+" octets) ..."),this._areaInstance&&this._areaInstance.progressMemory&&this._areaInstance.progressMemory(this._currentSize,this._maxSize),!0)}commit(){var t,n;if(this._bufferRequest.length===0){this.debug("No commit because the buffer is empty");return}if(this.info("Committing ..."),this._bufferRequestSent.push(this._bufferRequest),this._bufferRequest=[],this._status!=="Running"){this.info("The database is not ready ... Wait the availability of the database before sending requests to the server ...");return}if(!Hub.Instance.IsRunning){this.info("The server is disconnected ... Wait the end of resynchronizing with the server before sending requests to the server ...");return}if(this._hubDatabase!==null){this.info("The synchronization process is running ... Wait the end of resynchronizing with the server before sending requests to the server ...");return}if(!this._commitRunning){for(t=0,n=0;n<this._bufferRequestSent.length;n++)t+=this._bufferRequestSent[n].length;this.eventOnStartCommit(t);this.sendRequests()}}rollback(){var t,n;if(this._bufferRequest.length===0){this.debug("No rollback because the buffer is empty");return}for(this.info("Rollbacking ..."),t=this._bufferRequest.length,n=this._bufferRequest.length-1;n>=0;n--){var i=this._bufferRequest[n],r=String.JSONStringify(i),u=r.length;this.debug("Rollback the request "+r+" ("+u+" octets)");this.rollbackRequest(i);this._currentSize-=u}this._lastRequestId-=t;this._bufferRequest=[];this._areaInstance&&this._areaInstance.progressMemory&&this._areaInstance.progressMemory(this._currentSize,this._maxSize);this.info(t+" requests have been rollbacked")}onStatusChanged(n,t){function i(n){return function(t){n.setSchema(t)}}function r(n,t){return function(){n.error("Connexion error on initializing protocol");n.updateStatus("Error",new Errors("ERR_CONNECTION"),t)}}n==="Started"&&this._status==="NotInitialized"?(this.info("The connection is done with the server ... retrieving the database schema ..."),this.updateStatus("Initializing"),Hub.Instance.initialize(this._areaName,this._areaModuleId,i(this),r(this))):n==="Started"&&this._status==="ReadyToSynchronize"?this.synchronize():n==="ReadyToSynchronize"?(this.info("The server and the client were disconnected a while ... You can launch the synchronization process as you want ..."),this.updateStatus("ReadyToSynchronize")):n==="Error"&&(this.error("Connexion error on initializing protocol"),this.updateStatus("Error",t))}acknowledgeRequest(n,t,i,r,u,f){if(this._status!=="ReadyToSynchronize"&&this._status!=="Running"){this.info("The acknowledge of the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+") is buffering because the database is not yet ready");this._bufferNotifications.push({requestId:n,area:t,table:i,action:r,record:u,identity:f});return}this.info("Acknowledging of the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+")");this.updateFromServer(i,u,r==="Update"?f.New:f);this.deleteRequest(n)}acknowledgeTransaction(n,t,i){var u,r;if(this._status!=="ReadyToSynchronize"&&this._status!=="Running"){this.info("The acknowledge of the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+") is buffering because the database is not yet ready");this._bufferNotifications.push({requestId:n,area:t,transaction:i});return}this.info("Acknowledging of the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+")");for(u in i)(r=i[u],r!==null&&r!==undefined)&&(this.info("Acknowledging of the request for ('"+t+"', '"+r.table+"', '"+r.action+"', "+String.JSONStringify(r.record)+", "+String.JSONStringify(r.identity)+")"),this.updateFromServer(r.table,r.record,r.action==="Update"?r.identity.New:r.identity));this.deleteRequest(n)}beginNotification(n,t){this._status==="Running"&&(this.info("Begin of notification ("+n+", "+String.JSONStringify(t)+")"),this.eventOnBeginNotification(n,t))}notify(n,t,i,r,u){if(this._status!=="Running"){this.info("The notification of the update from the user '"+n+"' for ('"+i+"', '"+r+"', "+String.JSONStringify(u)+" is buffering because the database is not yet ready");this._bufferNotifications.push({userId:n,area:i,table:r,record:u});return}this.info("Notifying an update from the user '"+n+"' for ('"+i+"', '"+r+"', "+String.JSONStringify(u));this.eventOnNotify(r,u._tick,t);this.updateFromServer(r,u)}endNotification(n,t){this._status==="Running"&&(this.info("End of notification ("+n+", "+String.JSONStringify(t)+")"),this.eventOnEndNotification(n,t))}updateStatus(n,t,i){if(this._status!=="Error"){this.info("The status becomes '"+n+"'");var r=this._status;if(this._status=n,this._statusErrors=t,this._areaInstance&&this._areaInstance.onStatusChanged)this._areaInstance.onStatusChanged(r,this._status,this._statusErrors);if(this._hubMaster!==null&&this._status==="Error"){if(this.warn("The synchronization process has failed!"),this._hubMaster._areaInstance&&this._hubMaster._areaInstance.onStopProgress&&this._hubMaster._areaInstance.onStopProgress(),i===undefined&&(i=!1),Hub.Instance.IsRunning){if(this.warn("The server is up ..."),!i){this.error("Unable to resolv the issue on launching again a new synchronization ... Reload the page!");this._hubMaster.updateStatus(this._status,this._statusErrors);return}this.warn("On launching again a new synchronization, you can resolv the issue ... Try it again!");Hub.Instance.updateStatus("ReadyToSynchronize")}else this.warn("The server is down ... The synchronization is not complete! Try it again!");this._hubMaster._hubDatabase=null;this._hubMaster._hubHandle=window.setInterval(DSDatabase.ReconnectHub(this._hubMaster),this._hubMaster._hubInterval*1e3)}}}updateServerId(n,t,i){this.info("Updating all tables having a foreign key ('"+n+"', ["+t+"]) by this new server Id ["+i+"] ...");for(var r in this._tables)this._tables[r].updateServerId(n,t,i)}updateClientId(n,t,i){this.info("Updating all tables having a foreign key ('"+n+"', ["+t+"]) by this client Id ["+i+"] ...");for(var r in this._tables)this._tables[r].updateClientId(n,t,i)}setSchema(n){function e(n,t){return function(){n.error("Connexion error on loading data");n.updateStatus("Error",new Errors("ERR_CONNECTION"),t)}}function o(n,t){return function(i){n.setTable(i);t.splice(0,1);t.length>0&&Hub.Instance.loadTable(t[0],o(n,t),e(n,n._hubMaster!==null))}}var r=null,u,f,t,i;if(this.info("Schema received: "+String.JSONStringify(n)),n.Error){r=new Errors;r.setJSON(n.Error);this.error("The schema can't be loaded due to "+r.toString());this.updateStatus("Error",r);return}if(!n.Schema){this.error("The schema is missing");r=new Errors("ERR_SCHEMA");this.updateStatus("Error",r);return}if(this._version=n.Version,this.info("Database version = "+this._version),this._hubMaster!==null&&this._hubMaster._version!==this._version){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}this._parameters=n.Parameters;this.info("Database parameters = "+String.JSONStringify(this._parameters));this._parameters["Hub.MaxSize"]!==null&&this._parameters["Hub.MaxSize"]!==undefined&&(u=parseInt(this._parameters["Hub.MaxSize"]),!isNaN(u)&&u>0&&(this._maxSize=u*1024));this.info("Max size in the queue = "+this._maxSize+" octets");this._parameters["Hub.Interval"]!==null&&this._parameters["Hub.Interval"]!==undefined&&(f=parseInt(this._parameters["Hub.Interval"]),!isNaN(f)&&f>0&&(this._hubInterval=f));this.info("Interval between 2 checks of reconnection = "+this._hubInterval+" secondes");this._parameters["PDF.Font"]!==null&&this._parameters["PDF.Font"]!==undefined&&(PDF.FONT_NAME=this._parameters["PDF.Font"].toLowerCase());this.info("PDF Font = '"+PDF.FONT_NAME+"'");this._defaultLanguage=n.DefaultLanguage;this.info("Default language = "+this._defaultLanguage);this._currentUserId=n.CurrentUserId;this.info("Current user id = "+this._currentUserId);this._currentModuleId=n.CurrentModuleId;this.info("Current module id = "+this._currentModuleId);this._lastRequestId=n.LastRequestId;this.info("The last request Id treated by the server is "+this._lastRequestId);t=null;i=[];for(t in n.Schema)this._tables[t]=new DSTable(this,n.Schema[t]),i.push(t);for(t in n.Schema)this._tables[t].updateForeignKeys();this.updateStatus("Loading");this._areaInstance&&(this._areaInstance.progressStatus&&this._areaInstance.progressStatus(0,i.length),this._areaInstance.progressMemory&&this._areaInstance.progressMemory(0,this._maxSize));this._hubMaster!==null&&this._hubMaster._areaInstance!==null&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus(0,2*i.length+4);i.length>0&&Hub.Instance.loadTable(i[0],o(this,i),e(this,this._hubMaster!==null))}setTable(n){var i=null,r,f,t,u;if(this.info("Data received: "+String.JSONStringify(n)),n.Error){i=new Errors;i.setJSON(n.Error);this.error("The records can't be loaded due to "+i.toString());this.updateStatus("Error",i);return}if(!n.Records||!n.Table){this.error("The records are missing");i=new Errors("ERR_CONNECTION");this.updateStatus("Error",i);return}if(!this._tables[n.Table].setTable(n.Records,n.LastSequenceId)){this.error("The table is not correctly loaded!");i=new Errors("ERR_CONNECTION");this.updateStatus("Error",i);return}r=null;f=!1;for(r in this._tables)if(!this._tables[r].Loaded){f=!0;break}if(this._areaInstance&&this._areaInstance.progressStatus&&this._areaInstance.progressStatus(),this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus(),!f){for(r in this._tables)this._tables[r].updateUniqueValues();if(this.updateStatus("Loaded"),t=null,u=null,this._hubMaster===null){if(this._bufferNotifications.length>0){for(this.info("Executing all acknowledges and notifications buffered during the initialization process ..."),u=0;u<this._bufferNotifications.length;u++)(t=this._bufferNotifications[u],t!==null&&t!==undefined)&&(t.requestId!==null&&t.requestId!==undefined?(this.info("Acknowledging of the request buffered '"+t.requestId+"' for ('"+t.area+"', '"+t.table+"', '"+t.action+"', "+String.JSONStringify(t.record)+", "+String.JSONStringify(t.identity)),this.updateFromServer(t.table,t.record,t.action==="Update"?t.identity.New:t.identity)):t.userId!==null&&t.userId!==undefined&&(this.info("Notifying an update buffered from the user '"+t.userId+"' for ('"+t.area+"', '"+t.table+"', "+String.JSONStringify(t.record)),this.updateFromServer(t.table,t.record)));this._bufferNotifications=[]}}else this.finalizeSynchronization();if(this.updateStatus("Running"),this._hubMaster!==null&&(this._hubMaster.updateStatus("Running"),this._hubMaster.sendRequests()),this._areaInstance&&this._areaInstance.onStopProgress)this._areaInstance.onStopProgress(!0);this._hubMaster!==null&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.onStopProgress&&this._hubMaster._areaInstance.onStopProgress();this._hubMaster!==null?(this._hubMaster._hubHandle!==null&&(window.clearInterval(this._hubMaster._hubHandle),this._hubMaster._hubHandle=null),this._hubMaster._hubHandle=window.setInterval(DSDatabase.ReconnectHub(this._hubMaster),this._hubInterval*1e3)):(this._hubHandle!==null&&(window.clearInterval(this._hubHandle),this._hubHandle=null),this._hubHandle=window.setInterval(DSDatabase.ReconnectHub(this),this._hubInterval*1e3))}}getTable(n){try{return this._tables[n].getTable()}catch(t){return this.exception("An exception occurs on reading data from the table '"+n+"'",t),[]}}each(n,t){try{return this._tables[n].each(t),!0}catch(i){return!1}}getNewRow(n){var i=this._tables[n],t;return i===null||i===undefined?null:(t=i.NewRow,t.CustomerId!==undefined&&(t.CustomerId=this.CurrentCustomer.Id),t)}getRowById(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getRowById(t)}getClientIdByServerId(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getClientIdByServerId(t)}getServerIdByClientId(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getServerIdByClientId(t)}getSequence(n){var t=this._tables[n];return t===null||t===undefined?null:t.Sequence}getColumn(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getColumn(t)}getColumnLabel(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getColumnLabel(t)}getEnumerable(n,t,i){var r=this._tables[n];return r===null||r===undefined?i===undefined?[]:i:r.getEnumerable(t,i)}getDatetimeFormat(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getDatetimeFormat(t)}getDefaultValue(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.getDefaultValue(t)}getHistoryValue(n,t,i){var r=this._tables[n];return r===null||r===undefined?null:r.getHistoryValue(t,i)}getLastHistoryId(n,t){var i=this._tables["History"+n];return i===null||i===undefined?null:i.getLastHistoryId(t)}updateHistoryProperties(n,t){var i=this._tables[n];return i===null||i===undefined?null:i.updateHistoryProperties(t)}convertValue(n,t,i,r){r===undefined&&(r=!0);var u=this._tables[n];return u===null||u===undefined?i:u.convertValue(t,i,r)}checkProperties(n,t,i){var r=this._tables[n];return r===null||r===undefined?t:r.checkProperties(t,i)}start(){this._status==="NotInitialized"&&(this._areaInstance&&this._areaInstance.onStartProgress&&this._areaInstance.onStartProgress(),this._areaInstance&&this._areaInstance.progressStatus&&this._areaInstance.progressStatus(0,1),this.info("Connecting to the server ..."),Hub.Instance.addListener(this.Module,this),Hub.Instance.start())}addFromClient(n,t,i){this.info("Adding the record "+String.JSONStringify(t)+" from the client into the table '"+n+"' ...");var r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),i.addGlobal("ERR_REQUEST_UNKNOWN"),null):r.addFromClient(t,i)}updateFromClient(n,t,i,r){this.info("Updating the record "+String.JSONStringify(t)+" to "+String.JSONStringify(i)+" from the client into the table '"+n+"' ...");var u=this._tables[n];return u===null||u===undefined?(this.error("The table '"+n+"' doesn't exist!"),r.addGlobal("ERR_REQUEST_UNKNOWN"),null):u.updateFromClient(t,i,r)}updateFromServer(n,t,i){this.info("Updating the record "+String.JSONStringify(t)+" from the server into the table '"+n+"' ...");var r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),null):r.updateFromServer(t,i)}deleteRowById(n,t){this.info("Deleting the row "+t.toString()+" from the client into the table '"+n+"' ...");var i=this._tables[n];return i===null||i===undefined?(this.error("The table '"+n+"' doesn't exist!"),null):i.deleteRowById(t)}deleteFromClient(n,t,i){this.info("Deleting the record "+String.JSONStringify(t)+" from the client into the table '"+n+"' ...");var r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),i.addGlobal("ERR_REQUEST_UNKNOWN"),null):r.deleteFromClient(t,i)}selectRecordsFromClient(n,t,i,r){function f(n,t,i,r){return function(u){u[i]===r&&n.push({table:t,field:i,record:u})}}var u=r===null||r===undefined?[]:r;return this.each(n,f(u,n,t,i)),u}deleteRecordsFromClient(n,t){var r,i;if(!t.HasError&&n!==null&&n!==undefined)for(r=0;r<n.length&&!t.HasError;r++){if(i=n[r],i===null||i===undefined)return;this.deleteFromClient(i.table,i.record,t)}}executeRequest(n,t,i,r,u){this.info("Executing the request '"+t+"' with the record "+String.JSONStringify(i)+" from the client into the table '"+n+"' ...");var f=this._tables[n];return f===null||f===undefined?(this.error("The table '"+n+"' doesn't exist!"),r.addGlobal("ERR_REQUEST_UNKNOWN"),null):((i.CustomerId===undefined||i.CustomerId===null)&&(i.CustomerId=this.CurrentCustomer.Id),f.executeRequest(t,i,r,u))}addEventListener(n,t,i,r){var u=this.NextEventListenerKey;return(n===null||n===undefined)&&(n="*"),(t===null||t===undefined)&&(t="*"),(i===null||i===undefined)&&(i="*"),this.info("Create a new listener ["+u+"] on ('"+n+"', '"+t+"', '"+i+"')"),this._listeners[u]={table:t,id:i,event:n,key:u},(this._eventListeners[n]===null||this._eventListeners[n]===undefined)&&(this._eventListeners[n]={}),(this._eventListeners[n][t]===null||this._eventListeners[n][t]===undefined)&&(this._eventListeners[n][t]={}),(this._eventListeners[n][t][i]===null||this._eventListeners[n][t][i]===undefined)&&(this._eventListeners[n][t][i]={}),(this._eventListeners[n][t][i][u]===null||this._eventListeners[n][t][i][u]===undefined)&&(this._eventListeners[n][t][i][u]=r),u}removeEventListener(n){var t=this._listeners[n];t!==null&&t!==undefined&&(this.info("Remove the listener ["+n+"] on ('"+t.event+"', '"+t.table+"', '"+t.id+"')"),this._eventListeners[t.event]!==null&&this._eventListeners[t.event]!==undefined&&(this._eventListeners[t.event][t.table]!==null&&this._eventListeners[t.event][t.table]!==undefined&&(this._eventListeners[t.event][t.table][t.id]!==null&&this._eventListeners[t.event][t.table][t.id]!==undefined&&(this._eventListeners[t.event][t.table][t.id][n]!==null&&this._eventListeners[t.event][t.table][t.id][n]!==undefined&&delete this._eventListeners[t.event][t.table][t.id][n],$.isEmptyObject(this._eventListeners[t.event][t.table][t.id])&&delete this._eventListeners[t.event][t.table][t.id]),$.isEmptyObject(this._eventListeners[t.event][t.table])&&delete this._eventListeners[t.event][t.table]),$.isEmptyObject(this._eventListeners[t.event])&&delete this._eventListeners[t.event]),delete this._listeners[n])}getEvents(n,t,i){var e=[],r,u,f,o,s,h;for(r in this._eventListeners)if(r==="*"||r===n)for(u in this._eventListeners[r])if(u==="*"||u===t)for(f in this._eventListeners[r][u])if(f==="*"||f===i.toString())for(o in this._eventListeners[r][u][f])e.push({key:parseInt(o),fn:this._eventListeners[r][u][f][o]});e.sort(function(n,t){return n.key<t.key?-1:n.key>t.key?1:0});s=[];for(h in e)s.push(e[h].fn);return s}eventOnBeginNotification(n,t){var i=this.getEvents("onBeginNotification","*","*"),r;if(i.length!==0)for(r in i)try{i[r]("onBeginNotification","*",n,t)}catch(u){this.exception("Exception on raising the event 'onBeginNotification'",u)}}eventOnNotify(n,t,i,r){var u=this.getEvents("onNotify",n,"*"),f;if(u.length!==0)for(f in u)try{u[f]("onNotify",n,t,i,r)}catch(e){this.exception("Exception on raising the event 'onNotify'",e)}}eventOnEndNotification(n,t){var i=this.getEvents("onEndNotification","*","*"),r;if(i.length!==0)for(r in i)try{i[r]("onEndNotification","*",n,t)}catch(u){this.exception("Exception on raising the event 'onEndNotification'",u)}}eventOnCreate(n,t){var i=this.getEvents("onCreate",n,t),r,u;if(i.length!==0){r=this.getRowById(n,t);for(u in i)try{i[u]("onCreate",n,t,r)}catch(f){this.exception("Exception on raising the event 'onCreate'",f)}}}eventOnUpdate(n,t,i){var r=this.getEvents("onUpdate",n,t),u,f;if(r.length!==0){u=this.getRowById(n,t);for(f in r)try{r[f]("onUpdate",n,t,i,u)}catch(e){this.exception("Exception on raising the event 'onUpdate'",e)}}}eventOnDelete(n,t){var i=this.getEvents("onDelete",n,t),r,u;if(i.length!==0){r=this.getRowById(n,t);for(u in i)try{i[u]("onDelete",n,t,r)}catch(f){this.exception("Exception on raising the event 'onDelete'",f)}}}eventOnLoad(n){var t=this.getEvents("onLoad",n,"*"),i;if(t.length!==0)for(i in t)try{t[i]("onLoad",n)}catch(r){this.exception("Exception on raising the event 'onLoad'",r)}}eventOnStartCommit(n){var t,i;if(this._commitRunning=!0,t=this.getEvents("onStartCommit","*","*"),t.length!==0)for(i in t)try{t[i]("onStartCommit",n)}catch(r){this.exception("Exception on raising the event 'onStartCommit'",r)}}eventOnCommit(n){var t,i;if(this._commitRunning&&(t=this.getEvents("onCommit","*","*"),t.length!==0))for(i in t)try{t[i]("onCommit",n)}catch(r){this.exception("Exception on raising the event 'onCommit'",r)}}eventOnStopCommit(){var n,t;if(this._commitRunning&&(this._commitRunning=!1,n=this.getEvents("onStopCommit","*","*"),n.length!==0))for(t in n)try{n[t]("onStopCommit")}catch(i){this.exception("Exception on raising the event 'onStopCommit'",i)}}synchronize(){function n(n){return function(t){n.setSchema(t)}}function t(n,t){return function(){n.error("Connexion error on synchronizing protocol");n.updateStatus("Error",new Errors("ERR_CONNECTION"),t)}}this.info("Starting the synchronization process ...");this._hubHandle!==null&&(window.clearInterval(this._hubHandle),this._hubHandle=null);this._areaInstance&&this._areaInstance.onStartProgress&&this._areaInstance.onStartProgress();this._areaInstance&&this._areaInstance.progressStatus&&this._areaInstance.progressStatus(0,1,"MSG_SYNCHRONIZING");this._hubDatabase=new DSDatabase("DSSynchronization",this);this._hubDatabase._areaName=this._areaName;this._hubDatabase._areaModuleId=this._areaModuleId;Hub.Instance.initialize(this._hubDatabase._areaName,this._hubDatabase._areaModuleId,n(this._hubDatabase),t(this._hubDatabase,!0))}replayRequest(n){var i={},u=null,r=null,e,f,t,o;if(n===null||n===undefined)return null;if(u=new Errors,n.transaction!==null&&n.transaction!==undefined){for(e=[],f=0;f<n.transaction.length;f++)if(t=n.transaction[f],t!==null&&t!==undefined){if(r=null,t.table!==null&&t.table!==undefined&&(r=this._tables[t.table]),r===null||r===undefined){this.warn("Unable to replay the request "+String.JSONStringify(t)+" because the table doesn't exist");continue}i=null;switch(t.action){case"Create":i=r.replayCreate(t.record,t.identity,t.tick,u);break;case"Update":i=r.replayUpdate(t.record.Old,t.identity.Old,t.record.New,t.identity.New,t.tick,u);break;case"Delete":i=r.replayDelete(t.record,t.identity,t.tick,u);break;default:i={table:t.table,action:t.action,record:t.record,identity:t.identity,tick:t.tick}}if(i===null||u.HasError){for(this.warn("Unable to replay the request "+String.JSONStringify(t)+" due to "+u.toString()),f=e.length-1;f>=0;f--)this.rollbackRequest(e[f]);return null}e.push(i)}i={requestId:null,label:n.label,transaction:e,fnDone:n.fnDone}}else{if(n.table!==null&&n.table!==undefined&&(r=this._tables[n.table]),r===null||r===undefined)return this.warn("Unable to replay the request "+String.JSONStringify(n)+" because the table doesn't exist"),null;switch(n.action){case"Create":i=r.replayCreate(n.record,n.identity,n.tick,u);break;case"Update":i=r.replayUpdate(n.record.Old,n.identity.Old,n.record.New,n.identity.New,n.tick,u);break;case"Delete":i=r.replayDelete(n.record,n.identity,n.tick,u);break;default:i={requestId:null,table:n.table,action:n.action,record:n.record,identity:n.identity,tick:n.tick,fnDone:n.fnDone}}i!==null&&i!==undefined&&(i.label=n.label)}return i===null||u.HasError?(this.warn("Unable to replay the request "+String.JSONStringify(n)+" due to "+u.toString()),null):(i.requestId=this.NextRequestId,o=String.JSONStringify(i).length,this._currentSize+=o,this.info("The request "+String.JSONStringify(i)+" has been replayed (size: "+o+" octets) ..."),i)}replayRequests(n){var u,e;this.info("Replaying requests ...");this._requestsByRequestId={};this._bufferRequestSent=[];this._bufferRequest=[];this._bufferNotifications=[];u=[];for(e in n._requestsByRequestId)u.push(e);u.sort(function(n,t){return n<t?-1:n>t?1:0});for(var f=[],t=0,r=0,i=null,t=0;t<u.length;t++){if(u[t]<=this._lastRequestId){this.info("Ignore the request ["+u[t]+"] because already treated by the server");continue}i=this.replayRequest(n._requestsByRequestId[u[t]]);i!==null&&i!==undefined&&f.push(i)}for(t=0;t<n._bufferRequestSent.length;t++)for(r=0;r<n._bufferRequestSent[t].length;r++)i=this.replayRequest(n._bufferRequestSent[t][r]),i!==null&&i!==undefined&&f.push(i);for(this._bufferRequestSent.push(f),this.info(f.length+" requests to send to the server"),t=0;t<n._bufferRequest.length;t++)i=this.replayRequest(n._bufferRequest[t]),i!==null&&i!==undefined&&this._bufferRequest.push(i);for(this.info(this._bufferRequest.length+" requests in waiting to send to the server"),t=0;t<n._bufferNotifications.length;t++)if(n._bufferNotifications[t].transaction===undefined||n._bufferNotifications[t].transaction===null){for(i=[],r=0;r<n._bufferNotifications[t].transaction.length;r++)if(n._bufferNotifications[t][r].identity===undefined||n._bufferNotifications[t][r].identity===null){i.push(n._bufferNotifications[t][r]);continue}i.lenth>0&&this._bufferNotifications.push(i)}else if(n._bufferNotifications[t].identity===undefined||n._bufferNotifications[t].identity===null){this._bufferNotifications.push(n._bufferNotifications[t]);continue}this.info(this._bufferNotifications.length+" notifications waiting the end of initialization")}finalizeSynchronization(){var n=null;this.info("The schema and tables are loaded ... Synchronizing database manager ...");for(n in this._tables)if(this._hubMaster._tables[n]===null||this._hubMaster._tables[n]===undefined){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}for(n in this._hubMaster._tables)if(this._tables[n]===null||this._tables[n]===undefined){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}for(n in this._tables)if(!this._tables[n].hasSameStructure(this._hubMaster._tables[n])){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}this.info("The database schema is compatible with the database synchronized");this.info("Now, replaying all requests into the database manager into the new database ...");this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus();this.replayRequests(this._hubMaster);this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus();for(n in this._tables)this._hubMaster._tables[n]=this._tables[n],this._hubMaster._tables[n].setDatabase(this._hubMaster),this._hubMaster._tables[n].updateForeignKeys(!0);if(this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus(),this._hubMaster._requestsByRequestId=this._requestsByRequestId,this._hubMaster._bufferRequestSent=this._bufferRequestSent,this._hubMaster._bufferRequest=this._bufferRequest,this._hubMaster._bufferNotifications=this._bufferNotifications,this._hubMaster._version=this._version,this._hubMaster._currentSize=this._currentSize,this._hubMaster._maxSize=this._maxSize,this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressMemory&&this._hubMaster._areaInstance.progressMemory(this._hubMaster._currentSize,this._hubMaster._maxSize),this._hubMaster._parameters=this._parameters,this._hubMaster._defaultLanguage=this._defaultLanguage,this._hubMaster._currentUserId=this._currentUserId,this._hubMaster._hubInterval=this._hubInterval,this._hubMaster._hubDatabase=null,this._hubMaster._bufferNotifications.length>0){this._hubMaster.info("Executing all acknowledges and notifications buffered during the synchronization process ...");for(let n=0;n<this._hubMaster._bufferNotifications.length;n++){let t=this._hubMaster._bufferNotifications[n];t!==null&&t!==undefined&&(t.requestId!==null&&t.requestId!==undefined?(this._hubMaster.info("Acknowledging of the request buffered '"+t.requestId+"' for ('"+t.area+"', '"+t.table+"', '"+t.action+"', "+String.JSONStringify(t.record)+", "+String.JSONStringify(t.identity)),this._hubMaster.updateFromServer(t.table,t.record,t.action==="Update"?t.identity.New:t.identity)):t.userId!==null&&t.userId!==undefined&&(this._hubMaster.info("Notifying an update buffered from the user '"+t.userId+"' for ('"+t.area+"', '"+t.table+"', "+String.JSONStringify(t.record)),this._hubMaster.updateFromServer(t.table,t.record)))}this._hubMaster._bufferNotifications=[]}for(n in this._hubMaster._tables)this._hubMaster.eventOnLoad(n),this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus()}constructor(n,t){super(n===undefined?"DSDatabase":n);this._areaName=null;this._areaInstance=null;this._areaModuleId=-1;this._status="NotInitialized";this._statusErrors=null;this._version=0;this._tables={};this._parameters=null;this._defaultLanguage="FR";this._currentUserId=-1;this._currentModuleId=-1;this._selectedLanguage=null;this._listUsers=undefined;this._lastRequestId=0;this._maxSize=1048576;this._currentSize=0;this._bufferRequest=[];this._bufferRequestSent=[];this._requestsByRequestId={};this._bufferNotifications=[];this._sequence={};this._lastListenerKey=0;this._listeners={};this._eventListeners={};this._commitRunning=!1;this._bufferTransactionLabel=null;this._bufferTransaction=null;this._bufferTransactionCount=0;this._hubMaster=t===undefined?null:t;this._hubHandle=null;this._hubInterval=30;this._hubDatabase=null}static get Instance(){return this._instance||(this._instance=new DSDatabase),this._instance}}GUI={};GUI.GUI=(class extends LoggerBaseObject{get Name(){return this._name}get CSSClass(){return this._cssClass}get Box(){return this._box}get Component(){return this._component}get Visible(){return this._visible?this._box instanceof GUI.Box.Box?this._box.Visible:!0:!1}set Visible(n){(this._visible=n===!0||n===null||n===undefined,this.Visible?this.debug("Visible = true"):this.debug("Visible = false"),this._component!==null)&&(this.Visible?this._component.show():this._component.hide())}get Readonly(){return this._readonly?!0:this._box instanceof GUI.Box.Box?this._box.Readonly:!1}set Readonly(n){(this._readonly=n===!0||n===null||n===undefined,this.Readonly?this.debug("Readonly = true"):this.debug("Readonly = false"),this._component!==null)&&(this.Readonly?this._component.addClass("readonly"):this._component.removeClass("readonly"))}get IsOpened(){return this._isOpened}set TabIndex(n){this._tabIndex=n;this.Component!==null&&this.Component.attr("tabindex",this._tabIndex)}get TabIndex(){return this._tabIndex}destructor(){this.clearListeners();this._events={}}on(n,t){this.debug("Declare event("+n+")");this._events[n]=t}raise(n){this.IsOpened&&this._events[n]&&this._events[n]()}isEvent(n){return this._events[n]?!0:!1}getEvent(n){return this._events[n]?this._events[n]:null}off(n){this.debug("Remove event("+n+")");this._events[n]=null}clearListeners(){for(var n in this._listeners)DSDatabase.Instance.removeEventListener(this._listeners[n]);this._listeners=[]}addListener(n){this._listeners.push(n)}refresh(){(this.verbose("Refresh"),this._component!==null)&&(this.Visible?this._component.show():this._component.hide(),this.Readonly?this._component.addClass("readonly"):this._component.removeClass("readonly"))}onOpen(){this.verbose("onOpen");this._isOpened=!0}onClose(){this.clearListeners();this._isOpened=!1;this.verbose("onClose")}draw(n){if(n===null||n===undefined){this._component=this._container;return}this._component=$(n);this._container.append(this._component[0]);String.isEmptyOrWhiteSpaces(this._type)||this._component.addClass(this._type);String.isEmptyOrWhiteSpaces(this._cssClass)||this._component.addClass(this._cssClass);this._component.find("*").attr("tabindex",null);this._tabIndex!==null&&this._component.attr("tabindex",this._tabIndex)}focus(){return(this.verbose("focus"),this.Component===null||this._tabIndex===null||!this.Visible||this.Readonly)?!1:(this.Component.focus(),!0)}nextFocus(){this.Box instanceof GUI.Box.Box&&this.Box.nextFocus()}previousFocus(){this.Box instanceof GUI.Box.Box&&this.Box.previousFocus()}onMouseClick(){}onButtonOK(){if(this.verbose("onButtonOK"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_OK);(n!==null&&n.Visible||(n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE)),n!==null&&n.Visible)&&n.onMouseClick()}}onButtonClose(){if(this.verbose("onButtonClose"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE);n!==null&&n.Visible&&n.onMouseClick()}}onButtonCancel(){if(this.verbose("onButtonCancel"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_CANCEL);(n!==null&&n.Visible||(n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE)),n!==null&&n.Visible)&&n.onMouseClick()}}constructor(n,t,i,r){if(n==="area")super(i);else if(typeof t=="string"){let r=t.trim().split(">"),u=r[r.length-1];r=u.trim().split(" ");u=r[r.length-1];super(n+"["+u+"."+i+"]")}else t instanceof GUI.Box.Box?super(n+"["+t.Name+"."+i+"]"):super(n+"["+i+"]");this._name=i;this._cssClass=r?r:null;this._box=null;this._type=n;typeof t=="string"?this._container=$(t):t instanceof GUI.Box.Box?(this._container=t.CurrentPanel,this._box=t):this._container=t?t:null;this._component=null;this._visible=!0;this._readonly=!1;this._isOpened=!1;this._tabIndex=null;this._events={};this._listeners=[];this._throttle=null;this.debug("Create the GUI component '"+i+"' ("+this._type+")")}});GUI.Board={};GUI.Board.BOARD_ICON=1;GUI.Board.BOARD_ADD=2;GUI.Board.BOARD_CANCEL=4;GUI.Board.BOARD_DELETE=8;GUI.Board.BOARD_HELP=16;GUI.Board.BOARD_NONE=0;GUI.Board.BOARD_ALL=255;GUI.Board.ExportCSVFile=null;GUI.Board.Board=(class extends GUI.GUI{set Readonly(n){(super.Readonly=n,this.Component!==null)&&(this.Readonly?this.Component.find("> .title > .div").addClass("readonly"):this.Component.find("> .title > .div").removeClass("readonly"))}get Readonly(){return super.Readonly}set Help(n){function t(n){return function(){typeof n._link=="string"&&window.open(n._link,"_blank");typeof n._link=="function"&&n._link()}}if(this._link=n===null||n===undefined?null:n,this._link===null)this.off("help");else this.on("help",t(this))}set Panel(n){this._panel=n}get Panel(){return this._panel}get IsVisibleIcon(){return this._icons&GUI.Board.BOARD_ICON}get IsVisibleAdd(){return this._icons&GUI.Board.BOARD_ADD}get IsVisibleCancel(){return this._icons&GUI.Board.BOARD_CANCEL}get IsVisibleDelete(){return this._icons&GUI.Board.BOARD_DELETE}get IsVisibleHelp(){return this._icons&GUI.Board.BOARD_HELP}get List(){return this._list}get TableZone(){return this.Component.find("> .table")}get Webix(){return this._webix}set Webix(n){this._webix!==null&&this._webix.destructor();this._webix=n}destructor(){super.destructor();this._webix!==null&&(this._webix.destructor(),this._webix=null)}show(){this.IsOpened||(this.debug("Show the board"),this.onOpen(),this.refresh(),this.Component.show(),this._webix!==null&&(this.populateWebix(),this.adjustWebix()))}hide(){this.IsOpened&&this.Visible&&(this.debug("Hide the board"),this.onClose(),this.Component.hide())}setVisible(n,t){function i(n,t,i,r){t&i&&(r?n._icons&i||(n._icons+=i):n._icons&i&&(n._icons-=i))}if(n!==null&&n!==undefined){if(typeof n=="boolean"){super.Visible=n;return}i(this,n,GUI.Board.BOARD_ICON,t);i(this,n,GUI.Board.BOARD_ADD,t);i(this,n,GUI.Board.BOARD_CANCEL,t);i(this,n,GUI.Board.BOARD_DELETE,t);i(this,n,GUI.Board.BOARD_HELP,t);this.refreshIcon("board",this.IsVisibleIcon);this.refreshIcon("add",this.IsVisibleAdd);this.refreshIcon("cancel",this.IsVisibleCancel);this.refreshIcon("delete",this.IsVisibleDelete);this.refreshIcon("help",this.IsVisibleHelp)}}refreshIcon(n,t){function r(n,t){return function(){switch(t){case"board":n.onBoard();break;case"add":n.onAdd();break;case"cancel":n.onCancel();break;case"delete":n.onDelete();break;case"help":n.onHelp()}}}if(this.Component!==null){var i=this.Component.find("> .title > .icon."+n);if(t?i.hasClass("hide")&&i.removeClass("hide"):i.hasClass("hide")||i.addClass("hide"),i.hasClass("disallowed")&&i.removeClass("disallowed"),this.isEvent(n)&&this.List.isBoardAllowed(this,DSDatabase.Instance.CurrentUser,n)){i.css("cursor","pointer");i.off("click").on("click",r(this,n))}else t?(i.addClass("disallowed"),i.css("cursor","initial"),i.off("click")):(i.css("cursor","initial"),i.off("click"))}}refresh(){(super.refresh(),this.Component!==null&&this._webix!==null)&&(this.Component.find("> .title > .title").html(Helper.Span(this._title)),this.refreshIcon("board",this.IsVisibleIcon),this.refreshIcon("add",this.IsVisibleAdd),this.refreshIcon("cancel",this.IsVisibleCancel),this.refreshIcon("delete",this.IsVisibleDelete),this.refreshIcon("help",this.IsVisibleHelp),this.Readonly?this.Component.find("> .title > div").addClass("readonly"):this.Component.find("> .title > div").removeClass("readonly"))}adjustWebix(){this.debug("Adjust webix");var n=this.TableZone,t=Math.floor(n.width()),i=Math.floor(n.height());(t!==this._webix.config.width||i!==this._webix.config.height)&&(this._webix.config.width=t,this._webix.config.height=i,this._webix.resize())}draw(){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(function(){n.debug("Resizing window ...");n.adjustWebix()},100))}}var n="<board id='"+this.Name+"' class='"+this.Name+"'>";n+="<div class='title'>";n+="<div class='icon board'><\/div>";n+="<div class='title'><\/div>";n+="<div class='icon add'><\/div>";n+="<div class='icon cancel'><\/div>";n+="<div class='icon delete'><\/div>";n+="<div class='icon help'><\/div>";n+="<\/div>";n+="<div class='table'><\/div>";n+="<\/board>";super.draw(n);this._webix=this.drawWebix(this.TableZone);$(window).on("resize",t(this))}populateWebix(){this.debug("Populate webix")}drawWebix(){return null}onOpen(){function n(n){return function(){n.Readonly||n.Box!==null&&n.Box.setFocus(n)}}function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onUpdate(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1}}}super.onOpen();this.Component.on("focus",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.Component.off("focus keydown")}onEvent(n,t){if(n&&this.List.isBoardAllowed(this,DSDatabase.Instance.CurrentUser,t)){var i=this.getEvent(t);i!==null&&i()}}onBoard(){this.onEvent(this.IsVisibleIcon,"board")}onAdd(){this.onEvent(this.IsVisibleAdd,"add")}onCancel(){this.onEvent(this.IsVisibleCancel,"cancel")}onDelete(){this.onEvent(this.IsVisibleDelete,"delete")}onHelp(){this.onEvent(this.IsVisibleHelp,"help")}addItem(n,t){function u(n,t,i){return function(){var n=new Errors,r;if(i.Table!==undefined?i.beginTransaction(Helper.Label(i.Table.toUpperCase()+"_CREATED_TOAST",i.getText(t))):i.beginTransaction(),r=i.addItem(t,n,!0),i.endTransaction(),n.HasError){window.administration===undefined&&i.rollback(oldRecord);GUI.Box.Message.Error("ERROR",n);return}window.administration===undefined&&i.commit(r)}}var r=new Errors,i;if(t=t===undefined||t===null?this.List:t,t.Table!==undefined?t.beginTransaction(Helper.Label(t.Table.toUpperCase()+"_CREATED_TOAST",t.getText(n))):t.beginTransaction(),i=t.addItem(n,r,!1),t.endTransaction(),Helper.IsLabel(i)){GUI.Box.Message.Message(Helper.Label(t.Table===undefined?this.Title:t.Table.toUpperCase()+"_CREATE",t.getText(n)),i,u(this,n,t));return}if(r.HasError){window.administration===undefined&&t.rollback(oldRecord);GUI.Box.Message.Error("ERROR",r);return}window.administration===undefined&&t.commit(i)}updateItem(n,t,i){function f(n,t,i){return function(){var r=new Errors,u;if(n.List.Table!==undefined?n.List.beginTransaction(Helper.Label(n.List.Table.toUpperCase()+"_UPDATED_TOAST",n.List.getText(i))):n.List.beginTransaction(),u=n.List.updateItem(t.Id,t,i,r,!0),n.List.endTransaction(),r.HasError){window.administration===undefined&&n.List.rollback(t);GUI.Box.Message.Error("ERROR",r);return}window.administration===undefined&&n.List.commit(u)}}var u=new Errors,r;if(i=i===undefined||i===null?this.List:i,i.Table!==undefined?i.beginTransaction(Helper.Label(i.Table.toUpperCase()+"_UPDATED_TOAST",i.getText(t))):i.beginTransaction(),r=i.updateItem(n.Id,n,t,u,!1),i.endTransaction(),Helper.IsLabel(r)){GUI.Box.Message.Message(Helper.Label(i.Table===undefined?this.Title:i.Table.toUpperCase()+"_UPDATE",i.getText(t)),r,f(this,n,t,i));return}if(u.HasError){window.administration===undefined&&i.rollback(n);GUI.Box.Message.Error("ERROR",u);return}window.administration===undefined&&i.commit(r)}deleteItem(n,t){var i=new Errors,r;if(t=t===undefined||t===null?this.List:t,t.Table!==undefined?t.beginTransaction(Helper.Label(t.Table.toUpperCase()+"_DELETED_TOAST",t.getText(n))):t.beginTransaction(),r=t.deleteItem(n.Id,n,i),t.endTransaction(),i.HasError){window.administration===undefined&&t.rollback(r);GUI.Box.Message.Error("ERROR",i);return}window.administration===undefined&&t.commit(r)}exportCSV(n){let i=new CSV;i.addList(this.List);var r=new Blob(i.toBlob(DSDatabase.Instance.Parameters["CSV.Charset"],DSDatabase.Instance.Parameters["CSV.Separator"]),{encoding:i.Charset,type:"text/csv;charset="+i.Charset});GUI.Board.ExportCSVFile!==null&&window.URL.revokeObjectURL(GUI.Board.ExportCSVFile);GUI.Board.ExportCSVFile=window.URL.createObjectURL(r);n=n===undefined||n===null?this.Name+".csv":n;let t=document.createElement("a");return t.setAttribute("download",n),t.href=GUI.Board.ExportCSVFile,document.getElementById("log").appendChild(t),window.requestAnimationFrame(function(){var n=new MouseEvent("click");t.dispatchEvent(n);document.getElementById("log").removeChild(t)}),!0}toPDF(n,t){t(n)}exportPDF(){function n(n){return function(){function i(n){return function(t){try{GUI.Box.Progress.Stop();n.info("PDF file : "+String.JSONStringify(t));pdfMake.createPdf(t).download(n.Name+".pdf");n.info("Export done into a PDF file")}catch(i){GUI.Box.Progress.Stop();n.exception("Unable to create PDF file",i);GUI.Box.Message.Error("ERROR","ERR_DOWNLOAD_PDF")}}}var t=PDF.Create(n._title);n.toPDF(t,i(n),function(n){GUI.Box.Progress.Stop();GUI.Box.Message.Error("ERROR",n)})}}if(!Hub.Instance.IsOnline&&!PDF.INITIALIZATION_DONE){GUI.Box.Message.Error("ERROR","ERR_UNABLE_PDF");return}this.info("Exporting board into a PDF file ...");GUI.Box.Progress.Start();GUI.Box.Progress.SetStatus(0,2,"MSG_PDF");PDF.Initialize(n(this))}constructor(n,t,i,r,u,f){super("board",n,t,"board "+i?i:"");this._panel=null;this._link=null;this._title=Helper.Label(r);this._list=u instanceof List.List?u:new List.List;this._icons=f!==null&&f!==undefined?f:GUI.Board.BOARD_ICON+GUI.Board.BOARD_ADD+GUI.Board.BOARD_CANCEL+GUI.Board.BOARD_DELETE;this._webix=null;this._CSVColumns=null}});GUI.Board.BoardChart=(class extends GUI.Board.Board{get Legends(){return this._legends}createChart(){return null}draw(){function o(n){return function(t,i,r){var u;if(i!==undefined)for(u=0;u<n._legends.length;u++)n._legends[u].text!==""&&(n._legends[u].text=$(n._legends[u].text).each(Language.Manager.HandleReplacementKeyLabel(t,i,r))[0].outerHTML);else for(u=0;u<n._legends.length;u++)n._legends[u].text!==""&&(n._legends[u].text=$(n._legends[u].text).each(Language.Manager.HandleReplacementLabel(t))[0].outerHTML);n.Webix=n.createChart();n.adjustWebix()}}var f,n,t,e,i,r,u;for(this.declareLegends(),f=String.parseRGBToHEX($("body").css("color")),n=$("<webix id='"+this.Name+"' class='default_color'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass),t=n.appendTo("body"),e=String.parseRGBToHEX(n.css("color")),t.remove(),i=0;i<this._legends.length;i++)r=this._legends[i],n=$("<webix id='"+this.Name+"' class='color_"+r.id+"'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass),t=n.appendTo("body"),u=String.parseRGBToHEX(n.css("color")),t.remove(),r.color=u===f?e:u;super.draw();Language.Manager.Instance.addListener(o(this))}adjustWebix(){(super.adjustWebix(),this.Webix!==null)&&this.Webix.adjust()}declareLegend(n,t,i){this._legends.push({id:n,text:Helper.Span(t),label:Helper.Label(t),color:null,type:i===undefined||i===null?null:i})}declareLegends(){}getTooltipValue(n,t){return n[t].toString()}getTooltip(n,t,i){var r=0,u="";if(i!==null&&i!==undefined){for(r=0;r<this._legends.length;r++)if(this._legends[r].id===i)return"<div style='color: "+this._legends[r].color+";'>"+String.encode(n[t])+" - "+this._legends[r].text+": "+n[this._legends[r].id].toString()+"<\/div>";return null}switch(this._legends.length){case 0:return null;case 1:return"<div style='color: "+this._legends[0].color+";'>"+String.encode(n[t])+" - "+this._legends[0].text+": "+n[this._legends[0].id].toString()+"<\/div>"}for(u="<table><tr><td colspan='2'><center><b>"+String.encode(n[t])+"<\/b><\/center><\/td><\/tr>",r=0;r<this._legends.length;r++)u+="<tr style='color: "+this._legends[r].color+";'><td>"+this._legends[r].text+"<\/td><td>"+this.getTooltipValue(n,this._legends[r].id)+"<\/td><\/tr>";return u+"<\/table>"}get NbPoints(){return Math.ceil(this.TableZone.width()/10)+1}newIndicator(){for(var t={},n=0;n<this._legends.length;n++)t[this._legends[n].id]=0;return t}drawCanvas(){}onOpen(){function n(n){return function(){n.refresh();n.populateWebix();n.adjustWebix(!0)}}if(super.onOpen(),!this.List.isEvent("onCreate")&&!this.List.isEvent("onUpdate")&&!this.List.isEvent("onDelete")&&!this.List.isEvent("onLoad")){this.List.on("onCreate",n(this));this.List.on("onUpdate",n(this));this.List.on("onDelete",n(this));this.List.on("onLoad",n(this))}this.List.onOpen()}onClose(){super.onClose();this.List.unbind("onCreate");this.List.unbind("onUpdate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}toPDF(n,t,i){try{var u=PDF.MAX_WIDTH_A4-n.pageMargins[0]-n.pageMargins[2],f=Math.ceil(u/2),r=$("<canvas width='"+(u*2).toString()+"' height='"+(f*2).toString()+"' ><\/canvas>"),e=r[0].getContext("2d");this.drawCanvas(r[0],e);n.content.push({image:PDF.AddImage(n,r[0].toDataURL("image/png",1)),width:u,height:f,alignment:"center"});r.remove();t(n)}catch(o){this.exception("Unable to create PDF file",o);i("ERR_DOWNLOAD_PDF")}}constructor(n,t,i,r,u,f){super(n,t,"board_chart "+i,r,u,f);this._legends=[]}});GUI.Board.BoardChartMultiData=(class extends GUI.Board.BoardChart{static get BAR(){return"bar"}static get LINE(){return"line"}set NbSteps(n){this._nbSteps=n<1?1:Math.ceil(n)}get Values(){return this._values}createChart(){function i(n){return function(t,i){var r=n.getTooltip(n.Webix.getItem(t),"label");String.isEmptyOrWhiteSpaces(r)||GUI.Webix.Tooltip.Instance.show(r,i)}}function r(){return function(){GUI.Webix.Tooltip.Instance.hide()}}var t=this._maxValue?this._maxValue:this._nbSteps,n={view:"chart",type:this._chartType,css:"webix_board_line",container:this.TableZone[0],color:"#color#",shadow:!1,border:!1,borderless:!0,xAxis:{template:this._showXAxis?"#label#":"",lines:!1},tooltip:!1,yAxis:{start:0,end:t,step:t/this._nbSteps,lines:!0},legend:{values:this.Legends,align:"center",layout:"x"},series:this._series,data:this._data,on:{onMouseMove:i(this),onMouseOut:r(this)}};return this._chartType===GUI.Board.BoardChartMultiData.LINE&&(n.offset=0,n.eventRadius=5),new webix.ui(n)}drawWebix(){var n=null,t;this._series=[];for(n in this.Legends){let i=this.Legends[n],r=$("<webix id='"+this.Name+"' class='color_"+i.id+"'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||r.addClass(this.CSSClass);let u=r.appendTo("body");t=parseInt(r.css("width"));t<1&&(t=1);u.remove();i.width=t;i.type=i.type===null||i.type===undefined?this._chartType:i.type}for(n in this.Legends){let t=this.Legends[n];if(t.type===this._chartType)switch(this._chartType){case GUI.Board.BoardChartMultiData.BAR:this._series.push({value:"#"+t.id+"#",color:t.color});break;case GUI.Board.BoardChartMultiData.LINE:this._series.push({value:"#"+t.id+"#",item:{radius:0},line:{color:t.color,width:t.width}})}}for(n in this.Legends){let t=this.Legends[n];if(t.type!==this._chartType)switch(t.type){case GUI.Board.BoardChartMultiData.BAR:this._series.push({value:"#"+t.id+"#",type:"bar",color:t.color});break;case GUI.Board.BoardChartMultiData.LINE:this._series.push({value:"#"+t.id+"#",type:"line",item:{radius:0},line:{color:t.color,width:t.width}})}}return this.createChart()}adjustWebix(n){var t,i,r;if(n=n===null||n===undefined?!1:n,this.Webix!==null){for(t=0,i=0;i<this._data.length;i++)for(r=0;r<this.Legends.length;r++)t<this._data[i][this.Legends[r].id]&&(t=Math.ceil(this._data[i][this.Legends[r].id]/this._nbSteps)*this._nbSteps);(this._maxValue!==t||this.Webix.config.yAxis.step!==t/this._nbSteps||n)&&(this._maxValue=t,this.Webix=this.createChart());var u=this.TableZone,f=u.width(),e=u.height();this.Webix.config.width=f;this.Webix.config.height=e;this.Webix.config.x=f/10;this.Webix.config.y=e/10;this.Webix.resize();super.adjustWebix()}}clear(){this._data.splice(0,this._data.length);this._values={}}declareAbscissa(n,t){var i,r;if(t=t===null||t===undefined?n:t,this._values[n]===undefined){for(i={id:this._data.length,abscissa:n,label:t},r=0;r<this.Legends.length;r++)i[this.Legends[r].id]=0;this._data.push(i);this._values[n]=i}}setValue(n,t,i){if(this._values[n]!==null&&this._values[n]!==undefined&&this._values[n][t]!==null&&this._values[n][t]!==undefined){var r=0;r=typeof i=="string"?String.parseFloat(i):typeof i=="number"?i:0;r<0&&(r=0);this._values[n][t]=r}}drawCanvas(n,t){for(var i=0,r=0,l=0,a=this._nbSteps,p,d,g,nt,w,rt,ot,st,ht,o,i=0;i<this._data.length;i++)for(r=0;r<this.Legends.length;r++)a<this._data[i][this.Legends[r].id]&&(a=Math.ceil(this._data[i][this.Legends[r].id]/this._nbSteps)*this._nbSteps);var v=16,it=20,y=n.width*.95,b=Math.ceil(n.height*.7),u=n.width-y,f=b,s=0,e=0,h=0,k=0;if(t.translate(.5,6.5),this._data.length>0&&this.Legends.length>0){for(p=0,i=0;i<this.Legends.length;i++)this.Legends[i].type===GUI.Board.BoardChartMultiData.BAR&&p++;for(p>0?(e=y/Math.max(1,this._data.length),s=e/2,k=e/p):(e=y/Math.max(1,this._data.length-1),s=0),h=b/a,i=0,l=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.BAR){for(t.fillStyle=this.Legends[i].color,r=0;r<this._data.length;r++)(d=this._data[r][this.Legends[i].id],d<=0)||t.fillRect(u+r*e+k*(l+.1),f-1,k*.8,-d*h+1);l++}for(i=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.LINE){for(t.beginPath(),t.lineWidth=2,t.moveTo(u+s+1,f-h*this._data[0][this.Legends[i].id]),r=1;r<this._data.length;r++)t.lineTo(u+s+e*r,f-h*this._data[r][this.Legends[i].id]);t.strokeStyle=this.Legends[i].color;t.stroke()}for(i=0,l=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.LINE)for(t.fillStyle=this.Legends[i].color,r=0;r<this._data.length;r++)g=u+s+e*r,nt=f-h*this._data[r][this.Legends[i].id],t.beginPath(),t.moveTo(g,nt),t.lineTo(g,nt),t.fill()}for(t.beginPath(),t.lineWidth=1,t.moveTo(u,0),t.lineTo(u,f),t.lineTo(n.width,f),t.strokeStyle="#000000",t.stroke(),t.setLineDash([5,5]),i=1;i<=this._nbSteps;i++)w=Math.ceil(b*i/this._nbSteps),t.beginPath(),t.lineWidth=1,t.moveTo(u+1,f-w),t.lineTo(u+y,f-w),t.strokeStyle="#d8d8d8",t.stroke(),t.font=v.toString()+"px Arial",t.fillStyle="#333333",t.textAlign="right",rt=Math.ceil(a*i/this._nbSteps).toString(),t.fillText(rt,u-2,f-w+v/3);if(t.setLineDash([]),this.Legends.length>0){var ut=n.width/(this.Legends.length>4?4:this.Legends.length),c=it,tt=c/2,ct=0,lt=n.height-7-it/2-(c+14)*Math.floor((this.Legends.length-1)/4);for(t.font="20px Arial",i=0,r=0;i<this.Legends.length;i++){let n=Language.Manager.Instance.interpolation(this.Legends[i].label);var at=t.measureText(n),ft=ct+i%4*ut+(ut-at.width-c)/2,et=lt+r*(c+14);t.fillStyle="#666666";t.textAlign="left";t.fillText(n,ft+c,et);ot=ft+tt;st=et-tt;t.fillStyle=this.Legends[i].color;t.beginPath();t.arc(ot,st+4,tt*.8,0,Math.PI*2);t.fill();(i+1)%4==0&&r++}}if(this._data.length>0&&this.Legends.length>0)for(ht=Math.max(1,Math.ceil(20/e)),i=0;i<this._data.length;i+=ht)o=this._data[i].label,o=String.isEmptyOrWhiteSpaces(o)?"":o.length>23?o.substr(0,20)+" ...":o,t.save(),t.font=v.toString()+"px Arial",t.translate(u+s+e*i,f+2),t.rotate(-Math.PI/4),t.textAlign="right",t.fillStyle="#000000",t.fillText(o,0,v),t.restore()}constructor(n,t,i,r,u,f,e,o){super(n,t,"board_chart_multi "+i?i:"",r,u,f);this._chartType=e===null||e===undefined?GUI.Board.BoardChartMultiData.LINE:e;this._series=[];this._data=[];this._values={};this._maxValue=0;this._showXAxis=o===null||o===undefined||o;this._nbSteps=1}});GUI.Board.BoardChartBar=(class extends GUI.Board.BoardChartMultiData{constructor(n,t,i,r,u,f){super(n,t,"board_chart_bar",i,r,u,GUI.Board.BoardChartMultiData.BAR,f)}});GUI.Board.BoardChartLine=(class extends GUI.Board.BoardChartMultiData{constructor(n,t,i,r,u,f){super(n,t,"board_chart_line",i,r,u,GUI.Board.BoardChartMultiData.LINE,f)}});GUI.Board.BoardChartPie=(class extends GUI.Board.BoardChart{createChart(){return new webix.ui({view:"chart",type:"pie",css:"webix_board_pie",container:this.TableZone[0],value:"#value#",color:"#color#",shadow:!1,border:!1,borderless:!0,tooltip:{template:"#value#"},pieInnerText:"<div class='webix_pieInnerText'>#percentage#<\/div>",legend:{values:this.Legends,align:"left",layout:"y"},data:this._data})}drawWebix(){var n,t;this._data=[];this._values={};this._indicator={};for(n in this.Legends)t={id:n,value:0,color:this.Legends[n].color,percentage:0},this._data.push(t),this._values[this.Legends[n].id]=t,this._indicator[this.Legends[n].id]=0;return this.createChart()}computeIndicator(){return this.newIndicator()}populateWebix(){function r(n){return function(t){n.updateIndicator(n.computeIndicator(t),null,!1)}}var n=0,t,i;for(super.populateWebix(),this._indicator=this.newIndicator(),this.List.each(r(this)),n=0;n<this.Legends.length;n++)this.setValue(this.Legends[n].id,this._indicator[this.Legends[n].id]);for(t=0,n=0;n<this._data.length;n++)t+=this._data[n].value;for(i=0,n=0;n<this._data.length;n++)this._data[n].value>0?(i+=this._data[n].value,this._data[n].percentage=(Math.ceil(i*100/t)-Math.ceil((i-this._data[n].value)*100/t)).toString()):this._data[n].percentage="0",this._data[n].percentage+="%"}adjustWebix(){if(this.Webix!==null){var i=this.TableZone,n=i.width(),t=i.height();this.Webix.config.width=n;this.Webix.config.height=t;this.Webix.config.x=n/2;this.Webix.config.y=t/2;this.Webix.config.radius=(n<t?n:t)/2-5;this.Webix.resize();super.adjustWebix()}}setValue(n,t){if(this._values[n]!==null&&this._values[n]!==undefined){var i=0;i=typeof t=="string"?String.parseFloat(t):typeof t=="number"?t:0;i<0&&(i=0);this._values[n].value=i}}updateIndicator(n,t,i){var f=!1,r=null,u=null;if(i=i===null||i===undefined||i,n!==null&&n!==undefined&&t!==null&&t!==undefined)for(r=0;r<this.Legends.length;r++)(u=n[this.Legends[r].id]-t[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]+=u);else if(n!==null&&n!==undefined)for(r=0;r<this.Legends.length;r++)(u=n[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]+=u);else if(t!==null||t!==undefined)for(r=0;r<this.Legends.length;r++)(u=t[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]-=u);f&&i&&(this.populateWebix(),this.adjustWebix())}onOpen(){function t(n){return function(){n.refresh();n.populateWebix();n.adjustWebix()}}function n(n){return function(t,i,r,u,f){var e=null,o=null;switch(t){case"onCreate":e=n.computeIndicator(u);break;case"onUpdate":o=n.computeIndicator(u);e=n.computeIndicator(f);break;case"onDelete":o=n.computeIndicator(u)}n.debug("Handle event ("+t+","+i+") : "+String.JSONStringify(o)+" - "+String.JSONStringify(e));n.updateIndicator(e,o)}}this.List.on("onLoad",t(this));this.List.on("onCreate",n(this));this.List.on("onUpdate",n(this));this.List.on("onDelete",n(this));super.onOpen()}onClose(){super.onClose();this.List.unbind("onCreate");this.List.unbind("onUpdate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}drawCanvas(n,t){for(var i=0,u=0,r,v,y,k,h,p,i=0;i<this._data.length;i++)u+=this._data[i].value;var f=(n.height>n.width/2?n.width/2:n.height)/2,e=f,o=f;if(u>0){for(r=1.5*Math.PI,i=0;i<this._data.length;i++)t.fillStyle=this._data[i].color,t.beginPath(),t.moveTo(e,o),t.arc(e,o,f*.9,r,r+Math.PI*2*(this._data[i].value/u),!1),t.lineTo(e,o),t.fill(),r+=Math.PI*2*(this._data[i].value/u);for(r=1.5*Math.PI,i=0;i<this._data.length;i++)r+=Math.PI*2*(this._data[i].value/u),this._data[i].value>0&&(v=f*.5*Math.cos(r-Math.PI*2*(this._data[i].value/u)/2),y=f*.5*Math.sin(r-Math.PI*2*(this._data[i].value/u)/2),t.font="22px Arial",t.fillStyle="#ffffff",t.textAlign="center",t.fillText(this._data[i].percentage,e+v,o+y))}else k=String.parseRGBToHEX($("body").css("color")),h=$("<webix id='"+this.Name+"' class='default_color'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||h.addClass(this.CSSClass),p=h.appendTo("body"),t.fillStyle=String.parseRGBToHEX(h.css("color")),p.remove(),t.beginPath(),t.moveTo(e,o),t.arc(e,o,f,0,Math.PI*2),t.fill();if(this.Legends.length>0){var d=n.width/4,c=n.height/6,g=Math.ceil(this.Legends.length/2),nt=n.width/2,tt=(n.height-g*c)/2;for(i=0;i<this.Legends.length;i++){var it=this._values[this.Legends[i].id].value,w=nt+i%2*d,b=tt+Math.floor(i/2)*c,s=c/2,l=w+s+s*.4,a=b+s;t.fillStyle=this.Legends[i].color;t.beginPath();t.moveTo(l,a);t.arc(l,a,s*.4,0,Math.PI*2);t.lineTo(l,a);t.fill();t.font="20px Arial";t.fillStyle="#666666";t.textAlign="left";t.fillText(Language.Manager.Instance.interpolation(this.Legends[i].label)+" ("+it.toString()+")",w+2*s,b+c/2+7)}}}constructor(n,t,i,r,u){super(n,t,"board_chart_pie",i,r,u);this._indicator={};this._data=[];this._values={}}});GUI.Board.BoardTable=(class extends GUI.Board.Board{static get COLUMN_SELECT(){return"_select"}get ColumnsVisible(){var n,t;if(this.Webix===null)return[];n=[];for(t in this.Webix.config.columns)this.Webix.isColumnVisible(this.Webix.config.columns[t].id)&&n.push(this.Webix.config.columns[t].id);return n}get Columns(){return this._columns}set MultiSelection(n){if(this._multiselect=n!==null&&n!==undefined&&n,this.Webix!==null&&this.Webix.isColumnVisible(GUI.Board.BoardTable.COLUMN_SELECT)!==this._multiselect)try{this._multiselect?this.Webix.showColumn(GUI.Board.BoardTable.COLUMN_SELECT):this.Webix.hideColumn(GUI.Board.BoardTable.COLUMN_SELECT)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",t)}}get Multiselection(){return this._multiselect}destructor(){super.destructor();this._webixAdjustedZone!==null&&(this._webixAdjustedZone.remove(),this._webixAdjustedZone=null,this._webixAdjustedZoneHTML=null)}declareColumn(n,t,i,r,u,f,e){function h(n,t){return function(i,r){var o,u,f,e;for(o in t)if(u=n.List.getAttributValue(i.item,t[o]),f=n.List.getAttributValue(r.item,t[o]),u!==null||f!==null){if(u===null)return-1;if(f===null)return 1;if(Array.isArray(u)&&Array.isArray(f)){if(u.length<f.length)return-1;if(u.length>f.length)return 1;for(e=0;e<u.length;e++)if(u[e]!==null||f[e]!==null){if(u[e]===null)return-1;if(f[e]===null||u[e]>f[e])return 1;if(u[e]<f[e])return-1}continue}if(u>f)return 1;if(u<f)return-1}return 0}}function c(n,t,i){return function(r){if(t===GUI.Board.BoardTable.COLUMN_SELECT)return"<div class='"+GUI.Board.BoardTable.COLUMN_SELECT+"'><div class='"+(r._select?"selected":"unselected")+"'><\/div><\/div>";let u="";return n.isFieldVisible(t,i,r.item)?(n.List.isAttributDeleted(r.item,t)&&(u="deleted"),r._select&&(u=u+(u===""?"":" ")+"selected"),u=u+(u===""?"":" ")+t.toLowerCase(),"<div class='"+u+"'>"+n.List.getAttributHTML(r.item,t)+"<\/div>"):""}}var o={},s;return o.id=n,o.header={header:t,text:Helper.Span(t),height:20},o.fillspace=i,o.css={"text-align":r?r:"left"},o.template=c(this,n,DSDatabase.Instance.CurrentUser),o.sort=u===undefined||u===null||typeof u=="boolean"&&u?h(this,[n]):typeof u=="string"?h(this,[n,u]):Array.isArray(u)?h(this,[n].concat(u)):!1,this._columns.push(o),s={title:t,field:n,size:i,align:r?r:"left"},f!==null&&f!==undefined&&e!==null&&e!==undefined&&(s.width=f,s.height=e),this._pdfColumns.push(s),this.debug("Declare column '"+n+"'"),o}showColumn(n){if(this.Webix!==null&&n!==GUI.Board.BoardTable.COLUMN_SELECT)try{this.Webix.showColumn(n)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",t)}}hideColumn(n){if(this.Webix!==null&&n!==GUI.Board.BoardTable.COLUMN_SELECT)try{this.Webix.hideColumn(n)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on hiding the column",t)}}focus(){return(this.verbose("focus"),this.Component===null||this._tabIndex===null||!this.Visible||this.Readonly)?!1:this.Webix===null||this.Webix===undefined?!1:(this.Webix.getFirstId()===undefined?this.Component.focus():(!this.Webix.getSelectedItem()&&this.Webix.getFirstId()&&this.Webix.select(this.Webix.getFirstId()),webix.UIManager.setFocus(this.Webix)),!0)}isFieldVisible(n,t,i){if(!this.List.isBoardFieldVisible(this,n,t,i))return!1;if(this.List.ListParent===null||this.List.ListParent===undefined)return!0;let r=this.List.ListParent.getListValues(this.List.Column);return r===null?this.List.isBoardFieldVisible(this,n,t,i):n!==r.column}isFieldReadonly(n,t,i){return this.List.isBoardFieldReadonly(this,n,t,i)}isAllowed(n,t,i){return this.List.isBoardAllowed(this,n,t,i)}onOpen(){function n(n){return function(t,i,r,u){n.addRow(t,i,r,u)}}function t(n){return function(t,i,r,u,f){n.updateRow(t,i,r,u,f)}}function i(n){return function(t,i,r,u){n.deleteRow(t,i,r,u)}}function r(n){return function(){n.refresh();n.populateWebix();n.adjustWebix()}}super.onOpen();this.List.on("onCreate",n(this));this.List.on("onUpdate",t(this));this.List.on("onDelete",i(this));this.List.on("onLoad",r(this));this.List.onOpen()}onClose(){super.onClose();this.List.unbind("onCreate");this.List.unbind("onUpdate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}refresh(){if(super.refresh(),this.Webix!==null){if(this.Webix.isColumnVisible(GUI.Board.BoardTable.COLUMN_SELECT)!==this._multiselect)try{this._multiselect?this.Webix.showColumn(GUI.Board.BoardTable.COLUMN_SELECT):this.Webix.hideColumn(GUI.Board.BoardTable.COLUMN_SELECT)}catch(n){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",n)}for(let n in this._columns){let t=this.isFieldVisible(this._columns[n].id);this.Webix.isColumnVisible(this._columns[n].id)!==t&&t&&this.showColumn(this._columns[n].id)}for(let n in this._columns){let t=this.isFieldVisible(this._columns[n].id);this.Webix.isColumnVisible(this._columns[n].id)===t||t||this.hideColumn(this._columns[n].id)}}}addRow(n,t,i,r){var u,f;this.Webix!==null&&this.List.isVisible(r)&&(this.IsDebug&&this.debug("Add row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")"),u={},u.id=this.List.getId(r).toString(),u.item=r,u._select=!1,this.Webix.blockEvent(),this.Webix.add(u,-1),this.Webix.unblockEvent(),this.adjustWebix(u.id),f=this.getEvent("onUpdate"),f&&f())}updateRow(n,t,i,r,u){var e,o,f,s;if(this.Webix!==null&&(e=this.List.isVisible(r),o=this.List.isVisible(u),e||o)){if(e&&!o){this.deleteRow(n,t,i,r);return}if(!e&&o){this.addRow(n,t,i,u);return}this.IsDebug&&this.debug("Update row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(u)+")");f={};f.id=this.List.getId(r).toString();f.item=u;f._select=this.Webix.getItem(f.id)._select;this.Webix.blockEvent();this.Webix.updateItem(f.id,f);this.Webix.unblockEvent();this.adjustWebix(f.id);s=this.getEvent("onUpdate");s&&s()}}deleteRow(n,t,i,r){var u,f;this.Webix!==null&&(this.IsDebug&&this.debug("Delete row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")"),u={},u.id=this.List.getId(r).toString(),u.item=r,u._select=!1,this.Webix.blockEvent(),this.Webix.remove(u.id),this.Webix.unblockEvent(),f=this.getEvent("onUpdate"),f&&f())}adjustWebix(n){function r(n,t,i){var r,u,f;if(i!==null&&i!==undefined){for(n.Webix.isSelected(i.id)?$(n._webixAdjustedZoneHTML).addClass("webix_row_select"):$(n._webixAdjustedZoneHTML).removeClass("webix_row_select"),r=1,u=0;u<t.length;u++)f=n.Webix.getColumnConfig(t[u]),$(n._webixAdjustedZoneHTML).css("width",f.width+"px"),$(n._webixAdjustedZoneHTML).css("height","1px"),n._webixAdjustedZoneHTML.innerHTML=n.Webix.getText(i.id,f.id),r<n._webixAdjustedZoneHTML.scrollHeight&&(r=n._webixAdjustedZoneHTML.scrollHeight),n._webixAdjustedZoneHTML.innerHTML="";i.$height=r}}function u(n,t){return function(i){r(n,t,i)}}var t,i;(n===null||n===undefined?super.adjustWebix():this.debug("Adjust row : "+n.toString()),this.Webix!==null)&&(this._webixAdjustedZone===null&&(this._webixAdjustedZone=$("<div class='webix_view webix_dtable'><div class='webix_ss_body'><div class='webix_ss_center'><div class='webix_ss_center_scroll'><div class='webix_column'><div class='webix_cell'><\/div><\/div><\/div><\/div><\/div><\/div>"),t="webix_board",this.CSSClass&&(t+=" "+("webix_"+this.CSSClass).split(" ").join(" webix_")),this._webixAdjustedZone.addClass(t),this._webixAdjustedZone.css("visibility","hidden"),$(this.Webix.$view).append(this._webixAdjustedZone),this._webixAdjustedZoneHTML=this._webixAdjustedZone.find("> div > div > div > div > div")[0]),i=this.ColumnsVisible,this.Webix.blockEvent(),n!==null&&n!==undefined?(r(this,i,this.Webix.getItem(n)),this.Webix.refresh(n)):(this.Webix.data.each(u(this,i)),this.Webix.refresh()),this.Webix.unblockEvent())}draw(){function n(n){return function(){GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.List.Table,null,n.List).createRecord()}}function t(n){return function(t){t!==null&&GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.List.Table,null,n.List).deleteRecord(t)}}if(this.declareColumn(GUI.Board.BoardTable.COLUMN_SELECT,null,1,"center",!1),this.declareColumns(),super.draw(),this.List instanceof List.ListRecord||this.List instanceof List.ListArrayRecord){this.on("add",n(this));this.on("delete",t(this))}}populateWebix(){function t(n){return function(t){var i={};i.id=n.List.getId(t);i.item=t;i._select=!1;n.Webix.add(i,-1)}}if(super.populateWebix(),this.Webix!==null){var n=this.Webix.isVisible();this.Webix.blockEvent();this.Webix.hide();this.Webix.clearAll();this.List.each(t(this));this.Webix.unblockEvent();n&&this.Webix.show();this.Webix.showItemByIndex(0)}}drawWebix(n){function u(n){return function(t,i,r,u){n.Visible&&u&&(n.debug("Resizing column ..."),n.adjustWebix())}}function f(n){return function(){n.onUpdate()}}function e(n){return function(t){var r,i;if(t.column===GUI.Board.BoardTable.COLUMN_SELECT&&n._multiselect){n.isSelectedItem(t)?n.unselectItem(t):n.selectItem(t);return}if(!n.Readonly&&(r=n.getEvent("onClick"+t.column),r)&&(i=this.getItem(t),i)){let u=DSDatabase.Instance.CurrentUser;n.isAllowed(u,"onClick"+t.column,i.item)&&!n.isFieldReadonly(t.column,u,i.item)&&(n.debug("Raise event(onClick"+t.column+","+i.id+")"),r(i.id,i.item,t.column))}}}function o(n){return function(t,i){var r=i.column.id===null||i.column.id===undefined?"ToolTip":i.column.id,t,u,f,e,o;return r===GUI.Board.BoardTable.COLUMN_SELECT&&n._multiselect?(t=n.getSelectedItem(),t===null)?"":Language.Manager.Instance.interpolation(Helper.Label("TABLE_"+(t._select===!0?"SELECTED":"UNSELECTED"))):t===null||t===undefined||i===null||i===undefined?"":t.item===null||t.item===undefined||i.column===null||i.column===undefined?"":(u=t.item,f=n.List.getAttributToolTipHTML(u,r),typeof f=="boolean"&&f===!1)?"":String.isEmptyOrWhiteSpaces(f)?(e=null,o=n.List.getAttributHTML(u,r),e=Helper.IsLabel(u[r],!0)?Helper.Span(u[r]):n.List.getAttributText(u,r),e===o||e===String.decode(o)?n.List.getAttributText(t.item,"ToolTip"):e):f}}function s(n){return function(t,i,r){var u,f;if(i!==undefined)for(u=0;u<n._columns.length;u++)for(f=0;f<n._columns[u].header.length;f++)n._columns[u].header[f].text!==""&&(n._columns[u].header[f].text=$(n._columns[u].header[f].text).each(Language.Manager.HandleReplacementKeyLabel(t,i,r))[0].outerHTML);else for(u=0;u<n._columns.length;u++)for(f=0;f<n._columns[u].header.length;f++)n._columns[u].header[f].text!==""&&(n._columns[u].header[f].text=$(n._columns[u].header[f].text).each(Language.Manager.HandleReplacementLabel(t))[0].outerHTML);try{n.Webix.refreshColumns()}catch(e){this.IsVerbose&&this.exception("[Verbose] An exception occurs on refreshing columns",e)}}}function h(n){return function(t,i){let u=i.which||i.keyCode;switch(u){case 9:return i.preventDefault(),i.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return i.preventDefault(),n.onUpdate(),!1;case 27:return i.preventDefault(),n.onButtonCancel(),!1;case 32:if(i.preventDefault(),!n._multiselect)return!1;var r=n.getSelectedItem();return r===null?!1:(n.isSelectedItem(r.id)?n.unselectItem(r.id):n.selectItem(r.id),!1)}}}function c(n){return function(){var i=n.getEvent("onSelectChange"),t;if(i){t=this.getItem(n.Webix.getSelectedId(!0));let r=DSDatabase.Instance.CurrentUser;n.isAllowed(r,"onSelectChange",t?t.item:null)&&(n.debug("Raise event(onSelectChange,"+(t?t.id:"")+")"),t?i(t.id,t.item):i())}}}var t="webix_board",r;this.CSSClass&&(t+=" "+("webix_"+this.CSSClass).split(" ").join(" webix_"));let i=$("<div class='"+t+"'><div class='webix_cell'><\/div><\/div>");return $("body > main").append(i),r=parseInt(i.find(".webix_cell").css("font-size")),i.remove(),Language.Manager.Instance.addListener(s(this)),new webix.ui({view:"datatable",container:n[0],css:t,scroll:"y",scrollAlignY:!1,select:"row",tooltip:{template:o(this),css:t+"_tooltip"},columns:this._columns,resizeColumn:!0,fixedRowHeight:!1,rowLineHeight:r,rowHeight:r,navigation:!0,editable:!0,data:[],on:{onColumnResize:u(this),onItemDblClick:f(this),onItemClick:e(this),onKeyPress:h(this),onSelectChange:c(this)}})}isSelectedItem(n){let t=this.Webix.getItem(n);return t===null?!1:t._select}selectItem(n){let t=this.Webix.getItem(n);t===null||t._select||(t._select=!0,this.Webix.refresh(t.id))}unselectItem(n){let t=this.Webix.getItem(n);t!==null&&t._select&&(t._select=!1,this.Webix.refresh(t.id))}getSelectedItems(){function t(n,t){return function(i){var r=n.Webix.getItem(i);r!==null&&r!==undefined&&r.item&&r._select&&t.push(r.item)}}let n=[];if(this._multiselect){if(this.Webix.eachRow(t(this,n)),n.length===0){let t=this.getSelectedItem();t!==null&&t.item!==null&&t.item!==undefined&&n.push(t.item)}}else{let t=this.getSelectedItem();t!==null&&t.item!==null&&t.item!==undefined&&n.push(t.item)}return n}getSelectedItem(n){return(n===undefined&&(n=this.Webix.getSelectedId()),String.isEmptyOrWhiteSpaces(n))?null:this.Webix.getItem(n)}onBoard(){var t,n;if(this.IsVisibleIcon&&(t=this.getEvent("board"),t!==null)){if(n=this.getSelectedItem(),n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"board"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"board",n.item)&&t(this.List.getId(n.item),n.item)}}onAdd(){var t,n;if(this.IsVisibleAdd&&(t=this.getEvent("add"),t!==null)){if(n=this.getSelectedItem(),n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"add"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"add",n.item)&&t(this.List.getId(n.item),n.item)}}onUpdate(){var n=this.getSelectedItem(),i;if(n!==null){i=this.getEvent("update");let t=GUI.Box.BoxRecord.CACHE_DIALOG_BOX(this.List.Table,null,this.List);if(i===null&&n!==null){t!==null&&(this.Readonly?this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(this.List.getId(n.item)):this.isAllowed(DSDatabase.Instance.CurrentUser,"update",n.item)?t.updateRecord(this.List.getId(n.item)):this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(this.List.getId(n.item)));return}if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"update",n.item)&&t!==null){this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(this.List.getId(n.item));return}n===null?i(null):i(this.List.getId(n.item),n.item)}}onCancel(){var t,n;if(this.IsVisibleCancel&&(t=this.getEvent("cancel"),t!==null)){if(n=this.getSelectedItem(),n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"cancel"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"cancel",n.item)&&t(this.List.getId(n.item),n.item)}}onDelete(){var t,n;if(this.IsVisibleDelete&&(t=this.getEvent("delete"),t!==null)){if(n=this.getSelectedItem(),n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"delete"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"delete",n.item)&&t(this.List.getId(n.item),n.item)}}sort(n,t){if(this.Webix!==null)for(let i=0;i<this._columns.length;i++){let r=this._columns[i];if(r.id===n&&r.sort!==!1){this.Webix.sort(r.sort,t===null||t===undefined?"asc":t);return}}}declareColumns(){}toPDF(n,t,i){try{let r=[],u=DSDatabase.Instance.CurrentUser;for(let n in this._pdfColumns){let t=this._pdfColumns[n];t!==null&&t!==undefined&&this.Webix.isColumnVisible(t.field)&&r.push(t)}PDF.CreateTable(n,null,r,this.List,this.List.getListSorted());PDF.Finalize(n,t,i)}catch(r){this.exception("Unable to create PDF file",r);i("ERR_DOWNLOAD_PDF")}}constructor(n,t,i,r,u){super(n,t,"board_table",i,r,u);this._webixAdjustedZone=null;this._webixAdjustedZoneHTML=null;this._columns=[];this._pdfColumns=[];this._multiselect=!1}});GUI.Board.BoardTableAssociation=(class extends GUI.Board.BoardTable{declareColumns(){function n(n){return function(t){var i=n.List.getItem(t,!0),r;i!==null&&(r=DSRecord.Clone(i),r._selected?n.List.isBoardAllowed(n,DSDatabase.Instance.CurrentUser,"delete",i)&&n.deleteItem(i):n.List.isBoardAllowed(n,DSDatabase.Instance.CurrentUser,"add",r)&&n.addItem(r))}}this.declareColumn("_selected",null,1,"center",!1);this.on("onClick_selected",n(this));super.declareColumns()}constructor(n,t,i,r,u){super(n,t,i,r,u)}});GUI.Board.BoardHistory=(class extends GUI.Board.BoardTable{declareColumns(){this.declareColumn("User","HISTORY_USER",5,"center","Id");this.declareColumn("Date","HISTORY_DATE",5,"center");this.declareColumn("Nature","HISTORY_NATURE",5,"center","Id");this.declareColumn("Description","HISTORY_DESCRIPTION",10,"center","Id");this.declareColumn("Field","HISTORY_FIELD",10,null,"Id");this.declareColumn("OldValue","HISTORY_OLDVALUE",5,null,"Id");this.declareColumn("NewValue","HISTORY_NEWVALUE",5,null,"Id")}adjustWebix(n){var u,t,i,f;if(n!==undefined){super.adjustWebix(n);return}if(u=$(window).width(),t=-1,u<480?t=3:u<960&&(t=4),t!==this._nbColumnsToShow){i=[];switch(t){case 3:i=["User","Date","Nature"];break;case 4:i=["User","Date","Nature","Description"];break;default:i=null}this.debug("Resizing and show a part of columns : "+String.JSONStringify(i));for(f in this.Columns){var r=this.Columns[f],e=this.Webix.isColumnVisible(r.id),o=i===null?!0:i.indexOf(r.id)>=0;if(e!==o){if(e){this.hideColumn(r.id);continue}this.showColumn(r.id)}}this._nbColumnsToShow=t;(this._nbColumnsToShow<0&&!this.List.IsDetails||this._nbColumnsToShow>=0&&this.List.IsDetails)&&(this.List.setDetails(t<0),this.populateWebix())}super.adjustWebix()}constructor(n,t,i){super(n,t,"HISTORY_TITLE",i,GUI.Board.BOARD_NONE);this._nbColumnsToShow=-1;this.draw()}});GUI.Board.BoardTree=(class extends GUI.Board.Board{adjustWebix(){(super.adjustWebix(),this.Webix!==null)&&this.Webix.adjust()}constructor(n,t,i,r,u){super(n,t,"board_tree",i,r,u)}});GUI.Box={};GUI.Box.BOX_RC=!1;GUI.Box.Box=(class extends GUI.GUI{static get MAIN_PAGE(){return"body > dialog"}static get BUTTON_OK(){return"OK"}static get BUTTON_CANCEL(){return"CANCEL"}static get BUTTON_CLOSE(){return"CLOSE"}static get StackIndex(){return this._stackBoxIndex?this._stackBoxIndex++:this._stackBoxIndex=1,this._stackBoxIndex}static get Stack(){return this._stackBox||(this._stackBox={}),this._stackBox}static GetLastOpenedBox(){let t=null,i=0;for(var n in GUI.Box.Box.Stack)GUI.Box.Box.Stack[n]!==null&&i<GUI.Box.Box.Stack[n]._zIndex&&(i=GUI.Box.Box.Stack[n]._zIndex,t=GUI.Box.Box.Stack[n]);return t}get ContentZone(){return this.Component===null?null:this.Component.find("> div > .content")}get ButtonZone(){return this.Component===null?null:this.Component.find("> div > .buttons")}get IsOpened(){return super.IsOpened&&this._boxOpened&&this.Component!==null&&this._zIndex>0}set Title(n){if(this._title=Helper.Label(n),this.debug("Set title "+String.JSONStringify(this._title)),this.Component!==null){var t=this.Component.find("> div > .title"),i=Helper.Span(this._title);String.isEmptyOrWhiteSpaces(i)?t.hide():(t.html(i),t.show())}}get Title(){return this._title}set Message(n){if(this._message=Helper.Label(n),this.debug("Set message "+String.JSONStringify(this._message)),this.Component!==null){var t=this.Component.find("> div > .message"),i=Helper.Span(this._message);String.isEmptyOrWhiteSpaces(i)?t.hide():(t.html(i),t.show())}}set Error(n){if(this._error=n===null||n===undefined?null:typeof n=="string"?new Errors(n):Helper.IsLabel(n)?new Errors(n.label,n.parameters):n,this.debug("Set error "+String.JSONStringify(this._error)),this.Component!==null){if(this._error!==null){this.error(this._error.toString());let n=!1;for(let t in this._fields){let i=this._fields[t];if(i.Visible){let r=this._error.getField(t);i.Error=r;this._error.ignoreField(t);r!==null&&this._error.ignoreField("Copy"+t);n||r===null||(i.Panel!==null&&this.gotoCurrentPanel(this.getNavigationIndex(i.Panel)),i.focus(),n=!0)}}}else for(let n in this._fields)this._fields[n].Error=null;var t=this.Component.find("> div > .error");this._error===null||!this._error.summary||String.isEmptyOrWhiteSpaces(this._error.summary())?(this.ContentZone.hasClass("haserrors")===!0&&this.ContentZone.removeClass("haserrors"),t.hide()):(this.ContentZone.hasClass("haserrors")!==!0&&this.ContentZone.addClass("haserrors"),t.html(this._error.summary()),t.show())}}set Mode(n){this._mode=n}get Mode(){return this._mode}get CurrentPanel(){return this.Component===null?null:this._currentPanel?this._currentPanel:this.ContentZone}get Fields(){return this._fields}get Boards(){return this._boards}get Buttons(){return this._buttons}get Value(){return null}set OnClosed(n){this._onClosed=n}destructor(){var n,t,i;super.destructor();for(n in this._fields)this._fields[n].destructor();this._fields={};for(t in this._boards)this._boards[t].destructor();this._boards={};for(i in this._buttons)this._buttons[i].destructor();this._buttons={};this._focus=[]}declareField(n){if(n!==undefined&&n!==null)return this.debug("Declare the field '"+n.Name+"'"),this._fields[n.Name]=this.addFocus(n),n.Panel=this._currentPanelName,n}getField(n){if(n===undefined||n===null)return null;var t=this._fields[n];return t===null||t===undefined?null:t}declareBoard(n){if(n!==undefined&&n!==null)return this.debug("Declare the board '"+n.Name+"'"),this._boards[n.Name]=this.addFocus(n),n.Panel=this._currentPanelName,n}getBoard(n){if(n===undefined||n===null)return null;var t=this._boards[n];return t===null||t===undefined?null:t}clearButtons(){this.debug("Cleanning up all buttons ...");this._buttons={}}declareButton(n,t,i){this.debug("Declare the button '"+n+"', '"+String.JSONStringify(t)+"'");var r=this.addFocus(new GUI.Button.Button(this,n,null,t,i));return this._buttons[r.Name]=r,r}getButton(n){if(n===undefined||n===null)return null;var t=this._buttons[n];return t===null||t===undefined?null:t}drawButton(n){n.show()}drawContent(n){n.hide()}draw(){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(function(){n.IsOpened&&(n.debug("Resizing window ..."),n.resize())},100))}}if(this.Component===null){var n="<box id='"+this.Name.toString().toLowerCase()+"' class='"+this.Name.toString().toLowerCase()+"' style='display:none;'>";n+="<div>";n+="<div class='title'><\/div>";n+="<div class='message'><\/div>";n+="<div class='error'><\/div>";n+="<div class='content'><\/div>";n+="<div class='buttons'><\/div>";n+="<\/div>";n+="<\/box>";super.draw(n);this.drawContent(this.ContentZone);this.drawButton(this.ButtonZone);this.Component.remove();Language.Manager.Instance.addComponent(this.Component);$(window).on("resize",t(this))}}checkValue(){return!0}isFieldVisible(n,t,i){return i===null||!i._list?!0:n!==i._list.column}isFieldReadonly(){return!1}isBoardVisible(){return!0}isBoardReadonly(){return!1}isPanelVisible(){return!0}isPanelReadonly(){return!1}onButtonOK(){this.verbose("onButtonOK");let n=this.getButton(GUI.Box.Box.BUTTON_OK);n!==null&&n.onMouseClick()}onButtonCancel(){this.verbose("onButtonCancel");let n=this.getButton(GUI.Box.Box.BUTTON_CANCEL);n!==null&&n.onMouseClick()}refresh(){super.refresh();this.Component!==null&&(this.Title=this._title,this.Message=this._message,this.Error=this._error);this._panels===null||this._navigationPanels===null?this.refreshPanel():this.gotoCurrentPanel();for(var n in this._buttons)this._buttons[n].refresh()}resize(){}onOpen(){function u(n,t){return function(){n.setFocus(t)}}function f(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:if(GUI.Box.BOX_RC){GUI.Box.BOX_RC=!1;return}return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1}}}var n,t,i,r;if(super.onOpen(),this._panels!==null)for(n in this._panels){this._panels[n].on("focus",u(this,this._panels[n]));this._panels[n].on("keydown",f(this,this._panels[n]))}for(t in this._fields)this._fields[t].onOpen();for(i in this._boards)this._boards[i].onOpen();for(r in this._buttons)this._buttons[r].onOpen();this._boxOpened=!0}open(){if(!this.IsOpened){this.debug("Open the box");this._zIndex=1;for(var n in GUI.Box.Box.Stack)GUI.Box.Box.Stack[n]!==null&&this._zIndex<GUI.Box.Box.Stack[n]._zIndex&&(this._zIndex=GUI.Box.Box.Stack[n]._zIndex);this._zIndex===1&&$(GUI.Box.Box.MAIN_PAGE).show();this._zIndex++;GUI.Box.Box.Stack[this._boxIndex]=this;this.Component.css("z-index",this._zIndex.toString());$(GUI.Box.Box.MAIN_PAGE).append(this.Component);this._navigationPanelHidden=[];this._navigationPanelIndex=0;this.onOpen();this.refresh();this.Component.show()}}onClose(){this.onChangeFocus(null);if(this._panels!==null)for(var n in this._panels)this._panels[n].off("focus keydown");super.onClose()}close(){var n,t,i,r;if(this.IsOpened){this.debug("Close the box");this.Component.css("z-index","");this.Component.hide();delete GUI.Box.Box.Stack[this._boxIndex];this._zIndex=-1;this._boxOpened=!1;for(n in this._fields)this._fields[n].onClose();for(t in this._boards)this._boards[t].onClose();for(i in this._buttons)this._buttons[i].onClose();this.onClose();this.Component.remove();this._onClosed!==null&&this._onClosed();for(r in GUI.Box.Box.Stack)if(GUI.Box.Box.Stack[r]!==null)return;$(GUI.Box.Box.MAIN_PAGE).hide()}}declarePanel(n,t){var i=null;if(this.Component!==null&&n!==undefined&&n!==null)return this._panels===null&&(this.ContentZone.addClass("panels"),this._navigationPrevious=$("<panel class='navigation left'><\/panel>"),this.ContentZone.append(this._navigationPrevious[0]),this._navigationMiddle=$("<panel class='main'><\/panel>"),this.ContentZone.append(this._navigationMiddle[0]),this._navigationNext=$("<panel class='navigation right'><\/panel>"),this.ContentZone.append(this._navigationNext[0]),this._panels={}),this.debug("Declare the panel '"+n+"'"),i=$("<panel id='"+n+"'><\/panel>"),this._navigationMiddle.append(i[0]),this._panels[n]=this.addFocus(i),t&&i.addClass(t),this._currentPanelName=n,this._currentPanel=i,this._navigationPanels===null&&(this._navigationPanels=[[]]),this._navigationPanels[0].push(n),i}startBlock(n){if(this.CurrentPanel!==null){this._blocks.push(this.CurrentPanel);let t=$("<div"+(n===null||n===undefined?"":" class='"+n+"'")+"><\/div>");this.CurrentPanel.append(t);this._currentPanel=t}}endBlock(){this.CurrentPanel!==null&&this._blocks.length!==0&&(this._currentPanel=this._blocks.pop())}declareNavigationPanels(n){var t=null,i,r,u;if(this._navigationPanels=null,this._panels!==null){if(n===null||n===undefined){this._navigationPanels=[[]];for(t in this._panels)this._navigationPanels[0].push(t);return}if(typeof n=="string"){if(t=this._panels[n],t===null||t===undefined)return;this._navigationPanels=[[n]];return}if(Array.isArray(n)){this._navigationPanels=[];for(i in n)if(Array.isArray(n[i])){r=[];for(u in n[i])t=this._panels[n[i][u]],t!==null&&t!==undefined&&r.push(n[i][u]);this._navigationPanels.push(r)}else t=this._panels[n[i]],t!==null&&t!==undefined&&this._navigationPanels.push([n[i]])}}}gotoPreviousPanel(){if(this._navigationPanels!==null&&this._navigationPanelIndex!==0)for(this._navigationPanelIndex--;!this.gotoCurrentPanel()&&this._navigationPanelIndex>0;)this._navigationPanelIndex--}getNavigationIndex(n){if(n===null)return-1;for(let t=0;t<this._navigationPanels.length;t++)if(this._navigationPanels[t].indexOf(n)>=0&&this._navigationPanelHidden.indexOf(n)<0)return t;return-1}gotoCurrentPanel(n){function s(n){return function(){n.gotoPreviousPanel()}}function h(n){return function(){n.gotoNextPanel()}}var t,u;if(this._panels===null||this._navigationPanels===null)return this._navigationPrevious!==null&&this._navigationPrevious!==undefined&&this._navigationPrevious.hide(),this._navigationNext!==null&&this._navigationNext!==undefined&&this._navigationNext.hide(),!0;n!==null&&n!==undefined&&(this._navigationPanelIndex=n);this._navigationPanelIndex<0&&(this._navigationPanelIndex=0);this._navigationPanelIndex>=this._navigationPanels.length&&(this._navigationPanelIndex=this._navigationPanels.length-1);let f=DSDatabase.Instance.CurrentUser,e=this.Value,o=!1;for(t in this._panels)(u=this._panels[t],u!==null&&u!==undefined)&&(this._navigationPanels[this._navigationPanelIndex].indexOf(t)<0||this._navigationPanelHidden.indexOf(t)>=0||!this.isPanelVisible(t,f,e)?u.hide():(o=!0,u.show(),this.refreshPanel(t)));let i=this._navigationPanelIndex===0;if(!i){i=!0;for(let n=0;n<this._navigationPanelIndex&&i;n++)for(let t=0;t<this._navigationPanels[n].length&&i;t++)i=!this.isPanelVisible(this._navigationPanels[n][t],f,e)}if(i)this._navigationPrevious.off("click"),this._navigationPrevious.addClass("first");else{this._navigationPrevious.off("click").on("click",s(this));this._navigationPrevious.removeClass("first")}let r=this._navigationPanelIndex>=this._navigationPanels.length-1;if(!r){r=!0;for(let n=this._navigationPanelIndex+1;n<this._navigationPanels.length&&r;n++)for(let t=0;t<this._navigationPanels[n].length&&r;t++)r=!this.isPanelVisible(this._navigationPanels[n][t],f,e)}if(r)this._navigationNext.off("click"),this._navigationNext.addClass("last");else{this._navigationNext.off("click").on("click",h(this));this._navigationNext.removeClass("last")}this._navigationPanels.length<=1?(this._navigationPrevious.hide(),this._navigationNext.hide()):(this._navigationPrevious.show(),this._navigationNext.show());for(let n=0;n<this._focus.length;n++){let t=this._focus[n];if(t.length!==1&&this.isFocusable(t)&&!(this._navigationPanels[this._navigationPanelIndex].indexOf(t.Panel)<0)){this.setFocus(t);break}}return o}gotoNextPanel(){if(this._navigationPanels!==null&&!(this._navigationPanelIndex>=this._navigationPanels.length-1))for(this._navigationPanelIndex++;!this.gotoCurrentPanel()&&this._navigationPanelIndex<this._navigationPanels.length;)this._navigationPanelIndex++}showPanel(n){n!==null&&n!==undefined&&(this._navigationPanelHidden.indexOf(n)<0||this._navigationPanelHidden.splice(this._navigationPanelHidden.indexOf(n),1))}refreshPanel(n){var f,i,e,t;let r=DSDatabase.Instance.CurrentUser,u=this.Value;n=n===null||n===undefined?null:n;for(f in this._fields)(i=this._fields[f],n===null||i.Panel===n)&&(i.Visible=this.isFieldVisible(i.Name,r,u)&&(i.Panel===null||i.Panel!==null&&this.isPanelVisible(i.Panel,r,u)),i.Readonly=this.isFieldReadonly(i.Name,r,u)||i.Panel!==null&&this.isPanelReadonly(i.Panel,r,u),i.refresh());for(e in this._boards)(t=this._boards[e],n===null||t.Panel===n)&&(t.Visible=this.isBoardVisible(t.Name,r,u)&&(t.Panel===null||t.Panel!==null&&this.isPanelVisible(t.Panel,r,u)),t.Readonly=this.isBoardReadonly(t.Name,r,u)||t.Panel!==null&&this.isPanelReadonly(t.Panel,r,u),t.refresh(),t.adjustWebix())}hidePanel(n){n!==null&&n!==undefined&&(this._navigationPanelHidden.indexOf(n)>=0||this._navigationPanelHidden.push(n))}onChangeFocus(n){if(this._focusLastIndex!==null){let n=this._focus[this._focusLastIndex];n instanceof GUI.Field.Field&&n.onFocusOut();this._focusLastIndex=null}return n===null||n===undefined?!1:n.focus()?(n.Name!==null&&n.Name!==undefined?this.verbose("Focus on "+n.Name+" ["+this._focusIndex+"]"):n.length===1?this.verbose("Focus on "+n.attr("id")+" ["+this._focusIndex+"]"):this.verbose("Focus on "+this._focusIndex),this._focusLastIndex=this._focusIndex,n instanceof GUI.Field.Field&&n.onFocusIn(),!0):!1}clearFocus(){this.onChangeFocus(null);for(let n in this._focus){let t=this._focus[n];if(t!==null&&t!==undefined){if(t instanceof GUI.GUI){t.TabIndex=null;continue}if(typeof t=="string"&&(t=this.Component.find(t)),t!==null&&t!==undefined&&t.length===1){t.attr("tabindex",null);continue}}}this._focus=[];this._focusIndex=0;this._focusLastIndex=null}getFocusItem(n){return n===null||n===undefined?null:n instanceof GUI.GUI?n:typeof n=="string"?this._fields[n]!==null&&this._fields[n]!==undefined?this._fields[n]:this._boards[n]!==null&&this._boards[n]!==undefined?this._boards[n]:(n=this.Component.find(n),n!==null&&n!==undefined&&n.length===1)?n:null:n.length===1?n:null}addFocus(n){return(n=this.getFocusItem(n),n===null||n===undefined)?null:n instanceof GUI.GUI?(n.TabIndex=this._focus.length,this._focus.push(n),n):n!==null&&n!==undefined&&n.length===1?(n.attr("tabindex",this._focus.length),this._focus.push(n),n):null}firstFocus(){this._focusIndex=-1;this.nextFocus()}isFocusable(n){return(n=this.getFocusItem(n),n===null||n===undefined)?!1:n instanceof GUI.GUI?n.Visible&&!n.Readonly:n!==null&&n!==undefined&&n.length===1?n.is(":visible"):!1}previousFocus(){let n=0,t=this._navigationPanelIndex;while(n<2){for(this._focusIndex--,this._focusIndex<0&&(this._focusIndex=this._focus.length-1);this._focusIndex>=0;this._focusIndex--){let n=this._focus[this._focusIndex];if(this.isFocusable(n)){if(n.length===1&&this._focusIndex>0&&n[0].tagName==="PANEL"){let i=this._focusIndex-1,t=this._focus[i];if(t.length===undefined){let r=t.Panel;for(;i>=0;i--){if(t=this._focus[i],t.Panel===null||t.Panel===undefined||t.Panel!==r)break;if(this.isFocusable(t)){n=t;this._focusIndex=i;break}}}}else if(n.length===1&&this._focusIndex===0&&n[0].tagName==="PANEL")break;if(n.Panel!==null&&n.Panel!==undefined){let i=this.getNavigationIndex(n.Panel);t!==i&&this.gotoCurrentPanel(i);t=i}if(this.onChangeFocus(n))return}}n++}}nextFocus(){let n=0,t=this._navigationPanelIndex;while(n<2){for(this._focusIndex>=this._focus.length&&(this._focusIndex=-1),this._focusIndex++;this._focusIndex<this._focus.length;this._focusIndex++){let n=this._focus[this._focusIndex];if(this.isFocusable(n)){if(n.Panel!==null&&n.Panel!==undefined){let i=this.getNavigationIndex(n.Panel);t!==i&&this.gotoCurrentPanel(i);t=i}if(n.length===1&&n[0].tagName==="PANEL"){let t=n.attr("id");for(let i=this._focusIndex+1;i<this._focusIndex<this._focus.length;i++){let r=this._focus[i];if(r.Panel===null||r.Panel===undefined||r.Panel!==t)break;if(this.isFocusable(r)){n=r;this._focusIndex=i;break}}}if(this.onChangeFocus(n))return}}n++}}setFocus(n){if(n=this.getFocusItem(n),n!==null&&this.isFocusable(n)){let i=this.getFocusItem(this._focus[this._focusIndex]);if(i!==null&&this.isFocusable(i)){if(n instanceof GUI.GUI&&i instanceof GUI.GUI&&n.Name===i.Name)return;if(n.length===1&&i.length===1&&n[0]===i[0])return}let t=null;if(n.length===1?t=parseInt(n.attr("tabindex")):n instanceof GUI.GUI&&(t=n.TabIndex),t!==null&&t!==undefined&&!(t>=this._focus.length)&&t!==this._focusIndex){this._focusIndex=t;this.onChangeFocus(n)}}}arrowFocus(n,t){let i=this.getFocusItem(this._focus[this._focusIndex]);if(i!==null&&i!==undefined){i instanceof GUI.GUI&&(i=i.Component);let f=i.offset().left,e=i.offset().top,u=this._navigationPanelIndex,r=this._focusIndex;for(r+=n;0<=r&&r<this._focus.length;r+=n){let n=this._focus[r];if(i=this.getFocusItem(n),this.isFocusable(i)){i instanceof GUI.GUI&&(i=i.Component);let o=i.offset().left,s=i.offset().top;if(t(f,e,o,s)){if(n.Panel!==null&&n.Panel!==undefined){let t=this.getNavigationIndex(n.Panel);u!==t&&this.gotoCurrentPanel(t);u=t}if(this.onChangeFocus(n))return}}}}}leftFocus(){this.arrowFocus(-1,function(n,t,i,r){return n>i&&t===r})}upFocus(){this.arrowFocus(-1,function(n,t,i,r){return n===i&&t>r})}downFocus(){this.arrowFocus(1,function(n,t,i,r){return n===i&&t<r})}rightFocus(){this.arrowFocus(1,function(n,t,i,r){return n<i&&t===r})}constructor(n,t){super("box",GUI.Box.Box.MAIN_PAGE,n,t);this._boxIndex=GUI.Box.Box.StackIndex;this._boxOpened=!1;this._title=null;this._message=null;this._error=null;this._mode=null;this._focus=[];this._focusIndex=0;this._focusLastIndex=null;this._panels=null;this._fields={};this._boards={};this._currentPanelName=null;this._currentPanel=null;this._navigationPrevious=null;this._navigationMiddle=null;this._navigationNext=null;this._navigationPanels=null;this._navigationPanelIndex=0;this._navigationPanelHidden=[];this._onClosed=null;this._buttons={};this._blocks=[];this._zIndex=-1}});GUI.Box.BoxChoice=(class extends GUI.Box.Box{set Choices(n){function u(n,t,i){return function(){this.debug("Select the choice '"+t.toString()+"'");try{i()}catch(r){n.exception("Unable to select the choice '"+t.toString()+"' due to an exception",r)}n.close()}}var r=this.ContentZone,i,t;if(r!==null&&(r.empty(),n!==null&&n!==undefined)){this.clearFocus();this.clearButtons();for(i in n)if(t=n[i],t!==null&&t!==undefined&&t.label!==null&&t.label!==undefined&&t.fn!==null&&t.fn!==undefined){this.debug("Choice ("+i.toString()+") -> "+Language.Manager.Instance.interpolation(Helper.Label(t.label)));let r=this.declareButton("Choice_"+i.toString(),t.label);r.Action=u(this,i,t.fn)}this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}}drawContent(n){super.drawContent(n);n.show()}open(){super.open();this.firstFocus()}constructor(n){super(n,"box_choice");this.draw()}static BoxChoices(n,t,i){this._boxChoices||(this._boxChoices=new GUI.Box.BoxChoice("choices"));this._boxChoices.Title=n;this._boxChoices.Message=t;this._boxChoices.Choices=i;this._boxChoices.Error=null;this._boxChoices.open()}});GUI.Box.BoxInputDigit=(class extends GUI.Box.Box{set Label(n){this._label=Helper.Label(n)}set Format(n){this._digits.Format=n}get Format(){return this._digits.Format}set Digits(n){this._digits=typeof n=="string"?new Digits.Digits(n):n===null||n===undefined?new Digits.Digits:n}set Align(n){this._align=n==="left"||n==="center"||n==="right"?n:"right"}set Value(n){this._digits.Value=n}get Value(){return this._digits.Value}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}destructor(){super.destructor();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null)}addKey(n){if(this._digits.addKey(n),this.refresh(),this._calendar!==null){let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){let i=["7","8","9","4","5","6","1","2","3"],t="";for(let n=0;n<i.length;n++)t+="<div class='key' key='"+i[n]+"'><div>"+String.encode(i[n])+"<\/div><\/div>";t+="<div class='key undo' key='undo'><\/div>";t+="<div class='key' key='0'><div>0<\/div><\/div>";t+="<div class='key next minus' key='next'><\/div>";t+="<div class='key value minus' key='minus'>"+String.encode("-")+"<\/div>";this._content=n;this._content.append("<field class='input field_input input_digit'><div class='label'><\/div><div class='value'><div class='field' tabindex=0><\/div><\/div><div class='unit'><\/div><div class='icon'><\/div><\/field > <div id='keyboard'>"+t+"<\/div><div id='calendar'><\/div>");this._content.show()}drawCalendar(){function i(n){return function(t){n._digits.setDate(t.getDate(),t.getMonth()+1,1900+t.getYear());n.refresh()}}if(this._calendar!==null&&(this._calendar.destructor(),this._calendar=null),this._digits instanceof Digits.Datetime){let n=this._digits.WebixType;if(n!==null){this._calendar=new webix.ui({view:"calendar",type:n==="day"?undefined:n,container:this._content.find("> #calendar")[0],weekHeader:n==="day",weekNumber:n==="day",calendarDateFormat:this._digits.WebixFormat,on:{onDateSelect:i(this)}});let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}}onOpen(){function n(n){return function(){n.addKey($(this).attr("key"))}}function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 8:t.preventDefault();n.addKey("undo");return;case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:t.preventDefault();n.onButtonOK();return;case 27:t.preventDefault();n.onButtonCancel();return;case 46:return t.preventDefault(),n.addKey("raz"),!1}}}function i(n){return function(t){let i=t.which||t.keyCode;i<32||n.addKey(String.fromCharCode(i))}}function r(n){return function(){n._digits.RAZ();n.refresh()}}super.onOpen();this.clearFocus();this.addFocus("field > .value > .field");this.addFocus(this.getButton(GUI.Box.Box.BUTTON_OK));this.addFocus(this.getButton(GUI.Box.Box.BUTTON_CANCEL));this.Component.find("#keyboard > .key").on("click",n(this));this.Component.find("field > .value > .field").on("keydown",t(this));this.Component.find("field > .value > .field").on("keypress",i(this));this.Component.find("field > .icon").on("click",r(this));this._digits.selectAll()}open(){function n(n){return function(t,i){n._calendar!==null&&i===undefined&&n.drawCalendar()}}super.open();this.drawCalendar();this._languageListener=Language.Manager.Instance.addListener(n(this))}onClose(){super.onClose();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null);this.Component.find("#keyboard > .key").off("click");this.Component.find("field > .value > .field").off("keydown keypress");this.Component.find("field > .icon").off("click")}refresh(){if(super.refresh(),this.Component!==null){let i=this._digits.toString();this.Component.find("field > .value > .field").html(String.encode(i));i=Helper.Span(this._label);var r=this.Component.find("field > .label");String.isEmptyOrWhiteSpaces(i)?(r.html(""),r.hasClass("hide")||r.addClass("hide")):r.html(i);let n=this.Component.find("#keyboard > .next"),o=this._digits.NextTokenFix;String.isEmptyOrWhiteSpaces(o)?(n.hasClass("empty")||n.addClass("empty"),this.Component.find("#keyboard > .next").html("")):(n.hasClass("empty")&&n.removeClass("empty"),this.Component.find("#keyboard > .next").html(String.encode(o)));this._digits.AllowNegativeValue?(n.hasClass("minus")||n.addClass("minus"),this.Component.find("#keyboard > .key.value.minus").show()):(n.hasClass("minus")&&n.removeClass("minus"),this.Component.find("#keyboard > .key.value.minus").hide());let u=this.Component.find("#keyboard > .undo");this._digits.HasUndo?u.hasClass("empty")&&u.removeClass("empty"):u.hasClass("empty")||u.addClass("empty");let t=this.Component.find("field > .unit");if(t.length>0){let n=String.encode(this._unit);String.isEmptyOrWhiteSpaces(n)?t.hasClass("hide")||t.addClass("hide"):(t.hasClass("hide")&&t.removeClass("hide"),t.html(n))}let s=this.Component.find("field > .value > .field");s.css("text-align",this._align);let f=this.Component.find("#calendar"),e=this.Component.find("#keyboard");this._digits.IsCalendar?(f.hasClass("hide")&&f.removeClass("hide"),e.hasClass("hide")||e.addClass("hide")):(f.hasClass("hide")||f.addClass("hide"),e.hasClass("hide")&&e.removeClass("hide"));this.firstFocus()}}constructor(n,t){super(n,"box_inputdigit");this._content=null;this._label=null;this._unit=null;this._align="right";this._calendar=null;this._languageListener=null;this._notRefresh=!1;this._digits=typeof t=="string"?new Digits.Digits(t):t===null||t===undefined?new Digits.Digits:t;this.draw()}static Digit(n,t,i,r,u,f,e){this._dialogBoxDigit||(this._dialogBoxDigit=new GUI.Box.BoxInputDigit("digits"));this._dialogBoxDigit.Title=n;this._dialogBoxDigit.Label=t;this._dialogBoxDigit.Unit=i;this._dialogBoxDigit.Digits=r;this._dialogBoxDigit.Align=u;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_OK).Action=f;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=f!==null&&f!==undefined;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_CANCEL).Action=e;this._dialogBoxDigit.open()}});GUI.Box.BoxInputFile=(class extends GUI.Box.Box{static get ID(){return this._inputFileId?this._inputFileId++:this._inputFileId=1,this._inputFileId}get Value(){return this._value}get FileZone(){return this.Component.find(".content > #file")}drawButton(n){function t(n){return function(t){n.deleteFile(t)}}super.drawButton(n);this.addFocus(this.FileZone);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL").Action=t(this)}drawContent(n){super.drawContent(n);n.append('<input type="file" class="file" id="UploadFile_'+this._index.toString()+'" accept="'+this._extensions+'" />');n.append("<div id='file'><\/div>");n.append("<div id='filename'><\/div>");n.show()}onOpen(){function n(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 13:case 32:return t.preventDefault(),n.onMouseClick(),!1}}}function t(n){return function(){n.sendFiles([{name:this.value,file:this.files[0]}])}}function i(n){return function(){n.Component.find("#UploadFile_"+n._index.toString()).click()}}function r(){return function(n){n.preventDefault();n.stopPropagation()}}function u(n){return function(){Hub.Instance.IsRunning&&n.FileZone.addClass("is-dragover")}}function f(n){return function(){n.FileZone.removeClass("is-dragover")}}function e(n){return function(t){var i=[];for(let n=0;n<t.originalEvent.dataTransfer.files.length;n++)i.push({name:t.originalEvent.dataTransfer.files[n].name,file:t.originalEvent.dataTransfer.files[n]});n.sendFiles(i)}}super.onOpen();this.FileZone.on("keydown",n(this));this.FileZone.removeClass("full");this.Component.find("#filename").html("");this.Component.find("#UploadFile_"+this._index.toString()).val("");this._value=null;this.Component.find("#UploadFile_"+this._index.toString()).off("change").on("change",t(this));this.FileZone.click(i(this));this.FileZone.on("drag dragstart dragend dragover dragenter dragleave drop",r(this)).on("dragover dragenter",u(this)).on("dragleave dragend drop",f(this)).on("drop",e(this))}open(){super.open();this.firstFocus()}onClose(){super.onClose();this.FileZone.off("drag dragstart dragend dragover dragenter dragleave drop keydown")}onMouseClick(){this.Readonly||this.Component===null||this.FileZone.click()}deleteFile(n){if((n===null||n===undefined)&&(n=this._value),n!==null&&n!==undefined){if(Hub.Instance.IsRunning)for(let t=0;t<n.length;t++){let i=n[t];try{$.ajax({type:"POST",url:"/Administration/File/Remove",data:String.JSONStringify({id:i.id.toString(),filename:i.filename}),contentType:"application/json",processData:!1})}catch(t){this.exception("Unable to remove the file",t)}}this._value=null;this.FileZone.removeClass("full");this.Component.find("#filename").html("")}}sendFiles(n){function u(n){return function(t){t=JSON.parse(t);n.FileZone.hasClass("full")||n.FileZone.addClass("full");let i="";for(let n=0;n<t.files.length;n++)i=i+(i===""?"":"<br />")+String.encode(t.files[n].filename);n.Component.find("#filename").html(i);n._value=t.files;GUI.Box.Progress.Stop()}}function f(n){return function(t){if(n.FileZone.removeClass("full"),n.Component.find("#UploadFile_"+n._index.toString()).val(""),n._value=null,GUI.Box.Progress.Stop(),t.status===500){GUI.Box.Message.Error("ERROR","ERR_UPLOAD_TOO_BIG");return}if(!Hub.Instance.IsRunning){GUI.Box.Message.Error("ERROR","ERR_UPLOAD_BROKEN");return}GUI.Box.Message.Error("ERROR",new Errors("ERR_UPLOAD_FAILED",[t.status.toString()]))}}var i,t,r;if(Hub.Instance.IsRunning){i=this._extensions.split(",");t=[];for(let r=0;r<n.length;r++){let f=n[r].name.match(/\.([^\.]+)$/)[1],u=!1;for(let n=0;n<i.length;n++)if(i[n].toUpperCase()==="."+f.toUpperCase()){u=!0;break}u||t.push(n[r].name)}if(t.length>0){GUI.Box.Message.Error("ERROR",Helper.Label("ERR_UPLOAD_EXTENSION",[t.join(", ")]));return}r=new FormData;for(let t=0;t<n.length;t++)r.append(n[t].name,n[t].file);GUI.Box.Progress.Start();GUI.Box.Progress.SetStatus(0,1,"MSG_LOADING");this.deleteFile();$.ajax({type:"POST",url:"/Administration/File/Upload",contentType:!1,processData:!1,data:r,xhr:function(){let n=$.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",function(n){n.lengthComputable&&GUI.Box.Progress.SetStatus(n.loaded,n.total,"MSG_LOADING")},!1),n},success:u(this),error:f(this)})}}constructor(n,t){super(n,"box_inputfile");this._index=GUI.Box.BoxInputFile.ID;this._extensions=t?t:".gif,.png,.jpg,.bmp,.svg,.tif,.jpeg,.txt,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx";this._value=null;this.draw()}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxInputFile("inputfile")),this._instance}static Open(n,t,i){GUI.Box.BoxInputFile.Instance.Title=n;GUI.Box.BoxInputFile.Instance.Message=t;GUI.Box.BoxInputFile.Instance.Error=null;GUI.Box.BoxInputFile.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=i;GUI.Box.BoxInputFile.Instance.open()}});GUI.Box.BoxInputText=(class extends GUI.Box.Box{set AllowRC(n){this._allowRC=n!==undefined&&n!==null&&n}get TextZone(){return this._content.find("textarea")}set Value(n){(this._value=String.convertValue(n),this.Component!==null)&&(this.TextZone.val(this._value===null||this._value===undefined?"":this._value.toString()),this.resize())}get Value(){return this.Component===null?this._value:this.TextZone.val()}drawButton(n){super.drawButton(n);this.addFocus(this.TextZone);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(function(){n.resize()},100))}}super.drawContent(n);this._content=n;this._content.append("<textarea><\/textarea>");this._content.show();$(window).on("resize",t(this))}onOpen(){function n(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:if(n._allowRC){GUI.Box.BOX_RC=!0;return}return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1}}}function t(){return function(){$(this).select()}}function i(n){return function(){n.resize()}}super.onOpen();this.TextZone.on("keydown",n(this));this.TextZone.on("focus",t(this));this.TextZone.on("change keyup paste",i(this))}open(){super.open();this.firstFocus()}onClose(){this.TextZone.off("change keyup paste keydown")}refresh(){super.refresh();this.Value=this._value}resize(){var t,n;this.Component!==null&&(t=this.TextZone.height(),this.TextZone.height(1),n=this.TextZone[0].scrollHeight,this.TextZone.height(n>1?n:t))}constructor(n){super(n,"box_inputtext");this._allowRC=!1;this._content=null;this._value=null;this.draw()}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxInputText("inputtext")),this._instance}static Open(n,t,i,r,u){GUI.Box.BoxInputText.Instance.Title=n;GUI.Box.BoxInputText.Instance.Message=t;GUI.Box.BoxInputText.Instance.Value=i;GUI.Box.BoxInputText.Instance.AllowRC=r;GUI.Box.BoxInputText.Instance.Error=null;GUI.Box.BoxInputText.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=u;GUI.Box.BoxInputText.Instance.open()}});GUI.Box.Message=(class{static Message(n,t,i){this._dialogBoxMessage||(this._dialogBoxMessage=new GUI.Box.Box("message","box_message"),this._dialogBoxMessage.draw(),this._dialogBoxMessage.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxMessage.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxMessage.Title=n;this._dialogBoxMessage.Message=t;this._dialogBoxMessage.getButton(GUI.Box.Box.BUTTON_OK).Action=i;this._dialogBoxMessage.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=i!==null&&i!==undefined;this._dialogBoxMessage.open()}static Information(n,t){this._dialogBoxInformation||(this._dialogBoxInformation=new GUI.Box.Box("message","box_information"),this._dialogBoxInformation.draw(),this._dialogBoxInformation.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxInformation.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxInformation.Title="INFORMATION";this._dialogBoxInformation.Message=n;this._dialogBoxInformation.getButton(GUI.Box.Box.BUTTON_OK).Action=t;this._dialogBoxInformation.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=t!==null&&t!==undefined;this._dialogBoxInformation.open()}static Warning(n,t){this._dialogBoxWarning||(this._dialogBoxWarning=new GUI.Box.Box("message","box_warning"),this._dialogBoxWarning.draw(),this._dialogBoxWarning.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxWarning.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxWarning.Title="WARNING";this._dialogBoxWarning.Message=n;this._dialogBoxWarning.getButton(GUI.Box.Box.BUTTON_OK).Action=t;this._dialogBoxWarning.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=t!==null&&t!==undefined;this._dialogBoxWarning.open()}static Error(n,t){this._dialogBoxError||(this._dialogBoxError=new GUI.Box.Box("error","box_error"),this._dialogBoxError.draw(),this._dialogBoxError.declareButton(GUI.Box.Box.BUTTON_OK));this._dialogBoxError.Title=n;this._dialogBoxError.Error=t;this._dialogBoxError.open()}static Reload(n,t){let i=new GUI.Box.Box("error","box_reload");i.Title="RELOAD";i.Error=n;i.draw();i.declareButton("Reload","BTN_RELOAD",t);i.open()}});GUI.Box.Progress=(class{static Start(){$("body > .progress").show();Logger.Instance.debug("Progress","Start progress")}static SetStatus(n,t,i){let r=$("body > .progress > div > #bar"),u=$("body > .progress > div > #progressStatus");(n===null||n===undefined)&&(n=r.val()+1);r.val(n);t!==null&&t!==undefined&&r.attr("max",t);i!==null&&i!==undefined&&u.html(Helper.Span(i));Logger.Instance.debug("Progress","Progress ("+n.toString()+"/"+r.attr("max")+" - "+u.html()+")")}static Stop(){$("body > .progress").hide();Logger.Instance.debug("Progress","End progress")}});GUI.Box.BoxRecord=(class extends GUI.Box.Box{static get ROOT_DIRECTORY(){return URL_ROOT+"Content/Images/Areas/"}static get MODE_CREATE(){return"Create"}static get MODE_READ(){return"Read"}static get MODE_UPDATE(){return"Update"}static get MODE_DELETE(){return"Delete"}static CACHE_DIALOG_BOX(n,t,i){if(this._cacheDialogBox||(this._cacheDialogBox={}),n===null||n===undefined)return null;var u=n+(t===null||t===undefined?"":"."+t),r=this._cacheDialogBox[u];if(r!==null&&r!==undefined)for(let n=0;n<r.length;n++)if(!r[n].IsOpened||t!==null&&t!==undefined)return r[n].List=i,r[n].OnClosed=null,r[n];try{r=eval(n+"Record.Box")}catch(f){try{r=eval(n+".Box")}catch(f){return null}}return r?(r=new r,r.List=i,r.Commit=window.administration===undefined,(this._cacheDialogBox[u]===null||this._cacheDialogBox[u]===undefined)&&(this._cacheDialogBox[u]=[]),this._cacheDialogBox[u].push(r),r):null}get Value(){var i=DSRecord.Clone(this._currentRecord);for(var t in this.Fields)this._currentRecord!==null&&(this._currentRecord._list&&t===this._currentRecord._list.column||(i[t]=DSDatabase.Instance.convertValue(this._table,t,this.Fields[t].Value,!1)));let n=this._list.SequenceProperty;return n!==null&&n!==undefined&&this.Fields[n]!==null&&this.Fields[n]!==undefined&&this._noSequence&&(i[n]=null),i}set Error(n){super.Error=n;this._panels===null||this._navigationPanels===null?this.refreshPanel():this.gotoCurrentPanel()}set Commit(n){this._commit=n!==null&&n!==undefined&&n}get Table(){return this._table}get List(){return this._list}set List(n){this._list=n?n:new List.ListRecord(this._table)}get LoopOnCreate(){return this._loopOnCreate}set LoopOnCreate(n){this._loopOnCreate=n!==null&&n!==undefined&&n===!0}get NewRecord(){return this._list.NewItem}get CurrentRecord(){return this._currentRecord}get OriginRecord(){return this._originRecord}declareField(n){if(n!==undefined&&n!==null){if(n instanceof GUI.Field.Field)return super.declareField(n);if(typeof n=="string"){let i=DSDatabase.Instance.getColumn(this._table,n),r=DSDatabase.Instance.getColumnLabel(this._table,n),s=null,u=null,h=null,f=null,e=null,o=null;if(i===null)return super.declareField(new GUI.Field.FieldInput(this,n,r));let t=null;switch(i.Type){case"Int32":if(o=i.ForeignKey,o!==null){u=null;try{u=eval(o.Table+"Record.List")}catch(c){u=null}u=u?new u(!1):new List.ListRecord(o.Table,!1);DSDatabase.Instance.getColumn(o.Table,"Picture")!==null?(t=new GUI.Field.FieldSelectImage(this,n,r,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase(),u),i.IsRequired||t.setAllowNullValue(!0,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase()+"_NULL"),t.Autovalidation=!0,t.ShowLabel=!0):(t=new GUI.Field.FieldSelect(this,n,r,u),t.AllowNullValue=!i.IsRequired);break}t=new GUI.Field.FieldInputDigit(this,n,r,i.Digit,i.Unit);break;case"Double":case"Decimal":t=new GUI.Field.FieldInputDigit(this,n,r,i.Digit,i.Unit);break;case"Boolean":t=new GUI.Field.FieldCheckBox(this,n,r,[r+"_NULL",r+"_TRUE",r+"_FALSE"]);t.AllowNullValue=!i.IsRequired;break;case"String":if(e=DSDatabase.Instance.getSequence(this._table),e!==null&&n===e.Property)t=new GUI.Field.FieldInputDigit(this,n,r,new Digits.Sequence(e.Key,e.Length)),t.AsString=!0;else if(f=i.StringFormat,String.isEmptyOrWhiteSpaces(f))if(i.IsEmail)t=new GUI.Field.FieldInput(this,n,r,GUI.Field.FieldInput.TYPE_INPUT,null,i.StringMaxLength);else{let u=i.StringMaxLength;u=u===null?2e3:u;t=new GUI.Field.FieldInput(this,n,r,u>64?GUI.Field.FieldInput.TYPE_TEXTAREA:GUI.Field.FieldInput.TYPE_INPUT,null,u);t.AllowRC=u>64}else t=new GUI.Field.FieldInputDigit(this,n,r,new Digits.Mask(f)),t.AsString=!0;break;case"Enum":h=i.PathEnumerable;u=this.getListEnumerable(n);String.isEmptyOrWhiteSpaces(h)||!IMAGES_LOADED_FROM_SERVER.startsWith(h)&&IMAGES_LOADED_FROM_SERVER.indexOf(","+h)<0?(t=new GUI.Field.FieldSelect(this,n,r,u),t.AllowNullValue=!i.IsRequired):(t=new GUI.Field.FieldSelectImage(this,n,r,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase(),u),t.Autovalidation=!0,i.IsRequired||t.setAllowNullValue(!0,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase()+"_NULL"));break;case"DateTime":f=i.DatetimeFormat;t=new GUI.Field.FieldInputWithBox(this,n,r,f===null?"datetime":f);break;case"Byte[]":try{s=eval(this._table+"Record.DEFAULT_PICTURE")()}catch(c){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",c)}t=new GUI.Field.FieldImage(this,n,r,s);s!==null&&(t.DefaultPicture=s.picture)}return t===null?super.declareField(new GUI.Field.FieldInput(this,n,this._table.toUpperCase()+"_"+n.toUpperCase())):super.declareField(t)}}}drawButton(n){super.drawButton(n);this._buttonOK=this.declareButton(GUI.Box.Box.BUTTON_OK,"BTN_SUBMIT");this.drawAdditionalButton(n);this._buttonCancel=this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL");this._buttonClose=this.declareButton(GUI.Box.Box.BUTTON_CLOSE,"BTN_CLOSE")}drawContent(n){super.drawContent(n);n.show()}drawAdditionalButton(){}isFocusable(n){if(!super.isFocusable(n))return!1;if(n instanceof GUI.Field.Field){let t=DSDatabase.Instance.CurrentUser,i=this.Value;if(!this.isFieldVisible(n.Name,t,i)||this.isFieldReadonly(n.Name,t,i)||!this.isPanelVisible(n.Panel,t,i))return!1}return!0}initialize(n,t,i){this.Mode=t;this._currentRecord=this.getRecord(n);this._originRecord=this.Mode===GUI.Box.BoxRecord.MODE_READ?this._currentRecord:this.getRecord(this._list.getId(this._currentRecord));this.debug("Initializing the box ('"+t+"', "+(i?"Readonly":"Not Readonly")+") for the record ["+this._currentRecord.Id.toString()+"] ...");this.Title=Helper.Label(this.Name.toUpperCase()+"_"+t.toUpperCase(),this.getRecordLabel());this.Message=null;this.Error=null;this.Readonly=i}getListEnumerable(n){return new List.ListArray(new List.ListEnumerable(this._table,n,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList())}getRecordLabel(){let n=this._list.getText(this.Value);return String.isEmptyOrWhiteSpaces(n)?"{TITLE_NOT_DEFINED}":n}getRecord(n){var t=null;return t=typeof n=="number"||typeof n=="string"?DSRecord.Clone(this._list.getItem(n,!0)):DSRecord.Clone(n),t===null&&(t=this.NewRecord),t}updateFields(){if(this._currentRecord!==null&&this._currentRecord!==undefined){this.debug("Update fields");for(var n in this.Fields)try{this.Fields[n].populate();this.Fields[n].Value=this._currentRecord[n]}catch(t){this.exception(`Unable to set the value of the field ${n}`,t)}}}updateBoards(){this.debug("Update boards");for(var n in this.Boards)try{this.Boards[n].populateWebix();this.Boards[n].adjustWebix()}catch(t){this.exception(`Unable to populate the list ${n}`,t)}}isFieldVisible(n,t,i){return super.isFieldVisible(n,t,i)?this._list.isBoxFieldVisible(this,n,t,i):!1}isFieldReadonly(n,t,i){return super.isFieldReadonly(n,t,i)?!0:this._list.isBoxFieldReadonly(this,n,t,i)}isBoardVisible(n,t,i){return super.isBoardVisible(n,t,i)?this._list.isBoxBoardVisible(this,n,t,i):!1}isBoardReadonly(n,t,i){return super.isBoardReadonly(n,t,i)?!0:this._list.isBoxBoardReadonly(this,n,t,i)}isPanelVisible(n,t,i){return super.isPanelVisible(n,t,i)?this._list.isBoxPanelVisible(this,n,t,i):!1}isPanelReadonly(n,t,i){return super.isPanelReadonly(n,t,i)?!0:this._list.isBoxPanelReadonly(this,n,t,i)}open(){this.updateFields();super.open();this.updateBoards();this.firstFocus();let n=this._list.SequenceProperty;n!==null&&n!==undefined&&this.Fields[n]!==null&&this.Fields[n]!==undefined&&(this._noSequence?(this.Fields[n].Component.find("#field > .field").hide(),this.Fields[n].Message=Helper.Span("ERR_SEQUENCE_"+this.Table.toUpperCase())):(this.Fields[n].Component.find("#field > .field").show(),this.Fields[n].Message=null))}close(){super.close();this._noSequence=!1}createRecord(n,t){function i(n){return function(){n.open()}}function r(n){return function(t){var r=new Errors,i;return(n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),i=n._list.addItem(t,r,!1),n._list.endTransaction(),Helper.IsLabel(i))?(GUI.Box.Message.Message(n.Title,i,function(){var i=new Errors,r;if(n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),r=n._list.addItem(t,i,!0),n._list.endTransaction(),i.HasError){n._commit&&n._list.rollback(t);n.Error=i;return}n._commit&&(n._list.commit(r),n._currentRecord=r);n._loopOnCreate||n.close()}),!1):r.HasError?(n._commit&&n._list.rollback(t),r):(n._commit&&(n._list.commit(i),n._currentRecord=i),!n._loopOnCreate)}}function u(n){return function(){n.debug("Cancelling record ...");var t=new Errors;return n._list.cancelItem(-1,null,n.Value,t),n.close(),!0}}this.IsOpened||(this.initialize(n===undefined||n===null?null:n,t?t:GUI.Box.BoxRecord.MODE_CREATE,!1),this._buttonOK.Visible=!0,this._buttonOK.Action=r(this),this._buttonCancel.Visible=!0,this._buttonCancel.Action=u(this),this._buttonClose.Visible=!1,this._list.createSequence(this._currentRecord,i(this))||(this._noSequence=!0,i(this)()))}readRecord(n){this.IsOpened||(this.initialize(n,GUI.Box.BoxRecord.MODE_READ,!0),this._buttonOK.Visible=!1,this._buttonOK.Action=null,this._buttonCancel.Visible=!1,this._buttonClose.Visible=!0,this.open(),this._buttonClose.focus())}updateRecord(n,t){function i(n){return function(){var t=n._originRecord,u=n.Value,r,i;return DSRecord.IsEqual(t,u)?(n.debug("Record unchanged"),!0):(n.debug("Updating record ..."),r=new Errors,n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),i=n._list.updateItem(t.Id,t,u,r,!1),n._list.endTransaction(),Helper.IsLabel(i))?(GUI.Box.Message.Message(n.Title,i,function(){var i=new Errors,r;if(n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),r=n._list.updateItem(t.Id,t,u,i,!0),n._list.endTransaction(),i.HasError){n._commit&&n._list.rollback(t);n.Error=i;return}n._commit&&(n._list.commit(r),n._currentRecord=r);n.close()}),!1):r.HasError?(n._commit&&n._list.rollback(t),r):(n._commit&&(n._list.commit(i),n._currentRecord=i),!0)}}function r(n){return function(){function r(){var r=new Errors;n._list.cancelItem(t.Id,i,t,r);r.HasError?n.Error=r:n.close()}n.debug("Cancelling record ...");var i=n._originRecord,t=n.Value;return DSRecord.IsEqual(i,t)?!0:(GUI.Box.Message.Message(n.Title,"MSG_CONFIRMATION_CANCEL",r),!1)}}this.IsOpened||(this.initialize(n,t?t:GUI.Box.BoxRecord.MODE_UPDATE,!1),this._buttonOK.Visible=!0,this._buttonOK.Action=i(this),this._buttonCancel.Visible=!0,this._buttonCancel.Action=r(this),this._buttonClose.Visible=!1,this.open())}deleteRecord(n){function t(n){return function(){var t=new Errors,i;return(n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),i=n._list.deleteItem(n._originRecord.Id,n._originRecord,t),n._list.endTransaction(),t.HasError)?(n._commit&&n._list.rollback(i),t):(n._commit&&n._list.commit(i),!0)}}this.IsOpened||(this.initialize(n,GUI.Box.BoxRecord.MODE_DELETE,!0),this._buttonOK.Visible=!0,this._buttonOK.Action=t(this),this._buttonCancel.Visible=!0,this._buttonClose.Visible=!1,this.open())}constructor(n,t){super(n,"box_record");this._noSequence=!1;this._table=n;this._list=t?t:new List.ListRecord(n);this._originRecord=null;this._currentRecord=null;this._commit=!1;this._loopOnCreate=!1;this._buttonOK=null;this._buttonCancel=null;this._buttonClose=null}});GUI.Box.BoxReleaseNotes=(class extends GUI.Box.Box{drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK)}open(){super.open();this.firstFocus()}constructor(n){if(super("releasenotes","box_releasenotes"),this.Title="TITLE_RELEASENOTES",this.draw(),n!==null&&n!==undefined&&n.lines!==null&&n.lines!==undefined){let t="";for(let i=0;i<n.lines.length;i++)t+=n.lines[i];this.ContentZone.append(t);this.ContentZone.show()}}static Open(n){this._instance||(this._instance=new GUI.Box.BoxReleaseNotes(n));this._instance.open()}});GUI.Box.BoxSelect=(class extends GUI.Box.Box{set FilterInList(n){this._fnFilterInList=n?n:null;this._list!==null&&(this._list.Filter=this._fnFilterInList)}set Label(n){this._label=n===null||n===undefined?null:n;this._fieldFilter!==null&&(this._fieldFilter.Label=this._label)}set Filter(n){(this._filter=n===null||n===undefined?null:n,this._fieldFilter!==null)&&(this._fieldFilter.Value=String.convertValue(this._filter),this.IsOpened&&this.updateListFiltered())}set List(n){(this._list=n===undefined||n===null?null:n,this._list!==null&&this._fnFilterInList!==null&&(this._list.Filter=this._fnFilterInList),this.Component!==null)&&this.IsOpened&&this.updateList()}get List(){return this._list}set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Autovalidation(n){this._autovalidation=n!==null&&n!==undefined&&n;this._autovalidation&&(this._multiSelect=!1)}set MultiSelect(n){this._multiSelect=n!==null&&n!==undefined&&n===!0;this._multiSelect&&(this._autovalidation=!1)}set Value(n){let t=this._value;if(!this._multiSelect){if(this._value=String.convertValue(n),this.Component===null||!this.IsOpened)return;t!==null&&this._pictures.find("#"+t+" > img").removeClass("selected");this._value!==null&&(this._pictures.find("#"+this._value).show(),this._pictures.find("#"+this._value+" > img").addClass("selected"));return}if(String.isEmptyOrWhiteSpaces(n))this._value=[];else if(Array.isArray(n)){this._value=[];for(let t in n)this._value.push(String.convertValue(n[t]))}else this._value=[String.convertValue(n)];if(this.Component!==null&&this.IsOpened){if(t!==null&&t!==undefined)if(Array.isArray(t))for(let n in t)this._pictures.find("#"+t[n]+" > img").removeClass("selected");else this._pictures.find("#"+t+" > img").removeClass("selected");if(this._value!==null&&this._value!==undefined)for(let n in this._value)this._pictures.find("#"+this._value[n]).show(),this._pictures.find("#"+this._value[n]+" > img").addClass("selected")}}get Value(){return this._multiSelect?String.isEmptyOrWhiteSpaces(this._value)?null:Array.isArray(this._value)?[].concat(this._value):[String.convertValue(this._value)]:this._value}destructor(){super.destructor();this._fieldFilter!==null&&(this._fieldFilter.destructor(),this._fieldFilter=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null)}drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){function t(n){return function(t,i){i===undefined&&n.refresh()}}this._fieldFilter=this.declareField(new GUI.Field.FieldInput(this,"filter_"+this.Name,this._label));n.append("<div class='pictures'><\/div>");n.show();this._pictures=n.find(".pictures");this._languageListener=Language.Manager.Instance.addListener(t(this));this._fieldFilter.on("change",t(this));this.List=this._list}refresh(){super.refresh();this.Filter=this._fieldFilter.Value;this.getButton(GUI.Box.Box.BUTTON_OK).Visible=!this._autovalidation||this._allowNullValue}onOpen(){function n(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.setFocus(n._fieldFilter):n.getButton(GUI.Box.Box.BUTTON_OK).Visible?n.setFocus(n.getButton(GUI.Box.Box.BUTTON_OK)):n.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible?n.setFocus(n.getButton(GUI.Box.Box.BUTTON_CANCEL)):n.setFocus(n._fieldFilter),!1;case 13:return t.preventDefault(),$(this).click(),n._multiSelect||n.getButton(GUI.Box.Box.BUTTON_OK).Component.click(),!1;case 32:return t.preventDefault(),$(this).click(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 37:return t.preventDefault(),n.leftFocus(),!1;case 38:return t.preventDefault(),n.upFocus(),!1;case 39:return t.preventDefault(),n.rightFocus(),!1;case 40:return t.preventDefault(),n.downFocus(),!1}}}function t(n){return function(){n.setFocus($(this))}}function i(n){return function(){n.setFocus($(this));var t=String.convertValue($(this).attr("id"));if(n._multiSelect){for(let i in n._value)if(n._value[i]===t){if(n._value.length===1&&!n._allowNullValue)return;n._pictures.find("> #"+n._value[i]+" > img").removeClass("selected");n._value.splice(i,1);return}(n._value===null||n._value===undefined)&&(n._value=[]);n._value.push(t);n._pictures.find("> #"+t+" > img").addClass("selected")}else n._value!==null&&n._pictures.find("> #"+n._value+" > img").removeClass("selected"),n._value=t===n._value?null:t,n._allowNullValue||n._value!==null||(n._value=t),n._value!==null&&(n._pictures.find("> #"+n._value+" > img").addClass("selected"),n._autovalidation&&n.getButton(GUI.Box.Box.BUTTON_OK).Component.click())}}super.onOpen();this._currentList=this._list?this._list.getList():[];this.updateList();this.ContentZone.find("> .pictures > div").on("keydown",n(this));this.ContentZone.find("> .pictures > div").on("focus",t(this));this.ContentZone.find("> .pictures > div").on("click",i(this))}open(){super.open();this.firstFocus()}onClose(){super.onClose();this.ContentZone.find("> .pictures > div").off("click keydown focus");this._pictures.html("");this._currentList=null}previousFocus(){if(this._focusIndex===this._focus.length-1){if(this.getButton(GUI.Box.Box.BUTTON_OK).Visible){this.setFocus(this.getButton(GUI.Box.Box.BUTTON_OK));return}this.setFocus(this._fieldFilter);this.nextFocus();return}if(this._focusIndex===this._focus.length-2&&this.getButton(GUI.Box.Box.BUTTON_OK).Visible){this.setFocus(this._fieldFilter);this.nextFocus();return}super.previousFocus()}updateListFiltered(){var n,e,t,u,i,r,f;if(this._currentList!==null){n=String.convertValue(this._fieldFilter.Value);n!==null&&(n=n.toUpperCase());this.clearFocus();this.addFocus(this._fieldFilter);for(e in this._currentList)if((t=this._currentList[e],this._list.isVisible(t))&&(u=String.convertValue(this._list.getId(t)),u!==null)&&(i=this._list.getPicture(t),i!==null&&i!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(i=this._list.DefaultPicture),i!==null&&i!==undefined)){r="";f=this._list.getText(t);r=String.isEmptyOrWhiteSpaces(f)?Language.Manager.Instance.interpolation(this._list.getLanguageLabel(t)):f;let o=this._pictures.find("> #"+u);n===null||r.toUpperCase().indexOf(n)>=0?(o.show(),this.addFocus(o),o.focus(function(){$(this).addClass("focus")}),o.blur(function(){$(this).removeClass("focus")})):o.hide()}this.addFocus(this.getButton(GUI.Box.Box.BUTTON_OK));this.addFocus(this.getButton(GUI.Box.Box.BUTTON_CANCEL))}}updateList(){var i,e,t,r,n,u,f;if(this._pictures!==null){i="";for(e in this._currentList)(t=this._currentList[e],this._list.isVisible(t))&&(r=String.convertValue(this._list.getId(t)),r!==null)&&(n=this._list.getPicture(t),n!==null&&n!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(n=this._list.DefaultPicture),n!==null&&n!==undefined)&&(u="",f=this._list.getText(t),u=String.isEmptyOrWhiteSpaces(f)?Helper.Span(this._list.getLanguageLabel(t)):String.encode(f),i+="<div id='"+r+"'><img id='picture' src='"+n+"' /><div id='name'>"+u+"<\/div><\/div>");if(this._pictures.html(i),this._value!==null&&this._value!==undefined)if(Array.isArray(this._value)){let n=[];for(let t in this._value)this._pictures.find("> #"+this._value[t]+" > img").length>0&&(this._pictures.find("> #"+this._value[t]+" > img").addClass("selected"),n.push(this._value[t]));this._value=n}else this._pictures.find("> #"+this._value+" > img").length===0?this._value=null:this._pictures.find("> #"+this._value+" > img").addClass("selected");this.updateListFiltered()}}constructor(n,t){super(n,"box_select");this._label=Helper.Label(t);this._filter=null;this._list=null;this._value=null;this._fnFilterInList=null;this._fieldFilter=null;this._pictures=null;this._languageListener=null;this._allowNullValue=!0;this._autovalidation=!1;this._multiSelect=!1;this._currentList=null;this.draw();this.List=new List.List}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxSelect("boxselect")),this._instance}static Open(n,t,i,r,u,f){GUI.Box.BoxSelect.Instance.Title=n;GUI.Box.BoxSelect.Instance.Message=t;GUI.Box.BoxSelect.Instance.Error=null;GUI.Box.BoxSelect.Instance.Label=null;GUI.Box.BoxSelect.Instance.List=r;GUI.Box.BoxSelect.Instance.List.Filter=u;GUI.Box.BoxSelect.Instance.AllowNullValue=!1;GUI.Box.BoxSelect.Instance.Autovalidation=!1;GUI.Box.BoxSelect.Instance.Value=i;GUI.Box.BoxSelect.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=f;GUI.Box.BoxSelect.Instance.open()}});GUI.Button={};GUI.Button.Button=(class extends GUI.GUI{set Label(n){this._label=Helper.Label(n)}set Action(n){this._action=n?n:null}get Readonly(){return this._readonly}set Readonly(n){super.Readonly=n}draw(){super.draw("<button id='"+this.Name+"'>"+Helper.Span(this._label)+"<\/button>")}onOpen(){function n(n){return function(){var i,t;if(!n.Readonly)try{if(n._action===null){n.Box!==null&&n.Box.close();return}if(i=null,n.Box!==null&&!String.isEmptyOrWhiteSpaces(n.Box.Value)){i=n.Box.Value;let t=n.Box.checkValue(i);if(t!==!0){n.Box.Error=t;return}}if(t=n.Box===null?n._action():n._action(i),typeof t=="boolean"){t&&n.Box!==null&&n.Box.close();return}if(typeof t=="string"||t instanceof Errors){n.Box!==null&&(n.Box.Error=t);return}n.Box!==null&&n.Box.close()}catch(r){n.exception("Unexpected error on clicking",r);n.Box!==null&&(n.Box.Error="ERR_EXCEPTION_UNEXPECTED")}}}function t(n){return function(){n.Readonly||n.Box!==null&&n.Box.setFocus(n)}}function i(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 13:case 32:return t.preventDefault(),n.onMouseClick(),!1}}}super.onOpen();this.Component.on("focus",t(this));this.Component.on("keydown",i(this));this.Component.on("click",n(this))}onClose(){super.onClose();this.Component.off("focus keydown click")}refresh(){if(super.refresh(),this.Component!==null){var n=Helper.Span(this._label);if(String.isEmptyOrWhiteSpaces(n)){this.Component.html("");this.Component.hide();return}if(this.Component.html(n),this.Readonly){this.Component.hasClass("readonly")||this.Component.addClass("readonly");return}this.Component.hasClass("readonly")&&this.Component.removeClass("readonly")}}onMouseClick(){this.Visible&&!this.Readonly&&this.Component!==null&&this.Component.click()}constructor(n,t,i,r,u){super("button",n,t,i);n instanceof GUI.Box.BoxChoice?this._container=n.ContentZone:n instanceof GUI.Box.Box&&(this._container=n.ButtonZone);this._label=Helper.Label(r);this._label.label===null&&(this._label=Helper.Label("BTN_OK"));this._action=u?u:null;this.draw()}});GUI.Field={};GUI.Field.Field=(class extends GUI.GUI{get FieldZone(){return this.Component.find("> .value > .field")}get MessageZone(){return this.Component.find("> .value > .message")}get ErrorZone(){return this.Component.find("> .value > .error")}set Label(n){this._label=Helper.Label(n)}get Label(){return this._label}set Panel(n){this._panel=n}get Panel(){return this._panel}set Link(n){this._fnLink=n?n:null;this.refreshLink()}set Message(n){if(n===null||n===undefined||String.isEmptyOrWhiteSpaces(n)){this.Component.hasClass("message")&&this.Component.removeClass("message");this.MessageZone.html("");return}this.Component.hasClass("message")||this.Component.addClass("message");this.MessageZone.html(n)}set Error(n){if(n===null||n===undefined||String.isEmptyOrWhiteSpaces(n)){this.Component.hasClass("error")&&this.Component.removeClass("error");this.ErrorZone.html("");return}this.debug("Error = "+n);this.Component.hasClass("error")||this.Component.addClass("error");this.ErrorZone.html(n)}set Value(n){var t=this._value,i=n;n===undefined&&(n=null);this._value=n;typeof this._value=="string"?this._value=this._value.trim():this._value instanceof moment?this._value=this._value.format(List.List.TEXT_FORMAT_DATE):this._value instanceof Date&&(this._value=moment(this._value).format(List.List.TEXT_FORMAT_DATE));t!==this._value?(t=t!==undefined&&t!==null?t.toString():"null",i=this._value!==undefined&&this._value!==null?this._value.toString():"null",this.debug("Replace the value '"+t+"' to '"+i+"'"),this.IsOpened&&(this.refresh(),this.raise("change"))):this.IsOpened&&this.refresh()}get Value(){return this._value}get IsLinked(){return this._fnLink!==null}draw(){super.draw("<field id='"+this.Name+"'><div class='label'><\/div><div class='value'><div class='field'><\/div><div class='message'><\/div><div class='error'><\/div><\/div><\/field>");this.drawField(this.FieldZone)}drawField(){}populate(){this.verbose("Populate")}onOpen(){function n(n){return function(){n.Box!==null&&n.Box.setFocus(n)}}super.onOpen();this.Component.on("focus",n(this))}onClose(){super.onClose();this.Component.off("focus")}onFocusIn(){}onFocusOut(){}refreshLink(){if(this.Component!==null){var n=this.Component.find("> .label"),t=Helper.Span(this._label);if(String.isEmptyOrWhiteSpaces(t)){n.html("");n.hasClass("hide")||n.addClass("hide");return}if(n.html(t),n.hasClass("hide")&&n.removeClass("hide"),n.off("click"),n.removeClass("link"),this._fnLink){n.on("click",this._fnLink);n.addClass("link")}}}refresh(){(super.refresh(),this.Component!==null)&&this.refreshLink()}constructor(n,t,i,r){super("field",n,t,r);this._label=Helper.Label(i);this._value=null;this._fnLink=null;this._panel=null}});GUI.Field.FieldCheckBox=(class extends GUI.Field.Field{set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Value(n){this._allowNullValue||n!==null&&n!==undefined||(n=!0);switch(typeof n){case"boolean":break;case"number":n=n!==0;break;case"string":n=n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1";break;default:n=this._allowNullValue?null:!0}super.Value=n}get Value(){return super.Value}get Text(){var t="",n=-1;switch(this.Value){case null:n=0;break;case!0:n=1;break;default:n=2}return this._labels===null||this._labels===undefined||this._labels[n]===null||this._labels[n]===undefined?"":(t=Language.Manager.Instance.interpolation(this._labels[n]),String.isEmptyOrWhiteSpaces(t))?"":t.trim()}drawField(n){n.append("<div><\/div>")}onMouseClick(){if(!this.Readonly){switch(this.Value){case!0:this.Value=this._allowNullValue?null:!1;break;case null:this.Value=!1;break;default:this.Value=!0}GUI.Webix.Tooltip.Instance.IsVisible&&GUI.Webix.Tooltip.Instance.show(String.encode(this.Text))}}onOpen(){function n(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 32:return t.preventDefault(),n.onMouseClick(),!1}}}super.onOpen();this.Component.on("keydown",n(this))}onClose(){super.onClose();this.Component.off("keydown");this.FieldZone.find("div").off("click mouseenter mousemove mouseleave")}refresh(){function i(n){return function(){n.onMouseClick()}}function t(n){return function(t){GUI.Webix.Tooltip.Instance.show(String.encode(n.Text),t)}}function r(){return function(){GUI.Webix.Tooltip.Instance.hide()}}if(super.refresh(),this.Component!==null){var n=this.FieldZone.find("div");if(this.Readonly)n.css("cursor","initial"),n.off("click");else{n.css("cursor","pointer");n.off("click").on("click",i(this))}if(n.off("mouseenter mousemove mouseleave"),this._labels!==null)n.on("mouseenter",t(this)).on("mouseleave",r(this)).on("mousemove",t(this));n.removeClass("true");n.removeClass("false");n.removeClass("null");switch(this.Value){case!0:n.addClass("true");break;case!1:n.addClass("false");break;case null:n.addClass("null")}}}constructor(n,t,i,r){super(n,t,i,"field_checkbox");this._allowNullValue=!1;this._labels=r?r:null;this.draw()}});GUI.Field.FieldImage=(class extends GUI.Field.Field{static get Index(){return this._fieldIndex?this._fieldIndex++:this._fieldIndex=1,this._fieldIndex}set Value(n){super.Value=n}get Value(){if(this.Component===null)return super.Value;var n=this.Component.find("#picture > label > #picture")[0];return n?n.src.startsWith("data:image")?n.src:null:super.Value}get FileZone(){return this.Component.find("#picture")}drawField(n){var t="<label for='file_picture_"+this._index.toString()+"'>";t+="<img id='picture'";this._image.picture!==null&&this._image.picture!==undefined&&(t+=" src='"+this._image.picture+"'");t+=" />";t+="<\/label>";t+="<input id='file_picture_"+this._index.toString()+"' type='file' accept='"+this._image.extensions+"' style='display: none;' />";n.append(t)}onMouseClick(){this.Component!==null&&this.Component.find("input").click()}loadPicture(n,t){function o(n){return function(t){Picture.resize(t.target.result,n._image.width,n._image.height,function(t){n.Value=t;GUI.Box.Progress.Stop()})}}var i=n.match(/\.([^\.]+)$/),u,f,r,e;if(i.length!==0){for(i=i[1],u=this._image.extensions.split(","),f=!1,r=0;r<u.length;r++)if(u[r].toUpperCase()==="."+i.toUpperCase()){f=!0;break}f&&(e=new FileReader,e.onload=o(this),GUI.Box.Progress.Start(),GUI.Box.Progress.SetStatus(0,1,"MSG_LOADING"),e.readAsDataURL(t))}}onOpen(){function n(n){return function(){n.loadPicture(this.value,this.files[0])}}function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.Box.onButtonCancel(),!1;case 32:return t.preventDefault(),n.onMouseClick(),!1}}}function i(){return function(n){n.preventDefault();n.stopPropagation()}}function r(n){return function(){Hub.Instance.IsRunning&&n.FileZone.addClass("is-dragover")}}function u(n){return function(){n.FileZone.removeClass("is-dragover")}}function f(n){return function(t){t.originalEvent.dataTransfer.files.length===1&&n.loadPicture(t.originalEvent.dataTransfer.files[0].name,t.originalEvent.dataTransfer.files[0])}}super.onOpen();this.FileZone.on("drag dragstart dragend dragover dragenter dragleave drop",i(this)).on("dragover dragenter",r(this)).on("dragleave dragend drop",u(this)).on("drop",f(this));this.Component.find("#file_picture_"+this._index.toString()).val("");this.Component.find("#file_picture_"+this._index.toString()).on("change",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.Component.find("#file_picture_"+this._index.toString()).off("change");this.Component.off("keydown");this.FileZone.off("drag dragstart dragend dragover dragenter dragleave drop")}refresh(){if(super.refresh(),this.Component!==null){this.Component.find("#file_picture_"+this._index.toString()).prop("disabled",this.Readonly);this.Component.find(".value > .field > label > #picture").css("cursor",this.Readonly?"initial":"pointer");var n=this._value===null?this._image.picture:this._value;this.Component.find(".value > .field > label > #picture")[0].src=String.isEmptyOrWhiteSpaces(n)?"":n}}constructor(n,t,i,r){super(n,t,i,"field_image");this._index=GUI.Field.FieldImage.Index;this._image={extensions:r.extensions,picture:r.picture,width:r.width,height:r.height};(this._image.extensions===undefined||this._image.extensions===null)&&(this._image.extensions=".gif,.png,.jpg,.bmp,.svg,.tif,.jpeg");(this._image.picture===undefined||this._image.picture===null)&&(this._image.picture=null);(this._image.width===undefined||this._image.width===null)&&(this._image.width=100);(this._image.height===undefined||this._image.height===null)&&(this._image.height=100);this.draw()}});GUI.Field.FieldInput=(class extends GUI.Field.Field{static get TYPE_INPUT(){return"input"}static get TYPE_TEXTAREA(){return"textarea"}set Value(n){super.Value=n}get Value(){return this.Component===null?super.Value:this.FieldZone.find(this._type).val().trim()}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}set AllowRC(n){this._allowRC===GUI.Field.FieldInput.TYPE_INPUT?!1:n!==null&&n!==undefined&&n===!0}onOpen(){function t(n){return function(){var t=$(this).val();n._value=t;n._maxLength!==null&&(n.Message=n._maxLength>0&&t.length>=parseInt(n._maxLength*9/10)?Helper.Span("FIELD_MAX_LENGTH",n._maxLength):null);clearTimeout(n._throttle);n._throttle=setTimeout(function(){n.raise("change")},300)}}function i(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:if(n._allowRC){GUI.Box.BOX_RC=!0;return}return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1}}}function r(n){return function(){n._throttle!==null&&(clearTimeout(n._throttle),n._throttle=null,n.raise("change"))}}function n(n,t){return function(){n.Box!==null&&n.Box.setFocus(n);t||n.FieldZone.find(n._type).focus()}}super.onOpen();this.FieldZone.find(this._type).on("keydown",i(this)).on("input",t(this)).on("blur",r(this)).on("focus",n(this,!0));this.Component.off("focus").on("focus",n(this,!1))}onClose(){super.onClose();this.FieldZone.find(this._type).off("keydown input blur")}refresh(){if(super.refresh(),this.Component!==null){var t=this.FieldZone.find(this._type);t.prop("disabled",this.Readonly);t.val(String.isEmptyOrWhiteSpaces(this._value)?"":this._value.toString());let n=this.FieldZone.find(".unit");if(n.length>0){let t=String.encode(this._unit);String.isEmptyOrWhiteSpaces(t)?n.hasClass("hide")||n.addClass("hide"):(n.hasClass("hide")&&n.removeClass("hide"),this.FieldZone.find(".unit").html(t))}this._maxLength!==null&&t.attr("maxlength",this._maxLength)}}drawField(n){switch(this._type){case GUI.Field.FieldInput.TYPE_INPUT:n.append("<input type='text' /><div class='unit'><\/div>");break;case GUI.Field.FieldInput.TYPE_TEXTAREA:n.append("<textarea><\/textarea>")}}focus(){return super.focus()?(this.Component.find(this._type).focus().select(),!0):!1}constructor(n,t,i,r,u,f){r=r?r:GUI.Field.FieldInput.TYPE_INPUT;super(n,t,i,"field_"+r);this._type=r?r:GUI.Field.FieldInput.TYPE_INPUT;this._unit=u===null||u===undefined?null:u;this._allowRC=this._type===GUI.Field.FieldInput.TYPE_TEXTAREA;this._maxLength=f===null||f===undefined||isNaN(parseInt(f))?null:parseInt(f);this._maxLength=this._maxLength<=0?null:this._maxLength;this.draw()}});GUI.Field.FieldInputDigit=(class extends GUI.Field.Field{set ShowKeyboard(n){this._showKeyboard=n!==null&&n!==undefined&&n===!0}set AsString(n){this._asString=n!==null&&n!==undefined&&n===!0}set Value(n){if(this._asString&&typeof n=="string"){let t="";for(let i=0;i<n.length;i++)"0"<=n[i]&&n[i]<="9"&&(t+=n[i]);n=t}let t=this._digits.Value;if(this._digits.Value=n,t!==n){t=t!==undefined&&t!==null?t.toString():"null";let i=n!==undefined&&n!==null?n.toString():"null";this.debug("Replace the value '"+t+"' to '"+i+"'");this.IsOpened&&(this.refresh(),this.raise("change"))}else this.IsOpened&&this.refresh()}get Value(){return this._digits.IsNull?null:this._asString?this._digits.toString():this._digits.Value}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}set NbDecimals(n){if(!(!this._digits instanceof Digits.Decimal)){let t=new Digits.Decimal(this._digits.NbDigitBefore,n);t.Value=this._digits.Value;this._digits=t;this.refresh()}}destructor(){super.destructor();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null)}addKey(n){if(!this.Readonly){n==="undo"&&this._digits._undo.length===0&&this._digits.addKey("raz");let i=this._digits.Value;this._digits.addKey(n);let t=this._digits.Value;if(i!==t){i=i!==undefined&&i!==null?i.toString():"null";let n=t!==undefined&&t!==null?t.toString():"null";this.IsOpened&&(this.refresh(),this.raise("change"))}else this.IsOpened&&this.refresh();this._calendar!==null&&t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}drawCalendar(){function i(n){return function(t){n._notRefresh||(n._digits.setDate(t.getDate(),t.getMonth()+1,1900+t.getYear()),n.refresh(),n.raise("change"),n.focus())}}if(this._calendar!==null&&(this._calendar.destructor(),this._calendar=null),this._digits instanceof Digits.Datetime&&this._showKeyboard){let n=this._digits.WebixType;if(n!==null){this._calendar=new webix.ui({view:"calendar",type:n==="day"?undefined:n,container:this.Component.find("#calendar")[0],weekHeader:n==="day",weekNumber:n==="day",calendarDateFormat:this._digits.WebixFormat,on:{onChange:i(this)}});let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}}drawField(n){let i=["7","8","9","4","5","6","1","2","3"],t="<div id='field'><div class='field'><\/div><div class='unit'><\/div><\/div>";t+="<div id='keyboard' class='hide'>";for(let n=0;n<i.length;n++)t+="<div class='key' key='"+i[n]+"'><div>"+String.encode(i[n])+"<\/div><\/div>";t+="<div class='key undo' key='undo'><\/div>";t+="<div class='key' key='0'><div>0<\/div><\/div>";t+="<div class='key next minus' key='next'><\/div>";t+="<div class='key value minus' key='minus'>"+String.encode("-")+"<\/div>";t+="<\/div>";t+="<div id='calendar'><\/div>";n.append(t)}onOpen(){function n(n){return function(t,i){n._calendar!==null&&i===undefined&&n.drawCalendar()}}function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 8:return t.preventDefault(),n.addKey("undo"),!1;case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 46:return t.preventDefault(),n.addKey("raz"),!1}}}function i(n){return function(t){let i=t.which||t.keyCode;i<32||(t.preventDefault(),n.addKey(String.fromCharCode(i)))}}function r(n){return function(){n.addKey($(this).attr("key"));n.focus()}}function u(n){return function(){function i(n){return function(t){n.Value=t;n.focus()}}function r(n){return function(){n.focus()}}if(!n.Readonly&&!n._showKeyboard){let t=null;n.Box instanceof GUI.Box.Box&&n.Box.List!==null&&n.Box.List!==undefined&&n.Box.List.Table!==null&&n.Box.List.Table!==undefined&&(t=n.Box.List.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase());(t===null||Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,t)===null)&&(t="TITLE_SELECT_"+n.Name.toUpperCase());Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,t)===null&&(t="TITLE_SELECT_"+n._digits.Type.toUpperCase());GUI.Box.BoxInputDigit.Digit(t,n.Label,n.Unit,n._digits.clone(),n.Component.find(".value > .field > #field > .field").css("text-align"),i(n),r(n))}}}super.onOpen();this.drawCalendar();this._languageListener=Language.Manager.Instance.addListener(n(this));this.Component.on("keydown",t(this));this.Component.on("keypress",i(this));this.Component.on("dblclick",u(this));this.Component.find("#keyboard > .key").on("click",r(this));this._digits.selectAll()}onClose(){super.onClose();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null);this.Component.off("keydown keypress dblclick");this.Component.find("#keyboard > .key").off("click")}onFocusIn(){if(super.onFocusIn(),this._digits.selectAll(),this._keyboardVisible=!0,this._showKeyboard){let n=this.Component.find("#calendar"),t=this.Component.find("#keyboard");this._digits.IsCalendar?(n.hasClass("hide")&&n.removeClass("hide"),t.hasClass("hide")||t.addClass("hide")):(n.hasClass("hide")||n.addClass("hide"),t.hasClass("hide")&&t.removeClass("hide"))}}onFocusOut(){super.onFocusIn();let n=this.Component.find("#calendar"),t=this.Component.find("#keyboard");this._keyboardVisible=!1;t.hasClass("hide")||t.addClass("hide");n.hasClass("hide")||n.addClass("hide")}refresh(){if(super.refresh(),this.Component!==null){let f=this._digits.toString();this.FieldZone.find(".field").html(String.isEmptyOrWhiteSpaces(f)?"0":String.encode(f));let t=this.FieldZone.find(".unit");if(t.length>0){let n=String.encode(this._unit);String.isEmptyOrWhiteSpaces(n)?t.hasClass("hide")||t.addClass("hide"):(t.hasClass("hide")&&t.removeClass("hide"),t.html(n))}let n=this.Component.find("#keyboard > .next"),e=this._digits.NextTokenFix;String.isEmptyOrWhiteSpaces(e)?(n.hasClass("empty")||n.addClass("empty"),this.Component.find("#keyboard > .next").html("")):(n.hasClass("empty")&&n.removeClass("empty"),this.Component.find("#keyboard > .next").html(String.encode(e)));this._digits.AllowNegativeValue?(n.hasClass("minus")||n.addClass("minus"),this.Component.find("#keyboard > .key.value.minus").show()):(n.hasClass("minus")&&n.removeClass("minus"),this.Component.find("#keyboard > .key.value.minus").hide());let u=this.Component.find("#keyboard > .undo");this._digits.HasUndo?u.hasClass("empty")&&u.removeClass("empty"):u.hasClass("empty")||u.addClass("empty");let i=this.Component.find("#calendar"),r=this.Component.find("#keyboard");this._keyboardVisible&&this._showKeyboard?this._digits.IsCalendar?(i.hasClass("hide")&&i.removeClass("hide"),r.hasClass("hide")||r.addClass("hide")):(i.hasClass("hide")||i.addClass("hide"),r.hasClass("hide")&&r.removeClass("hide")):(i.hasClass("hide")||i.addClass("hide"),r.hasClass("hide")||r.addClass("hide"))}}constructor(n,t,i,r,u){r=r===null||r===undefined?new Digits.Digits:r;super(n,t,i,"field_input_digit "+r.Type);this._digits=r;this._unit=u===null||u===undefined?null:u;this._showKeyboard=!1;this._calendar=null;this._languageListener=null;this._keyboardVisible=!1;this._notRefresh=!1;this._asString=!1;this.draw()}});GUI.Field.FieldInputWithBox=(class extends GUI.Field.Field{static CACHE_BOX(n){let i=null;if(this._addonBox||(this._addonBox={}),n instanceof Digits.Digits)i="digits";else if(typeof n=="string")i=n;else return null;let r=this._addonBox[i];if(r!==undefined)return r;let t={name:null,box:null,list:null,digits:null};return n instanceof Digits.Digits?(t.digits=n,t.name=n.Type.toLowerCase()):DSDatabase.Instance.Tables[n]!==undefined?(t.name=n.toLowerCase(),t.box=new GUI.Box.BoxSelect(n,"SELECT_NAME"),t.list=List.ListRecord.CACHE_LIST(n)):(t.digits=Digits.Digits.Factory(n),t.digits!==null&&(t.name=t.digits.Type.toLowerCase())),this._addonBox[i]=t,t}set Value(n){if(this._withBox.box!==null){super.Value=n;return}var t=this._value,i=n;n===undefined&&(n=null);this._withBox.digits.Value=n;this._value=this._withBox.digits.Value;t!==this._value?(t=t!==undefined&&t!==null?t.toString():"null",i=this._value!==undefined&&this._value!==null?this._value.toString():"null",this.debug("Replace the value '"+t+"' to '"+i+"'"),this.IsOpened&&(this.refresh(),this.raise("change"))):this.IsOpened&&this.refresh()}get Value(){return super.Value}set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set FilterInBox(n){this._fnFilterInBox=n?n:null}get DatabaseTableReference(){return this._withBox.list===null?null:this._withBox.list.Table}drawField(n){n.append("<div class='value'><\/div><div class='icon'><\/div>")}onMouseClick(){this.Component===null||this.Readonly||this.FieldZone.find(".icon").click()}onOpen(){function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 32:return t.preventDefault(),n.onMouseClick(),!1;case 46:return t.preventDefault(),n.Value=null,!1}}}function n(n){return function(){function t(n){return function(t){return n.Value=t,!0}}function i(n){return function(){n.focus()}}if(n._withBox!==null&&!n.Readonly){if(n._withBox.box!==null){let u=n._withBox.list.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase();Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,u)===null&&(u="TITLE_SELECT_"+n.DatabaseTableReference.toUpperCase());let r=null;(n.Label===null||n.Label.label===null||n.Label.label===undefined)&&(r=DSDatabase.Instance.getColumnLabel(n._withBox.list.Table,n.Name),Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,r)===null&&(r=null));n._withBox.box.AllowNullValue=n._allowNullValue;n._withBox.box.Autovalidation=!0;n._withBox.box.List=n._withBox.list;n._withBox.box.FilterInList=n._fnFilterInBox;n._withBox.box.OnClosed=i(n);n._withBox.box.getButton(GUI.Box.Box.BUTTON_OK).Action=t(n);n._withBox.box.Title=u;n._withBox.box.Label=r;n._withBox.box.Value=n.Value;n._withBox.box.Error=null;n._withBox.box.open()}if(n._withBox.digits!==null){let i=null;n.Box instanceof GUI.Box.Box&&n.Box.List!==null&&n.Box.List!==undefined&&n.Box.List.Table!==null&&n.Box.List.Table!==undefined&&(i=n.Box.List.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase());(i===null||Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,i)===null)&&(i="TITLE_SELECT_"+n.Name.toUpperCase());Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,i)===null&&(i="TITLE_SELECT_"+n._withBox.name.toUpperCase());n._withBox.digits.Value=n.Value;GUI.Box.BoxInputDigit.Digit(i,n.Label,null,n._withBox.digits,n.Component.find(".value > .field > .value").css("text-align"),t(n))}}}}super.onOpen();this.Component.on("keydown",t(this));this.Component.find(".field").on("dblclick",n(this));this.FieldZone.find(".icon").on("click",n(this))}onClose(){super.onClose();this.Component.off("keydown");this.Component.find(".field").off("dblclick");this.Component.find(".label").off("click");this.FieldZone.find(".icon").off("click")}refresh(){function u(n){return function(){function i(n,t){return function(){n.OnClose=null;t.focus()}}if(!String.isEmptyOrWhiteSpaces(n.Value)){let t=GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.DatabaseTableReference,null,n._withBox.list);t!==null&&(t.OnClosed=i(t,n),t.readRecord(n.Value))}}}var i,r;if(super.refresh(),this.Component!==null){this.Readonly?this.FieldZone.find(".icon").hide():this.FieldZone.find(".icon").show();this.FieldZone.hasClass("deleted")&&this.FieldZone.removeClass("deleted");i=this.DatabaseTableReference;let n=null;if(!this.IsLinked&&i!==null&&!String.isEmptyOrWhiteSpaces(this.Value)&&(n=DSDatabase.Instance.getRowById(i,this.Value),n!==null)){this.Component.find(".label").off("click").on("click",u(this));this.Component.find(".label").addClass("link");this._withBox.list.isDeleted(n)&&this.FieldZone.addClass("deleted")}this.updateListeners();let t=null;if(this._withBox.digits!==null?(this._withBox.digits.Value=this.Value,t=this._withBox.digits.toString()):t=this.Value,String.isEmptyOrWhiteSpaces(t)){this.FieldZone.find(".value").html("");return}if(i===null){this.FieldZone.find(".value").html(String.encode(t));return}if(n===null&&(n=DSDatabase.Instance.getRowById(i,t)),n===null){this.FieldZone.find(".value").html(String.encode(t.toString()));return}r=this._withBox.list.getText(n);this.FieldZone.find(".value").html(String.encode(String.isEmptyOrWhiteSpaces(r)?"":r))}}updateListeners(){function n(n){return function(t,i,r,u,f){if(n.DatabaseTableReference===i){var e=n._withBox.list.getText(f);n.FieldZone.find(".value").html(String.encode(String.isEmptyOrWhiteSpaces(e)?"":e));n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");n._withBox.list.isDeleted(f)&&n.FieldZone.addClass("deleted")}}}function t(n){return function(t,i,r,u){n.DatabaseTableReference===i&&(n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted"),n._withBox.list.isDeleted(u)&&n.FieldZone.addClass("deleted"))}}this.clearListeners();this.DatabaseTableReference&&!String.isEmptyOrWhiteSpaces(this.Value)&&(this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this.DatabaseTableReference,this.Value,n(this))),this.addListener(DSDatabase.Instance.addEventListener("onDelete",this.DatabaseTableReference,this.Value,t(this))))}constructor(n,t,i,r){super(n,t,i,"field_input_with_box");this._fnFilterInBox=null;this._allowNullValue=!1;this._withBox=GUI.Field.FieldInputWithBox.CACHE_BOX(r);this.draw();this._withBox.name!==null&&this.Component.addClass(this._withBox.name)}});GUI.Field.FieldSelect=(class extends GUI.Field.Field{set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Value(n){if(n!==null&&n!==undefined||this._allowNullValue){super.Value=n;return}this.setFirstValueNotNull()}get Value(){if(this.Component===null)return super.Value;var n=this.FieldZone.find("select").val();return String.isEmptyOrWhiteSpaces(n)?null:n.trim()}set ExcludeValueToFilter(n){this._valueAdded=n===null||n===undefined?null:n}get List(){return this._list}drawField(n){n.append("<select><\/select>")}focus(){return super.focus()?(this.Component.find("select").focus(),!0):!1}populate(){function h(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1}}}function c(n,t){return function(){n.Box!==null&&n.Box.setFocus(n);t||n.FieldZone.find("select").focus()}}var n,r,e,t,s,i,u,o,f;if(super.populate(),this.Component!==null){n=this.FieldZone.find("select");r=null;n.empty();n.off("keydown focus").on("keydown",h(this)).on("focus",c(this,!0));this._allowNullValue&&n.append("<option value=''><\/option>");e=this._list.getList();t="";for(s in e)if((i=e[s],this._list.isVisible(i))&&(t="",this._list.isDeleted(i)&&(t=" class='deleted'"),u=String.convertValue(this._list.getId(i)),u!==null)){if(o=this._list.getText(i),!String.isEmptyOrWhiteSpaces(o)){n.append("<option value='"+u+"'"+t+">"+String.encode(o.trim())+"<\/option>");continue}(f=this._list.getLanguageLabel(i),f!==undefined&&f!==null)&&n.append(Helper.Option(u,f))}if(this._valueAdded!==null&&this._list!==null&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&(r=n.find("option[value='"+this._valueAdded+"']"),r===null||r===undefined||r.length===0)){let i=DSDatabase.Instance.getRowById(this._list.Table,this._valueAdded);i!==null&&(t="",this._list.isDeleted(i)&&(t=" class='deleted'"),n.append("<option value='"+i.Id+"'"+t+">"+String.encode(this._list.getText(i))+"<\/option>"))}}}refresh(){function r(n){return function(){var t,i;n._value=$(this).val();t=n.FieldZone.find("select");t.hasClass("deleted")&&t.removeClass("deleted");n.Value!==null&&(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord)&&(i=DSDatabase.Instance.getRowById(n._list.Table,n.Value),i!==null&&n._list.isDeleted(i)&&t.addClass("deleted"));n.raise("change")}}var n,t,i;if(super.refresh(),this.Component!==null){if(this.populate(),typeof this._value=="string"&&(this._value=this._value.trim()),n=this.FieldZone.find("select"),t=n.find("option[value='"+this._value+"']"),(t===null||t===undefined||t.length===0)&&(this._value=null),n.val(this._value===null?"":this._value),n.hasClass("deleted")&&n.removeClass("deleted"),this.Value!==null&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)){let t=DSDatabase.Instance.getRowById(this._list.Table,this._value);t!==null&&this._list.isDeleted(t)&&n.addClass("deleted")}i=this.getEvent("onLoad");i&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&i("onLoad",this._list.Table);n.prop("disabled",this.Readonly);n.off("change").on("change",r(this))}}onOpen(){function n(n){return function(){n.Box!==null&&n.Box.setFocus(n);n.FieldZone.find("select").focus()}}function t(n){return function(){n.refresh()}}function i(n){var t=n.FieldZone.find("select");return function(i,r,u,f){var e,o;(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord)&&(n._list.isVisible(f)&&(e="",n._list.isDeleted(f)&&(e=" class='deleted'"),t.append("<option value='"+f.Id+"'"+e+">"+String.encode(n._list.getText(f))+"<\/option>")),o=n.getEvent(i),o&&o(i,r,u,f))}}function r(n){var t=n.FieldZone.find("select");return function(i,r,u,f,e){var a,h,c;if(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord){var o=t.find("option[value='"+e.Id+"']"),l="",s=!1;n._list.isDeleted(e)&&(l=" class='deleted'",s=!0);o===null||o===undefined||o.length===0?n._list.isVisible(e)&&t.append("<option value='"+e.Id+"'"+l+">"+String.encode(n._list.getText(e))+"<\/option>"):n._list.isVisible(e)?(o.hasClass("deleted")&&o.removeClass("deleted"),s&&o.addClass("deleted"),o.html(String.encode(n._list.getText(e)))):n._valueAdded!==null&&n._valueAdded.toString()===e.Id.toString()?(o.hasClass("deleted")&&o.removeClass("deleted"),s&&o.addClass("deleted"),o.html(String.encode(n._list.getText(e)))):(a=n.Value,o.remove(),a!==n.Value&&(n.Value=n.Value));t.hasClass("deleted")&&t.removeClass("deleted");n.Value!==null&&(h=DSDatabase.Instance.getRowById(n._list.Table,n.Value),h!==null&&n._list.isDeleted(h)&&t.addClass("deleted"));c=n.getEvent(i);c&&c(i,r,u,f,e)}}}function u(n){var t=n.FieldZone.find("select");return function(i,r,u,f){var e,s,o;if(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord){if(e=t.find("option[value='"+f.Id+"']"),e===null||e===undefined||e.length===0||n._valueAdded!==null&&n._valueAdded.toString()===newRecord.Id.toString()?(e.hasClass("deleted")&&e.removeClass("deleted"),n._list.isDeleted(f)&&e.addClass("deleted")):(s=n.Value,e.remove(),s!==n.Value&&(n.Value=n.Value)),t.hasClass("deleted")&&t.removeClass("deleted"),n.Value!==null){let i=DSDatabase.Instance.getRowById(n._list.Table,n.Value);i!==null&&n._list.isDeleted(i)&&t.addClass("deleted")}o=n.getEvent(i);o&&o(i,r,u,f)}}}super.onOpen();this.Component.off("focus").on("focus",n(this));(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&(this.addListener(DSDatabase.Instance.addEventListener("onLoad",this._list.Table,"*",t(this))),this.addListener(DSDatabase.Instance.addEventListener("onCreate",this._list.Table,"*",i(this))),this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._list.Table,"*",r(this))),this.addListener(DSDatabase.Instance.addEventListener("onDelete",this._list.Table,"*",u(this))))}onClose(){super.onClose();this.FieldZone.find("select").off("focus");this.Component.off("focus")}setFirstValueNotNull(){if(this.Component!==null){var n=this.FieldZone.find("select");if(n[0].length===0){super.Value=null;return}if(this._allowNullValue){super.Value=n[0].length>1?n[0][1].value:null;return}if(n[0].length>0){super.Value=n[0][0].value;return}super.Value=null}}constructor(n,t,i,r){super(n,t,i,"field_select");this._list=r?r:new List.List;this._allowNullValue=!1;this._valueAdded=null;this.draw()}});GUI.Field.FieldSelectImage=(class extends GUI.Field.Field{set _parentValue(n){super.Value=n}set DefaultPicture(n){this._picture=String.isEmptyOrWhiteSpaces(n)?null:n}set Rollover(n){this._rollover=n!==null&&n!==undefined&&n;this._rollover&&(this._multiSelect=!1)}set Autovalidation(n){this._autovalidation=n!==null&&n!==undefined&&n;this._autovalidation&&(this._multiSelect=!1)}set MultiSelect(n){this._multiSelect=n!==null&&n!==undefined&&n===!0;this._multiSelect&&(this._rollover=!1,this._autovalidation=!1)}set ShowLabel(n){this._showLabel=n!==null&&n!==undefined&&n===!0;this._showLabel||(this.Message=null)}set Message(n){(this._showLabel||String.isEmptyOrWhiteSpaces(n))&&(super.Message=n)}get List(){return this._list}get Text(){var n="",t=[];if(Array.isArray(this.Value)?t=this.Value:String.isEmptyOrWhiteSpaces(this.Value)||(t=[this.Value]),t.length===0)return(n=Language.Manager.Instance.interpolation(this._labelNullValue),String.isEmptyOrWhiteSpaces(n))?"":n.trim();for(let i in t){let u=this._list.getItem(t[i],!0);if(u!==null){let r=this._list.getText(u);(String.isEmptyOrWhiteSpaces(r)&&(r=Language.Manager.Instance.interpolation(this._list.getLanguageLabel(u))),String.isEmptyOrWhiteSpaces(r))||(n=n+(n.length===0?"":", ")+r.trim())}}return n}destructor(){super.destructor();this._dialogBox!==null&&(this._dialogBox.destructor(),this._dialogBox=null)}drawField(n){n.append("<img><\/img><span><\/span>")}onOpen(){function t(n){return function(t){let i=t.which||t.keyCode;switch(i){case 9:return t.preventDefault(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case 13:return t.preventDefault(),n.onButtonOK(),!1;case 27:return t.preventDefault(),n.onButtonCancel(),!1;case 32:return t.preventDefault(),n.onMouseClick(),!1}}}function n(n){return function(t){GUI.Webix.Tooltip.Instance.show(String.encode(n.Text),t)}}function i(){return function(){GUI.Webix.Tooltip.Instance.hide()}}super.onOpen();this.FieldZone.find("img").on("mouseenter",n(this)).on("mouseleave",i(this)).on("mousemove",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.FieldZone.find("img").off("mouseenter mouseleave mousemove click");this.Component.on("keydown")}refresh(){function i(n){return function(){function i(n){return function(t){return!n._allowNullValue&&t===null?(GUI.Box.BoxError("ERROR",n._errorMessage),!1):(n.Value=t,n.Message=n.Text,!0)}}function r(n){return function(){return n.raise("cancel"),!0}}function u(n){return function(){n.focus();n._dialogBox.OnClosed=null}}if(n._rollover){n.setNextValue();return}if(n._dialogBox===null&&(n._dialogBox=new GUI.Box.BoxSelect(n.Name,n.Label?n.Label:"SELECT_NAME"),n._dialogBox.getButton(GUI.Box.Box.BUTTON_OK).Action=i(n),n._dialogBox.getButton(GUI.Box.Box.BUTTON_CANCEL).Action=r(n),(n.Label===null||!n.Label.label)&&n.Box instanceof GUI.Box.BoxRecord)){var t=DSDatabase.Instance.getColumnLabel(n.Box.Table,n.Name);t!==null&&(n._dialogBox.Label=t)}n._dialogBox.Title=n._title;n._dialogBox.Error=null;n._dialogBox.Message=null;n._dialogBox.Filter=null;n._dialogBox.Value=n.Value;n._dialogBox.List=n._list;n._dialogBox.AllowNullValue=n._allowNullValue;n._dialogBox.Autovalidation=n._autovalidation;n._dialogBox.MultiSelect=n._multiSelect;n._dialogBox.OnClosed=u(n);n._dialogBox.open()}}if(super.refresh(),this.Readonly)this.FieldZone.find("img").css("cursor","initial"),this.FieldZone.find("img").off("click");else{this.FieldZone.find("img").css("cursor","pointer");this.FieldZone.find("img").off("click").on("click",i(this))}var n=this._picture,t=null;Array.isArray(this.Value)?t=this.Value.length>0?this._list.getItem(this.Value[0],!0):null:String.isEmptyOrWhiteSpaces(this.Value)||(t=this._list.getItem(this.Value,!0));t!==null&&(n=this._list.getPicture(t));n!==null&&n!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(n=this._list.DefaultPicture);this.FieldZone.find("img")[0].src=n===null?this._picture:n;Array.isArray(this.Value)&&this.Value.length>1?(this.FieldZone.find("span").show(),this.FieldZone.find("span").html(this.Value.length)):this.FieldZone.find("span").hide();this.Message=this.Text;this.FieldZone.hasClass("deleted")&&this.FieldZone.removeClass("deleted");t!==null&&this._list.isDeleted(t)&&this.FieldZone.addClass("deleted");this.IsOpened&&this.updateListeners();this._dialogBox!==null&&this._dialogBox.IsOpened&&(this._dialogBox.Value=this.Value)}setNextValue(){function i(n,t){n._parentValue=t===null?null:String.convertValue(n._list.getId(t));n.FieldZone.find("img")[0].src=t===null?n._picture:n._list.getPicture(t);n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");t!==null&&n._list.isDeleted(t)&&n.FieldZone.addClass("deleted");n.Message=n.Text;n.IsOpened&&n.updateListeners();GUI.Webix.Tooltip.Instance.IsVisible&&GUI.Webix.Tooltip.Instance.show(String.encode(n.Text))}var u=0,t=null,r=null,f=!1,e=this._list.getList(),n,o;for(u in e)if(n=e[u],n!==null&&n!==undefined){if(o=String.convertValue(this._list.getId(n)),this.Value===o){f=!0;continue}if(this._list.isVisible(n)){if(f){r=n;break}t===null&&(t=n)}}if(r!==null){i(this,r);return}if(t===null){i(this,null);return}i(this,t)}updateListeners(){function n(n){return function(t,i,r,u,f){var e=n._list.getPicture(f);n.FieldZone.find("img")[0].src=e===null?n._picture:e;n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");item!==null&&n._list.isDeleted(f)&&n.FieldZone.addClass("deleted");n.Message=n.Text}}this.clearListeners();(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&!String.isEmptyOrWhiteSpaces(this.Value)&&this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._list.Table,this.Value,n(this)))}setAllowNullValue(n,t){this._allowNullValue=n!==null&&n!==undefined&&n;this._labelNullValue=t?t:"SELECT_VALUE_NULL";this._errorMessage=new Errors(t===null||t===undefined?"ERR_SELECT_VALUE":t);this._dialogBox!==null&&(this._dialogBox.AllowNullValue=this._allowNullValue)}onMouseClick(){this.Visible&&!this.Readonly&&this.FieldZone!==null&&this.FieldZone.find("img").click()}constructor(n,t,i,r,u,f){super(n,t,i,"field_select_image");this._title=r;this._list=u?u:new List.List;this._rollover=!1;this._picture=this._list.DefaultPicture===null||this._list.DefaultPicture===undefined?null:this._list.DefaultPicture;this._dialogBox=null;this._allowNullValue=!1;this._errorMessage=new Errors("ERR_SELECT_VALUE");this._labelNullValue=f?f:"SELECT_VALUE_NULL";this._autovalidation=!1;this._multiSelect=!1;this._showLabel=!1;this.draw()}});GUI.Webix={};webix.Date.startOnMonday=!0;GUI.Webix.Webix=(class extends GUI.GUI{get ChartZone(){return this.Component}set Webix(n){this._webix!==null&&(this._webix.destructor(),this._webix=null);this._webix=n}get Webix(){return this._webix}destructor(){super.destructor();this._webix!==null&&this._webix.destructor();this._webix=null}drawChart(){}draw(){function n(n){return function(){n.debug("Resizing webix chart ...");n.refresh()}}super.draw("<webix id='"+this.Name+"'><\/webix>");this.drawChart(this.ChartZone);this.refresh();$(window).on("resize",n(this))}constructor(n,t,i){super("Webix",n,t,i);this._webix=null}});GUI.Webix.WebixBar=(class extends GUI.Webix.Webix{setLabel(n,t){n<0||n>=this._values.length||this._values[n]===undefined||(this._values[n].label=Helper.Label(t))}setValue(n,t){n<0||n>=this._values.length||this._values[n]===undefined||(this._values[n].value=typeof t=="string"?String.parseFloat(t):typeof t=="number"?String.parseFloat(t):0,this._values[n].value<0&&(this._values[n].value=0),this.refresh())}createChart(){var n=this._maxValue?this._maxValue:this._nbSteps;return new webix.ui({view:"chart",type:"bar",css:"webix_bar",container:this.ChartZone[0],value:"#value#",color:"#color#",shadow:!1,border:!1,borderless:!0,tooltip:{template:function(n){return Helper.Span(n.label)}},yAxis:{start:0,end:n,step:n/this._nbSteps},data:[]})}drawChart(){var u,n,r,t,i;for(this.Webix=this.createChart(),u="#000000",n=$("<webix id='"+this.Name+"' class='color'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass),r=n.appendTo("body"),t=n.css("color"),r.remove(),String.isEmptyOrWhiteSpaces(t)||(u=String.parseRGBToHEX(t)),i=0;i<this._values.length;i++)n=$("<webix id='"+this.Name+"' class='color_"+(i+1).toString()+"'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass),r=n.appendTo("body"),t=n.css("color"),r.remove(),this._values[i].color=String.isEmptyOrWhiteSpaces(t)?u:String.parseRGBToHEX(t)}refresh(){var n;if(super.refresh(),this.Component!==null&&this.Webix!==null){var i=this.ChartZone.width(),r=this.ChartZone.height(),t=0;for(this.Webix.clearAll(),n=0;n<this._values.length;n++)this.Webix.add(this._values[n]),t<this._values[n].value&&(t=Math.ceil(this._values[n].value/this._nbSteps)*this._nbSteps);this._maxValue!==t&&(this._maxValue=t,this.Webix=this.createChart());this.Webix.config.barWidth=i/(this._values.length+1);this.Webix.config.width=i;this.Webix.config.height=r;this.Webix.config.x=i/10;this.Webix.config.y=r/10;this.Webix.resize()}}constructor(n,t,i){super(n,t,"bar");this._values=[];for(var r=0;r<i;r++)this._values.push({id:r+1,value:0,color:"#000000",label:null});this._maxValue=0;this._nbSteps=5;this.draw()}});GUI.Webix.Tooltip=(class{static get DEFAULT(){return"tooltip"}get IsVisible(){return this._visible}show(n,t){var u,f;if(!String.isEmptyOrWhiteSpaces(n)){(t===null||t===undefined)&&(t={pageX:this._lastEventMouse.x,pageY:this._lastEventMouse.y});$('<p class="image webix_tooltip"><\/p>').html(n).appendTo("body");u=$(".image.webix_tooltip").width()+20;f=$(".image.webix_tooltip").height()+10;$(".image.webix_tooltip").remove();var e=$(window).width(),o=$(window).height(),i=t.pageX,r=t.pageY;i+u>e&&(i<u?i=0:(i=i-u,r+=10));r+f>o&&(r=r<f?0:r-f);this._tooltip.show({text:n},{x:i,y:r});this._visible=!0;this._lastEventMouse={x:t.pageX,y:t.pageY}}}hide(){this._tooltip.hide();this._visible=!1}constructor(){webix.ui({id:GUI.Webix.Tooltip.DEFAULT,view:"tooltip",template:"#text#"});this._tooltip=$$(GUI.Webix.Tooltip.DEFAULT);this._lastEventMouse={x:0,y:0};this._visible=!1}static get Instance(){return this._instance||(this._instance=new GUI.Webix.Tooltip),this._instance}});var ERR_INITIALIZATION="L'initialisation a rencontrÃ© une erreur ... Si le problÃ¨me persiste, contacter votre Ã©quipe support !",BTN_RELOAD="RECHARGER",ERROR="Erreur";class Area extends GUI.GUI{static get HTTP_ROOT_DOCUMENTATION(){let n="http";return n=window.location.href.startsWith("http://localhost")?"https":window.location.href.split(":")[0],n+"://www.syncytium.fr/wiki/index.php/utilisation/"}static get ROOT_MENU(){return"body > menu > ul > "}static get SERVICE_RELEASE_NOTES(){return"ReleaseNotes"}set Help(n){function t(n){return function(){typeof n._link=="string"&&window.open(n._link,"_blank");typeof n._link=="function"&&n._link()}}this._link=n===null||n===undefined?null:n;$(Area.ROOT_MENU+"#help").unbind();this._link!==null&&$(Area.ROOT_MENU+"#help").click(t(this))}get ModuleId(){return this._moduleId}get Menu(){return this._menu}get CurrentMenu(){return this._currentMenu}get CurrentSubMenu(){return this._currentSubMenu}destructor(){super.destructor();for(var n in this._boards)this._boards[n].destructor();this._boards={}}declareBoard(n,t){let i=this.getMenu(n),r=new t(i.sheet,n);return i.boards.push(r),r}setTitle(n,t){this._title=Helper.Label(n);this._element=t===null||t===undefined?null:t;$("header > ul > li.area").html(Helper.Span(this._title));this._element===null?$("header > ul > li.element").hide():($("header > ul > li.element").show(),$("header > ul > li.element.screen_name").html(String.encode(this._element)))}declareMenu(n,t,i){function u(n,t){return function(){n.onMenu(t)}}function f(n,t){return function(){$('<p class="webix_tooltip menu '+n+'"><\/p>').html(Helper.Span(t)).appendTo("body").fadeIn("slow")}}function e(n){return function(){$(".webix_tooltip.menu."+n).remove()}}function o(n){return function(t){var i=t.pageX+10,r=t.pageY;$(".webix_tooltip.menu."+n).css({top:r,left:i})}}if(this._menu[n]===null||this._menu[n]===undefined){this.info("Declaring menu ('"+n+"', '"+t+"') ...");this._firstMenu===null&&(this._firstMenu=n);this._menu[n]={id:n,title:Helper.Label(t),filter:i===undefined?null:i,boards:[],menu:{},orderMenu:[],current:null,sheet:null};var r=$("<li class='button' id='"+n+"'><\/li>");$(Area.ROOT_MENU+" li.spaceall").before(r);r.hover(f(n,this._menu[n].title),e(n)).mousemove(o(n));r.click(u(this,n));this._menu[n].sheet=$("<sheet class='"+n+"'><\/sheet>");this._menu[n].sheet.hide();$("body > main").append(this._menu[n].sheet);Language.Manager.Instance.addComponent(this._menu[n].sheet)}return this._menu[n]}declareSubMenu(n,t,i,r){function f(n,t,i){return function(){n.onMenu(t,i)}}var u=this._menu[n];return u===null||u===undefined?null:((u.menu[t]===null||u.menu[t]===undefined)&&(this.info("Declaring sub menu ('"+n+"', '"+t+"', '"+i+"') ..."),u.menu[t]={id:t,title:Helper.Label(i),filter:r===undefined?null:r,boards:[],functions:[]},u.orderMenu.push(u.menu[t]),u.current===null&&(u.current=t),$(Area.ROOT_MENU+"#"+n+"_"+t).click(f(this,n,t))),u.menu[t])}getMenu(n){var t=this._menu[n];return t===null||t===undefined?null:t}onSelectingMenu(){}onMenu(n,t,i){var s=!1,e=this._menu[n],u=null,r=null,o,f;if(e!==null&&e!==undefined&&(n=n===null||n===undefined?null:n,t=t===null||t===undefined?null:t,this.info("Select menu '"+(n===null?"null":n)+"', '"+(t===null?"null":t)+"'"),i!==null&&i!==undefined&&i!==!1||this._currentMenu!==n||this._currentSubMenu!==t)){if(t===null&&e.boards.length===0&&e.current!==null)t=e.current;else if(t===null&&e.boards.length===0)for(u in e.menu){t=u;break}$("body > .progress").is(":visible")||(this.onStartProgress(),this.progressStatus(0,1,"MSG_REFRESHING"),s=!0);for(let n in this._menu){let t=this._menu[n];if(t!==null&&t!==undefined){for(u in t.boards)(r=t.boards[u],r!==null&&r!==undefined)&&r.hide();$(Area.ROOT_MENU+"#"+n).hasClass("selected")&&$(Area.ROOT_MENU+"#"+n).removeClass("selected");$(Area.ROOT_MENU+"#"+n).prop("disabled",!1);t.sheet.remove();for(let i in t.menu){let f=t.menu[i];if(f!==null&&f!==undefined){for(u in f.boards)(r=f.boards[u],r!==null&&r!==undefined)&&r.hide();$(Area.ROOT_MENU+"#"+n).hasClass(i)&&$(Area.ROOT_MENU+"#"+n).removeClass(i);$(Area.ROOT_MENU+"#"+n+"_"+i).prop("disabled",!0);$(Area.ROOT_MENU+"#"+n+"_"+i).hide()}}}}for(let i in this._menu){let e=this._menu[i];if(e!==null&&e!==undefined){i===n&&($(Area.ROOT_MENU+"#"+i).hasClass("selected")||$(Area.ROOT_MENU+"#"+i).addClass("selected"),$(Area.ROOT_MENU+"#"+i).prop("disabled",!0));o=!1;for(f in e.menu){let s=e.menu[f];if(s!==null&&s!==undefined){if(i===n&&f===t){$(Area.ROOT_MENU+"#"+i).hasClass(f)||$(Area.ROOT_MENU+"#"+i).addClass(f);$(Area.ROOT_MENU+"#"+i+"_"+f).prop("disabled",!0);$("main > sheet."+i+"_"+f).length>0?$("main > sheet."+i+"_"+f).show():e.sheet.length>0&&(e.sheet.show(),$("body > main").append(e.sheet));for(u in s.boards)(r=s.boards[u],r!==null&&r!==undefined)&&r.show();o=!0}i===n&&$(Area.ROOT_MENU+"#"+i+"_"+f).show()}}if(!o&&i===n){e.sheet.show();$("body > main").append(e.sheet);for(u in e.boards)(r=e.boards[u],r!==null&&r!==undefined)&&r.show()}}}this.onSelectingMenu(n,t);this._currentMenu=n;this._currentSubMenu=t;e.current=t;s&&this.onStopProgress()}}selectSubMenu(){function u(n,t,i,r){return function(){if(r.functions!==null&&r.functions!==undefined)for(var u in r.functions)try{r.functions[u](t,i)}catch(f){n.exception("Unable to execute a function for the menu ('"+(t===null?"null":t)+"', '"+(i===null?"null":i)+"')",f)}if(r.boards.length>0)n.onMenu(t,i)}}var n=this.menu[this._currentMenu],i,r,t;if(n!==null&&n!==undefined&&!$.isEmptyObject(n.menu)){for(i=[],r=0;r<n.orderMenu.length;r++)(t=n.orderMenu[r],t!==null&&t!==undefined)&&i.push({label:t.title,fn:u(this,this._currentMenu,t.id,t)});i.length!==0&&GUI.Box.BoxChoices(n.title,null,i)}}onStatusChanged(n,t,i){function r(){window.onbeforeunload=null;window.location=URL_ROOT+"Administration/User/SignOut"}i===null||i===undefined?this.info("The current database status is '"+t+"'"):this.info("The current database status is '"+t+"' ("+i.toString()+")");switch(t){case"Running":this.onLoadedData();break;case"Error":$("body > main").hide();$("body > .progress").hide();$(".box_record").hide();n==="Running"?GUI.Box.Message.Reload(i,r):GUI.Box.Message.Reload(ERR_INITIALIZATION,r)}}onStartProgress(){GUI.Box.Progress.Start()}progressStatus(n,t,i){GUI.Box.Progress.SetStatus(n,t,i)}onStopProgress(n){var t,r,u,i,f;if(GUI.Box.Progress.Stop(),n!==undefined&&n===!0){if(t=window.location.search.substr(1),t===null||t===""){this.startApplication({});return}for(r={},u=t.split("&"),i=0;i<u.length;i++)f=u[i].split("="),r[f[0]]=f[1];this.startApplication(r)}}progressMemory(n,t){(n===null||n===undefined||n<0)&&(n=0);n>t&&(n=t);$("body > .memory > .container").width((n*100/t).toFixed(0).toString()+"%")}onLoadedData(){function f(){return function(){GUI.Box.BoxRecord.CACHE_DIALOG_BOX("User","Profile").profile(DSDatabase.Instance.CurrentUser)}}function i(){return function(n,t,i,r,u){var f=null,e;switch(t){case"User":switch(n){case"onUpdate":$("body > header > ul > .photo > img")[0].src=u.Picture===null?UserRecord.DEFAULT_PICTURE().picture:u.Picture;u.EndDate!==null&&u.EndDate<new moment&&(f="MSG_DISCONNECTED");break;case"onDelete":f="MSG_DISCONNECTED"}break;case"Module":switch(n){case"onUpdate":if(r.Profile!==u.Profile)switch(u.Profile){case UserRecord.PROFILE_ADMINISTRATOR:if(DSDatabase.Instance.Area==="Administration")return;f="MSG_CHANGE_PROFILE_ADMINISTRATOR";break;case UserRecord.PROFILE_SUPERVISOR:case UserRecord.PROFILE_USER:case UserRecord.PROFILE_OTHER:f=DSDatabase.Instance.Area==="Administration"?"MSG_DISCONNECTED":"MSG_CHANGE_PROFILE";break;case UserRecord.PROFILE_NONE:f="MSG_DISCONNECTED"}break;case"onDelete":f="MSG_DISCONNECTED"}break;case"UserModule":f="MSG_DISCONNECTED"}if(f!==null){e=new GUI.Box.Box("reload","box_reload");e.Title="RELOAD";e.Message=f;e.draw();switch(f){case"MSG_CHANGE_PROFILE_ADMINISTRATOR":case"MSG_DISCONNECTED":e.declareButton("Signout","BTN_SIGNOUT",function(){return Hub.Instance.stop(!0),Logger.Instance.IsEnabled=!1,window.onbeforeunload=null,window.location=URL_ROOT+"Administration/User/SignOut",!0});break;case"MSG_CHANGE_PROFILE":e.declareButton("Reload","BTN_RELOAD",function(){return window.location.reload(),!0})}e.open()}}}function e(n){return function(t,i,r,u){if(u!==null&&u!==undefined&&(!Helper.IsLabel(u,!0)||Language.Manager.Instance.existLabel(u.label))){var f=Language.Manager.Instance.interpolation(u);n.info("Toast: "+f);webix.message(String.encode(f))}}}function o(n){return function(t,i,r,u,f){if(i==="*"&&u!==null&&u!==undefined){if(f!==null&&f!==undefined){GUI.Box.Message.Error(u,f);return}var e=Language.Manager.Instance.interpolation(u);n.info("Toast: "+e);webix.message(String.encode(e))}}}function s(){return function(n){if(n.Error!==null&&n.Error!==undefined){var t=new Errors;t.setJSON(n.Error);GUI.Box.Message.Error("ERROR",t);return}GUI.Box.BoxReleaseNotes.Open(n.Result)}}function h(n,t){return function(){if(!Hub.Instance.IsOnline){GUI.Box.Message.Information("ERR_RELEASE_NOTES");return}Hub.Instance.executeService(Area.SERVICE_RELEASE_NOTES,null,null,t)}}function c(){return function(){function i(n){return function(){function t(){return Hub.Instance.stop(!0),Logger.Instance.IsEnabled=!1,window.onbeforeunload=null,window.location=URL_ROOT+ModuleRecord.GetModuleName(n)+"/"+ModuleRecord.GetModuleName(n)+"/Index?moduleId="+DSDatabase.Instance.getServerIdByClientId("Module",n.Id),!0}if(DSDatabase.Instance.IsEmpty)return t();GUI.Box.Message.Message("TITLE_EXIT","MSG_CONFIRMATION_CANCEL",t)}}let n=DSDatabase.Instance.CurrentUser,r=DSDatabase.Instance.CurrentModule,t=[];if(n!==null&&n!==undefined){let f=n.Modules,e=new ModuleRecord.List;for(var u in f){let o=f[u];if(o!==null&&o!==undefined){let n=e.getItem(o.ModuleId);n!==null&&n!==undefined&&n.Id!=r.Id&&n.Enable&&t.push({label:e.getText(n),fn:i(n)})}}}t.length>0&&GUI.Box.BoxChoice.BoxChoices("TITLE_MODULE",null,t)}}function n(){return function(){let n=(new UserRecord.List).getItem(DSDatabase.Instance.CurrentUser.Id),t=0;if(n!==null&&n!==undefined){let r=n.Modules,u=new ModuleRecord.List;for(var i in r){let n=r[i];if(n!==null&&n!==undefined){let f=u.getItem(n.ModuleId);f!==null&&f!==undefined&&f.Enable&&t++}}}$("body > header > ul > .area.screen_name").css("cursor",t>1?"pointer":"initial")}}if(this._firstLoad){this._firstLoad=!1;this.info("Data are loaded. So, building the screen ...");Language.Manager.Instance.initialize(DSDatabase.Instance);var t=DSDatabase.Instance.CurrentUser,r=DSDatabase.Instance.CurrentModule,u=null;DSDatabase.Instance.each("UserModule",function(n){n.UserId!==t.Id||n.ModuleId!==r.Id||n._deleted||(u=n)});$("body > header > ul > .photo > img")[0].src=t===null||t.Picture===null?UserRecord.DEFAULT_PICTURE().picture:t.Picture;$("body > header > ul > .photo").hover(function(){var n=DSDatabase.Instance.CurrentUser,t="";n!==null&&n.Name!==""?t=n.Name:n!==null&&n.Login!==""&&(t=n.Login);$('<p class="image webix_tooltip"><\/p>').html(t).appendTo("body").fadeIn("slow")},function(){$(".image.webix_tooltip").remove()}).mousemove(function(n){var t=n.pageX-10-$(".image.webix_tooltip").width(),i=n.pageY;$(".image.webix_tooltip").css({top:i,left:t})});$(Language.Manager.LANGUAGE_ROOT+"#"+DSDatabase.Instance.CurrentLanguage).html("<span>"+DSDatabase.Instance.CurrentLanguage+"<\/span>");webix.i18n.setLocale(DSDatabase.Instance.CurrentLanguage);Locale.setLanguage(DSDatabase.Instance.CurrentLanguage);this.draw();this.progressStatus();this.setTitle(this._title);this.Help=this._link;$("body > main").show();this.onOpen();t.Id<0?($("body > header > ul > .photo").unbind(),$("body > header > ul > .photo > img").css("cursor","initial")):($("body > header > ul > .photo").click(f()),$("body > header > ul > .photo > img").css("cursor","pointer"));t!==null&&(DSDatabase.Instance.addEventListener("onUpdate","User",t.Id,i()),DSDatabase.Instance.addEventListener("onDelete","User",t.Id,i()));r!==null&&(DSDatabase.Instance.addEventListener("onUpdate","Module",r.Id,i()),DSDatabase.Instance.addEventListener("onDelete","Module",r.Id,i()));u!==null&&DSDatabase.Instance.addEventListener("onDelete","UserModule",u.Id,i());DSDatabase.Instance.addEventListener("onStartCommit","*","*",function(n,t){GUI.Box.Progress.SetStatus(0,t,"MSG_COMMITTING");GUI.Box.Progress.Start()});DSDatabase.Instance.addEventListener("onCommit","*","*",function(){GUI.Box.Progress.SetStatus()});DSDatabase.Instance.addEventListener("onStopCommit","*","*",function(){GUI.Box.Progress.Stop()});DSDatabase.Instance.addEventListener("onBeginNotification","*","*",e(this));DSDatabase.Instance.addEventListener("onNotify","*","*",o(this));$("body > footer > .release").click(h(this,s(this)));$("body > footer > .company").click(function(){window.open("http://www.concilium-lesert.fr","_blank")});$("body > header > ul > .area.screen_name").click(c(this));DSDatabase.Instance.addEventListener("onCreate","UserModule","*",n());DSDatabase.Instance.addEventListener("onUpdate","UserModule","*",n());DSDatabase.Instance.addEventListener("onDelete","UserModule","*",n());DSDatabase.Instance.addEventListener("onLoad","UserModule","*",n());DSDatabase.Instance.addEventListener("onCreate","Module","*",n());DSDatabase.Instance.addEventListener("onUpdate","Module","*",n());DSDatabase.Instance.addEventListener("onDelete","Module","*",n());DSDatabase.Instance.addEventListener("onLoad","Module","*",n());n(this)()}}startApplication(n){this.info("Parameters : "+String.JSONStringify(n))}drawSheets(){}draw(){var n,t;for(super.draw(null),n=[],this.drawSheets(this._container,n),this.progressStatus(0,n.length+1,"MSG_INITIALIZING"),t=0;t<n.length;t++)n[t](),this.progressStatus();$("body > main > sheet > buttons > #submit").html(Helper.Span("BTN_SUBMIT"));$("body > main > sheet > buttons > #cancel").html(Helper.Span("BTN_CANCEL"))}onOpen(){if(super.onOpen(),this._firstMenu!==null)this.onMenu(this._firstMenu)}refresh(){var u=0,t=this._menu[this._currentMenu],i=null,n=null,r=0;if(GUI.Box.Progress.Start(),t!==null&&t!==undefined&&(u+=t.boards.length,i=t.menu[this._currentSubMenu],i!==null&&i!==undefined&&(u+=i.boards.length)),GUI.Box.Progress.SetStatus(0,u+1,"MSG_REFRESHING"),GUI.Box.Progress.SetStatus(),t!==null&&t!==undefined){for(r in t.boards)(n=t.boards[r],n!==null&&n!==undefined)&&(n.refresh(),n.populateWebix(),n.adjustWebix(),GUI.Box.Progress.SetStatus());if(i=t.menu[this._currentSubMenu],i!==null&&i!==undefined)for(r in i.boards)(n=i.boards[r],n!==null&&n!==undefined)&&(n.refresh(),n.populateWebix(),n.adjustWebix(),GUI.Box.Progress.SetStatus())}GUI.Box.Progress.Stop()}constructor(n,t,i){super("area","body > main",n);this._link=null;this._title=null;this._element=null;this._firstLoad=!0;this._moduleId=i===null||i===undefined?-1:i;this._boards={};this._firstMenu=null;this._menu={};this._currentMenu=null;this._currentSubMenu=null;this.setTitle(t)}}