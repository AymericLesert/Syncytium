var Namespace={},Digits,Language,Filter,List,GUI;Namespace.isDefined=function(n){try{return eval(n),!0}catch(t){return!1}};Array.isEmpty=function(n){if(n===null||n===undefined||n.length===null||n.length===undefined)return!0;if(n.length>0)return!1;for(let n in n)return!1;return!0};Array.toIterable=function*(n){if(n!==null&&n!==undefined)for(let t in n)yield n[t]};class Dates{static Check(n,t,i,r,u){let e=[],f=[],o=new moment;for(let i of Array.toIterable(i)){if(t[i]===null||t[i]===undefined||!(t[i]instanceof moment)){u.addField(i,"ERR_FIELD_REQUIRED",["{"+n.toUpperCase()+"_"+i.toUpperCase()+"}"]);continue}e.push(i)}for(let i of e){if(r&&t[i]>o){u.addField(i,"ERR_"+n.toUpperCase()+"_DATE",["{"+n.toUpperCase()+"_"+i.toUpperCase()+"}","{"+n.toUpperCase()+"_NOW}"]);continue}f.push(i)}for(let i=0;i<f.length-1;i++)for(let r=i+1;r<f.length;r++)t[f[i]]>t[f[r]]&&u.addField(f[i],"ERR_"+n.toUpperCase()+"_DATE",["{"+n.toUpperCase()+"_"+f[i].toUpperCase()+"}","{"+n.toUpperCase()+"_"+f[r].toUpperCase()+"}"])}static Compare(n,t){return(n===null||n===undefined)&&(t===null||t===undefined)?0:(n!==null&&n!==undefined&&typeof n=="string"&&(n=new moment(n)),t!==null&&t!==undefined&&typeof t=="string"&&(t=new moment(t)),n===null||n===undefined||!n.isValid())?1:t===null||t===undefined||!t.isValid()?-1:n<t?-1:n>t?1:0}static isDateVisible(n,t,i){let r=0,u=0;if(i===null||i===undefined||i.length===null||i.length===undefined||i.length===0)return!1;for(r=0;r<i.length&&i[r].indexOf(n)>=0;r++);if(r===i.length)return!0;if(i.length===1)return!1;for(r=0;r<i.length;r++){let f=i[r].indexOf(n);if(!(f<0)){for(u=f-1;u>=0&&Dates.isDateVisible(i[r][u],t,i);u--);if(u<0&&t[n]!==null&&t[n]!==undefined)return!0}}let f=0;for(r=1;r<i.length;r++)i[r].length<i[f].length&&(f=r);return i[f].indexOf(n)>=0}static getLongestPath(n,t){if(t===null||t===undefined||t.length===null||t.length===undefined||t.length===0)return[];if(t.length===1)return t[0];let i=0;for(let r=0;r<t[0].length;r++)Dates.isDateVisible(t[0][r],n,t)&&i++;let r=0;for(let u=1;u<t.length;u++)if(!(i>=t[u].length)){let f=0;for(let i=0;i<t[u].length;i++)Dates.isDateVisible(t[u][i],n,t)&&f++;i<f&&(r=u,i=f)}return t[r]}static get Today(){return this._today===undefined&&(this._intervalToday=setInterval(()=>{this._today=(new moment).startOf("day")},6e4),this._today=(new moment).startOf("day")),this._today}}class Errors{get HasError(){if(this._global.length>0||this._fatal.length>0)return!0;for(let n in this._fields)return!0;for(let n in this._errors)return!0;return!1}get HasFatal(){if(this._fatal.length>0)return!0;for(let n of Array.toIterable(this._errors))if(n.HasFatal)return!0;return!1}clear(){this._errors={};this._fields={};this._global=[];this._fatal=[]}addError(n,t){t!==null&&t!==undefined&&t.HasError&&(this._errors[n]||(this._errors[n]=[]),this._errors[n].push(t))}addField(n,t,i){this._fields[n]||(this._fields[n]={ignore:!1,errors:[]});this._fields[n].errors.push({message:t,parameters:i})}getField(n){let t=this._fields[n];if(t===null||t===undefined||Array.isEmpty(t.errors))return null;let i="<ul>";for(let n of t.errors)i+="<li>",i+=Helper.Span(n.message,n.parameters),i+="<\/li>";return i+="<\/ul>"}ignoreField(n){this._fields[n]||(this._fields[n]={ignore:!0,errors:[]});this._fields[n].ignore=!0}addGlobal(n,t){this._global.push({message:n,parameters:t})}addFatal(n,t){this._fatal.push({message:n,parameters:t})}addErrors(n){if(n.HasError){for(let t in n._fields){n._fields[t].ignore===!0&&this.ignoreField(t);for(let n of n._fields[t].errors)this.addField(t,n.message,n.parameters)}for(let t in n._errors)for(let n of n._errors[t])this.addError(t,n);for(let t of n._global)this.addGlobal(t.message,t.parameters);for(let t of n._fatal)this.addFatal(t.message,t.parameters)}}setJSON(n){if(this.clear(),n.Fatals!==null&&n.Fatals!==undefined)for(let t of n.Fatals)this._fatal.push({message:t.Message,parameters:t.Parameters});if(n.Globals!==null&&n.Globals!==undefined)for(let t of n.Globals)this._global.push({message:t.Message,parameters:t.Parameters});if(n.Fields!==null&&n.Fields!==undefined)for(let t in n.Fields){this._fields[t]={ignore:!1,errors:[]};for(let n of n.Fields[t])this._fields[t].errors.push({message:n.Message,parameters:n.Parameters})}}summary(n){if(!this.HasError)return"";if(n===null||n===undefined){let n=0;for(let t in this._fields)n++;for(let t in this._errors)n++;if(n===0&&this._global.length===0&&this._fatal.length===0)return"";if(n===0&&this._global.length===0&&this._fatal.length===1)return Helper.Span(this._fatal[0].message,this._fatal[0].parameters);if(n===0&&this._global.length===1&&this._fatal.length===0)return Helper.Span(this._global[0].message,this._global[0].parameters)}let t="<ul>",i=!0;for(let n of this._fatal)t+="<li>",t+=Helper.Span(n.message,n.parameters),t+="<\/li>",i=!1;for(let n of this._global)t+="<li>",t+=Helper.Span(n.message,n.parameters),t+="<\/li>",i=!1;for(let n in this._fields)if(this._fields[n].ignore!==!0){t+="<li>";t+=String.encode(n);t+="<ul>";for(let i in this._fields[n].errors){let r=this._fields[n].errors[i];t+="<li>";t+=Helper.Span(r.message,r.parameters);t+="<\/li>"}t+="<\/ul>";t+="<\/li>";i=!1}for(let n in this._errors){t+="<li>";t+=String.encode(n);for(let n of this._errors[n])t+=n.summary(!0);t+="<\/li>";i=!1}return i?"":t+"<\/ul>"}toString(n){if(!this.HasError)return"";(n===null||n===undefined)&&(n="EN");let t="";for(let i of this._fatal)t.length!==0&&(t+=", "),t+=Language.Manager.Instance.interpolation(i.message,i.parameters,n);for(let i of this._global)t.length!==0&&(t+=", "),t+=Language.Manager.Instance.interpolation(i.message,i.parameters,n);for(let i in this._fields){t.length!==0&&(t+=", ");t+=i+": {";let r=!0;for(let i of this._fields[i].errors)r||(t+=", "),r=!1,t+=Language.Manager.Instance.interpolation(i.message,i.parameters,n);t+="}"}for(let i in this._errors){t.length!==0&&(t+=", ");t+=i+": {";let r=!0;for(let i of this._errors[i])r||(t+=", "),r=!1,t+=i.toString(n);t+="}"}return t}toClipboard(n,t){if(!this.HasError)return"";(n===null||n===undefined)&&(n="EN");(t===null||t===undefined)&&(t="");let r=String.isEmptyOrWhiteSpaces(t)?"":t+" ",i="";for(let t of this._fatal)i.length!==0&&(i+="\n"),i+=r+Language.Manager.Instance.interpolation(t.message,t.parameters,n);for(let t of this._global)i.length!==0&&(i+="\n"),i+=r+Language.Manager.Instance.interpolation(t.message,t.parameters,n);for(let u in this._fields){i.length!==0&&(i+="\n");i+=r+u+" :\n";let f=!0;for(let r of this._fields[u].errors)f||(i+="\n"),f=!1,i+=t+"* "+Language.Manager.Instance.interpolation(r.message,r.parameters,n)}for(let u in this._errors){i.length!==0&&(i+="\n");i+=r+u+" :\n";let f=!0;for(let r of this._errors[u])f||(i+="\n"),f=!1,i+=r.toClipboard(n,t+"*")}return i}constructor(n,t){this._errors={};this._fields={};this._global=[];this._fatal=[];n!==undefined&&this.addGlobal(n,t)}}class Helper{static Label(n,t,i){let r={label:null,parameters:null,language:null};return typeof n=="string"?r={label:n,parameters:t?t:null,language:i?i:null}:n!==null&&n!==undefined&&typeof n=="object"&&(r={label:n.label,parameters:n.parameters,language:n.language},r.parameters=t?t:r.parameters,r.language=i?i:r.language),r.parameters===null||r.parameters===undefined||Array.isArray(r.parameters)||(r.parameters=[r.parameters]),r}static IsLabel(n,t){return n===null||n===undefined?!1:typeof n=="string"&&!String.isEmptyOrWhiteSpaces(n)&&(t===null||t===undefined||!t)?!0:n.label!==undefined&&n.language!==undefined&&n.parameters!==undefined}static Span(n,t,i){let r=Helper.Label(n,t,i);if(String.isEmptyOrWhiteSpaces(r.label))return"";let u="<span";if(r.language!==null&&r.language!==undefined&&(u+=' k-language="'+r.language+'"'),r.label!==null&&r.label!==undefined&&(u+=' k-label="'+r.label+'"'),r.parameters!==null&&r.parameters!==undefined&&r.parameters.length>0)for(let n in r.parameters)u+=" k-label-"+n+'="'+r.parameters[n]+'"';return u+">"+String.encode(Language.Manager.Instance.interpolation(r))+"<\/span>"}static Option(n,t,i,r){let u=Helper.Label(t,i,r);if(String.isEmptyOrWhiteSpaces(u.label))return"";let f="<option";if(n!==null&&n!==undefined&&(f+=' value="'+n.toString()+'"'),u.language!==null&&u.language!==undefined&&(f+=' k-language="'+u.language+'"'),u.label!==null&&u.label!==undefined&&(f+=' k-label="'+u.label+'"'),u.parameters!==null&&u.parameters!==undefined&&u.parameters.length>0)for(let n in u.parameters)f+=" k-label-"+n+'="'+u.parameters[n]+'"';return f+">"+String.encode(Language.Manager.Instance.interpolation(u))+"<\/option>"}}class Logger{static get LOG_FILENAME(){return"log.txt"}static get MAX_LINES(){return 1e5}get IsVerboseAll(){return this._isVerboseAll}set IsVerboseAll(n){this._isVerboseAll=n===!0;this._isVerbose=n===!0;this._isDebug=n===!0}get IsVerbose(){return this._isVerbose}set IsVerbose(n){this._isVerbose=n===!0;this._isDebug=this._isVerbose===!0}get IsDebug(){return this._isDebug}set IsDebug(n){this._isDebug=n===!0}get IsEnabled(){return this._isEnabled}set IsEnabled(n){this._isEnabled=n===!0}get Visible(){return this._logTable?this._logTable.isVisible():!1}downloadLogFile(){function i(n,t){return function(i){let r=n.getItem(i);t.push(r.id.toString().padEnd(8," ")+" "+r.date+" ["+r.level+"] "+String.decode(r.module).padEnd(48," ")+" "+r.allDescription)}}if(!this._logTable)return!0;let t=[];this._logTable.eachRow(i(this._logTable,t));let r=new Blob([t.join("\n")],{type:"text/plain;charset=utf-8"});this._logFile!==null&&window.URL.revokeObjectURL(this._logFile);this._logFile=window.URL.createObjectURL(r);let n=document.createElement("a");return n.setAttribute("download",Logger.LOG_FILENAME),n.href=this._logFile,document.getElementById("log").appendChild(n),window.requestAnimationFrame(function(){let t=new MouseEvent("click");n.dispatchEvent(t);document.getElementById("log").removeChild(n)}),!0}write(n,t,i){let r={id:this._id,date:(new moment).format("YYYY/MM/DD HH:mm:ss.SSS"),level:n,module:t,message:i};if(this._id++,this.define(),this._isEnabled&&this._logTable){let n=String.encode(r.message),t=null;t=n.length>4096?n.substring(0,4096)+"[...]":n;this._logTable.add({id:this.id,date:r.date,level:r.level,module:String.encode(r.module),description:t,allDescription:n});this._logTable.count()>Logger.MAX_LINES&&this._logTable.remove(this._logTable.getFirstId())}}adjustWebix(n){function i(n,t,i){if(i!==null&&i!==undefined){let r=1;for(let t of Array.toIterable(t)){let u=n._logTable.getColumnConfig(t);$(n._logAdjustedZoneHTML).css("width",u.width+"px");$(n._logAdjustedZoneHTML).css("height","1px");n._logAdjustedZoneHTML.innerHTML=n._logTable.getText(i.id,u.id);r<n._logAdjustedZoneHTML.scrollHeight&&(r=n._logAdjustedZoneHTML.scrollHeight);n._logAdjustedZoneHTML.innerHTML=""}i.$height=r}}function r(n,t){return function(r){i(n,t,r)}}if(this._logTable!==null){this._logAdjustedZone===null&&(this._logAdjustedZone=$("<div class='webix_view webix_dtable webix_log'><div class='webix_ss_body'><div class='webix_ss_center'><div class='webix_ss_center_scroll'><div class='webix_column'><div class='webix_cell'><\/div><\/div><\/div><\/div><\/div><\/div>"),this._logAdjustedZone.css("visibility","hidden"),$(this._logTable.$view).append(this._logAdjustedZone),this._logAdjustedZoneHTML=this._logAdjustedZone.find("> div > div > div > div > div")[0]);let t=[];for(let n of Array.toIterable(this._logTable.config.columns))t.push(n.id);n!==null&&n!==undefined?(i(this,t,this._logTable.getItem(n)),this._logTable.refresh(n)):(this._logTable.data.each(r(this,t)),this._logTable.refresh())}}define(){function t(n){return function(t){n.adjustWebix(t)}}function n(n,t){return function(n){switch(n.level){case"V":return"<span class='verbose'>"+n[t]+"<\/span>";case"D":return"<span class='debug'>"+n[t]+"<\/span>";case"I":return"<span class='info'>"+n[t]+"<\/span>";case"W":return"<span class='warning'>"+n[t]+"<\/span>";case"E":return"<span class='error'>"+n[t]+"<\/span>";default:return n[t]}}}function i(n){return function(){clearTimeout(n._throttle);n._throttle=setTimeout(function(){n._logTable.isVisible()&&n._logTable.resize()},100)}}if(this._isEnabled&&!this._logTable){this._logTable=new webix.ui({view:"datatable",container:$("log")[0],css:"webix_log",scroll:"y",scrollAlignY:!1,columns:[{id:"date",header:"Date",adjust:"data",fillspace:2,css:{"text-align":"center"},template:n(this,"date")},{id:"level",header:"Level",adjust:"header",fillspace:1,css:{"text-align":"center"},template:n(this,"level")},{id:"module",header:"Module",adjust:"data",fillspace:2,css:{"text-align":"center"},template:n(this,"module")},{id:"description",header:"Description (<a href='#' onclick='javascript:Logger.Instance.downloadLogFile();'>client<\/a> - <a href='/Administration/Administration/Log?date="+(new moment).format("YYYY-MM-DD")+"' target='_blank'>server<\/a>)",adjust:"data",fillspace:15,css:{"text-align":"left"},template:n(this,"description")}],resizeColumn:!0,fixedRowHeight:!1,rowLineHeight:15,rowHeight:15,on:{onItemDblClick:t(this)}});this._logTable.hide();$(window).on("resize",i(this));this.write("I","Log","-----------------------------------------------------");this.write("I","Log","Module : "+this._moduleArea);this.write("I","Log","Version : "+this._moduleVersion);this.write("I","Log","Parameters : "+window.location.search);this.write("I","Log","-----------------------------------------------------");this.id++}}setModule(n,t){this._moduleArea=n;this._moduleVersion=t}show(){(this.define(),this._logTable)&&($("page").hide(),$("log").show(),this._logTable.show())}hide(){(this.define(),this._logTable)&&(this._logTable.hide(),$("log").hide(),$("page").show())}verbose(n,t){this._isVerbose&&this.write("V",n,t)}debug(n,t){this._isDebug&&this.write("D",n,t)}info(n,t){this.write("I",n,t)}warn(n,t){this.write("W",n,t);console.warn("["+n+"] "+t)}error(n,t){this.write("E",n,t);console.error("["+n+"] "+t)}exception(n,t,i){i!==null&&i!==undefined&&(i.message&&(t+=" : "+i.message),i.stack&&(t+=" | stack: "+i.stack),typeof i=="string"&&(t+=" : "+i));this.write("E",n,t);console.error("["+n+"] "+t)}status(n){function u(){return function(){$("header > ul > li.status").hasClass("started")===!0?($("header > ul > li.status").removeClass("started"),$("header > ul > li.status").addClass("stopped")):($("header > ul > li.status").removeClass("stopped"),$("header > ul > li.status").addClass("started"))}}this._currentStatus=n;let i=$("header > ul > li.status");i.unbind();let t=null,r=["starting","started","stopping","stopped","readytosynchronize"];switch(n){case"Starting":t="starting";this._currentStatus="STATUS_STARTING";break;case"Started":t="started";this._currentStatus="STATUS_STARTED";break;case"Stopping":t="stopping";this._currentStatus="STATUS_STOPPING";break;case"Error":case"NotInitialized":case"Stopped":t="stopped";this._currentStatus="STATUS_STOPPED";break;case"ReadyToSynchronize":t="readytosynchronize";this._currentStatus="STATUS_READY";$("header > ul > li.status").click(function(){Hub.Instance.synchronize()})}this._intervalStatus!==null&&(window.clearInterval(this._intervalStatus),this._intervalStatus=null);for(let n=0;n<r.length;n++)i.removeClass(r[n]);t==="starting"||t==="stopping"?this._intervalStatus=window.setInterval(u(this),1e3):t!==null&&i.addClass(t);i.hover(function(){$('<p class="image webix_tooltip"><\/p>').html(Helper.Span(Logger.Instance._currentStatus)).appendTo("body").fadeIn("slow")},function(){$(".image.webix_tooltip").remove()}).mousemove(function(n){let t=n.pageX+10,i=n.pageY;$(".image.webix_tooltip").css({top:i,left:t})})}constructor(){this._isVerboseAll=!1;this._isVerbose=!1;this._isDebug=!1;this._isEnabled=!1;this._logTable=null;this._logAdjustedZone=null;this._logAdjustedZoneHTML=null;this._currentStatus=null;this._logFile=null;this._id=0;this._moduleArea="";this._moduleVersion="";this._intervalStatus=null;this._throttle=null}static get Instance(){return this._instance||(this._instance=new Logger),this._instance}}class LoggerBaseObject{get Module(){return this._module}get IsVerboseAll(){return Logger.Instance.IsVerboseAll}get IsVerbose(){return Logger.Instance.IsVerbose}get IsDebug(){return Logger.Instance.IsDebug}verbose(n){Logger.Instance.IsVerbose&&Logger.Instance.verbose(this._module,n)}debug(n){Logger.Instance.IsDebug&&Logger.Instance.debug(this._module,n)}info(n){Logger.Instance.info(this._module,n)}warn(n){Logger.Instance.warn(this._module,n)}error(n){Logger.Instance.error(this._module,n)}exception(n,t){Logger.Instance.exception(this._module,n,t)}toString(){return String.JSONStringify(this)}constructor(n){this._module=n}}class CSV extends LoggerBaseObject{get Name(){return this._name}get Charset(){return this._charset}get Separator(){return this._separator}get RowCount(){return this._rowCount}get RowCurrent(){return this._rowNumber}get RowAdded(){return this._rowAdded}get RowUpdated(){return this._rowUpdated}get RowDeleted(){return this._rowDeleted}get WillDeleteRows(){return this._willDeletedRows}addRow(n){this._row.push({_table:n===undefined||n===null?null:n});this._rowCount++;this._rowNumber++}addHeaderRecord(n,t){let i=this._tablesByOrder.length>1;for(let r in t)if(!r.startsWith("_")&&r!=="Id"){let u=r==="CustomerId"||r.startsWith("Copy");u||t._list===null||t._list===undefined||t._list.column!==r||(u=!0);n[r]={table:n._table,attribut:r,label:(i?n._table+".":"")+r,list:n._list,ignore:u};this._headers.push(n[r])}if(t._subLists!==null&&t._subLists!==undefined)for(let r in t._subLists){let u=t._subLists[r];u!==null&&u!==undefined&&u.composition&&(n[r]={table:n._table,attribut:r,label:(i?n._table+".":"")+r,list:n._list,ignore:!1},this._headers.push(n[r]))}}writeHeaderFromList(n,t){if(t!==null&&t!==undefined){let i={_table:n,_list:t===null||t===undefined?null:t};this._tablesByName[n]=i;this._tablesByOrder.push(i);this.addHeaderRecord(i,t.NewItem)}}writeRecordFromList(n,t,i){if(t!==null&&t!==undefined){this._row[this._rowCount-1][n]=t===null||t===undefined?null:t;let r=this._tablesByName[n];if(r!==undefined){for(let n in t)r[n]===null||r[n]===undefined||r[n].ignore;return}(i===null||i===undefined)&&t._list!==undefined&&t._list!==null&&(i=t._list);r={_table:n,_list:i===null||i===undefined?null:i};this._tablesByName[n]=r;this._tablesByOrder.push(r);this.addHeaderRecord(r,t)}}writeFromList(n,t){function i(n,r,u){return function(f){n.addRow(r.Table);for(let t in u)n.writeRecordFromList(u[t].list.Table,u[t].record,u[t].list);if(n.writeRecordFromList(r.Table,f,r),f._subLists!==null&&f._subLists!==undefined){u.push({list:r,record:f});for(let r in f._subLists){let e=f._subLists[r];if(e!==null&&e!==undefined&&(e.composition||t)){let o=f[r];for(let t in o)i(n,e.list,u)(o[t])}}u.pop()}}}n!==null&&n!==undefined&&(t=t!==null&&t!==undefined&&t===!0,this._row=[],this._rowCount=0,this._rowNumber=0,this.writeHeaderFromList(n.Table,n),n.each(i(this,n,[])))}toBlob(n,t){let i=0,r=0,h=0,f=0,o=[],e=null,u=[],s="";if(this.info("Building CSV file ..."),Array.isArray(n))for(i=0;i<this._headers.length;i++){let t=!1;if(!this._headers[i].ignore){for(r=0;r<n.length&&!t;r++)n[r]===this._headers[i].label?t=!0:Array.isArray(n[r])&&n[r][0]===this._headers[i].label&&(t=!0,typeof n[r][1]=="string"&&(this._headers[i].label=n[r][1]));this._headers[i].ignore=!t;t&&u.push(this._headers[i].label)}}else for(i=0;i<this._headers.length;i++)this._headers[i].ignore||u.push(this._headers[i].label);for(o.push(u),t&&t(0,2*this._row.length),i=0,h=1;i<this._row.length;i++){let n=!0,s=this._row[i];for(e=u,u=[],r=0,f=0;r<this._headers.length;r++){let t=this._headers[r];if(!t.ignore){if(t.table===null&&t.attribut==="line"){u.push(h);f++;continue}if(t.table===null&&t.attribut==="table"){u.push(s._table);f++;continue}if(t===null||t===undefined){e[f]!==null&&e[f]!==undefined&&(n=!1);u.push(null);f++;continue}let i=s[t.table];if(i===null||i===undefined){e[f]!==null&&e[f]!==undefined&&(n=!1);u.push(null);f++;continue}let o=null;o=t.list===null?i[t.attribut]:t.list.getAttributCSV(i,t.attribut);e[f]!==o&&(n=!1);u.push(o);f++}}n||(o.push(u),h++);t&&t()}for(t&&t(this._row.length,this._row.length+o.length),s=this._charset.toLowerCase()==="utf-8"?"﻿":"",i=0;i<o.length;i++){for(u=o[i],r=0;r<u.length;r++)s+=String.convertCSV(u[r],this._separator),r<u.length-1&&(s+=this._separator);s+="\n";t&&t()}return this.info("CSV file built"),new Blob([s],{encoding:this.Charset,type:"text/csv;charset="+this.Charset})}*toBlobFromList(n,t){this._blob=null;this.info("Building CSV file from a list ...");yield GUI.Box.Progress.Status(0,1,Helper.Label("MSG_EXPORT_WRITING",this.Name));let r=n.getList();this.info("Exporting "+r.length+" lines into the CSV file ...");yield GUI.Box.Progress.Status(0,r.length+1);let i=this._charset.toLowerCase()==="utf-8"?"﻿":"",u=!1;for(let n of t)u&&(i+=this._separator),u=!0,i+=Array.isArray(n)?String.convertCSV(n[1],this._separator):String.convertCSV(n,this._separator);i+="\n";yield GUI.Box.Progress.Status();for(let r of Array.toIterable(r)){let u=!1;for(let t of t){let f=Array.isArray(t)?t[0]:t;u&&(i+=this._separator);u=!0;i+=String.convertCSV(n.getAttributCSV(r,f),this._separator)}i+="\n";yield GUI.Box.Progress.Status()}this.info("CSV file built");this._blob=new Blob([i],{encoding:this.Charset,type:"text/csv;charset="+this.Charset})}get Blob(){return this._blob}hasFile(n){for(let t of this._files)if(t.name===n)return!0;return!1}hasHeader(n,t){if(this._files.length===0)return!1;if(t===null||t===undefined)return this._files[0].headersByName[n]!==undefined;for(let i of this._files)if(i.name===t)return i.headersByName[n]!==undefined;return!1}*toList(n,t,i,r,u,f,e,o,s,h){let a=this._name,v=0,c=[],l={};if(this._row=[],this._rowCount=0,this._rowNumber=0,e=e===null||e===undefined||e===!0,o=o===null||o===undefined||o===!0,s=s!==null&&s!==undefined&&s===!0,this._willDeletedRows=s,e&&(this._rowAdded=0,this._rowUpdated=0,this._rowDeleted=0),this._files=[{name:this._name,content:this._content,startIndex:0,size:0,firstRow:0,headers:[],headersByName:{},rowCount:0}],h!==null&&h!==undefined&&Array.isArray(h)&&h.length>0)for(let n of Array.toIterable(h))this._files.push({name:n.name,content:n.csv===null||n.csv===undefined||String.isEmptyOrWhiteSpaces(n.csv._content)?"":n.csv._content,startIndex:0,size:0,firstRow:0,headers:[],headersByName:{},rowCount:0});try{yield GUI.Box.Progress.Status(0,this._files.length,i);for(let n of this._files){if(this._name=n.name,String.isEmptyOrWhiteSpaces(n.content)){t.addGlobal("ERR_CSV_FILE_MISSING",[n.name]);continue}n.size=n.content.length;n.startIndex=0;n.content[0]==="﻿"&&n.startIndex++;n.content.length>2&&n.content[0].charCodeAt()===239&&n.content[1].charCodeAt()===187&&n.content[2].charCodeAt()===191&&(n.startIndex+=3);let i,r=0,f=!1;for(i=n.startIndex;i<n.size&&n.content[i]!=="\n"&&n.content[i]!=="\r";i++){let u=n.content[i];if(u==='"')f=!f;else if(u==="\\")i<n.size&&i++;else if(u===this._separator&&!f){let u=String.cleanupCSV(n.content.substring(n.startIndex,i));n.headersByName[u]!==undefined&&t.addGlobal("ERR_CSV_HEADERDOUBLE",[u,r,n.name]);n.headers.push(u);n.headersByName[u]=r;n.startIndex=i+1;r++}}let u=String.cleanupCSV(n.content.substring(n.startIndex,i));for(n.headersByName[u]!==undefined&&t.addGlobal("ERR_CSV_HEADERDOUBLE",[u,r,n.name]),n.headers.push(u),n.headersByName[u]=r;i<=n.size&&(n.content[i]==="\n"||n.content[i]==="\r"||n.content[i]===undefined);i++)n.content[i]==="\n"&&n.firstRow++;n.startIndex=i;n.rowCount=n.content.count("\n");v+=n.rowCount-n.firstRow;yield GUI.Box.Progress.Status()}if(t.HasError)return this._files=[],null;if(this._name=a,!n.startCSV(this,t))return t.HasError||t.addGlobal("CSV_ABORTED"),this._files=[],null;if(Array.isArray(h)){yield GUI.Box.Progress.Status(0,v);let i=!1;for(let r of this._files){if(this._name=r.name,this._rowNumber=r.firstRow,this._rowCount=r.rowCount,c=[],l={},!n.startPreloadingCSV(this,t)){i=!0;break}let u=new Errors,f=r.startIndex;for(let e=f,o=0,s=!1;e<=r.size&&!i;e++){let h=e===r.size?"\n":r.content[e];if(h==='"')s=!s;else if(h==="\\")e++;else if(h!==this._separator||s){if(h==="\n"||h==="\r"){let h=String.cleanupCSV(r.content.substring(f,e));for(c[o]=h,l[r.headers[o]]=h,o++;e<r.size&&(r.content[e]==="\n"||r.content[e]==="\r");e++)r.content[e]==="\n"&&(this._rowNumber++,yield GUI.Box.Progress.Status());f=e;e<r.size&&e--;o!==r.headers.length?u.addGlobal("ERR_CSV_COLUMN_MISSING",[o,r.headers.length]):n.preloadRecordFromCSV(this,c,l,u)||(i=!0);u.HasFatal&&(i=!0);u.HasError&&(t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[r.name,this.RowCurrent]),u),u=new Errors);o=0;s=!1}}else{let n=String.cleanupCSV(r.content.substring(f,e));c[o]=n;l[r.headers[o]]=n;o++;f=e+1}}if(i=!n.endPreloadingCSV(this,t)||i,i&&!t.HasError&&t.addGlobal("CSV_ABORTED"),i)break}if(t.HasError)return this._name=a,n.endCSV(this,t),this._files=[],null}if(this._name=a,c=[],l={},e){let i=this._files[0];if(this._rowNumber=i.firstRow,this._rowCount=i.rowCount,yield GUI.Box.Progress.Status(this.RowCurrent,this.RowCount,r),!n.startCheckingCSV(this,t))return n.endCSV(this,t),t.HasError||t.addGlobal("CSV_ABORTED"),this._files=[],null;let f=!1,u=new Errors,e=i.startIndex;for(let r=e,o=0,s=!1;r<=i.size&&!f;r++){let h=r===i.size?"\n":i.content[r];if(h==='"')s=!s;else if(h==="\\")r++;else if(h!==this._separator||s){if(h==="\n"||h==="\r"){let h=String.cleanupCSV(i.content.substring(e,r));for(c[o]=h,l[i.headers[o]]=h,o++;r<i.size&&(i.content[r]==="\n"||i.content[r]==="\r");r++)i.content[r]==="\n"&&(this._rowNumber++,yield GUI.Box.Progress.Status());if(e=r,r<i.size&&r--,o!==i.headers.length?u.addGlobal("ERR_CSV_COLUMN_MISSING",[o,i.headers.length]):n.checkRecordFromCSV(this,c,l,u)||(f=!0),!f&&!u.HasError){let t=n.getRecordFromCSV(this,c,l,u);t===null||u.HasError||(t.oldItem===null&&t.newItem!==null?this._rowAdded++:t.oldItem!==null&&t.newItem!==null&&(DSRecord.IsEqual(t.oldItem,t.newItem)||this._rowUpdated++))}u.HasFatal&&(f=!0);u.HasError&&(t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[i.name,this.RowCurrent]),u),u=new Errors);o=0;s=!1}}else{let n=String.cleanupCSV(i.content.substring(e,r));c[o]=n;l[i.headers[o]]=n;o++;e=r+1}}if(f=!n.endCheckingCSV(this,t)||f,f&&!t.HasError&&t.addGlobal("CSV_ABORTED"),t.HasError)return n.endCSV(this,t),this._files=[],null;this._rowDeleted=n.getRowToDeleteCSV(this)}if(o){let i=this._files[0];if(this._rowNumber=i.firstRow,this._rowCount=i.rowCount,yield GUI.Box.Progress.Status(this.RowCurrent,this.RowCount,u),!n.startImportingCSV(this,t))return n.endCSV(this,t),t.HasError||t.addGlobal("CSV_ABORTED"),this._files=[],null;this._rowAdded=0;this._rowUpdated=0;this._rowDeleted=0;let r=!1,e=new Errors,o=i.startIndex;for(let u=o,f=0,s=!1;u<=i.size&&!r;u++){let h=u===i.size?"\n":i.content[u];if(h==='"')s=!s;else if(h==="\\")u++;else if(h!==this._separator||s){if(h==="\n"||h==="\r"){let a=String.cleanupCSV(i.content.substring(o,u));for(c[f]=a,l[i.headers[f]]=a,f++;u<i.size&&(i.content[u]==="\n"||i.content[u]==="\r");u++)i.content[u]==="\n"&&(this._rowNumber++,yield GUI.Box.Progress.Status());o=u;u<i.size&&u--;let h=n.getRecordFromCSV(this,c,l,e);h===null||e.HasError||(h.oldItem===null&&h.newItem!==null?(n.addItemCSV(this,h.newItem,e,!0,!0),this._rowAdded++):h.oldItem!==null&&h.newItem!==null&&(DSRecord.IsEqual(h.oldItem,h.newItem)||(n.updateItemCSV(this,n.getId(h.oldItem),h.oldItem,h.newItem,e,!0,!0),this._rowUpdated++)));e.HasFatal&&(r=!0);e.HasError&&(t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[i.name,this.RowCurrent]),e),e=new Errors);f=0;s=!1}}else{let n=String.cleanupCSV(i.content.substring(o,u));c[f]=n;l[i.headers[f]]=n;f++;o=u+1}}if(s&&!r&&!t.HasError){yield GUI.Box.Progress.Status(0,1,f);let i=n.getItemsToDeleteCSV(this,t);if(yield GUI.Box.Progress.Status(),!t.HasError&&i.length>0){yield GUI.Box.Progress.Status(0,i.length,f);for(let r=0;r<i.length;r++){let u=i[r];if(n.deleteItemCSV(this,n.getId(u),u,t,!1),t.HasFatal)break;yield GUI.Box.Progress.Status()}}t.HasError&&(r=!0)}if(!r&&!t.HasError){yield GUI.Box.Progress.Status(0,1,u);let i=n.getItemsToPostUpdateCSV(this,t);if(yield GUI.Box.Progress.Status(),!t.HasError&&i.length>0){yield GUI.Box.Progress.Status(0,i.length,u);for(let r=0;r<i.length;r++){let u=i[r][0],f=i[r][1];if(n.updateItemCSV(this,n.getId(u),u,f,t,!0,!0),t.HasFatal)break;yield GUI.Box.Progress.Status()}}t.HasError&&(r=!0)}if(r=!n.endImportingCSV(this,t)||r,r&&!t.HasError&&t.addGlobal("CSV_ABORTED"),t.HasError)return n.endCSV(this,t),this._files=[],null;this._rowDeleted=n.getRowToDeleteCSV(this)}s||(this._rowNumber=0);n.endCSV(this,t)}catch(y){t.addFatal("ERR_CSV_UNEXPECTED",this.Name);this.exception("Unable to load data due to an unexpected error",y)}return this._name=a,this._files=[],null}copy(n){return new CSV(n,this,this._separator,this._charset)}constructor(n,t,i,r){super("CSV"+(n?"."+n:""));this._name=String.isEmptyOrWhiteSpaces(n)?"":n;this._content=t instanceof CSV?t._content:String.isEmptyOrWhiteSpaces(t)&&!(typeof t=="string")?null:t;this._charset=String.isEmptyOrWhiteSpaces(r)?"utf-8":r;this._separator=String.isEmptyOrWhiteSpaces(i)?";":i;this._blob=null;this._row=[];this._rowCount=0;this._rowNumber=0;this._rowAdded=0;this._rowUpdated=0;this._rowDeleted=0;this._willDeletedRows=!1;this._tablesByOrder=[];this._tablesByName={};this._headers=[];this._headers.push({table:null,attribut:"line",label:"line",list:null,ignore:!1});this._headers.push({table:null,attribut:"table",label:"table",list:null,ignore:!1});this._files=[]}}class DocPDF extends LoggerBaseObject{static get ROOT_FONT(){return URL_ROOT+"Content/Fonts/"}static get ROOT_PICTURE(){return URL_ROOT+"Content/Images/"}static get ROOT_WEBSITE(){return DSDatabase.Instance.Parameters["PDF.Web"]}static get ROOT_CONTACT(){return DSDatabase.Instance.Parameters["PDF.Contact"]}get MaxWidth(){switch(this._pageSize){case"A4":switch(this._pageOrientation){case"portrait":return Math.ceil(8.27*72)-this._pageMargins[0]-this._pageMargins[2];case"landscape":return Math.ceil(11.69*72)-this._pageMargins[0]-this._pageMargins[2]}break;default:return 0}}get MaxHeight(){switch(this._pageSize){case"A4":switch(this._pageOrientation){case"portrait":return Math.ceil(11.69*72)-this._pageMargins[1]-this._pageMargins[3]-1;case"landscape":return Math.ceil(8.27*72)-6-this._pageMargins[1]-this._pageMargins[3]}break;default:return 0}}get Fontname(){return String.isEmptyOrWhiteSpaces(this._fontname)?DSDatabase.Instance.Parameters["PDF.Font"]:this._fontname}set Fontname(n){this._fontname=n}get Content(){return this._doc===null?null:this._doc.content}async initialize(){return new Promise((n,t)=>{(pdfMake.tableLayouts===undefined||pdfMake.tableLayouts===null)&&(pdfMake.tableLayouts={});(pdfMake.tableLayouts.tableLayout===undefined||pdfMake.tableLayouts.tableLayout===null)&&(pdfMake.tableLayouts.tableLayout={hLineWidth:function(n,t){return n===t.table.body.length||n<=t.table.headerRows?1:0},vLineWidth:function(){return 1},hLineColor:function(){return"#666666"},vLineColor:function(){return"#666666"}});(pdfMake.fonts===undefined||pdfMake.fonts===null)&&(pdfMake.fonts={});let i=this.Fontname;switch(i){case"arial-unicode-ms":pdfMake.fonts[i]={normal:"arial-unicode-ms.ttf",bold:"arial-unicode-ms.ttf",italics:"arial-unicode-ms.ttf",bolditalics:"arial-unicode-ms.ttf"};i="arial-unicode-ms";break;case"dejavu":pdfMake.fonts[i]={normal:"DejaVuSans.ttf",bold:"DejaVuSans-Bold.ttf",italics:"DejaVuSans-Oblique.ttf",bolditalics:"DejaVuSans-BoldOblique.ttf"};i="dejavusans";break;case"dejavu-condensed":pdfMake.fonts[i]={normal:"DejaVuSansCondensed.ttf",bold:"DejaVuSansCondensed-Bold.ttf",italics:"DejaVuSansCondensed-Oblique.ttf",bolditalics:"DejaVuSansCondensed-BoldOblique.ttf"};i="dejavusans";break;case"opensans":pdfMake.fonts[i]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-Bold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-BoldItalic.ttf"};i="opensans";break;case"opensans-extra":pdfMake.fonts[i]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-ExtraBold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-ExtraBoldItalic.ttf"};i="opensans";break;case"opensans-light":pdfMake.fonts[i]={normal:"OpenSans-Light.ttf",bold:"OpenSans-Regular.ttf",italics:"OpenSans-LightItalic.ttf",bolditalics:"OpenSans-Italic.ttf"};i="opensans";break;case"opensans-semi":pdfMake.fonts[i]={normal:"OpenSans-Regular.ttf",bold:"OpenSans-Semibold.ttf",italics:"OpenSans-Italic.ttf",bolditalics:"OpenSans-SemiboldItalic.ttf"};i="opensans";break;case"microsoft-yaihei":pdfMake.fonts[i]={normal:"msyh.ttf",bold:"msyh.ttf",italics:"msyh.ttf",bolditalics:"msyh.ttf"};i="msyh";break;case"montserrat":pdfMake.fonts[i]={normal:"montserrat.ttf",bold:"montserrat.ttf",italics:"montserrat.ttf",bolditalics:"montserrat.ttf"};i="montserrat";break;default:i="roboto";pdfMake.fonts[i]={normal:"Roboto-Regular.ttf",bold:"Roboto-Medium.ttf",italics:"Roboto-Italic.ttf",bolditalics:"Roboto-MediumItalic.ttf"}}if(window.pdfMake!==null&&window.pdfMake!==undefined&&window.pdfMake.vfs!==null&&window.pdfMake.vfs!==undefined&&window.pdfMake.vfs[pdfMake.fonts[i].normal]!==null&&window.pdfMake.vfs[pdfMake.fonts[i].normal]!==undefined){n();return}if(!Hub.Instance.IsOnline){t();return}$.ajax({url:DocPDF.ROOT_FONT+"pdfmake-"+i+".js",dataType:"script",success:(t,r)=>{this.info("Font '"+i+"' loaded with status: "+r),typeof pdfMake!="undefined"&&typeof window.pdfMake.addVirtualFileSystem!="undefined"&&window.pdfMake.addVirtualFileSystem(window.pdfMake.vfs),n()},error:(n,r)=>{this.error("Unable to load the font '"+i+"' due to "+r),t()}})})}async create(n,t,i,r){this._doc===null&&await this.initialize().then(()=>{this._pageSize=String.isEmptyOrWhiteSpaces(t)?"A4":t,this._pageOrientation=String.isEmptyOrWhiteSpaces(i)?"portrait":i,(r===null||r===undefined)&&(this._pageMargins=this._pageOrientation==="portrait"?[20,90,20,30]:[90,20,30,20]),this._doc={pageSize:this._pageSize,pageOrientation:this._pageOrientation,pageMargins:this._pageMargins,compress:!1,header:function(t){let i={columns:[{image:"image_0",width:80,height:30,margin:[15,10,0,0]},{image:"image_1",width:345,margin:[20,26,20,0],height:1},{text:DocPDF.ROOT_CONTACT,width:150,margin:[0,22,15,0],style:"url"}]};return t>1&&n!==null&&n!==undefined&&(i=[i,{text:Language.Manager.Instance.interpolation(n).toUpperCase(),style:"subtitle"}]),i},content:[{text:n!==null&&n!==undefined?Language.Manager.Instance.interpolation(n).toUpperCase():"",decoration:"underline",decorationColor:"#7dc142",style:"title"}],images:{image_0:{name:"image_0",src:DocPDF.ROOT_PICTURE+"PDF/Syncytium.png"},image_1:{name:"image_1",src:DocPDF.ROOT_PICTURE+"PDF/Line.png"}},styles:{url:{fontSize:10,bold:!1,color:"#3a6bbb",alignment:"right"},title:{fontSize:26,bold:!1,color:"#333333",alignment:"center",margin:[0,0,0,10]},subtitle:{fontSize:12,bold:!0,color:"#333333",alignment:"left",margin:[20,15,0,10]},legend:{fontSize:6,bold:!1,color:"#333333",alignment:"center",italics:!0,margin:0},boardTitle:{fontSize:22,bold:!1,color:"#3a6bbb",alignment:"left",margin:[0,15,0,15]},tableHeader:{fontSize:6,italics:!0,bold:!0,color:"#eeeeee",fillColor:"#bfbfbf",margin:0},tableCell:{fontSize:6,italics:!1,bold:!1,fillColor:"#eeeeee",color:"#666666",margin:[0,0,0,0]},tableCellOdd:{fontSize:6,italics:!1,bold:!1,color:"#666666",fillColor:"#ebebeb",margin:[0,0,0,0]}},defaultStyle:{font:this.Fontname},footer:function(n,t){return{text:Language.Manager.Instance.interpolation("PDF_PAGE",[n.toString(),t.toString()],DSDatabase.Instance.CurrentLanguage),fontSize:8,alignment:"center"}}}})}addImage(n){let i=0;for(let t of Array.toIterable(this._doc.images)){if(t.src===n)return t.name;i++}let t="image_"+i.toString();return this._doc.images[t]={name:t,src:n},t}createTable(n,t,i){let f=0,u=0,e=1,r={headerRows:2,dontBreakRows:!0,widths:[],body:[]};for(let n in t)u+=t[n].size;u>0&&(e=(this.MaxWidth-this._doc.pageMargins[0]-this._doc.pageMargins[2]-10*t.length)/u);u=0;String.isEmptyOrWhiteSpaces(n)||r.body.push([{text:Language.Manager.Instance.interpolation(n),colSpan:t.length,style:"boardTitle",border:[!1,!1,!1,!0]}]);r.body.push([]);for(let n=0;n<t.length;n++){let f=Math.ceil(t[n].size*e)+1,i=Language.Manager.Instance.interpolation(t[n].title);i=i===null?"":i.toUpperCase();n===t.length-1&&(f=this.MaxWidth-this._doc.pageMargins[0]-this._doc.pageMargins[2]-9*t.length-u+1);r.widths.push(f);r.body[r.body.length-1].push({text:i,alignment:"center",style:"tableHeader"});n>0&&r.body.length>1&&r.body[0].push({});u+=f}i.each(n=>{let e=f%2==0?"tableCell":"tableCellOdd",u=[];for(let r=0;r<t.length;r++){let f=i.getAttributText(n,t[r].field),s=i.getAttributHTML(n,t[r].field);if(!String.isEmptyOrWhiteSpaces(f)&&!String.isEmptyOrWhiteSpaces(s)&&f===String.decode(s)){u.push({text:f,alignment:t[r].align,style:e});continue}let c=$(s),h=c.attr("src");if(h===undefined){u.push({text:f,alignment:t[r].align,style:e});continue}let o=this.addImage(h);if(t[r].legend!==null&&t[r].legend!==undefined&&t[r].legend&&!String.isEmptyOrWhiteSpaces(f)){let n=null;n=t[r].width!==undefined&&t[r].height!==undefined?{image:o,width:t[r].width,height:t[r].height,alignment:t[r].align}:{image:o,alignment:t[r].align};u.push({stack:[n,{text:f,style:"legend"}],style:e})}else t[r].width!==undefined&&t[r].height!==undefined?u.push({image:o,width:t[r].width,height:t[r].height,alignment:t[r].align,style:e}):u.push({image:o,alignment:t[r].align,style:e})}r.body.push(u);f++});this._doc.content.push({table:r,layout:"tableLayout"})}async finalize(){for(let n in this._doc.images)await Picture.loadSVGAsync(this._doc.images[n].src).then(t=>{this._doc.images[n]=t}).catch(t=>{this.exception("Unable to load the picture '"+n+"'",t);return})}download(n){try{return this.info("PDF file : "+String.JSONStringify(this._doc)),pdfMake.createPdf(this._doc).download(n),this.info("Export done into a PDF file"),!0}catch(t){return this.exception("Unable to create PDF file '"+n+"'",t),!1}}constructor(n){super("PDF");this._fontname=n;this._pageSize=null;this._pageOrientation=null;this._pageMargins=null;this._doc=null}}class Picture{static resize(n,t,i,r){var u=document.createElement("img");u.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height+" => width: "+t+" x height: "+i);let f=document.createElement("canvas"),e=f.getContext("2d");f.width=t;f.height=i;n.indexOf("image/svg")>=0?e.drawImage(this,0,0,t,i,0,0,f.width,f.height):e.drawImage(this,0,0,this.width,this.height,0,0,f.width,f.height);this.onload=null;r(f.toDataURL("image/png",1));f.remove();u.remove()};u.onerror=function(){r();this.onload=null;this.onerror=null};u.src=n}static loadPNG(n,t){var i=new Image;i.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height);let n=document.createElement("canvas"),r=n.getContext("2d");n.height=this.height;n.width=this.width;r.drawImage(this,0,0);t(n.toDataURL("image/png",1));this.onload=null;n.remove();i.remove()};i.src=n}static loadSVG(n,t){var i=new Image;i.onload=function(){Logger.Instance.info("Picture","width: "+this.width+" x height: "+this.height);let n=document.createElement("canvas"),r=n.getContext("2d");n.height=this.height;n.width=this.width;r.drawImage(this,0,0);t(n.toDataURL("image/svg+xml"));this.onload=null;n.remove();i.remove()};i.src=n}static async loadSVGAsync(n){return new Promise((t,i)=>{let r=new Image;r.onload=()=>{try{Logger.Instance.info("Picture","width: "+r.width+" x height: "+r.height);let n=document.createElement("canvas"),i=n.getContext("2d");n.height=r.height;n.width=r.width;i.drawImage(r,0,0);let u=n.toDataURL("image/svg+xml");this.onload=null;n.remove();r.remove();Logger.Instance.debug("Picture","Success !");t(u)}catch(n){Logger.Instance.debug("Picture","Error !");i(n)}};r.onerror=()=>{Logger.Instance.debug("Picture","Error !"),i()};Logger.Instance.debug("Picture","Loading file '"+n+"' ...");r.src=n})}}class SortArray{static find(n,t,i){let r=null;switch(n.length){case 0:return{index:0,newIndex:!0};case 1:return(r=i(n[0],t),r<0)?{index:1,newIndex:!0}:r>0?{index:0,newIndex:!0}:{index:0,newIndex:!1}}let u=0,f=n.length-1;if(r=i(n[u],t),r>0)return{index:u,newIndex:!0};if(r===0)return{index:u,newIndex:!1};if(r=i(n[f],t),r<0)return{index:f+1,newIndex:!0};if(r===0)return{index:f,newIndex:!1};let e=Math.floor((u+f)/2);while(e!==u&&e!==f){if(r=i(n[e],t),r===0)return{index:e,newIndex:!1};r<0?u=e:f=e;e=Math.floor((u+f)/2)}return{index:u+1,newIndex:!0}}}class Similarity{static pairs(n){let t=[],i=n.length;if(i<2)return t;n=n.toUpperCase();for(let r=0;r<i-1;r++)t.push(n.substr(r,2));return t.sort(function(n,t){return n<t?-1:n>t?1:0}),t}static computeWord(n,t){let u=Similarity.pairs(n);if(u.length===0)return 0;let f=Similarity.pairs(t);if(f.length===0||n.length<2||t.length<2)return 0;let s=0,h=0,c=0,i=0,r=0,e=u.length,o=f.length;while(i<e&&r<o)if(u[i]===f[r]){for(c++,s++,h++,i++;i<e&&u[i]===u[i-1];i++);for(r++;r<o&&f[r]===f[r-1];r++);}else if(u[i]<f[r])for(s++,i++;i<e&&u[i]===u[i-1];i++);else for(h++,r++;r<o&&f[r]===f[r-1];r++);while(i<e)for(s++,i++;i<e&&u[i]===u[i-1];i++);while(r<o)for(h++,r++;r<o&&f[r]===f[r-1];r++);return 2*c/(s+h)}static words(n){let t=n.toUpperCase().replace(/[&/\\#,+()$~%.'":*?!<>{}]/g," ").split(" ");t.sort(function(n,t){return n<t?-1:n>t?1:0});let i=[];for(let n=0;n<t.length;n++)String.isEmptyOrWhiteSpaces(t[n])||n>0&&t[n]===t[n-1]||t[n].length<2||i.push(t[n]);return i}static rank(n,t){if(String.isEmptyOrWhiteSpaces(n)||String.isEmptyOrWhiteSpaces(t))return 0;let i=Similarity.words(n),r=Similarity.words(t),u=0;for(let n=0;n<i.length;n++){let t=0;for(let u=0;u<r.length&&t<1;u++){let f=Similarity.computeWord(i[n],r[u]);f>t&&(t=f)}u+=t}return i.length===0?0:u/i.length}static ranks(n,t){let i=0;for(let r=0;r<t.length&&i<1;r++){let u=Similarity.rank(n,t[r]);u>i&&(i=u)}return i}}String.HEX_DIGITS=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];String.RANDOM_VALUE="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";String._cache={};String.internal=function(n){let t=String._cache[n];return t!==undefined?t:(String._cache[n]=n,n)};String.encode=function(n){return $("<div/>").text(n).html()};String.decode=function(n){return $("<div/>").html(n).text()};String.protect=function(n,t){return n.replace(new RegExp(t,"g"),"\\"+t)};String.isEmptyOrWhiteSpaces=function(n){return n===null||n===undefined||typeof n=="string"&&n.match(/^\s*$/)!==null};String.isEmailValide=function(n){return n&&/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(n)};String.isPercentage=function(n){return n&&/^[0-9]+(\.[0-9]+|)%$/.test(n)};String.getStringFromJSON=function(n){return this.isEmptyOrWhiteSpaces(n)?"":n.trim()};String.prototype.startsWith||(String.prototype.startsWith=function(n,t){return t=t||0,this.substr(t,n.length)===n});String.prototype.count||(String.prototype.count=function(n){let t=0;for(let i=0;i<this.length;i++)this[i]===n&&t++;return t});String.prototype.padEnd||(String.prototype.padEnd=function(n,t){if(!t||typeof t!="string"||t.length===0||!n||typeof n!="number"||n===0||t.length>=n)return this;let i=t;while(i.length<n)i+=t;return(i+this).slice(-n)});String.convertValue=function(n){return n===null||n===undefined?null:typeof n=="boolean"?n?"1":"0":(typeof n!="string"&&(n=n.toString()),n=n.trim(),n===""?null:n)};String.parseInt=function(n){return/^(-|\+)?([0-9]+|Infinity)$/.test(n)?Number(n):NaN};String.parseFloat=function(n){return/^(-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(n)?Number(n):/^(-|\+)?([0-9]+(,[0-9]+)?|Infinity)$/.test(n)?Number(n.replace(",",".")):NaN};String.parseRGBToHEX=function(n){function t(n){return isNaN(n)?"00":String.HEX_DIGITS[(n-n%16)/16]+String.HEX_DIGITS[n%16]}return n=n.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+t(n[1])+t(n[2])+t(n[3])};String.convertCSV=function(n,t){let i="";if(n===null||n===undefined)return i;switch(typeof n){case"string":i=n;break;case"number":i=n.toString().replace(".",",");break;case"boolean":i=String.convertValue(n);break;default:i=n instanceof Date?moment(n.toString()).format("YYYY/MM/DD HH:mm:ss.SSS"):n instanceof moment?moment(n).format("YYYY/MM/DD HH:mm:ss.SSS"):n.toString()}return!String.isEmptyOrWhiteSpaces(i)&&(i.indexOf(t)>0||i.indexOf('"')>0||isNaN(String.parseFloat(i))||!isFinite(i))&&(i='"'+i.replace(/"/g,"'").replace(/\n/g," ")+'"'),i};String.cleanupCSV=function(n){if(n.length<2)return n;let t=0;n[0]==='"'&&n[n.length-1]==='"'&&(t=1);let i="";for(let r=t;r<n.length-t;r++)n[r]!=="\\"&&(i+=n[r]);return i};String.convertBoolean=function(n){return typeof n=="string"&&(n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1")||typeof n=="boolean"&&n||typeof n=="number"&&n!==0};String.convertPercentage=function(n){return n===null||n===undefined?0:typeof n=="boolean"?n?1:0:typeof n=="string"?n[n.length-1]==="%"?String.parseFloat(n.substr(0,n.length-1))/100:String.parseFloat(n):n};String.compare=function(n,t){return n=String.convertValue(n),n=n===null?"":n.toUpperCase(),t=String.convertValue(t),t=t===null?"":t.toUpperCase(),n<t?-1:n>t?1:0};String.in=function(n,t){return n=String.convertValue(n),n=n===null?"":n.toUpperCase(),t=String.convertValue(t),t=t===null?"":t.toUpperCase(),n.indexOf(t)>=0};String.JSONStringify=function(n){return JSON.stringify(n,function(n,t){return n==="_subLists"||n==="_list"||n==="_parent"||n==="_foreignKeys"?undefined:t})};String.base64DecodeUnicode=function(n){return decodeURIComponent(atob(n).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""))};String.random=function(n){let t="";for(let i=0;i<n;i++)t+=String.RANDOM_VALUE[Math.round(Math.random()*(String.RANDOM_VALUE.length-1))];return t};Digits={};Digits.Digit=(class{get Value(){return this._value===null?this._default:this._value}set Value(n){this._value=n!==" "&&String.isEmptyOrWhiteSpaces(n)?null:n}set Token(n){if(this._range=[],this._value=null,this._default=" ",n.length===1)this._range.push(n),this._default=n;else{let i="",r="",t=0;for(t=1;t<n.length-1;t++){i=n[t];n[t+1]==="-"?(r=n[t+2],t+=2):r=i;for(let n=i.charCodeAt(0);n<=r.charCodeAt(0);n++)this._range.push(String.fromCharCode(n))}}}get DefaultValue(){return this._default}set DefaultValue(n){this._default=n}get Mark(){return this._mark}set Mark(n){this._mark=this.IsStatic?String.isEmptyOrWhiteSpaces(n)?" ":n:String.isEmptyOrWhiteSpaces(n)?"_":n}get IsStatic(){return this._range.length<=1}get IsNull(){return this._value===null}check(n){return this._range.includes(n)}toHTML(){return this._value===null?this._mark:this._value}constructor(){this._range=[];this._value=null;this._default=" ";this._mark="_"}});Digits.Digits=(class{static Factory(n){let t=null;if(String.isEmptyOrWhiteSpaces(n)||typeof n!="string")return null;if(t=n.match(/^(((_{1,3}\.){0,1}(___\.)*(__0)((.0{3})+){0,1})|(_*0+)|((0{1,3}\.){0,1}(000\.)*(000)))((,0+){0,1}|)$/),t!==null){let i=n.replace(/\./g,""),t=i.indexOf(",");return new Digits.Decimal(t,t<0?0:i.length-t-1)}return(t=n.match(/^\D+(0+)$/),t!==null)?new Digits.Sequence(t[0].substr(0,t[0].length-t[1].length),t[1].length):/^(date|time|datetime)$/.test(n.toLowerCase())?new Digits.Datetime(n):/^(.*(DD|MM|YYYY|HH|mm|ss|SSS))+.*$/.test(n)?new Digits.Datetime(n):new Digits.Mask(n)}get Type(){return"digit"}get HasError(){return this._error}get IsCalendar(){return!1}get IsNull(){return String.isEmptyOrWhiteSpaces(this.CurrentValue)}get AllowNegativeValue(){return this._allowNegativeValue}set AllowNegativeValue(n){this._allowNegativeValue=n===null||n===undefined||n===!0}getFormat(){return this._format}setFormat(n,t){this.cleanUndo();this._error=!1;this._format=n;this._separator=t;this._indexSeparator=-1;this._digits=[];let i=0;while(i<n.length){let r=[new Digits.Digit];i=this.getToken(r,n,i);for(let n of r)n.DefaultValue===t&&this._indexSeparator<0&&(this._indexSeparator=this._digits.length),this._digits.push(n)}if(t==='\0'&&(this._indexSeparator=this._digits.length),this._selectStart=-1,this._selectEnd=-1,this._indexToken=this._indexSeparator,this._indexToken<0)for(this._indexToken=0;this._indexToken<this._digits.length&&this._digits[this._indexToken].IsStatic;)this._indexToken++}get HasUndo(){return this._undo.length>0}cleanUndo(){this._undo=[]}pushUndo(){let n=this.CurrentValue;!this._handleUndo||this._undo.length>0&&this._undo[this._undo.length-1][0]===n||this._undo.push([n,this._indexToken])}popUndo(){if(this.HasUndo){this._handleUndo=!1;let n=this._undo.pop();this.Value=n[0];this._indexToken=n[1];this._handleUndo=!0;this._selectStart=-1;this._selectEnd=-1}}get CurrentValue(){let n="";for(let t of this._digits)t.IsNull||(n+=t.Value);return n}get Value(){let n="",t=!0;for(let i of this._digits)i.IsStatic?i.DefaultValue===this._separator&&t&&(t=!1,n+=i.Value):n+=i.Value;return n.trim()}set Value(n){let i=0,t=0;typeof n=="number"?(n=n.toString(),String.isEmptyOrWhiteSpaces(this._separator)||(n=n.replace(".",this._separator))):n=String.isEmptyOrWhiteSpaces(n)?"":n.toString();n!==this.CurrentValue&&this.pushUndo();this._selectStart=-1;this._selectEnd=-1;this._indexToken=0;this._error=!1;let r=-1;if(this._indexSeparator>=0){for(t=n.indexOf(this._separator),t<0&&(t=n.length),this._indexToken=this._indexSeparator,i=this._indexSeparator-1,t--;i>=0;i--){let r=this._digits[i];String.isEmptyOrWhiteSpaces(n)?r.Value=null:t<0?r.Value=null:r.check(n[t])?(r.Value=n[t],t--):r.Value=null}t>=0&&(this._error=!0);this._separator!=='\0'?(t=n.indexOf(this._separator),t<0?(this._digits[this._indexSeparator].Value=null,t=n.length-1):(this._digits[this._indexSeparator].Value=this._separator,this._indexToken++)):t=n.length-1;t++}else r=0;for(i=this._indexSeparator+1;i<this._digits.length;i++){let u=this._digits[i];String.isEmptyOrWhiteSpaces(n)?u.Value=null:t>=n.length?u.Value=null:u.check(n[t])?(u.Value=n[t],r=i+1,t++):u.Value=null}if(r>=0){while(r<this._digits.length&&this._digits[r].IsStatic)r++;this._indexToken=r}t<n.length&&(this._error=!0)}toString(){let n="";for(let t of this._digits)n+=t.Value;return n}toHTML(){let n="",t=this._indexToken;this._selectStart>=0&&(t=-1);for(let i=0;i<this._digits.length;i++)i===this._selectStart&&(n+="<span class='selected'>"),i===t&&(n+="<span class='pointer'>"),n+=this._digits[i].toHTML(),(i===this._selectEnd||i===t)&&(n+="<\/span>");return n}getToken(n,t,i){let o=" ",f=t[i],u=0,e="",r=n[0];switch(f){case"0":r.Token="[0-9]";r.DefaultValue="0";r.Mark="0";i++;break;case"_":r.Token="[0-9]";r.DefaultValue=" ";r.Mark="_";i++;break;case"?":r.Token="[0-9A-Fa-f]";r.DefaultValue="0";r.Mark="_";i++;break;case"[":for(e="[",o=t[i+1],u=i+1;u<t.length;u++){if(f=t[u],f==="]"){u++;break}f==="\\"?(u++,u<t.length&&(e+=t[u])):e+=f}e+="]";r.Token=e;r.DefaultValue=o;r.Mark="_";i=u;break;case"\\":i++;i<t.length?(r.Token=t[i],r.Mark=t[i],i++):(r.Token="\\",r.Mark="\\");break;default:r.Token=f;r.Mark=f;i++}return i}get NextTokenFix(){return this._indexToken<=this._indexSeparator&&this._indexSeparator<this._digits.length?this._separator:null}set IndexToken(n){n=n===null||n===undefined?0:n;this._indexToken=n<0||this._digits.length===0?0:n>=this._digits.length?this._digits.length-1:n}get IndexToken(){return this._indexToken<0?0:this._indexToken>this._digits.length-1?this._digits.length-1:this._indexToken}addKey(n){let t=0;switch(n){case"raz":return this.Value="",this;case"next":if(this._indexToken>this._indexSeparator||this._indexSeparator>=this._digits.length)return this;n=this._separator;break;case"undo":this.popUndo()}if(this._selectStart>=0)for(this._indexToken=this._selectStart;this._indexToken<this._digits.length&&this._digits[this._indexToken].IsStatic;)this._indexToken++;for(t=this._selectStart;t<=this._selectEnd&&t>=0&&t<this._digits.length;t++)this._digits[t].Value=null;return(this._selectStart=-1,this._selectEnd=-1,n==="undo")?this:(this.Value=this.CurrentValue+n,this.HasError&&(this.popUndo(),this._error=!1),this)}selectAll(){this._selectStart=0;this._selectEnd=this._digits.length-1;this._selectEnd<0&&(this._selectEnd=0);this._indexToken=0}RAZ(){this._selectStart=-1;this._selectEnd=-1;this._indexToken=0;this.Value=""}clone(){let n=new Digits.Digits(this._format,this._separator);return n._handleUndo=!1,n.Value=this.Value,n._handleUndo=!0,n}constructor(n,t){n=String.isEmptyOrWhiteSpaces(n)?"":n;this._format=n;this._digits=[];this._error=!1;this._separator=t;this._indexSeparator=-1;this._allowNegativeValue=!1;this._selectStart=-1;this._selectEnd=-1;this._indexToken=-1;this._undo=[];this._handleUndo=!0;this.setFormat(n,t)}});Digits.Decimal=(class extends Digits.Digits{static get EPSILON(){return 1e-5}static IsZero(n){return-Digits.Decimal.EPSILON<n&&n<Digits.Decimal.EPSILON}get Type(){return"decimal"}set Value(n){n=typeof n=="number"?n.toFixed(this._nbDigitAfter).toString().replace(".",","):String.isEmptyOrWhiteSpaces(n)?null:n.trim().replace(/\./g,"");n!==null&&n.startsWith("-")?(this._negative=!0,n=n.substr(1)):this._negative=!1;super.Value=n}get Value(){let n=super.Value;return n===null?n:this._negative?-String.parseFloat(n.trim()):String.parseFloat(n.trim())}get NbDigitBefore(){return this._nbDigitBefore}get NbDigitAfter(){return this._nbDigitAfter}toString(){let n=super.toString().replace(/^[ .]*/,"").replace(/,$/,"");return this._negative&&(n="-"+n),n}addKey(n){return n==="minus"&&this.AllowNegativeValue?(this._negative=!this._negative,this):super.addKey(n==="."?",":n)}clone(){let n=new Digits.Decimal(this._nbDigitBefore,this._nbDigitAfter);return n.Value=this.Value,n}constructor(n,t){n=n===null||n===undefined||n<=0?6:n;t=t===null||t===undefined||t<=0?0:t;let r="".padEnd(n-1,"_")+"0",i=r.length%3;i===0&&(i+=3);let u=r.substr(0,i);while(i<r.length)u+="."+r.substr(i,3),i+=3;t>0&&(u+=",".padEnd(t+1,"0"));super(u,t>0?",":"\0");this._negative=!1;this._nbDigitBefore=n;this._nbDigitAfter=t}});Digits.Mask=(class extends Digits.Digits{get Type(){return"mask"}clone(){let n=new Digits.Mask(this.getFormat(),this._separator);return n.Value=this.Value,n}constructor(n,t){super(n,t)}});Digits.Sequence=(class extends Digits.Digits{get Type(){return"sequence"}clone(){let n=new Digits.Sequence(this._key,this._length);return n.Value=this.Value,n}constructor(n,t){super(n+"".padEnd(t,"0"),"\0");this._key=n;this._length=t}});Digits.Datetime=(class extends Digits.Digits{get Type(){let n=/(.*(DD|MM|YYYY))+/.test(this._dateFormat),t=/(.*(HH|mm|ss|SSS))+/.test(this._dateFormat);return(n?"date":"")+(t?"time":"")}get IsCalendar(){for(let n of this._groupBy)if(n[2]<=this._indexToken&&this._indexToken<=n[2]+n[1].length&&(n[0]==="YYYY"||n[0]==="MM"||n[0]==="DD"))return!0;return!1}setFormat(n){this._groupBy=[];this._webixFormat="";this._webixType=0;super.setFormat(n)}getFormat(){return String.isEmptyOrWhiteSpaces(this._dateFormat)?"DD/MM/YYYY HH:mm:ss":this._dateFormat}get WebixFormat(){return this._webixFormat}get WebixType(){switch(this._webixType){case 1:return"year";case 2:case 3:return"month";case 6:case 7:return"day"}return null}get CurrentType(){for(let n of this._groupBy)if(n[2]<=this._indexToken&&this._indexToken<n[2]+n[1].length)return n[0];return null}set Value(n){n instanceof Date&&(n=moment(n.toString()).format(this._format));n instanceof moment&&(n=n.format(this._dateFormat));super.Value=n;for(let n of this._groupBy){let i="",r=n[2],t=0;for(t=0;t<n[1].length;t++,r++){let r=n[1][t];r.IsNull||(i+=r.Value)}(i.length===t||r>=this._digits.length&&!this._digits[this._digits.length-1].IsNull||r<this._digits.length&&!this._digits[r].IsNull)&&this.setValue(n,String.isEmptyOrWhiteSpaces(i)?0:String.parseInt(i))}}get Value(){let n=this.toString();if(String.isEmptyOrWhiteSpaces(n))return null;let t=new moment(n,this._dateFormat,!0);return t.isValid()?t:(this._error=!0,null)}setValue(n,t){if(t===null||t===undefined)return-1;let i=n[3][0],r=n[3][1];t<i&&(t=i);t>r&&(t=r);let u=t.toString().padStart(n[1].length,"0");for(let t=0;t<n[1].length;t++)n[1][t].Value=u[t];return n[2]+n[1].length}setDate(n,t,i){let r=0;for(let u of this._groupBy){let f=0;switch(u[0]){case"DD":f=this.setValue(u,n);break;case"MM":f=this.setValue(u,t);break;case"YYYY":f=this.setValue(u,i)}r<f&&(r=f)}this.IndexToken=r}setTime(n,t,i,r){let u=0;for(let f of this._groupBy){let e=0;switch(f[0]){case"HH":e=this.setValue(f,n);break;case"mm":e=this.setValue(f,t);break;case"SS":e=this.setValue(f,i);break;case"sss":e=this.setValue(f,r)}u<e&&(u=e)}this.IndexToken=u}getToken(n,t,i){let u=["YYYY","MM","DD","HH","mm","ss","SSS"],f=["%Y","%m","%d","%H","%i","%s","%S"],e=[1,2,4,0,0,0,0],o=[[1900,2099],[1,12],[1,31],[0,23],[0,59],[0,59],[0,999]],r=u.indexOf(t.substr(i,4));if(r<0&&(r=u.indexOf(t.substr(i,3))),r<0&&(r=u.indexOf(t.substr(i,2))),r>=0){let t=n[0];t.Token="[0-9]";t.Mark="_";for(let t=1;t<u[r].length;t++){let t=new Digits.Digit;n.push(t);t.Token="[0-9]";t.Mark="_"}return this._groupBy.push([u[r],n,this._digits.length,o[r]]),this._webixFormat+=f[r],this._webixType|=e[r],i+u[r].length}let s=super.getToken(n,t,i);return this._webixFormat+=n[0].DefaultValue,s}clone(){let n=new Digits.Datetime(this._formatDefault);return n.Value=this.Value,n}constructor(n){let t=String.isEmptyOrWhiteSpaces(n)?"DD/MM/YYYY HH:mm:ss":n;switch(t.toLowerCase()){case"date":t="DD/MM/YYYY";break;case"time":t="HH:mm";break;case"datetime":t="DD/MM/YYYY HH:mm"}super("");this._dateFormat=t;this._groupBy=[];this._webixFormat="";this._webixType=0;this.setFormat(t)}});class Clipboard{static Copy(n,t){let r=document.createElement("textarea"),i="";String.isEmptyOrWhiteSpaces(n)||(i=n);String.isEmptyOrWhiteSpaces(t)||(i+=(String.isEmptyOrWhiteSpaces(i)?"":"\n\n")+t);r.value=String.isEmptyOrWhiteSpaces(i)?"Error empty":i;document.body.appendChild(r);r.select();document.execCommand("copy");document.body.removeChild(r)}}Language={};Language.Default={Labels:{AREA_ADMINISTRATION:{FR:"Administration",EN:"Administration"},AREA_CUSTOMER:{FR:"Customer",EN:"Customer"},BTN_CANCEL:{FR:"Annuler",EN:"Cancel"},BTN_CLIPBOARD:{FR:"Presse-papier",EN:"Clipboard"},BTN_CLOSE:{FR:"Ferme",EN:"Close"},BTN_CONNECT:{FR:"Connection",FR:"Connect"},BTN_OK:{FR:"OK",EN:"OK"},BTN_RELOAD:{FR:"RECHARGER",EN:"RELOAD"},ERR_CONNECTION:{FR:"La connection vers le serveur est corrompue. Pouvez-vous recharger la page ?",EN:"The connection toward server is corrupted. Please, reload the page ?"},ERR_EXCEPTION_UNEXPECTED:{FR:"Une exception inattendue est survenue durant le traitement de la requête",EN:"Unexpected exception on running the request"},ERR_INITIALISATION:{FR:"L'initialisation a rencontré un problème ...Si le problème persiste, contactez l'équipe technique!",EN:"Initialization has encountered an issue ... If the issue already exists, please contact the technical team!"},ERR_NOCONNECTION:{FR:"Non connecté!",EN:"Not connected!"},ERR_UNABLE_SYNCHRONIZATION:{FR:"Impossible de synchroniser la base de données en raison d'une mise à jour de la base de données. Rechargez la page!",EN:"Unable to synchronize database. Reload the page!"},ERR_UNAUTHENTICATED:{FR:"Votre session est terminée ...Toutes vos modifications sont perdues !Veuillez vous authentifier à nouveau !",EN:"Your session is over ... All modifications are lost! Please, reload the page !"},ERR_UNAUTHORIZED:{FR:"Requête non autorisée",EN:"Request not allowed"},ERR_UPLOAD_BROKEN:{FR:"La connection a été rompue ...Essayez toute à l'heure ...",EN:"The connection is broken ... Try later ..."},MSG_INITIALIZING:{FR:"Initialisation en cours ...",EN:"Initializing ..."},MSG_LOADING:{FR:"Chargement en cours ...",EN:"Loading ..."},MSG_SYNCHRONIZING:{FR:"Synchronisation en cours ...",FR:"Synchronizing ..."},TITLE_EXIT:{FR:"Sortie",FR:"Exit"}}};Language.Manager=(class extends LoggerBaseObject{static get LANGUAGE_ROOT(){return"body > header > ul > "}static HandleReplacementKeyLabel(n,t,i){return function(){try{let u=$(this).attr("k-label");if(!u||u===undefined||u!==i)return!0;let r=$(this).attr("k-language");if(!r&&t!==n||r&&r!==t)return!0;r||(r=t);let e=[],f=0;while($(this).attr("k-label-"+f))e.push($(this).attr("k-label-"+f)),f++;let o=Language.Manager.Instance.interpolation(u,e,r);return $(this).is("input")?$(this).val(o):$(this).html(String.encode(o)),!0}catch(r){return!0}}}static HandleReplacementLabel(n){return function(){try{let t=$(this).attr("k-label");if(!t||t===undefined)return!0;let i=$(this).attr("k-language");i||(i=n);let u=[],r=0;while($(this).attr("k-label-"+r))u.push($(this).attr("k-label-"+r)),r++;let f=Language.Manager.Instance.interpolation(t,u,i);return $(this).is("input")?$(this).val(f):$(this).html(String.encode(f)),!0}catch(t){return!0}}}get Languages(){return this._languages}initialize(){function i(n){return function(t,i,r,u,f){n.info("Replace the label "+String.JSONStringify(n._labels[f.Key])+" by "+String.JSONStringify(f));n._labels[f.Key]=f;n.onUpdateLabel(t,i,r,u,f)}}function r(n){return function(){n.initialize();n.onChangeLanguage(DSDatabase.Instance.CurrentLanguage,!0)}}this.info("Cleaning up ...");this._labels={};this._ignoreLabels={};this.info("Updating language table ...");let n={},t=0;for(let i of Array.toIterable(DSDatabase.Instance.getTable("Language"))){if(n[i.Key]=i,this._languages===null){this._languages=[];for(let n in i)n.length===2&&n.toUpperCase()===n&&this._languages.push(n);this.debug("List of languages: "+String.JSONStringify(this._languages))}this.IsVerboseAll&&this.verbose("["+i.Key+"] = "+String.JSONStringify(i));t++}this._labels=n;this._ignoreLabels={};this.info("Language table contains "+t+" labels");this._eventOnUpdateKey===null&&(this._eventOnUpdateKey=DSDatabase.Instance.addEventListener("onUpdate","Language","*",i(this)),DSDatabase.Instance.addEventListener("onLoad","Language","*",r(this)))}existLabel(n){return this._labels[n]!==null&&this._labels[n]!==undefined}getLabel(n,t){try{let i=this._labels[t][n];return i?i:null}catch(i){try{let i=Language.Default.Labels[t][n];return i?i:null}catch(i){return this._ignoreLabels[n+"."+t]||(this._ignoreLabels[n+"."+t]=!0,this.warn("The label("+n+","+t+") doesn't exist")),null}}}getComment(n){try{let t=this._labels[n].Comment;return t?t:""}catch(t){return""}}setLabel(n,t,i){let r=this.getLabel(n,t);if(!i||!r||i===r)return!1;try{return this.info("The value '"+r+"' of the label '"+t+"' is replaced by '"+i+"' ..."),this._labels[t][n]=i,!0}catch(u){return this.exception("Exception on updating the label("+n+","+t+")",u),!1}}addComponent(n){this._components.push(n)}interpolation(n,t,i){function e(n,t){return function(i,r){try{let u=n.getLabel(t,r);return u===null?i:typeof u=="string"||typeof u=="number"?u:i}catch(u){return i}}}function o(n){return function(t,i){try{let r=n[i];return typeof r=="string"||typeof r=="number"?r:t}catch(r){return t}}}let r=Helper.Label(n,t,i);i=r.language?r.language:DSDatabase.Instance.CurrentLanguage;let f=this.getLabel(i,r.label);if(!f)return r.label;let u=[];if(r.parameters&&r.parameters.length>0)for(let n of r.parameters)n!==null&&n!==undefined?u.push(n.toString().replace(/{([^{}]*)}/g,e(this,i))):u.push("");return f.replace(/{([^{}]*)}/g,o(u))}onUpdateLabel(n,t,i,r,u){for(let n in u)if(n.length===2&&n.toUpperCase()===n&&u[n]!==r[n]){let t=u.Key,i=n;this.info("Updating all labels having the key '"+t+"' ("+i+")");$("div").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));$("span").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));$("input").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));$("select > option").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));for(let n=0;n<this._components.length;n++){let r=this._components[n];r.find("div").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));r.find("span").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));r.find("input").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t));r.find("select > option").each(Language.Manager.HandleReplacementKeyLabel(DSDatabase.Instance.CurrentLanguage,i,t))}for(let n of Array.toIterable(this._listeners))n(DSDatabase.Instance.CurrentLanguage,i,t)}}onChangeLanguage(n,t){if(t===undefined&&(t=!1),DSDatabase.Instance.CurrentLanguage!==n||t){webix.i18n.setLocale(n);Locale.setLanguage(n);$(Language.Manager.LANGUAGE_ROOT+"#"+DSDatabase.Instance.CurrentLanguage).removeClass("selected");DSDatabase.Instance.SelectedLanguage=n;$(Language.Manager.LANGUAGE_ROOT+"#"+n).addClass("selected");this.info("Translating all labels into '"+n+"' ...");$("div").each(Language.Manager.HandleReplacementLabel(n));$("span").each(Language.Manager.HandleReplacementLabel(n));$("input").each(Language.Manager.HandleReplacementLabel(n));$("select > option").each(Language.Manager.HandleReplacementLabel(n));for(let t=0;t<this._components.length;t++){let i=this._components[t];i.find("div").each(Language.Manager.HandleReplacementLabel(n));i.find("span").each(Language.Manager.HandleReplacementLabel(n));i.find("input").each(Language.Manager.HandleReplacementLabel(n));i.find("select > option").each(Language.Manager.HandleReplacementLabel(n))}for(let t of Array.toIterable(this._listeners))t(n)}}addListener(n){return this._indexListener++,this._listeners[this._indexListener]=n,this._indexListener}removeListener(n){this._listeners[n]!==null&&this._listeners[n]!==undefined&&this._listeners.splice(n,1)}constructor(){super("LanguageManager");this._labels={};this._ignoreLabels={};this._languages=null;this._eventOnUpdateKey=null;this._indexListener=0;this._listeners=[];this._components=[]}static get Instance(){return this._instance||(this._instance=new Language.Manager),this._instance}});Filter={};Filter.Filter=(class{getField(n){return this._filters[n]===undefined||this._filters[n]===null?null:this._filters[n]}setField(n,t){this._filters[n]=t}constructor(){this._filters={}}static get Instance(){return this._instance||(this._instance=new Filter.Filter),this._instance}});Filter.FilterItems=(class{setValue(n){let t=[];if(Array.isArray(n)){let i={};for(let n of Array.toIterable(n)){let r=String.isEmptyOrWhiteSpaces(n)||isNaN(String.parseInt(n))?null:String.parseInt(n);i[r]===undefined&&r!==null&&(i[r]=!0,t.push(r))}t.sort(function(n,t){return n<t?-1:n>t?1:0})}else String.isEmptyOrWhiteSpaces(n)||isNaN(String.parseInt(n))||t.push(String.parseInt(n));let i=this._values.length===t.length;if(i){let n=0;for(n=0;n<t.length&&t[n]===this._values[n];n++);if(n===t.length)return!1}return this._values=t,!0}getValue(){return this._values}match(n){return this._values.length===0?!0:this._values.indexOf(n)>=0}constructor(){this._values=[]}});List={};List.List=(class{static get TEXT_FORMAT_DATE(){return"DD/MM/YYYY"}static get TEXT_FORMAT_DATETIME(){return"DD/MM/YYYY HH:mm:ss"}set DefaultPicture(n){this._defaultPicture=String.isEmptyOrWhiteSpaces(n)?null:n}get DefaultPicture(){return this._defaultPicture}set Filter(n){this._fnFilter=n?n:null}destructor(){this.clearListeners();this._events={}}clear(){}compare(n,t){let i=this.getId(n),r=this.getId(t);return i===r?0:i<r?-1:1}each(n){for(let t of Array.toIterable(this.getList()))if(this.isVisible(t)){let i=String.convertValue(this.getId(t));if(i!==null)try{n(t)}catch(t){Logger.Instance.exception("List","An exception occurs while rading each items",t)}}}getList(){return[]}getListSorted(){function t(n){return function(t,i){return n.compare(t,i)}}let n=this.getList();return n.sort(t(this)),n}count(){let n=0;for(let t of Array.toIterable(this.getList()))this.isVisible(t)&&n++;return n}getListIndexed(){return[]}on(n,t){this._events[n]=t}async raise(n,...t){let i=this._events[n];i&&(i.constructor.name==="AsyncFunction"?await i(n,...t):i(n,...t))}isEvent(n){return this._events[n]!==undefined&&this._events[n]!==null}getEvent(n){return this._events[n]?this._events[n]:null}unbind(n){this._events[n]=null}clearListeners(){for(let n of this._listeners)DSDatabase.Instance.removeEventListener(n);this._listeners=[]}addListener(n){this._listeners.push(n)}onOpen(){}onClose(){this.clearListeners()}getId(n){return n===null||n===undefined?null:typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n:n.Id!==undefined?n.Id:null}getKey(n){return this.getText(n)}getItem(n,t){let i=String.convertValue(n);for(let n of Array.toIterable(this.getList()))if(t!==null&&t!==undefined&&t||this.isVisible(n)){let r=String.convertValue(this.getId(n));if(r!==null&&r===i)return n}return null}getText(n){return n===null||n===undefined?"":typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n.toString().trim():String.isEmptyOrWhiteSpaces(n.Name)?String.isEmptyOrWhiteSpaces(n.Description)?n.Id!==undefined?n.Id.toString().trim():n.toString().trim():n.Description.trim():n.Name.trim()}getLanguageLabel(){return null}getPicture(n){return n===null||n===undefined||typeof n=="string"||typeof n=="number"||typeof n=="boolean"?null:String.isEmptyOrWhiteSpaces(n.Picture)?this._defaultPicture:n.Picture}getAttributHTMLBoolean(n,t){if(n===null||n===undefined)return"";let i=n[t];return i===undefined?"":"<div class='"+(i===null?"null":i?"true":"false")+"'><\/div>"}getAttributHTMLReference(n,t,i,r){if(n===null||n===undefined)return"";let u=List.ListRecord.CACHE_LIST(i);if(u===null)return this.getAttributText(n,t);let f=u.getItem(n[t],!0);if(f===null||f===undefined)return this.getAttributText(n,t);if(r===!0){let n=u.getPicture(f);if(n!==null)return"<img src='"+n+"' />";if(u.DefaultPicture!==null)return"<img src='"+u.DefaultPicture+"' />"}return u.getText(f)}getAttributHTMLPicture(n,t){if(n===null||n===undefined)return"";let i=n[t]?n[t]:this._defaultPicture;return i===null||i===undefined?"":"<img src='"+i+"' />"}getAttributHTMLEnumerate(n,t,i){if(n===null||n===undefined)return"";let u=n[t];if(u===null||u===undefined)return i===!0?"<div class='null'><\/div>":"";let r=List.ListEnumerable.Factory(this.Table,t,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList()[u];return r===undefined||r===null||r.Label===undefined||r.Label===null?i===!0?"<div class='null'><\/div>":"":i===!0?"<div class='"+r.Name.toLowerCase()+"'><\/div>":Helper.Span(r.Label)}getAttributHTMLMultiline(n,t){if(n===null||n===undefined)return"";let i=n[t];return i===null||i===undefined?String.encode(this.getAttributText(n,t)):(i=String.encode(this.getAttributText(n,t)).split("\n"),i.join("<br />"))}getAttributHTMLArray(n,t){return String.encode(this.getAttributText(n,t))}getAttributHTML(n,t){if(n===null||n===undefined)return"";let i=n[t];return i===null||i===undefined?String.encode(this.getAttributText(n,t)):Helper.IsLabel(i,!0)?Helper.Span(i):String.encode(this.getAttributText(n,t))}getAttributToolTipHTML(){return null}getAttributTextBoolean(n,t){if(n===null||n===undefined)return"";let i=n[t];return i===null||i===undefined?"":Language.Manager.Instance.interpolation(Helper.Label(this.Table.toUpperCase()+"_"+t.toUpperCase()+"_"+(i===null?"NULL":i===!0?"TRUE":"FALSE")))}getAttributTextDouble(n,t,i){if(n===null||n===undefined)return"";let f=n[t];if(f===undefined||f===null)return"";let r=null,e=null,u=DSDatabase.Instance.getColumn(n._table,t);return u!==null&&u!==undefined?(r=i===null||i===undefined?u.Digit:new Digits.Decimal(9,i),e=u.Unit):r=new Digits.Decimal(9,i===null||i===undefined?3:i),r.Value=f,r.toString()+(String.isEmptyOrWhiteSpaces(e)?"":" "+e)}getAttributTextDate(n,t){if(n===null||n===undefined)return"";let i=n[t];if(i===undefined||i===null)return"";if(typeof i=="string")return i;let r=DSDatabase.Instance.getDatetimeFormat(n._table,t);return(r===null&&(r=List.List.TEXT_FORMAT_DATE),i instanceof Date)?moment(i.toString()).format(r):i instanceof moment?i.format(r):typeof i=="number"?moment(i).format(r):i.toString()}getAttributTextDateTime(n,t){if(n===null||n===undefined)return"";let i=n[t];if(i===undefined||i===null)return"";if(typeof i=="string")return i;let r=DSDatabase.Instance.getDatetimeFormat(n._table,t);return(r===null&&(r=List.List.TEXT_FORMAT_DATETIME),i instanceof Date)?moment(i.toString()).format(r):i instanceof moment?i.format(r):i.toString()}getAttributTextReference(n,t,i){if(n===null||n===undefined)return"";let r=List.ListRecord.CACHE_LIST(i);if(r===null)return n[t]?n[t].toString():"";let u=r.getItem(n[t],!0);return u===null||u===undefined?n[t]?n[t].toString():"":r.getText(u)}getAttributTextPicture(){return""}getAttributTextEnumerate(n,t){if(n===null||n===undefined)return"";let r=n[t];if(r===null||r===undefined)return"";let i=null;return(n._table&&(i=List.ListEnumerable.Factory(n._table,t,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList()[r]),i===undefined||i===null||i.Label===undefined||i.Label===null||Language.Manager.Instance.existLabel(i.Label)||(i=List.ListEnumerable.Factory(this.Table,t,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList()[r]),i===undefined||i===null||i.Label===undefined||i.Label===null)?"":Language.Manager.Instance.interpolation(Helper.Label(i.Label))}getAttributTextArray(n,t){if(n===null||n===undefined)return"";let i=n[t];if(i===null||i===undefined)return"";if(!Array.isArray(i))return i.toString();let r=[];for(let n of Array.toIterable(i)){let t="";t=n._list===null||n._list===undefined?n.toString():n._list.list.getText(n);r.push(t)}return r.sort(),r.join(", ")}getAttributTextComments(n){if(n===null||n===undefined||n.Comments===null||n.Comments===undefined||Array.isEmpty(n.Comments))return"";let i=[];for(let n of Array.toIterable(n.Comments))i.push(n);i.sort((n,t)=>Dates.Compare(n.Date,t.Date));let t="";for(let n of i)t!==""&&(t+=" / "),t+=n.Comment.replace(/\n/g," ").trim();return t}getAttributText(n,t){if(n===null||n===undefined)return"";let i=n[t];if(i===null||i===undefined)return"";switch(typeof i){case"boolean":return i?"1":"0";case"number":return i.toString().replace(".",",");case"string":return i;default:return Helper.IsLabel(i,!0)?Language.Manager.Instance.interpolation(i):i instanceof Date?moment(i.toString()).format(List.List.TEXT_FORMAT_DATE):i instanceof moment?i.format(List.List.TEXT_FORMAT_DATE):i.toString()}}getAttributValue(n,t){if(n===null||n===undefined)return null;let i=n[t];return(i===undefined&&(i=this.getAttributText(n,t)),i===null||i===undefined)?null:(Helper.IsLabel(i,!0)&&(i=Language.Manager.Instance.interpolation(i)),typeof i=="string")?i.trim().toUpperCase():i}getAttributCSV(n,t){if(n===null||n===undefined)return"";if(n._foreignKeys!==undefined&&n._foreignKeys!==null&&t in n._foreignKeys)return n._foreignKeys[t].list.getKey(n[t]);let i=n[t];return i!==null&&i!==undefined&&typeof i=="boolean"?i?"1":"0":(i=this.getAttributText(n,t),i===null||i===undefined)?"":i}isAttributDeletedReference(n,t,i){if(n===null||n===undefined)return!0;let r=List.ListRecord.CACHE_LIST(i);if(r===null)return!0;let u=r.getItem(n[t]);return u===null||u===undefined?!0:r.isDeleted(u)}isAttributDeleted(n){return this.isDeleted(n)}isVisible(n){return n===null||n===undefined?!1:this._fnFilter?this._fnFilter(n):!0}isDeleted(n){return n===null||n===undefined?!0:n._deleted!==null&&n._deleted!==undefined&&n._deleted}isBoxFieldVisible(){return!0}isBoxFieldReadonly(n,t,i){return i.Profile===UserRecord.PROFILE_OTHER||i.Profile===UserRecord.PROFILE_NONE}isBoxBoardVisible(){return!0}isBoxBoardReadonly(){return!1}isBoxPanelVisible(){return!0}isBoxPanelReadonly(){return!1}isBoardFieldVisible(){return!0}isBoardFieldReadonly(){return!1}isBoardAllowed(n,t,i){return i==="help"||i==="read"||i==="onSelectChange"?!0:!n.Readonly&&t.Profile!==UserRecord.PROFILE_OTHER&&t.Profile!==UserRecord.PROFILE_NONE}beginTransaction(){}endTransaction(){}async commitAsync(){}rollback(){}async rollbackAsync(){}declareKeysCSV(){}startCSV(n){return Logger.Instance.info("List","Starting reading CSV file '"+n.Name+"' ..."),!0}getRowToDeleteCSV(){return 0}startPreloadingCSV(n){return Logger.Instance.info("List","Starting preloading CSV file '"+n.Name+"' ..."),!0}preloadRecordFromCSV(){return!0}endPreloadingCSV(n,t){return t.HasFatal?(Logger.Instance.error("List","Preloading CSV file '"+n.Name+"' failed due to "+t.toString()),!1):(Logger.Instance.info("List","CSV file '"+n.Name+"' preloaded"),!0)}startCheckingCSV(n){return Logger.Instance.info("List","Starting checking CSV file '"+n.Name+"' ..."),this.beginTransaction(),!0}checkRecordFromCSV(){return!0}endCheckingCSV(n,t){return(this.endTransaction(),this.rollback(),t.HasError)?(Logger.Instance.error("List","Checking CSV file '"+n.Name+"' failed due to "+t.toString()),!1):(Logger.Instance.info("List","CSV file '"+n.Name+"' checked"),!0)}startImportingCSV(n){return Logger.Instance.info("List","Starting importing data included into the CSV file '"+n.Name+"' ..."),!0}getRecordFromCSV(){return null}addItemCSV(){return null}updateItemCSV(){return null}deleteItemCSV(){return null}getItemsToDeleteCSV(){return[]}getItemsToPostUpdateCSV(){return[]}endImportingCSV(n,t){return t.HasError?(Logger.Instance.error("List","Importing data from CSV file '"+n.Name+"' failed due to "+t.toString()),!1):(Logger.Instance.info("List","Data included into the CSV file '"+n.Name+"' imported"),!0)}endCSV(n){return Logger.Instance.info("List","CSV file '"+n.Name+"' imported"),!0}constructor(){this._defaultPicture=null;this._fnFilter=null;this._events={};this._listeners=[]}});List.ListArray=(class extends List.List{get Array(){return this._array}getLanguageLabel(n){return typeof n=="object"?n.Label!==undefined?n.Label:null:null}getText(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n.toString().trim():n.Text!==undefined?n.Text:null}clear(){if(super.clear(),this._array!==null){let n=[];for(let t in this._array)n.push(t);for(let t=0;t<n.length;t++)delete this._array[n[t]];this._array.length=0}else this._array=[]}getList(){return this._array}constructor(n){super();this._array=n}});List.ListCalendar=(class extends List.List{setMonth(n,t){n<1||n>12||(this._offsetMonth=n,this._offsetYear=t)}previousMonth(){this._offsetMonth--;this._offsetMonth<1&&(this._offsetMonth=12,this._offsetYear--)}nextMonth(){this._offsetMonth++;this._offsetMonth>12&&(this._offsetMonth=1,this._offsetYear++)}month(n){let t=this._offsetMonth+(n===null||n===undefined?0:n);return(t-1)%12+1}year(n){let t=this._offsetMonth+(n===null||n===undefined?0:n);return this._offsetYear+Math.floor((t-1)/12)}getId(n){return n.day}getElementId(){return null}getElementHTML(){return null}getElementDate(){return null}getElementText(){return""}getText(){return null}getPicture(){return null}getAttributHTML(n,t){function c(n){return function(t,i){let r=n.getElementText(t),u=n.getElementText(i);return r<u?-1:u<r?1:0}}if(t==="day")return n.day.toString();let f=parseInt(t);if(isNaN(f))return"";let l=n.day,r=this._offsetMonth+f,e=this._offsetYear;while(r>12)r-=12,e++;let o=this.day[l];if(!o)return"";let s=o.month[r];if(!s)return"";let h=s.year[e];if(!h)return"";let u=[];for(let n of Array.toIterable(h))u.push(n);u.sort(c(this));let i="";for(let n of u)if(n!==null&&n!==undefined){let t=this.getElementHTML(n);String.isEmptyOrWhiteSpaces(t)||(i!==""&&(i+="<\/br>"),i+=t)}return i}getAttributText(n,t){if(t==="ToolTip")return"";if(t==="day")return n.day.toString();let r=parseInt(t);if(isNaN(r))return"";let f=n.day,i=this._offsetMonth+r,u=this._offsetYear;while(i>12)i-=12,u++;return new moment([u,i-1,f]).format("LLLL")}getAttributValue(n){return n.day.toString()}isVisible(){return!0}getItem(n){return this.day[n]===undefined?null:this.day[n]}getList(){return this.day}clear(){this.day=[];for(let n=1;n<=31;n++)this.day[n]={day:n,month:{}}}addItem(n,t){let i=this.getElementDate(n);if(i===null||i===undefined||!(i instanceof moment))return null;let u=i.date(),f=i.month()+1,o=i.year(),e=this.day[u];if(!e)return null;let r=e.month[f];r||(e.month[f]={month:f,year:{}},r=e.month[f]);let s=r.year[o];return s||(r.year[o]={},s=r.year[o]),s[this.getElementId(n)]=n,(typeof t!="boolean"||t)&&this.raise("onUpdate","*",u,{day:u},{day:u}),n}updateItem(n,t){let i=this.getElementDate(n),r=this.getElementDate(t);if(this.deleteItem(n,!1),this.addItem(t,!1),i!==null||r!==null){let u=this.getEvent("onUpdate");if(u){if(i!==null&&r!==null&&i.date()===r.date()){u("onUpdate","*",i.date(),{day:i.date()},{day:i.date()});return}i!==null&&u("onUpdate","*",i.date(),{day:i.date()},{day:i.date()});r!==null&&u("onUpdate","*",r.date(),{day:r.date()},{day:r.date()})}}}deleteItem(n,t){let i=this.getElementDate(n);if(i===null||i===undefined||!(i instanceof moment))return null;let r=i.date(),o=i.month()+1,s=i.year(),u=this.day[r];if(!u)return null;let f=u.month[o];if(!f)return null;let e=f.year[s];return e?(delete e[this.getElementId(n)],(typeof t!="boolean"||t)&&this.raise("onUpdate","*",r,{day:r},{day:r}),n):null}constructor(){super();let n=new moment;this._offsetMonth=n.month()+1;this._offsetYear=n.year();this.clear()}});List.ListEnumerable=(class extends List.ListArray{static Factory(n,t,i){this._cache||(this._cache={});let u=n+"."+t,r=this._cache[u];return r?r:(r=new List.ListEnumerable(n,t,i),this._cache[u]=r,r)}get DefaultPicture(){return this._defaultPicture}getLanguageLabel(n){return n.Label!==undefined?n.Label:null}constructor(n,t,i){super(DSDatabase.Instance.getEnumerable(n,t));this._table=n;this._column=t;this._path=i?i:"";this._defaultPicture=null;let r=DSDatabase.Instance.getEnumerable(this._table,this._column,null);r!==null&&r!==undefined&&(this._defaultPicture=this._path+r.Picture);for(let n of Array.toIterable(this._array))n.Picture=this._path+n.Picture}});List.ListHistory=(class extends List.ListArray{static get CREATE(){return 0}static get UPDATE(){return 1}static get DELETE(){return 2}get IsDetails(){return this._details}get List(){return this._list!==null?this._list:(this._list=String.isEmptyOrWhiteSpaces(this._table)?new List.ListRecord:List.ListRecord.CACHE_LIST(this._table),this._list)}clear(){super.clear();this._currentId=1}push(n,t,i,r,u,f){let e={Id:this._currentId++,UserId:n.HistoryUserId,Date:n.HistoryDate,Nature:Helper.Label(i),Description:t===null||t===undefined?this.List.getText(n):t,Field:r===null||r===undefined?null:Helper.Label(r),OldValue:u===null||u===undefined?null:u,NewValue:f===null||f===undefined?null:f,Item:n};return this._array.push(e),e}sort(){this._array.sort(function(n,t){return n.Id>t.Id?-1:n.Id<t.Id?1:0})}getValueText(n){return n===null||n===undefined?"":Helper.IsLabel(n,!0)?n.label:n.toString()}setDetails(n){this._details=n===null||n===undefined?!0:n}getId(n){return n.Id}getText(n){return this.List.getText(n)}getLanguageLabel(n){return this.List.getLanguageLabel(n)}getPicture(n){return this.List.getPicture(n)}getAttributHTML(n,t){let r=null,i=null;switch(t){case"Id":return"";case"User":return(r=n.UserId,r===null||r===undefined)?"":(i=DSDatabase.Instance.getRowById("User",r),i===null||i===undefined)?"":(String.isEmptyOrWhiteSpaces(i.Picture)&&(i.Picture=UserRecord.DEFAULT_PICTURE().picture),String.isEmptyOrWhiteSpaces(i.Picture))?"":"<img class='user' src='"+i.Picture+"' />";case"OldValue":case"NewValue":return Array.isArray(n[t])?this.List.getAttributText(n[t][0],n[t][1]):super.getAttributHTML(n,t);default:return super.getAttributHTML(n,t)}}getAttributText(n,t){let i=null,r=null;switch(t){case"User":return(i=n.UserId,i===null||i===undefined)?"":(r=DSDatabase.Instance.getRowById("User",i),r===null||r===undefined)?"":String.isEmptyOrWhiteSpaces(r.Name)?"":r.Name;case"Date":return(i=n[t],i===null||i===undefined)?"":i instanceof moment?i.format("DD/MM/YYYY HH:mm:ss"):super.getAttributText(n,t);case"OldValue":case"NewValue":return Array.isArray(n[t])?this.List.getAttributText(n[t][0],n[t][1]):super.getAttributText(n,t);default:return super.getAttributText(n,t)}}getAttributValue(n,t){let i=null;switch(t){case"User":case"Nature":case"Field":case"Description":return i=this.getAttributText(n,t),i===null?null:i.toUpperCase().trim();case"Date":return n.Id;case"OldValue":case"NewValue":return Array.isArray(n[t])?this.List.getAttributText(n[t][0],n[t][1]):super.getAttributValue(n,t);default:return super.getAttributValue(n,t)}}isAttributDeleted(n,t){switch(t){case"OldValue":case"NewValue":return Array.isArray(n[t])?this.List.isAttributDeleted(n[t][0],n[t][1]):super.isAttributDeleted(n,t);default:return super.isAttributDeleted(n,t)}}isVisible(n){return this._details||n.Field===null}get NewItem(){return null}checkItem(){return!0}addItem(){return null}updateItem(){return null}deleteItem(){return null}compareRecord(n,t){return n.HistoryDate<t.HistoryDate?-1:n.HistoryDate>t.HistoryDate?1:0}getNature(n){if(n===null||n===undefined||n.HistoryNature===null||n.HistoryNature===undefined)return"HISTORY_HISTORYNATURE_UPDATE";switch(n.HistoryNature){case List.ListHistory.CREATE:return"HISTORY_HISTORYNATURE_CREATE";case List.ListHistory.UPDATE:return"HISTORY_HISTORYNATURE_UPDATE";case List.ListHistory.DELETE:return"HISTORY_HISTORYNATURE_DELETE"}return"HISTORY_HISTORYNATURE_UPDATE"}isBoxFieldVisible(n,t,i,r){return this.List.isBoxFieldVisible(n,t,i,r===null||r===undefined?null:r.Item)}isBoxFieldReadonly(){return!0}isBoxBoardVisible(n,t,i,r){return this.List.isBoxBoardVisible(n,t,i,r===null||r===undefined?null:r.Item)}isBoxBoardReadonly(){return!0}isBoxPanelVisible(n,t,i,r){return this.List.isBoxPanelVisible(n,t,i,r===null||r===undefined?null:r.Item)?t!=="_history":!1}isBoxPanelReadonly(){return!0}isBoardFieldVisible(n,t,i,r){return this.List.isBoardFieldVisible(n,t,i,r===null||r===undefined?null:r.Item)}isBoardFieldReadonly(){return!0}isBoardAllowed(n,t,i,r){return this.List.isBoardAllowed(n,t,i,r===null||r===undefined?null:r.Item)}getRecord(n){let t={};for(let i in n)i.startsWith("_")||i.startsWith("Copy")||i==="Attachments"||i==="Followers"||i==="Comments"||i==="History"||Array.isArray(n[i])||(t[i]=n[i]);return t._deleted=n.HistoryNature===this.DELETE,t._record=n,t}isEqualHistory(n,t){if((n===null||n===undefined)&&t!==null&&t!==undefined||n!==null&&n!==undefined&&(t===null||t===undefined))return!1;if((n===null||n===undefined)&&(t===null||t===undefined))return!0;for(let t in t)if(!t.startsWith("_")&&!t.startsWith("Copy")&&t!=="Attachments"&&t!=="Followers"&&t!=="Comments"&&t!=="History"&&t!=="Id"&&t!=="CustomerId"&&!t.startsWith("History")&&!Object.prototype.hasOwnProperty.call(n,t))return!1;for(let n in n)if(!n.startsWith("_")&&!n.startsWith("Copy")&&n!=="Attachments"&&n!=="Followers"&&n!=="Comments"&&n!=="History"&&n!=="Id"&&n!=="CustomerId"&&!n.startsWith("History")&&!Object.prototype.hasOwnProperty.call(t,n))return!1;for(let i in n)if(!i.startsWith("_")&&!i.startsWith("Copy")&&i!=="Attachments"&&i!=="Followers"&&i!=="Comments"&&i!=="History"&&i!=="Id"&&i!=="CustomerId"&&!i.startsWith("History")){let r=n[i];Object.prototype.hasOwnProperty.call(n,"History"+i)&&(r=n["History"+i]);let u=t[i];if(Object.prototype.hasOwnProperty.call(t,"History"+i)&&(u=t["History"+i]),!DSRecord.IsEqualValue(r,u))return!1}return!0}set Item(n){if(this._item=n===null||n===undefined?null:n,this.clear(),this._item!==null){let r=[];for(let n of Array.toIterable(this._item.History))r.push(this.getRecord(n));r.sort(this.compareRecord);let i=null,t=null,u=!0;for(let n in r){if(i=t,t=r[n],i===null||t._deleted){this.push(t._record,this.List.getText(t),this.getNature(t));continue}u=!0;for(let n in t)if(!n.startsWith("_")&&!n.startsWith("Copy")&&!n.startsWith("History")&&n!=="Id"&&n!=="CustomerId"){let r=i[n];Object.prototype.hasOwnProperty.call(i,"History"+n)&&(r=i["History"+n]);let f=t[n];Object.prototype.hasOwnProperty.call(t,"History"+n)&&(f=t["History"+n]);DSRecord.IsEqualValue(r,f)===!1&&(this.push(t._record,this.List.getText(t),this.getNature(t),DSDatabase.Instance.getColumnLabel(this._table,n),[i,n],[t,n]),u=!1)}u&&this.push(t._record,this.List.getText(t),this.getNature(t));for(let n in t._record._subLists){let u=t._record._subLists[n];if(u.table!=="History"&&u.composition){let r=List.ListRecord.CACHE_LIST(u.table.substr(7)),f=i===null?[]:i._record[n];for(let i of Array.toIterable(t._record[n])){let e=null,u=(t._record._table+"_"+n).toUpperCase();u.startsWith("HISTORY")&&(u=u.substr(7));switch(i.HistoryNature){case List.ListHistory.CREATE:this.push(t._record,this.List.getText(t),"HISTORY_HISTORYNATURE_LISTCREATE",u,"",r.getText(i));break;case List.ListHistory.UPDATE:for(let n of Array.toIterable(f))if(n.HistoryId===i.HistoryId){e=n;break}if(this.isEqualHistory(e,i))break;this.push(t._record,this.List.getText(t),"HISTORY_HISTORYNATURE_LISTUPDATE",u,r.getText(e),r.getText(i));break;case List.ListHistory.DELETE:this.push(t._record,this.List.getText(t),"HISTORY_HISTORYNATURE_LISTDELETE",u,"",r.getText(i))}}}}}this.sort()}}constructor(n){super([]);this._currentId=0;this._details=!0;this._item=null;this._table=n===null||n===undefined?null:n;this._list=null}});List.ListLanguage=(class extends List.List{getId(n){return n}getLanguageLabel(n){return n}getText(){return null}getPicture(){return null}getList(){return Language.Manager.Instance.Languages}constructor(){super()}});List.ListRecord=(class extends List.List{static get GetSubListNewSequence(){return this._newSequenceId?(this._newSequenceId--,this._newSequenceId):(this._newSequenceId=-2,-2)}static CACHE_LIST(n){this._cacheList||(this._cacheList={});let t=this._cacheList[n];if(t!==null&&t!==undefined)return t;try{let i=eval(n+"Record.List");return t=new i(!0),Logger.Instance.verbose("CACHE_LIST","[1] : "+n),this._cacheList[n]=t,t}catch(i){Logger.Instance.verbose("CACHE_LIST","[1] Unable to create list '"+n+"'");t=null}if(n.startsWith("History")&&n!=="History")try{let r=eval(n.substr(7)+"Record.List");t=new List.ListRecord(n,!0);Logger.Instance.verbose("CACHE_LIST","[2] : "+n);this._cacheList[n]=t;let i=new r(!0);if(i._subLists!==null&&i._subLists!==undefined)for(let n in i._subLists)if(n!=="History"){let r=i._subLists[n];r.composition?t.declareListValues(n,"History"+r.table,r.column,!1):(t.declareListValues(n,r.table,r.column,!1,null),t._subLists[n].history=!0)}return t}catch(i){Logger.Instance.verbose("CACHE_LIST","[2] Unable to create list '"+n+"'");t=null}return t=new List.ListRecord(n,!0),Logger.Instance.verbose("CACHE_LIST","[3] : "+n),this._cacheList[n]=t,t}static SetListValues(n,t){if(n===undefined||n===null||t===null||t===undefined||t._subLists!==undefined)return t;t._subLists={};for(let i in n){let r=n[i];r!==null&&r!==undefined&&(t._subLists[i]={list:r.list,table:r.table,column:r.column,property:i,composition:r.composition,history:r.history,values:null},Object.defineProperty(t,i,{enumerable:!1,get:function(){let n=this._subLists[i];if(n===null||n===undefined)return n.values=[],n.values;if(n.values!==null||(n.values=[],n.list===null||this.Id<0))return n.values;let t={};t[n.column]=this.Id;n.history&&this.HistoryId!==null&&this.HistoryId!==undefined&&(t[n.column]=this.HistoryId);for(let t of Array.toIterable(n.list.getListIndexed(n.column,t)))t._parent=this,t._id=t.Id,t._list=n,n.values[t._id]=t;return n.values}}))}return t}static SetForeignKeys(n,t){if(n===undefined||n===null||t===null||t===undefined||t._foreignKeys!==undefined)return t;t._foreignKeys={};for(let i in n){let r=n[i];r!==null&&r!==undefined&&(t._foreignKeys[i]={field:r.field,table:r.table,list:r.list,id:null,value:null},Object.defineProperty(t,i,{enumerable:!1,get:function(){let n=this._foreignKeys[i],t=this[n.field];if(n.value!==null&&n.value.Id>=0&&n.id===t&&n.value.Id===t)return n.value;if(t===null||t===undefined)return n.id=null,n.value=null,null;let r=null;return(r=t<0?this._id!==undefined&&this._id!==null&&this._id<0?this._parent:null:n.list.getItem(t,!0),r===null||r===undefined)?(n.id=null,n.value=null,null):(n.id=r.Id,n.value=r,r)},set:function(n){let t=this._foreignKeys[i];if(n===null||n===undefined){this[t.field]=null;t.id=null;t.value=null;return}let r=null;typeof n=="number"||typeof n=="string"?r=t.list.getItem(id,!0):n.Id!==null&&n.Id!==undefined&&(r=n);r===null?(this[t.field]=null,t.id=null,t.value=null):(this[t.field]=r.Id,t.id=r.Id,t.value=r)}}))}return t}static SetExtendedFields(n,t){if(t=List.ListRecord.SetListValues(n._subLists,t),n instanceof List.ListRecord&&n._foreignKeys===null){let t=DSDatabase.Instance.getForeignKeys(n.Table);n._foreignKeys={};for(let i in t){let r=t[i],u=i;i==="HistoryId"?i="HistoryRef":i.endsWith("Id")?i=i.substr(0,i.length-2):i+="Ref";n._foreignKeys[i]={field:u,table:r,list:List.ListRecord.CACHE_LIST(r),id:null,value:null}}}return List.ListRecord.SetForeignKeys(n._foreignKeys,t)}static CleanUpExtendedFields(n){if(n===null||n===undefined)return n;if(n._subLists!==null&&n._subLists!==undefined)for(let n of Array.toIterable(n._subLists))n.values=null;if(n._foreignKeys!==null&&n._foreignKeys!==undefined)for(let n of Array.toIterable(n._foreignKeys))n.id=null,n.value=null;return n}get Table(){return this._table}get SequenceProperty(){return this._sequenceProperty}set CSVList(n){this._csv_list=n}get CSVList(){return this._csv_list}destructor(){this._subLists=null;super.destructor()}declareListValues(n,t,i,r,u){this._subLists===null&&(this._subLists={});this._subLists[n]={list:u===null||u===undefined?List.ListRecord.CACHE_LIST(t):u,table:t,column:i,property:n,composition:r!==null&&r!==undefined&&r===!0,history:!1}}getListValues(n){return this._subLists===null?null:this._subLists[n]===null||this._subLists[n]===undefined?null:this._subLists[n]}declareSequence(n,t,i){this._sequenceProperty=n;this._sequenceKey=t;this._sequenceLength=i}createSequence(n,t){function i(i){return function(r){if(typeof r=="number"){let u=i._sequenceKey+r.toString().padStart(i._sequenceLength,"0"),f={};f[i._sequenceProperty]=u;let e=i.getListIndexed(i._sequenceProperty,f);return e.length===0?(n._sequenceId=r,n[i._sequenceProperty]=u,t(),!0):!1}return t(),!0}}return this._sequenceProperty===null?(t(),!0):!Hub.Instance.IsRunning&&!DSDatabase.Instance.hasSequence(this._sequenceKey)?!1:(DSDatabase.Instance.nextSequence(this._sequenceKey,i(this)),!0)}async createSequenceAsync(n){function t(t){return function(i){if(typeof i=="number"){let r=t._sequenceKey+i.toString().padStart(t._sequenceLength,"0"),u={};u[t._sequenceProperty]=r;let f=t.getListIndexed(t._sequenceProperty,u);return f.length===0?(n._sequenceId=i,n[t._sequenceProperty]=r,fn(),!0):!1}return fn(),!0}}return this._sequenceProperty===null?(fn(),!0):!Hub.Instance.IsRunning&&!DSDatabase.Instance.hasSequence(this._sequenceKey)?!1:(DSDatabase.Instance.nextSequence(this._sequenceKey,t(this)),!0)}compare(n,t){let i=this.getText(n),r=this.getText(t);return i===r?0:i<r?-1:1}each(n){function t(n,t){return function(i){(i=List.ListRecord.SetExtendedFields(n,i),n.isVisible(i))&&t(i)}}DSDatabase.Instance.each(this._table,t(this,n))}getList(){function t(n,t){return function(i){(i=List.ListRecord.SetExtendedFields(n,i),n.isVisible(i))&&t.push(i)}}let n=[];return DSDatabase.Instance.each(this._table,t(this,n)),n}getListIndexed(n,t){function u(n,t,i){return function(r){if(n.isVisible(r)){for(let n in i)if(r[n]!==i[n])return;t.push(r)}}}let r=DSDatabase.Instance.getIndex(this.Table,n,t),i=[];if(r===null)Logger.Instance.warn("List["+this._table+"]","Index missing on the column '"+n+"' for keys "+String.JSONStringify(t)),console.warn("List["+this._table+"] : Index missing on the column '"+n+"' for keys "+String.JSONStringify(t)),this.each(u(this,i,t));else for(let n of Array.toIterable(r)){let t=this.getItem(n);this.isVisible(t)&&i.push(t)}return i}onOpen(){function n(n){return function(t,i,r,u){n.raise(t,i,r,u)}}function t(n){return function(t,i,r,u,f){n.raise(t,i,r,u,f)}}function i(n){return function(t,i,r,u){n.raise(t,i,r,u)}}function r(n){return function(t,i){n.raise(t,i)}}super.onOpen();this.addListener(DSDatabase.Instance.addEventListener("onCreate",this._table,"*",n(this)));this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._table,"*",t(this)));this.addListener(DSDatabase.Instance.addEventListener("onDelete",this._table,"*",i(this)));this.addListener(DSDatabase.Instance.addEventListener("onLoad",this._table,"*",r(this)))}get NewItem(){if(this._subLists===null)return DSDatabase.Instance.getNewRow(this._table);let n=List.ListRecord.SetExtendedFields(this,DSDatabase.Instance.getNewRow(this._table));this._sequenceProperty!==null&&(n._sequenceProperty=this._sequenceProperty,n._sequenceKey=this._sequenceKey,n._sequenceLength=this._sequenceLength,n._sequenceId=null);for(let t in this._subLists){let i=n._subLists[t];i!==null&&i!==undefined&&(i.values=[])}return n}createSubItem(n,t){if(List.ListRecord.SetExtendedFields(this,n),n===null||n===undefined||n._subLists===null||n._subLists===undefined)return null;let i=n._subLists[t];if(i===null||i===undefined||i.list===null)return null;let r=i.list.NewItem;return r[i.column]=n.Id,r._parent=n,r._id=List.ListRecord.GetSubListNewSequence,r._list=i,List.ListRecord.SetExtendedFields(i.list,r),r}addSubItem(n,t){let i=this.createSubItem(n,t);return n[t][i._id]=i,i}getItem(n,t){let i=null;return(typeof n=="number"?i=DSDatabase.Instance.getRowById(this._table,n):typeof n=="string"&&(i=DSDatabase.Instance.getRowById(this._table,parseInt(n))),i===null)?null:(i=List.ListRecord.SetExtendedFields(this,i),t!==null&&t!==undefined&&t)?i:i._deleted||!this.isVisible(i)?null:i}getAttributHTML(n,t){switch(t){case"Enable":return this.getAttributHTMLBoolean(n,t);case"Picture":return this.getAttributHTMLPicture(n,t);default:return super.getAttributHTML(n,t)}}getAttributText(n,t){let i=null;switch(t){case"Picture":return"";case"ToolTip":return n.ToolTip===undefined?this.getAttributText(n,"Comment"):(i=String.convertValue(n.ToolTip),i===null?"":i);default:return super.getAttributText(n,t)}}isVisible(n){return super.isVisible(n)?this._allRecords?!0:n.Enable!==undefined?n.Enable:!0:!1}checkProperties(n,t){let i=DSDatabase.Instance.checkProperties(this.Table,n,t);if(this._subLists===null)return null;for(let n in this._subLists){let r=this._subLists[n];if(r!==null&&r!==undefined&&r.list!==null&&r.list!==undefined&&r.composition)for(let i of Array.toIterable(i[n])){let u=new Errors;r.list.checkProperties(i,u);u.HasError&&(i._line===null||i._line===undefined?t.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,i._id]),u):t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,i._line]),u))}}return t.HasError?t:null}checkItem(n,t,i){let r=null;if(this._subLists===null)return null;for(let u in this._subLists){let f=this._subLists[u];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition)for(let n of Array.toIterable(n[u])){let e=new Errors,o=f.list.checkItem(n,e,i);e.HasError&&(n._line===null||n._line===undefined?t.addError(Language.Manager.Instance.interpolation("ERR_ID",[u,n._id]),e):t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[u,n._line]),e));r===null&&Helper.IsLabel(o)&&(r=o)}}return t.HasError?t:Helper.IsLabel(r)?r:null}addHistory(n,t,i,r,u){if(this._subLists!==null){let s=this._subLists.History;if(s!==undefined&&s!==null){let f={},e=i===null?t:i;for(let n in e)if(!n.startsWith("_")&&r!==n){let t=e[n];if(t===undefined&&(t=null),t===null){f[n]=null;continue}if(typeof t!="function"){if(typeof t=="number"&&n!=="Id"&&!n.startsWith("Copy")){let i=DSDatabase.Instance.getHistoryValue(this.Table,n,t);i===null?f[n]=t:(f["History"+n]=i.Id,f[n]=i.HistoryId);continue}if(typeof t=="string"||typeof t=="number"||typeof t=="boolean"){f[n]=t;continue}if(t instanceof Date){f[n]=new Date(t);continue}if(t instanceof moment){f[n]=new moment(t);continue}}}f.HistoryId=f.Id;f.Id=-1;f.HistoryUserId=DSDatabase.Instance.CurrentUser.Id;f.HistoryDate=new moment;f.HistoryNature=n;r!==undefined&&r!==null&&(f["History"+r]=e[r],f[r]=u);let o=new Errors;if(f=DSDatabase.Instance.addFromClient("History"+this.Table,f,o),o.HasError){Logger.Instance.warn("List.ListRecord","Errors occured during added history item (ignore it) : "+o.toString());return}if(this._subLists===null&&this._subLists===undefined)return f;for(let n in this._subLists){let r=this._subLists[n];if(r!==null&&r!==undefined&&n!=="History"&&r.list!==null&&r.list!==undefined&&r.composition){f[n]=[];let o=List.ListRecord.CACHE_LIST(r.table),e=t===null?[]:t[n],u=i===null?[]:i[n];for(let t in u){let i=u[t];i=i===null||i===undefined?null:i;let s=e[t];s=s===null||s===undefined?null:s;i!==null&&s===null&&f[n].push(o.addHistory(List.ListHistory.CREATE,s,i,r.column,f.Id))}for(let t in u){let i=u[t];i=i===null||i===undefined?null:i;let s=e[t];s=s===null||s===undefined?null:s;i!==null&&s!==null&&f[n].push(o.addHistory(List.ListHistory.UPDATE,s,i,r.column,f.Id))}for(let t in e){let s=u[t];s=s===null||s===undefined?null:s;let i=e[t];i=i===null||i===undefined?null:i;s===null&&i!==null&&f[n].push(o.addHistory(List.ListHistory.DELETE,i,null,r.column,f.Id))}}}return f}}}addItem(n,t,i,r){if(n=DSDatabase.Instance.updateHistoryProperties(this.Table,n),r===null||r===undefined||r){let r=this.checkItem(n,t,i);if(t.HasError)return t;if(Helper.IsLabel(r))return r}let u=DSDatabase.Instance.addFromClient(this._table,n,t);if(t.HasError)return t;if(this._subLists===null)return u;List.ListRecord.SetExtendedFields(this,u);for(let r in this._subLists){let f=this._subLists[r];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let e=u._subLists[r];e.values=[];for(let n of Array.toIterable(n[r])){n[f.column]=u.Id;let s=new Errors,o=f.list.addItem(n,s,i,!1);(s.HasError&&(n._line===null||n._line===undefined?t.addError(Language.Manager.Instance.interpolation("ERR_ID",[r,n._id]),s):t.addError(Language.Manager.Instance.interpolation("ERR_LINE",[r,n._line]),s)),o!==null)&&(o._parent=u,o.__id=n._id,o._id=o.Id,o._list=f,e.values[o.Id]=o)}}}return t.HasError?t:((r===null||r===undefined||r)&&this.addHistory(List.ListHistory.CREATE,null,u),u)}updateItem(n,t,i,r,u,f){if(i=DSDatabase.Instance.updateHistoryProperties(this.Table,i),f===null||f===undefined||f){let n=this.checkItem(i,r,u);if(r.HasError)return r;if(Helper.IsLabel(n))return n}let e=DSDatabase.Instance.updateFromClient(this._table,t,i,r);if(r.HasError)return r;if(this._subLists===null)return e;List.ListRecord.SetExtendedFields(this,e);for(let n in this._subLists){let f=this._subLists[n];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let s=t[n],h=i[n],o=e._subLists[n];o.values=[];for(let n in s){let t=s[n];if(t.Id!==-1&&!h[n]){let i=new Errors;f.list.deleteItem(t.Id,t,i,!1);i.HasError&&(t._line===null||t._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[f.column,t._id]),i):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[f.column,t._line]),i))}}for(let t in h){let i=h[t];if(i.Id!==-1){if(DSRecord.IsEqual(i,s[t])){o.values[i.Id]=DSRecord.Clone(i);o.values[i.Id].__id=i._id;continue}let l=new Errors,c=f.list.updateItem(i.Id,s[t],i,l,u,!1);(l.HasError&&(i._line===null||i._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,i._id]),l):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,i._line]),l)),c!==null)&&(c._parent=e,c.__id=i._id,c._id=c.Id,c._list=f,o.values[c.Id]=c)}}for(let t of Array.toIterable(h))if(t.Id===-1){t[f.column]=e.Id;let s=new Errors,i=f.list.addItem(t,s,u,!1);(s.HasError&&(t._line===null||t._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,t._id]),s):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,t._line]),s)),i!==null)&&(i._parent=e,i.__id=t._id,i._id=i.Id,i._list=f,o.values[i.Id]=i)}}}return r.HasError?r:((f===null||f===undefined||f)&&this.addHistory(List.ListHistory.UPDATE,t,e),e)}deleteItem(n,t,i,r){if(this._subLists!==null){for(let n in this._subLists){let r=this._subLists[n];if(r!==null&&r!==undefined&&r.list!==null&&r.list!==undefined&&r.composition){for(let t of Array.toIterable(t[n])){let u=new Errors;r.list.deleteItem(t.Id,t,u,!1);u.HasError&&(t._line===null||t._line===undefined?i.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,t._id]),u):i.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,t._line]),u))}t._subLists[n].values=[]}}if(i.HasError)return i}let u=DSDatabase.Instance.deleteFromClient(this._table,t,i);if(i.HasError)return i;if(this._subLists===null)return u;u=List.ListRecord.SetExtendedFields(this,u);for(let n in this._subLists){let t=u._subLists[n];t!==null&&t!==undefined&&(t.values=[])}return(r===null||r===undefined||r)&&this.addHistory(List.ListHistory.DELETE,u,null),u}cancelItem(n,t,i,r){if(this._subLists===null)return!0;i!==null&&i!==undefined&&typeof i._sequenceId=="number"&&DSDatabase.Instance.cancelSequence(i._sequenceKey,i._sequenceId);for(let n in this._subLists){let f=this._subLists[n];if(f!==null&&f!==undefined&&f.list!==null&&f.list!==undefined&&f.composition){let e=t===null||t===undefined?null:t[n],u=i===null||i===undefined?null:i[n];if(u!==null&&u!==undefined)for(let t of Array.toIterable(u))if(t.Id===-1){let i=new Errors;f.list.cancelItem(t.Id,null,t,i);i.HasError&&(t._line===null||t._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,t._id]),i):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,t._line]),i))}if(u!==null&&u!==undefined&&e!==null&&e!==undefined)for(let t in u){let i=u[t];if(i.Id!==-1&&!DSRecord.IsEqual(i,e[t])){let o=new Errors;f.list.cancelItem(i.Id,e[t],i,o);o.HasError&&(i._line===null||i._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,i._id]),o):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,i._line]),o))}}if(e!==null&&e!==undefined)for(let t in e){let i=e[t];if(i.Id!==-1&&(u===null||u===undefined||!u[t])){let o=new Errors;f.list.cancelItem(i.Id,i,null,o);o.HasError&&(i._line===null||i._line===undefined?r.addError(Language.Manager.Instance.interpolation("ERR_ID",[n,i._id]),o):r.addError(Language.Manager.Instance.interpolation("ERR_LINE",[n,i._line]),o))}}}}return!r.HasError}beginTransaction(n,t){super.beginTransaction(n,t);DSDatabase.Instance.beginTransaction(n,t)}endTransaction(){DSDatabase.Instance.endTransaction();super.endTransaction()}async commitAsync(){await DSDatabase.Instance.commit()}rollback(){DSDatabase.Instance.rollback()}async rollbackAsync(){await DSDatabase.Instance.rollbackAsync()}isBoxFieldReadonly(n,t,i,r){return super.isBoxFieldReadonly(n,t,i,r)?!0:this._sequenceProperty!==null&&t===this._sequenceProperty?!0:!1}declareKeysCSV(n,t){super.declareKeysCSV(n,t);this._csv_keys.push([n,t])}declareForeignKeysCSV(n,t,i,r){this._csv_foreignKeys[n]={table:t,list:List.ListRecord.CACHE_LIST(t),keys:{},computed:!1,filter:i,buildingKey:r}}loadForeignKeysCSV(n){function t(n){return function(t){if(!n.filter||n.filter(t)){let i=n.buildingKey?n.buildingKey(n.list,t):n.list.getKey(t);String.isEmptyOrWhiteSpaces(i)||(n.keys[i]=n.list.getId(t))}}}for(let i in this._csv_foreignKeys){let r=this._csv_foreignKeys[i];r.computed||(Logger.Instance.info("List","Reading values for the property '"+i+"' of the CSV file '"+n.Name+"' ..."),r.list.each(t(r)),r.computed=!0)}}getForeignKeysIdCSV(n,t,i){let r=this._csv_foreignKeys[n];if(r===null||r===undefined)return i.addField(n,"ERR_CSV_MISSINGREFERENCE",[t,n]),null;let u=r.keys[t];return u===null||u===undefined?String.isEmptyOrWhiteSpaces(t)?null:(i.addField(n,"ERR_CSV_MISSINGREFERENCE",[t,n]),null):u}startCSV(n,t){function r(n,t,i){return function(r){let u=n.getKey(r);if(n._csv_recordIdsByKey[u]!==undefined)t[u]===undefined&&(t[u]=u,i.addGlobal("ERR_CSV_KEYDOUBLE_DB",u));else{let t=n.getId(r);n._csv_recordIdsByKey[u]=t;n._csv_recordsToDelete[u]=t;n._csv_rowToDelete++}}}if(!super.startCSV(n,t))return!1;this._csv_foreignKeys={};let i=new Errors;if(this._csv_rowToDelete=0,this._csv_recordKey={},this._csv_recordIdsByKey={},this._csv_recordsToDelete={},this._csv_list===null)this.each(r(this,{},i));else{let n=r(this,{},i);for(let t of Array.toIterable(this._csv_list))n(t)}return i.HasError?(t.addErrors(i),!1):(this._csv_transaction_opened=!1,!0)}startPreloadingCSV(n,t){let i=super.startPreloadingCSV(n,t);return this.loadForeignKeysCSV(n),i}startCheckingCSV(n,t){let i=super.startCheckingCSV(n,t);return this.loadForeignKeysCSV(n),i}getRowToDeleteCSV(){return this._csv_rowToDelete}getMappingRecordFromCSV(n,t){function i(n){let t=String.random(n.maxLength);while(n.tmpKeys[t]!==undefined)t=String.random(n.maxLength);return n.tmpKeys[t]=!0,t}if(this._csv_cache===null)return t;for(let n in this._csv_cache){let r=this._csv_cache[n],u=this.getAttributText(t,n);u=String.isEmptyOrWhiteSpaces(u)?"":u;let f=r.values[u];if(f!==undefined&&f._lastValues!==undefined){for(let n in r.attributes)t[n]=f._lastValues[n];continue}let e={};for(let n in r.attributes){let o=this.getAttributText(t,n);o=String.isEmptyOrWhiteSpaces(o)?"":o;let s=r.attributes[n].values[o];if(f!==undefined)if(s!==!0)delete r.values[u][n];else if(f[n][0]===o)delete r.values[u][n];else{let u=f[n];u[1]=o;u[2]=i(r.attributes[n]);t[n]=u[2];delete r.attributes[n].values[u[0]]}else s!==!0||(r.values[u]===undefined&&(r.values[u]={}),r.values[u][n]=[null,o,i(r.attributes[n])],t[n]=r.values[u][n][2]);e[n]=t[n]}(f===null||r.values[u]===undefined)&&(r.values[u]={});r.values[u]._lastValues=e}return t}checkRecordFromCSV(n,t,i,r){if(!super.checkRecordFromCSV(n,t,i,r))return!1;let u=this.getMappingRecordFromCSV(n,this.NewItem,t,i,r);if(u===null)return!0;this.checkProperties(u,r);let f=this.getKey(u),e=this._csv_recordKey[f];return e!==null&&e!==undefined?r.addGlobal("ERR_CSV_KEYDOUBLE_FILE",f):this._csv_recordKey[f]=!0,this.checkItem(u,r,!1),!0}endCheckingCSV(n,t){return this._csv_transaction_opened&&(this._csv_transaction_opened=!1,this.endTransactionCSV(n)),super.endCheckingCSV(n,t)}startImportingCSV(n,t){function i(n){return function(t){for(let i in n._csv_cache){let u=n._csv_cache[i],r=n.getAttributText(t,i);r=String.isEmptyOrWhiteSpaces(r)?"":r;let f={};u.values[r]=f;for(let i in u.attributes){let r=n.getAttributText(t,i);r=String.isEmptyOrWhiteSpaces(r)?"":r;f[i]=[r,null,null];u.attributes[i].values[r]=!0}}}}if(this._csv_cache={},this._csv_keys.length>0){for(let n of Array.toIterable(this._csv_keys)){let i=n[0],r=n[1],t={values:{},attributes:{}};this._csv_cache[i]=t;for(let n of Array.toIterable(r)){let i=DSDatabase.Instance.getColumn(this.Table,n).StringMaxLength;i>64&&(i=64);t.attributes[n]={maxLength:i,tmpKeys:{},values:{}}}}if(this._csv_list===null)this.each(i(this));else{let n=i(this);for(let t of Array.toIterable(this._csv_list))n(t)}}this._csv_counter=0;this._csv_counter_add=n.RowAdded;this._csv_counter_update=n.RowUpdated;this._csv_counter_delete=n.RowDeleted;this._csv_counter_postUpdate=null;let r=super.startImportingCSV(n,t);return this.loadForeignKeysCSV(n),r}getRecordFromCSV(n,t,i,r){let s=super.getRecordFromCSV(n,t,i,r);if(s!==null)return s;let u=this.getMappingRecordFromCSV(n,this.NewItem,t,i,r);if(u===null)return null;this.checkProperties(u,r);let e=this.getKey(u),f=this._csv_recordIdsByKey[e];if(f===null||f===undefined)return{oldItem:null,newItem:u};this._csv_recordsToDelete[e]!==undefined&&(delete this._csv_recordsToDelete[e],this._csv_rowToDelete--);let o=null;return(o=this._csv_list===null?this.getItem(f,!0):this._csv_list[f],u=this.getMappingRecordFromCSV(n,DSRecord.Clone(o,!1),t,i,r),u===null)?null:(this.checkProperties(u,r),{oldItem:o,newItem:u})}beginTransactionCSV(n){let t=undefined,r=!1;this._csv_counter===0&&(t=Helper.Label(this.Table.toUpperCase()+"_IMPORTING_TOAST",[this._csv_counter_add,this._csv_counter_update,n.WillDeleteRows?this._csv_counter_delete:0]));let i=this._csv_counter_add+this._csv_counter_update+(n.WillDeleteRows?this._csv_counter_delete:0);this._csv_counter++;(this._csv_counter>=i||this._csv_counter%this._csv_lotsize==0)&&this._csv_transaction_opened&&(this._csv_transaction_opened=!1,this.endTransactionCSV(n));this._csv_counter>=i&&(this._csv_counter_postUpdate===null&&(this._csv_counter_postUpdate=this.getItemsToPostUpdateCSV(n,new Errors).length),this._csv_counter===i+this._csv_counter_postUpdate&&(t=Helper.Label(this.Table.toUpperCase()+"_IMPORTED_TOAST",[this._csv_counter_add,this._csv_counter_update,n.WillDeleteRows?this._csv_counter_delete:0]),r=!0));this._csv_transaction_opened||(this.beginTransaction(t,r),this._csv_transaction_opened=!0)}endTransactionCSV(){this._csv_transaction_opened||this.endTransaction()}addItemCSV(n,t,i,r,u){this.beginTransactionCSV(n);let f=this.addItem(t,i,r,u);return this.endTransactionCSV(n),f}updateItemCSV(n,t,i,r,u,f,e){this.beginTransactionCSV(n);let o=this.updateItem(t,i,r,u,f,e);return this.endTransactionCSV(n),o}deleteItemCSV(n,t,i,r,u){this.beginTransactionCSV(n);let f=this.deleteItem(t,i,r,u);return this.endTransactionCSV(n),f}getItemsToDeleteCSV(){let n=[];for(let t of Array.toIterable(this._csv_recordsToDelete)){let i=this.getItem(t,!0);i!==null&&n.push(i)}return n}getItemsToPostUpdateCSV(){function t(n,t){return function(i){let r=null;for(let t in n._csv_cache){let e=n._csv_cache[t],u=n.getAttributText(i,t);u=String.isEmptyOrWhiteSpaces(u)?"":u;let f=e.values[u];if(f!==undefined){for(let n in e.attributes)f[n]!==undefined&&f[n][2]!==null&&(r===null&&(r=DSRecord.Clone(i)),r[n]=f[n][1]);delete e.values[u]}}r!==null&&t.push([i,r])}}let n=[];if(this._csv_cache===null)return n;if(this._csv_list===null)this.each(t(this,n));else{let i=t(this,n);for(let n of Array.toIterable(this._csv_list))i(n)}return n}endImportingCSV(n,t){return this._csv_transaction_opened&&(this._csv_transaction_opened=!1,this.endTransactionCSV(n)),this._csv_cache=null,super.endImportingCSV(n,t)}endCSV(n,t){return(this._csv_transaction_opened&&(this._csv_transaction_opened=!1,this.endTransactionCSV(n)),this._csv_recordKey={},this._csv_recordIdsByKey={},this._csv_recordsToDelete={},this._csv_rowToDelete=0,this._csv_foreignKeys={},!super.endCSV(n,t))?!1:!0}constructor(n,t){super();this._table=n;this._allRecords=t===null||t===undefined||t===!0?!0:!1;let i=DSDatabase.Instance.getSequence(n);this._sequenceProperty=i===null?null:i.Property;this._sequenceKey=i===null?null:i.Key;this._sequenceLength=i===null?null:i.Length;this._subLists=null;this._foreignKeys=null;this._csv_list=null;this._csv_mapping=null;this._csv_recordKey={};this._csv_recordIdsByKey={};this._csv_recordsToDelete={};this._csv_rowToDelete=0;this._csv_foreignKeys={};this._csv_cache=null;this._csv_keys=[];this._csv_counter=null;this._csv_counter_add=null;this._csv_counter_update=null;this._csv_counter_delete=null;this._csv_counter_postUpdate=null;this._csv_lotsize=DSDatabase.Instance.Tables[n]===undefined||DSDatabase.Instance.Tables[n]===null?1:DSDatabase.Instance.Tables[n].LotSize;this._csv_transaction_opened=!1}});List.ListArrayRecord=(class extends List.ListArray{get Table(){return this._listRecord.Table}get Column(){return this._column}get ListRecord(){return this._listRecord}get ListParent(){return this._listParent}get Item(){return this._item}set Item(n){this._array=[];this._item=n===undefined||n===null?null:n;this._item!==null&&this._item[this._column]&&(this._array=this._item[this._column])}get SequenceProperty(){return this._listRecord._sequenceProperty}createSequence(n,t){return this._listRecord.createSequence(n,t)}compare(n,t){return this._listRecord.compare(n,t)}each(n){for(let t of Array.toIterable(this._array))n(t)}getList(){let n=[];for(let t of Array.toIterable(this._array))n.push(t);return n}get NewItem(){return this._listRecord.createSubItem(this._item,this._column)}getId(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n:n._id!==undefined?n._id:n.Id!==undefined&&n.Id>0?n.Id:null}getItem(n){let t=this._array[n];return t?DSRecord.Clone(t):null}getText(n){return this._listRecord.getText(n)}getKey(n){return this._listRecord.getKey(n)}getLanguageLabel(n){return this._listRecord.getLanguageLabel(n)}getPicture(n){return this._listRecord.getPicture(n)}getAttributHTML(n,t){return this._listRecord.getAttributHTML(n,t)}getAttributToolTipHTML(n,t){return this._listRecord.getAttributToolTipHTML(n,t)}getAttributText(n,t){return this._listRecord.getAttributText(n,t)}getAttributValue(n,t){return this._listRecord.getAttributValue(n,t)}getAttributCSV(n,t){return this._listRecord.getAttributCSV(n,t)}isAttributDeleted(n,t){return this._listRecord.isAttributDeleted(n,t)}isVisible(n){return this._listRecord.isVisible(n)}isDeleted(n){return this._listRecord.isDeleted(n)}checkItem(n,t,i){let r=this._listRecord.checkItem(n,t,i);if(Helper.IsLabel(r))return r;if(t.HasError)return t;if(n._table===null||n._table===undefined||n._parent===null||n._parent===undefined)return r;let f=n._parent,e=f[n._list.property],u=DSDatabase.Instance.Tables[n._table];for(let i in u._columnsByName){let f=u._columns[u._columnsByName[i]],o=f.Unique;if(o!==null){let r=!1;for(let t of Array.toIterable(e))if(t._id!==n._id){r=!0;for(let i of Array.toIterable(o.Fields))if(!DSRecord.IsEqualValue(n[i],t[i])){r=!1;break}if(r)break}r&&(Logger.Instance.error("ListArrayRecord","The value '"+n[i]+"' already exists for the column '"+i+"'"),t.addField(f.Property,o.Error,["{"+f.Field+"}"]))}}return t.HasError?t:r}addItem(n,t,i){let r=DSDatabase.Instance.updateHistoryProperties(this.Table,n);if(r!==null&&(n=r),n=DSDatabase.Instance.checkProperties(this.Table,n,t),t.HasError)return t;let u=this.checkItem(n,t,i);return t.HasError?t:Helper.IsLabel(u)?u:(this._array[this.getId(n)]=n,this.raise("onCreate",this.Table,this.getId(n),n),n)}updateItem(n,t,i,r,u){let f=DSDatabase.Instance.updateHistoryProperties(this.Table,i);if(f!==null&&(i=f),i=DSDatabase.Instance.checkProperties(this.Table,i,r),r.HasError)return r;let e=this.checkItem(i,r,u);return r.HasError?r:Helper.IsLabel(e)?e:(this._array[this.getId(i)]=i,this.raise("onUpdate",this.Table,this.getId(i),t,i),i)}deleteItem(n,t){let i=this._array[this.getId(t)];if(i)return delete this._array[this.getId(t)],this.raise("onDelete",this.Table,this.getId(i),i),i}cancelItem(n,t,i,r){return this._listRecord.cancelItem(n,t,i,r)}isBoxFieldVisible(n,t,i,r){return this._listRecord.isBoxFieldVisible(n,t,i,r)}isBoxFieldReadonly(n,t,i,r){return this._listRecord.isBoxFieldReadonly(n,t,i,r)}isBoxBoardVisible(n,t,i,r){return this._listRecord.isBoxBoardVisible(n,t,i,r)}isBoxBoardReadonly(n,t,i,r){return this._listRecord.isBoxBoardReadonly(n,t,i,r)}isBoxPanelVisible(n,t,i,r){return this._listRecord.isBoxPanelVisible(n,t,i,r)}isBoxPanelReadonly(n,t,i,r){return this._listRecord.isBoxPanelReadonly(n,t,i,r)}isBoardFieldVisible(n,t,i,r){return this._listRecord.isBoardFieldVisible(n,t,i,r)}isBoardFieldReadonly(n,t,i,r){return this._listRecord.isBoardFieldReadonly(n,t,i,r)}isBoardAllowed(n,t,i,r){return this._listRecord.isBoardAllowed(n,t,i,r)}startCSV(n,t){return this._listRecord.CSVList=this._array,this._listRecord.startCSV(n,t)}getRowToDeleteCSV(n){return this._listRecord.getRowToDeleteCSV(n)}startPreloadingCSV(n,t){return this._listRecord.startPreloadingCSV(n,t)}preloadRecordFromCSV(n,t,i,r){return this._listRecord.preloadRecordFromCSV(n,t,i,r)}endPreloadingCSV(n,t){return this._listRecord.endPreloadingCSV(n,t)}startCheckingCSV(n,t){return this._listRecord.startCheckingCSV(n,t)}checkRecordFromCSV(n,t,i,r){return this._listRecord.checkRecordFromCSV(n,t,i,r)}endCheckingCSV(n,t){return this._listRecord.endCheckingCSV(n,t)}startImportingCSV(n,t){return this._listRecord.startImportingCSV(n,t)}getRecordFromCSV(n,t,i,r){return this._listRecord.getRecordFromCSV(n,t,i,r)}beginTransactionCSV(){}endTransactionCSV(){}addItemCSV(n,t,i,r,u){return this.addItem(t,i,r,u)}updateItemCSV(n,t,i,r,u,f,e){return this.updateItem(t,i,r,u,f,e)}deleteItemCSV(n,t,i,r,u){return this.deleteItem(t,i,r,u)}getItemsToDeleteCSV(n,t){return this._listRecord.getItemsToDeleteCSV(n,t)}getItemsToPostUpdateCSV(n,t){return this._listRecord.getItemsToPostUpdateCSV(n,t)}endImportingCSV(n,t){return this._listRecord.endImportingCSV(n,t)}endCSV(n,t){return this._listRecord.endCSV(n,t)}constructor(n,t,i){super([]);this._listParent=n===undefined||n===null?null:n;this._listRecord=i===undefined||i===null?null:i;this._item=null;this._column=t}});List.ListArrayRecordAssociation=(class extends List.ListArrayRecord{get Item(){return this._item}set Item(n){super.Item=n;this._targetArray=this._array;this._listAssociation._allRecords=n.HistoryId!==undefined?!0:this._listAssociationAllRecords;this.updateListItems()}compare(n,t){let i=this._listAssociation.getItem(n[this._associationColumn],!0),r=this._listAssociation.getItem(t[this._associationColumn],!0);return String.compare(this._listAssociation.getText(i),this._listAssociation.getText(r))}each(n){let t=[];for(let n of Array.toIterable(this._array))t.push(n);t.sort((n,t)=>this.compare(n,t));for(let t of t)n(List.ListRecord.SetExtendedFields(this.ListRecord,t))}updateListItems(){Logger.Instance.verbose("ListArrayRecordAssociation","Updating the list of items ...");let n=[];for(let t of Array.toIterable(this._targetArray))t.HistoryNature!==List.ListHistory.DELETE&&(n[t[this._associationColumn]]=t);this._array=[];for(let t of this._listAssociation.getListSorted()){let r=this._listAssociation.getId(t),i=null;for(let t of Array.toIterable(n))if(t[this._associationColumn]===r){i=DSRecord.Clone(t);i._selected=!0;delete n[r];break}i===null&&(i=this.ListRecord.createSubItem(this._item,this.Column),i[this._associationColumn]=r,i._selected=!1);this._array[i._id]=i}for(let n of Array.toIterable(n)){let t=DSRecord.Clone(n);t._selected=!0;this._array[t._id]=t}return this._array}onOpen(){function n(n){return function(t,i,r){let o=n.getEvent("onCreate"),s=n.getEvent("onUpdate"),h=n.getEvent("onDelete"),u=[],f=[];for(let t of Array.toIterable(n._array))u[t[n._associationColumn]]=t,f[t[n._associationColumn]]=!1;for(let t of Array.toIterable(n._listAssociation.getList())){let i=n._listAssociation.getId(t);if(i in f&&delete f[i],i in u){if(i!==r)continue;let t=u[i];if(s)try{s("onUpdate",n.Table,i,t,t)}catch(e){Logger.Instance.exception(n.Table,"Exception on updating item",e)}continue}let e=n.ListRecord.createSubItem(n._item,n.Column);if(e[n._associationColumn]=i,e._selected=!1,n._array[e._id]=e,o)try{o("onCreate",n.Table,e._id,e)}catch(e){Logger.Instance.exception(n.Table,"Exception on creating item",e)}}for(let t in f){let r=u[t],i=n.getId(r);if(delete n._array[i],i in n._targetArray&&delete n._targetArray[i],h)try{h("onDelete",n.Table,i,r)}catch(e){Logger.Instance.exception(n.Table,"Exception on deleting item",e)}}}}function t(n){return function(t,i){n.updateListItems();n.raise("onLoad",i)}}super.onOpen();this._listAssociation.on("onCreate",n(this));this._listAssociation.on("onUpdate",n(this));this._listAssociation.on("onDelete",n(this));this._listAssociation.on("onLoad",t(this));this._listAssociation.onOpen()}onClose(){this._listAssociation.unbind("onCreate");this._listAssociation.unbind("onUpdate");this._listAssociation.unbind("onDelete");this._listAssociation.unbind("onLoad");this._listAssociation.onClose();super.onClose()}getAttributHTML(n,t){return t==="_selected"?this.getAttributHTMLBoolean(n,t):super.getAttributHTML(n,t)}getAttributToolTipHTML(n,t){return t==="_selected"?"":super.getAttributToolTipHTML(n,t)}getAttributText(n,t){return t==="_selected"?"":super.getAttributText(n,t)}getAttributValue(n,t){return t==="_selected"?n._selected===!0:super.getAttributText(n,t)}addItem(n,t,i){if(n=DSDatabase.Instance.updateHistoryProperties(this.Table,n),n=DSDatabase.Instance.checkProperties(this.Table,n,t),t.HasError)return t;let u=this.checkItem(n,t,i);if(t.HasError)return t;if(Helper.IsLabel(u))return u;let f=n[this._associationColumn],r=null;n._selected=!1;for(let t in this._array)if(this._array[t][this._associationColumn]===f){r=this._array[t];this._array[t]=n;n.Id=r.Id;n._id=r._id;n._selected=!0;break}return n._selected?(this._targetArray[n._id]=n,n._selected=!0,this.raise("onUpdate",this.Table,n.Id,r,n),n):(Logger.Instance.error("List.ListArrayRecordAssociation","The list references an inexisting element ..."),t.addFatal("ERR_EXCEPTION_UNEXPECTED"),t)}updateItem(n,t,i,r,u){return this.addItem(i,r,u)}deleteItem(n,t){let i=t[this._associationColumn];for(let r in this._array)if(this._array[r][this._associationColumn]===i){this._array[r]._selected=!1;delete this._targetArray[this._array[r]._id];this.raise("onUpdate",this.Table,n,t,this._array[r]);break}}constructor(n,t,i,r,u){super(n,t,i);this._targetArray=[];this._associationColumn=r;this._listAssociation=u===undefined||u===null?null:u;this._listAssociationAllRecords=this._listAssociation!==null?this._listAssociation._allRecords:!1}});class DSAnnotationAttribute{static Factory(n){switch(n.Type){case"ForeignKey":return new DSForeignKeyAttribute(n.Error,n.Table);case"Index":return new DSIndexAttribute(n.Error,n.CaseSensitive,n.Fields);case"Unique":return new DSUniqueAttribute(n.Error,n.CaseSensitive,n.Fields);case"Decimal":return new DSDecimalAttribute(n.Error,n.Digit,n.Precision,n.Unit);case"Email":return new DSEmailAttribute(n.Error);case"Key":return new DSKeyAttribute(n.Error);case"Required":return new DSRequiredAttribute(n.Error);case"String":return new DSStringAttribute(n.Error,n.Min,n.ErrorMin,n.Max,n.ErrorMax);case"DateTime":return new DSDateTimeAttribute(n.Format);case"Mask":return new DSMaskAttribute(n.Mask);case"Sequence":return new DSSequenceAttribute(n.Key,n.Length);case"Password":return new SyncytiumasswordAttribute;case"File":return new DSFileAttribute}return Logger.Instance.error("DSAnnotationAttribute","Type '"+n.Type+"' not implemented!"),null}static FactoryList(n){let t=[];for(let i of Array.toIterable(n)){let r=DSAnnotationAttribute.Factory(i);if(r&&t.push(r),r instanceof DSForeignKeyAttribute){i={Type:"Index",Error:"",CaseSensitive:"True",Fields:null};for(let n of Array.toIterable(n))if(n.Type===i.Type&&n.Error===i.Error&&n.CaseSensitive===i.CaseSensitive&&(n.Fields===null||n.Fields===undefined)){i=null;break}i!==null&&(r=DSAnnotationAttribute.Factory(i),r&&t.push(r))}}return t}get Type(){return"Annotation"}toString(){return this.Type+" = "+String.JSONStringify(this)}constructor(){}}class DSConstraintAttribute extends DSAnnotationAttribute{get Type(){return"Constraint"}get Error(){return this._error}constructor(n){super();this._error=n}}class DSForeignKeyAttribute extends DSConstraintAttribute{get Type(){return"ForeignKey"}get Table(){return this._table}constructor(n,t){super(n);this._table=t}}class DSIndexAttribute extends DSConstraintAttribute{get Type(){return"Index"}get Fields(){return this._fields}get FieldName(){return this._fields[0]}get FieldNames(){return String.JSONStringify(this._fields)}addField(n){this._fields=[n].concat(this._fields)}addIndexFields(n){this._indexFields=[];for(let t of this._fields)this._indexFields.push(n[t])}getValue(n){let i=undefined,t=undefined;for(let r of Array.toIterable(this._fields)){let u=n[r];(u===null||u===undefined)&&(u=null);u!==null&&(u=this._caseSensitive?u.toString():u.toString().toUpperCase());i===undefined?i=u:t===undefined?t=[i,u]:t.push(u)}return t!==undefined?t:i}match(n){if(n===null||n===undefined)return!1;for(let t of this._fields)if(n[t]===undefined)return!1;return!0}isEqual(n,t){for(let i of this._indexFields)if(n[i]!==t[i])return!1;return!0}getIds(n){let t=this.getValue(n);if(t===null)return[];let i=this._values[t];return i===undefined?[]:i}getValues(){let n=[];for(let t in this._values)n.push(t);return n}addValue(n){let t=this.getValue(n);if(t!==null){let i=n.Id;i===undefined||i===null||i<0||(this._values[t]===undefined&&(this._values[t]=[]),this._values[t].push(i))}}existValue(n){let r=this.getValue(n);if(r===null||this._values[r]===undefined)return!1;let t=n.Id;if(t===undefined||t===null||t<0)return!0;let i=this._values[r];return i===null||i===undefined?!1:i.indexOf(t)>=0?!1:i.length>0}deleteValue(n){let r=this.getValue(n);if(r!==null){let i=n.Id;if(i!==undefined&&i!==null&&!(i<0)){let t=this._values[r];if(t!==null&&t!==undefined){let u=t.indexOf(i);u<0||(t.splice(u,1),t.length===0&&delete this._values[r])}}}}toListValues(){return String.JSONStringify(this._values)}constructor(n,t,i){super(n);this._caseSensitive=t==="True";this._values={};this._fields=i===null||i===undefined?[]:i;this._indexFields=[]}}class DSUniqueAttribute extends DSIndexAttribute{get Type(){return"Unique"}constructor(n,t,i){super(n,t,i)}}class DSControlAttribute extends DSAnnotationAttribute{get Type(){return"Control"}get Error(){return this._error}check(){return!0}constructor(n){super();this._error=n}}class DSDecimalAttribute extends DSControlAttribute{get Type(){return"Decimal"}get NbDigitsBefore(){return this._digit-this._precision}get NbDigitsAfter(){return this._precision}get Unit(){return this._unit}check(n,t,i){let r=0,u=super.check(n,t,i);if(t===null||t===undefined)return u;switch(typeof t){case"string":r=String.parseFloat(t);break;case"number":r=t;break;case"boolean":r=t?1:0;break;default:return i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString(),t.toString()]),!1}return isNaN(r)?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString(),t.toString()]),!1):r>=this._maxValue||r<=this._minValue?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString(),t.toString()]),!1):String.parseFloat(r.toFixed(8))!==String.parseFloat(r.toFixed(this._precision))?(i.addField(n.Property,this._error,["{"+n.Field+"}",this._digit.toString(),this._precision.toString(),t.toString()]),!1):u}constructor(n,t,i,r){super(n);this._digit=t;this._precision=i;this._unit=String.isEmptyOrWhiteSpaces(r)?null:String.decode(r);this._maxValue=this._digit<=0?1:10;for(let n=i+1;n<this._digit;n++)this._maxValue*=10;this._minValue=-this._maxValue}}class DSEmailAttribute extends DSControlAttribute{get Type(){return"Email"}check(n,t,i){let r=super.check(n,t,i);return t===null||t===undefined?r:typeof t!="string"?(i.addField(n.Property,this._error,["{"+n.Field+"}","{ERR_FIELD_TYPE}"]),!1):!String.isEmptyOrWhiteSpaces(t)&&!String.isEmailValide(t)?(i.addField(n.Property,this._error,["{"+n.Field+"}",t]),!1):r}constructor(n){super(n)}}class DSRequiredAttribute extends DSControlAttribute{get Type(){return"Required"}check(n,t,i){let r=super.check(n,t,i);return t===null||t===undefined?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):typeof t=="string"&&String.isEmptyOrWhiteSpaces(t)?(i.addField(n.Property,this._error,["{"+n.Field+"}"]),!1):r}constructor(n){super(n)}}class DSStringAttribute extends DSControlAttribute{get Type(){return"String"}get MaxLength(){return this._max}check(n,t,i){let r=super.check(n,t,i);return t===null||t===undefined?this._min>0?(i.addField(n.Property,this._errorMin,["{"+n.Field+"}",this._min.toString()]),!1):r:typeof t!="string"?(i.addField(n.Property,this._error,["{"+n.Field+"}","{ERR_FIELD_TYPE}"]),!1):(t.length<this._min&&(i.addField(n.Property,this._errorMin,["{"+n.Field+"}",this._min.toString()]),r=!1),this._max>=0&&t.length>this._max&&(i.addField(n.Property,this._errorMax,["{"+n.Field+"}",this._max.toString()]),r=!1),r)}constructor(n,t,i,r,u){super(n);this._min=t;this._errorMin=i;this._max=r;this._errorMax=u}}class DSKeyAttribute extends DSRequiredAttribute{get Type(){return"Key"}constructor(n){super(n)}}class DSFormatAttribute extends DSAnnotationAttribute{get Type(){return"Format"}convertFromJSON(n){return n}convertToJSON(n){return n}constructor(){super()}}class DSDateTimeAttribute extends DSFormatAttribute{get Type(){return"DateTime"}get Format(){return this._format}convertFromJSON(n){if(n===null||n===undefined||typeof n!="string")return n;if(n=new moment(n,this._format),!n.isValid())throw"ERR_FIELD_BADFORMAT";return n}convertToJSON(n){return n===null||n===undefined?n:n instanceof Date?moment(n.toString()).format(this._format):n instanceof moment?n.format(this._format):typeof n=="number"?moment(n).format(this._format):n}constructor(n){super();this._format=n}}class DSFileAttribute extends DSFormatAttribute{get Type(){return"File"}constructor(){super()}}class SyncytiumasswordAttribute extends DSFormatAttribute{get Type(){return"Password"}constructor(){super()}}class DSMaskAttribute extends DSFormatAttribute{get Type(){return"Mask"}get Mask(){return this._mask}constructor(n){super();this._mask=n}}class DSSequenceAttribute extends DSFormatAttribute{get Type(){return"Sequence"}get Key(){return this._key}get Length(){return this._length}constructor(n,t){super();this._key=n;this._length=t}}class Hub extends LoggerBaseObject{get IsRunning(){return this._status==="Started"}get IsOnline(){return this._status==="Started"||this._status==="ReadyToSynchronize"}get IsStopped(){return this._status==="Stopped"}async updateStatus(n,t){function i(n,t,i){n.info("The status becomes '"+t+"'"+(i!==undefined?" ("+String.JSONStringify(i)+")":""));let r=n._status;n._status=t;Logger.Instance.status(n._status);for(let u in n._listeners)if(n._listeners[u].onStatusChanged){n.debug("Notify the listener '"+u+"' about the status '"+t+"'");n._listeners[u].onStatusChanged(r,t,i)}}function r(t){return function(r){if(t.info("IsAllowed = "+String.JSONStringify(r)),r.Error!==null&&r.Error!==undefined){let n=new Errors;n.setJSON(r.Error);i(t,"Error",n)}else r.Allow!==null&&r.Allow!==undefined&&r.Allow?i(t,n):i(t,"Error",new Errors("ERR_AUTHENTICATED_TWICE"))}}function u(n){return function(){n.error("IsAllowed = failed!");i(n,"Error",new Errors("ERR_AUTHENTICATED_TWICE"))}}if(this.verbose("Updating status '"+this._status+"' to '"+n+"' ..."),this._status!==n||n==="ReadyToSynchronize"){if(n==="Started"&&this.verbose("Connected, transport = "+$.connection.hub.transport.name),n!=="ReadyToSynchronize"){i(this,n,t);return}this.verbose("Running is allowed ...");await new Promise((n,t)=>{$.connection.databaseHub.server.isAllowed().done(n).fail(t)}).then(r(this)).catch(u(this))}}async initialize(n,t){return this.info("Initializing for the area '"+n+"' ("+t+") ..."),new Promise((i,r)=>{$.connection.databaseHub.server.initialize(n,t).done(i).fail(r)})}ping(){function i(i){return function(){i._timeout=null;i.verbose("Ping the server via HTTP");let r=window.location.href.split("/")[2];n=window.location.href.startsWith("http://localhost")?"http":window.location.href.split(":")[0];window.location.href.indexOf(".syncytium.")>=0&&(t=window.location.href.split("/")[3]);try{$.ajax({type:"POST",url:n+"://"+r+(t===null?"":"/"+t)+"/Administration/Ping/Ping",contentType:!1,processData:!1,data:new FormData})}catch(u){i.exception("Exception on ping access to HTTP",u)}}}let n="http",t=null;this.verbose("Ping the server via WebService");$.connection.databaseHub.server.ping();this._timeoutPing!==null&&(window.clearTimeout(this._timeoutPing),this._timeoutPing=null);this._timeoutPing=setTimeout(i(this),500)}async loadTable(n){function t(t,i){return function(r){if(r.Error!==null&&r.Error!==undefined){i(r);return}if(t._nbLots>=r.NbLots){r.Records=t._rows;t._rows=[];i(r);return}t.info("Waiting for all data of the table '"+n+"' before continuing ...");t._lastNbLots=t._nbLots;t._nbIntervalLoadTable=0;t._intervalLoadTable=setInterval(()=>{if(t._lastNbLots!==t._nbLots){t.warn("Receiving data of the table '"+n+"' ...");t._nbIntervalLoadTable=0;t._lastNbLots=t._nbLots;return}if(t._nbLots<r.NbLots){t.warn("Waiting for all data of the table '"+n+"' before continuing ...");t._nbIntervalLoadTable++;t._nbIntervalLoadTable>10&&(t.error("Any response from the server ... the connection might be corrupted !"),clearInterval(t._intervalLoadTable),t._intervalLoadTable=null,t._nbIntervalLoadTable=0,r.Error={Fatals:[{Message:"ERR_CONNECTION",Parameters:[]}]},i(r));return}clearInterval(t._intervalLoadTable);t._intervalLoadTable=null;t._nbIntervalLoadTable=0;t._lastNbLots=0;r.Records=t._rows;t._rows=[];i(r)},200)}}return this.info("Retrieving content of the table '"+n+"' ..."),this._rows=[],this._nbLots=0,new Promise((i,r)=>{$.connection.databaseHub.server.loadTable(n).done(t(this,i)).fail(r)})}async executeRequest(n,t,i,r,u,f){return this.IsDebug&&this.debug("Executing the request: ["+n+"] => { Label = '"+String.JSONStringify(t)+"', Table = '"+i+"', Action = '"+r+"', Record = "+String.JSONStringify(u)+", Identity = "+String.JSONStringify(f)+"} ..."),new Promise((e,o)=>{$.connection.databaseHub.server.executeRequest(n,t,i,r,u,f).done(e).fail(o)})}async executeTransaction(n,t,i,r){return this.IsDebug&&this.debug("Executing the transaction: ["+n+"] => { Label = '"+String.JSONStringify(t)+"', Transaction = '"+String.JSONStringify(i)+"'} ..."),new Promise((u,f)=>{$.connection.databaseHub.server.executeTransaction(n,t,i,r).done(u).fail(f)})}async executeService(n,t,i,r){return this.IsDebug&&this.debug("Executing the service: { Service = '"+n+"', Record = "+String.JSONStringify(t)+", Identity = "+String.JSONStringify(i)+", Synchronous = "+r+"} ..."),new Promise((u,f)=>{$.connection.databaseHub.server.executeService(n,t,i,r).done(u).fail(f)})}loadTableFromServer(n,t){this.IsVerboseAll&&this.verbose("Loading data for the table '"+n+"' : "+String.JSONStringify(t));for(let n of Array.toIterable(t))this._rows.push(n);this._nbLots++}async beginNotification(n,t){if(this._status!=="ReadyToSynchronize")for(let i in this._listeners)this._listeners[i].beginNotification&&(this.debug("Notify the listener '"+i+"' for the beginning of notification ("+n.toString()+", "+String.JSONStringify(t)+")"),await this._listeners[i].beginNotification(n,t))}async notify(n,t,i,r){if(this._status!=="ReadyToSynchronize")for(let u in this._listeners)if(this._listeners[u].notify){this.debug("Notify the listener '"+u+"' about an update from the user '"+n+"' for ("+String.JSONStringify(t)+", '"+i+"', "+String.JSONStringify(r));for(let f=0;f<r.length;f++)await this._listeners[u].notify(n,t,i,r[f].table,r[f].record)}}async endNotification(n,t){if(this._status!=="ReadyToSynchronize")for(let i in this._listeners)this._listeners[i].endNotification&&(this.debug("Notify the listener '"+i+"' for the ending of notification ("+n.toString()+", "+String.JSONStringify(t)+")"),await this._listeners[i].endNotification(n,t))}async acknowledgeRequest(n,t,i,r,u,f,e){for(let o in this._listeners)this._listeners[o].acknowledgeRequest&&(this.debug("Notify the listener '"+o+"' about an acknowledge from the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+") with error ("+String.JSONStringify(e)+")"),await this._listeners[o].acknowledgeRequest(n,t,i,r,u,f,e))}async acknowledgeTransaction(n,t,i,r){for(let u in this._listeners)this._listeners[u].acknowledgeTransaction&&(this.debug("Notify the listener '"+u+"' about an acknowledge from the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+") with error ("+String.JSONStringify(r)+")"),await this._listeners[u].acknowledgeTransaction(n,t,i,r))}async acknowledgeService(n,t,i,r,u){for(let f in this._listeners)this._listeners[f].acknowledgeService&&(this.debug("Notify the listener '"+f+"' about an acknowledge from the service '"+t+"' for ('"+n+"', "+String.JSONStringify(i)+", "+String.JSONStringify(r)+") => "+String.JSONStringify(u)),await this._listeners[f].acknowledgeService(n,t,i,r,u))}async start(){function n(n){return new Promise((t,i)=>{let r=!0;try{n.executeEvent()}catch(u){n.exception("Exception on handling events from server",u);r=!1}setTimeout(r?t:i,100)})}if(this._status!=="Started"&&this._status!=="Starting"&&this._status!=="ReadyToSynchronize"){let t=this._status;await this.updateStatus("Starting");await new Promise((n,t)=>{$.connection.hub.start().done(n).fail(t)}).then(()=>{await this.updateStatus(t==="NotInitialized"?"Started":"ReadyToSynchronize"),setTimeout(()=>{this.info("Starting thread to handle events from server in asynchronous mode ...");for(;;)await n(this).then(()=>{}).catch(()=>{})},this._timeoutDelay*1e3)})}}async synchronize(){this._status==="ReadyToSynchronize"&&await this.updateStatus("Started")}async stop(n){(n!==null&&n!==undefined&&n===!0||this.IsRunning&&this._status!=="Stopping")&&(await this.updateStatus("Stopping"),await new Promise((n,t)=>{let i=$.connection.hub.stop();i.done?i.done(n).fail(t):n()}).then(()=>Hub.Instance.updateStatus("Stopped")))}addListener(n,t){this._listeners[n]=t;this.debug("Listener '"+n+"' added")}removeListener(n){delete this._listeners[n];this.debug("Listener '"+n+"' removed")}async executeEvent(){if(this._events.length===0||this._eventBlocked)return!1;try{let n=this._events[0];this._events.splice(0,1);switch(n[0]){case"beginNotification":await this.beginNotification(...n[1]);break;case"notify":await this.notify(...n[1]);break;case"endNotification":await this.endNotification(...n[1]);break;case"acknowledgeRequest":await this.acknowledgeRequest(...n[1]);break;case"acknowledgeTransaction":await this.acknowledgeTransaction(...n[1]);break;case"acknowledgeService":await this.acknowledgeService(...n[1])}}catch(n){this.exception("Exception on executing an event from the server",n)}return!0}pushEvent(n,...t){this._events.push([n,t])}blockEvents(){this.debug("Blocking handling notifications from the server ...");this._eventBlocked=!0}unblockEvents(){this.debug("Unblocking notifications from the server ...");this._eventBlocked=!1}constructor(){super("HUB");this._status="NotInitialized";this._listeners={};this._timeoutPing=null;this._nbLots=0;this._lastNbLots=0;this._rows=[];this._nbIntervalLoadTable=0;this._intervalLoadTable=null;this._eventBlocked=!1;this._events=[];this._timeoutDelay=2;Logger.Instance.status(this._status)}static get Instance(){return this._instance||(this._instance=new Hub),this._instance}}$.connection.databaseHub.client.loadTable=function(n,t){Hub.Instance.loadTableFromServer(n,t)};$.connection.databaseHub.client.beginNotification=function(n,t){Hub.Instance.pushEvent("beginNotification",n,t)};$.connection.databaseHub.client.notify=function(n,t,i,r){Hub.Instance.pushEvent("notify",n,t,i,r)};$.connection.databaseHub.client.endNotification=function(n,t){Hub.Instance.pushEvent("endNotification",n,t)};$.connection.databaseHub.client.acknowledgeRequest=function(n,t,i,r,u,f,e){Hub.Instance.pushEvent("acknowledgeRequest",n,t,i,r,u,f,e)};$.connection.databaseHub.client.acknowledgeTransaction=function(n,t,i,r){Hub.Instance.pushEvent("acknowledgeTransaction",n,t,i,r)};$.connection.databaseHub.client.acknowledgeService=function(n,t,i,r,u){Hub.Instance.pushEvent("acknowledgeService",n,t,i,r,u)};$.connection.databaseHub.client.stop=function(){Logger.Instance.info("HUB","Stop");$.connection.hub.stop()};$.connection.databaseHub.client.ping=function(){Logger.Instance.info("HUB","Ping");Hub.Instance.ping()};$.connection.hub.reconnecting(function(){Hub.Instance.debug("Reconnecting ...");Hub.Instance.updateStatus("Starting")});$.connection.hub.reconnected(function(){Hub.Instance.debug("Reconnected!");Hub.Instance.updateStatus("ReadyToSynchronize")});$.connection.hub.disconnected(function(){Hub.Instance.debug("Disconnected!");Hub.Instance.updateStatus("Stopped");$.connection.hub.lastError&&Hub.Instance.warn("Disconnected. Reason: "+$.connection.hub.lastError.message)});class DSRecord{static Clone(n,t){if(n===undefined||n===null)return null;t=t!==null&&t!==undefined&&t===!0;let i={};for(let r in n)if(r!=="_subLists"&&r!=="_parent"&&r!=="_list"&&r!=="_foreignKeys"){let u=n[r];if(u===undefined&&(u=null),u===null){i[r]=null;continue}if(typeof u=="string"||typeof u=="number"||typeof u=="boolean"||typeof u=="function"){i[r]=u;continue}if(u instanceof Date){i[r]=new Date(u);continue}if(u instanceof moment){i[r]=new moment(u);continue}if(Array.isArray(u)){i[r]=[];for(let n in u)i[r][n]=DSRecord.Clone(u[n],t);continue}i[r]=DSRecord.Clone(u,t)}if(n._list!==null&&n._list!==undefined&&(i._list=n._list),n._parent!==null&&n._parent!==undefined&&(i._parent=n._parent),i=List.ListRecord.SetExtendedFields(n,i),n._subLists===null||n._subLists===undefined)return i;for(let r in i._subLists){let u=i._subLists[r];if(u!==null&&u!==undefined&&(u.composition||t)){let f=n[r];u.values=[];for(let n in f){let r=DSRecord.Clone(f[n],t);r!==null&&r!==undefined&&(r._parent=i,r._list=u,u.values[n]=r)}}}return i}static IsEqualValue(n,t){if((n===undefined||String.isEmptyOrWhiteSpaces(n))&&(n=null),(t===undefined||String.isEmptyOrWhiteSpaces(t))&&(t=null),n===null&&t===null)return!0;if(n===null||t===null)return!1;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof value=="function")return n===t;if(n instanceof Date&&t instanceof Date)return n.toString()===t.toString();if(n instanceof Date||t instanceof Date)return!1;if(n instanceof moment&&t instanceof moment)return Dates.Compare(n,t)===0;if(n instanceof moment||t instanceof moment)return!1;if(Array.isArray(n)&&Array.isArray(t)){if(n.length!==t.length)return!1;for(let i in n)if(!DSRecord.IsEqual(n[i],t[i]))return!1;return!0}return Array.isArray(n)||Array.isArray(t)?!1:null}static IsEqual(n,t){if((n===undefined||n===null)&&(t===undefined||t===null))return!0;if(n===undefined||n===null||t===undefined||t===null)return!1;for(let n in n)if(!n.startsWith("_")&&!Object.prototype.hasOwnProperty.call(t,n))return!1;for(let t in t)if(!t.startsWith("_")&&!Object.prototype.hasOwnProperty.call(n,t))return!1;for(let i in n)if(!i.startsWith("_")){let r=n[i],u=t[i],f=DSRecord.IsEqualValue(r,u);if(f!==!0&&(f===!1||!DSRecord.IsEqual(r,u)))return!1}if((n._subLists===null||n._subLists===undefined)&&(t._subLists===null||t._subLists===undefined))return!0;if((n._subLists===null||n._subLists===undefined)&&!(t._subLists===null||t._subLists===undefined)||!(n._subLists===null||n._subLists===undefined)&&(t._subLists===null||t._subLists===undefined))return!1;for(let i in n._subLists)if(!(n._subLists[i]===null||n._subLists[i]===undefined)&&(t._subLists[i]===null||t._subLists[i]===undefined)||(n._subLists[i]===null||n._subLists[i]===undefined)&&!(t._subLists[i]===null||t._subLists[i]===undefined))return!1;for(let i in t._subLists)if(!(n._subLists[i]===null||n._subLists[i]===undefined)&&(t._subLists[i]===null||t._subLists[i]===undefined)||(n._subLists[i]===null||n._subLists[i]===undefined)&&!(t._subLists[i]===null||t._subLists[i]===undefined))return!1;for(let i in n._subLists){if(n._subLists[i].composition!==t._subLists[i].composition)return!1;if(n._subLists[i].composition){let r=n[i],u=t[i];if(!DSRecord.IsEqual(r,u))return!1}}return!0}}class DSColumn extends LoggerBaseObject{get IsKey(){for(let n of this._controls)if(n.Type==="Key")return!0;return!1}get IsEmail(){for(let n of this._controls)if(n.Type==="Email")return!0;return!1}get ForeignKey(){for(let n of this._constraints)if(n.Type==="ForeignKey")return n;return null}get Unique(){for(let n of this._constraints)if(n.Type==="Unique")return n;return null}get Indexes(){let n=null;for(let t of this._constraints)t.Type==="Index"&&(n===null&&(n=[]),n.push(t));return n}get Typeof(){switch(this._type){case"Int32":case"Decimal":case"Double":return"number";case"Boolean":return"boolean";case"String":return"string"}return this._type}get DatetimeFormat(){if(this._type!=="DateTime")return null;for(let n of this._formats)if(n.Type==="DateTime")return n.Format;return null}get StringFormat(){if(this._type!=="String")return null;for(let n of this._formats)if(n.Type==="Mask")return n.Mask;return null}get StringMaxLength(){if(this._type!=="String")return null;for(let n of this._controls)if(n.Type==="String")return n.MaxLength;return null}get Field(){return this._field}get Property(){return this._property}get DefaultValue(){return this._defaultValue}get Formats(){return this._formats}get Controls(){return this._controls}get Constraints(){return this._constraints}get IsNullable(){return this._isNullable}get IsRequired(){if(!this._isNullable)return!0;for(let n of this._controls)if(n.Type==="Required")return!0;return!1}get Type(){return this._type}get PathEnumerable(){let t=this._enumerable.Area,i=this._enumerable.Name,n="";return String.isEmptyOrWhiteSpaces(t)||(n+=t+"/"),String.isEmptyOrWhiteSpaces(i)||(n+=i+"/"),n}get Digit(){for(let n of this._controls)if(n.Type==="Decimal")return new Digits.Decimal(n.NbDigitsBefore,n.NbDigitsAfter);return this._type==="Int32"?new Digits.Decimal(9):new Digits.Decimal(6,3)}get Unit(){for(let n of this._controls)if(n.Type==="Decimal")return n.Unit;return null}hasSameStructure(n){if(this._isNullable!==n._isNullable||this._type!==n._type)return!1;for(let t in this._enumerable)if(t!=="Name"&&t!=="Area"&&(n._enumerable[t]===null||n._enumerable[t]===undefined))return!1;for(let t in n._enumerable)if(t!=="Name"&&t!=="Area"&&(this._enumerable[t]===null||this._enumerable[t]===undefined))return!1;for(let t in this._enumerable)if(t!=="Name"&&t!=="Area"&&this._enumerable[t].Label!==n._enumerable[t].Label)return!1;return!0}convertType(n,t,i){if(i===undefined&&(i=!0),(n===undefined||typeof n=="string"&&n==="")&&(n=null),!this._isNullable&&i&&n===null)return this.error("The property '"+this._property+"' can't be null"),t.addField(this._property,"ERR_FIELD_REQUIRED",["{"+this._field+"}"]),n;if(n===null)return n;if(typeof n=="string"){if(n=n.trim(),this.Typeof==="string")return String.internal(n)}else if(typeof n===this.Typeof)return n;let r=null,u=null;switch(this._type){case"Int32":if(typeof n=="boolean")return n?1:0;if(typeof n=="string"){if(n.trim()==="")return 0;if(u=String.parseInt(n),!isNaN(u))return u}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n;case"Decimal":case"Double":if(typeof n=="boolean")return n?1:0;if(typeof n=="string"){if(n.trim()==="")return 0;if(u=String.parseFloat(n),!isNaN(u))return u}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n;case"Boolean":return typeof n=="string"?n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1":typeof n=="number"?n!==0:(this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n);case"String":return String.internal(n.toString().trim());case"Enum":if(typeof n=="number"&&this._enumerable[n]!==undefined)return n;if(typeof n=="string"){if(n!=="Name"&&n!=="Area"&&this._enumerable[n]!==undefined){let t=String.parseInt(n);return isNaN(t)?n:t}for(let t in this._enumerable)if(t!=="Name"&&t!=="Area"&&this._enumerable[t]!==null&&this._enumerable[t]!==undefined&&(!String.isEmptyOrWhiteSpaces(this._enumerable[t].Label)&&this._enumerable[t].Label.trim().toUpperCase()===n.trim().toUpperCase()||!String.isEmptyOrWhiteSpaces(this._enumerable[t].Name)&&this._enumerable[t].Name.trim().toUpperCase()===n.trim().toUpperCase()))return String.parseInt(t)}return this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n;case"DateTime":return n instanceof Date&&(r=moment(n.toISOString(),moment.ISO_8601),r.isValid())?r.valueOf():n instanceof moment?n.valueOf():typeof n=="string"&&(r=moment(n,[this.DatetimeFormat,moment.ISO_8601,"YYYY/MM/DD HH:mm:ss.SSS","YYYY/MM/DD HH:mm:ss","YYYY/MM/DD HH:mm","YYYY/MM/DD","DD/MM/YYYY HH:mm:ss.SSS","DD/MM/YYYY HH:mm:ss","DD/MM/YYYY HH:mm","DD/MM/YYYY","HH:mm:ss.SSS","HH:mm:ss","HH:mm"],!0),r.isValid())?r.valueOf():(this.error("The property '"+this._property+"' ("+n+") can't be converted into '"+this._type+"'"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n);case"Byte[]":return typeof n=="string"&&n.length>32768&&(this.error("The property '"+this._property+"' ("+n.length+") can't be converted into '"+this._type+"' because the size exceeds the limit of 32Ko"),t.addField(this._property,"ERR_FIELD_FILE_TOO_LONG",["{"+this._field+"}",32])),n;default:return this.error("Type '"+this._type+"' not implemented!"),t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n}}convertFromJSON(n,t){if(!this._isNullable&&(n===null||n===undefined))return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}","null"]),n;for(let i of this._formats)try{n=i.convertFromJSON(n)}catch(i){return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n}return this.convertType(n,t)}convertToJSON(n,t){for(let i of this._formats)try{n=i.convertToJSON(n)}catch(i){return t.addField(this._property,"ERR_FIELD_BADFORMAT",["{"+this._field+"}",n.toString()]),n}return n}checkProperties(n,t){n=this.convertType(n,t);for(let i of this._controls)i.check(this,n,t);return n}getIndex(n){let t=null,i=this.Unique;i!==null&&i.match(n)&&(t=i);let r=this.Indexes;if(r!==null)for(let i of r)i.match(n)&&(t===null||t.Fields.length<i.Fields.length)&&(t=i);return t!==null?t.getIds(n):null}getValues(){let n=this.Unique;if(n!==null)return n.getValues();let t=this.Indexes;if(t!==null)for(let n of t)if(n.Fields.length===1)return n.getValues();return null}getEnumerable(n){if(this._type!=="Enum")return n===undefined?[]:n;if(n===undefined){let n=[],t=this.PathEnumerable;for(let i in this._enumerable)if(i!=="Name"&&i!=="Area"&&!String.isEmptyOrWhiteSpaces(this._enumerable[i].Label)){let r={};r.Id=String.parseInt(i);r.Label=this._enumerable[i].Label.trim().toUpperCase();r.Picture=null;r.Name=this._enumerable[i].Name;String.isEmptyOrWhiteSpaces(this._enumerable[i].Name)||(r.Picture=t+this._enumerable[i].Name+".svg");n.push(r)}return n}if(typeof n=="number"&&this._enumerable[n]!==undefined)return this._enumerable[n].Label;if(typeof n=="string"){if(n!=="Name"&&n!=="Area"&&this._enumerable[n]!==undefined)return this._enumerable[n].Label;for(let t in this._enumerable)if(t!=="Name"&&t!=="Area"&&this._enumerable[t]!==null&&this._enumerable[t]!==undefined&&!String.isEmptyOrWhiteSpaces(this._enumerable[t].Label)&&this._enumerable[t].Label.trim().toUpperCase()===n.trim().toUpperCase())return this._enumerable[t].Label.trim().toUpperCase()}if(n!==null)return n;let t={};return t.Id=null,t.Label=this._field+"_NULL",t.Picture=this.PathEnumerable+"Null.svg",t.Name="Null",t}constructor(n,t){super("DSColumn["+n+"."+t.Property+"]");this._field=t.Field;this._property=t.Property;typeof t.Type=="string"?(this._type=t.Type,this._enumerable={}):(this._type="Enum",this._enumerable=t.Type);this._isNullable=t.IsNullable;this._defaultValue=t.DefaultValue;this._formats=DSAnnotationAttribute.FactoryList(t.Formats);this._controls=DSAnnotationAttribute.FactoryList(t.Controls);this._constraints=DSAnnotationAttribute.FactoryList(t.Constraints);this.info("Structure: "+this.toString())}}class DSTable extends LoggerBaseObject{static IsEqualProperties(n,t){return((n===undefined||String.isEmptyOrWhiteSpaces(n))&&(n=null),(t===undefined||String.isEmptyOrWhiteSpaces(t))&&(t=null),n===null&&t===null)?!0:n===null||t===null?!1:n instanceof moment&&typeof t=="number"?n.valueOf()===t:typeof n=="number"&&t instanceof moment?n===t.valueOf():typeof n=="string"||typeof n=="number"||typeof n=="boolean"?n===t:n instanceof Date&&t instanceof Date?n.toString()===t.toString():n instanceof Date||t instanceof Date?!1:n instanceof moment&&t instanceof moment?n.toString()===t.toString():(n instanceof moment||t instanceof moment,!1)}get NextSequenceId(){return this._lastSequenceId++}get Name(){return this._name}get LotSize(){return this._maxLotSize}get NewRow(){let n={};for(let t of Array.toIterable(this._columns))n[t.Property]=t.DefaultValue;return n._table=this._name,n}updateUniqueAndIndexValues(){if(this._columnUnique.length!==0||this._columnIndex.length!==0){for(let n=0;n<this._records.length;n++)if(!this._records[n][this._indexDeleted]){let t=this.getRow(null,this._records[n],this._identities[n]);for(let n of Array.toIterable(this._columnUnique))n.addValue(t);for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.addValue(t)}if(this.IsVerboseAll){for(let n in this._columnUnique)this.verbose("List of unique values for the column '"+this._columns[n].Property+"' = "+this._columnUnique[n].toListValues());for(let n in this._columnIndex)for(let t of this._columnIndex[n])this.verbose("List of indexed values for the column '"+this._columns[n].Property+"' = "+t.toListValues())}}}updateForeignKeys(n){if(this._columnForeign===null||n===!0){this.info("Declaring foreign key of the table '"+this._name+"' ...");try{this._columnForeign=[];let n=!1;for(let t=0;t<this._columns.length;t++){let i=this._columns[t].ForeignKey;i!==null&&(this.debug("The column '"+this._columns[t].Property+"' is a foreign key on the table '"+i.Table+"'"),this._database.Tables[i.Table]===null||this._database.Tables[i.Table]===undefined?(this.error("The table '"+i.Table+"' doesn't exist in the schema"),n=!1):this._columnForeign.push({index:t,table:this._database.Tables[i.Table]}))}if(n){this.error("Some errors occurs ...");this._columnForeign=undefined;return}this.info(this._columnForeign.length+" foreign keys are declared")}catch(t){this.exception("An exception occurs on declaring foreign key of the table '"+this._name+"'",t);this._columnForeign=undefined}}}getForeignKeys(){let n={};if(this._columnForeign===null)return n;for(let t of Array.toIterable(this._columnForeign))n[this._columns[t.index].Property]=t.table._name;return n}hasSameStructure(n){if(this._columns.length!==n._columns.length)return!1;let i={},r={},t=null;for(t=0;t<this._columns.length;t++)i[this._columns[t].Property]=this._columns[t],r[n._columns[t].Property]=n._columns[t];for(let n in i)if(r[n]===null||r[n]===undefined)return!1;for(let n in r)if(i[n]===null||i[n]===undefined)return!1;for(let n in i)if(!i[n].hasSameStructure(r[n]))return!1;return!0}setDatabase(n){this._database=n}async setTable(n,t){function*r(i,r){i._lastSequenceId=1;i._records=[];i._identities=[];i._identitiesByServerId=[];i._identitiesByClientId=[];yield!0;try{let u=0,e=!1,f=new Errors;for(let t=0;t<n.length;t++){for(i._records[t]=[],u=0;u<i._columns.length;u++){f.clear();let r=i._columns[u].convertFromJSON(n[t][u],f);f.HasError&&(i.error("["+t+"]: Conversion of the value '"+n[t][u].toString()+"' of the column '"+i._columns[u].Property+"' in the record '"+String.JSONStringify(n[t])+"' has failed"),e=!0);i._records[t][u]=r}i._records[t][i._indexTick]=n[t][i._indexTick];i._records[t][i._indexDeleted]=n[t][i._indexDeleted];n[i._indexReplayClientId]!==null&&i._indexReplayClientId!==undefined&&(i._replayServerIds[n[i._indexReplayClientId]]=i._records[t][i._indexKey]);let r=[];r[0]=t;r[1]=i.NextSequenceId;u=2;for(let n=0;n<i._columnForeign.length;u++,n++)i._columnForeign[n].table.getIdentity(r,u,i._records[t][i._columnForeign[n].index]);if(i.IsVerbose){let u=n.length<100||t<20||t>n.length-20||i.IsVerboseAll;u&&i.debug("["+t+"]: Row = "+String.JSONStringify(i._records[t])+", Identity = "+String.JSONStringify(r));u||t!==20||i.debug("...")}let o=i._records[t][i._indexKey],s=r[1];i.updateIdentity(o,s);i._identities[t]=r;i._identitiesByServerId[o]=r;i._identitiesByClientId[s]=r;yield!0}return(t&&t>0&&i._lastSequenceId<t+1&&(i._lastSequenceId=t+1),i.info("The sequence Id starts at "+i._lastSequenceId),e)?(i.error("Errors occurs on loading table ..."),r.value=!1,!1):(i.info("Table loaded with "+i._records.length+" records"),!0)}catch(u){return i.exception("An exception occurs on loading the table '"+i._name+"'",u),r.value=!1,!1}}if(this.info("Loading table ..."),this._indexKey===undefined||this._indexTick===undefined||this._indexDeleted===undefined||this._columnForeign===undefined)return this.error("The initialization has failed!"),!1;let i={value:!0};return await GUI.Box.Progress.Thread(r(this,i),1e4,!1,!1),i.value}getIdentity(n,t,i){if(i===null||i===undefined){n[t]=null;return}let r=this._identitiesByServerId[i];if(r!==undefined){n[t]=r[1];return}let u={identity:n,index:t};n[t]=null;this.IsVerbose&&this.verbose("The identity '"+i+"' is not yet known by the table ... queueing ("+String.JSONStringify(u)+")!");this._notYetKnown[i]===undefined&&(this._notYetKnown[i]=[]);this._notYetKnown[i].push(u)}updateIdentity(n,t){if(this._notYetKnown[n]!==undefined){this.IsVerbose&&this.verbose(this._notYetKnown[n].length+" identities of the serverId ("+n+") from foreign key were waiting for the clientId ("+t+")");for(let i=0;i<this._notYetKnown[n].length;i++){let r=this._notYetKnown[n][i];r!==null&&r!==undefined&&(this.IsVerbose&&this.verbose(String.JSONStringify(r.identity)+" => Ids["+r.index+"] ="+t),r.identity[r.index]=t)}delete this._notYetKnown[n]}}updateServerId(n,t,i){let r=!0;for(let u=0;u<this._columnForeign.length;u++)if(this._columnForeign[u].table.Name===n){r&&(this.IsDebug&&this.debug("Updating id refering the foreign key ('"+n+"', ["+t+"]) with the serverId ["+i+"] ..."),r=!1);let f=0;for(let n=0;n<this._identities.length;n++)this._identities[n][u+2]===t&&(this._records[n][this._columnForeign[u].index]=i,f++);this.IsVerboseAll&&this.verbose(f+" Ids updated")}}updateClientId(n,t,i){let r=!0;for(let u=0;u<this._columnForeign.length;u++)if(this._columnForeign[u].table.Name===n){r&&(this.IsDebug&&this.debug("Updating id refering the foreign key ('"+n+"', ["+t+"]) with the clientId ["+i+"] ..."),r=!1);let f=0;for(let n=0;n<this._identities.length;n++)if(this._identities[n][u+2]===t){let r=this.getRow(n);this._identities[n][u+2]=i;f++;this._database.eventOnUpdate(this._name,this._identities[n][1],r)}this.IsVerboseAll&&this.verbose(f+" Ids updated")}}getRow(n,t,i){n!==null&&n!==undefined&&(t=this._records[n],i=this._identities[n]);let u={},r=0;for(r=0;r<this._columns.length;r++)u[this._columns[r].Property]=t[r]!==null&&(this._columns[r].Typeof==="DateTime"||t[r]instanceof moment)?moment(t[r]):t[r]!==null&&t[r]instanceof Date?moment(t[r].toISOString(),moment.ISO_8601):t[r];if(u._tick=t[r++],u._deleted=t[r++],u._table=this._name,i!==null&&i!==undefined){r=0;u._rowIndex=i[r++];u[this._columns[this._indexKey].Property]=i[r++];for(let n=0;n<this._columnForeign.length;n++,r++)u[this._columns[this._columnForeign[n].index].Property]=i[r]}return u}getTable(){try{let n=[];for(let t=0;t<this._records.length;t++)this._records[t][this._indexDeleted]||n.push(this.getRow(t));return n}catch(n){return this.exception("An exception occurs on reading data from the table '"+this._name+"'",n),[]}}each(n){if(n!==null&&n!==undefined)for(let t=0;t<this._records.length;t++)this._records[t][this._indexDeleted]||n(this.getRow(t))}get Sequence(){for(let n=0;n<this._columns.length;n++){let t=this._columns[n];if(t!==null&&t!==undefined)for(let n=0;n<t.Formats.length;n++){let i=t.Formats[n];if(i!==null&&i!==undefined&&i.Type==="Sequence")return{Property:t.Property,Key:i.Key,Length:i.Length}}}return null}getColumn(n){let t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t]}getColumnLabel(n){let t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].Field}getDefaultValue(n){let t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].DefaultValue}getHistoryValue(n,t){let s=this._columnsByName[n];if(s===undefined||s===null)return null;let u=this._database.Tables["History"+this._name];if(u===null||u===undefined)return null;let f=u._columnsByName[n];if(f===null||f===undefined)return null;let e=u._columns[f];if(e===null||e===undefined)return null;let o=e.ForeignKey;if(o===null||o===undefined)return null;let i=this._database.Tables[o.Table];if(i===null||i===undefined)return null;let r=0;for(r=0;r<i._columnForeign.length;r++)if(i._columns[i._columnForeign[r].index].Property==="HistoryId")break;if(r>=i._columnForeign.length)return null;r+=2;let h=-1;for(let n=i._identitiesByClientId.length-1;n>=0;n--){let u=i._identitiesByClientId[n];if(u!==null&&u!==undefined&&u[0]!==null&&u[0]!==undefined&&!i._records[u[0]][i._indexDeleted]&&u[r]===t){h=n;break}}return{Id:t,HistoryId:h}}getLastHistoryId(n){let i=this._columnsByName.HistoryId;if(i===null||i===undefined)return null;let t=0;for(t=0;t<this._columnForeign.length;t++)if(this._columns[this._columnForeign[t].index].Property==="HistoryId")break;if(t>=this._columnForeign.length)return null;t+=2;for(let i=this._identitiesByClientId.length-1;i>=0;i--){let r=this._identitiesByClientId[i];if(r!==null&&r!==undefined&&r[0]!==null&&r[0]!==undefined&&!this._records[r[0]][this._indexDeleted]&&r[t]===n)return i}return null}updateHistoryProperties(n){if(this._hasCopy===!1)return n;this._hasCopy=!1;for(let t=0;t<this._columns.length;t++)if(this._columns[t].Property.startsWith("Copy")){let r=this._columns[t],i=this._columns[this._columnsByName[r.Property.substr(4)]];if(i!==null&&i!==undefined){let u=r.ForeignKey;if(u!==null&&u.Table.startsWith("History")){let f=i.ForeignKey;if(f!==null&&u.Table.substr(7)===f.Table){if(this._hasCopy=!0,n[i.Property]===null||n[i.Property]===undefined){n[i.Property]=null;n[r.Property]=null;continue}typeof n[i.Property]!="string"||isNaN(parseInt(n[i.Property]))||(n[i.Property]=parseInt(n[i.Property]));let e=this._database.getLastHistoryId(f.Table,n[i.Property]);if(n[r.Property]!==e)if(n[r.Property]===null||n[r.Property]===undefined)n[r.Property]=e;else{let t=this._database.getRowById(u.Table,n[r.Property]);(t===null||t.HistoryId!==n[i.Property])&&(n[r.Property]=e)}}}}}return n}getIndex(n,t){let i=this._columnsByName[n];return i===undefined||i===null?[]:this._columns[i].getIndex(t)}getValues(n){let i=this._columnsByName[n];if(i===undefined||i===null)return[];let t=this._columns[i].getValues();if(t!==null)return t;let r={};t=[];for(let n of Array.toIterable(this._records))if(!n[this._indexDeleted]){let u=n[i];u!==null&&u!==undefined&&r[u]===undefined&&(r[u]=!0,t.push(u))}return t}getEnumerable(n,t){let i=this._columnsByName[n];return i===undefined||i===null?[]:this._columns[i].getEnumerable(t)}getDatetimeFormat(n){let t=this._columnsByName[n];return t===undefined||t===null?null:this._columns[t].DatetimeFormat}convertValue(n,t,i){i===undefined&&(i=!0);let r=this._columnsByName[n];if(r===undefined||r===null)return t;let f=new Errors,u=this._columns[r].convertType(t,f,i);return f.HasError?t:u===null?null:this._columns[r].Typeof==="DateTime"?moment(u):u}checkProperties(n,t){for(let i=0;i<this._columns.length;i++){let r=this._columns[i];if(n[r.Property]===undefined){this.error("The property '"+r.Property+"' is missing into the record");t.addField(r.Property,"ERR_FIELD_MISSING",["{"+r.Field+"}"]);n[r.Property]=null;continue}let u=r.checkProperties(n[r.Property],t);t.HasError||r.Typeof!=="DateTime"||typeof u!="number"||(u=moment(u));n[r.Property]=u}return n}getRowById(n){let t=this._identitiesByClientId[n];return t===null||t===undefined?null:this.getRow(t[0])}getClientIdByServerId(n){let t=this._identitiesByServerId[n];return t===null||t===undefined?null:t[1]}getServerIdByClientId(n){let t=this._identitiesByClientId[n];return t===null||t===undefined?null:this._records[t[0]][this._indexKey]}getRecordToServer(n){let i={},t=new Errors;for(let r=0;r<this._columns.length;r++)i[this._columns[r].Property]=this._columns[r].convertToJSON(n[r],t);return t.HasError&&this.warn("Some errors occur during converting the record to a JSON object ("+t.toString()+")"),i}getIdentityToServer(n){let t={};t._rowIndex=n[0];t[this._columns[this._indexKey].Property]=n[1];for(let i=0,r=2;i<this._columnForeign.length;i++,r++)t[this._columns[this._columnForeign[i].index].Property]=n[r];return t}addFromClient(n,t){try{this.info("Adding the record "+String.JSONStringify(n)+" from the client ...");let r=[],u=null,i=null;for(i=0;i<this._columns.length;i++){if(u=this._columns[i],n[u.Property]===undefined){this.error("The property '"+u.Property+"' is missing into the record");t.addField(u.Property,"ERR_FIELD_MISSING",["{"+u.Field+"}"]);r[i]=null;continue}r[i]=u.checkProperties(n[u.Property],t)}r[this._indexKey]!==-1&&(this.error("A new record must have an Id equals to -1"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",r[this._indexKey].toString()]));r[this._indexTick]=null;r[this._indexDeleted]=!1;this.IsVerboseAll&&this.verbose("The new row containing clientId is "+String.JSONStringify(r));for(i in this._columnUnique){let n=this._columnUnique[i];(u=this._columns[i],n.existValue(this.getRow(null,r)))&&(this.error("The value '"+r[i]+"' already exists for the column '"+u.Property+"'"),t.addField(u.Property,n.Error,["{"+u.Field+"}"]))}let f=[];i=0;f[i++]=-1;f[i++]=-1;for(let n=0;n<this._columnForeign.length;n++,i++){let e=this._columnForeign[n];u=this._columns[e.index];let o=r[e.index];if(o===null||o===undefined){f[i]=null;continue}let s=e.table._identitiesByClientId[o];if(s===undefined){this.error("The index '"+o+"' (client) of the column '"+u.Property+"' doesn't exist into the table '"+this._columnForeign[n].table._name+"'");t.addField(u.Property,u.ForeignKey.Error);f[i]=null;continue}f[i]=o;r[e.index]=e.table._records[s[0]][e.table._indexKey]}if(t.HasError)return this.error("Unable to add the record due to some errors ("+t.toString()+")"),null;f[0]=this._records.length;f[1]=this.NextSequenceId;this._records.push(r);this._identities.push(f);this._identitiesByClientId[f[1]]=f;let e=this.getRow(null,r,f);for(let n of Array.toIterable(this._columnUnique))n.addValue(e);for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.addValue(e);return(this.IsVerboseAll&&this.verbose("The row containing serverId "+String.JSONStringify(r)+" and clientId "+String.JSONStringify(f)+" is added"),!this._database.send(this._name,"Create",this.getRecordToServer(r),this.getIdentityToServer(f),r[this._indexTick]))?(t.addFatal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnCreate(this._name,f[1]),e)}catch(i){return this.exception("An exception occurs on adding data into the table '"+this._name+"'",i),t.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}updateFromClient(n,t,i){try{this.info("Updating the record "+String.JSONStringify(n)+" to "+String.JSONStringify(t)+" from the client ...");let u=[],f=[],e=null,r=null;for(r=0;r<this._columns.length;r++){if(e=this._columns[r],n[e.Property]===undefined||t[e.Property]===undefined){this.error("The property '"+e.Property+"' is missing into the record");i.addField(e.Property,"ERR_FIELD_MISSING",["{"+e.Field+"}"]);u[r]=null;f[r]=null;continue}u[r]=e.convertType(n[e.Property],i);f[r]=e.checkProperties(t[e.Property],i)}if((u[this._indexKey]<0||f[this._indexKey]<0)&&(this.error("An existing record must have an Id greater or equal to 0"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",f[this._indexKey].toString()])),i.HasError||u[this._indexKey]===f[this._indexKey]||(this.error("New and old records must represent the same record!"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",f[this._indexKey].toString()])),i.HasError)return this.error("Unable to update the record due to some errors ("+i.toString()+")"),null;u[this._indexTick]=n._tick!==undefined?n._tick:null;u[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1;f[this._indexTick]=u[this._indexTick];f[this._indexDeleted]=u[this._indexDeleted];(u[this._indexDeleted]||f[this._indexDeleted])&&(this.error("Unable to update a record already deleted!"),i.addGlobal("ERR_RECORD_DELETED"));this.IsVerboseAll&&this.verbose("The rows containing clientId are old:"+String.JSONStringify(u)+" and new:"+String.JSONStringify(f));let o=this.getRowById(u[this._indexKey]);if(o===null||o===undefined)this.error("New and old records must represent an existing record!"),i.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",u[this._indexKey].toString()]);else{let n=!1;for(r=0;r<this._columns.length;r++)if(!DSTable.IsEqualProperties(u[r],o[this._columns[r].Property])){this.error("Old ("+String.JSONStringify(u)+") and existing ("+String.JSONStringify(o)+") records must represent the same record ("+this._columns[r].Property+" => old: '"+(u[r]===null?"null":u[r].toString())+"' - existing: '"+(o[this._columns[r].Property]===null?"null":o[this._columns[r].Property].toString())+"') !");i.addGlobal("ERR_RECORD_DIFFERENT");n=!0;break}n||u[this._indexTick]===o._tick&&u[this._indexDeleted]===o._deleted||(this.warn("Old ("+String.JSONStringify(u)+") and existing ("+String.JSONStringify(o)+") records must represent the same record (tick or deleted flag)!"),i.addGlobal("ERR_RECORD_DIFFERENT"))}for(r in this._columnUnique){let n=this._columnUnique[r];(e=this._columns[r],n.existValue(this.getRow(null,f)))&&(this.error("The value '"+f[r]+"' already exists for the column '"+e.Property+"'"),i.addField(e.Property,n.Error,["{"+e.Field+"}"]))}let s=this._identitiesByClientId[f[this._indexKey]],h=[];r=0;h[r++]=s[0];h[r++]=s[1];f[this._indexKey]=this._records[s[0]][this._indexKey];for(let n=0;n<this._columnForeign.length;n++,r++){let t=this._columnForeign[n];e=this._columns[t.index];let u=f[t.index];if(u===null||u===undefined){h[r]=null;continue}let o=t.table._identitiesByClientId[u];if(o===undefined){this.error("The index '"+u+"' (client) of the column '"+e.Property+"' doesn't exist into the table '"+this._columnForeign[n].table._name+"'");i.addField(e.Property,e.ForeignKey.Error);h[r]=null;continue}h[r]=u;f[t.index]=t.table._records[o[0]][t.table._indexKey]}if(i.HasError)return this.error("Unable to update the record due to some errors ("+i.toString()+")"),null;let c=this._records[h[0]],a=this.getRecordToServer(c),v=this.getIdentityToServer(s);for(r=0;r<c.length;r++)c[r]=f[r];for(r=0;r<s.length;r++)s[r]=h[r];let l=this.getRow(null,f,s);for(r in this._columnUnique){let n=this._columnUnique[r];n.isEqual(u,f)||(n.deleteValue(this.getRow(null,u)),n.addValue(l))}for(r in this._columnIndex)for(let n of this._columnIndex[r])n.isEqual(u,f)||(n.deleteValue(this.getRow(null,u)),n.addValue(l));return(this.IsVerboseAll&&this.verbose("The row containing serverId "+String.JSONStringify(c)+" and clientId "+String.JSONStringify(s)+" is updated"),!this._database.send(this._name,"Update",{New:this.getRecordToServer(f),Old:a},{New:this.getIdentityToServer(s),Old:v},f[this._indexTick]))?(i.addFatal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnUpdate(this._name,s[1],o),l)}catch(r){return this.exception("An exception occurs on updating data into the table '"+this._name+"'",r),i.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}updateFromServer(n,t){try{let l=new Errors;t!==null&&t!==undefined?this.info("Acknowledging the record "+String.JSONStringify(n)+" from the server within clientId "+String.JSONStringify(t)+" ..."):this.info("Updating the record "+String.JSONStringify(n)+" from the server ...");let i=[],s=null,r=null,e=null,o=null;for(r=0;r<this._columns.length;r++){if(s=this._columns[r],n[s.Property]===undefined){this.warn("The property '"+s.Property+"' is missing into the record");i[r]=null;continue}i[r]=s.convertFromJSON(n[s.Property],l)}if(i[this._indexTick]=n._tick!==undefined?n._tick:null,i[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1,this.IsVerboseAll&&this.verbose("The row containing serverId is "+String.JSONStringify(i)),t!==null&&t!==undefined){let r=this._identitiesByServerId[i[this._indexKey]],n=this._identitiesByClientId[t[this._columns[this._indexKey].Property]];if((r===null||r===undefined)&&n!==null&&n!==undefined)this.IsVerboseAll&&this.verbose("Acknowledging a creation ..."),this._identitiesByServerId[i[this._indexKey]]=n,this._database.updateServerId(this._name,n[1],i[this._indexKey]);else{if(n===null||n===undefined){this.warn("Identity information of the record is missing ... ignore this update!");return}if(r[0]!==n[0]){this.IsVerboseAll&&(this.verbose("Acknowledging a creation but the record has been created before this action ... Merging rows ["+r[0]+"] and ["+n[0]+"] ..."),this.verbose("Removing referencing to the clientId ["+n[1]+"] ..."));this._database.updateClientId(this._name,n[1],r[1]);for(let t of Array.toIterable(this._columnUnique))t.deleteValue(this.getRow(null,this._records[n[0]],n));for(let t of Array.toIterable(this._columnIndex))for(let t of t)t.deleteValue(this.getRow(null,this._records[n[0]],n));this.IsVerboseAll&&this.verbose("Deleting the row ["+n[0]+"] ...");this._records[n[0]][this._indexDeleted]=!0;this.IsVerboseAll&&this.verbose("The clientId ["+t[this._columns[this._indexKey].Property]+"] is replaced by ["+r[1]+"]");t[this._columns[this._indexKey].Property]=r[1];this._database.eventOnDelete(this._name,n[1])}}}let f=this._identitiesByServerId[i[this._indexKey]];if(f===null||f===undefined){this.IsVerboseAll&&this.verbose("This record is a new one ... create it!");let n=this._records.length;for(this._records.push(i),o=[],o[0]=n,o[1]=this.NextSequenceId,r=2,e=0;e<this._columnForeign.length;r++,e++)this._columnForeign[e].table.getIdentity(o,r,this._records[n][this._columnForeign[e].index]);this.IsVerboseAll&&this.verbose("["+n+"]: Row = "+String.JSONStringify(this._records[n])+", Identity = "+String.JSONStringify(o));let t=this._records[n][this._indexKey],u=o[1];if(this.updateIdentity(t,u),this._identities[n]=o,this._identitiesByServerId[t]=o,this._identitiesByClientId[u]=o,!this._records[n][this._indexDeleted]){let t=this.getRow(null,this._records[n],this._identities[n]);for(let n of Array.toIterable(this._columnUnique))n.addValue(t);for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.addValue(t)}this._records[n][this._indexDeleted]||this._database.eventOnCreate(this._name,o[1]);return}let u=this._records[f[0]];if(u[this._indexTick]!==null&&u[this._indexTick]!==undefined&&i[this._indexTick]!==null&&i[this._indexTick]!==undefined&&u[this._indexTick]>=i[this._indexTick]){this.IsDebug&&this.debug("The record stored into the table is newer than the record to update, ignore it!");return}let h=this.getRow(f[0]);for(e=0,r=2;e<this._columnForeign.length;e++,r++)this._columnForeign[e].table.getIdentity(f,r,i[this._columnForeign[e].index]);for(r in this._columnUnique){let n=this._columnUnique[r];n.isEqual(u,i)&&i[this._indexDeleted]===u[this._indexDeleted]||(n.deleteValue(this.getRow(null,u,f)),i[this._indexDeleted]||n.addValue(h))}for(r in this._columnIndex)for(let n of this._columnIndex[r])n.isEqual(u,i)&&i[this._indexDeleted]===u[this._indexDeleted]||(n.deleteValue(this.getRow(null,u,f)),i[this._indexDeleted]||n.addValue(h));let c=u[this._indexDeleted];for(r=0;r<this._columns.length;r++)u[r]=i[r];u[this._indexTick]=i[this._indexTick];u[this._indexDeleted]=i[this._indexDeleted];this.IsVerboseAll&&this.verbose("The row containing serverId "+String.JSONStringify(u)+" and clientId "+String.JSONStringify(f)+" is updated");u[this._indexDeleted]===c?c||this._database.eventOnUpdate(this._name,f[1],h):c?this._database.eventOnCreate(this._name,f[1]):this._database.eventOnDelete(this._name,f[1])}catch(i){this.exception("An exception occurs on updating data into the table '"+this._name+"'",i)}}deleteRowById(n){try{this.info("Deleting the row "+n.toString()+" from the client ...");let t=this._identitiesByClientId[n];return t===null||t===undefined?!1:this._records[t[0]][this._indexDeleted]?!1:(this._records[t[0]][this._indexDeleted]=!0,this._database.eventOnDelete(this._name,t[1]),!0)}catch(t){return this.exception("An exception occurs on deleting row "+n.toString()+" into the table '"+this._name+"'",t),!1}}deleteFromClient(n,t){try{this.info("Deleting the record "+String.JSONStringify(n)+" from the client ...");let i=[],f=null,r=null;for(r=0;r<this._columns.length;r++){if(f=this._columns[r],n[f.Property]===undefined){this.error("The property '"+f.Property+"' is missing into the record");t.addField(f.Property,"ERR_FIELD_MISSING",["{"+f.Field+"}"]);i[r]=null;continue}i[r]=f.convertType(n[f.Property],t)}i[this._indexKey]<0&&(this.error("An existing record must have an Id greater or equal to 0"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",i[this._indexKey].toString()]));i[this._indexTick]=n._tick!==undefined?n._tick:null;i[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1;i[this._indexDeleted]&&(this.error("Unable to delete a record already deleted!"),t.addGlobal("ERR_RECORD_DELETED"));this.IsVerboseAll&&this.verbose("The row containing clientId is "+String.JSONStringify(i));let u=this.getRowById(i[this._indexKey]);if((u===null||u===undefined)&&i[this._indexKey]>=0)this.error("Record must represent an existing record!"),t.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",i[this._indexKey].toString()]);else if(i[this._indexKey]>=0){let n=!1;for(r=0;r<this._columns.length;r++)if(!DSTable.IsEqualProperties(i[r],u[this._columns[r].Property])){this.error("Old ("+String.JSONStringify(i)+") and existing ("+String.JSONStringify(u)+") records must represent the same record ("+this._columns[r].Property+" => old: '"+(i[r]===null?"null":i[r].toString())+"' - existing: '"+(u[this._columns[r].Property]===null?"null":u[this._columns[r].Property].toString())+"') !");t.addGlobal("ERR_RECORD_DIFFERENT");n=!0;break}n||i[this._indexTick]===u._tick&&i[this._indexDeleted]===u._deleted||(this.error("Old ("+String.JSONStringify(i)+") and existing ("+String.JSONStringify(u)+") records must represent the same record (tick or deleted flag)!"),t.addGlobal("ERR_RECORD_DIFFERENT"))}if(t.HasError)return this.error("Unable to delete the record due to some errors ("+t.toString()+")"),null;let e=this._identitiesByClientId[i[this._indexKey]],o=this._records[e[0]],s=this.getRecordToServer(o),h=this.getIdentityToServer(e);o[this._indexDeleted]=!0;for(let n of Array.toIterable(this._columnUnique))n.deleteValue(this.getRow(null,i));for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.deleteValue(this.getRow(null,i));return(this.IsVerbose&&this.info("The row containing serverId "+String.JSONStringify(o)+" and clientId "+String.JSONStringify(e)+" is deleted"),!this._database.send(this._name,"Delete",s,h,o[this._indexTick]))?(t.addFatal("ERR_OUT_OF_MEMORY"),null):(this._database.eventOnDelete(this._name,e[1]),this.getRow(e[0]))}catch(i){return this.exception("An exception occurs on deleting data into the table '"+this._name+"'",i),t.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}executeRequest(n,t,i,r){try{if(this.info("Executing the request '"+n+"' with the record "+String.JSONStringify(t)+" from the client ..."),this._name==="User"&&n==="NewPassword"&&t!==null&&t!==undefined&&t.Id!==null&&t.Id!==undefined&&t.CustomerId!==null&&t.CustomerId!==undefined){let u=this._identitiesByClientId[t.Id],f=this._database.getServerIdByClientId("Customer",t.CustomerId);if(u!==null||u!==undefined)return this._database.send(this._name,n,{UserId:this._records[u[0]][this._indexKey],CustomerId:f},{UserId:t.Id,CustomerId:t.CustomerId},null,r)?null:(i.addFatal("ERR_OUT_OF_MEMORY"),null)}return i.addGlobal("ERR_REQUEST_UNKNOWN"),null}catch(u){return this.exception("An exception occurs on executin a request into the table '"+this._name+"'",u),i.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}rollback(n,t,i,r){let h=null;this.info("Rollbacking the request serverId:"+String.JSONStringify(t)+" clientId:"+String.JSONStringify(i)+" if and only if the tick is '"+r+"' ...");let l=t,o=i;if(n==="Update"&&t!==null&&t!==undefined&&i!==null&&i!==undefined&&(l=t.Old,o=i.Old),l===null||l===undefined||o===null||o===undefined){this.error("Unable to rollback due to a missing parameter!");return}let s=o._rowIndex,y=o[this._columns[this._indexKey].Property],f=this._identitiesByClientId[y];if(s===null||s===undefined){if(f===null||f===undefined){this.error("Unable to rollback due to a non-consitency information!");return}s=f[0]}else if(s!==f[0]){this.error("Unable to rollback due to a non-consitency information!");return}this.IsVerboseAll&&this.verbose("Rollback the row ("+s+")");let e=this._records[s];if(e===null||e===undefined){this.error("Unable to rollback due to a missing row!");return}if(e[this._indexTick]!==r){this.info("Unable to rollback the row ("+s+") because the row has been updated since sending the request");return}let u=null,a=null,c=null,v=null;switch(n){case"Create":this.IsVerboseAll&&this.verbose("Delete the row");e[this._indexDeleted]=!0;for(let n of Array.toIterable(this._columnUnique))n.deleteValue(this.getRow(null,e,f));for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.deleteValue(this.getRow(null,e,f));this._database.eventOnDelete(this._name,f[1]);break;case"Update":for(this.IsVerboseAll&&this.verbose("Restore the row"),u=0;u<this._columns.length;u++)if(l[this._columns[u].Property]===undefined){this.error("Unable to rollback due to a missing property!");return}for(u=0;u<this._columnForeign.length;u++)if(o[this._columns[this._columnForeign[u].index].Property]===undefined){this.error("Unable to rollback due to a missing identity!");return}for(a=new Errors,c=[],u=0;u<this._columns.length;u++)c[u]=this._columns[u].convertFromJSON(l[this._columns[u].Property],a);h=this.getRow(null,c,o);for(u in this._columnUnique){let n=this._columnUnique[u];n.isEqual(e,c)||(n.deleteValue(this.getRow(null,e,f)),n.addValue(h))}for(u in this._columnIndex)for(let n of this._columnIndex[u])n.isEqual(e,c)||(n.deleteValue(this.getRow(null,e,f)),n.addValue(h));for(v=this.getRow(s),u=0;u<this._columns.length;u++)e[u]=c[u];u=2;for(let n=0;n<this._columnForeign.length;u++,n++)f[u]=o[this._columns[this._columnForeign[n].index].Property];this._database.eventOnUpdate(this._name,f[1],v);break;case"Delete":this.IsVerboseAll&&this.verbose("Restore the row as undeleted");e[this._indexDeleted]=!1;h=this.getRow(null,e,f);for(let n of Array.toIterable(this._columnUnique))n.addValue(h);for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.addValue(h);this._database.eventOnCreate(this._name,f[1])}}getNewClientId(n,t,i,r){if(t===null||t===undefined)return null;let u=this._columns[n.index],f=null;if(t>=0)return(f=n.table._identitiesByServerId[t],f===undefined)?(this.error("The serverId '"+t+"' of the column '"+u.Property+"' doesn't exist into the table '"+n.table._name+"'"),r.addField(u.Property,u.ForeignKey.Error),null):f[1];if(i===null||i===undefined)return null;if(t=n.table._replayServerIds[i],t!==null&&t!==undefined&&t>=0)return(f=n.table._identitiesByServerId[t],f===undefined)?(this.error("The serverId '"+t+"' of the column '"+u.Property+"' doesn't exist into the table '"+n.table._name+"'"),r.addField(u.Property,u.ForeignKey.Error),null):f[1];let e=n.table._replayClientIds[i];return e===null||e===undefined?null:e}replayCreate(n,t,i,r){try{this.info("Replaying the creation of the record "+String.JSONStringify(n)+" ...");let f=[],o=null,u=null;for(u=0;u<this._columns.length;u++){if(o=this._columns[u],n[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");r.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);f[u]=null;continue}f[u]=o.convertFromJSON(n[o.Property],r)}f[this._indexKey]!==-1&&(this.error("A new record must have an Id equals to -1"),r.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",f[this._indexKey].toString()]));f[this._indexTick]=null;f[this._indexDeleted]=!1;this.IsVerboseAll&&this.verbose("The new row containing serverId is "+String.JSONStringify(f));for(u in this._columnUnique){let n=this._columnUnique[u];(o=this._columns[u],n.existValue(this.getRow(null,f)))&&(this.error("The value '"+f[u]+"' already exists for the column '"+o.Property+"'"),r.addField(o.Property,n.Error,["{"+o.Field+"}"]))}let e=[];u=0;e[u++]=-1;e[u++]=-1;for(let n=0;n<this._columnForeign.length;n++,u++){let i=this._columnForeign[n],o=f[i.index],s=t[this._columns[i.index].Property];e[u]=this.getNewClientId(i,o,s,r)}if(r.HasError)return null;e[0]=this._records.length;e[1]=this.NextSequenceId;this._replayClientIds[t[this._columns[this._indexKey].Property]]=e[1];this._records.push(f);this._identities.push(e);this._identitiesByClientId[e[1]]=e;let s=this.getRow(null,f,e);for(let n of Array.toIterable(this._columnUnique))n.addValue(s);for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.addValue(s);return this.IsVerboseAll&&this.verbose("The row containing serverId "+String.JSONStringify(f)+" and clientId "+String.JSONStringify(e)+" is added"),{requestId:null,table:this._name,action:"Create",record:this.getRecordToServer(f),identity:this.getIdentityToServer(e),tick:i}}catch(u){return this.exception("An exception occurs on replaying data into the table '"+this._name+"'",u),r.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}replayUpdate(n,t,i,r,u,f){try{this.info("Replaying the update of the record "+String.JSONStringify(n)+" within identities "+String.JSONStringify(t)+" to "+String.JSONStringify(i)+" within identities "+String.JSONStringify(r)+" ...");let e=null,a=null,o=null,h=[];for(e=0;e<this._columns.length;e++){if(o=this._columns[e],n[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");f.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);h[e]=null;continue}h[e]=this._columns[e].convertFromJSON(n[this._columns[e].Property],f)}h[this._indexTick]=n._tick!==undefined?n._tick:null;h[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1;h[this._indexDeleted]&&(this.error("Unable to update a record already deleted!"),f.addGlobal("ERR_RECORD_DELETED"));let g=h[this._indexKey],p=this.getNewClientId({index:this._indexKey,table:this},g,t[this._columns[this._indexKey].Property],f);if(p===null)return null;let v=this._identitiesByClientId[p];if(v===null||v===undefined)return this.error("Unable to retrieve the client Id ["+p+"] into the table"),f.addFatal("ERR_EXCEPTION_UNEXPECTED"),null;let y=[];for(y[0]=v[0],y[1]=v[1],e=2,a=0;a<this._columnForeign.length;a++,e++){let n=this._columnForeign[a],i=h[n.index],r=t[this._columns[n.index].Property];y[e]=this.getNewClientId(n,i,r,f)}if(f.HasError)return null;this.IsVerboseAll&&this.verbose("The row of the record to update is "+String.JSONStringify(h)+" with identities "+String.JSONStringify(y));let c=this.getRow(v[0]);if(c===null||c===undefined)this.error("New and old records must represent an existing record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",v[0].toString()]);else{let n=this.getRow(null,h,y),t=!1;for(e=0;e<this._columns.length;e++)if(!DSTable.IsEqualProperties(n[this._columns[e].Property],c[this._columns[e].Property])){this.error("Old ("+String.JSONStringify(n)+") and existing ("+String.JSONStringify(c)+") records must represent the same record ("+this._columns[e].Property+" => old: '"+(n[this._columns[e].Property]===null?"null":n[this._columns[e].Property].toString())+"' - existing: '"+(c[this._columns[e].Property]===null?"null":c[this._columns[e].Property].toString())+"') !");f.addGlobal("ERR_RECORD_DIFFERENT");t=!0;break}t||(n._tick===c._tick||n._tick===null||c._tick===null)&&n._deleted===c._deleted||(this.error("Old ("+String.JSONStringify(n)+") and existing ("+String.JSONStringify(c)+") records must represent the same record (tick or deleted flag)!"),f.addGlobal("ERR_RECORD_DIFFERENT"))}if(f.HasError)return null;let s=[];for(e=0;e<this._columns.length;e++){if(o=this._columns[e],i[o.Property]===undefined){this.error("The property '"+o.Property+"' is missing into the record");f.addField(o.Property,"ERR_FIELD_MISSING",["{"+o.Field+"}"]);s[e]=null;continue}s[e]=o.convertFromJSON(i[o.Property],f)}s[this._indexTick]=i._tick!==undefined?i._tick:null;s[this._indexDeleted]=i._deleted!==undefined?i._deleted:!1;s[this._indexDeleted]&&(this.error("Unable to update a record already deleted!"),f.addGlobal("ERR_RECORD_DELETED"));let k=s[this._indexKey];g!==k&&(this.error("New and old records must represent the same record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",k.toString()]));let d=this.getNewClientId({index:this._indexKey,table:this},k,r[this._columns[this._indexKey].Property],f);if(d===null)return null;p!==d&&(this.error("New and old records must represent the same record!"),f.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",d.toString()]));let l=[];for(l[0]=v[0],l[1]=v[1],e=2,a=0;a<this._columnForeign.length;a++,e++){let n=this._columnForeign[a],t=s[n.index],i=r[this._columns[n.index].Property];l[e]=this.getNewClientId(n,t,i,f)}if(f.HasError)return null;this.IsVerboseAll&&this.verbose("The new row of the record is "+String.JSONStringify(s)+" with identities "+String.JSONStringify(l));for(e in this._columnUnique){let n=this._columnUnique[e];(o=this._columns[e],n.existValue(this.getRow(null,s,l)))&&(this.error("The value '"+s[e]+"' already exists for the column '"+o.Property+"'"),f.addField(o.Property,n.Error,["{"+o.Field+"}"]))}if(f.HasError)return null;let w=this._records[l[0]],b=this._identities[l[0]];for(n=this.getRow(null,w,b),e=0;e<w.length;e++)w[e]=s[e];for(e=0;e<b.length;e++)b[e]=l[e];i=this.getRow(null,w,b);for(e in this._columnUnique){let t=this._columnUnique[e];t.isEqual(h,s)||(t.deleteValue(n),t.addValue(i))}for(e in this._columnIndex)for(let t of this._columnIndex[e])t.isEqual(h,s)||(t.deleteValue(n),t.addValue(i));return{requestId:null,table:this._name,action:"Update",record:{Old:this.getRecordToServer(h),New:this.getRecordToServer(s)},identity:{Old:this.getIdentityToServer(y),New:this.getIdentityToServer(l)},tick:u}}catch(e){return this.exception("An exception occurs on replaying the update data into the table '"+this._name+"'",e),f.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}replayDelete(n,t,i,r){try{this.info("Replaying the deletion of the record "+String.JSONStringify(n)+" within identities "+String.JSONStringify(t)+" ...");let u=null,c=null,h=null,f=[];for(u=0;u<this._columns.length;u++){if(h=this._columns[u],n[h.Property]===undefined){this.error("The property '"+h.Property+"' is missing into the record");r.addField(h.Property,"ERR_FIELD_MISSING",["{"+h.Field+"}"]);f[u]=null;continue}f[u]=this._columns[u].convertFromJSON(n[this._columns[u].Property],r)}f[this._indexTick]=n._tick!==undefined?n._tick:null;f[this._indexDeleted]=n._deleted!==undefined?n._deleted:!1;f[this._indexDeleted]&&(this.error("Unable to delete a record already deleted!"),r.addGlobal("ERR_RECORD_DELETED"));let a=f[this._indexKey],l=this.getNewClientId({index:this._indexKey,table:this},a,t[this._columns[this._indexKey].Property],r);if(l===null)return null;let s=this._identitiesByClientId[l];if(s===null||s===undefined)return this.error("Unable to retrieve the client Id ["+l+"] into the table"),r.addFatal("ERR_EXCEPTION_UNEXPECTED"),null;let o=[];for(o[0]=s[0],o[1]=s[1],u=2,c=0;c<this._columnForeign.length;c++,u++){let n=this._columnForeign[c],i=f[n.index],e=t[this._columns[n.index].Property];o[u]=this.getNewClientId(n,i,e,r)}if(r.HasError)return null;this.IsVerboseAll&&this.verbose("The row of the record to delete is "+String.JSONStringify(f)+" with identities "+String.JSONStringify(o));let e=this.getRow(s[0]);if(e===null||e===undefined)this.error("Record must represent an existing record!"),r.addField(this._columns[this._indexKey].Property,"ERR_FIELD_BADFORMAT",["{"+this._columns[this._indexKey].Field+"}",s[0].toString()]);else{let n=this.getRow(null,f,o),t=!1;for(u=0;u<this._columns.length;u++)if(!DSTable.IsEqualProperties(n[this._columns[u].Property],e[this._columns[u].Property])){this.error("Old ("+String.JSONStringify(n)+") and existing ("+String.JSONStringify(e)+") records must represent the same record ("+this._columns[u].Property+" => old: '"+(n[this._columns[u].Property]===null?"null":n[this._columns[u].Property].toString())+"' - existing: '"+(e[this._columns[u].Property]===null?"null":e[this._columns[u].Property].toString())+"') !");r.addGlobal("ERR_RECORD_DIFFERENT");t=!0;break}t||(n._tick===e._tick||n._tick===null||e._tick===null)&&n._deleted===e._deleted||(this.error("Old ("+String.JSONStringify(n)+") and existing ("+String.JSONStringify(e)+") records must represent the same record (tick or deleted flag)!"),r.addGlobal("ERR_RECORD_DIFFERENT"))}if(r.HasError)return null;for(let n of Array.toIterable(this._columnUnique))n.deleteValue(this.getRow(null,f,o));for(let n of Array.toIterable(this._columnIndex))for(let n of n)n.deleteValue(this.getRow(null,f,o));return this._records[s[0]][this._indexDeleted]=!0,{requestId:null,table:this._name,action:"Delete",record:this.getRecordToServer(f),identity:this.getIdentityToServer(o),tick:i}}catch(u){return this.exception("An exception occurs on replaying the delete data into the table '"+this._name+"'",u),r.addFatal("ERR_EXCEPTION_UNEXPECTED"),null}}constructor(n,t,i){super("DSTable["+i.Name+"]");this._database=n;this._name=i.Name;this._areaName=i.Area;this._maxLotSize=i.LotSize;this._indexTable=t;this._columns=[];this._columnsByName={};this._records=[];this._columnUnique=[];this._columnIndex=[];this._hasCopy=null;this._columnForeign=null;this._identities=[];this._identitiesByServerId=[];this._identitiesByClientId=[];this._notYetKnown=[];this._replayClientIds={};this._replayServerIds={};this._lastSequenceId=0;this._indexKey=undefined;this._indexTick=undefined;this._indexDeleted=undefined;this._indexReplayClientId=undefined;this.info("Declaring the table '"+this._name+"' ...");try{this.info("Declaring columns ...");let n=0;for(n=0;n<i.Columns.length;n++){let t=new DSColumn(this._name,i.Columns[n]);if(t.IsKey&&this._indexKey===undefined&&(this._indexKey=n),t.Unique&&(this._columnUnique[n]=t.Unique,this._columnUnique[n].addField(t.Property)),t.Indexes){this._columnIndex[n]=t.Indexes;for(let n of this._columnIndex[n])n.addField(t.Property)}this._columns.push(t);this._columnsByName[t.Property]=n}for(let n of this._columns)if(n.Unique&&n.Unique.addIndexFields(this._columnsByName),n.Indexes)for(let t of n.Indexes)t.addIndexFields(this._columnsByName);if(this.IsDebug){for(let n of Array.toIterable(this._columnUnique))this.debug("The column '"+n.FieldName+"' has to be a unique value (list of Ids: "+n.FieldNames+")");for(let n of Array.toIterable(this._columnIndex))for(let n of n)this.debug("The column '"+n.FieldName+"' has an index (list of Ids: "+n.FieldNames+")")}this._indexKey===undefined&&(n=this._columnsByName.Id,n!==undefined&&(this._indexKey=n));this.debug("IndexKey = "+this._indexKey);this._indexTick=this._columns.length;this.debug("IndexTick = "+this._indexTick);this._indexDeleted=this._columns.length+1;this.debug("IndexDeleted = "+this._indexDeleted);this._indexReplayClientId=this._columns.length+2;this.info(this._columns.length+" columns declared")}catch(r){this.exception("An exception occurs on declaring table '"+this._name+"'",r)}}}class DSDatabase extends LoggerBaseObject{static Heartbeat(n,t){if(this._interval===undefined&&(this._interval=null),(t===null||t===undefined||t<=0)&&this._interval!==null){window.clearInterval(this._interval);this._interval=null;Logger.Instance.info("DB Heartbeat","Heartbeat stopped");return}this._interval===null&&(Logger.Instance.info("DB Heartbeat","Heartbeat started"),this._interval=window.setInterval(async function(){if(Logger.Instance.info("DB Heartbeat","Heartbeat ..."),Hub.Instance.IsRunning&&!n._commitRunning){await n.sendRequests().then(()=>{Hub.Instance.IsStopped&&(Logger.Instance.info("DB Heartbeat","The server was disconnected during the committing process ... Trying to reconnect it ..."),Hub.Instance.start())});return}Hub.Instance.IsStopped&&(Logger.Instance.info("DB Heartbeat","The server is disconnected ... Trying to reconnect it ..."),Hub.Instance.start())},t*1e3))}static async Thread(n,t,i){function u(){return new Promise((r,u)=>{let f=!0;try{let r=t.next();f=!r.done;f&&i&&i(n)}catch(e){Logger.Instance.exception("DSDatabase","Exception on running thread",e);f=!1}setTimeout(f?r:u,10)})}let r=!0;while(r)await u().catch(()=>{r=!1})}set Area(n){this._areaName=n.Module;this._areaInstance=n;this._areaModuleId=n.ModuleId}get Area(){return this._areaName}get NextRequestId(){return this._lastRequestId++}get NextEventListenerKey(){return this._lastListenerKey++}get CurrentLanguage(){if(this._selectedLanguage)return this._selectedLanguage;let n=this.CurrentUser;return n&&n.Language?n.Language:this._defaultLanguage}get CurrentUser(){let n={};if(this._currentUserId===null||this._currentUserId===undefined)return null;if(this._currentUserId===-1)return n.Id=-1,n.Login="",n.Registration="",n.Name="",n.FactoryId=null,n.SectionId=null,n.WorkcentreId=null,n.Profile=UserRecord.PROFILE_ADMINISTRATOR,n.Email="",n.FrequencyNotification=UserRecord.FREQUENCY_NONE,n.FrequencyReportSupervisor=UserRecord.FREQUENCY_NONE,n.FrequencyReportUser=UserRecord.FREQUENCY_NONE,n.CreationDate=new moment,n.EndDate=null,n.Language=this._defaultLanguage,n.Picture=null,n.CustomerId=1,n;let t=this.getClientIdByServerId("User",this._currentUserId);return t===null||t===undefined?null:(this._listUsers===undefined&&(this._listUsers=UserRecord.List?new UserRecord.List:null),n=this._listUsers!==null?this._listUsers.getItem(t,!0):this.getRowById("User",t),n.Profile=this.CurrentModule.Profile,n)}get CurrentModule(){let n=this.getRowById("Module",this.getClientIdByServerId("Module",this._currentModuleId));return n===null&&(n={},n.Id=0,n.Name="No module",n.Module=ModuleRecord.MODULE_NONE,n.Parameters="",n.Profile=UserRecord.PROFILE_NONE,n.Description="",n.Enable=!1),n}get CurrentCustomer(){let n=this.getRowById("Customer",1);return n===null&&(n={},n.Id=0,n.Name="Syncytium Saint-Nazaire",n.Email="",n.Address="",n.Comment=""),n}get Tables(){return this._tables}set SelectedLanguage(n){this._selectedLanguage=n}get Parameters(){return this._parameters}onStartProgress(){this._areaInstance&&this._areaInstance.onStartProgress&&this._areaInstance.onStartProgress();this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.onStartProgress&&this._hubMaster._areaInstance.onStartProgress()}onProgress(n,t,i){n!==null&&n!==undefined||t!==null&&t!==undefined?(this._areaInstance&&this._areaInstance.progressStatus&&this._areaInstance.progressStatus(n,t,i),this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus(n,t,i)):this._areaInstance&&this._areaInstance.progressStatus?this._areaInstance.progressStatus(n,t,i):this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressStatus&&this._hubMaster._areaInstance.progressStatus(n,t,i)}onProgressMemory(){this.IsVerbose&&this.verbose("Memory used : "+this._currentSize+" / "+this._maxSize);this._areaInstance&&this._areaInstance.progressMemory&&this._areaInstance.progressMemory(this._currentSize,this._maxSize);this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.progressMemory&&this._hubMaster._areaInstance.progressMemory(this._hubMaster.current,this._hubMaster._maxSize)}onStopProgress(n){if(this._areaInstance&&this._areaInstance.onStopProgress)this._areaInstance.onStopProgress(n);if(this._hubMaster&&this._hubMaster._areaInstance&&this._hubMaster._areaInstance.onStopProgress)this._hubMaster._areaInstance.onStopProgress(n)}hasSequence(n){return this._sequence[n]===null||this._sequence[n]===undefined?!1:this._sequence[n].length>0}async nextSequence(n,t){function r(r){return function(u){r.info("New sequence '"+n+"' = "+String.JSONStringify(u));t(u.Error!==null&&u.Error!==undefined?u:u.Result.Value)?i=!0:r.debug("Sequence ("+n+") "+String.JSONStringify(u)+" already exist ...")}}(this._sequence[n]===null||this._sequence[n]===undefined)&&(this._sequence[n]=[]);for(var i=!1;!i;)this._sequence[n].length>0?t(this._sequence[n].splice(0,1)[0])?i=!0:db.debug("Sequence ("+n+") "+this._sequence[n].splice(0,1)[0]+" already exist ..."):await Hub.Instance.executeService("Sequence",{Key:n},null,!0).then(r(this))}async setSequence(n,t){await Hub.Instance.executeService("SetSequence",{Key:n,Value:t},null,!0)}cancelSequence(n,t){t===null||t===undefined||t<=0||((this._sequence[n]===null||this._sequence[n]===undefined)&&(this._sequence[n]=[]),this.info("Cancel sequence '"+n+"' = "+t),this._sequence[n].push(t))}get IsEmpty(){return this._bufferRequest.length===0&&this._bufferRequestSent.length===0}deleteRequest(n){let t=this._requestsByRequestId[n];if(t!==null&&t!==undefined){let i=String.JSONStringify(t).length;this.debug("Remove the request ("+n+") from the memory ("+i+" octets)");delete this._requestsByRequestId[n];this._currentSize-=i;this.onProgressMemory()}}rollbackRequest(n){if(n.transaction!==null&&n.transaction!==undefined){this.info("Rollbacking the transaction ("+n.requestId+") ...");let t=this.uncompressTransaction(n.transaction);for(let n=t.length-1;n>=0;n--)try{this.rollbackRequest(t[n])}catch(i){this.exception("Unable to rollback the request",i);this.warn("ignore this exception and continue")}return}n.requestId===undefined?this.info("Rollbacking the request serverId:"+String.JSONStringify(n.record)+" clientId:"+String.JSONStringify(n.identity)+" into the table '"+n.table+"' if and only if the tick is '"+n.tick+"' ..."):this.info("Rollbacking the request ("+n.requestId+") serverId:"+String.JSONStringify(n.record)+" clientId:"+String.JSONStringify(n.identity)+" into the table '"+n.table+"' if and only if the tick is '"+n.tick+"' ...");let t=this._tables[n.table];if(t===null||t===undefined){this.error("The table '"+n.table+"' doesn't exist!");return}t.rollback(n.action,n.record,n.identity,n.tick)}async sendRequests(n){function t(t,i){return async function(r){t.IsVerboseAll&&(i.transaction!==null&&i.transaction!==undefined?t.verbose("Transaction "+String.JSONStringify(i)+" sent"):t.verbose("Request "+String.JSONStringify(i)+" sent"));i.fnDone!==null&&i.fnDone!==undefined&&(i.fnDone.constructor.name==="AsyncFunction"?await i.fnDone(r.Record,r.Error):i.fnDone(r.Record,r.Error));let u=null;if(r.Error!==null&&r.Error!==undefined){let n=t._requestsByRequestId[r.RequestId];u=new Errors;u.setJSON(r.Error);t.warn("["+r.RequestId+"] The request can't have been executed due to some errors ("+u.toString()+")");await t.eventOnNotify("*",-1,n.label,u);t.rollbackRequest(n);t.deleteRequest(r.RequestId)}else t.debug("["+r.RequestId+"] The request has been correctly executed");n===!0&&await t.eventOnValidation("onCommit",u&&u.HasError?u:null)}}if(this._bufferRequestSent.length===0){this.debug("No requests to send");return}this.info("Sending all requests in waiting ...");let i=0;for(let n=0;n<this._bufferRequestSent.length;n++)i+=this._bufferRequestSent[n].length;for(n===!0&&await this.eventOnStartValidation("onStartCommit",i),Hub.Instance.blockEvents();this._bufferRequestSent.length>0;){let n=this._bufferRequestSent[0][0];n!==undefined&&n!==null&&(this._requestsByRequestId[n.requestId]=n);this._bufferRequestSent[0].splice(0,1);this._bufferRequestSent[0].length===0&&this._bufferRequestSent.splice(0,1);n!==undefined&&n!==null&&(n.transaction!==null&&n.transaction!==undefined?await Hub.Instance.executeTransaction(n.requestId,n.label,n.transaction,n.notify).then(t(this,n)):await Hub.Instance.executeRequest(n.requestId,n.label,n.table,n.action,n.record,n.identity).then(t(this,n)))}Hub.Instance.unblockEvents();n===!0&&await this.eventOnStopValidation("onStopCommit")}beginTransaction(n,t){this._bufferTransactionCount===0&&(this._bufferTransactionLabel=Helper.Label(n),this._bufferTransactionNotify=t===!0,this._bufferTransaction=[]);this._bufferTransactionCount++;this.debug("Begin transaction ["+this._bufferTransactionCount.toString()+"]")}compressTransaction(n){function i(n,t,i){for(let r in t){if(!Array.isArray(n[r])){n[r]=[];for(let t=0;t<i;t++)n[r].push(undefined)}n[r].push(t[r])}return n}let t=[],f=null,u=null,r=0;for(let n of n){(f===null||f!==n.action)&&(r++,f=n.action,u={});let o=this._tables[n.table],c=o===undefined?1:o._maxLotSize;if(c=c<=1?1:c,c===1){r++;n._indexLot=r;n._indexTable=o===undefined?0:o._indexTable;n._indexSubLot=0;t.push([n]);u={};continue}let s=u[n.table];s===undefined&&(s=[{table:n.table,action:n.action,record:n.action==="Update"?{New:{},Old:{}}:{},identity:n.action==="Update"?{New:{},Old:{}}:{},tick:[],_request:n,_indexLot:r,_indexTable:o===undefined?0:o._indexTable,_indexSubLot:0}],u[n.table]=s,t.push(s));let e=s[s.length-1],h=e.tick.length;n.action==="Update"?(i(e.record.New,n.record.New,h),i(e.record.Old,n.record.Old,h),i(e.identity.New,n.identity.New,h),i(e.identity.Old,n.identity.Old,h)):(i(e.record,n.record,h),i(e.identity,n.identity,h));e.tick.push(n.tick);e.tick.length>=c&&s.push({table:n.table,action:n.action,record:n.action==="Update"?{New:{},Old:{}}:{},identity:n.action==="Update"?{New:{},Old:{}}:{},tick:[],_request:n,_indexLot:r,_indexTable:o===undefined?0:o._indexTable,_indexSubLot:s.length})}n=t;t=[];for(let n of n)for(let n of n){if(!Array.isArray(n.tick)){t.push(n);continue}if(!Array.isEmpty(n.tick)){if(n.tick.length===1){n.tick=n._request.tick;n.record=n._request.record;n.identity=n._request.identity;delete n._request;t.push(n);continue}t.push(n)}}t.sort((n,t)=>n._indexLot<t._indexLot?-1:n._indexLot>t._indexLot?1:n._indexTable<t._indexTable?-1:n._indexTable>t._indexTable?1:n._indexSubLot<t._indexSubLot?-1:n._indexLot>t._indexLot?1:0);for(let n of t)delete n._indexLot,delete n._indexTable,delete n._indexSubLot;return t}uncompressTransaction(n){function t(n,t){let i={};for(let r in n)i[r]=n[r][t];return i}let i=[];for(let n of n){if(!Array.isArray(n.tick)){i.push(n);continue}for(let r in n.tick)i.push({table:n.table,action:n.action,record:n.action==="Update"?{New:t(n.record.New,r),Old:t(n.record.Old,r)}:t(n.record,r),identity:n.action==="Update"?{New:t(n.identity.New,r),Old:t(n.identity.Old,r)}:t(n.identity,r),tick:n.tick[r]})}return i}endTransaction(n){if(this._bufferTransactionCount<0){this._bufferTransactionCount=0;return}if(this.debug("End transaction ["+this._bufferTransactionCount.toString()+"]"),this._bufferTransactionCount--,!(this._bufferTransactionCount>0)){if(this._bufferTransaction!==null&&this._bufferTransaction.length>0){let t={requestId:this.NextRequestId,label:this._bufferTransactionLabel,transaction:this.compressTransaction(this._bufferTransaction),fnDone:n,notify:this._bufferTransactionNotify};this._bufferRequest.push(t);this.info("The transaction "+String.JSONStringify(t)+" is buffering ...");let i=String.JSONStringify(t).length;for(let n=0;n<this._bufferTransaction.length;n++)i-=String.JSONStringify(this._bufferTransaction[n]).length;this._currentSize+=i;this.onProgressMemory()}this._bufferTransaction=null;this._bufferTransactionLabel=null;this._bufferTransactionNotify=!1}}send(n,t,i,r,u,f){let e={table:n,action:t,record:i,identity:r,tick:u};this._bufferTransaction!==null?this._bufferTransaction.push(e):(e.requestId=this.NextRequestId,e.label=Helper.Label(n.toUpperCase()+"_"+t.toUpperCase()+"D_TOAST",e.requestId),e.fnDone=f,this._bufferRequest.push(e));let o=String.JSONStringify(e).length;return(this._currentSize+=o,this._currentSize>this._maxSize)?(this.error("The request "+String.JSONStringify(e)+" can't be buffered into a transaction because the size '"+this._currentSize+" octets' exceeds '"+this._maxSize+" octets' ..."),this.rollbackRequest(e),!1):(this._bufferTransaction!==null?this.verbose("The request "+String.JSONStringify(e)+" is buffering into a transaction (size: "+o+" octets) ..."):this.info("The request "+String.JSONStringify(e)+" is buffering (size: "+o+" octets) ..."),this.onProgressMemory(),!0)}async commit(){if(this._bufferRequest.length===0){this.debug("No commit because the buffer is empty");return}if(this.info("Committing ..."),this._bufferRequestSent.push(this._bufferRequest),this._bufferRequest=[],this._status!=="Running"){this.info("The database is not ready ... Wait the availability of the database before sending requests to the server ...");return}if(!Hub.Instance.IsRunning){this.info("The server is disconnected ... Wait the end of resynchronizing with the server before sending requests to the server ...");return}if(this._hubDatabase!==null){this.info("The synchronization process is running ... Wait the end of resynchronizing with the server before sending requests to the server ...");return}this._commitRunning||await this.sendRequests(!0)}*rollbackIterable(){let n=this._bufferRequest.length;for(let n=this._bufferRequest.length-1;n>=0;n--){let t=this._bufferRequest[n],i=String.JSONStringify(t),r=i.length;this.debug("Rollback the request "+i+" ("+r+" octets)");this.rollbackRequest(t);this._currentSize-=r;this.onProgressMemory();yield!0}this._lastRequestId-=n;this._bufferRequest=[];this.info(n+" requests have been rollbacked")}rollback(){if(this._bufferRequest.length===0){this.debug("No rollback because the buffer is empty");return}this.info("Rollbacking ...");this.eventOnStartValidation("onStartRollback",this._bufferRequest.length);try{for(let n of this.rollbackIterable())this.eventOnValidation("onRollback")}catch(n){this.exception("Unable to rollback the request",ex)}this.eventOnStopValidation("onStopRollback")}async rollbackAsync(){function n(n){return function(){n.eventOnStopValidation("onStopRollback")}}if(this._bufferRequest.length===0){this.debug("No rollback because the buffer is empty");return}this.info("Rollbacking ...");await this.eventOnStartValidation("onStartRollback",this._bufferRequest.length);await DSDatabase.Thread(this,this.rollbackIterable(),n=>{n.eventOnValidation("onRollback")}).then(n(this))}async onStatusChanged(n,t,i){function r(n){return async function(t){await n.initialize(t)}}function u(n,t){return function(i){n.exception("Connexion error on "+t+" protocol",i);n.updateStatus("Error",new Errors("ERR_CONNECTION"),t==="synchronizing")}}if(t==="Started"&&this._status==="NotInitialized")this.info("The connection is done with the server ... retrieving the database schema ..."),this.updateStatus("Initializing"),await Hub.Instance.initialize(this._areaName,this._areaModuleId).then(r(this)).catch(u(this,"initializing"));else if(t==="Started"&&this._status==="ReadyToSynchronize"){this.info("Starting the synchronization process ...");DSDatabase.Heartbeat();this.onStartProgress();this.onProgress(0,1,"MSG_SYNCHRONIZING");this._hubDatabase=new DSDatabase("DSSynchronization",this);this._hubDatabase._areaName=this._areaName;this._hubDatabase._areaModuleId=this._areaModuleId;await Hub.Instance.initialize(this._hubDatabase._areaName,this._hubDatabase._areaModuleId).then(r(this._hubDatabase)).catch(u(this._hubDatabase,"synchronizing",!0))}else t==="ReadyToSynchronize"?(this.info("The server and the client were disconnected a while ... You can launch the synchronization process as you want ..."),this.updateStatus("ReadyToSynchronize")):t==="Error"&&(this.error("Connexion error on initializing protocol"),this.updateStatus("Error",i))}async acknowledgeRequest(n,t,i,r,u,f,e){if(e!==null&&e!==undefined){let i=this._requestsByRequestId[n],t=new Errors;t.setJSON(e.Error);this.warn("["+n+"] The request can't have been executed due to some errors ("+t.toString()+")");await this.eventOnNotify("*",-1,i.label,t);this.rollbackRequest(i);this.deleteRequest(n);return}if(this._status!=="ReadyToSynchronize"&&this._status!=="Running"){this.info("The acknowledge of the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+") is buffering because the database is not yet ready");this._bufferNotifications.push({requestId:n,area:t,table:i,action:r,record:u,identity:f});return}this.info("Acknowledging of the request '"+n+"' for ('"+t+"', '"+i+"', '"+r+"', "+String.JSONStringify(u)+", "+String.JSONStringify(f)+")");this.updateFromServer(i,r==="Update"?u.New:u,r==="Update"?f.New:f);this.deleteRequest(n)}async acknowledgeTransaction(n,t,i,r){function*u(n,i){for(let i of i)n.IsVerboseAll&&n.verbose("Acknowledging of the request for ('"+t+"', '"+i.table+"', '"+i.action+"', "+String.JSONStringify(i.record)+", "+String.JSONStringify(i.identity)+")"),n.updateFromServer(i.table,i.action==="Update"?i.record.New:i.record,i.action==="Update"?i.identity.New:i.identity),yield!0}if(r!==null&&r!==undefined){let i=this._requestsByRequestId[n],t=new Errors;t.setJSON(r.Error);this.warn("["+n+"] The transaction can't have been executed due to some errors ("+t.toString()+")");await this.eventOnNotify("*",-1,i.label,t);this.rollbackRequest(i);this.deleteRequest(n);return}if(i=this.uncompressTransaction(i),this._status!=="ReadyToSynchronize"&&this._status!=="Running"){this.info("The acknowledge of the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+") is buffering because the database is not yet ready");this._bufferNotifications.push({requestId:n,area:t,transaction:i});return}this.info("Acknowledging of the transaction '"+n+"' for ('"+t+"', "+String.JSONStringify(i)+")");await DSDatabase.Thread(this,u(this,i)).then(()=>this.deleteRequest(n))}async beginNotification(n,t){this._status==="Running"&&(this.info("Begin of notification ("+n+", "+String.JSONStringify(t)+")"),await this.eventOnBeginNotification(n,t))}async notify(n,t,i,r,u){if(this._status!=="Running"){this.info("The notification of the update from the user '"+n+"' for ('"+i+"', '"+r+"', "+String.JSONStringify(u)+" is buffering because the database is not yet ready");this._bufferNotifications.push({userId:n,area:i,table:r,record:u});return}this.info("Notifying an update from the user '"+n+"' for ('"+i+"', '"+r+"', "+String.JSONStringify(u));await this.eventOnNotify(r,u._tick,t);this.updateFromServer(r,u)}async endNotification(n,t){this._status==="Running"&&(this.info("End of notification ("+n+", "+String.JSONStringify(t)+")"),await this.eventOnEndNotification(n,t))}updateStatus(n,t,i){if(this._status!=="Error"){this.info("The status becomes '"+n+"'");let r=this._status;if(this._status=n,this._statusErrors=t,this._areaInstance&&this._areaInstance.onStatusChanged)this._areaInstance.onStatusChanged(r,this._status,this._statusErrors);if(this._hubMaster!==null&&this._status==="Error"){if(this.warn("The synchronization process has failed!"),i===undefined&&(i=!1),Hub.Instance.IsRunning){if(this.warn("The server is up ..."),!i){this.error("Unable to fix the issue on launching again a new synchronization ... Reload the page!");this._hubMaster.updateStatus(this._status,this._statusErrors);return}this.warn("On launching again a new synchronization, you can resolv the issue ... Try it again!");Hub.Instance.updateStatus("ReadyToSynchronize")}else this.warn("The server is down ... The synchronization is not complete! Try it again!");this._hubMaster._hubDatabase=null;DSDatabase.Heartbeat(this._hubMaster,this._hubMaster._hubInterval)}}}updateServerId(n,t,i){this.IsVerboseAll&&this.verbose("Updating all tables having a foreign key ('"+n+"', ["+t+"]) by this new server Id ["+i+"] ...");for(let r of Array.toIterable(this._tables))r.updateServerId(n,t,i)}updateClientId(n,t,i){this.IsVerboseAll&&this.verbose("Updating all tables having a foreign key ('"+n+"', ["+t+"]) by this client Id ["+i+"] ...");for(let r of Array.toIterable(this._tables))r.updateClientId(n,t,i)}async initialize(n){function e(n,t){return function(){return n.error("Connexion error on loading data"),n.updateStatus("Error",new Errors("ERR_CONNECTION"),t),!1}}function o(n){return async function(t){let i=null;if(n.IsDebug&&n.debug("Data received: "+String.JSONStringify(t)),t.Error)return i=new Errors,i.setJSON(t.Error),n.error("The records can't be loaded due to "+i.toString()),n.updateStatus("Error",i),!1;if(!t.Records||!t.Table)return n.error("The records are missing"),i=new Errors("ERR_CONNECTION"),n.updateStatus("Error",i),!1;let r=await n._tables[t.Table].setTable(t.Records,t.LastSequenceId);return r?(n.onProgress(),!0):(n.error("The table is not correctly loaded!"),i=new Errors("ERR_CONNECTION"),n.updateStatus("Error",i),!1)}}function r(n,t){return function(){n.onStopProgress(t);DSDatabase.Heartbeat(n,n._hubInterval)}}function*s(n){n.onProgress(0,n._tables.length,"MSG_LOADING");yield!0;for(let t in n._tables)n.eventOnLoad(t),n.onProgress(),yield!0}function*h(n){n.info("The database schema is compatible with the database synchronized");n.info("Now, replaying all requests into the database manager into the new database ...");n.onProgress();yield!0;n.replayRequests(n._hubMaster);yield!0;n.onProgress();yield!0;n.info("Replacing all existing data by the result of the synchronisation ...");for(let t in n._tables)n._hubMaster._tables[t]=n._tables[t],n._hubMaster._tables[t].setDatabase(n._hubMaster),n._hubMaster._tables[t].updateForeignKeys(!0),yield!0;n.onProgress();yield!0}function*c(n){if(n._hubMaster._bufferNotifications.length>0){n._hubMaster.info("Executing all acknowledges and notifications buffered during the synchronization process ...");let t=n._hubMaster._bufferNotifications;n._hubMaster._bufferNotifications=[];for(let t of t)t.requestId!==null&&t.requestId!==undefined?(n._hubMaster.info("Acknowledging of the request buffered '"+t.requestId+"' for ('"+t.area+"', '"+t.table+"', '"+t.action+"', "+String.JSONStringify(t.record)+", "+String.JSONStringify(t.identity)),n._hubMaster.updateFromServer(t.table,t.action==="Update"?t.record.New:t.record,t.action==="Update"?t.identity.New:t.identity)):t.userId!==null&&t.userId!==undefined&&(n._hubMaster.info("Notifying an update buffered from the user '"+t.userId+"' for ('"+t.area+"', '"+t.table+"', "+String.JSONStringify(t.record)),n._hubMaster.updateFromServer(t.table,t.action==="Update"?t.record.New:t.record)),yield!0}for(let t in n._hubMaster._tables)n._hubMaster.eventOnLoad(t),n.onProgress(),yield!0}let t=null;if(this.info("Schema received: "+String.JSONStringify(n)),n.Error){t=new Errors;t.setJSON(n.Error);this.error("The schema can't be loaded due to "+t.toString());this.updateStatus("Error",t);return}if(!n.Schema){this.error("The schema is missing");t=new Errors("ERR_SCHEMA");this.updateStatus("Error",t);return}if(this._version=n.Version,this.info("Database version = "+this._version),this._hubMaster!==null&&this._hubMaster._version!==this._version){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}if(this._parameters=n.Parameters,this.info("Database parameters = "+String.JSONStringify(this._parameters)),this._parameters["Hub.MaxSize"]!==null&&this._parameters["Hub.MaxSize"]!==undefined){let n=parseInt(this._parameters["Hub.MaxSize"]);!isNaN(n)&&n>0&&(this._maxSize=n*1024)}if(this.info("Max size in the queue = "+this._maxSize+" octets"),this._parameters["Hub.Timeout"]!==null&&this._parameters["Hub.Timeout"]!==undefined){let n=parseInt(this._parameters["Hub.Timeout"]);!isNaN(n)&&n>0&&(this._hubInterval=Math.floor(n/5*3))}this.info("Interval between 2 checks of reconnection = "+this._hubInterval+" secondes");this._defaultLanguage=n.DefaultLanguage;this.info("Default language = "+this._defaultLanguage);this._currentUserId=n.CurrentUserId;this.info("Current user id = "+this._currentUserId);this._currentModuleId=n.CurrentModuleId;this.info("Current module id = "+this._currentModuleId);this._lastRequestId=n.LastRequestId;this.info("The last request Id treated by the server is "+this._lastRequestId);let i=[],u=0;for(let t in n.Schema)this._tables[t]=new DSTable(this,u,n.Schema[t]),i.push(t),u++;for(let n of Array.toIterable(this._tables))n.updateForeignKeys();this.updateStatus("Loading");this.onProgress(0,i.length+(this._hubMaster!==null?3:0));this.onProgressMemory();let f=!0;for(let n of i){let t=await Hub.Instance.loadTable(n).then(o(this)).catch(e(this,this._hubMaster!==null));if(!t){f=!1;break}}if(f){for(let n of Array.toIterable(this._tables))n.updateUniqueAndIndexValues();if(this.updateStatus("Loaded"),this._hubMaster===null){if(this._bufferNotifications.length>0){this.info("Executing all acknowledges and notifications buffered during the initialization process ...");for(let n of this._bufferNotifications)n.requestId!==null&&n.requestId!==undefined?(this.info("Acknowledging of the request buffered '"+n.requestId+"' for ('"+n.area+"', '"+n.table+"', '"+n.action+"', "+String.JSONStringify(n.record)+", "+String.JSONStringify(n.identity)),this.updateFromServer(n.table,n.action==="Update"?n.record.New:n.record,n.action==="Update"?n.identity.New:n.identity)):n.userId!==null&&n.userId!==undefined&&(this.info("Notifying an update buffered from the user '"+n.userId+"' for ('"+n.area+"', '"+n.table+"', "+String.JSONStringify(n.record)),this.updateFromServer(n.table,n.action==="Update"?n.record.New:n.record));this._bufferNotifications=[]}r(this,!0)();await GUI.Box.Progress.Thread(s(this),1,!1,!1);this.updateStatus("Running");return}this.info("The schema and tables are loaded ... Synchronizing database manager ...");for(let n in this._tables)if(this._hubMaster._tables[n]===null||this._hubMaster._tables[n]===undefined){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}for(let n in this._hubMaster._tables)if(this._tables[n]===null||this._tables[n]===undefined){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}for(let n in this._tables)if(!this._tables[n].hasSameStructure(this._hubMaster._tables[n])){this.updateStatus("Error",new Errors("ERR_UNABLE_SYNCHRONIZATION"));return}await GUI.Box.Progress.Thread(h(this),1,!1,!1).then(()=>{this._hubMaster._requestsByRequestId=this._requestsByRequestId,this._hubMaster._bufferRequestSent=this._bufferRequestSent,this._hubMaster._bufferRequest=this._bufferRequest,this._hubMaster._bufferNotifications=this._bufferNotifications,this._hubMaster._version=this._version,this._hubMaster._currentSize=this._currentSize,this._hubMaster._maxSize=this._maxSize,this._hubMaster._parameters=this._parameters,this._hubMaster._defaultLanguage=this._defaultLanguage,this._hubMaster._currentUserId=this._currentUserId,this._hubMaster._lastRequestId=this._lastRequestId,this._hubMaster._hubInterval=this._hubInterval,this._hubMaster._hubDatabase=null,await GUI.Box.Progress.Thread(c(this),1,!1,!1).then(()=>{this._hubMaster.onProgressMemory(),this._hubMaster.updateStatus("Running"),await this._hubMaster.sendRequests().then(r(this._hubMaster,!0)).catch(r(this._hubMaster,!1))})})}}getTable(n){try{return this._tables[n].getTable()}catch(t){return this.exception("An exception occurs on reading data from the table '"+n+"'",t),[]}}each(n,t){try{return this._tables[n].each(t),!0}catch(i){return!1}}getNewRow(n){let t=this._tables[n];if(t===null||t===undefined)return null;let i=t.NewRow;return i.CustomerId!==undefined&&(i.CustomerId=this.CurrentCustomer.Id),i}getRowById(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getRowById(t)}getClientIdByServerId(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getClientIdByServerId(t)}getServerIdByClientId(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getServerIdByClientId(t)}getSequence(n){let t=this._tables[n];return t===null||t===undefined?null:t.Sequence}getColumn(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getColumn(t)}getForeignKeys(n){let t=this._tables[n];return t===null||t===undefined?{}:t.getForeignKeys()}getColumnLabel(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getColumnLabel(t)}getEnumerable(n,t,i){let r=this._tables[n];return r===null||r===undefined?i===undefined?[]:i:r.getEnumerable(t,i)}getDatetimeFormat(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getDatetimeFormat(t)}getDefaultValue(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getDefaultValue(t)}getHistoryValue(n,t,i){let r=this._tables[n];return r===null||r===undefined?null:r.getHistoryValue(t,i)}getLastHistoryId(n,t){let i=this._tables["History"+n];return i===null||i===undefined?null:i.getLastHistoryId(t)}getIndex(n,t,i){let r=this._tables[n];return r===null||r===undefined?null:r.getIndex(t,i)}getValues(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.getValues(t)}updateHistoryProperties(n,t){let i=this._tables[n];return i===null||i===undefined?null:i.updateHistoryProperties(t)}convertValue(n,t,i,r){r===undefined&&(r=!0);let u=this._tables[n];return u===null||u===undefined?i:u.convertValue(t,i,r)}checkProperties(n,t,i){let r=this._tables[n];return r===null||r===undefined?t:r.checkProperties(t,i)}async start(){if(this._status==="NotInitialized"){this.onStartProgress();this.onProgress(0,1,"MSG_INITIALIZING");this.info("Connecting to the server ...");Hub.Instance.addListener(this.Module,this);await Hub.Instance.start()}}addFromClient(n,t,i){this.IsVerbose&&this.verbose("Adding the record "+String.JSONStringify(t)+" from the client into the table '"+n+"' ...");let r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),i.addFatal("ERR_REQUEST_UNKNOWN"),null):r.addFromClient(t,i)}updateFromClient(n,t,i,r){this.IsVerbose&&this.verbose("Updating the record "+String.JSONStringify(t)+" to "+String.JSONStringify(i)+" from the client into the table '"+n+"' ...");let u=this._tables[n];return u===null||u===undefined?(this.error("The table '"+n+"' doesn't exist!"),r.addFatal("ERR_REQUEST_UNKNOWN"),null):u.updateFromClient(t,i,r)}updateFromServer(n,t,i){this.IsVerbose&&this.verbose("Updating the record "+String.JSONStringify(t)+" from the server into the table '"+n+"' ...");let r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),null):r.updateFromServer(t,i)}deleteRowById(n,t){this.IsVerbose&&this.verbose("Deleting the row "+t.toString()+" from the client into the table '"+n+"' ...");let i=this._tables[n];return i===null||i===undefined?(this.error("The table '"+n+"' doesn't exist!"),null):i.deleteRowById(t)}deleteFromClient(n,t,i){this.IsVerbose&&this.verbose("Deleting the record "+String.JSONStringify(t)+" from the client into the table '"+n+"' ...");let r=this._tables[n];return r===null||r===undefined?(this.error("The table '"+n+"' doesn't exist!"),i.addFatal("ERR_REQUEST_UNKNOWN"),null):r.deleteFromClient(t,i)}selectRecordsFromClient(n,t,i,r){function f(n,t,i,r){return function(u){u[i]===r&&n.push({table:t,field:i,record:u})}}let u=r===null||r===undefined?[]:r;return this.each(n,f(u,n,t,i)),u}deleteRecordsFromClient(n,t){if(!t.HasError&&n!==null&&n!==undefined)for(let i=0;i<n.length&&!t.HasError;i++){let r=n[i];if(r===null||r===undefined)return;this.deleteFromClient(r.table,r.record,t)}}executeRequest(n,t,i,r,u){this.info("Executing the request '"+t+"' with the record "+String.JSONStringify(i)+" from the client into the table '"+n+"' ...");let f=this._tables[n];return f===null||f===undefined?(this.error("The table '"+n+"' doesn't exist!"),r.addFatal("ERR_REQUEST_UNKNOWN"),null):((i.CustomerId===undefined||i.CustomerId===null)&&(i.CustomerId=this.CurrentCustomer.Id),f.executeRequest(t,i,r,u))}addEventListener(n,t,i,r){let u=this.NextEventListenerKey;return(n===null||n===undefined)&&(n="*"),(t===null||t===undefined)&&(t="*"),(i===null||i===undefined)&&(i="*"),this.info("Create a new listener ["+u+"] on ('"+n+"', '"+t+"', '"+i+"')"),this._listeners[u]={table:t,id:i,event:n,key:u},(this._eventListeners[n]===null||this._eventListeners[n]===undefined)&&(this._eventListeners[n]={}),(this._eventListeners[n][t]===null||this._eventListeners[n][t]===undefined)&&(this._eventListeners[n][t]={}),(this._eventListeners[n][t][i]===null||this._eventListeners[n][t][i]===undefined)&&(this._eventListeners[n][t][i]={}),(this._eventListeners[n][t][i][u]===null||this._eventListeners[n][t][i][u]===undefined)&&(this._eventListeners[n][t][i][u]=r),u}removeEventListener(n){let t=this._listeners[n];t!==null&&t!==undefined&&(this.info("Remove the listener ["+n+"] on ('"+t.event+"', '"+t.table+"', '"+t.id+"')"),this._eventListeners[t.event]!==null&&this._eventListeners[t.event]!==undefined&&(this._eventListeners[t.event][t.table]!==null&&this._eventListeners[t.event][t.table]!==undefined&&(this._eventListeners[t.event][t.table][t.id]!==null&&this._eventListeners[t.event][t.table][t.id]!==undefined&&(this._eventListeners[t.event][t.table][t.id][n]!==null&&this._eventListeners[t.event][t.table][t.id][n]!==undefined&&delete this._eventListeners[t.event][t.table][t.id][n],$.isEmptyObject(this._eventListeners[t.event][t.table][t.id])&&delete this._eventListeners[t.event][t.table][t.id]),$.isEmptyObject(this._eventListeners[t.event][t.table])&&delete this._eventListeners[t.event][t.table]),$.isEmptyObject(this._eventListeners[t.event])&&delete this._eventListeners[t.event]),delete this._listeners[n])}getEvents(n,t,i){let r=[];for(let u in this._eventListeners)if(u==="*"||u===n)for(let n in this._eventListeners[u])if(n==="*"||n===t)for(let t in this._eventListeners[u][n])if(t==="*"||t===i.toString())for(let i in this._eventListeners[u][n][t])r.push({key:parseInt(i),fn:this._eventListeners[u][n][t][i]});r.sort(function(n,t){return n.key<t.key?-1:n.key>t.key?1:0});let u=[];for(let n of r)u.push(n.fn);return u}async eventOnBeginNotification(n,t){let i=this.getEvents("onBeginNotification","*","*");for(let i of i)try{i.constructor.name==="AsyncFunction"?await i("onBeginNotification","*",n,t):i("onBeginNotification","*",n,t)}catch(r){this.exception("Exception on raising the event 'onBeginNotification'",r)}}async eventOnNotify(n,t,i,r){let u=this.getEvents("onNotify",n,"*");for(let u of u)try{u.constructor.name==="AsyncFunction"?await u("onNotify",n,t,i,r):u("onNotify",n,t,i,r)}catch(f){this.exception("Exception on raising the event 'onNotify'",f)}}async eventOnEndNotification(n,t){let i=this.getEvents("onEndNotification","*","*");for(let i of i)try{i.constructor.name==="AsyncFunction"?await i("onEndNotification","*",n,t):i("onEndNotification","*",n,t)}catch(r){this.exception("Exception on raising the event 'onEndNotification'",r)}}async eventOnCreate(n,t){let i=this.getEvents("onCreate",n,t);if(i.length!==0){let r=this.getRowById(n,t);for(let i of i)try{i.constructor.name==="AsyncFunction"?await i("onCreate",n,t,r):i("onCreate",n,t,r)}catch(u){this.exception("Exception on raising the event 'onCreate'",u)}}}async eventOnUpdate(n,t,i){let r=this.getEvents("onUpdate",n,t);if(r.length!==0){let u=this.getRowById(n,t);for(let r of r)try{r.constructor.name==="AsyncFunction"?await r("onUpdate",n,t,i,u):r("onUpdate",n,t,i,u)}catch(f){this.exception("Exception on raising the event 'onUpdate'",f)}}}async eventOnDelete(n,t){let i=this.getEvents("onDelete",n,t);if(i.length!==0){let r=this.getRowById(n,t);for(let i of i)try{i.constructor.name==="AsyncFunction"?await i("onDelete",n,t,r):i("onDelete",n,t,r)}catch(u){this.exception("Exception on raising the event 'onDelete'",u)}}}async eventOnLoad(n){let t=this.getEvents("onLoad",n,"*");for(let t of t)try{t.constructor.name==="AsyncFunction"?await t("onLoad",n):t("onLoad",n)}catch(i){this.exception("Exception on raising the event 'onLoad'",i)}}async eventOnStartValidation(n,t){this._commitRunning=!0;let i=this.getEvents(n,"*","*");for(let i of i)try{i.constructor.name==="AsyncFunction"?await i(n,t):i(n,t)}catch(r){this.exception("Exception on raising the event '"+n+"'",r)}}async eventOnValidation(n,t){if(this._commitRunning){let i=this.getEvents(n,"*","*");for(let i of i)try{i.constructor.name==="AsyncFunction"?await i(n,t):i(n,t)}catch(r){this.exception("Exception on raising the event '"+n+"'",r)}}}async eventOnStopValidation(n){this._commitRunning=!1;let t=this.getEvents(n,"*","*");for(let t of t)try{t.constructor.name==="AsyncFunction"?await t(n):t(n)}catch(i){this.exception("Exception on raising the event '"+n+"'",i)}}replayRequest(n){let t={},r=null,i=null;if(n===null||n===undefined)return null;if(r=new Errors,n.transaction!==null&&n.transaction!==undefined){let u=[],f=this.uncompressTransaction(n.transaction);for(let n of f){if(i=null,n.table!==null&&n.table!==undefined&&(i=this._tables[n.table]),i===null||i===undefined){this.warn("Unable to replay the request "+String.JSONStringify(n)+" because the table doesn't exist");continue}t=null;switch(n.action){case"Create":t=i.replayCreate(n.record,n.identity,n.tick,r);break;case"Update":t=i.replayUpdate(n.record.Old,n.identity.Old,n.record.New,n.identity.New,n.tick,r);break;case"Delete":t=i.replayDelete(n.record,n.identity,n.tick,r);break;default:t={table:n.table,action:n.action,record:n.record,identity:n.identity,tick:n.tick}}if(t===null||r.HasError){this.warn("Unable to replay the request "+String.JSONStringify(n)+" due to "+r.toString());for(let n=u.length-1;n>=0;n--)this.rollbackRequest(u[n]);return null}u.push(t)}t={requestId:null,label:n.label,transaction:this.compressTransaction(u),notify:n.notify,fnDone:n.fnDone}}else{if(n.table!==null&&n.table!==undefined&&(i=this._tables[n.table]),i===null||i===undefined)return this.warn("Unable to replay the request "+String.JSONStringify(n)+" because the table doesn't exist"),null;switch(n.action){case"Create":t=i.replayCreate(n.record,n.identity,n.tick,r);break;case"Update":t=i.replayUpdate(n.record.Old,n.identity.Old,n.record.New,n.identity.New,n.tick,r);break;case"Delete":t=i.replayDelete(n.record,n.identity,n.tick,r);break;default:t={requestId:null,table:n.table,action:n.action,record:n.record,identity:n.identity,tick:n.tick,fnDone:n.fnDone}}t!==null&&t!==undefined&&(t.label=n.label)}if(t===null||r.HasError)return this.warn("Unable to replay the request "+String.JSONStringify(n)+" due to "+r.toString()),null;t.requestId=this.NextRequestId;let u=String.JSONStringify(t).length;return this._currentSize+=u,this.info("The request "+String.JSONStringify(t)+" has been replayed (size: "+u+" octets) ..."),this.onProgressMemory(),t}replayRequests(n){this.info("Replaying requests ...");this._requestsByRequestId={};this._bufferRequestSent=[];this._bufferRequest=[];this._bufferNotifications=[];let u=[];for(let t in n._requestsByRequestId)u.push(t);u.sort(function(n,t){return n<t?-1:n>t?1:0});let f=[],t=0,r=0,i=null;for(t=0;t<u.length;t++){if(u[t]<=this._lastRequestId){this.info("Ignore the request ["+u[t]+"] because already treated by the server");continue}i=this.replayRequest(n._requestsByRequestId[u[t]]);i!==null&&i!==undefined&&f.push(i)}for(t=0;t<n._bufferRequestSent.length;t++)for(r=0;r<n._bufferRequestSent[t].length;r++)i=this.replayRequest(n._bufferRequestSent[t][r]),i!==null&&i!==undefined&&f.push(i);for(this._bufferRequestSent.push(f),this.info(f.length+" requests to send to the server"),t=0;t<n._bufferRequest.length;t++)i=this.replayRequest(n._bufferRequest[t]),i!==null&&i!==undefined&&this._bufferRequest.push(i);for(this.info(this._bufferRequest.length+" requests in waiting to send to the server"),t=0;t<n._bufferNotifications.length;t++)if(n._bufferNotifications[t].transaction!==undefined&&n._bufferNotifications[t].transaction!==null){for(i=[],r=0;r<n._bufferNotifications[t].transaction.length;r++)n._bufferNotifications[t].transaction[r].identity!==undefined&&n._bufferNotifications[t].transaction[r].identity!==null&&i.push(n._bufferNotifications[t].transaction[r]);i.lenth>0&&this._bufferNotifications.push(i)}else if(n._bufferNotifications[t].identity!==undefined&&n._bufferNotifications[t].identity!==null){this._bufferNotifications.push(n._bufferNotifications[t]);continue}this.info(this._bufferNotifications.length+" notifications waiting the end of initialization")}constructor(n,t){super(n===undefined?"DSDatabase":n);this._areaName=null;this._areaInstance=null;this._areaModuleId=-1;this._status="NotInitialized";this._statusErrors=null;this._version=0;this._tables={};this._parameters=null;this._defaultLanguage="EN";this._currentUserId=-1;this._currentModuleId=-1;this._selectedLanguage=null;this._listUsers=undefined;this._lastRequestId=0;this._maxSize=1048576;this._currentSize=0;this._bufferRequest=[];this._bufferRequestSent=[];this._requestsByRequestId={};this._bufferNotifications=[];this._sequence={};this._lastListenerKey=0;this._listeners={};this._eventListeners={};this._commitRunning=!1;this._bufferTransactionLabel=null;this._bufferTransactionNotify=!1;this._bufferTransaction=null;this._bufferTransactionCount=0;this._hubMaster=t===undefined?null:t;this._hubInterval=30;this._hubDatabase=null}static get Instance(){return this._instance||(this._instance=new DSDatabase),this._instance}}GUI={};GUI.GUI=(class extends LoggerBaseObject{get Name(){return this._name}get CSSClass(){return this._cssClass}get Box(){return this._box}get Component(){return this._component}get Visible(){return this._visible?this._box instanceof GUI.Box.Box?this._box.Visible:!0:!1}set Visible(n){(this._visible=n===!0||n===null||n===undefined,this.Visible?this.debug("Visible = true"):this.debug("Visible = false"),this._component!==null)&&(this.Visible?this._component.show():this._component.hide())}get Readonly(){return this._readonly?!0:this._box instanceof GUI.Box.Box?this._box.Readonly:!1}set Readonly(n){(this._readonly=n===!0||n===null||n===undefined,this.Readonly?this.debug("Readonly = true"):this.debug("Readonly = false"),this._component!==null)&&(this.Readonly?this._component.addClass("readonly"):this._component.removeClass("readonly"))}get IsOpened(){return this._isOpened}set TabIndex(n){this._tabIndex=n;this.Component!==null&&this.Component.attr("tabindex",this._tabIndex)}get TabIndex(){return this._tabIndex}destructor(){this.clearListeners();this._events={}}on(n,t){this.debug("Declare event("+n+")");this._events[n]=t}raise(n,...t){this.IsOpened&&this._events[n]&&this._events[n](...t)}isEvent(n){return this._events[n]?!0:!1}getEvent(n){return this._events[n]?this._events[n]:null}off(n){this.debug("Remove event("+n+")");this._events[n]=null}clearListeners(){for(let n of this._listeners)DSDatabase.Instance.removeEventListener(n);this._listeners=[]}addListener(n){this._listeners.push(n)}refresh(){(this.verbose("Refresh"),this._component!==null)&&(this.Visible?this._component.show():this._component.hide(),this.Readonly?this._component.addClass("readonly"):this._component.removeClass("readonly"))}onOpen(){this.verbose("onOpen");this._isOpened=!0}onClose(){this.clearListeners();this._isOpened=!1;this.verbose("onClose")}draw(n){if(n===null||n===undefined){this._component=this._container;return}this._component=$(n);this._container.append(this._component[0]);String.isEmptyOrWhiteSpaces(this._type)||this._component.addClass(this._type);String.isEmptyOrWhiteSpaces(this._cssClass)||this._component.addClass(this._cssClass);this._component.find("*").attr("tabindex",null);this._tabIndex!==null&&this._component.attr("tabindex",this._tabIndex)}focus(){return(this.verbose("focus"),this.Component===null||this._tabIndex===null||!this.Visible||this.Readonly)?!1:(this.Component.focus(),!0)}nextFocus(){this.Box instanceof GUI.Box.Box&&this.Box.nextFocus()}previousFocus(){this.Box instanceof GUI.Box.Box&&this.Box.previousFocus()}onMouseClick(){}onButtonOK(){if(this.verbose("onButtonOK"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_OK);(n!==null&&n.Visible||(n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE)),n!==null&&n.Visible)&&n.onMouseClick()}}onButtonClose(){if(this.verbose("onButtonClose"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE);n!==null&&n.Visible&&n.onMouseClick()}}onButtonCancel(){if(this.verbose("onButtonCancel"),this.Box instanceof GUI.Box.Box){let n=this.Box.getButton(GUI.Box.Box.BUTTON_CANCEL);(n!==null&&n.Visible||(n=this.Box.getButton(GUI.Box.Box.BUTTON_CLOSE)),n!==null&&n.Visible)&&n.onMouseClick()}}constructor(n,t,i,r){if(n==="area")super(i);else if(typeof t=="string"){let r=t.trim().split(">"),u=r[r.length-1];r=u.trim().split(" ");u=r[r.length-1];super(n+"["+u+"."+i+"]")}else t instanceof GUI.Box.Box?super(n+"["+t.Name+"."+i+"]"):super(n+"["+i+"]");this._name=i;this._cssClass=r?r:null;this._box=null;this._type=n;typeof t=="string"?this._container=$(t):t instanceof GUI.Box.Box?(this._container=t.CurrentPanel,this._box=t):this._container=t?t:null;this._component=null;this._visible=!0;this._readonly=!1;this._isOpened=!1;this._tabIndex=null;this._events={};this._listeners=[];this._throttle=null;this.debug("Create the GUI component '"+i+"' ("+this._type+")")}});GUI.Board={};GUI.Board.BOARD_ICON=1;GUI.Board.BOARD_ADD=2;GUI.Board.BOARD_EDIT=4;GUI.Board.BOARD_CANCEL=8;GUI.Board.BOARD_DELETE=16;GUI.Board.BOARD_HELP=32;GUI.Board.BOARD_NONE=0;GUI.Board.BOARD_ALL=255;GUI.Board.ExportCSVFile=null;GUI.Board.Board=(class extends GUI.GUI{get Title(){return this._title}set Title(n){this._title=Helper.Label(n)}set Readonly(n){(super.Readonly=n,this.Component!==null)&&(this.Readonly?this.Component.find("> .title > .div").addClass("readonly"):this.Component.find("> .title > .div").removeClass("readonly"))}get Readonly(){return super.Readonly}set Help(n){function t(n){return function(){typeof n._link=="string"&&window.open(Area.HTTP_ROOT_DOCUMENTATION+n._link,"_blank");typeof n._link=="function"&&n._link()}}if(this._link=n===null||n===undefined?null:n,this._link===null)this.off("help");else this.on("help",t(this))}set Panel(n){this._panel=n}get Panel(){return this._panel}get IsVisibleIcon(){return this._icons&GUI.Board.BOARD_ICON}get IsVisibleAdd(){return this._icons&GUI.Board.BOARD_ADD}get IsVisibleEdit(){return this._icons&GUI.Board.BOARD_EDIT}get IsVisibleCancel(){return this._icons&GUI.Board.BOARD_CANCEL}get IsVisibleDelete(){return this._icons&GUI.Board.BOARD_DELETE}get IsVisibleHelp(){return this._icons&GUI.Board.BOARD_HELP}get List(){return this._list}get TableZone(){return this.Component.find("> .table")}get Webix(){return this._webix}set Webix(n){this._webix!==null&&this._webix.destructor();this._webix=n}get AdjustWebixEnable(){return this._adjustWebixEnable}set AdjustWebixEnable(n){this._adjustWebixEnable=n}destructor(){super.destructor();this._webix!==null&&(this._webix.destructor(),this._webix=null)}async show(){this.IsOpened||(this.debug("Show the board"),this.onOpen(),this.refresh(),this.Component.show(),this._webix!==null&&(await this.populateWebix(),await this.adjustWebix()))}hide(){this.IsOpened&&this.Visible&&(this.debug("Hide the board"),this.onClose(),this.Component.hide())}setVisible(n,t){function i(n,t,i,r){t&i&&(r?n._icons&i||(n._icons+=i):n._icons&i&&(n._icons-=i))}if(n!==null&&n!==undefined){if(typeof n=="boolean"){super.Visible=n;return}i(this,n,GUI.Board.BOARD_ICON,t);i(this,n,GUI.Board.BOARD_ADD,t);i(this,n,GUI.Board.BOARD_EDIT,t);i(this,n,GUI.Board.BOARD_CANCEL,t);i(this,n,GUI.Board.BOARD_DELETE,t);i(this,n,GUI.Board.BOARD_HELP,t);this.refreshIcon("board",this.IsVisibleIcon);this.refreshIcon("add",this.IsVisibleAdd);this.refreshIcon("edit",this.IsVisibleEdit);this.refreshIcon("cancel",this.IsVisibleCancel);this.refreshIcon("delete",this.IsVisibleDelete);this.refreshIcon("help",this.IsVisibleHelp)}}refreshIcon(n,t){function r(n,t){return function(){switch(t){case"board":n.onBoardIcon();break;case"add":n.onBoardAdd();break;case"edit":n.onBoardEdit();break;case"cancel":n.onBoardCancel();break;case"delete":n.onBoardDelete();break;case"help":n.onBoardHelp()}}}if(this.Component!==null){let i=this.Component.find("> .title > .icon."+n);if(t?i.hasClass("hide")&&i.removeClass("hide"):i.hasClass("hide")||i.addClass("hide"),i.hasClass("disallowed")&&i.removeClass("disallowed"),this.isEvent(n)&&this.List.isBoardAllowed(this,DSDatabase.Instance.CurrentUser,n,undefined)){i.css("cursor","pointer");i.off("click").on("click",r(this,n))}else t?(i.addClass("disallowed"),i.css("cursor","initial"),i.off("click")):(i.css("cursor","initial"),i.off("click"))}}refresh(){(super.refresh(),this.Component!==null)&&(this.Component.find("> .title > .title").html(Helper.Span(this._title)),this.refreshIcon("board",this.IsVisibleIcon),this.refreshIcon("add",this.IsVisibleAdd),this.refreshIcon("edit",this.IsVisibleEdit),this.refreshIcon("cancel",this.IsVisibleCancel),this.refreshIcon("delete",this.IsVisibleDelete),this.refreshIcon("help",this.IsVisibleHelp),this.Readonly?this.Component.find("> .title > div").addClass("readonly"):this.Component.find("> .title > div").removeClass("readonly"))}async adjustWebix(){if(this.debug("Adjust webix (async)"),this._webix!==null&&this._webix!==undefined){let n=this.TableZone,t=Math.floor(n.width()),i=Math.floor(n.height());(t!==this._webix.config.width||i!==this._webix.config.height)&&(this._webix.config.width=t,this._webix.config.height=i,this._webix.resize())}}draw(){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(async function(){n.debug("Resizing window ...");await n.adjustWebix()},100))}}let n="<board id='"+this.Name+"' class='"+this.Name+"'>";n+="<div class='title'>";n+="<div class='icon board'><\/div>";n+="<div class='title'><\/div>";n+="<div class='icon add'><\/div>";n+="<div class='icon edit'><\/div>";n+="<div class='icon cancel'><\/div>";n+="<div class='icon delete'><\/div>";n+="<div class='icon help'><\/div>";n+="<\/div>";n+="<div class='table'><\/div>";n+="<\/board>";super.draw(n);this._webix=this.drawWebix(this.TableZone);$(window).on("resize",t(this))}async populateWebix(){this.debug("Populate webix (async)")}drawWebix(){return null}onOpen(){function n(n){return function(){n.Readonly||n.Box!==null&&n.Box.setFocus(n)}}function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onUpdate(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1}}}super.onOpen();this.Component.on("focus",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.Component.off("focus keydown")}onEvent(n,t){if(n&&this.List.isBoardAllowed(this,DSDatabase.Instance.CurrentUser,t)){let i=this.getEvent(t);i!==null&&i()}}onBoardIcon(){this.onEvent(this.IsVisibleIcon,"board")}onBoardAdd(){this.onEvent(this.IsVisibleAdd,"add")}onBoardEdit(){this.onEvent(this.IsVisibleEdit,"edit")}onBoardCancel(){this.onEvent(this.IsVisibleCancel,"cancel")}onBoardDelete(){this.onEvent(this.IsVisibleDelete,"delete")}onBoardHelp(){this.onEvent(this.IsVisibleHelp,"help")}async addItem(n,t){function u(n,t,i){return async function(){let n=new Errors;i.Table!==undefined?i.beginTransaction(Helper.Label(i.Table.toUpperCase()+"_CREATED_TOAST",i.getText(t))):i.beginTransaction();let r=i.addItem(t,n,!0);if(i.endTransaction(),n.HasError){await i.rollbackAsync().then(()=>{GUI.Box.Message.Error("ERROR",n)});return}await i.commitAsync()}}let i=new Errors;t=t===undefined||t===null?this.List:t;t.Table!==undefined?t.beginTransaction(Helper.Label(t.Table.toUpperCase()+"_CREATED_TOAST",t.getText(n))):t.beginTransaction();let r=t.addItem(n,i,!1);if(t.endTransaction(),Helper.IsLabel(r)){GUI.Box.Message.Message(Helper.Label(t.Table===undefined?this.Title:t.Table.toUpperCase()+"_CREATE",t.getText(n)),r,u(this,n,t));return}if(i.HasError){await t.rollbackAsync().then(()=>{GUI.Box.Message.Error("ERROR",i)});return}await t.commitAsync()}async updateItem(n,t,i){function f(n,t,i,r){return async function(){let n=new Errors;r.Table!==undefined?r.beginTransaction(Helper.Label(r.Table.toUpperCase()+"_UPDATED_TOAST",r.getText(i))):r.beginTransaction();let u=r.updateItem(t.Id,t,i,n,!0);if(r.endTransaction(),n.HasError){await r.rollbackAsync().then(()=>{GUI.Box.Message.Error("ERROR",n)});return}await r.commitAsync()}}let r=new Errors;i=i===undefined||i===null?this.List:i;i.Table!==undefined?i.beginTransaction(Helper.Label(i.Table.toUpperCase()+"_UPDATED_TOAST",i.getText(t))):i.beginTransaction();let u=i.updateItem(n.Id,n,t,r,!1);if(i.endTransaction(),Helper.IsLabel(u)){GUI.Box.Message.Message(Helper.Label(i.Table===undefined?this.Title:i.Table.toUpperCase()+"_UPDATE",i.getText(t)),u,f(this,n,t,i));return}if(r.HasError){await i.rollbackAsync().then(()=>{GUI.Box.Message.Error("ERROR",r)});return}await i.commitAsync()}async deleteItem(n,t){let i=new Errors;if(t=t===undefined||t===null?this.List:t,t.Table!==undefined?t.beginTransaction(Helper.Label(t.Table.toUpperCase()+"_DELETED_TOAST",t.getText(n))):t.beginTransaction(),t.deleteItem(n.Id,n,i),t.endTransaction(),i.HasError){await t.rollbackAsync().then(()=>{GUI.Box.Message.Error("ERROR",i)});return}await t.commitAsync()}declareExportCSV(n,t,i,r,u,f){this._csvFiles[n]={name:n,list:t,label:i,headers:r,filename:u,frequency:f===null||f===undefined?1e3:f};this._csvFilesSelections.push(this._csvFiles[n])}async exportCSV(n,t,i,r){function e(n,t,i){return function(){n.exportCSV(t.headers,t.filename,t.list,i)}}if(n===undefined&&t===undefined){if(this._csvFilesSelections.length===0)return!1;let n=[];for(let t of this._csvFilesSelections)n.push({label:t.label,fn:e(this,t,t.frequency)});return GUI.Box.BoxChoice.BoxChoices("TITLE_CSV_EXPORT",null,n),!0}(i===null||i===undefined)&&(i=this.List);let u=!1;t=t===undefined||t===null?this.Name+".csv":t;let f=new CSV(this.Name,null,DSDatabase.Instance.Parameters["CSV.Separator"],DSDatabase.Instance.Parameters["CSV.Charset"]);return await GUI.Box.Progress.Thread(f.toBlobFromList(i,n),r,!0,!0).then(()=>{if(f.Blob===null){u=!1;return}GUI.Board.ExportCSVFile!==null&&window.URL.revokeObjectURL(GUI.Board.ExportCSVFile);GUI.Board.ExportCSVFile=window.URL.createObjectURL(f.Blob);let n=document.createElement("a");n.setAttribute("download",t);n.href=GUI.Board.ExportCSVFile;document.getElementById("log").appendChild(n);window.requestAnimationFrame(function(){let t=new MouseEvent("click");n.dispatchEvent(t);document.getElementById("log").removeChild(n)});u=!0}),u}toPDF(n){return n}exportPDF(){this.info("Exporting board into a PDF file ...");GUI.Box.Progress.Start();GUI.Box.Progress.SetStatus(0,2,"MSG_PDF");let n=new DocPDF;n.create(this._title).then(()=>{this.toPDF(n).finalize()}).then(()=>{n.download(this.Name+".pdf"),GUI.Box.Progress.Stop()}).catch(n=>{GUI.Box.Progress.Stop(),GUI.Box.Message.Error("ERROR",n)})}clearWebixCache(){this.debug("Cleaning up the webix cache ...")}constructor(n,t,i,r,u,f){super("board",n,t,"board "+i?i:"");this._panel=null;this._link=null;this._title=Helper.Label(r);this._list=u instanceof List.List?u:new List.List;this._icons=f!==null&&f!==undefined?f:GUI.Board.BOARD_ICON+GUI.Board.BOARD_ADD+GUI.Board.BOARD_CANCEL+GUI.Board.BOARD_DELETE;this._webix=null;this._CSVColumns=null;this._adjustWebixEnable=!0;this._csvFiles={};this._csvFilesSelections=[]}});GUI.Board.BoardChart=(class extends GUI.Board.Board{get Legends(){return this._legends}createChart(){return null}draw(){function u(n){return async function(t,i,r){let u;if(i!==undefined)for(u=0;u<n._legends.length;u++)n._legends[u].text!==""&&(n._legends[u].text=$(n._legends[u].text).each(Language.Manager.HandleReplacementKeyLabel(t,i,r))[0].outerHTML);else for(u=0;u<n._legends.length;u++)n._legends[u].text!==""&&(n._legends[u].text=$(n._legends[u].text).each(Language.Manager.HandleReplacementLabel(t))[0].outerHTML);n.Webix=n.createChart();await n.adjustWebix()}}this.declareLegends();let i=String.parseRGBToHEX($("body").css("color")),n=$("<webix id='"+this.Name+"' class='default_color'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass);let t=n.appendTo("body"),r=String.parseRGBToHEX(n.css("color"));t.remove();for(let u of this._legends){n=$("<webix id='"+this.Name+"' class='color_"+u.id+"'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass);t=n.appendTo("body");let f=String.parseRGBToHEX(n.css("color"));t.remove();u.color=f===i?r:f}super.draw();Language.Manager.Instance.addListener(u(this))}async adjustWebix(){(await super.adjustWebix(),this.Webix!==null)&&this.Webix.adjust()}declareLegend(n,t,i){this._legends.push({id:n,text:Helper.Span(t),label:Helper.Label(t),color:null,type:i===undefined||i===null?null:i})}declareLegends(){}getTooltipValue(n,t){return n[t].toString()}getTooltip(n,t,i){let r=0,u="";if(i!==null&&i!==undefined){for(r=0;r<this._legends.length;r++)if(this._legends[r].id===i)return"<div style='color: "+this._legends[r].color+";'>"+String.encode(n[t])+" - "+this._legends[r].text+": "+n[this._legends[r].id].toString()+"<\/div>";return null}switch(this._legends.length){case 0:return null;case 1:return"<div style='color: "+this._legends[0].color+";'>"+String.encode(n[t])+" - "+this._legends[0].text+": "+n[this._legends[0].id].toString()+"<\/div>"}for(u="<table><tr><td colspan='2'><center><b>"+String.encode(n[t])+"<\/b><\/center><\/td><\/tr>",r=0;r<this._legends.length;r++)u+="<tr style='color: "+this._legends[r].color+";'><td>"+this._legends[r].text+"<\/td><td>"+this.getTooltipValue(n,this._legends[r].id)+"<\/td><\/tr>";return u+"<\/table>"}get NbPoints(){return Math.ceil(this.TableZone.width()/10)+1}newIndicator(){let n={};for(let t of this._legends)n[t.id]=0;return n}drawCanvas(){}onOpen(){function n(n){return async function(){n.refresh();await n.populateWebix();await n.adjustWebix(!0)}}if(super.onOpen(),!this.List.isEvent("onCreate")&&!this.List.isEvent("onUpdate")&&!this.List.isEvent("onDelete")&&!this.List.isEvent("onLoad")){this.List.on("onCreate",n(this));this.List.on("onUpdate",n(this));this.List.on("onDelete",n(this));this.List.on("onLoad",n(this))}this.List.onOpen()}onClose(){super.onClose();this.List.unbind("onCreate");this.List.unbind("onUpdate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}toPDF(n){let i=n.MaxWidth-n.Content.pageMargins[0]-n.Content.pageMargins[2],r=Math.ceil(i/2),t=$("<canvas width='"+(i*2).toString()+"' height='"+(r*2).toString()+"' ><\/canvas>"),u=t[0].getContext("2d");return this.drawCanvas(t[0],u),n.Content.push({image:n.addImage(t[0].toDataURL("image/png",1)),width:i,height:r,alignment:"center"}),t.remove(),n}constructor(n,t,i,r,u,f){super(n,t,"board_chart "+i,r,u,f);this._legends=[]}});GUI.Board.BoardChartMultiData=(class extends GUI.Board.BoardChart{static get BAR(){return"bar"}static get LINE(){return"line"}set NbSteps(n){this._nbSteps=n<1?1:Math.ceil(n)}get Values(){return this._values}createChart(){function i(n){return function(t,i){let r=n.getTooltip(n.getItem(t),"label");String.isEmptyOrWhiteSpaces(r)||GUI.Webix.Tooltip.Instance.show(r,i)}}function r(){return function(){GUI.Webix.Tooltip.Instance.hide()}}let t=this._maxValue?this._maxValue:this._nbSteps,n={view:"chart",type:this._chartType,css:"webix_board_line",container:this.TableZone[0],color:"#color#",shadow:!1,border:!1,borderless:!0,xAxis:{template:this._showXAxis?"#label#":"",lines:!1},tooltip:!1,yAxis:{start:0,end:t,step:t/this._nbSteps,lines:!0},legend:{values:this.Legends,align:"center",layout:"x"},series:this._series,data:this._data,on:{onMouseMove:i(this),onMouseOut:r(this)}};return this._chartType===GUI.Board.BoardChartMultiData.LINE&&(n.offset=0,n.eventRadius=5),new webix.ui(n)}drawWebix(){this._series=[];for(let n of this.Legends){let t=$("<webix id='"+this.Name+"' class='color_"+n.id+"'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||t.addClass(this.CSSClass);let r=t.appendTo("body"),i=parseInt(t.css("width"));i<1&&(i=1);r.remove();n.width=i;n.type=n.type===null||n.type===undefined?this._chartType:n.type}for(let n of this.Legends)if(n.type===this._chartType)switch(this._chartType){case GUI.Board.BoardChartMultiData.BAR:this._series.push({value:"#"+n.id+"#",color:n.color});break;case GUI.Board.BoardChartMultiData.LINE:this._series.push({value:"#"+n.id+"#",item:{radius:0},line:{color:n.color,width:n.width}})}for(let n of this.Legends)if(n.type!==this._chartType)switch(n.type){case GUI.Board.BoardChartMultiData.BAR:this._series.push({value:"#"+n.id+"#",type:"bar",color:n.color});break;case GUI.Board.BoardChartMultiData.LINE:this._series.push({value:"#"+n.id+"#",type:"line",item:{radius:0},line:{color:n.color,width:n.width}})}return this.createChart()}async adjustWebix(n){if(n=n===null||n===undefined?!1:n,this.Webix!==null){let t=0;for(let n of this._data)for(let i of this.Legends)t<n[i.id]&&(t=Math.ceil(n[i.id]/this._nbSteps)*this._nbSteps);(this._maxValue!==t||this.Webix.config.yAxis.step!==t/this._nbSteps||n)&&(this._maxValue=t,this.Webix=this.createChart());let i=this.TableZone,r=i.width(),u=i.height();this.Webix.config.width=r;this.Webix.config.height=u;this.Webix.config.x=r/10;this.Webix.config.y=u/10;this.Webix.resize();await super.adjustWebix()}}clear(){this._data.splice(0,this._data.length);this._values={}}declareAbscissa(n,t){if(t=t===null||t===undefined?n:t,this._values[n]===undefined){let i={id:this._data.length,abscissa:n,label:t};for(let n of this.Legends)i[n.id]=0;this._data.push(i);this._values[n]=i}}setValue(n,t,i){if(this._values[n]!==null&&this._values[n]!==undefined&&this._values[n][t]!==null&&this._values[n][t]!==undefined){let r=0;r=typeof i=="string"?String.parseFloat(i):typeof i=="number"?i:0;r<0&&(r=0);this._values[n][t]=r}}drawCanvas(n,t){let i=0,r=0,h=0,c=this._nbSteps;for(i=0;i<this._data.length;i++)for(r=0;r<this.Legends.length;r++)c<this._data[i][this.Legends[r].id]&&(c=Math.ceil(this._data[i][this.Legends[r].id]/this._nbSteps)*this._nbSteps);let l=16,p=20,a=n.width*.95,v=Math.ceil(n.height*.7),u=n.width-a,f=v,o=0,e=0,s=0,y=0;if(t.translate(.5,6.5),this._data.length>0&&this.Legends.length>0){let n=0;for(i=0;i<this.Legends.length;i++)this.Legends[i].type===GUI.Board.BoardChartMultiData.BAR&&n++;for(n>0?(e=a/Math.max(1,this._data.length),o=e/2,y=e/n):(e=a/Math.max(1,this._data.length-1),o=0),s=v/c,i=0,h=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.BAR){for(t.fillStyle=this.Legends[i].color,r=0;r<this._data.length;r++){let n=this._data[r][this.Legends[i].id];n<=0||t.fillRect(u+r*e+y*(h+.1),f-1,y*.8,-n*s+1)}h++}for(i=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.LINE){for(t.beginPath(),t.lineWidth=2,t.moveTo(u+o+1,f-s*this._data[0][this.Legends[i].id]),r=1;r<this._data.length;r++)t.lineTo(u+o+e*r,f-s*this._data[r][this.Legends[i].id]);t.strokeStyle=this.Legends[i].color;t.stroke()}for(i=0,h=0;i<this.Legends.length;i++)if(this.Legends[i].type===GUI.Board.BoardChartMultiData.LINE)for(t.fillStyle=this.Legends[i].color,r=0;r<this._data.length;r++){let n=u+o+e*r,h=f-s*this._data[r][this.Legends[i].id];t.beginPath();t.moveTo(n,h);t.lineTo(n,h);t.fill()}}for(t.beginPath(),t.lineWidth=1,t.moveTo(u,0),t.lineTo(u,f),t.lineTo(n.width,f),t.strokeStyle="#000000",t.stroke(),t.setLineDash([5,5]),i=1;i<=this._nbSteps;i++){let n=Math.ceil(v*i/this._nbSteps);t.beginPath();t.lineWidth=1;t.moveTo(u+1,f-n);t.lineTo(u+a,f-n);t.strokeStyle="#d8d8d8";t.stroke();t.font=l.toString()+"px var(--syncytium-font)";t.fillStyle="#333333";t.textAlign="right";let r=Math.ceil(c*i/this._nbSteps).toString();t.fillText(r,u-2,f-n+l/3)}if(t.setLineDash([]),this.Legends.length>0){let e=n.width/(this.Legends.length>4?4:this.Legends.length),u=p,f=u/2,o=0,s=n.height-7-p/2-(u+14)*Math.floor((this.Legends.length-1)/4);for(t.font="20px var(--syncytium-font)",i=0,r=0;i<this.Legends.length;i++){let n=Language.Manager.Instance.interpolation(this.Legends[i].label),l=t.measureText(n),h=o+i%4*e+(e-l.width-u)/2,c=s+r*(u+14);t.fillStyle="#666666";t.textAlign="left";t.fillText(n,h+u,c);let a=h+f,v=c-f;t.fillStyle=this.Legends[i].color;t.beginPath();t.arc(a,v+4,f*.8,0,Math.PI*2);t.fill();(i+1)%4==0&&r++}}if(this._data.length>0&&this.Legends.length>0){let n=Math.max(1,Math.ceil(20/e));for(i=0;i<this._data.length;i+=n){let n=this._data[i].label;n=String.isEmptyOrWhiteSpaces(n)?"":n.length>23?n.substr(0,20)+" ...":n;t.save();t.font=l.toString()+"px var(--syncytium-font)";t.translate(u+o+e*i,f+2);t.rotate(-Math.PI/4);t.textAlign="right";t.fillStyle="#000000";t.fillText(n,0,l);t.restore()}}}constructor(n,t,i,r,u,f,e,o){super(n,t,"board_chart_multi "+i?i:"",r,u,f);this._chartType=e===null||e===undefined?GUI.Board.BoardChartMultiData.LINE:e;this._series=[];this._data=[];this._values={};this._maxValue=0;this._showXAxis=o===null||o===undefined||o;this._nbSteps=1}});GUI.Board.BoardChartBar=(class extends GUI.Board.BoardChartMultiData{constructor(n,t,i,r,u,f){super(n,t,"board_chart_bar",i,r,u,GUI.Board.BoardChartMultiData.BAR,f)}});GUI.Board.BoardChartLine=(class extends GUI.Board.BoardChartMultiData{constructor(n,t,i,r,u,f){super(n,t,"board_chart_line",i,r,u,GUI.Board.BoardChartMultiData.LINE,f)}});GUI.Board.BoardChartPie=(class extends GUI.Board.BoardChart{createChart(){return new webix.ui({view:"chart",type:"pie",css:"webix_board_pie",container:this.TableZone[0],value:"#value#",color:"#color#",shadow:!1,border:!1,borderless:!0,tooltip:{template:"#value#"},pieInnerText:"<div class='webix_pieInnerText'>#percentage#<\/div>",legend:{values:this.Legends,align:"left",layout:"y"},data:this._data})}drawWebix(){this._data=[];this._values={};this._indicator={};for(let n in this.Legends){let t={id:n,value:0,color:this.Legends[n].color,percentage:0};this._data.push(t);this._values[this.Legends[n].id]=t;this._indicator[this.Legends[n].id]=0}return this.createChart()}computeIndicator(){return this.newIndicator()}async populateWebix(){function r(n){return function(t){n.updateIndicator(n.computeIndicator(t),null,!1)}}let n=0;for(await super.populateWebix(),this._indicator=this.newIndicator(),this.List.each(r(this)),n=0;n<this.Legends.length;n++)this.setValue(this.Legends[n].id,this._indicator[this.Legends[n].id]);let t=0;for(n=0;n<this._data.length;n++)t+=this._data[n].value;let i=0;for(n=0;n<this._data.length;n++)this._data[n].value>0?(i+=this._data[n].value,this._data[n].percentage=(Math.ceil(i*100/t)-Math.ceil((i-this._data[n].value)*100/t)).toString()):this._data[n].percentage="0",this._data[n].percentage+="%"}async adjustWebix(){if(this.Webix!==null){let i=this.TableZone,n=i.width(),t=i.height();this.Webix.config.width=n;this.Webix.config.height=t;this.Webix.config.x=n/2;this.Webix.config.y=t/2;this.Webix.config.radius=(n<t?n:t)/2-5;this.Webix.resize();await super.adjustWebix()}}setValue(n,t){if(this._values[n]!==null&&this._values[n]!==undefined){let i=0;i=typeof t=="string"?String.parseFloat(t):typeof t=="number"?t:0;i<0&&(i=0);this._values[n].value=i}}async updateIndicator(n,t,i){let f=!1,r=null,u=null;if(i=i===null||i===undefined||i,n!==null&&n!==undefined&&t!==null&&t!==undefined)for(r=0;r<this.Legends.length;r++)(u=n[this.Legends[r].id]-t[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]+=u);else if(n!==null&&n!==undefined)for(r=0;r<this.Legends.length;r++)(u=n[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]+=u);else if(t!==null||t!==undefined)for(r=0;r<this.Legends.length;r++)(u=t[this.Legends[r].id],u!==0)&&(f=!0,this._indicator[this.Legends[r].id]-=u);f&&i&&(await this.populateWebix(),await this.adjustWebix())}onOpen(){function t(n){return async function(){n.refresh();await n.populateWebix();await n.adjustWebix()}}function n(n){return function(t,i,r,u,f){let e=null,o=null;switch(t){case"onCreate":e=n.computeIndicator(u);break;case"onUpdate":o=n.computeIndicator(u);e=n.computeIndicator(f);break;case"onDelete":o=n.computeIndicator(u)}n.debug("Handle event ("+t+","+i+") : "+String.JSONStringify(o)+" - "+String.JSONStringify(e));n.updateIndicator(e,o)}}this.List.on("onLoad",t(this));this.List.on("onCreate",n(this));this.List.on("onUpdate",n(this));this.List.on("onDelete",n(this));super.onOpen()}onClose(){super.onClose();this.List.unbind("onCreate");this.List.unbind("onUpdate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}drawCanvas(n,t){let i=0,r=0;for(i=0;i<this._data.length;i++)r+=this._data[i].value;let u=(n.height>n.width/2?n.width/2:n.height)/2,f=u,e=u;if(r>0){let n=1.5*Math.PI;for(i=0;i<this._data.length;i++)t.fillStyle=this._data[i].color,t.beginPath(),t.moveTo(f,e),t.arc(f,e,u*.9,n,n+Math.PI*2*(this._data[i].value/r),!1),t.lineTo(f,e),t.fill(),n+=Math.PI*2*(this._data[i].value/r);for(n=1.5*Math.PI,i=0;i<this._data.length;i++)if(n+=Math.PI*2*(this._data[i].value/r),this._data[i].value>0){let o=u*.5*Math.cos(n-Math.PI*2*(this._data[i].value/r)/2),s=u*.5*Math.sin(n-Math.PI*2*(this._data[i].value/r)/2);t.font="22px var(--syncytium-font)";t.fillStyle="#eeeeee";t.textAlign="center";t.fillText(this._data[i].percentage,f+o,e+s)}}else{let r=String.parseRGBToHEX($("body").css("color")),n=$("<webix id='"+this.Name+"' class='default_color'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass);let i=n.appendTo("body");t.fillStyle=String.parseRGBToHEX(n.css("color"));i.remove();t.beginPath();t.moveTo(f,e);t.arc(f,e,u,0,Math.PI*2);t.fill()}if(this.Legends.length>0){let u=n.width/4,r=n.height/6,f=Math.ceil(this.Legends.length/2),e=n.width/2,o=(n.height-f*r)/2;for(i=0;i<this.Legends.length;i++){let l=this._values[this.Legends[i].id].value,h=e+i%2*u,c=o+Math.floor(i/2)*r,n=r/2,f=h+n+n*.4,s=c+n;t.fillStyle=this.Legends[i].color;t.beginPath();t.moveTo(f,s);t.arc(f,s,n*.4,0,Math.PI*2);t.lineTo(f,s);t.fill();t.font="20px var(--syncytium-font)";t.fillStyle="#666666";t.textAlign="left";t.fillText(Language.Manager.Instance.interpolation(this.Legends[i].label)+" ("+l.toString()+")",h+2*n,c+r/2+7)}}}constructor(n,t,i,r,u){super(n,t,"board_chart_pie",i,r,u);this._indicator={};this._data=[];this._values={}}});GUI.Board.BoardSocialNetwork=(class extends GUI.Board.Board{set Item(n){this.List.Item=n}get Item(){return this.List.Item}buildComment(n,t){let r=t!==undefined?t:this.List.getId(n),i="";for(let n of n.Comment.split("\n"))i+=(i===""?"":"<br />")+String.encode(n);let u="";if(n.AuthorId===DSDatabase.Instance.CurrentUser.Id)u="<div class='empty'><\/div><div class='comment me'>"+i+"<\/div><div class='delete' id='"+r+"'><\/div>";else{List.ListRecord.SetExtendedFields(this.List,n);let t=n.Author===null||n.Author.Picture===null?UserRecord.DEFAULT_PICTURE().picture:n.Author.Picture,f=n.Author===null?"":String.encode(n.Author.Name),e=UserRecord.IsAdministrator()?"<div class='delete' id='"+r+"'><\/div>":"";u="<div class='picture' name='"+f+"'><img src='"+t+"'><\/div><div class='comment'>"+i+"<\/div>"+e+"<div class='empty'><\/div>"}return"<div id='"+r+"'><div class='date'>"+n.Date.format("dddd D MMMM YYYY HH:mm:ss")+"<\/div><div class='message'>"+u+"<\/div><\/div>"}drawWebix(n){return n.append('<div id="author"><div id="picture"><img><\/div><div id="name"><\/div><\/div><div id="comments"><\/div><div id="message"><textarea id="text"><\/textarea><div id="ok"><\/div><\/div>'),null}refresh(){if(super.refresh(),this.Component!==null){let n=DSDatabase.Instance.CurrentUser;this.Component.find("#author > #picture > img")[0].src=n===null||n.Picture===null?UserRecord.DEFAULT_PICTURE().picture:n.Picture;this.Component.find("#author > #name").html(String.encode(n.Name));this.Component.find("#message > #ok").html(Helper.Span("BTN_OK"));this.Box!==null&&this.Box!==undefined&&this.Box.Mode===GUI.Box.BoxRecord.MODE_DELETE?this.Component.find("#message").hide():this.Component.find("#message").show()}}refreshDiscussion(){function n(n){return async function(){let t=$(this).attr("id");GUI.Box.Message.Message(n._title,"MSG_CONFIRMATION_DELETE",()=>{if(t<0){let i=-t-2,r=GUI.Board.BoardSocialNetwork.Queue[n._table][i][1];GUI.Board.BoardSocialNetwork.Queue[n._table].splice(i,1);n.List.raise("onDelete",n.List.Table,t,r)}else{let i=n.List.getItem(t);if(i===null||i===undefined)return;DSDatabase.Instance.deleteFromClient(n.List.Table,i,new Errors);await DSDatabase.Instance.commit()}})}}this.Component.find("#comments").scrollTop(this.Component.find("#comments")[0].scrollHeight);this.Component.find("#comments .message > .picture").hover(function(){$('<p class="image webix_tooltip"><\/p>').html($(this).attr("name")).appendTo("body").fadeIn("slow")},function(){$(".image.webix_tooltip").remove()}).mousemove(function(n){let t=n.pageX-10-$(".image.webix_tooltip").width(),i=n.pageY;$(".image.webix_tooltip").css({top:i,left:t})});this.Component.find("#comments .message .delete").off("click").on("click",n(this))}async populateWebix(){await super.populateWebix();let n=[];if(this.Item!==null&&this.Item!==undefined&&this.Item._subLists!==null&&this.Item._subLists!==undefined&&this.Item._subLists.Comments!==null&&this.Item._subLists.Comments!==undefined){let i=List.ListRecord.CACHE_LIST(this._table),r=i.getKey(this.Item),t=-2;for(let i of GUI.Board.BoardSocialNetwork.Queue[this._table])i[0]===r&&n.push([i[1],t]),t--;this.Item._subLists.Comments.values=null;for(let t of Array.toIterable(this.Item.Comments))n.push([t,this.Item._subLists.Comments.list.getId(t)])}n.sort((n,t)=>Dates.Compare(n[0].Date,t[0].Date));this.Component.find("#comments").empty();let t="";for(let n of n)t+=this.buildComment(n[0],n[1]);this.Component.find("#comments").append(t);this.refreshDiscussion()}addRow(n,t,i,r){this.IsDebug&&this.debug("Add comment (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")");this.Component.find("#comments").append(this.buildComment(r,i));this.refreshDiscussion()}deleteRow(n,t,i,r){this.IsDebug&&this.debug("Delete comment (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")");this.Component.find("#comments > #"+i).remove();this.refreshDiscussion()}onOpen(){function n(n){return function(){n.Readonly||n.Box!==null&&n.Box.setFocus(n)}}function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),!0;case"Escape":return t.stopImmediatePropagation(),!1}}}function i(n){return async function(){let i=String.decode(n.Component.find("#message > #text").val());if(!String.isEmptyOrWhiteSpaces(i)){let t=n.List.NewItem;if(t[n._table+"Id"]=n.List.getId(n.Item),t.Date=new moment,t.AuthorId=DSDatabase.Instance.CurrentUser.Id,t.Comment=i,n.List.getId(n.Item)<0){let i=List.ListRecord.CACHE_LIST(n._table);if(i===null)return;GUI.Board.BoardSocialNetwork.Queue[n._table].push([i.getKey(n.Item),t]);n.List.raise("onCreate",n.List.Table,-GUI.Board.BoardSocialNetwork.Queue[n._table].length-1,t)}else DSDatabase.Instance.addFromClient(n.List.Table,t,new Errors),await DSDatabase.Instance.commit();n.Component.find("#message > #text").val("")}}}function r(n){return async function(t,i,r,u){if(GUI.Board.BoardSocialNetwork.Queue!==undefined&&GUI.Board.BoardSocialNetwork.Queue[i]!==undefined&&!Array.isEmpty(GUI.Board.BoardSocialNetwork.Queue[i])){let f=List.ListRecord.CACHE_LIST(i);if(f!==null){List.ListRecord.SetExtendedFields(f,u);let o=f.getKey(u),s=GUI.Board.BoardSocialNetwork.Queue[i],e=[];for(let t of s)if(t[0]===o){let i=new Errors;t[1][n._table+"Id"]=r;DSDatabase.Instance.addFromClient(n.List.Table,t[1],i);i.HasError&&n.warn(i.toString())}else e.push(t);GUI.Board.BoardSocialNetwork.Queue[i]=e;await DSDatabase.Instance.commit()}}}}function u(n){return function(t,i,r,u){u[n._table+"Id"]===n.List.getId(n.Item)&&n.addRow(t,i,r,u)}}function f(n){return function(t,i,r,u){u[n._table+"Id"]===n.List.getId(n.Item)&&n.deleteRow(t,i,r,u)}}function e(n){return async function(){n.refresh();await n.populateWebix();await n.adjustWebix()}}super.onOpen();this.Component.find("#message > #text").on("focus",n(this));this.Component.find("#message > #text").on("keydown",t(this));this.Component.find("#message > #ok").on("click",i(this));GUI.Board.BoardSocialNetwork.Queue[this._table]===undefined&&(GUI.Board.BoardSocialNetwork.Queue[this._table]=[],DSDatabase.Instance.addEventListener("onCreate",this._table,"*",r(this)));this.List.on("onCreate",u(this));this.List.on("onDelete",f(this));this.List.on("onLoad",e(this));this.List.onOpen()}onClose(){super.onClose();this.Component.find("#comments .message .delete").off("click");this.Component.find("#message > #text").off("focus keydown");this.Component.find("#message > #ok").off("click");this.List.unbind("onCreate");this.List.unbind("onDelete");this.List.unbind("onLoad");this.List.onClose()}constructor(n,t,i,r){super(n,t,"board_social_network",i,new List.ListRecord("Comment"+r),GUI.Board.BOARD_NONE);this.draw();this.Component.addClass("socialnetwork");this._table=r;GUI.Board.BoardSocialNetwork.Queue===undefined&&(GUI.Board.BoardSocialNetwork.Queue={})}});GUI.Board.BoardTable=(class extends GUI.Board.Board{static get COLUMN_SELECT(){return"_select"}static handleClickBoolean(n,t){return async function(i,r,u){let e=n.List.getItem(i,!0);if(e!==null){let f=DSRecord.Clone(e);f[u]=t===!0?f[u]===null?!0:f[u]===!0?!1:null:f[u]===!0?!1:!0;await n.updateItem(e,f)}}}static handleChangeText(n,t,i){return async function(r,u,f){function e(t){return async function(i){let r=n.List.getItem(t,!0);if(r!==null){let u=DSRecord.Clone(r);return u[f]=String.isEmptyOrWhiteSpaces(i)?null:i,await n.updateItem(r,u),!0}}}GUI.Box.BoxInputText.Open(Helper.Label(t,n.List.getText(u)),i,u[f],!1,e(r))}}static handleChangeDigit(n,t,i,r,u){return function(f,e,o){function l(t,i){return async function(){let r=n.List.getItem(t,!0);if(r!==null){let f=DSRecord.Clone(r);return f[o]=u===null||u===undefined?i.Value:u(i),await n.updateItem(r,f),!0}}}let c=null,h=DSDatabase.Instance.getColumn(n.List.Table,o);h!==null&&(c=h.DatetimeFormat);h!==null&&c===null&&(c=h.StringFormat);let s=null;if(c!==null&&(s=Digits.Digits.Factory(c)),s===null&&(s=h.Digit),s===null){handleChangeText(n,t,i)(f,e,o);return}s.Value=e[o];GUI.Box.BoxInputDigit.Digit(Helper.Label(t,n.List.getText(e)),i,h.Unit,s,r===null||r===undefined?"center":r,l(f,s))}}static handleChangeSelect(n,t,i,r,u,f){return async function(e,o,s){function c(t,i){return async function(){let r=n.List.getItem(t,!0);if(r!==null){let u=DSRecord.Clone(r);return u[s]=i,await n.updateItem(r,u),!0}}}let h=[];u===!0&&h.push({label:"SELECT_VALUE_NULL",fn:c(e,null)});for(let n of r.getListSorted())o[s]!==r.getId(n)&&(f===null||f===undefined||f(e,o,s,n))&&h.push({label:r.getText(n),fn:c(e,r.getId(n))});h.length>0&&GUI.Box.BoxChoice.BoxChoices(Helper.Label(t,n.List.getText(o)),i,h)}}static handleChangeSelectImage(n,t,i,r,u,f){return async function(e,o,s){function h(t){return async function(i){let r=n.List.getItem(t,!0);if(r!==null){let u=DSRecord.Clone(r);return u[s]=i,await n.updateItem(r,u),!0}}}GUI.Box.BoxSelect.Open(Helper.Label(t,n.List.getText(o)),i,o[s],r,u,h(e));GUI.Box.BoxSelect.Instance.AllowNullValue=f===!0}}handleUpdateRows(n,t,i,r){function u(n){return async function(u,f,e){function*o(n){let u=[];yield GUI.Box.Progress.Status(0,1,"MSG_REFRESHING");n.Webix.eachRow(r=>{let f=n.getItem(r);f!==null&&f!==undefined&&f.item&&(i||f.item[t]===e)&&(!i||i(f.item,e))&&u.push(r)});n.info("Refreshing "+u.length+" lines ...");yield GUI.Box.Progress.Status(0,u.length);for(let i of u)n.refreshRow(i,r===undefined?[t]:r),yield GUI.Box.Progress.Status()}n.Webix!==null&&n.isFieldVisible(t,DSDatabase.Instance.CurrentUser)&&await GUI.Box.Progress.Thread(o(n),1e3,!1,!1)}}this._keepListEvents?this._alreadyOpened||(DSDatabase.Instance.addEventListener("onUpdate",n,"*",u(this)),DSDatabase.Instance.addEventListener("onDelete",n,"*",u(this))):(this.addListener(DSDatabase.Instance.addEventListener("onUpdate",n,"*",u(this))),this.addListener(DSDatabase.Instance.addEventListener("onDelete",n,"*",u(this))))}get ColumnsVisible(){if(this.Webix===null)return[];let n=[];for(let t of Array.toIterable(this.Webix.config.columns))this.Webix.isColumnVisible(t.id)&&n.push(t.id);return n}get Columns(){return this._columns}get ColumnSortedByDefault(){let n=this.ColumnsVisible;return n.length>0?[n[0],"asc"]:null}set MultiSelection(n){if(this._multiselect=n!==null&&n!==undefined&&n,this.Webix!==null&&this.Webix.isColumnVisible(GUI.Board.BoardTable.COLUMN_SELECT)!==this._multiselect)try{this._multiselect?this.Webix.showColumn(GUI.Board.BoardTable.COLUMN_SELECT):this.Webix.hideColumn(GUI.Board.BoardTable.COLUMN_SELECT)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",t)}}get Multiselection(){return this._multiselect}set KeepListEvents(n){this._keepListEvents=String.convertBoolean(n)}get KeepListEvents(){return this._keepListEvents}destructor(){super.destructor();this._webixAdjustedZone!==null&&(this._webixAdjustedZone.remove(),this._webixAdjustedZone=null,this._webixAdjustedZoneHTML=null)}async show(){await super.show();this._alreadyOpened=!0}getHTML(n,t,i){if(n===GUI.Board.BoardTable.COLUMN_SELECT)return"<div class='"+GUI.Board.BoardTable.COLUMN_SELECT+"'><div class='"+(i._select?"selected":"unselected")+"'><\/div><\/div>";let r="",u=i.item!==undefined&&i.item!==null?i.item:this.List.getItem(i.id,!0);return u===null||!this.isFieldVisible(n,t,u)?"":(this.List.isAttributDeleted(u,n)&&(r="deleted"),this.isFieldReadonly(n,t,u)&&(r=r+(r===""?"":" ")+"readonly"),i._select&&(r=r+(r===""?"":" ")+"selected"),r=r+(r===""?"":" ")+n.toLowerCase(),"<div class='"+r+"'>"+this.List.getAttributHTML(u,n)+"<\/div>")}declareColumn(n,t,i,r,u,f,e){function s(n,t){return function(i,r){for(let t of t){n._webixCacheValue[i.id]===undefined&&(n._webixCacheValue[i.id]={});n._webixCacheValue[r.id]===undefined&&(n._webixCacheValue[r.id]={});let u=n._webixCacheValue[i.id][t];u===undefined&&(u=n.List.getAttributValue(n.List.getItem(i.id),t),n._webixCacheValue[i.id][t]=u);let f=n._webixCacheValue[r.id][t];if(f===undefined&&(f=n.List.getAttributValue(n.List.getItem(r.id),t),n._webixCacheValue[r.id][t]=f),u!==null||f!==null){if(u===null)return-1;if(f===null)return 1;if(Array.isArray(u)&&Array.isArray(f)){if(u.length<f.length)return-1;if(u.length>f.length)return 1;for(let n=0;n<u.length;n++)if(u[n]!==null||f[n]!==null){if(u[n]===null)return-1;if(f[n]===null||u[n]>f[n])return 1;if(u[n]<f[n])return-1}continue}if(u>f)return 1;if(u<f)return-1}}return 0}}function c(n,t,i){return function(r){n._webixCacheHTML[r.id]===undefined&&(n._webixCacheHTML[r.id]={});let u=[r._select,t];if(n._webixCacheHTML[r.id][u]!==undefined)return n._webixCacheHTML[r.id][u];let f=String.internal(n.getHTML(t,i,r));return n._webixCacheHTML[r.id][u]=f,f}}let o={};o.id=n;o.header={header:t,text:Helper.Span(t),height:20};o.fillspace=i;o.css={"text-align":r?r:"left"};o.template=c(this,n,DSDatabase.Instance.CurrentUser);o.sort=u===undefined||u===null||typeof u=="boolean"&&u?s(this,[n]):typeof u=="string"?s(this,[n,u]):Array.isArray(u)?s(this,[n].concat(u)):!1;this._columns.push(o);let h={title:t,field:n,size:i,align:r?r:"left"};return f!==null&&f!==undefined&&e!==null&&e!==undefined&&(h.width=f,h.height=e),this._pdfColumns.push(h),this.debug("Declare column '"+n+"'"),o}showColumn(n){if(this.Webix!==null&&n!==GUI.Board.BoardTable.COLUMN_SELECT)try{this.Webix.showColumn(n)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",t)}}hideColumn(n){if(this.Webix!==null&&n!==GUI.Board.BoardTable.COLUMN_SELECT)try{this.Webix.hideColumn(n)}catch(t){this.IsVerbose&&this.exception("[Verbose] An exception occurs on hiding the column",t)}}focus(){return(this.verbose("focus"),this.Component===null||this._tabIndex===null||!this.Visible||this.Readonly)?!1:this.Webix===null||this.Webix===undefined?!1:(this.Webix.getFirstId()===undefined?this.Component.focus():(!this.Webix.getSelectedItem()&&this.Webix.getFirstId()&&this.Webix.select(this.Webix.getFirstId()),webix.UIManager.setFocus(this.Webix)),!0)}isFieldVisible(n,t,i){if(!this.List.isBoardFieldVisible(this,n,t,i))return!1;if(this.List.ListParent===null||this.List.ListParent===undefined||this.List.ListParent.getListValues===undefined)return!0;let r=this.List.ListParent.getListValues(this.List.Column);return r===null?this.List.isBoardFieldVisible(this,n,t,i):n!==r.column}isFieldReadonly(n,t,i){return this.List.isBoardFieldReadonly(this,n,t,i)}isAllowed(n,t,i){return this.List.isBoardAllowed(this,n,t,i)}onOpen(){function n(n){return function(t,i,r,u){n.addRow(t,i,r,u)}}function t(n){return function(t,i,r,u,f){n.updateRow(t,i,r,u,f)}}function i(n){return function(t,i,r,u){n.deleteRow(t,i,r,u)}}function r(n){return async function(){n.refresh();await n.populateWebix();await n.adjustWebix()}}if(super.onOpen(),!this._listEvents){this.List.on("onCreate",n(this));this.List.on("onUpdate",t(this));this.List.on("onDelete",i(this));this.List.on("onLoad",r(this));this.List.onOpen();this._listEvents=!0}}onClose(){super.onClose();this._keepListEvents||(this.List.unbind("onCreate"),this.List.unbind("onUpdate"),this.List.unbind("onDelete"),this.List.unbind("onLoad"),this.List.onClose(),this._listEvents=!1)}refresh(){if(super.refresh(),this.Webix!==null){if(this.Webix.isColumnVisible(GUI.Board.BoardTable.COLUMN_SELECT)!==this._multiselect)try{this._multiselect?this.Webix.showColumn(GUI.Board.BoardTable.COLUMN_SELECT):this.Webix.hideColumn(GUI.Board.BoardTable.COLUMN_SELECT)}catch(n){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",n)}for(let n of this._columns){let t=this.isFieldVisible(n.id);this.Webix.isColumnVisible(n.id)!==t&&t&&this.showColumn(n.id)}for(let n of this._columns){let t=this.isFieldVisible(n.id);this.Webix.isColumnVisible(n.id)===t||t||this.hideColumn(n.id)}}}refreshRow(n,t){let i=this.getItem(n);if(i!==null&&i!==undefined&&i.item){if(t===undefined||t===null)this._webixCacheHTML[n]={},this._webixCacheValue[n]={};else for(let t of Array.toIterable(t))if(this._webixCacheValue[n]!==undefined&&(this._webixCacheValue[n][t]=undefined),this._webixCacheHTML[n]!==undefined)for(let i of[undefined,!0,!1])this._webixCacheHTML[n][[i,t]]=undefined;this.Webix.isVisible()&&this.IsOpened&&(List.ListRecord.CleanUpExtendedFields(i.item),this.Webix.refresh(n))}}addRow(n,t,i,r){if(this.Webix!==null&&(r=List.ListRecord.SetExtendedFields(this.List,r),this.List.isVisible(r))){this.IsDebug&&this.debug("Add row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")");let u={};if(u.id=this.List.getId(r).toString(),u._select=!1,this._webixCacheHTML[u.id]={},this._webixCacheValue[u.id]={},this.Webix.isVisible()&&this.IsOpened){this.Webix.blockEvent();this.Webix.add(u,-1);this.Webix.unblockEvent();this.adjustWebix(u.id);let f=this.Webix.getState();f&&f.sort&&this.sort(f.sort.id,f.sort.dir);let e=this.getEvent("onUpdate");e&&e()}}}updateRow(n,t,i,r,u){if(this.Webix!==null){r=List.ListRecord.SetExtendedFields(this.List,r);u=List.ListRecord.SetExtendedFields(this.List,u);let o=this.getItem(this.List.getId(r).toString())!==undefined,s=this.List.isVisible(u);if(o||s){if(o&&!s){this.deleteRow(n,t,i,r);return}if(!o&&s){this.addRow(n,t,i,u);return}this.IsDebug&&this.debug("Update row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(u)+")");let f={};f.id=this.List.getId(r).toString();let h=this.getItem(f.id);if(f._select=h!==null?h._select:!1,this._webixCacheHTML[f.id]={},this._webixCacheValue[f.id]={},this.Webix.isVisible()&&this.IsOpened){this.Webix.blockEvent();this.Webix.updateItem(f.id,f);this.Webix.unblockEvent();this.adjustWebix(f.id);let e=this.Webix.getState();e&&e.sort&&this.sort(e.sort.id,e.sort.dir);let c=this.getEvent("onUpdate");c&&c()}}}}deleteRow(n,t,i,r){if(this.Webix!==null){this.IsDebug&&this.debug("Delete row (table = '"+t+"', id = "+i+", record = "+String.JSONStringify(r)+")");let u={};if(u.id=this.List.getId(r).toString(),u._select=!1,this._webixCacheHTML[u.id]={},this._webixCacheValue[u.id]={},this.Webix.isVisible()&&this.IsOpened){this.Webix.blockEvent();this.Webix.remove(u.id);this.Webix.unblockEvent();let f=this.getEvent("onUpdate");f&&f()}}}async adjustWebix(n){function t(n,t,i){if(i!==null&&i!==undefined){let u=n.Webix.isSelected(i.id),f=!0,r=1;for(let e=0;e<t.length;e++){let s=n.Webix.getColumnConfig(t[e]),h=n.Webix.getText(i.id,s.id),c=[u,s.id,h],o=n._webixCacheHeight[c];o===undefined&&(f&&(u?$(n._webixAdjustedZoneHTML).addClass("webix_row_select"):$(n._webixAdjustedZoneHTML).removeClass("webix_row_select"),f=!1),$(n._webixAdjustedZoneHTML).css("width",s.width+"px"),$(n._webixAdjustedZoneHTML).css("height","1px"),n._webixAdjustedZoneHTML.innerHTML=h,o=n._webixAdjustedZoneHTML.scrollHeight+4,n._webixCacheHeight[c]=o,n._webixAdjustedZoneHTML.innerHTML="");r<o&&(r=o)}i.$height=r}}function*i(n){yield GUI.Box.Progress.Status(0,1,"MSG_REFRESHING");n.verbose("Getting rows to update ...");let i=[];n.Webix.data.each(n=>i.push(n));yield GUI.Box.Progress.Status(1,i.length+1);n.verbose("Updating "+i.length+" rows ...");let r=n.ColumnsVisible;for(let i of i)t(n,r,i),yield GUI.Box.Progress.Status();n.verbose("Refreshing Webix table ...");n.Webix.refresh();n.Webix.unblockEvent();n.verbose("End of adjusting Webix table ...")}if(this.Webix!==null){let n=this.TableZone,t=Math.floor(n.width()),i=Math.floor(n.height());(t!==this._webix.config.width||i!==this._webix.config.height)&&(this.debug("Clean up webix cache to compute height"),this._webixCacheHeight={})}if(n===null||n===undefined?await super.adjustWebix():this.verbose("Adjust row : "+n.toString()),this.Webix!==null&&this._adjustWebixEnable){if(this._webixAdjustedZone===null){this._webixAdjustedZone=$("<div class='webix_view webix_dtable'><div class='webix_ss_body'><div class='webix_ss_center'><div class='webix_ss_center_scroll'><div class='webix_column'><div class='webix_cell'><\/div><\/div><\/div><\/div><\/div><\/div>");let n="webix_board";this.CSSClass&&(n+=" "+("webix_"+this.CSSClass).split(" ").join(" webix_"));this._webixAdjustedZone.addClass(n);this._webixAdjustedZone.css("visibility","hidden");$(this.Webix.$view).append(this._webixAdjustedZone);this._webixAdjustedZoneHTML=this._webixAdjustedZone.find("> div > div > div > div > div")[0]}this.Webix.blockEvent();n!==null&&n!==undefined?(t(this,this.ColumnsVisible,this.getItem(n,!1)),this.Webix.refresh(n),this.Webix.unblockEvent()):await GUI.Box.Progress.Thread(i(this),1e3,!1,!1)}}draw(){function n(n){return function(){GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.List.Table,null,n.List).createRecord()}}function t(n){return function(t){t!==null&&GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.List.Table,null,n.List).deleteRecord(t)}}if(this.declareColumn(GUI.Board.BoardTable.COLUMN_SELECT,null,1,"center",!1),this.declareColumns(),super.draw(),this.List instanceof List.ListRecord||this.List instanceof List.ListArrayRecord){this.on("add",n(this));this.on("delete",t(this))}}async populateWebix(){function*n(n){yield GUI.Box.Progress.Status(0,1,"MSG_LOADING");let r=n.Webix.isVisible();n.verbose("Cleaning Webix table ...");n.Webix.blockEvent();n.Webix.hide();n.Webix.clearAll();let i=[];n.List.each(n=>i.push(n));n.verbose("Adding "+i.length+" items and evaluating items (HTML and Value) ...");yield GUI.Box.Progress.Status(0,i.length+2);for(let t of i){let i={};i.id=n.List.getId(t);i.item=t;i._select=!1;for(let r of n._columns){n._webixCacheHTML[i.id]===undefined&&(n._webixCacheHTML[i.id]={});let u=[!1,r.id];if(n._webixCacheHTML[i.id][u]===undefined&&(n._webixCacheHTML[i.id][u]=String.internal(n.getHTML(r.id,DSDatabase.Instance.CurrentUser,i))),n._webixCacheValue[i.id]===undefined&&(n._webixCacheValue[i.id]={}),n._webixCacheValue[i.id][r.id]===undefined){let u=n.List.getAttributValue(t,r.id);n._webixCacheValue[i.id][r.id]=typeof u=="string"?String.internal(u):u}}delete i.item;n.Webix.add(i,-1);List.ListRecord.CleanUpExtendedFields(t);yield GUI.Box.Progress.Status()}n.verbose("Sorting Webix table ...");let t=n.ColumnSortedByDefault;typeof t=="string"?n.sort(t):Array.isArray(t)&&n.sort(t[0],t[1]);yield GUI.Box.Progress.Status();n.verbose("Showing Webix table ...");n.Webix.unblockEvent();r&&n.Webix.show();n.Webix.showItemByIndex(0);n.verbose("End of populate Webix table ...");yield GUI.Box.Progress.Status()}(await super.populateWebix(),this.Webix!==null)&&await GUI.Box.Progress.Thread(n(this),200,!0,!1)}drawWebix(n){function f(n){return async function(t,i,r,u){n.Visible&&u&&(n.debug("Resizing column ..."),n._webixCacheHeight={},await n.adjustWebix())}}function e(n){return function(){n.onUpdate()}}function o(n){return function(t){if(t.column===GUI.Board.BoardTable.COLUMN_SELECT&&n._multiselect){n.isSelectedItem(t)?n.unselectItem(t):n.selectItem(t);return}if(!n.Readonly){let r=n.getEvent("onClick"+t.column);if(r){let i=n.getItem(t);if(i){let u=DSDatabase.Instance.CurrentUser;n.isAllowed(u,"onClick"+t.column,i.item)&&!n.isFieldReadonly(t.column,u,i.item)&&(n.debug("Raise event(onClick"+t.column+","+i.id+")"),r(i.id,i.item,t.column))}}}}}function s(n){return function(t,i){let u=i.column.id===null||i.column.id===undefined?"ToolTip":i.column.id;if(u===GUI.Board.BoardTable.COLUMN_SELECT&&n._multiselect)return(t=n.getSelectedItem(),t===null)?"":Language.Manager.Instance.interpolation(Helper.Label("TABLE_"+(t._select===!0?"SELECTED":"UNSELECTED")));if(t===null||t===undefined||i===null||i===undefined)return"";let r=n.List.getItem(t.id,!0);if(r===null||r===undefined||i.column===null||i.column===undefined)return"";let f=n.List.getAttributToolTipHTML(r,u);if(typeof f=="boolean"&&f===!1)return"";if(Helper.IsLabel(f,!0))return Helper.Span(f);if(!String.isEmptyOrWhiteSpaces(f))return f;let e=null,o=n.List.getAttributHTML(r,u);return e=Helper.IsLabel(r[u],!0)?Helper.Span(r[u]):n.List.getAttributText(r,u),e===o||e===String.decode(o)?n.List.getAttributText(r,"ToolTip"):e}}function h(n){return function(t,i,r){let u,f;if(i!==undefined)for(u=0;u<n._columns.length;u++)for(f=0;f<n._columns[u].header.length;f++)n._columns[u].header[f].text!==""&&(n._columns[u].header[f].text=$(n._columns[u].header[f].text).each(Language.Manager.HandleReplacementKeyLabel(t,i,r))[0].outerHTML);else for(u=0;u<n._columns.length;u++)for(f=0;f<n._columns[u].header.length;f++)n._columns[u].header[f].text!==""&&(n._columns[u].header[f].text=$(n._columns[u].header[f].text).each(Language.Manager.HandleReplacementLabel(t))[0].outerHTML);try{n.Webix.refreshColumns()}catch(e){this.IsVerbose&&this.exception("[Verbose] An exception occurs on refreshing columns",e)}}}function c(n){return function(t,i){let r=null;switch(i.key){case"Tab":return i.stopImmediatePropagation(),i.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return i.stopImmediatePropagation(),n.onUpdate(),!1;case"Escape":return i.stopImmediatePropagation(),n.onButtonCancel(),!1;case"Delete":return i.stopImmediatePropagation(),n.onBoardDelete(),!1;case" ":return(i.stopImmediatePropagation(),!n._multiselect)?!1:(r=n.getSelectedItem(),r===null)?!1:(n.isSelectedItem(r.id)?n.unselectItem(r.id):n.selectItem(r.id),!1)}}}function l(n){return function(){let i=n.getEvent("onSelectChange");if(i){let t=this.getItem(n.Webix.getSelectedId(!0)),r=DSDatabase.Instance.CurrentUser;n.isAllowed(r,"onSelectChange",t?t.item:null)&&(n.debug("Raise event(onSelectChange,"+(t?t.id:"")+")"),t?i(t.id,t.item):i())}}}let t="webix_board";this.CSSClass&&(t+=" "+("webix_"+this.CSSClass).split(" ").join(" webix_"));let i=$("<div class='"+t+"'><div class='webix_cell'><\/div><\/div>");$("body > main").append(i);let r=parseInt(i.find(".webix_cell").css("font-size"));i.remove();Language.Manager.Instance.addListener(h(this));let u=[];for(let n of this._columns)u.push(n);return new webix.ui({view:"datatable",container:n[0],css:t,scroll:"y",scrollAlignY:!1,select:"row",tooltip:{template:s(this),css:t+"_tooltip"},columns:u,resizeColumn:!0,fixedRowHeight:!1,rowLineHeight:r,rowHeight:r,navigation:!0,editable:!0,data:[],on:{onColumnResize:f(this),onItemDblClick:e(this),onItemClick:o(this),onKeyPress:c(this),onSelectChange:l(this)}})}isSelectedItem(n){let t=this.getItem(n);return t===null?!1:t._select}selectItem(n){let t=this.getItem(n);t===null||t._select||(t._select=!0,this.Webix.refresh(t.id))}unselectItem(n){let t=this.getItem(n);t!==null&&t._select&&(t._select=!1,this.Webix.refresh(t.id))}getSelectedItems(){function t(n,t){return function(i){let r=n.getItem(i);r!==null&&r!==undefined&&r.item&&r._select&&t.push(r.item)}}let n=[];if(this._multiselect){if(this.Webix.eachRow(t(this,n)),n.length===0){let t=this.getSelectedItem();t!==null&&t.item!==null&&t.item!==undefined&&n.push(t.item)}}else{let t=this.getSelectedItem();t!==null&&t.item!==null&&t.item!==undefined&&n.push(t.item)}return n}getSelectedItem(){return this.getItem(this.Webix.getSelectedId())}getItem(n,t){if(n===undefined&&(n=this.Webix.getSelectedId()),String.isEmptyOrWhiteSpaces(n))return null;let i=this.Webix.getItem(n);return i===null||i===undefined?null:t===!1?i:{id:i.id,item:this.List.getItem(i.id,!0),_select:i._select}}onBoardIcon(){if(this.IsVisibleIcon){let t=this.getEvent("board");if(t!==null){let n=this.getSelectedItem();if(n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"board"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"board",n.item)&&t(n.id,n.item)}}}onBoardAdd(){if(this.IsVisibleAdd){let t=this.getEvent("add");if(t!==null){let n=this.getSelectedItem();if(n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"add",null))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"add",n.item)&&t(n.id,n.item)}}}onUpdate(){let n=this.getSelectedItem();if(n!==null){let i=this.getEvent("update"),t=GUI.Box.BoxRecord.CACHE_DIALOG_BOX(this.List.Table,null,this.List);if(i===null&&n!==null){t!==null&&(this.Readonly?this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(n.id):this.isAllowed(DSDatabase.Instance.CurrentUser,"update",n.item)?t.updateRecord(n.id):this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(n.id));return}if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"update",n.item)&&t!==null){this.isAllowed(DSDatabase.Instance.CurrentUser,"read",n.item)&&t.readRecord(n.id);return}n===null?i(null):i(n.id,n.item)}}onBoardCancel(){if(this.IsVisibleCancel){let t=this.getEvent("cancel");if(t!==null){let n=this.getSelectedItem();if(n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"cancel"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"cancel",n.item)&&t(n.id,n.item)}}}onBoardDelete(){if(this.IsVisibleDelete){let t=this.getEvent("delete");if(t!==null){let n=this.getSelectedItem();if(n===null){if(!this.isAllowed(DSDatabase.Instance.CurrentUser,"delete"))return;t(null);return}this.isAllowed(DSDatabase.Instance.CurrentUser,"delete",n.item)&&t(n.id,n.item)}}}sort(n,t){if(this.Webix!==null)for(let i=0;i<this._columns.length;i++){let r=this._columns[i];if(r.id===n&&r.sort!==!1){this.verbose("Sorting table by '"+n+"' ...");this.Webix.sort(r.sort,t===null||t===undefined?"asc":t);this.Webix.markSorting(n,t===null||t===undefined?"asc":t);return}}}declareColumns(){}toPDF(n){let t=[];for(let n of this._pdfColumns)this.Webix.isColumnVisible(n.field)&&t.push(n);return n.createTable(null,t,this.List),n}clearWebixCache(){super.clearWebixCache();this._webixCacheHTML={};this._webixCacheValue={}}constructor(n,t,i,r,u){super(n,t,"board_table",i,r,u);this._webixAdjustedZone=null;this._webixAdjustedZoneHTML=null;this._columns=[];this._pdfColumns=[];this._multiselect=!1;this._webixCacheHTML={};this._webixCacheValue={};this._webixCacheHeight={};this._alreadyOpened=!1;this._listEvents=!1;this._keepListEvents=!1}});GUI.Board.BoardTableAssociation=(class extends GUI.Board.BoardTable{declareColumns(){function n(n){return async function(t){let i=n.List.getItem(t,!0);if(i!==null){let r=DSRecord.Clone(i);r._selected?n.List.isBoardAllowed(n,DSDatabase.Instance.CurrentUser,"delete",i)&&await n.deleteItem(i):n.List.isBoardAllowed(n,DSDatabase.Instance.CurrentUser,"add",r)&&await n.addItem(r)}}}this.declareColumn("_selected",null,1,"center",!1);this.on("onClick_selected",n(this));super.declareColumns()}constructor(n,t,i,r,u){super(n,t,i,r,u)}});GUI.Board.BoardHistory=(class extends GUI.Board.BoardTable{get ColumnSortedByDefault(){return["Date","desc"]}declareColumns(n){this.declareColumn("User","HISTORY_HISTORYUSERID",5,"center","Id",20,20);this.declareColumn("Date","HISTORY_HISTORYDATE",5,"center","Id");this.declareColumn("Nature","HISTORY_HISTORYNATURE",5,"center","Id");n!==null&&n!==undefined&&n===!0&&this.declareColumn("Description","HISTORY_HISTORYDESCRIPTION",10,"center","Id");this.declareColumn("Field","HISTORY_HISTORYFIELD",7,null,"Id");this.declareColumn("OldValue","HISTORY_HISTORYOLDVALUE",9,null,"Id");this.declareColumn("NewValue","HISTORY_HISTORYNEWVALUE",9,null,"Id")}async adjustWebix(n){if(n!==undefined){await super.adjustWebix(n);return}let i=$(window).width(),t=-1;if(i<480?t=3:i<960&&(t=4),t!==this._nbColumnsToShow){let n=[];switch(t){case 3:n=["User","Date","Nature"];break;case 4:n=["User","Date","Nature","Description"];break;default:n=null}this.debug("Resizing and show a part of columns : "+String.JSONStringify(n));for(let t of this.Columns){let i=this.Webix.isColumnVisible(t.id),r=n===null?!0:n.indexOf(t.id)>=0;if(i!==r){if(i){this.hideColumn(t.id);continue}this.showColumn(t.id)}}this._nbColumnsToShow=t;(this._nbColumnsToShow<0&&!this.List.IsDetails||this._nbColumnsToShow>=0&&this.List.IsDetails)&&(this.List.setDetails(t<0),await this.populateWebix())}await super.adjustWebix()}set Item(n){this.List.Item=n}onUpdate(){let n=this.getSelectedItem();if(n!==null&&n.item!==null&&n.item!==undefined){let t=GUI.Box.BoxRecord.CACHE_DIALOG_BOX(this.List._list.Table,"History",this.List);t!==null&&t.readRecord(n.item.Item)}}constructor(n,t,i){super(n,t,"HISTORY_TITLE",i,GUI.Board.BOARD_NONE);this._nbColumnsToShow=-1;this.draw()}});GUI.Board.BoardTree=(class extends GUI.Board.Board{async adjustWebix(){(await super.adjustWebix(),this.Webix!==null)&&this.Webix.adjust()}constructor(n,t,i,r,u){super(n,t,"board_tree",i,r,u)}});GUI.Board.BoardImport=(class extends GUI.Board.Board{importFileIntoTable(n,t,i,r){function h(n,i,r,u,f){return async function(){GUI.Box.Progress.Stop(!0);f.HasError?(n.error("Data not imported into the table '"+t+"' due to "+f.toString()),await i.rollbackAsync().then(()=>{GUI.Box.Message.Error("TITLE_IMPORT",f)})):(n.info(r.RowAdded+" data added, "+r.RowUpdated+" data updated and "+r.RowDeleted+" data deleted into the table '"+t+"' ..."),await i.commitAsync().then(()=>{GUI.Box.Message.Information(Helper.Label("MSG_IMPORT_IMPORTED",[r.RowAdded,r.RowUpdated,u?r.RowDeleted:0,t]))}))}}function f(n,r,u,f,e){return async function(){let o=new Errors;await GUI.Box.Progress.Thread(u.toList(r,o,Helper.Label("MSG_IMPORT_PRELOADING",t),Helper.Label("MSG_IMPORT_CHECKING",t),Helper.Label("MSG_IMPORT_IMPORTING",t),Helper.Label("MSG_IMPORT_DELETING",t),!1,!0,f,e),i).then(h(n,r,u,f,o))}}function e(n,r,u,e){return async function(o){let s=new Errors;if(n.info("Importing data into the table '"+t+"' ..."),Array.isArray(o))for(let t of o)n.info("Completing data within the file '"+t.name+"' ...");await GUI.Box.Progress.Thread(u.toList(r,s,Helper.Label("MSG_IMPORT_PRELOADING",t),Helper.Label("MSG_IMPORT_CHECKING",t),Helper.Label("MSG_IMPORT_IMPORTING",t),Helper.Label("MSG_IMPORT_DELETING",t),!0,!1,e,o),i).then(()=>{GUI.Box.Progress.Stop(!0),s.HasError?(n.error("Data not imported into the table '"+t+"' due to "+s.toString()),GUI.Box.Message.Error("TITLE_IMPORT",s)):u.RowAdded!==0||u.RowUpdated!==0||u.RowDeleted!==0&&e?e?GUI.Box.Message.Message("TITLE_IMPORT",Helper.Label("MSG_CSV_IMPORTING_ALL",[u.RowAdded,u.RowUpdated,u.RowDeleted,n._fieldFile.Filename]),f(n,r,u,e,o)):GUI.Box.Message.Message("TITLE_IMPORT",Helper.Label("MSG_CSV_IMPORTING",[u.RowAdded,u.RowUpdated,n._fieldFile.Filename]),f(n,r,u,e,o)):GUI.Box.Message.Message("TITLE_IMPORT",Helper.Label("MSG_CSV_IMPORTING_NONE",n._fieldFile.Filename))})}}let u=this._fieldFile.File,o=this._fieldAll.Value,s=List.ListRecord.CACHE_LIST(t);if(!(u instanceof CSV)){GUI.Box.Message.Error("ERROR","ERR_FILE_MISSING");return}if(!Array.isArray(r)||Array.isEmpty(r)){e(this,s,u.copy(n),o)(r);return}this.info("Selecting "+r.length+" files before importing data into the table '"+t+"' ...");GUI.Box.BoxInputFilesCSV.Open("CSV_SELECT_FILES",null,r,e(this,s,u.copy(n),o))}declareImportationRecord(n,t,i,r,u){function e(n,t,i,r,u){return function(){n.importFileIntoTable(t,i,r,u)}}this.debug("Declare the importation record '"+t+"', '"+String.JSONStringify(i)+"' ("+n+")");let f=new GUI.Button.Button(this.Component.find("> .table > .buttons"),n,null,i,e(this,n,t,r,u));return this._buttons[f.Name]=f,f}drawWebix(n){return n.append("<div class='fields'><\/div><div class='buttons'><\/div>"),this._fieldFile=new GUI.Field.FieldFileCSV(n.find("> .fields"),"file",null),this._fieldAll=new GUI.Field.FieldCheckBox(n.find("> .fields"),"all","BTN_DELETE_ALL_LINES"),this._fieldAll.AllowNullValue=!1,this._fieldAll.Value=!1,null}refresh(){super.refresh();this._fieldFile.refresh();this._fieldAll.refresh();for(let n of Array.toIterable(this._buttons))n.refresh()}onOpen(){super.onOpen();this._fieldFile.onOpen();this._fieldAll.onOpen();for(let n of Array.toIterable(this._buttons))n.onOpen()}onClose(){this._fieldFile.onClose();this._fieldAll.onClose();for(let n of Array.toIterable(this._buttons))n.onClose();super.onClose()}constructor(n,t,i){super(n,t,"import",i?i:"TITLE_IMPORT",null,GUI.Board.BOARD_NONE);this._fieldFile=null;this._fieldAll=null;this._buttons=[];this.draw();this.Component.addClass("import")}});GUI.Box={};GUI.Box.BOX_RC=!1;GUI.Box.ExportCSVFile=null;GUI.Box.Box=(class extends GUI.GUI{static get MAIN_PAGE(){return"body > dialog"}static get BUTTON_FIRST(){return"FIRST"}static get BUTTON_PREVIOUS(){return"PREVIOUS"}static get BUTTON_OK(){return"OK"}static get BUTTON_CANCEL(){return"CANCEL"}static get BUTTON_CLOSE(){return"CLOSE"}static get BUTTON_LAST(){return"LAST"}static get BUTTON_CLIPBOARD(){return"CLIPBOARD"}static get BUTTON_SEARCH(){return"SEARCH"}static get BUTTON_NEXT(){return"NEXT"}static get StackIndex(){return this._stackBoxIndex?this._stackBoxIndex++:this._stackBoxIndex=1,this._stackBoxIndex}static get Stack(){return this._stackBox||(this._stackBox=[]),this._stackBox}static GetLastOpenedBox(){let n=null,t=0;for(let i of Array.toIterable(GUI.Box.Box.Stack))t<i._zIndex&&(t=i._zIndex,n=i);return n}get ContentZone(){return this.Component===null?null:this.Component.find("> div > .content")}get ButtonZone(){return this.Component===null?null:this.Component.find("> div > .buttons")}get IsOpened(){return super.IsOpened&&this._boxOpened&&this.Component!==null&&this._zIndex>0}set Title(n){if(this._title=Helper.Label(n),this.debug("Set title "+String.JSONStringify(this._title)),this.Component!==null){let t=this.Component.find("> div > .title"),i=Helper.Span(this._title);String.isEmptyOrWhiteSpaces(i)?t.hide():(t.html(i),t.show())}}get Title(){return this._title}set Message(n){if(this._message=Helper.Label(n),this.debug("Set message "+String.JSONStringify(this._message)),this.Component!==null){let t=this.Component.find("> div > .message"),i=Helper.Span(this._message);String.isEmptyOrWhiteSpaces(i)?t.hide():(t.html(i),t.show())}}set Error(n){if(this._error=n===null||n===undefined?null:typeof n=="string"?new Errors(n):Helper.IsLabel(n)?new Errors(n.label,n.parameters):n,this.debug("Set error "+String.JSONStringify(this._error)),this.Component!==null){if(this._error!==null){this.error(this._error.toString());let n=!1;for(let t in this._fields){let i=this._fields[t];if(i.Visible){let r=this._error.getField(t);i.Error=r;this._error.ignoreField(t);r!==null&&this._error.ignoreField("Copy"+t);n||r===null||(i.Panel!==null&&this.gotoCurrentPanel(this.getNavigationIndex(i.Panel)),i.focus(),n=!0)}}}else for(let n of Array.toIterable(this._fields))n.Error=null;let t=this.Component.find("> div > .error");if(this._error===null||!this._error.summary||String.isEmptyOrWhiteSpaces(this._error.summary()))this.ContentZone.hasClass("haserrors")===!0&&this.ContentZone.removeClass("haserrors"),t.hide();else{this.ContentZone.hasClass("haserrors")!==!0&&this.ContentZone.addClass("haserrors");let n=this._error.summary();String.isEmptyOrWhiteSpaces(n)?t.hide():(t.html(n),t.show())}}}set Mode(n){this._mode=n}get Mode(){return this._mode}get CurrentPanel(){return this.Component===null?null:this._currentPanel?this._currentPanel:this.ContentZone}get Fields(){return this._fields}get Boards(){return this._boards}get Buttons(){return this._buttons}get Value(){return null}set OnClosed(n){this._onClosed=n}destructor(){super.destructor();for(let n of Array.toIterable(this._fields))n.destructor();this._fields={};for(let n of Array.toIterable(this._boards))n.destructor();this._boards={};for(let n of Array.toIterable(this._buttons))n.destructor();this._buttons={};this._focus=[]}declareField(n){if(n!==undefined&&n!==null)return this.debug("Declare the field '"+n.Name+"'"),this._fields[n.Name]=this.addFocus(n),n.Panel=this._currentPanelName,n}getField(n){if(n===undefined||n===null)return null;let t=this._fields[n];return t===null||t===undefined?null:t}declareBoard(n){if(n!==undefined&&n!==null)return this.debug("Declare the board '"+n.Name+"'"),this._boards[n.Name]=this.addFocus(n),n.Panel=this._currentPanelName,n}getBoard(n){if(n===undefined||n===null)return null;let t=this._boards[n];return t===null||t===undefined?null:t}clearButtons(){this.debug("Cleanning up all buttons ...");this._buttons={}}declareButton(n,t,i){this.debug("Declare the button '"+n+"', '"+String.JSONStringify(t)+"'");let r=this.addFocus(new GUI.Button.Button(this,n,null,t,i));return this._buttons[r.Name]=r,r}getButton(n){if(n===undefined||n===null)return null;let t=this._buttons[n];return t===null||t===undefined?null:t}drawButton(n){n.show()}drawContent(n){n.hide()}draw(){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(function(){n.IsOpened&&(n.debug("Resizing window ..."),n.resize())},100))}}if(this.Component===null){let n="<box id='"+this.Name.toString().toLowerCase()+"' class='"+this.Name.toString().toLowerCase()+"' style='display:none;'>";n+="<div>";n+="<div class='title'><\/div>";n+="<div class='message'><\/div>";n+="<div class='error'><\/div>";n+="<div class='content'><\/div>";n+="<div class='buttons'><\/div>";n+="<\/div>";n+="<\/box>";super.draw(n);this.drawContent(this.ContentZone);this.drawButton(this.ButtonZone);this.Component.remove();Language.Manager.Instance.addComponent(this.Component);$(window).on("resize",t(this))}}checkValue(){return!0}isFieldVisible(n,t,i){return i===null||!i._list?!0:n!==i._list.column}isFieldReadonly(){return!1}isBoardVisible(){return!0}isBoardReadonly(){return!1}isPanelVisible(n){return this._navigationPanelHidden.indexOf(n)<0}isPanelReadonly(){return!1}onButtonOK(){this.verbose("onButtonOK");let n=this.getButton(GUI.Box.Box.BUTTON_OK);n!==null&&n.onMouseClick()}onButtonCancel(){this.verbose("onButtonCancel");let n=this.getButton(GUI.Box.Box.BUTTON_CANCEL);n!==null&&n.onMouseClick()}onKeypressed(){return!0}refresh(){super.refresh();this.Component!==null&&(this._refreshing=!0,this.Title=this._title,this.Message=this._message,this.Error=this._error,this._refreshing=!1);this.verbose("Setting on the current focus ...");this._panels===null||this._navigationPanels===null?this.refreshPanel():this.gotoCurrentPanel();for(let n of Array.toIterable(this._buttons))n.refresh()}resize(){}updateFields(){this.debug("Update fields")}updateBoards(){this.debug("Update boards")}onOpen(){function n(n,t){return function(){n.setFocus(t)}}function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":if(GUI.Box.BOX_RC){GUI.Box.BOX_RC=!1;return}return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;default:return n.onKeypressed(t)}}}if(super.onOpen(),this._panels!==null)for(let i of Array.toIterable(this._panels)){i.on("focus",n(this,i));i.on("keydown",t(this,i))}for(let n of Array.toIterable(this._fields))n.onOpen(),n.Message="",n.Error="";for(let n of Array.toIterable(this._boards))n.onOpen();for(let n of Array.toIterable(this._buttons))n.onOpen();this._boxOpened=!0}open(){if(!this.IsOpened){this.debug("Open the box");this._zIndex=1;for(let n of Array.toIterable(GUI.Box.Box.Stack))this._zIndex<n._zIndex&&(this._zIndex=n._zIndex);this._zIndex===1&&$(GUI.Box.Box.MAIN_PAGE).show();this._zIndex++;GUI.Box.Box.Stack[this._boxIndex]=this;this.Component.css("z-index",this._zIndex.toString());$(GUI.Box.Box.MAIN_PAGE).append(this.Component);this._navigationPanelHidden=[];this._navigationPanelIndex=0;this.debug("On openning the box ...");this.verbose("Updating fields ...");this.updateFields();this.onOpen();this.debug("Showing the box ...");this.Component.show();this.debug("Cleaning up undo values ...");for(let n of Array.toIterable(this._fields))n.cleanUndo();this.debug("Refreshing dialog box ...");this.refresh();this.verbose("Updating boards ...");this.updateBoards();this.verbose("Setting the focus on the first field ...");this.firstFocus()}}onClose(){this.onChangeFocus(null);if(this._panels!==null)for(let n of Array.toIterable(this._panels))n.off("focus keydown");super.onClose()}close(){if(this.IsOpened){this.debug("Close the box");this.Component.css("z-index","");this.Component.hide();delete GUI.Box.Box.Stack[this._boxIndex];this._zIndex=-1;this._boxOpened=!1;for(let n of Array.toIterable(this._fields))n.onClose();for(let n of Array.toIterable(this._boards))n.onClose();for(let n of Array.toIterable(this._buttons))n.onClose();this.onClose();this.Component.remove();this._onClosed!==null&&this._onClosed();for(let n of Array.toIterable(GUI.Box.Box.Stack))if(n!==null)return;$(GUI.Box.Box.MAIN_PAGE).hide()}}declarePanel(n,t){if(this.Component!==null&&n!==undefined&&n!==null){this._panels===null&&(this.ContentZone.addClass("panels"),this._navigationPrevious=$("<panel class='navigation left'><\/panel>"),this.ContentZone.append(this._navigationPrevious[0]),this._navigationMiddle=$("<panel class='main'><\/panel>"),this.ContentZone.append(this._navigationMiddle[0]),this._navigationNext=$("<panel class='navigation right'><\/panel>"),this.ContentZone.append(this._navigationNext[0]),this._panels={});this.debug("Declare the panel '"+n+"'");let i=$("<panel id='"+n+"'><\/panel>");return this._navigationMiddle.append(i[0]),this._panels[n]=this.addFocus(i),t&&i.addClass(t),this._currentPanelName=n,this._currentPanel=i,this._navigationPanels===null&&(this._navigationPanels=[[]]),this._navigationPanels[0].push(n),i}}startBlock(n){if(this.CurrentPanel!==null){this._blocks.push(this.CurrentPanel);let t=$("<div"+(n===null||n===undefined?"":" class='"+n+"'")+"><\/div>");this.CurrentPanel.append(t);this._currentPanel=t}}endBlock(){this.CurrentPanel!==null&&this._blocks.length!==0&&(this._currentPanel=this._blocks.pop())}declareNavigationPanels(n){if(this._navigationPanels=null,this._panels!==null){if(n===null||n===undefined){this._navigationPanels=[[]];for(let n in this._panels)this._navigationPanels[0].push(n);return}if(typeof n=="string"){let t=this._panels[n];if(t===null||t===undefined)return;this._navigationPanels=[[n]];return}if(Array.isArray(n)){this._navigationPanels=[];for(let n of n)if(Array.isArray(n)){let t=[];for(let i in n){let r=this._panels[n[i]];r!==null&&r!==undefined&&t.push(n[i])}this._navigationPanels.push(t)}else{let t=this._panels[n];t!==null&&t!==undefined&&this._navigationPanels.push([n])}}}}gotoPreviousPanel(){if(this._navigationPanels!==null&&this._navigationPanelIndex!==0){let n=this._navigationPanelIndex;for(this._navigationPanelIndex--;!this.gotoCurrentPanel()&&this._navigationPanelIndex>0;)this._navigationPanelIndex--;this.gotoCurrentPanel()||(this._navigationPanelIndex=n,this.gotoCurrentPanel())}}getNavigationIndex(n){if(n===null)return-1;for(let t=0;t<this._navigationPanels.length;t++)if(this._navigationPanels[t].indexOf(n)>=0&&this._navigationPanelHidden.indexOf(n)<0)return t;return-1}gotoCurrentPanel(n){function e(n){return function(){n.gotoPreviousPanel()}}function o(n){return function(){n.gotoNextPanel()}}if(this._panels===null||this._navigationPanels===null)return this._navigationPrevious!==null&&this._navigationPrevious!==undefined&&this._navigationPrevious.hide(),this._navigationNext!==null&&this._navigationNext!==undefined&&this._navigationNext.hide(),!0;n!==null&&n!==undefined&&(this._navigationPanelIndex=n);this._navigationPanelIndex<0&&(this._navigationPanelIndex=0);this._navigationPanelIndex>=this._navigationPanels.length&&(this._navigationPanelIndex=this._navigationPanels.length-1);let r=DSDatabase.Instance.CurrentUser,u=this.Value,f=!1;for(let n in this._panels){let t=this._panels[n];t!==null&&t!==undefined&&(this._navigationPanels[this._navigationPanelIndex].indexOf(n)<0||this._navigationPanelHidden.indexOf(n)>=0||!this.isPanelVisible(n,r,u)?t.hide():(f=!0,t.show(),this.refreshPanel(n)))}let t=this._navigationPanelIndex===0;if(!t){t=!0;for(let n=0;n<this._navigationPanelIndex&&t;n++)for(let i=0;i<this._navigationPanels[n].length&&t;i++)t=!this.isPanelVisible(this._navigationPanels[n][i],r,u)}if(t)this._navigationPrevious.off("click"),this._navigationPrevious.addClass("first");else{this._navigationPrevious.off("click").on("click",e(this));this._navigationPrevious.removeClass("first")}let i=this._navigationPanelIndex>=this._navigationPanels.length-1;if(!i){i=!0;for(let n=this._navigationPanelIndex+1;n<this._navigationPanels.length&&i;n++)for(let t=0;t<this._navigationPanels[n].length&&i;t++)i=!this.isPanelVisible(this._navigationPanels[n][t],r,u)}if(i)this._navigationNext.off("click"),this._navigationNext.addClass("last");else{this._navigationNext.off("click").on("click",o(this));this._navigationNext.removeClass("last")}this._navigationPanels.length<=1?(this._navigationPrevious.hide(),this._navigationNext.hide()):(this._navigationPrevious.show(),this._navigationNext.show());for(let n=0;n<this._focus.length;n++){let t=this._focus[n];if(t.length!==1&&this.isFocusable(t)&&!(this._navigationPanels[this._navigationPanelIndex].indexOf(t.Panel)<0)){this.setFocus(t);break}}return f}gotoNextPanel(){if(this._navigationPanels!==null&&!(this._navigationPanelIndex>=this._navigationPanels.length-1)){let n=this._navigationPanelIndex;for(this._navigationPanelIndex++;!this.gotoCurrentPanel()&&this._navigationPanelIndex<this._navigationPanels.length-1;)this._navigationPanelIndex++;this.gotoCurrentPanel()||(this._navigationPanelIndex=n,this.gotoCurrentPanel())}}showPanel(n){n!==null&&n!==undefined&&(this._navigationPanelHidden.indexOf(n)<0||this._navigationPanelHidden.splice(this._navigationPanelHidden.indexOf(n),1))}refreshPanel(n){let t=DSDatabase.Instance.CurrentUser,i=this.Value;n=n===null||n===undefined?null:n;for(let r of Array.toIterable(this._fields))(n===null||r.Panel===n)&&(r.Visible=this.isFieldVisible(r.Name,t,i)&&(r.Panel===null||r.Panel!==null&&this.isPanelVisible(r.Panel,t,i)),r.Readonly=this.isFieldReadonly(r.Name,t,i)||r.Panel!==null&&this.isPanelReadonly(r.Panel,t,i),r.refresh());for(let r of Array.toIterable(this._boards))(n===null||r.Panel===n)&&(r.Visible=this.isBoardVisible(r.Name,t,i)&&(r.Panel===null||r.Panel!==null&&this.isPanelVisible(r.Panel,t,i)),r.Readonly=this.isBoardReadonly(r.Name,t,i)||r.Panel!==null&&this.isPanelReadonly(r.Panel,t,i),r.refresh(),r.adjustWebix())}hidePanel(n){n!==null&&n!==undefined&&(this._navigationPanelHidden.indexOf(n)>=0||this._navigationPanelHidden.push(n))}onChangeFocus(n){if(this._focusLastIndex!==null){let n=this._focus[this._focusLastIndex];n instanceof GUI.Field.Field&&n.onFocusOut();this._focusLastIndex=null}return n===null||n===undefined?!1:n.focus()?(n.Name!==null&&n.Name!==undefined?this.verbose("Focus on "+n.Name+" ["+this._focusIndex+"]"):n.length===1?this.verbose("Focus on "+n.attr("id")+" ["+this._focusIndex+"]"):this.verbose("Focus on "+this._focusIndex),this._focusLastIndex=this._focusIndex,n instanceof GUI.Field.Field&&n.onFocusIn(),!0):!1}clearFocus(){this.onChangeFocus(null);for(let n of Array.toIterable(this._focus))if(n!==null&&n!==undefined){if(n instanceof GUI.GUI){n.TabIndex=null;continue}if(typeof n=="string"&&(n=this.Component.find(n)),n!==null&&n!==undefined&&n.length===1){n.attr("tabindex",null);continue}}this._focus=[];this._focusIndex=0;this._focusLastIndex=null}getFocusItem(n){return n===null||n===undefined?null:n instanceof GUI.GUI?n:typeof n=="string"?this._fields[n]!==null&&this._fields[n]!==undefined?this._fields[n]:this._boards[n]!==null&&this._boards[n]!==undefined?this._boards[n]:(n=this.Component.find(n),n!==null&&n!==undefined&&n.length===1)?n:null:n.length===1?n:null}addFocus(n){return(n=this.getFocusItem(n),n===null||n===undefined)?null:n instanceof GUI.GUI?(n.TabIndex=this._focus.length,this._focus.push(n),n):n!==null&&n!==undefined&&n.length===1?(n.attr("tabindex",this._focus.length),this._focus.push(n),n):null}firstFocus(){this._focusIndex=-1;this.nextFocus()}isFocusable(n){return(n=this.getFocusItem(n),n===null||n===undefined)?!1:n instanceof GUI.GUI?n.Visible&&!n.Readonly:n!==null&&n!==undefined&&n.length===1?n.is(":visible"):!1}previousFocus(){let n=0,t=this._navigationPanelIndex;while(n<2){for(this._focusIndex--,this._focusIndex<0&&(this._focusIndex=this._focus.length-1);this._focusIndex>=0;this._focusIndex--){let n=this._focus[this._focusIndex];if(this.isFocusable(n)){if(n.length===1&&this._focusIndex>0&&n[0].tagName==="PANEL"){let i=this._focusIndex-1,t=this._focus[i];if(t.length===undefined){let r=t.Panel;for(;i>=0;i--){if(t=this._focus[i],t.Panel===null||t.Panel===undefined||t.Panel!==r)break;if(this.isFocusable(t)){n=t;this._focusIndex=i;break}}}}else if(n.length===1&&this._focusIndex===0&&n[0].tagName==="PANEL")break;if(n.Panel!==null&&n.Panel!==undefined){let i=this.getNavigationIndex(n.Panel);t!==i&&this.gotoCurrentPanel(i);t=i}if(this.onChangeFocus(n))return}}n++}}nextFocus(){let n=0,t=this._navigationPanelIndex;while(n<2){for(this._focusIndex>=this._focus.length&&(this._focusIndex=-1),this._focusIndex++;this._focusIndex<this._focus.length;this._focusIndex++){let n=this._focus[this._focusIndex];if(this.isFocusable(n)){if(n.Panel!==null&&n.Panel!==undefined){let i=this.getNavigationIndex(n.Panel);t!==i&&this.gotoCurrentPanel(i);t=i}if(n.length===1&&n[0].tagName==="PANEL"){let t=n.attr("id");for(let i=this._focusIndex+1;i<this._focusIndex<this._focus.length;i++){let r=this._focus[i];if(r.Panel===null||r.Panel===undefined||r.Panel!==t)break;if(this.isFocusable(r)){n=r;this._focusIndex=i;break}}}if(this.onChangeFocus(n))return}}n++}}setFocus(n){if(n=this.getFocusItem(n),n!==null&&this.isFocusable(n)){let i=this.getFocusItem(this._focus[this._focusIndex]);if(i!==null&&this.isFocusable(i)){if(n instanceof GUI.GUI&&i instanceof GUI.GUI&&n.Name===i.Name)return;if(n.length===1&&i.length===1&&n[0]===i[0])return}let t=null;if(n.length===1?t=parseInt(n.attr("tabindex")):n instanceof GUI.GUI&&(t=n.TabIndex),t!==null&&t!==undefined&&!(t>=this._focus.length)&&t!==this._focusIndex){this._focusIndex=t;this.onChangeFocus(n)}}}arrowFocus(n,t){let i=this.getFocusItem(this._focus[this._focusIndex]);if(i!==null&&i!==undefined){i instanceof GUI.GUI&&(i=i.Component);let f=i.offset().left,e=i.offset().top,u=this._navigationPanelIndex,r=this._focusIndex;for(r+=n;0<=r&&r<this._focus.length;r+=n){let n=this._focus[r];if(i=this.getFocusItem(n),this.isFocusable(i)){i instanceof GUI.GUI&&(i=i.Component);let o=i.offset().left,s=i.offset().top;if(t(f,e,o,s)){if(n.Panel!==null&&n.Panel!==undefined){let t=this.getNavigationIndex(n.Panel);u!==t&&this.gotoCurrentPanel(t);u=t}if(this.onChangeFocus(n))return}}}}}leftFocus(){this.arrowFocus(-1,function(n,t,i,r){return n>i&&t===r})}upFocus(){this.arrowFocus(-1,function(n,t,i,r){return n===i&&t>r})}downFocus(){this.arrowFocus(1,function(n,t,i,r){return n===i&&t<r})}rightFocus(){this.arrowFocus(1,function(n,t,i,r){return n<i&&t===r})}constructor(n,t){super("box",GUI.Box.Box.MAIN_PAGE,n,t);this._boxIndex=GUI.Box.Box.StackIndex;this._boxOpened=!1;this._title=null;this._message=null;this._error=null;this._mode=null;this._focus=[];this._focusIndex=0;this._focusLastIndex=null;this._panels=null;this._fields={};this._boards={};this._currentPanelName=null;this._currentPanel=null;this._navigationPrevious=null;this._navigationMiddle=null;this._navigationNext=null;this._navigationPanels=null;this._navigationPanelIndex=0;this._navigationPanelHidden=[];this._onClosed=null;this._buttons={};this._blocks=[];this._zIndex=-1}});GUI.Box.BoxChoice=(class extends GUI.Box.Box{set Choices(n){function r(n,t,i){return function(){this.debug("Select the choice '"+t.toString()+"'");try{i()}catch(r){n.exception("Unable to select the choice '"+t.toString()+"' due to an exception",r)}n.close()}}let i=this.ContentZone;if(i!==null&&(i.empty(),n!==null&&n!==undefined)){this.clearFocus();this.clearButtons();let t=0;for(let n of n)if(n!==null&&n!==undefined&&n.label!==null&&n.label!==undefined&&n.fn!==null&&n.fn!==undefined){this.debug("Choice ("+t+") -> "+Language.Manager.Instance.interpolation(Helper.Label(n.label)));let i=this.declareButton("Choice_"+t,n.label);i.Action=r(this,t,n.fn);t++}this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}}drawContent(n){super.drawContent(n);n.show()}open(){super.open();this.firstFocus()}constructor(n){super(n,"box_choice");this.draw()}static BoxChoices(n,t,i){this._boxChoices||(this._boxChoices=new GUI.Box.BoxChoice("choices"));this._boxChoices.IsOpened||(this._boxChoices.Title=n,this._boxChoices.Message=t,this._boxChoices.Choices=i,this._boxChoices.Error=null,this._boxChoices.open())}});GUI.Box.BoxInputDigit=(class extends GUI.Box.Box{set Label(n){this._label=Helper.Label(n)}setFormat(n,t){this._digits.setFormat(n,t)}getFormat(){return this._digits.getFormat()}set Digits(n){this._digits=typeof n=="string"?new Digits.Digits(n):n===null||n===undefined?new Digits.Digits:n}set Align(n){this._align=n==="left"||n==="center"||n==="right"?n:"right"}set Value(n){this._digits.Value=n}get Value(){return this._digits.Value}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}destructor(){super.destructor();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null)}addKey(n){if(this._digits.addKey(n),this.refresh(),this._calendar!==null){let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){let i=["7","8","9","4","5","6","1","2","3"],t="";for(let n=0;n<i.length;n++)t+="<div class='key' key='"+i[n]+"'><div>"+String.encode(i[n])+"<\/div><\/div>";t+="<div class='key undo' key='undo'><\/div>";t+="<div class='key' key='0'><div>0<\/div><\/div>";t+="<div class='key next minus' key='next'><\/div>";t+="<div class='key value minus' key='minus'>"+String.encode("-")+"<\/div>";this._content=n;this._content.append("<field class='input field_input input_digit'><div class='label'><\/div><div class='value'><div class='field' tabindex=0><\/div><\/div><div class='unit'><\/div><div class='icon'><\/div><\/field > <div id='keyboard'>"+t+"<\/div><div id='calendar'><\/div>");this._content.show()}drawCalendar(){function i(n){return function(t){n._digits.setDate(t.getDate(),t.getMonth()+1,1900+t.getYear());n.refresh()}}if(this._calendar!==null&&(this._calendar.destructor(),this._calendar=null),this._digits instanceof Digits.Datetime){let n=this._digits.WebixType;if(n!==null){this._calendar=new webix.ui({view:"calendar",type:n==="day"?undefined:n,container:this._content.find("> #calendar")[0],weekHeader:n==="day",weekNumber:n==="day",calendarDateFormat:this._digits.WebixFormat,on:{onDateSelect:i(this)}});let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}}onOpen(){function n(n){return function(){n.addKey($(this).attr("key"))}}function t(n){return function(t){switch(t.key){case"Backspace":t.stopImmediatePropagation();n.addKey("undo");return;case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":t.stopImmediatePropagation();n.onButtonOK();return;case"Escape":t.stopImmediatePropagation();n.onButtonCancel();return;case"Delete":return t.stopImmediatePropagation(),n.addKey("raz"),!1}}}function i(n){return function(t){let i=t.which||t.keyCode;i<32||n.addKey(String.fromCharCode(i))}}function r(n){return function(){n._digits.RAZ();n.refresh()}}super.onOpen();this.clearFocus();this.addFocus("field > .value > .field");this.addFocus(this.getButton(GUI.Box.Box.BUTTON_OK));this.addFocus(this.getButton(GUI.Box.Box.BUTTON_CANCEL));this.Component.find("#keyboard > .key").on("click",n(this));this.Component.find("field > .value > .field").on("keydown",t(this));this.Component.find("field > .value > .field").on("keypress",i(this));this.Component.find("field > .icon").on("click",r(this));this._digits.selectAll()}open(){function n(n){return function(t,i){n._calendar!==null&&i===undefined&&n.drawCalendar()}}super.open();this.drawCalendar();this._languageListener=Language.Manager.Instance.addListener(n(this))}onClose(){super.onClose();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null);this.Component.find("#keyboard > .key").off("click");this.Component.find("field > .value > .field").off("keydown keypress");this.Component.find("field > .icon").off("click")}refresh(){if(super.refresh(),this.Component!==null){this.Component.find("field > .value > .field").html(this._digits.toHTML());let e=Helper.Span(this._label),i=this.Component.find("field > .label");String.isEmptyOrWhiteSpaces(e)?(i.html(""),i.hasClass("hide")||i.addClass("hide")):i.html(e);let n=this.Component.find("#keyboard > .next"),o=this._digits.NextTokenFix;String.isEmptyOrWhiteSpaces(o)?(n.hasClass("empty")||n.addClass("empty"),this.Component.find("#keyboard > .next").html("")):(n.hasClass("empty")&&n.removeClass("empty"),this.Component.find("#keyboard > .next").html(String.encode(o)));this._digits.AllowNegativeValue?(n.hasClass("minus")||n.addClass("minus"),this.Component.find("#keyboard > .key.value.minus").show()):(n.hasClass("minus")&&n.removeClass("minus"),this.Component.find("#keyboard > .key.value.minus").hide());let r=this.Component.find("#keyboard > .undo");this._digits.HasUndo?r.hasClass("empty")&&r.removeClass("empty"):r.hasClass("empty")||r.addClass("empty");let t=this.Component.find("field > .unit");if(t.length>0){let n=String.encode(this._unit);String.isEmptyOrWhiteSpaces(n)?t.hasClass("hide")||t.addClass("hide"):(t.hasClass("hide")&&t.removeClass("hide"),t.html(n))}let s=this.Component.find("field > .value > .field");s.css("text-align",this._align);let u=this.Component.find("#calendar"),f=this.Component.find("#keyboard");this._digits.IsCalendar?(u.hasClass("hide")&&u.removeClass("hide"),f.hasClass("hide")||f.addClass("hide")):(u.hasClass("hide")||u.addClass("hide"),f.hasClass("hide")&&f.removeClass("hide"));this.firstFocus()}}constructor(n,t){super(n,"box_inputdigit");this._content=null;this._label=null;this._unit=null;this._align="right";this._calendar=null;this._languageListener=null;this._notRefresh=!1;this._digits=typeof t=="string"?new Digits.Digits(t):t===null||t===undefined?new Digits.Digits:t;this.draw()}static Digit(n,t,i,r,u,f,e){this._dialogBoxDigit||(this._dialogBoxDigit=new GUI.Box.BoxInputDigit("digits"));this._dialogBoxDigit.Title=n;this._dialogBoxDigit.Label=t;this._dialogBoxDigit.Unit=i;this._dialogBoxDigit.Digits=r;this._dialogBoxDigit.Align=u;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_OK).Action=f;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=f!==null&&f!==undefined;this._dialogBoxDigit.getButton(GUI.Box.Box.BUTTON_CANCEL).Action=e;this._dialogBoxDigit.open()}});GUI.Box.BoxInputFile=(class extends GUI.Box.Box{static get ID(){return this._inputFileId?this._inputFileId++:this._inputFileId=1,this._inputFileId}get Value(){return this._value}get FileZone(){return this.Component.find(".content > #file")}drawButton(n){function t(n){return function(t){n.deleteFile(t)}}super.drawButton(n);this.addFocus(this.FileZone);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL").Action=t(this)}drawContent(n){super.drawContent(n);n.append('<input type="file" class="file" id="UploadFile_'+this._index.toString()+'" accept="'+this._extensions+'" />');n.append("<div id='file'><\/div>");n.append("<div id='filename'><\/div>");n.show()}onOpen(){function n(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case"Enter":case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1}}}function t(n){return function(){n.sendFiles([{name:this.value,file:this.files[0]}])}}function i(n){return function(){n.Component.find("#UploadFile_"+n._index.toString()).click()}}function r(){return function(n){n.preventDefault();n.stopPropagation()}}function u(n){return function(){Hub.Instance.IsRunning&&n.FileZone.addClass("is-dragover")}}function f(n){return function(){n.FileZone.removeClass("is-dragover")}}function e(n){return function(t){let i=[];for(let n=0;n<t.originalEvent.dataTransfer.files.length;n++)i.push({name:t.originalEvent.dataTransfer.files[n].name,file:t.originalEvent.dataTransfer.files[n]});n.sendFiles(i)}}super.onOpen();this.FileZone.on("keydown",n(this));this.FileZone.removeClass("full");this.Component.find("#filename").html("");this.Component.find("#UploadFile_"+this._index.toString()).val("");this._value=null;this.Component.find("#UploadFile_"+this._index.toString()).off("change").on("change",t(this));this.FileZone.click(i(this));this.FileZone.on("drag dragstart dragend dragover dragenter dragleave drop",r(this)).on("dragover dragenter",u(this)).on("dragleave dragend drop",f(this)).on("drop",e(this))}open(){super.open();this.firstFocus()}onClose(){super.onClose();this.FileZone.off("drag dragstart dragend dragover dragenter dragleave drop keydown")}onMouseClick(){this.Readonly||this.Component===null||this.FileZone.click()}deleteFile(n){if((n===null||n===undefined)&&(n=this._value),n!==null&&n!==undefined){if(Hub.Instance.IsRunning)for(let t=0;t<n.length;t++){let i=n[t];try{$.ajax({type:"POST",url:"/Administration/File/Remove",data:String.JSONStringify({id:i.id.toString(),filename:i.filename}),contentType:"application/json",processData:!1})}catch(t){this.exception("Unable to remove the file",t)}}this._value=null;this.FileZone.removeClass("full");this.Component.find("#filename").html("")}}sendFiles(n){function u(n){return function(t){t=JSON.parse(t);n.FileZone.hasClass("full")||n.FileZone.addClass("full");let i="";for(let n=0;n<t.files.length;n++)i=i+(i===""?"":"<br />")+String.encode(t.files[n].filename);n.Component.find("#filename").html(i);n._value=t.files;GUI.Box.Progress.Stop()}}function f(n){return function(t){if(n.FileZone.removeClass("full"),n.Component.find("#UploadFile_"+n._index.toString()).val(""),n._value=null,GUI.Box.Progress.Stop(),t.status===500){GUI.Box.Message.Error("ERROR","ERR_UPLOAD_TOO_BIG");return}if(!Hub.Instance.IsRunning){GUI.Box.Message.Error("ERROR","ERR_UPLOAD_BROKEN");return}GUI.Box.Message.Error("ERROR",new Errors("ERR_UPLOAD_FAILED",[t.status.toString()]))}}if(Hub.Instance.IsRunning){let i=this._extensions.split(","),t=[];for(let r=0;r<n.length;r++){let f=n[r].name.match(/\.([^.]+)$/)[1],u=!1;for(let n=0;n<i.length;n++)if(i[n].toUpperCase()==="."+f.toUpperCase()){u=!0;break}u||t.push(n[r].name)}if(t.length>0){GUI.Box.Message.Error("ERROR",Helper.Label("ERR_UPLOAD_EXTENSION",[t.join(", ")]));return}let r=new FormData;for(let t=0;t<n.length;t++)r.append(n[t].name,n[t].file);GUI.Box.Progress.Start();GUI.Box.Progress.SetStatus(0,1,"MSG_LOADING");this.deleteFile();$.ajax({type:"POST",url:"/Administration/File/Upload",contentType:!1,processData:!1,data:r,xhr:function(){let n=$.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",function(n){n.lengthComputable&&GUI.Box.Progress.SetStatus(n.loaded,n.total,"MSG_LOADING")},!1),n},success:u(this),error:f(this)})}}constructor(n,t){super(n,"box_inputfile");this._index=GUI.Box.BoxInputFile.ID;this._extensions=t?t:".gif,.png,.jpg,.bmp,.svg,.tif,.jpeg,.txt,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx";this._value=null;this.draw()}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxInputFile("inputfile")),this._instance}static Open(n,t,i){GUI.Box.BoxInputFile.Instance.Title=n;GUI.Box.BoxInputFile.Instance.Message=t;GUI.Box.BoxInputFile.Instance.Error=null;GUI.Box.BoxInputFile.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=i;GUI.Box.BoxInputFile.Instance.open()}});GUI.Box.BoxInputFilesCSV=(class extends GUI.Box.Box{get Value(){let n=[];for(let t of this._value)t.value===null||t.field===null||t.field.File===null?t.value.csv=null:t.field.File!==null&&(t.value.csv=t.field.File.copy(t.value.name)),n.push(t.value);return n}set Value(n){this._value=[];for(let t=1;t<=this._nbFiles;t++){let u="file_"+t,i=this._fields[u];if(i===null||i===undefined){this._value.push({value:null,field:null});continue}i.Label=null;i.Error=null;i.File=null;i.Message=null;let r=null;if(n!==null&&n!==undefined&&(r=n[t-1]),r===null||r===undefined){this._value.push({value:null,field:null});continue}i.Label=r.label;i.Charset=r.charset;i.Separator=r.separator;this._value.push({value:r,field:i})}this.refresh()}drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){super.drawContent(n);for(let n=1;n<=this._nbFiles;n++)this.declareField(new GUI.Field.FieldFileCSV(this,"file_"+n,null));n.show()}open(){super.open();this.firstFocus()}constructor(n,t,i){super(n,"box_inputfilescsv");this._extensions=t?t:".csv";this._value=null;this._nbFiles=i;this.draw();this.Component.addClass("inputfilescsv"+this._nbFiles)}static Instance(n){this._instance||(this._instance=[]);let t=this._instance[n];return t===undefined&&(t=new GUI.Box.BoxInputFilesCSV("inputfilescsv",null,n),this._instance[n]=t),t}static Open(n,t,i,r){function f(n){return function(t){n&&n(t)}}let u=GUI.Box.BoxInputFilesCSV.Instance(i.length);u.Title=n;u.Message=t;u.Error=null;u.Value=i;u.getButton(GUI.Box.Box.BUTTON_OK).Action=f(r);u.open()}});GUI.Box.BoxInputText=(class extends GUI.Box.Box{set AllowRC(n){this._allowRC=n!==undefined&&n!==null&&n}get TextZone(){return this._content.find("textarea")}set Value(n){(this._value=String.convertValue(n),this.Component!==null)&&(this.TextZone.val(this._value===null||this._value===undefined?"":this._value.toString()),this.resize())}get Value(){return this.Component===null?this._value:this.TextZone.val()}drawButton(n){super.drawButton(n);this.addFocus(this.TextZone);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){function t(n){return function(){n.IsOpened&&(clearTimeout(n._throttle),n._throttle=setTimeout(function(){n.resize()},100))}}super.drawContent(n);this._content=n;this._content.append("<textarea><\/textarea>");this._content.show();$(window).on("resize",t(this))}onOpen(){function n(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":if(n._allowRC){GUI.Box.BOX_RC=!0;return}return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1}}}function t(){return function(){$(this).select()}}function i(n){return function(){n.resize()}}super.onOpen();this.TextZone.on("keydown",n(this));this.TextZone.on("focus",t(this));this.TextZone.on("change keyup paste",i(this))}open(){super.open();this.firstFocus()}onClose(){this.TextZone.off("change keyup paste keydown")}refresh(){super.refresh();this.Value=this._value}resize(){if(this.Component!==null){let t=this.TextZone.height();this.TextZone.height(1);let n=this.TextZone[0].scrollHeight;this.TextZone.height(n>1?n:t)}}constructor(n){super(n,"box_inputtext");this._allowRC=!1;this._content=null;this._value=null;this.draw()}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxInputText("inputtext")),this._instance}static Open(n,t,i,r,u){GUI.Box.BoxInputText.Instance.Title=n;GUI.Box.BoxInputText.Instance.Message=t;GUI.Box.BoxInputText.Instance.Value=i;GUI.Box.BoxInputText.Instance.AllowRC=r;GUI.Box.BoxInputText.Instance.Error=null;GUI.Box.BoxInputText.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=u;GUI.Box.BoxInputText.Instance.open()}});GUI.Box.Message=(class{static Message(n,t,i){this._dialogBoxMessage||(this._dialogBoxMessage=new GUI.Box.Box("message","box_message"),this._dialogBoxMessage.draw(),this._dialogBoxMessage.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxMessage.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxMessage.Title=n;this._dialogBoxMessage.Message=t;this._dialogBoxMessage.getButton(GUI.Box.Box.BUTTON_OK).Action=i;this._dialogBoxMessage.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=i!==null&&i!==undefined;this._dialogBoxMessage.open()}static Message2(n,t,i){this._dialogBoxMessage2||(this._dialogBoxMessage2=new GUI.Box.Box("message","box_message"),this._dialogBoxMessage2.draw(),this._dialogBoxMessage2.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxMessage2.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxMessage2.Title=n;this._dialogBoxMessage2.Message=t;this._dialogBoxMessage2.getButton(GUI.Box.Box.BUTTON_OK).Action=i;this._dialogBoxMessage2.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=i!==null&&i!==undefined;this._dialogBoxMessage2.open()}static Information(n,t){this._dialogBoxInformation||(this._dialogBoxInformation=new GUI.Box.Box("information","box_information"),this._dialogBoxInformation.draw(),this._dialogBoxInformation.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxInformation.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxInformation.Title="INFORMATION";this._dialogBoxInformation.Message=n;this._dialogBoxInformation.getButton(GUI.Box.Box.BUTTON_OK).Action=t;this._dialogBoxInformation.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=t!==null&&t!==undefined;this._dialogBoxInformation.open()}static Warning(n,t){this._dialogBoxWarning||(this._dialogBoxWarning=new GUI.Box.Box("warning","box_warning"),this._dialogBoxWarning.draw(),this._dialogBoxWarning.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxWarning.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL"));this._dialogBoxWarning.Title="WARNING";this._dialogBoxWarning.Message=n;this._dialogBoxWarning.getButton(GUI.Box.Box.BUTTON_OK).Action=t;this._dialogBoxWarning.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible=t!==null&&t!==undefined;this._dialogBoxWarning.open()}static Error(n,t){function i(t){return function(){return Clipboard.Copy(Language.Manager.Instance.interpolation(n),t._error===null?"":t._error.toClipboard()),!1}}this._dialogBoxError||(this._dialogBoxError=new GUI.Box.Box("error","box_error"),this._dialogBoxError.draw(),this._dialogBoxError.declareButton(GUI.Box.Box.BUTTON_OK),this._dialogBoxError.declareButton(GUI.Box.Box.BUTTON_CLIPBOARD,"BTN_CLIPBOARD").Action=i(this._dialogBoxError));this._dialogBoxError.Title=n;this._dialogBoxError.Error=t;this._dialogBoxError.open()}static Reload(n,t){let i=new GUI.Box.Box("error","box_reload");i.Title="RELOAD";i.Error=n;i.draw();i.declareButton("Reload","BTN_RELOAD",t);i.open()}});GUI.Box.Progress=(class{static IsOpened(){return this._isShown!==null&&this._isShown!==undefined&&this._isShown===!0}static Status(n,t,i){return[n,t,i]}static Start(n){n=n===null||n===undefined||n===!0;this._timeoutStop!==null&&this._timeoutStop!==undefined?(window.clearTimeout(this._timeoutStop),this._timeoutStop=null):this._timeoutStart!==null&&this._timeoutStart!==undefined?(Logger.Instance.warn("Progress","Progress bar already started"),n&&(window.clearTimeout(this._timeoutStart),this._timeoutStart=null,$("body > .progress").show(),Logger.Instance.verbose("Progress","Open progress bar forced"))):($("body > .progress").is(":visible")&&Logger.Instance.debug("Progress","Progress bar already opened"),n?($("body > .progress").show(),Logger.Instance.verbose("Progress","Open progress bar forced")):this._timeoutStart=window.setTimeout(()=>{GUI.Box.Progress._timeoutStart=null,$("body > .progress").show(),Logger.Instance.verbose("Progress","Open progress bar")},300));Logger.Instance.debug("Progress","Start progress");this._isShown=!0}static SetStatus(n,t,i,r){let u=$("body > .progress > div > #bar"),f=$("body > .progress > div > #progressStatus");Array.isArray(n)&&n.length===3&&(i=n[2],t=n[1],n=n[0]);(n===null||n===undefined)&&(n=u.val()+1);u.val(n);t!==null&&t!==undefined&&u.attr("max",t);i!==null&&i!==undefined&&f.html(Helper.Span(i));Logger.Instance.IsVerbose&&r!==!1&&Logger.Instance.verbose("Progress","Progress ("+n.toString()+"/"+u.attr("max")+" - "+f.html()+")")}static Stop(n){this._timeoutStart!==null&&this._timeoutStart!==undefined?(window.clearTimeout(this._timeoutStart),this._timeoutStart=null,Logger.Instance.verbose("Progress","Do not show the progress bar because it stops before a given laps of time")):this._timeoutStop!==null&&this._timeoutStop!==undefined?(window.clearTimeout(this._timeoutStop),this._timeoutStop=null,n===!0?($("body > .progress").hide(),Logger.Instance.verbose("Progress","Close progress bar by force")):this._timeoutStop=window.setTimeout(()=>{GUI.Box.Progress._timeoutStop=null,$("body > .progress").hide(),Logger.Instance.verbose("Progress","Close progress bar")},500)):$("body > .progress").is(":hidden")?Logger.Instance.debug("Progress","Progress bar already closed"):n===!0?($("body > .progress").hide(),Logger.Instance.verbose("Progress","Close progress bar by force")):this._timeoutStop=window.setTimeout(()=>{GUI.Box.Progress._timeoutStop=null,$("body > .progress").hide(),Logger.Instance.verbose("Progress","Close progress bar")},500);this._isShown&&Logger.Instance.debug("Progress","End progress");this._isShown=!1}static async Thread(n,t,i,r,u){await SyncytiumThread.Thread(n,t,i,r,u)}static async Sleep(n){await new Promise(t=>{setTimeout(t,n)})}});GUI.Box.BoxRecord=(class extends GUI.Box.Box{static get ROOT_DIRECTORY(){return URL_ROOT+"Content/Images/Areas/"}static get MODE_CREATE(){return"Create"}static get MODE_READ(){return"Read"}static get MODE_UPDATE(){return"Update"}static get MODE_DELETE(){return"Delete"}static CACHE_DIALOG_BOX(n,t,i){if(this._cacheDialogBox||(this._cacheDialogBox={}),n===null||n===undefined)return null;let u=n+(t===null||t===undefined?"":"."+t),r=this._cacheDialogBox[u];if(r!==null&&r!==undefined)for(let n=0;n<r.length;n++)if(!r[n].IsOpened||t!==null&&t!==undefined)return r[n].List=i,r[n].OnClosed=null,r[n];try{r=eval(n+"Record.Box")}catch(f){try{r=eval(n+".Box")}catch(f){return null}}return r?(r=new r,r.List=i,r.Commit=!0,(this._cacheDialogBox[u]===null||this._cacheDialogBox[u]===undefined)&&(this._cacheDialogBox[u]=[]),this._cacheDialogBox[u].push(r),r):null}get Value(){let t=DSRecord.Clone(this._currentRecord);for(let n in this.Fields)this._currentRecord!==null&&(this._currentRecord._list&&n===this._currentRecord._list.column||(t[n]=DSDatabase.Instance.convertValue(this._table,n,this.Fields[n].Value,!1)));let n=this._list.SequenceProperty;return n!==null&&n!==undefined&&this.Fields[n]!==null&&this.Fields[n]!==undefined&&this._noSequence&&(t[n]=null),t}set Error(n){(super.Error=n,this._initializing||this._refreshing)||(this._panels===null||this._navigationPanels===null?this.refreshPanel():this.gotoCurrentPanel())}set Commit(n){this._commit=n!==null&&n!==undefined&&n}get Table(){return this._table}get List(){return this._list}set List(n){this._list=n?n:new List.ListRecord(this._table)}get LoopOnCreate(){return this._loopOnCreate}set LoopOnCreate(n){this._loopOnCreate=n!==null&&n!==undefined&&n===!0}get NewRecord(){return this._list.NewItem}get CurrentRecord(){return this._currentRecord}get OriginRecord(){return this._originRecord}declareField(n){if(n!==undefined&&n!==null){if(n instanceof GUI.Field.Field)return super.declareField(n);if(typeof n=="string"){let i=DSDatabase.Instance.getColumn(this._table,n),r=DSDatabase.Instance.getColumnLabel(this._table,n),s=null,u=null,h=null,f=null,o=null,e=null;if(i===null)return super.declareField(new GUI.Field.FieldInput(this,n,r));let t=null;switch(i.Type){case"Int32":if(e=i.ForeignKey,e!==null){u=null;try{u=eval(e.Table+"Record.List")}catch(c){u=null}u=u?new u(!1):new List.ListRecord(e.Table,!1);DSDatabase.Instance.getColumn(e.Table,"Picture")!==null||DSDatabase.Instance.getColumn(e.Table,"Image")!==null?(t=new GUI.Field.FieldSelectImage(this,n,r,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase(),u),i.IsRequired||t.setAllowNullValue(!0,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase()+"_NULL"),t.Autovalidation=!0,t.ShowLabel=!0):(t=new GUI.Field.FieldSelect(this,n,r,u),t.AllowNullValue=!i.IsRequired);break}t=new GUI.Field.FieldInputDigit(this,n,r,i.Digit,i.Unit);break;case"Double":case"Decimal":t=new GUI.Field.FieldInputDigit(this,n,r,i.Digit,i.Unit);break;case"Boolean":t=new GUI.Field.FieldCheckBox(this,n,r,[r+"_NULL",r+"_TRUE",r+"_FALSE"]);t.AllowNullValue=!i.IsRequired;break;case"String":if(o=DSDatabase.Instance.getSequence(this._table),o!==null&&n===o.Property)t=new GUI.Field.FieldInputDigit(this,n,r,new Digits.Sequence(o.Key,o.Length)),t.AsString=!0;else if(f=i.StringFormat,String.isEmptyOrWhiteSpaces(f))if(i.IsEmail)t=new GUI.Field.FieldInput(this,n,r,GUI.Field.FieldInput.TYPE_INPUT,null,i.StringMaxLength);else{let u=i.StringMaxLength;u=u===null?2e3:u;t=new GUI.Field.FieldInput(this,n,r,u>64?GUI.Field.FieldInput.TYPE_TEXTAREA:GUI.Field.FieldInput.TYPE_INPUT,null,u);t.AllowRC=u>64}else t=new GUI.Field.FieldInputDigit(this,n,r,new Digits.Mask(f,"\0")),t.AsString=!0;break;case"Enum":h=i.PathEnumerable;u=this.getListEnumerable(n);String.isEmptyOrWhiteSpaces(h)||!IMAGES_LOADED_FROM_SERVER.startsWith(h)&&IMAGES_LOADED_FROM_SERVER.indexOf(","+h)<0?(t=new GUI.Field.FieldSelect(this,n,r,u),t.AllowNullValue=!i.IsRequired):(t=new GUI.Field.FieldSelectImage(this,n,r,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase(),u),t.Autovalidation=!0,i.IsRequired||t.setAllowNullValue(!0,this._table.toUpperCase()+"_SELECT_"+n.toUpperCase()+"_NULL"));break;case"DateTime":f=i.DatetimeFormat;t=new GUI.Field.FieldInputWithBox(this,n,r,f===null?"datetime":f);t.AllowNullValue=!i.IsRequired;break;case"Byte[]":try{s=eval(this._table+"Record.DEFAULT_PICTURE")()}catch(c){this.IsVerbose&&this.exception("[Verbose] An exception occurs on showing the column",c)}t=new GUI.Field.FieldFileImage(this,n,r,s);s!==null&&(t.DefaultPicture=s.picture)}return t===null?super.declareField(new GUI.Field.FieldInput(this,n,this._table.toUpperCase()+"_"+n.toUpperCase())):super.declareField(t)}}}drawButton(n){super.drawButton(n);this._buttonFirst=this.declareButton(GUI.Box.Box.BUTTON_FIRST,"BTN_FIRST");this._buttonPrevious=this.declareButton(GUI.Box.Box.BUTTON_PREVIOUS,"BTN_PREVIOUS");this._buttonOK=this.declareButton(GUI.Box.Box.BUTTON_OK,"BTN_SUBMIT");this.drawAdditionalButton(n);this._buttonCancel=this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL");this._buttonClose=this.declareButton(GUI.Box.Box.BUTTON_CLOSE,"BTN_CLOSE");this._buttonSearch=this.declareButton(GUI.Box.Box.BUTTON_SEARCH,"BTN_SEARCH");this._buttonNext=this.declareButton(GUI.Box.Box.BUTTON_NEXT,"BTN_NEXT");this._buttonLast=this.declareButton(GUI.Box.Box.BUTTON_LAST,"BTN_LAST")}drawContent(n){super.drawContent(n);n.show()}drawAdditionalButton(){}isSelectedRecord(n,t){return String.isEmptyOrWhiteSpaces(t)?!0:String.in(this.List.getText(n),t)}onFirstRecord(){this._updatedRecords===null||this._updatedIndex<=0||(this.close(),this.debug("Go to the first record"),this._updatedIndex=0,this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],this.Mode,!1),this.open(),this._buttonFirst.Readonly=!0,this._buttonPrevious.Readonly=!0,this._buttonNext.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1,this._buttonLast.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1)}onPreviousRecord(){this._updatedRecords===null||this._updatedIndex<=0||(this.close(),this.debug("Go to the previous record"),this._updatedIndex--,this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],this.Mode,!1),this.open(),this._buttonFirst.Readonly=this._updatedIndex<=0,this._buttonPrevious.Readonly=this._updatedIndex<=0,this._buttonNext.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1,this._buttonLast.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1)}onSearchRecord(){this._updatedRecords!==null&&GUI.Box.BoxInputText.Open("TITLE_SEARCH",this.List.Table.toUpperCase()+"_SEARCH",this._updatedSearch,!1,n=>{this.debug("Looking for a given record");this._updatedSearch=n;let r=this._updatedRecordsSelected,i=r[this._updatedIndex],t=0;for(this._updatedRecordsSelected=[],t=0;t<this._updatedRecords.length;t++)this.isSelectedRecord(this.List.getItem(this._updatedRecords[t]),this._updatedSearch)&&this._updatedRecordsSelected.push(t);for(this._updatedRecordsSelected.length===0&&this._updatedRecordsSelected.push(i),this._updatedIndex=0,t=0;t<this._updatedRecordsSelected.length;t++)if(this._updatedIndex=t,this._updatedRecordsSelected[t]>=i)break;i!==this._updatedRecordsSelected[this._updatedIndex]&&(this.close(),this.debug("Go to the first record found"),this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],this.Mode,!1),this.open());this._buttonFirst.Readonly=this._updatedIndex<=0;this._buttonPrevious.Readonly=this._updatedIndex<=0;this._buttonNext.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1;this._buttonLast.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1})}onNextRecord(){this._updatedRecords===null||this._updatedIndex>=this._updatedRecordsSelected.length-1||(this.close(),this.debug("Go to the next record"),this._updatedIndex++,this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],this.Mode,!1),this.open(),this._buttonFirst.Readonly=this._updatedIndex<=0,this._buttonPrevious.Readonly=this._updatedIndex<=0,this._buttonNext.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1,this._buttonLast.Readonly=this._updatedIndex>=this._updatedRecordsSelected.length-1)}onLastRecord(){this._updatedRecords===null||this._updatedIndex>=this._updatedRecords.length-1||(this.close(),this.debug("Go to the last record"),this._updatedIndex=this._updatedRecordsSelected.length-1,this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],this.Mode,!1),this.open(),this._buttonFirst.Readonly=this._updatedIndex<=0,this._buttonPrevious.Readonly=this._updatedIndex<=0,this._buttonNext.Readonly=!0,this._buttonLast.Readonly=!0)}onKeypressed(n){if(this.Mode===GUI.Box.BoxRecord.MODE_UPDATE&&this._updatedRecords!==null)switch(n.key){case"Home":return n.stopImmediatePropagation(),this._buttonFirst.onMouseClick(),!1;case"PageUp":return n.stopImmediatePropagation(),this._buttonPrevious.onMouseClick(),!1;case"PageDown":return n.stopImmediatePropagation(),this._buttonNext.onMouseClick(),!1;case"End":return n.stopImmediatePropagation(),this._buttonLast.onMouseClick(),!1;case"f":return n.ctrlKey?(n.stopImmediatePropagation(),this._buttonNext.onMouseClick(),!1):!1}return super.onKeypressed(n)}isFocusable(n){if(!super.isFocusable(n))return!1;if(n instanceof GUI.Field.Field){let t=DSDatabase.Instance.CurrentUser,i=this.Value;if(!this.isFieldVisible(n.Name,t,i)||this.isFieldReadonly(n.Name,t,i)||!this.isPanelVisible(n.Panel,t,i))return!1}return!0}initialize(n,t,i){this._initializing=!0;this.Mode=t;this._currentRecord=this.getRecord(n);this._originRecord=this.Mode===GUI.Box.BoxRecord.MODE_READ?this._currentRecord:this.getRecord(this._list.getId(this._currentRecord));this.debug("Initializing the box ('"+t+"', "+(i?"Readonly":"Not Readonly")+") for the record ["+this._currentRecord.Id.toString()+"] ...");this.Title=Helper.Label(this.Name.toUpperCase()+"_"+t.toUpperCase(),this.getRecordLabel());this.Message=null;this.Error=null;this.Readonly=i;this._initializing=!1}getListEnumerable(n){return new List.ListArray(new List.ListEnumerable(this._table,n,GUI.Box.BoxRecord.ROOT_DIRECTORY).getList())}getRecordLabel(){let n=this._list.getText(this.Value);return String.isEmptyOrWhiteSpaces(n)?"{TITLE_NOT_DEFINED}":n}getRecord(n){let t=null;return t=typeof n=="number"||typeof n=="string"?DSRecord.Clone(this._list.getItem(n,!0)):DSRecord.Clone(n),t===null&&(t=this.NewRecord),t}updateFields(){if(super.updateFields(),this._currentRecord!==null&&this._currentRecord!==undefined)for(let n in this.Fields){let t=this.Fields[n];try{t instanceof GUI.Field.FieldSelect&&(t.ExcludeValueToFilter=this._currentRecord[n]);t.populate();t.Value=this._currentRecord[n]}catch(n){this.exception(`Unable to set the value of the field ${n}`,n)}}}async updateBoards(){super.updateBoards();for(let n of Array.toIterable(this.Boards))try{n.clearWebixCache();await n.populateWebix();await n.adjustWebix()}catch(n){this.exception(`Unable to populate the list ${n.Name}`,n)}}isFieldVisible(n,t,i){return super.isFieldVisible(n,t,i)?this._list.isBoxFieldVisible(this,n,t,i):!1}isFieldReadonly(n,t,i){return super.isFieldReadonly(n,t,i)?!0:this._list.isBoxFieldReadonly(this,n,t,i)}isBoardVisible(n,t,i){return super.isBoardVisible(n,t,i)?this._list.isBoxBoardVisible(this,n,t,i):!1}isBoardReadonly(n,t,i){return super.isBoardReadonly(n,t,i)?!0:this._list.isBoxBoardReadonly(this,n,t,i)}isPanelVisible(n,t,i){return super.isPanelVisible(n,t,i)?n==="_history"&&this.Mode===GUI.Box.BoxRecord.MODE_CREATE?!1:this._list.isBoxPanelVisible(this,n,t,i):!1}isPanelReadonly(n,t,i){return super.isPanelReadonly(n,t,i)?!0:this._list.isBoxPanelReadonly(this,n,t,i)}open(){this.verbose("Openning box ...");super.open();let n=this._list.SequenceProperty;n!==null&&n!==undefined&&this.Fields[n]!==null&&this.Fields[n]!==undefined&&(this._noSequence?(this.Fields[n].Component.find("#field > .field").hide(),this.Fields[n].Message=Helper.Span("ERR_SEQUENCE_"+this.Table.toUpperCase())):(this.Fields[n].Component.find("#field > .field").show(),this.Fields[n].Message=null))}close(){super.close();this._noSequence=!1}createRecord(n,t,i){function r(n){return function(){n.open();n.debug("Box record is opened for creating an item")}}function u(t){return async function(){let r=new Errors;t._list.beginTransaction(Helper.Label(t.Name.toUpperCase()+"_"+t.Mode.toUpperCase()+"D_TOAST",t.getRecordLabel()));let u=t._list.addItem(n,r,!0);if(t._list.endTransaction(),r.HasError){t.Error=r;t._commit&&await t._list.rollbackAsync();return}t._commit&&(t._currentRecord=u,await t._list.commitAsync());i&&i(u);t._loopOnCreate||t.close()}}function f(n){return async function(t){let f=new Errors;n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel()));let r=n._list.addItem(t,f,!1);return(n._list.endTransaction(),Helper.IsLabel(r))?(GUI.Box.Message.Message(n.Title,r,u(n)),!1):f.HasError?(n._commit&&await n._list.rollbackAsync(),f):(n._commit&&(n._currentRecord=r,await n._list.commitAsync()),i&&i(r),!n._loopOnCreate)}}function e(n){return function(){n.debug("Cancelling record ...");let t=new Errors;return n._list.cancelItem(-1,null,n.Value,t),n.close(),!0}}this.IsOpened||(this.debug("Opening a box record for creating an item ..."),this._updatedRecords=null,this._updatedRecordsSelected=null,this._updatedIndex=null,this._updatedSearch=null,this.initialize(n===undefined||n===null?null:n,t?t:GUI.Box.BoxRecord.MODE_CREATE,!1),this._buttonFirst.Visible=!1,this._buttonPrevious.Visible=!1,this._buttonOK.Visible=!0,this._buttonOK.Action=f(this),this._buttonCancel.Visible=!0,this._buttonCancel.Action=e(this),this._buttonClose.Visible=!1,this._buttonSearch.Visible=!1,this._buttonNext.Visible=!1,this._buttonLast.Visible=!1,this._list.createSequence(this._currentRecord,r(this))||(this._noSequence=!0,r(this)()))}readRecord(n){this.IsOpened||(this.debug("Opening a box record for reading an item ..."),this._updatedRecords=null,this._updatedRecordsSelected=null,this._updatedIndex=null,this._updatedSearch=null,this.initialize(n,GUI.Box.BoxRecord.MODE_READ,!0),this._buttonFirst.Visible=!1,this._buttonPrevious.Visible=!1,this._buttonOK.Visible=!1,this._buttonOK.Action=null,this._buttonCancel.Visible=!1,this._buttonClose.Visible=!0,this._buttonSearch.Visible=!1,this._buttonNext.Visible=!1,this._buttonLast.Visible=!1,this.open(),this._buttonClose.focus(),this.debug("Box record is opened for reading an item"))}updateRecord(n,t,i){function u(n,t){if(n._updatedRecords===null||t==="ok")return!0;switch(t){case"first":n.onFirstRecord();break;case"previous":n.onPreviousRecord();break;case"search":n.onSearchRecord();break;case"next":n.onNextRecord();break;case"last":n.onLastRecord()}return!1}function f(n,t){return async function(){let f=n._originRecord,o=n.Value,r=new Errors;n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel()));let e=n._list.updateItem(f.Id,f,o,r,!0);if(n._list.endTransaction(),r.HasError){n.Error=r;n._commit&&await n._list.rollbackAsync();return}n._commit&&(n._currentRecord=e,await n._list.commitAsync());i&&i(e);u(n,t)&&n.close()}}function r(n,t){return async function(){let e=n._originRecord,s=n.Value;if(DSRecord.IsEqual(e,s))return n.debug("Record unchanged"),u(n,t);n.debug("Updating record ...");let o=new Errors;n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel()));let r=n._list.updateItem(e.Id,e,s,o,!1);return(n._list.endTransaction(),Helper.IsLabel(r))?(await n._list.rollbackAsync(),GUI.Box.Message.Message(n.Title,r,f(n,t)),!1):o.HasError?(n._commit&&await n._list.rollbackAsync(),o):(n._commit&&(n._currentRecord=r,await n._list.commitAsync()),i&&i(r),u(n,t))}}function e(n){return function(){function r(){let r=new Errors;n._list.cancelItem(t.Id,i,t,r);r.HasError?n.Error=r:n.close()}n.debug("Cancelling record ...");let i=n._originRecord,t=n.Value;return DSRecord.IsEqual(i,t)?!0:(GUI.Box.Message.Message(n.Title,"MSG_CONFIRMATION_CANCEL",r),!1)}}if(!this.IsOpened){if(this.debug("Opening a box record for updating an item ..."),Array.isArray(n)){let i=0;this._updatedRecords=[];this._updatedRecordsSelected=[];for(let n of Array.toIterable(n))this._updatedRecords.push(this.List.getId(n)),this.isSelectedRecord(n,this._updatedSearch)&&this._updatedRecordsSelected.push(i),i++;this._updatedSearch=null;this._updatedIndex=0;this.initialize(this._updatedRecords[this._updatedRecordsSelected[this._updatedIndex]],t?t:GUI.Box.BoxRecord.MODE_UPDATE,!1);this._buttonFirst.Visible=!0;this._buttonFirst.Readonly=this._updatedIndex<=0;this._buttonFirst.Action=r(this,"first");this._buttonPrevious.Visible=!0;this._buttonPrevious.Readonly=this._updatedIndex<=0;this._buttonPrevious.Action=r(this,"previous");this._buttonSearch.Visible=!0;this._buttonSearch.Readonly=!1;this._buttonSearch.Action=r(this,"search");this._buttonNext.Visible=!0;this._buttonNext.Readonly=this._updatedIndex>=this._updatedRecords.length-1;this._buttonNext.Action=r(this,"next");this._buttonLast.Visible=!0;this._buttonLast.Readonly=this._updatedIndex>=this._updatedRecords.length-1;this._buttonLast.Action=r(this,"last")}else this._updatedRecords=null,this._updatedRecordsSelected=null,this._updatedIndex=null,this._updatedSearch=null,this.initialize(n,t?t:GUI.Box.BoxRecord.MODE_UPDATE,!1),this._buttonFirst.Visible=!1,this._buttonPrevious.Visible=!1,this._buttonSearch.Visible=!1,this._buttonNext.Visible=!1,this._buttonLast.Visible=!1;this._buttonOK.Visible=!0;this._buttonOK.Action=r(this,"ok");this._buttonCancel.Visible=!0;this._buttonCancel.Action=e(this);this._buttonClose.Visible=!1;this.open();this.debug("Box record is opened for updating an item")}}deleteRecord(n){function t(n){return async function(){let t=new Errors;return(n._list.beginTransaction(Helper.Label(n.Name.toUpperCase()+"_"+n.Mode.toUpperCase()+"D_TOAST",n.getRecordLabel())),n._list.deleteItem(n._originRecord.Id,n._originRecord,t),n._list.endTransaction(),t.HasError)?(n._commit&&await n._list.rollbackAsync(),t):(n._commit&&await n._list.commitAsync(),!0)}}this.IsOpened||(this.debug("Opening a box record for deleting an item ..."),this.initialize(n,GUI.Box.BoxRecord.MODE_DELETE,!0),this._updatedRecords=null,this._updatedRecordsSelected=null,this._updatedIndex=null,this._updatedSearch=null,this._buttonFirst.Visible=!1,this._buttonPrevious.Visible=!1,this._buttonOK.Visible=!0,this._buttonOK.Action=t(this),this._buttonCancel.Visible=!0,this._buttonClose.Visible=!1,this._buttonSearch.Visible=!1,this._buttonNext.Visible=!1,this._buttonLast.Visible=!1,this.open(),this.debug("Box record is opened for deleting an item"))}constructor(n,t){super(n,"box_record");this._initializing=!1;this._refreshing=!1;this._noSequence=!1;this._table=n;this._list=t?t:new List.ListRecord(n);this._originRecord=null;this._currentRecord=null;this._commit=!1;this._loopOnCreate=!1;this._buttonFirst=null;this._buttonPrevious=null;this._buttonOK=null;this._buttonCancel=null;this._buttonClose=null;this._buttonSearch=null;this._buttonNext=null;this._buttonLast=null;this._updatedRecords=null;this._updatedRecordsSelected=null;this._updatedIndex=null;this._updatedSearch=null}});GUI.Box.BoxReleaseNotes=(class extends GUI.Box.Box{drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK)}open(){super.open();this.firstFocus()}constructor(n){if(super("releasenotes","box_releasenotes"),this.Title="TITLE_RELEASENOTES",this.draw(),n!==null&&n!==undefined&&n.lines!==null&&n.lines!==undefined){let t="";for(let i=0;i<n.lines.length;i++)t+=n.lines[i];this.ContentZone.append(t);this.ContentZone.show()}}static Open(n){this._instance||(this._instance=new GUI.Box.BoxReleaseNotes(n));this._instance.open()}});GUI.Box.BoxSelect=(class extends GUI.Box.Box{set FilterInList(n){this._fnFilterInList=n?n:null;this._list!==null&&(this._list.Filter=this._fnFilterInList)}set Label(n){this._label=n===null||n===undefined?null:n;this._fieldFilter!==null&&(this._fieldFilter.Label=this._label)}set Filter(n){(this._filter=n===null||n===undefined?null:n,this._fieldFilter!==null)&&(this._fieldFilter.Value=String.convertValue(this._filter),this.IsOpened&&this.updateListFiltered())}set List(n){(this._list=n===undefined||n===null?null:n,this._list!==null&&this._fnFilterInList!==null&&(this._list.Filter=this._fnFilterInList),this.Component!==null)&&this.IsOpened&&this.updateList()}get List(){return this._list}set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Autovalidation(n){this._autovalidation=n!==null&&n!==undefined&&n;this._autovalidation&&(this._multiSelect=!1)}set MultiSelect(n){this._multiSelect=n!==null&&n!==undefined&&n===!0;this._multiSelect&&(this._autovalidation=!1)}set Value(n){let t=this._value;if(!this._multiSelect){if(this._value=String.convertValue(n),this.Component===null||!this.IsOpened)return;t!==null&&this._pictures.find("#"+t+" > img").removeClass("selected");this._value!==null&&(this._pictures.find("#"+this._value).show(),this._pictures.find("#"+this._value+" > img").addClass("selected"));return}if(String.isEmptyOrWhiteSpaces(n))this._value=[];else if(Array.isArray(n)){this._value=[];for(let n of Array.toIterable(n))this._value.push(String.convertValue(n))}else this._value=[String.convertValue(n)];if(this.Component!==null&&this.IsOpened){if(t!==null&&t!==undefined)if(Array.isArray(t))for(let n of Array.toIterable(t))this._pictures.find("#"+n+" > img").removeClass("selected");else this._pictures.find("#"+t+" > img").removeClass("selected");if(this._value!==null&&this._value!==undefined)for(let n of Array.toIterable(this._value))this._pictures.find("#"+n).show(),this._pictures.find("#"+n+" > img").addClass("selected")}}get Value(){return this._multiSelect?String.isEmptyOrWhiteSpaces(this._value)?null:Array.isArray(this._value)?[].concat(this._value):[String.convertValue(this._value)]:this._value}destructor(){super.destructor();this._fieldFilter!==null&&(this._fieldFilter.destructor(),this._fieldFilter=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null)}drawButton(n){super.drawButton(n);this.declareButton(GUI.Box.Box.BUTTON_OK);this.declareButton(GUI.Box.Box.BUTTON_CANCEL,"BTN_CANCEL")}drawContent(n){function t(n){return function(t,i){i===undefined&&n.refresh()}}this._fieldFilter=this.declareField(new GUI.Field.FieldInput(this,"filter_"+this.Name,this._label));n.append("<div class='pictures'><\/div>");n.show();this._pictures=n.find(".pictures");this._languageListener=Language.Manager.Instance.addListener(t(this));this._fieldFilter.on("change",t(this));this.List=this._list}refresh(){super.refresh();this.Filter=this._fieldFilter.Value;this.getButton(GUI.Box.Box.BUTTON_OK).Visible=!this._autovalidation||this._allowNullValue}onOpen(){function n(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.setFocus(n._fieldFilter):n.getButton(GUI.Box.Box.BUTTON_OK).Visible?n.setFocus(n.getButton(GUI.Box.Box.BUTTON_OK)):n.getButton(GUI.Box.Box.BUTTON_CANCEL).Visible?n.setFocus(n.getButton(GUI.Box.Box.BUTTON_CANCEL)):n.setFocus(n._fieldFilter),!1;case"Enter":return t.stopImmediatePropagation(),$(this).click(),n._multiSelect||n.getButton(GUI.Box.Box.BUTTON_OK).Component.click(),!1;case" ":return t.stopImmediatePropagation(),$(this).click(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case"ArrowLeft":return t.stopImmediatePropagation(),n.leftFocus(),!1;case"ArrowUp":return t.stopImmediatePropagation(),n.upFocus(),!1;case"ArrowRight":return t.stopImmediatePropagation(),n.rightFocus(),!1;case"ArrowDown":return t.stopImmediatePropagation(),n.downFocus(),!1}}}function t(n){return function(){n.setFocus($(this))}}function i(n){return function(){n.setFocus($(this));let t=String.convertValue($(this).attr("id"));if(n._multiSelect){for(let i in n._value)if(n._value[i]===t){if(n._value.length===1&&!n._allowNullValue)return;n._pictures.find("> #"+n._value[i]+" > img").removeClass("selected");n._value.splice(i,1);return}(n._value===null||n._value===undefined)&&(n._value=[]);n._value.push(t);n._pictures.find("> #"+t+" > img").addClass("selected")}else n._value!==null&&n._pictures.find("> #"+n._value+" > img").removeClass("selected"),n._value=t===n._value?null:t,n._allowNullValue||n._value!==null||(n._value=t),n._value!==null&&(n._pictures.find("> #"+n._value+" > img").addClass("selected"),n._autovalidation&&n.getButton(GUI.Box.Box.BUTTON_OK).Component.click())}}super.onOpen();this._currentList=this._list?this._list.getList():[];this.updateList();this.ContentZone.find("> .pictures > div").on("keydown",n(this));this.ContentZone.find("> .pictures > div").on("focus",t(this));this.ContentZone.find("> .pictures > div").on("click",i(this))}open(){super.open();this.firstFocus()}onClose(){super.onClose();this.ContentZone.find("> .pictures > div").off("click keydown focus");this._pictures.html("");this._currentList=null}previousFocus(){if(this._focusIndex===this._focus.length-1){if(this.getButton(GUI.Box.Box.BUTTON_OK).Visible){this.setFocus(this.getButton(GUI.Box.Box.BUTTON_OK));return}this.setFocus(this._fieldFilter);this.nextFocus();return}if(this._focusIndex===this._focus.length-2&&this.getButton(GUI.Box.Box.BUTTON_OK).Visible){this.setFocus(this._fieldFilter);this.nextFocus();return}super.previousFocus()}updateListFiltered(){if(this._currentList!==null){let n=String.convertValue(this._fieldFilter.Value);n!==null&&(n=n.toUpperCase());this.clearFocus();this.addFocus(this._fieldFilter);for(let t of Array.toIterable(this._currentList))if(this._list.isVisible(t)){let u=String.convertValue(this._list.getId(t));if(u!==null){let i=this._list.getPicture(t);if(i!==null&&i!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(i=this._list.DefaultPicture),i!==null&&i!==undefined){let f="",e=this._list.getText(t);f=String.isEmptyOrWhiteSpaces(e)?Language.Manager.Instance.interpolation(this._list.getLanguageLabel(t)):e;let r=this._pictures.find("> #"+u);n===null||f.toUpperCase().indexOf(n)>=0?(r.show(),this.addFocus(r),r.focus(function(){$(this).addClass("focus")}),r.blur(function(){$(this).removeClass("focus")})):r.hide()}}}this.addFocus(this.getButton(GUI.Box.Box.BUTTON_OK));this.addFocus(this.getButton(GUI.Box.Box.BUTTON_CANCEL))}}updateList(){if(this._pictures!==null){let n="";for(let t of Array.toIterable(this._currentList))if(this._list.isVisible(t)){let r=String.convertValue(this._list.getId(t));if(r!==null){let i=this._list.getPicture(t);if(i!==null&&i!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(i=this._list.DefaultPicture),i!==null&&i!==undefined){let u="",f=this._list.getText(t);u=String.isEmptyOrWhiteSpaces(f)?Helper.Span(this._list.getLanguageLabel(t)):String.encode(f);n+="<div id='"+r+"'><img id='picture' src='"+i+"' /><div id='name'>"+u+"<\/div><\/div>"}}}if(this._pictures.html(n),this._value!==null&&this._value!==undefined)if(Array.isArray(this._value)){let n=[];for(let t of Array.toIterable(this._value))this._pictures.find("> #"+t+" > img").length>0&&(this._pictures.find("> #"+t+" > img").addClass("selected"),n.push(t));this._value=n}else this._pictures.find("> #"+this._value+" > img").length===0?this._value=null:this._pictures.find("> #"+this._value+" > img").addClass("selected");this.updateListFiltered()}}constructor(n,t){super(n,"box_select");this._label=Helper.Label(t);this._filter=null;this._list=null;this._value=null;this._fnFilterInList=null;this._fieldFilter=null;this._pictures=null;this._languageListener=null;this._allowNullValue=!0;this._autovalidation=!1;this._multiSelect=!1;this._currentList=null;this.draw();this.List=new List.List}static get Instance(){return this._instance||(this._instance=new GUI.Box.BoxSelect("boxselect")),this._instance}static Open(n,t,i,r,u,f){GUI.Box.BoxSelect.Instance.Title=n;GUI.Box.BoxSelect.Instance.Message=t;GUI.Box.BoxSelect.Instance.Error=null;GUI.Box.BoxSelect.Instance.Label=null;GUI.Box.BoxSelect.Instance.List=r;GUI.Box.BoxSelect.Instance.List.Filter=u;GUI.Box.BoxSelect.Instance.AllowNullValue=!1;GUI.Box.BoxSelect.Instance.Autovalidation=!1;GUI.Box.BoxSelect.Instance.Value=i;GUI.Box.BoxSelect.Instance.getButton(GUI.Box.Box.BUTTON_OK).Action=f;GUI.Box.BoxSelect.Instance.open()}});GUI.Button={};GUI.Button.Button=(class extends GUI.GUI{set Label(n){this._label=Helper.Label(n)}set Action(n){this._action=n?n:null}get Readonly(){return this._readonly}set Readonly(n){super.Readonly=n}draw(){super.draw("<button id='"+this.Name+"'>"+Helper.Span(this._label)+"<\/button>")}onOpen(){function n(n){return async function(){function i(n){return function(t){if(typeof t=="boolean"){t&&n.Box!==null&&n.Box.close();return}if(typeof t=="string"||t instanceof Errors){n.Box!==null&&(n.Box.Error=t);return}n.Box!==null&&n.Box.close()}}if(!n.Readonly){if(n._action===null){n.Box!==null&&n.Box.close();return}let t=undefined;if(n.Box!==null&&!String.isEmptyOrWhiteSpaces(n.Box.Value)){let i=null;try{t=n.Box.Value;i=n.Box.checkValue(t)}catch(r){n.exception("Unexpected error on clicking",r);n.Box!==null&&(n.Box.Error="ERR_EXCEPTION_UNEXPECTED")}if(i!==!0){n.Box.Error=i;return}}if(n._action.constructor.name==="AsyncFunction"){await n._action(t).then(i(n));return}try{i(n)(n.Box===null?n._action():n._action(t))}catch(r){n.exception("Unexpected error on clicking",r);n.Box!==null&&(n.Box.Error="ERR_EXCEPTION_UNEXPECTED")}}}}function t(n){return function(){n.Readonly||n.Box!==null&&n.Box.setFocus(n)}}function i(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case"Enter":case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1}}}super.onOpen();this.Component.on("focus",t(this));this.Component.on("keydown",i(this));this.Component.on("click",n(this))}onClose(){super.onClose();this.Component.off("focus keydown click")}refresh(){if(super.refresh(),this.Component!==null){let n=Helper.Span(this._label);if(String.isEmptyOrWhiteSpaces(n)){this.Component.html("");this.Component.hide();return}if(this.Component.html(n),this.Readonly){this.Component.hasClass("readonly")||this.Component.addClass("readonly");return}this.Component.hasClass("readonly")&&this.Component.removeClass("readonly")}}onMouseClick(){this.Visible&&!this.Readonly&&this.Component!==null&&this.Component.click()}constructor(n,t,i,r,u){super("button",n,t,i);n instanceof GUI.Box.BoxChoice?this._container=n.ContentZone:n instanceof GUI.Box.Box&&(this._container=n.ButtonZone);this._label=Helper.Label(r);this._label.label===null&&(this._label=Helper.Label("BTN_OK"));this._action=u?u:null;this.draw()}});GUI.Field={};GUI.Field.Field=(class extends GUI.GUI{get FieldZone(){return this.Component.find("> .value > .field")}get MessageZone(){return this.Component.find("> .value > .message")}get ErrorZone(){return this.Component.find("> .value > .error")}set Label(n){this._label=Helper.Label(n)}get Label(){return this._label}set Panel(n){this._panel=n}get Panel(){return this._panel}set Link(n){this._fnLink=n?n:null;this.refreshLink()}set Message(n){if(n===null||n===undefined||String.isEmptyOrWhiteSpaces(n)){this.Component.hasClass("message")&&this.Component.removeClass("message");this.MessageZone.html("");return}this.Component.hasClass("message")||this.Component.addClass("message");this.MessageZone.html(n)}set Error(n){if(n===null||n===undefined||String.isEmptyOrWhiteSpaces(n)){this.Component.hasClass("error")&&this.Component.removeClass("error");this.ErrorZone.html("");return}this.debug("Error = "+n);this.Component.hasClass("error")||this.Component.addClass("error");this.ErrorZone.html(n)}set Value(n){let t=this._value,i=n;n===undefined&&(n=null);this._value=n;typeof this._value=="string"?this._value=this._value.trim():this._value instanceof moment?this._value=this._value.format(List.List.TEXT_FORMAT_DATE):this._value instanceof Date&&(this._value=moment(this._value).format(List.List.TEXT_FORMAT_DATE));t!==this._value?(t=t!==undefined&&t!==null?t.toString():"null",i=this._value!==undefined&&this._value!==null?this._value.toString():"null",this.debug("Replace the value '"+t+"' to '"+i+"'"),this.IsOpened&&(this.refresh(),this.raise("change"))):this.IsOpened&&this.refresh()}get Value(){return this._value}get IsLinked(){return this._fnLink!==null}draw(){super.draw("<field id='"+this.Name+"'><div class='label'><\/div><div class='value'><form class='field'><\/form><div class='message'><\/div><div class='error'><\/div><\/div><\/field>");this.drawField(this.FieldZone)}drawField(){}populate(){this.verbose("Populate")}onOpen(){function n(n){return function(){n.Box!==null&&n.Box.setFocus(n)}}super.onOpen();this.Component.on("focus",n(this))}onClose(){super.onClose();this.Component.off("focus")}onFocusIn(){}onFocusOut(){}refreshLink(){if(this.Component!==null){let n=this.Component.find("> .label"),t=Helper.Span(this._label);if(String.isEmptyOrWhiteSpaces(t)){n.html("");n.hasClass("hide")||n.addClass("hide");return}if(n.html(t),n.hasClass("hide")&&n.removeClass("hide"),n.off("click"),n.removeClass("link"),this._fnLink){n.on("click",this._fnLink);n.addClass("link")}}}refresh(){(super.refresh(),this.Component!==null)&&this.refreshLink()}cleanUndo(){this.verbose("Clean up undo stack")}constructor(n,t,i,r){super("field",n,t,r);this._label=Helper.Label(i);this._value=null;this._fnLink=null;this._panel=null}});GUI.Field.FieldCheckBox=(class extends GUI.Field.Field{set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Value(n){this._allowNullValue||n!==null&&n!==undefined||(n=!0);switch(typeof n){case"boolean":break;case"number":n=n!==0;break;case"string":n=n.toUpperCase()==="TRUE"||n.toUpperCase()==="OK"||n==="1";break;default:n=this._allowNullValue?null:!0}super.Value=n}get Value(){return super.Value}get Text(){let t="",n=-1;switch(this.Value){case null:n=0;break;case!0:n=1;break;default:n=2}return this._labels===null||this._labels===undefined||this._labels[n]===null||this._labels[n]===undefined?"":(t=Language.Manager.Instance.interpolation(this._labels[n]),String.isEmptyOrWhiteSpaces(t))?"":t.trim()}drawField(n){n.append("<div><\/div>")}onMouseClick(){if(!this.Readonly){switch(this.Value){case!0:this.Value=this._allowNullValue?null:!1;break;case null:this.Value=!1;break;default:this.Value=!0}GUI.Webix.Tooltip.Instance.IsVisible&&GUI.Webix.Tooltip.Instance.show(String.encode(this.Text))}}onOpen(){function n(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1}}}super.onOpen();this.Component.on("keydown",n(this))}onClose(){super.onClose();this.Component.off("keydown");this.FieldZone.find("div").off("click mouseenter mousemove mouseleave")}refresh(){function i(n){return function(){n.onMouseClick()}}function t(n){return function(t){GUI.Webix.Tooltip.Instance.show(String.encode(n.Text),t)}}function r(){return function(){GUI.Webix.Tooltip.Instance.hide()}}if(super.refresh(),this.Component!==null){let n=this.FieldZone.find("div");if(this.Readonly)n.css("cursor","initial"),n.off("click");else{n.css("cursor","pointer");n.off("click").on("click",i(this))}if(n.off("mouseenter mousemove mouseleave"),this._labels!==null)n.on("mouseenter",t(this)).on("mouseleave",r(this)).on("mousemove",t(this));n.removeClass("true");n.removeClass("false");n.removeClass("null");switch(this.Value){case!0:n.addClass("true");break;case!1:n.addClass("false");break;case null:n.addClass("null")}}}constructor(n,t,i,r){super(n,t,i,"field_checkbox");this._allowNullValue=!1;this._labels=r?r:null;this.draw()}});GUI.Field.FieldFile=(class extends GUI.Field.Field{static get Index(){return this._fieldIndex?this._fieldIndex++:this._fieldIndex=1,this._fieldIndex}set Value(n){super.Value=n}get Value(){return super.Value}set File(n){this._file=n}get File(){return this._file}get Filename(){return this._filename}get FileZone(){return this.Component.find("label")}set Extension(n){(this._extension=String.isEmptyOrWhiteSpaces(n)?null:n,this.Component!==null)&&(this._extension!==null?this.Component.find("input#file_"+this._index.toString())[0].setAttribute("accept",this._extension):this.Component.find("input#file_"+this._index.toString())[0].removeAttribute("accept"))}get Extension(){return this._extension}drawField(n){let t="<label for='file_"+this._index.toString()+"'>";t+="<img id='picture' />";t+="<\/label>";t+=this._extension===null?"<input id='file_"+this._index.toString()+"' type='file' style='display: none;' />":"<input id='file_"+this._index.toString()+"' type='file' accept='"+this._extension+"' style='display: none;' />";n.append(t)}onMouseClick(){this.Component!==null&&this.Component.find("input").click()}loadFile(n,t){function f(n){return function(t){n.info("File '"+n._filename+"' is loaded");n.File=t.target.result;n.Message=n._filename;GUI.Box.Progress.Stop()}}function e(n){return function(){n.error("File '"+n._filename+"' can't be loaded");GUI.Box.Progress.Stop()}}function o(){return function(n){GUI.Box.Progress.SetStatus(n.loaded,n.total)}}this._filename=n.split(/[\\/]/).pop();this.info("Loading file '"+this._filename+"' ...");let i=n.match(/\.([^.]+)$/);if(i.length===0){this.error("Extension missing !");return}i=i[1];let u=!1;for(let n of this._extension.split(","))if(n.toUpperCase()==="."+i.toUpperCase()){u=!0;break}if(!u){this.error("Extension '"+i+"' not allowed !");return}this.Component.find("form")[0].reset();let r=new FileReader;r.onload=f(this);r.onerror=e(this);r.onprogress=o(this);GUI.Box.Progress.Start();GUI.Box.Progress.SetStatus(0,1,"MSG_LOADING");r.readAsDataURL(t)}onOpen(){function n(n){return function(){n.loadFile(this.value,this.files[0])}}function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.Box.onButtonCancel(),!1;case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1}}}function i(){return function(n){n.preventDefault();n.stopPropagation()}}function r(n){return function(){Hub.Instance.IsRunning&&n.FileZone.addClass("is-dragover")}}function u(n){return function(){n.FileZone.removeClass("is-dragover")}}function f(n){return function(t){t.originalEvent.dataTransfer.files.length===1&&n.loadFile(t.originalEvent.dataTransfer.files[0].name,t.originalEvent.dataTransfer.files[0])}}super.onOpen();this.FileZone.on("drag dragstart dragend dragover dragenter dragleave drop",i(this)).on("dragover dragenter",r(this)).on("dragleave dragend drop",u(this)).on("drop",f(this));this.Component.find("#file_"+this._index.toString()).val("");this.Component.find("#file_"+this._index.toString()).on("change",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.Component.find("#file_"+this._index.toString()).off("change");this.Component.off("keydown");this.FileZone.off("drag dragstart dragend dragover dragenter dragleave drop")}refresh(){(super.refresh(),this.Component!==null)&&(this.Component.find("#file_"+this._index.toString()).prop("disabled",this.Readonly),this.Component.find(".value > .field > label > #picture").css("cursor",this.Readonly?"initial":"pointer"))}constructor(n,t,i,r,u){super(n,t,i,"field_file "+r);this._index=GUI.Field.FieldFile.Index;this._extension=u;this._file=null;this._filename=null;this.draw()}});GUI.Field.FieldFileImage=(class extends GUI.Field.FieldFile{get Value(){if(this.Component===null)return super.Value;let n=this.Component.find("#picture > label > #picture")[0];return n?n.src.startsWith("data:image")?n.src:null:super.Value}set Value(n){super.Value=n}set File(n){function t(n){return function(t){t!==undefined?n.Value=t:GUI.Box.Message.Error("ERROR",Helper.Label("ERR_DOWNLOAD_PICTURE",[n._filename]))}}super.File=n;Picture.resize(n,this._image.width,this._image.height,t(this))}get File(){return super.File}set Size(n){n===null||n===undefined?(this._image.width=100,this._image.height=100):(this._image.width=n.width===undefined||n.width===null?100:n.width,this._image.height=n.height===undefined||n.height===null?100:n.height)}get Size(){return{width:this._image.width,height:this._image.height}}refresh(){if(super.refresh(),this.Component!==null){let i=this._value===null?this._image.picture:this._value,t=this.Component.find(".value > .field > label"),n=this.Component.find(".value > .field > label > #picture");if(t.width()>0){let u=t.width(),f=t.height(),i=this._image.width,r=this._image.height;if(i>u||r>f){let n=u/i,t=f/r;t<n?(r=Math.floor(r*t),i=Math.floor(i*t)):(r=Math.floor(r*n),i=Math.floor(i*n))}n.css("width",i+"px");n.css("height",r+"px")}String.isEmptyOrWhiteSpaces(i)?(n.removeAttr("src"),n.hide()):(n.attr("src",i),n.show())}}constructor(n,t,i,r){super(n,t,i,"field_file_image");this._image=r===null||r===undefined?{extensions:null,picture:null,width:null,height:null}:{extensions:r.extensions,picture:r.picture,width:r.width,height:r.height};(this._image.extensions===undefined||this._image.extensions===null)&&(this._image.extensions=".gif,.png,.jpg,.bmp,.svg,.tif,.jpeg");(this._image.picture===undefined||this._image.picture===null)&&(this._image.picture=null);(this._image.width===undefined||this._image.width===null)&&(this._image.width=100);(this._image.height===undefined||this._image.height===null)&&(this._image.height=100);this.Extension=this._image.extensions}});GUI.Field.FieldFileCSV=(class extends GUI.Field.FieldFile{get Charset(){return this._charset===null?DSDatabase.Instance.Parameters["CSV.Charset"]:this._charset}set Charset(n){this._charset=String.isEmptyOrWhiteSpaces(n)?null:n}get Separator(){return this._separator===null?DSDatabase.Instance.Parameters["CSV.Separator"]:this._separator}set Separator(n){this._separator=String.isEmptyOrWhiteSpaces(n)?null:n}set File(n){if(String.isEmptyOrWhiteSpaces(n)){super.File=null;return}if(!n.startsWith("data:")||!n.includes("base64,")){super.File=null;return}GUI.Box.Progress.SetStatus(1,2);try{super.File=new CSV(this.Name,this.Charset.toLowerCase()==="utf-8"?String.base64DecodeUnicode(n.substring(n.indexOf("base64,")+7)):atob(n.substring(n.indexOf("base64,")+7)),this.Separator,this.Charset.toLowerCase())}catch(t){this.exception("Exception on reading CSV file",t);this.Error="ERR_CSV_BADFORMATED_FILE";super.File=null}GUI.Box.Progress.SetStatus(2,3)}get File(){return super.File}constructor(n,t,i){super(n,t,i,"field_file_csv",".csv");this._charset=null;this._separator=null}});GUI.Field.FieldInput=(class extends GUI.Field.Field{static get TYPE_INPUT(){return"input"}static get TYPE_TEXTAREA(){return"textarea"}set Value(n){super.Value=n}get Value(){return this.Component===null?super.Value:this.FieldZone.find(this._type).val().trim()}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}set AllowRC(n){this._allowRC===GUI.Field.FieldInput.TYPE_INPUT?!1:n!==null&&n!==undefined&&n===!0}onOpen(){function t(n){return function(){let t=$(this).val();n._value=t;n._maxLength!==null&&(n.Message=n._maxLength>0&&t.length>=parseInt(n._maxLength*9/10)?Helper.Span("FIELD_MAX_LENGTH",n._maxLength):null);clearTimeout(n._throttle);n._throttle=setTimeout(()=>{n.raise("change")},300)}}function i(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":if(n._allowRC){GUI.Box.BOX_RC=!0;return}return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1}}}function r(n){return function(){n._throttle!==null&&(clearTimeout(n._throttle),n._throttle=null,n.raise("change"))}}function n(n,t){return function(){n.Box!==null&&n.Box.setFocus(n);t||n.FieldZone.find(n._type).focus()}}super.onOpen();this.FieldZone.find(this._type).on("keydown",i(this)).on("input",t(this)).on("blur",r(this)).on("focus",n(this,!0));this.Component.off("focus").on("focus",n(this,!1))}onClose(){super.onClose();this.FieldZone.find(this._type).off("keydown input blur")}refresh(){if(super.refresh(),this.Component!==null){let t=this.FieldZone.find(this._type);t.prop("disabled",this.Readonly);t.val(String.isEmptyOrWhiteSpaces(this._value)?"":this._value.toString());let n=this.FieldZone.find(".unit");if(n.length>0){let t=String.encode(this._unit);String.isEmptyOrWhiteSpaces(t)?n.hasClass("hide")||n.addClass("hide"):(n.hasClass("hide")&&n.removeClass("hide"),this.FieldZone.find(".unit").html(t))}this._maxLength!==null&&t.attr("maxlength",this._maxLength)}}drawField(n){switch(this._type){case GUI.Field.FieldInput.TYPE_INPUT:n.append("<input type='text' /><div class='unit'><\/div>");break;case GUI.Field.FieldInput.TYPE_TEXTAREA:n.append("<textarea><\/textarea>")}}focus(){return super.focus()?(this.Component.find(this._type).focus().select(),!0):!1}constructor(n,t,i,r,u,f){r=r?r:GUI.Field.FieldInput.TYPE_INPUT;super(n,t,i,"field_"+r);this._type=r?r:GUI.Field.FieldInput.TYPE_INPUT;this._unit=u===null||u===undefined?null:u;this._allowRC=this._type===GUI.Field.FieldInput.TYPE_TEXTAREA;this._maxLength=f===null||f===undefined||isNaN(parseInt(f))?null:parseInt(f);this._maxLength=this._maxLength<=0?null:this._maxLength;this.draw()}});GUI.Field.FieldInputDigit=(class extends GUI.Field.Field{set ShowKeyboard(n){this._showKeyboard=n!==null&&n!==undefined&&n===!0}set AsString(n){this._asString=n!==null&&n!==undefined&&n===!0}set Value(n){let t=this._digits.Value;if(this._digits.Value=n,t!==n){t=t!==undefined&&t!==null?t.toString():"null";let i=n!==undefined&&n!==null?n.toString():"null";this.debug("Replace the value '"+t+"' to '"+i+"'");this.IsOpened&&(this.refresh(),this.raise("change"))}else this.IsOpened&&this.refresh()}get Value(){return this._digits.IsNull?null:this._asString?this._digits.toString():this._digits.Value}set Unit(n){this._unit=n===null||n===undefined?null:n;this.refresh()}get Unit(){return this._unit}set NbDecimals(n){if(this._digits instanceof Digits.Decimal){let t=new Digits.Decimal(this._digits.NbDigitBefore,n);t.Value=this._digits.Value;this._digits=t;this.refresh()}}destructor(){super.destructor();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null)}addKey(n){if(!this.Readonly){let i=this._digits.CurrentValue;this._digits.addKey(n);let t=this._digits.CurrentValue;if(i!==t){i=i!==undefined&&i!==null?i.toString():"null";let n=t!==undefined&&t!==null?t.toString():"null";this.IsOpened&&(this.refresh(),this.raise("change"))}else this.IsOpened&&this.refresh();this._calendar!==null&&t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}drawCalendar(){function i(n){return function(t){n._notRefresh||(n._digits.setDate(t.getDate(),t.getMonth()+1,1900+t.getYear()),n.refresh(),n.raise("change"),n.focus())}}if(this._calendar!==null&&(this._calendar.destructor(),this._calendar=null),this._digits instanceof Digits.Datetime&&this._showKeyboard){let n=this._digits.WebixType;if(n!==null){this._calendar=new webix.ui({view:"calendar",type:n==="day"?undefined:n,container:this.Component.find("#calendar")[0],weekHeader:n==="day",weekNumber:n==="day",calendarDateFormat:this._digits.WebixFormat,on:{onChange:i(this)}});let t=this._digits.Value;t!==null&&(this._notRefresh=!0,this._calendar.setValue(t.toDate()),this._notRefresh=!1)}}}drawField(n){let i=["7","8","9","4","5","6","1","2","3"],t="<div id='field'><div class='field'><\/div><div class='unit'><\/div><\/div>";t+="<div id='keyboard' class='hide'>";for(let n=0;n<i.length;n++)t+="<div class='key' key='"+i[n]+"'><div>"+String.encode(i[n])+"<\/div><\/div>";t+="<div class='key undo' key='undo'><\/div>";t+="<div class='key' key='0'><div>0<\/div><\/div>";t+="<div class='key next minus' key='next'><\/div>";t+="<div class='key value minus' key='minus'>"+String.encode("-")+"<\/div>";t+="<\/div>";t+="<div id='calendar'><\/div>";n.append(t)}onOpen(){function n(n){return function(t,i){n._calendar!==null&&i===undefined&&n.drawCalendar()}}function t(n){return function(t){switch(t.key){case"Backspace":return t.stopImmediatePropagation(),n.addKey("undo"),!1;case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case"Delete":return t.stopImmediatePropagation(),n.addKey("raz"),!1}}}function i(n){return function(t){let i=t.which||t.keyCode;i<32||(t.stopImmediatePropagation(),n.addKey(String.fromCharCode(i)))}}function r(n){return function(){n.addKey($(this).attr("key"));n.focus()}}function u(n){return function(){function i(n){return function(t){n.Value=t;n.focus()}}function r(n){return function(){n.focus()}}if(!n.Readonly&&!n._showKeyboard){let t=null;n.Box instanceof GUI.Box.Box&&n.Box.List!==null&&n.Box.List!==undefined&&n.Box.List.Table!==null&&n.Box.List.Table!==undefined&&(t=n.Box.List.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase());(t===null||Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,t)===null)&&(t="TITLE_SELECT_"+n.Name.toUpperCase());Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,t)===null&&(t="TITLE_SELECT_"+n._digits.Type.toUpperCase());GUI.Box.BoxInputDigit.Digit(t,n.Label,n.Unit,n._digits.clone(),n.Component.find(".value > .field > #field > .field").css("text-align"),i(n),r(n))}}}super.onOpen();this.drawCalendar();this._languageListener=Language.Manager.Instance.addListener(n(this));this.Component.on("keydown",t(this));this.Component.on("keypress",i(this));this.Component.on("dblclick",u(this));this.Component.find("#keyboard > .key").on("click",r(this));this._digits.selectAll()}onClose(){super.onClose();this._calendar!==null&&(this._calendar.destructor(),this._calendar=null);this._languageListener!==null&&(Language.Manager.Instance.removeListener(this._languageListener),this._languageListener=null);this.Component.off("keydown keypress dblclick");this.Component.find("#keyboard > .key").off("click")}onFocusIn(){if(super.onFocusIn(),this._digits.selectAll(),this._keyboardVisible=!0,this._showKeyboard){let n=this.Component.find("#calendar"),t=this.Component.find("#keyboard");this._digits.IsCalendar?(n.hasClass("hide")&&n.removeClass("hide"),t.hasClass("hide")||t.addClass("hide")):(n.hasClass("hide")||n.addClass("hide"),t.hasClass("hide")&&t.removeClass("hide"))}}onFocusOut(){super.onFocusIn();let n=this.Component.find("#calendar"),t=this.Component.find("#keyboard");this._keyboardVisible=!1;t.hasClass("hide")||t.addClass("hide");n.hasClass("hide")||n.addClass("hide")}refresh(){if(super.refresh(),this.Component!==null){this.FieldZone.find(".field").html(this._digits.toHTML());let t=this.FieldZone.find(".unit");if(t.length>0){let n=String.encode(this._unit);String.isEmptyOrWhiteSpaces(n)?t.hasClass("hide")||t.addClass("hide"):(t.hasClass("hide")&&t.removeClass("hide"),t.html(n))}let n=this.Component.find("#keyboard > .next"),f=this._digits.NextTokenFix;String.isEmptyOrWhiteSpaces(f)?(n.hasClass("empty")||n.addClass("empty"),this.Component.find("#keyboard > .next").html("")):(n.hasClass("empty")&&n.removeClass("empty"),this.Component.find("#keyboard > .next").html(String.encode(f)));this._digits.AllowNegativeValue?(n.hasClass("minus")||n.addClass("minus"),this.Component.find("#keyboard > .key.value.minus").show()):(n.hasClass("minus")&&n.removeClass("minus"),this.Component.find("#keyboard > .key.value.minus").hide());let u=this.Component.find("#keyboard > .undo");this._digits.HasUndo?u.hasClass("empty")&&u.removeClass("empty"):u.hasClass("empty")||u.addClass("empty");let i=this.Component.find("#calendar"),r=this.Component.find("#keyboard");this._keyboardVisible&&this._showKeyboard?this._digits.IsCalendar?(i.hasClass("hide")&&i.removeClass("hide"),r.hasClass("hide")||r.addClass("hide")):(i.hasClass("hide")||i.addClass("hide"),r.hasClass("hide")&&r.removeClass("hide")):(i.hasClass("hide")||i.addClass("hide"),r.hasClass("hide")||r.addClass("hide"))}}cleanUndo(){super.cleanUndo();this._digits.cleanUndo()}constructor(n,t,i,r,u){r=r===null||r===undefined?new Digits.Digits:r;super(n,t,i,"field_input_digit "+r.Type);this._digits=r;this._unit=u===null||u===undefined?null:u;this._showKeyboard=!1;this._calendar=null;this._languageListener=null;this._keyboardVisible=!1;this._notRefresh=!1;this._asString=!1;this.draw()}});GUI.Field.FieldInputWithBox=(class extends GUI.Field.Field{static CACHE_BOX(n){let i=null;if(this._addonBox||(this._addonBox={}),n instanceof Digits.Digits)i="digits";else if(typeof n=="string")i=n;else return null;let r=this._addonBox[i];if(r!==undefined)return r;let t={name:null,box:null,list:null,digits:null};return n instanceof Digits.Digits?(t.digits=n,t.name=n.Type.toLowerCase()):DSDatabase.Instance.Tables[n]!==undefined?(t.name=n.toLowerCase(),t.box=new GUI.Box.BoxSelect(n,"SELECT_NAME"),t.list=List.ListRecord.CACHE_LIST(n)):(t.digits=Digits.Digits.Factory(n),t.digits!==null&&(t.name=t.digits.Type.toLowerCase())),this._addonBox[i]=t,t}set Value(n){if(this._withBox.box!==null){super.Value=n;return}let t=this._value,i=n;n===undefined&&(n=null);this._withBox.digits.Value=n;this._value=this._withBox.digits.Value;t!==this._value?(t=t!==undefined&&t!==null?t.toString():"null",i=this._value!==undefined&&this._value!==null?this._value.toString():"null",this.debug("Replace the value '"+t+"' to '"+i+"'"),this.IsOpened&&(this.refresh(),this.raise("change"))):this.IsOpened&&this.refresh()}get Value(){return super.Value}set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set FilterInBox(n){this._fnFilterInBox=n?n:null}get DatabaseTableReference(){return this._withBox.list===null?null:this._withBox.list.Table}drawField(n){n.append("<div class='value'><\/div><div class='icon'><\/div>")}onMouseClick(){this.Component===null||this.Readonly||this.FieldZone.find(".icon").click()}onOpen(){function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1;case"Delete":return t.stopImmediatePropagation(),n.Value=null,!1}}}function n(n){return function(){function t(n){return function(t){return n.Value=t,!0}}function i(n){return function(){n.focus()}}if(n._withBox!==null&&!n.Readonly){if(n._withBox.box!==null){let u=n._withBox.list.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase();Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,u)===null&&(u="TITLE_SELECT_"+n.DatabaseTableReference.toUpperCase());let r=null;(n.Label===null||n.Label.label===null||n.Label.label===undefined)&&(r=DSDatabase.Instance.getColumnLabel(n._withBox.list.Table,n.Name),Language.Manager.Instance.getLabel(DSDatabase.Instance.CurrentLanguage,r)===null&&(r=null));n._withBox.box.AllowNullValue=n._allowNullValue;n._withBox.box.Autovalidation=!0;n._withBox.box.List=n._withBox.list;n._withBox.box.FilterInList=n._fnFilterInBox;n._withBox.box.OnClosed=i(n);n._withBox.box.getButton(GUI.Box.Box.BUTTON_OK).Action=t(n);n._withBox.box.Title=u;n._withBox.box.Label=r;n._withBox.box.Value=n.Value;n._withBox.box.Error=null;n._withBox.box.open()}if(n._withBox.digits!==null){let r=null;n.Box instanceof GUI.Box.Box&&n.Box.List!==null&&n.Box.List!==undefined&&n.Box.List.Table!==null&&n.Box.List.Table!==undefined&&(r=n.Box.List.Table.toUpperCase()+"_SELECT_"+n.Name.toUpperCase());r!==null&&Language.Manager.Instance.existLabel(r)||(r="TITLE_SELECT_"+n.Name.toUpperCase());Language.Manager.Instance.existLabel(r)||(r="TITLE_SELECT_"+n._withBox.name.toUpperCase());n._withBox.digits.Value=n.Value;GUI.Box.BoxInputDigit.Digit(r,n.Label,null,n._withBox.digits,n.Component.find(".value > .field > .value").css("text-align"),t(n),i(n))}}}}super.onOpen();this.Component.on("keydown",t(this));this.Component.find(".field").on("dblclick",n(this));this.FieldZone.find(".icon").on("click",n(this))}onClose(){super.onClose();this.Component.off("keydown");this.Component.find(".field").off("dblclick");this.Component.find(".label").off("click");this.FieldZone.find(".icon").off("click")}refresh(){function u(n){return function(){function i(n,t){return function(){n.OnClose=null;t.focus()}}if(!String.isEmptyOrWhiteSpaces(n.Value)){let t=GUI.Box.BoxRecord.CACHE_DIALOG_BOX(n.DatabaseTableReference,null,n._withBox.list);t!==null&&(t.OnClosed=i(t,n),t.readRecord(n.Value))}}}if(super.refresh(),this.Component!==null){this.Readonly?this.FieldZone.find(".icon").hide():this.FieldZone.find(".icon").show();this.FieldZone.hasClass("deleted")&&this.FieldZone.removeClass("deleted");let i=this.DatabaseTableReference,n=null;if(!this.IsLinked&&i!==null&&!String.isEmptyOrWhiteSpaces(this.Value)&&(n=DSDatabase.Instance.getRowById(i,this.Value),n!==null)){this.Component.find(".label").off("click").on("click",u(this));this.Component.find(".label").addClass("link");this._withBox.list.isDeleted(n)&&this.FieldZone.addClass("deleted")}this.updateListeners();let t=null;if(this._withBox.digits!==null?(this._withBox.digits.Value=this.Value,t=this._withBox.digits.IsNull?this.Value:this._withBox.digits.toString()):t=this.Value,String.isEmptyOrWhiteSpaces(t)){this.FieldZone.find(".value").html("");return}if(i===null){this.FieldZone.find(".value").html(String.encode(t));return}if(n===null&&(n=DSDatabase.Instance.getRowById(i,t)),n===null){this.FieldZone.find(".value").html(String.encode(t.toString()));return}let r=this._withBox.list.getText(n);this.FieldZone.find(".value").html(String.encode(String.isEmptyOrWhiteSpaces(r)?"":r))}}updateListeners(){function n(n){return function(t,i,r,u,f){if(n.DatabaseTableReference===i){let e=n._withBox.list.getText(f);n.FieldZone.find(".value").html(String.encode(String.isEmptyOrWhiteSpaces(e)?"":e));n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");n._withBox.list.isDeleted(f)&&n.FieldZone.addClass("deleted")}}}function t(n){return function(t,i,r,u){n.DatabaseTableReference===i&&(n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted"),n._withBox.list.isDeleted(u)&&n.FieldZone.addClass("deleted"))}}this.clearListeners();this.DatabaseTableReference&&!String.isEmptyOrWhiteSpaces(this.Value)&&(this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this.DatabaseTableReference,this.Value,n(this))),this.addListener(DSDatabase.Instance.addEventListener("onDelete",this.DatabaseTableReference,this.Value,t(this))))}cleanUndo(){super.cleanUndo();this._withBox&&this._withBox.digits&&this._withBox.digits.cleanUndo()}constructor(n,t,i,r){super(n,t,i,"field_input_with_box");this._fnFilterInBox=null;this._allowNullValue=!1;this._withBox=GUI.Field.FieldInputWithBox.CACHE_BOX(r);this.draw();this._withBox.name!==null&&this.Component.addClass(this._withBox.name)}});GUI.Field.FieldSelect=(class extends GUI.Field.Field{set AllowNullValue(n){this._allowNullValue=n!==null&&n!==undefined&&n}set Value(n){if(n!==null&&n!==undefined||this._allowNullValue){super.Value=n;return}this.setFirstValueNotNull()}get Value(){if(this.Component===null)return super.Value;let n=this.FieldZone.find("select").val();return String.isEmptyOrWhiteSpaces(n)?null:n.trim()}set ExcludeValueToFilter(n){this._valueAdded=n===null||n===undefined?null:n}get List(){return this._list}drawField(n){n.append("<select><\/select><div class='icon'><\/div>")}onMouseClick(){this.Component===null||this.Readonly||this.FieldZone.find(".icon").click()}focus(){return super.focus()?(this.Component.find("select").focus(),!0):!1}sort(){let n=this.FieldZone.find("select > option");n.detach().sort((n,t)=>{let i=$(n).text(),r=$(t).text();return String.isEmptyOrWhiteSpaces(i)&&String.isEmptyOrWhiteSpaces(r)?0:String.isEmptyOrWhiteSpaces(i)?-1:String.isEmptyOrWhiteSpaces(r)?1:i>r?1:i<r?-1:0});n.appendTo(this.FieldZone.find("select"))}populate(){function u(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1}}}function f(n,t){return function(){n.Box!==null&&n.Box.setFocus(n);t||n.FieldZone.find("select").focus()}}if(super.populate(),this.Component!==null){let i=this.FieldZone.find("select");i.empty();i.off("keydown focus").on("keydown",u(this)).on("focus",f(this,!0));let t="";this._allowNullValue&&(t+="<option value=''><\/option>");let n="",r=!1;for(let i of Array.toIterable(this._list.getList()))if(this._list.isVisible(i)){n="";this._list.isDeleted(i)&&(n=" class='deleted'");let u=this._list.getId(i);if(u!==null){let e=this._list.getText(i);if(!String.isEmptyOrWhiteSpaces(e)){t+="<option value='"+u+"'"+n+">"+String.encode(e.trim())+"<\/option>";this._valueAdded===u&&(r=!0);continue}let f=this._list.getLanguageLabel(i);f!==undefined&&f!==null&&(t+=Helper.Option(u,f),this._valueAdded===u&&(r=!0))}}if(!r&&this._list!==null&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)){let i=this._list.getItem(this._valueAdded,!0);i!==null&&(n="",this._list.isDeleted(i)&&(n=" class='deleted'"),t+="<option value='"+i.Id+"'"+n+">"+String.encode(this._list.getText(i))+"<\/option>")}i.append(t);this.sort()}}refresh(){function r(n){return function(){n._value=$(this).val();let t=n.FieldZone.find("select");if(t.hasClass("deleted")&&t.removeClass("deleted"),n.Value!==null&&(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord)){let i=DSDatabase.Instance.getRowById(n._list.Table,n.Value);i!==null&&n._list.isDeleted(i)&&t.addClass("deleted")}n.raise("change")}}if(super.refresh(),this.Component!==null){this.populate();typeof this._value=="string"&&(this._value=this._value.trim());let n=this.FieldZone.find("select"),t=n.find("option[value='"+this._value+"']");if((t===null||t===undefined||t.length===0)&&(this._value=null),n.val(this._value===null?"":this._value),n.hasClass("deleted")&&n.removeClass("deleted"),this.Value!==null&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)){let t=DSDatabase.Instance.getRowById(this._list.Table,this._value);t!==null&&this._list.isDeleted(t)&&n.addClass("deleted")}let i=this.getEvent("onLoad");i&&(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&i("onLoad",this._list.Table);n.prop("disabled",this.Readonly);n.off("change").on("change",r(this));if(this.Readonly||!this.isEvent("icon"))this.FieldZone.find(".icon").hide(),this.FieldZone.find(".icon").off("click");else{this.FieldZone.find(".icon").show();this.FieldZone.find(".icon").off("click").on("click",()=>this.raise("icon",this))}}}onOpen(){function n(n){return function(){n.Box!==null&&n.Box.setFocus(n);n.FieldZone.find("select").focus()}}function t(n){return function(){n.refresh()}}function i(n){let t=n.FieldZone.find("select");return function(i,r,u,f){if(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord){if(List.ListRecord.SetExtendedFields(n._list,f),n._list.isVisible(f)){let i="";n._list.isDeleted(f)&&(i=" class='deleted'");t.append("<option value='"+f.Id+"'"+i+">"+String.encode(n._list.getText(f))+"<\/option>")}n.sort();let e=n.getEvent(i);e&&e(i,r,u,f)}}}function r(n){let t=n.FieldZone.find("select");return function(i,r,u,f,e){if(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord){List.ListRecord.SetExtendedFields(n._list,e);List.ListRecord.SetExtendedFields(n._list,f);let o=t.find("option[value='"+e.Id+"']"),h="",s=!1;if(n._list.isDeleted(e)&&(h=" class='deleted'",s=!0),o===null||o===undefined||o.length===0)n._list.isVisible(e)&&t.append("<option value='"+e.Id+"'"+h+">"+String.encode(n._list.getText(e))+"<\/option>");else if(n._list.isVisible(e))o.hasClass("deleted")&&o.removeClass("deleted"),s&&o.addClass("deleted"),o.html(String.encode(n._list.getText(e)));else if(n._valueAdded!==null&&n._valueAdded.toString()===e.Id.toString())o.hasClass("deleted")&&o.removeClass("deleted"),s&&o.addClass("deleted"),o.html(String.encode(n._list.getText(e)));else{let i=n.Value;o.remove();let t=n.Value;i!==t&&(n.Value=t)}if(t.hasClass("deleted")&&t.removeClass("deleted"),n.Value!==null){let i=DSDatabase.Instance.getRowById(n._list.Table,n.Value);i!==null&&n._list.isDeleted(i)&&t.addClass("deleted")}n.sort();let c=n.getEvent(i);c&&c(i,r,u,f,e)}}}function u(n){let t=n.FieldZone.find("select");return function(i,r,u,f){if(n._list instanceof List.ListRecord||n._list instanceof List.ListArrayRecord){List.ListRecord.SetExtendedFields(n._list,f);let e=t.find("option[value='"+f.Id+"']");if(e===null||e===undefined||e.length===0||n._valueAdded!==null&&n._valueAdded.toString()===newRecord.Id.toString())e.hasClass("deleted")&&e.removeClass("deleted"),n._list.isDeleted(f)&&e.addClass("deleted");else{let i=n.Value;e.remove();let t=n.Value;i!==t&&(n.Value=t)}if(t.hasClass("deleted")&&t.removeClass("deleted"),n.Value!==null){let i=DSDatabase.Instance.getRowById(n._list.Table,n.Value);i!==null&&n._list.isDeleted(i)&&t.addClass("deleted")}let o=n.getEvent(i);o&&o(i,r,u,f)}}}super.onOpen();this.Component.off("focus").on("focus",n(this));(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&(this.addListener(DSDatabase.Instance.addEventListener("onLoad",this._list.Table,"*",t(this))),this.addListener(DSDatabase.Instance.addEventListener("onCreate",this._list.Table,"*",i(this))),this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._list.Table,"*",r(this))),this.addListener(DSDatabase.Instance.addEventListener("onDelete",this._list.Table,"*",u(this))))}onClose(){super.onClose();this.FieldZone.find("select").off("focus");this.FieldZone.find(".icon").off("click");this.Component.off("focus")}setFirstValueNotNull(){if(this.Component!==null){let n=this.FieldZone.find("select");if(n[0].length===0){super.Value=null;return}if(this._allowNullValue){n[0].length>1?(this.FieldZone.find("select").val(n[0][1].value),super.Value=n[0][1].value):super.Value=null;return}if(n[0].length>0){this.FieldZone.find("select").val(n[0][0].value);super.Value=n[0][0].value;return}super.Value=null}}constructor(n,t,i,r){super(n,t,i,"field_select");this._list=r?r:new List.List;this._allowNullValue=!1;this._valueAdded=null;this.draw()}});GUI.Field.FieldSelectImage=(class extends GUI.Field.Field{set _parentValue(n){super.Value=n}set DefaultPicture(n){this._picture=String.isEmptyOrWhiteSpaces(n)?null:n}set Rollover(n){this._rollover=n!==null&&n!==undefined&&n;this._rollover&&(this._multiSelect=!1)}set Autovalidation(n){this._autovalidation=n!==null&&n!==undefined&&n;this._autovalidation&&(this._multiSelect=!1)}set MultiSelect(n){this._multiSelect=n!==null&&n!==undefined&&n===!0;this._multiSelect&&(this._rollover=!1,this._autovalidation=!1)}set ShowLabel(n){this._showLabel=n!==null&&n!==undefined&&n===!0;this._showLabel||(this.Message=null)}set Message(n){(this._showLabel||String.isEmptyOrWhiteSpaces(n))&&(super.Message=n)}get List(){return this._list}get Text(){let n="",t=[];if(Array.isArray(this.Value)?t=this.Value:String.isEmptyOrWhiteSpaces(this.Value)||(t=[this.Value]),t.length===0)return(n=Language.Manager.Instance.interpolation(this._labelNullValue),String.isEmptyOrWhiteSpaces(n))?"":n.trim();for(let t of t){let r=this._list.getItem(t,!0);if(r!==null){let i=this._list.getText(r);(String.isEmptyOrWhiteSpaces(i)&&(i=Language.Manager.Instance.interpolation(this._list.getLanguageLabel(r))),String.isEmptyOrWhiteSpaces(i))||(n=n+(n.length===0?"":", ")+i.trim())}}return n}destructor(){super.destructor();this._dialogBox!==null&&(this._dialogBox.destructor(),this._dialogBox=null)}drawField(n){n.append("<img><\/img><span><\/span>")}onOpen(){function t(n){return function(t){switch(t.key){case"Tab":return t.stopImmediatePropagation(),t.shiftKey?n.previousFocus():n.nextFocus(),!1;case"Enter":return t.stopImmediatePropagation(),n.onButtonOK(),!1;case"Escape":return t.stopImmediatePropagation(),n.onButtonCancel(),!1;case" ":return t.stopImmediatePropagation(),n.onMouseClick(),!1}}}function n(n){return function(t){GUI.Webix.Tooltip.Instance.show(String.encode(n.Text),t)}}function i(){return function(){GUI.Webix.Tooltip.Instance.hide()}}super.onOpen();this.FieldZone.find("img").on("mouseenter",n(this)).on("mouseleave",i(this)).on("mousemove",n(this));this.Component.on("keydown",t(this))}onClose(){super.onClose();this.FieldZone.find("img").off("mouseenter mouseleave mousemove click");this.Component.on("keydown")}refresh(){function i(n){return function(){function t(n){return function(t){return!n._allowNullValue&&t===null?(GUI.Box.BoxError("ERROR",n._errorMessage),!1):(n.Value=t,n.Message=n.Text,!0)}}function i(n){return function(){return n.raise("cancel"),!0}}function r(n){return function(){n.focus();n._dialogBox.OnClosed=null}}if(n._rollover){n.setNextValue();return}if(n._dialogBox===null&&(n._dialogBox=new GUI.Box.BoxSelect(n.Name,n.Label?n.Label:"SELECT_NAME"),n._dialogBox.getButton(GUI.Box.Box.BUTTON_OK).Action=t(n),n._dialogBox.getButton(GUI.Box.Box.BUTTON_CANCEL).Action=i(n),(n.Label===null||!n.Label.label)&&n.Box instanceof GUI.Box.BoxRecord)){let t=DSDatabase.Instance.getColumnLabel(n.Box.Table,n.Name);t!==null&&(n._dialogBox.Label=t)}n._dialogBox.Title=n._title;n._dialogBox.Error=null;n._dialogBox.Message=null;n._dialogBox.Filter=null;n._dialogBox.Value=n.Value;n._dialogBox.List=n._list;n._dialogBox.AllowNullValue=n._allowNullValue;n._dialogBox.Autovalidation=n._autovalidation;n._dialogBox.MultiSelect=n._multiSelect;n._dialogBox.OnClosed=r(n);n._dialogBox.open()}}if(super.refresh(),this.Readonly)this.FieldZone.find("img").css("cursor","initial"),this.FieldZone.find("img").off("click");else{this.FieldZone.find("img").css("cursor","pointer");this.FieldZone.find("img").off("click").on("click",i(this))}let n=this._picture,t=null;Array.isArray(this.Value)?t=this.Value.length>0?this._list.getItem(this.Value[0],!0):null:String.isEmptyOrWhiteSpaces(this.Value)||(t=this._list.getItem(this.Value,!0));t!==null&&(n=this._list.getPicture(t));n!==null&&n!==undefined||String.isEmptyOrWhiteSpaces(this._list.DefaultPicture)||(n=this._list.DefaultPicture);this.FieldZone.find("img")[0].src=n===null?this._picture:n;Array.isArray(this.Value)&&this.Value.length>1?(this.FieldZone.find("span").show(),this.FieldZone.find("span").html(this.Value.length)):this.FieldZone.find("span").hide();this.Message=this.Text;this.FieldZone.hasClass("deleted")&&this.FieldZone.removeClass("deleted");t!==null&&this._list.isDeleted(t)&&this.FieldZone.addClass("deleted");this.IsOpened&&this.updateListeners();this._dialogBox!==null&&this._dialogBox.IsOpened&&(this._dialogBox.Value=this.Value)}setNextValue(){function t(n,t){n._parentValue=t===null?null:String.convertValue(n._list.getId(t));n.FieldZone.find("img")[0].src=t===null?n._picture:n._list.getPicture(t);n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");t!==null&&n._list.isDeleted(t)&&n.FieldZone.addClass("deleted");n.Message=n.Text;n.IsOpened&&n.updateListeners();GUI.Webix.Tooltip.Instance.IsVisible&&GUI.Webix.Tooltip.Instance.show(String.encode(n.Text))}let n=null,i=null,r=!1;for(let t of Array.toIterable(this._list.getList())){let u=String.convertValue(this._list.getId(t));if(this.Value===u){r=!0;continue}if(this._list.isVisible(t)){if(r){i=t;break}n===null&&(n=t)}}if(i!==null){t(this,i);return}if(n===null){t(this,null);return}t(this,n)}updateListeners(){function n(n){return function(t,i,r,u,f){let e=n._list.getPicture(f);n.FieldZone.find("img")[0].src=e===null?n._picture:e;n.FieldZone.hasClass("deleted")&&n.FieldZone.removeClass("deleted");item!==null&&n._list.isDeleted(f)&&n.FieldZone.addClass("deleted");n.Message=n.Text}}this.clearListeners();(this._list instanceof List.ListRecord||this._list instanceof List.ListArrayRecord)&&!String.isEmptyOrWhiteSpaces(this.Value)&&this.addListener(DSDatabase.Instance.addEventListener("onUpdate",this._list.Table,this.Value,n(this)))}setAllowNullValue(n,t){this._allowNullValue=n!==null&&n!==undefined&&n;this._labelNullValue=t?t:"SELECT_VALUE_NULL";this._errorMessage=new Errors(t===null||t===undefined?"ERR_SELECT_VALUE":t);this._dialogBox!==null&&(this._dialogBox.AllowNullValue=this._allowNullValue)}onMouseClick(){this.Visible&&!this.Readonly&&this.FieldZone!==null&&this.FieldZone.find("img").click()}constructor(n,t,i,r,u,f){super(n,t,i,"field_select_image");this._title=r;this._list=u?u:new List.List;this._rollover=!1;this._picture=this._list.DefaultPicture===null||this._list.DefaultPicture===undefined?null:this._list.DefaultPicture;this._dialogBox=null;this._allowNullValue=!1;this._errorMessage=new Errors("ERR_SELECT_VALUE");this._labelNullValue=f?f:"SELECT_VALUE_NULL";this._autovalidation=!1;this._multiSelect=!1;this._showLabel=!1;this.draw()}});GUI.Webix={};webix.Date.startOnMonday=!0;GUI.Webix.Webix=(class extends GUI.GUI{get ChartZone(){return this.Component}set Webix(n){this._webix!==null&&(this._webix.destructor(),this._webix=null);this._webix=n}get Webix(){return this._webix}destructor(){super.destructor();this._webix!==null&&this._webix.destructor();this._webix=null}drawChart(){}draw(){function n(n){return function(){n.debug("Resizing webix chart ...");n.refresh()}}super.draw("<webix id='"+this.Name+"'><\/webix>");this.drawChart(this.ChartZone);this.refresh();$(window).on("resize",n(this))}constructor(n,t,i){super("Webix",n,t,i);this._webix=null}});GUI.Webix.WebixBar=(class extends GUI.Webix.Webix{setLabel(n,t){n<0||n>=this._values.length||this._values[n]===undefined||(this._values[n].label=Helper.Label(t))}setValue(n,t){n<0||n>=this._values.length||this._values[n]===undefined||(this._values[n].value=typeof t=="string"?String.parseFloat(t):typeof t=="number"?String.parseFloat(t):0,this._values[n].value<0&&(this._values[n].value=0),this.refresh())}createChart(){let n=this._maxValue?this._maxValue:this._nbSteps;return new webix.ui({view:"chart",type:"bar",css:"webix_bar",container:this.ChartZone[0],value:"#value#",color:"#color#",shadow:!1,border:!1,borderless:!0,tooltip:{template:function(n){return Helper.Span(n.label)}},yAxis:{start:0,end:n,step:n/this._nbSteps},data:[]})}drawChart(){this.Webix=this.createChart();let r="#000000",n=$("<webix id='"+this.Name+"' class='color'><\/webix>");String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass);let i=n.appendTo("body"),t=n.css("color");i.remove();String.isEmptyOrWhiteSpaces(t)||(r=String.parseRGBToHEX(t));for(let u=0;u<this._values.length;u++)n=$("<webix id='"+this.Name+"' class='color_"+(u+1).toString()+"'><\/webix>"),String.isEmptyOrWhiteSpaces(this.CSSClass)||n.addClass(this.CSSClass),i=n.appendTo("body"),t=n.css("color"),i.remove(),this._values[u].color=String.isEmptyOrWhiteSpaces(t)?r:String.parseRGBToHEX(t)}refresh(){if(super.refresh(),this.Component!==null&&this.Webix!==null){let t=this.ChartZone.width(),i=this.ChartZone.height(),n=0;this.Webix.clearAll();for(let t=0;t<this._values.length;t++)this.Webix.add(this._values[t]),n<this._values[t].value&&(n=Math.ceil(this._values[t].value/this._nbSteps)*this._nbSteps);this._maxValue!==n&&(this._maxValue=n,this.Webix=this.createChart());this.Webix.config.barWidth=t/(this._values.length+1);this.Webix.config.width=t;this.Webix.config.height=i;this.Webix.config.x=t/10;this.Webix.config.y=i/10;this.Webix.resize()}}constructor(n,t,i){super(n,t,"bar");this._values=[];for(let n=0;n<i;n++)this._values.push({id:n+1,value:0,color:"#000000",label:null});this._maxValue=0;this._nbSteps=5;this.draw()}});GUI.Webix.Tooltip=(class{static get DEFAULT(){return"tooltip"}get IsVisible(){return this._visible}show(n,t){if(!String.isEmptyOrWhiteSpaces(n)){(t===null||t===undefined)&&(t={pageX:this._lastEventMouse.x,pageY:this._lastEventMouse.y});$('<p class="image webix_tooltip"><\/p>').html(n).appendTo("body");let u=$(".image.webix_tooltip").width()+20,f=$(".image.webix_tooltip").height()+10;$(".image.webix_tooltip").remove();let e=$(window).width(),o=$(window).height(),i=t.pageX,r=t.pageY;i+u>e&&(i<u?i=0:(i=i-u,r+=10));r+f>o&&(r=r<f?0:r-f);this._tooltip.show({text:n},{x:i,y:r});this._visible=!0;this._lastEventMouse={x:t.pageX,y:t.pageY}}}hide(){this._tooltip.hide();this._visible=!1}constructor(){webix.ui({id:GUI.Webix.Tooltip.DEFAULT,view:"tooltip",template:"#text#"});this._tooltip=$$(GUI.Webix.Tooltip.DEFAULT);this._lastEventMouse={x:0,y:0};this._visible=!1}static get Instance(){return this._instance||(this._instance=new GUI.Webix.Tooltip),this._instance}});var ERR_INITIALIZATION="L'initialisation a rencontré une erreur ... Si le problème persiste, contacter votre équipe support !",BTN_RELOAD="RECHARGER",ERROR="Erreur";class Area extends GUI.GUI{static get HTTP_ROOT_DOCUMENTATION(){let n=null;if(String.isEmptyOrWhiteSpaces(DSDatabase.Instance.Parameters["HTTP.Document"])){let t="http",i="application.syncytium.local";t=window.location.href.startsWith("http://localhost")?"https":window.location.href.split(":")[0];window.location.href.indexOf("syncytium.server")>=0&&(i="application.syncytium.server");n=t+"://"+i+"/wiki/index.php/utilisation/"}else n=DSDatabase.Instance.Parameters["HTTP.Document"];return n.endsWith("/")||(n+="/"),n}static get ROOT_MENU(){return"body > menu > ul > "}static get SERVICE_RELEASE_NOTES(){return"ReleaseNotes"}set Help(n){function t(n){return function(){typeof n._link=="string"&&window.open(Area.HTTP_ROOT_DOCUMENTATION+n._link,"_blank");typeof n._link=="function"&&n._link()}}this._link=n===null||n===undefined?null:n;$(Area.ROOT_MENU+"#help").unbind();this._link!==null&&$(Area.ROOT_MENU+"#help").click(t(this))}get ModuleId(){return this._moduleId}get Menu(){return this._menu}get CurrentMenu(){return this._currentMenu}get CurrentSubMenu(){return this._currentSubMenu}destructor(){super.destructor();for(let n of Array.toIterable(this._boards))n.destructor();this._boards={}}declareBoard(n,t){let r=this.getMenu(n),i=new t(r.sheet,n);return i.KeepListEvents=!0,r.boards.push(i),i}setTitle(n,t){this._title=Helper.Label(n);this._element=t===null||t===undefined?null:t;$("header > ul > li.area").html(Helper.Span(this._title));this._element===null?$("header > ul > li.element").hide():($("header > ul > li.element").show(),$("header > ul > li.element.screen_name").html(String.encode(this._element)))}declareMenu(n,t,i,r,u){function e(n,t,i){return function(){n.onMenu(t,i)}}function o(n,t){return function(){$('<p class="webix_tooltip menu '+n+'"><\/p>').html(Helper.Span(t)).appendTo("body").fadeIn("slow")}}function s(n){return function(){$(".webix_tooltip.menu."+n).remove()}}function h(n){return function(t){let i=t.pageX+10,r=t.pageY;$(".webix_tooltip.menu."+n).css({top:r,left:i})}}if(this._menu[n]===null||this._menu[n]===undefined){this.info("Declaring menu ('"+n+"', '"+i+"') ...");this._firstMenu===null&&(this._firstMenu=n);this._menu[n]={id:n,title:Helper.Label(i),filter:r===undefined?null:r,boards:[],menu:{},orderMenu:[],current:null,sheet:null,showProgress:u!==null&&u!==undefined&&u===!0};let t=$("<li class='button' id='"+n+"'><\/li>");$(Area.ROOT_MENU+" li.spaceall").before(t);t.hover(o(n,this._menu[n].title),s(n)).mousemove(h(n));t.click(e(this,n));this._menu[n].sheet=$("<sheet class='"+n+"'><\/sheet>");this._menu[n].sheet.hide();$("body > main").append(this._menu[n].sheet);Language.Manager.Instance.addComponent(this._menu[n].sheet)}if(t===null||t===undefined)return this._menu[n];let f=this._menu[n];if(f.menu[t]===null||f.menu[t]===undefined){this.info("Declaring sub menu ('"+n+"', '"+t+"', '"+i+"') ...");f.menu[t]={id:t,title:Helper.Label(i),filter:r===undefined?null:r,boards:[],functions:[],sheet:null,showProgress:u!==null&&u!==undefined&&u===!0};f.orderMenu.push(f.menu[t]);f.current===null&&(f.current=t);let c=$("<li class='button' id='"+t+"'><\/li>");$(Area.ROOT_MENU+" li.spaceall").before(c);c.hover(o(t,f.menu[t].title),s(t)).mousemove(h(t));c.click(e(this,n,t));f.menu[t].sheet=$("<sheet class='"+t+"'><\/sheet>");f.menu[t].sheet.hide();$("body > main").append(f.menu[t].sheet);Language.Manager.Instance.addComponent(f.menu[t].sheet)}return f.menu[t]}getMenu(n){let t=this._menu[n];if(t!==null&&t!==undefined)return t;for(let i in this._menu)if(t=this._menu[i].menu[n],t!==null&&t!==undefined)return t;return null}onHandleChangeFilter(n,t){return function(){let i=t.field.Value;Filter.Filter.Instance.setField(t.key,i);let r=n.getMenu(t.menu);for(let n of r.boards)n[t.fieldName]=i}}onHandleRefresh(n){return function(){n.field.refresh()}}declareFilterInputText(n,t,i){let r={key:this.Name+"."+n+"."+t,menu:n,fieldName:t,field:null};Filter.Filter.Instance.setField(r.key,null);r.field=new GUI.Field.FieldInput("body > menu > ul > li.field",this.Name+n+t,i);r.field.Value=Filter.Filter.Instance.getField(r.key);r.field.on("change",this.onHandleChangeFilter(this,r));return this._filters.push(r),r.field}declareFilterInputDigit(n,t,i,r){let u={key:this.Name+"."+n+"."+t,menu:n,fieldName:t,field:null};Filter.Filter.Instance.setField(u.key,null);u.field=new GUI.Field.FieldInputWithBox("body > menu > ul > li.field",this.Name+n+t,i,r);u.field.AllowNullValue=!0;u.field.Value=Filter.Filter.Instance.getField(u.key);u.field.on("change",this.onHandleChangeFilter(this,u));return this._filters.push(u),u.field}declareFilterSelect(n,t,i,r){let u={key:this.Name+"."+n+"."+t,menu:n,fieldName:t,field:null};Filter.Filter.Instance.setField(u.key,null);u.field=new GUI.Field.FieldSelect("body > menu > ul > li.field",this.Name+n+t,i,r);u.field.AllowNullValue=!0;u.field.on("onCreate",this.onHandleRefresh(u));u.field.on("onUpdate",this.onHandleRefresh(u));u.field.on("onDelete",this.onHandleRefresh(u));u.field.Value=Filter.Filter.Instance.getField(u.key);u.field.on("change",this.onHandleChangeFilter(this,u));return this._filters.push(u),u.field}declareFilterSelectImage(n,t,i,r){let u={key:this.Name+"."+n+"."+t,menu:n,fieldName:t,field:null};Filter.Filter.Instance.setField(u.key,null);u.field=new GUI.Field.FieldSelectImage("body > menu > ul > li.field",this.Name+n+t,i,(n+"_SELECT_"+t).toUpperCase(),r);u.field.AllowNullValue=!0;u.field.on("onCreate",this.onHandleRefresh(u));u.field.on("onUpdate",this.onHandleRefresh(u));u.field.on("onDelete",this.onHandleRefresh(u));u.field.Value=Filter.Filter.Instance.getField(u.key);u.field.on("change",this.onHandleChangeFilter(this,u));return this._filters.push(u),u.field}declareFilterCheckBox(n,t,i){let r={key:this.Name+"."+n+"."+t,menu:n,fieldName:t,field:null};Filter.Filter.Instance.setField(r.key,null);r.field=new GUI.Field.FieldCheckBox("body > menu > ul > li.field",this.Name+n+t,i,[i+"_NULL",i+"_TRUE",i+"_FALSE"]);r.field.AllowNullValue=!0;r.field.Value=Filter.Filter.Instance.getField(r.key);r.field.on("change",this.onHandleChangeFilter(this,r));return this._filters.push(r),r.field}onSelectingMenu(n,t){for(let i of this._filters){let r=String.isEmptyOrWhiteSpaces(t)?n:t;i.field.Visible=i.menu===r;i.menu===r&&i.field.raise("change")}}async onMenu(n,t,i){let r=this._menu[n];if(r!==null&&r!==undefined&&(t=t===null||t===undefined?null:t,this.info("Select menu '"+(n===null?"null":n)+"', '"+(t===null?"null":t)+"'"),i!==null&&i!==undefined&&i!==!1||this._currentMenu!==n||this._currentSubMenu!==t)){if(t===null&&r.boards.length===0&&r.current!==null)t=r.current;else if(t===null&&r.boards.length===0)for(let n in r.menu){t=n;break}this._menu[n]!==undefined&&this._menu[n].showProgress===!0&&(GUI.Box.Progress.Start(!0),GUI.Box.Progress.SetStatus(0,1,"MSG_INITIALIZING"),await GUI.Box.Progress.Sleep(10));for(let n in this._menu){let t=this._menu[n];if(t!==null&&t!==undefined){for(let n of t.boards)n.hide();$(Area.ROOT_MENU+"#"+n).hasClass("selected")&&$(Area.ROOT_MENU+"#"+n).removeClass("selected");$(Area.ROOT_MENU+"#"+n).prop("disabled",!1);t.sheet.remove();for(let n in t.menu){let i=t.menu[n];if(i!==null&&i!==undefined){for(let n of i.boards)n.hide();$(Area.ROOT_MENU+"#"+n).hasClass("selected")&&$(Area.ROOT_MENU+"#"+n).removeClass("selected");$(Area.ROOT_MENU+"#"+n).prop("disabled",!1);$(Area.ROOT_MENU+"#"+n).hide();i.sheet.remove()}}}}for(let i in this._menu){let r=this._menu[i];if(r!==null&&r!==undefined){if(i===n&&t===null&&!$(Area.ROOT_MENU+"#"+i).hasClass("selected")){$(Area.ROOT_MENU+"#"+i).addClass("selected");$(Area.ROOT_MENU+"#"+i).prop("disabled",!0);$("main > sheet."+i).length>0?$("main > sheet."+i).show():r.sheet.length>0&&(r.sheet.show(),$("body > main").append(r.sheet));for(let n of r.boards)await n.show()}for(let u in r.menu){let f=r.menu[u];if(f!==null&&f!==undefined&&(i===n&&$(Area.ROOT_MENU+"#"+u).show(),i===n&&u===t)){$(Area.ROOT_MENU+"#"+u).addClass("selected");$(Area.ROOT_MENU+"#"+u).prop("disabled",!0);$("main > sheet."+u).length>0?$("main > sheet."+u).show():f.sheet.length>0&&(f.sheet.show(),$("body > main").append(f.sheet));for(let n of f.boards)await n.show()}}}}this.onSelectingMenu(n,t);this._currentMenu=n;this._currentSubMenu=t;r.current=t;this._menu[n]!==undefined&&this._menu[n].showProgress===!0&&GUI.Box.Progress.Stop()}}onStatusChanged(n,t,i){function r(){window.onbeforeunload=null;window.location=URL_ROOT+"Administration/User/SignOut"}i===null||i===undefined?this.info("The current database status is '"+t+"'"):this.info("The current database status is '"+t+"' ("+i.toString()+")");switch(t){case"Running":this.onLoadedData();break;case"Error":$("body > main").hide();$("body > .progress").hide();$(".box_record").hide();n==="Running"?GUI.Box.Message.Reload(i,r):GUI.Box.Message.Reload(ERR_INITIALIZATION,r)}}onStartProgress(){GUI.Box.Progress.Start()}progressStatus(n,t,i){GUI.Box.Progress.SetStatus(n,t,i)}onStopProgress(n){if(GUI.Box.Progress.Stop(),n!==undefined&&n===!0){let n=window.location.search.substr(1);if(n===null||n===""){this.startApplication({});return}let t={};for(let n of n.split("&")){let i=n.split("=");t[i[0]]=i[1]}this.startApplication(t)}}acknowledgeService(n,t,i,r,u){if(this.info("Acknowledging of the service '"+t+"' for ('"+n+"', "+String.JSONStringify(i)+", "+String.JSONStringify(r)+") => "+String.JSONStringify(u)),n!==this.Name){this.error("Unable to acknowldge the service because the area '"+n+"' is not expected ("+this.Name+")");return}switch(t){case Area.SERVICE_RELEASE_NOTES:if(u.Error!==null&&u.Error!==undefined){let n=new Errors;n.setJSON(u.Error);GUI.Box.Message.Error("ERROR",n);return}GUI.Box.BoxReleaseNotes.Open(u.Result)}}progressMemory(n,t){(n===null||n===undefined||n<0)&&(n=0);n>t&&(n=t);$("body > .memory > .container").width((n*100/t).toFixed(0).toString()+"%")}async onLoadedData(){function s(){return function(){GUI.Box.BoxRecord.CACHE_DIALOG_BOX("User","Profile").profile(DSDatabase.Instance.CurrentUser)}}function i(){return function(n,t,i,r,u){let f=null;switch(t){case"User":switch(n){case"onUpdate":$("body > header > ul > .photo > img")[0].src=u.Picture===null?UserRecord.DEFAULT_PICTURE().picture:u.Picture;u.EndDate!==null&&u.EndDate<new moment&&(f="MSG_DISCONNECTED");break;case"onDelete":f="MSG_DISCONNECTED"}break;case"Module":switch(n){case"onUpdate":if(r.Profile!==u.Profile)switch(u.Profile){case UserRecord.PROFILE_ADMINISTRATOR:if(DSDatabase.Instance.Area==="Administration")return;f="MSG_CHANGE_PROFILE_ADMINISTRATOR";break;case UserRecord.PROFILE_SUPERVISOR:case UserRecord.PROFILE_USER:case UserRecord.PROFILE_OTHER:f=DSDatabase.Instance.Area==="Administration"?"MSG_DISCONNECTED":"MSG_CHANGE_PROFILE";break;case UserRecord.PROFILE_NONE:f="MSG_DISCONNECTED"}break;case"onDelete":f="MSG_DISCONNECTED"}break;case"UserModule":f="MSG_DISCONNECTED"}if(f!==null){let e=new GUI.Box.Box("reload","box_reload");e.Title="RELOAD";e.Message=f;e.draw();switch(f){case"MSG_CHANGE_PROFILE_ADMINISTRATOR":case"MSG_DISCONNECTED":e.declareButton("Signout","BTN_SIGNOUT",async function(){return await Hub.Instance.stop(!0),Logger.Instance.IsEnabled=!1,window.onbeforeunload=null,window.location=URL_ROOT+"Administration/User/SignOut",!0});break;case"MSG_CHANGE_PROFILE":e.declareButton("Reload","BTN_RELOAD",function(){return window.location.reload(),!0})}e.open()}}}function h(n){return function(t,i,r,u,f){if(i==="*"&&u!==null&&u!==undefined){if(f!==null&&f!==undefined){GUI.Box.Message.Error(u,f);return}let e=Language.Manager.Instance.interpolation(u);n.info("Toast: "+e);webix.message(String.encode(e))}}}function c(n){return function(t,i,r,u){if(u!==null&&u!==undefined&&(!Helper.IsLabel(u,!0)||Language.Manager.Instance.existLabel(u.label))){let f=Language.Manager.Instance.interpolation(u);n.info("Toast: "+f);webix.message(String.encode(f))}}}function f(n,t){return function(i,r){n._popupCommit=GUI.Box.Progress.IsOpened();n._popupCommit||(GUI.Box.Progress.SetStatus(0,r,t),GUI.Box.Progress.Start(!1))}}function e(n){return function(){n._popupCommit||GUI.Box.Progress.SetStatus()}}function o(n){return function(){n._popupCommit||GUI.Box.Progress.Stop();n._popupCommit=!1}}function l(){return async function(){if(!Hub.Instance.IsOnline){GUI.Box.Message.Information("ERR_RELEASE_NOTES");return}await Hub.Instance.executeService(Area.SERVICE_RELEASE_NOTES,null,null,!1).then(n=>{if(n.Error!==null&&n.Error!==undefined){let t=new Errors;t.setJSON(n.Error);GUI.Box.Message.Error("ERROR",t);return}})}}function a(){return function(){function i(n){return async function(){async function t(){return await Hub.Instance.stop(!0),Logger.Instance.IsEnabled=!1,window.onbeforeunload=null,window.location=URL_ROOT+ModuleRecord.GetModuleName(n)+"/"+ModuleRecord.GetModuleName(n)+"/Index?moduleId="+DSDatabase.Instance.getServerIdByClientId("Module",n.Id),!0}if(DSDatabase.Instance.IsEmpty)return await t();GUI.Box.Message.Message("TITLE_EXIT","MSG_CONFIRMATION_CANCEL",t)}}let n=DSDatabase.Instance.CurrentUser,r=DSDatabase.Instance.CurrentModule,t=[];if(n!==null&&n!==undefined){let u=[];for(let n of Array.toIterable(n.Modules)){let t=n.Module;t!==null&&t!==undefined&&t.Id!==r.Id&&t.Enable&&u.push(t)}u.sort(function(n,t){return n.Module<t.Module?-1:n.Module>t.Module?1:0});for(let n of u)t.push({label:n.Name,fn:i(n)})}t.length>0&&GUI.Box.BoxChoice.BoxChoices("TITLE_MODULE",null,t)}}function n(){return function(){let n=(new UserRecord.List).getItem(DSDatabase.Instance.CurrentUser.Id),t=0;if(n!==null&&n!==undefined){let i=new ModuleRecord.List;for(let n of Array.toIterable(n.Modules)){let r=i.getItem(n.ModuleId);r!==null&&r!==undefined&&r.Enable&&t++}}$("body > header > ul > .area.screen_name").css("cursor",t>1?"pointer":"initial")}}if(this._firstLoad){this._firstLoad=!1;this.info("Data are loaded. So, building the screen ...");Language.Manager.Instance.initialize(DSDatabase.Instance);let t=DSDatabase.Instance.CurrentUser,r=DSDatabase.Instance.CurrentModule,u=null;DSDatabase.Instance.each("UserModule",function(n){n.UserId!==t.Id||n.ModuleId!==r.Id||n._deleted||(u=n)});$("body > header > ul > .photo > img")[0].src=t===null||t.Picture===null?UserRecord.DEFAULT_PICTURE().picture:t.Picture;$("body > header > ul > .photo").hover(function(){let n=DSDatabase.Instance.CurrentUser,t="";n!==null&&n.Name!==""?t=n.Name:n!==null&&n.Login!==""&&(t=n.Login);$('<p class="image webix_tooltip"><\/p>').html(t).appendTo("body").fadeIn("slow")},function(){$(".image.webix_tooltip").remove()}).mousemove(function(n){let t=n.pageX-10-$(".image.webix_tooltip").width(),i=n.pageY;$(".image.webix_tooltip").css({top:i,left:t})});$(Language.Manager.LANGUAGE_ROOT+"#"+DSDatabase.Instance.CurrentLanguage).html("<span>"+DSDatabase.Instance.CurrentLanguage+"<\/span>");webix.i18n.setLocale(DSDatabase.Instance.CurrentLanguage);Locale.setLanguage(DSDatabase.Instance.CurrentLanguage);await this.draw();this.setTitle(this._title);this.Help=this._link;$("body > main").show();this.onOpen();t.Id<0?($("body > header > ul > .photo").unbind(),$("body > header > ul > .photo > img").css("cursor","initial")):($("body > header > ul > .photo").click(s()),$("body > header > ul > .photo > img").css("cursor","pointer"));t!==null&&(DSDatabase.Instance.addEventListener("onUpdate","User",t.Id,i()),DSDatabase.Instance.addEventListener("onDelete","User",t.Id,i()));r!==null&&(DSDatabase.Instance.addEventListener("onUpdate","Module",r.Id,i()),DSDatabase.Instance.addEventListener("onDelete","Module",r.Id,i()));u!==null&&DSDatabase.Instance.addEventListener("onDelete","UserModule",u.Id,i());DSDatabase.Instance.addEventListener("onStartCommit","*","*",f(this,"MSG_COMMITTING"));DSDatabase.Instance.addEventListener("onStartRollback","*","*",f(this,"MSG_ROLLBACKING"));DSDatabase.Instance.addEventListener("onCommit","*","*",e(this));DSDatabase.Instance.addEventListener("onRollback","*","*",e(this));DSDatabase.Instance.addEventListener("onStopCommit","*","*",o(this));DSDatabase.Instance.addEventListener("onStopRollback","*","*",o(this));DSDatabase.Instance.addEventListener("onEndNotification","*","*",c(this));DSDatabase.Instance.addEventListener("onNotify","*","*",h(this));Hub.Instance.addListener(this.Name,this);$("body > footer > .release").click(l(this));$("body > footer > .company").click(function(){window.open("http://www.concilium-lesert.fr","_blank")});$("body > header > ul > .area.screen_name").click(a(this));DSDatabase.Instance.addEventListener("onCreate","UserModule","*",n());DSDatabase.Instance.addEventListener("onUpdate","UserModule","*",n());DSDatabase.Instance.addEventListener("onDelete","UserModule","*",n());DSDatabase.Instance.addEventListener("onLoad","UserModule","*",n());DSDatabase.Instance.addEventListener("onCreate","Module","*",n());DSDatabase.Instance.addEventListener("onUpdate","Module","*",n());DSDatabase.Instance.addEventListener("onDelete","Module","*",n());DSDatabase.Instance.addEventListener("onLoad","Module","*",n());n(this)()}}startApplication(n){this.info("Parameters : "+String.JSONStringify(n))}drawSheets(){}async draw(){function*t(n){yield GUI.Box.Progress.Status(0,n.length,"MSG_SCREEN_BUILDING");for(let n of n){try{n()}catch(t){Logger.Instance.exception("Area","Exception on building a screen",t)}yield GUI.Box.Progress.Status()}}super.draw(null);let n=[];this.drawSheets(this._container,n);await GUI.Box.Progress.Thread(t(n),1,!0,!0)}async onOpen(){function n(n){return function(){for(let t of n._filters)t.field.onOpen(),t.field.refresh()}}if(super.onOpen(),this._firstMenu===null){n(area)();return}await this.onMenu(this._firstMenu).then(n(this))}constructor(n,t,i){super("area","body > main",n);this._link=null;this._title=null;this._element=null;this._firstLoad=!0;this._moduleId=i===null||i===undefined?-1:i;this._popupCommit=!1;this._boards={};this._firstMenu=null;this._menu={};this._currentMenu=null;this._currentSubMenu=null;this._filters=[];this.setTitle(t)}}